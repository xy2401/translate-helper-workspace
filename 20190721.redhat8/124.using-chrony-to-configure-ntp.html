<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 5. Using the Chrony suite to configure NTP</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="using-chrony-to-configure-ntp"/>Chapter 5. Using the Chrony suite to configure NTP</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-ntp-with-chrony-intro_using-chrony-to-configure-ntp"/>Introduction to configuring NTP with chrony</h1></div></div></div><p>
				Accurate timekeeping is important for a number of reasons in IT. In networking for example, accurate time stamps in packets and logs are required. In Linux systems, the <code class="literal">NTP</code> protocol is implemented by a daemon running in user space.
			</p><p>
				The user space daemon updates the system clock running in the kernel. The system clock can keep time by using various clock sources. Usually, the <span class="emphasis"><em>Time Stamp Counter</em></span> (<span class="strong"><strong>TSC</strong></span>) is used. The TSC is a CPU register which counts the number of cycles since it was last reset. It is very fast, has a high resolution, and there are no interruptions.
			</p><p>
				In Red Hat Enterprise Linux 8, the <code class="literal">NTP</code> protocol is implemented by the <code class="literal">chronyd</code> daemon, available from the repositories in the <code class="literal">chrony</code> package.
			</p><p>
				These sections describe the use of the <span class="strong"><strong><span class="application">chrony</span></strong></span> suite.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="chrony-intro_using-chrony-to-configure-ntp"/>Introduction to chrony suite</h1></div></div></div><p>
				<span class="strong"><strong><span class="application">chrony</span></strong></span> is an implementation of the <code class="literal">Network Time Protocol (NTP)</code>. You can use <span class="strong"><strong><span class="application">chrony</span></strong></span>:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						To synchronize the system clock with <code class="literal">NTP</code> servers
					</li><li class="listitem">
						To synchronize the system clock with a reference clock, for example a GPS receiver
					</li><li class="listitem">
						To synchronize the system clock with a manual time input
					</li><li class="listitem">
						As an <code class="literal">NTPv4(RFC 5905)</code> server or peer to provide a time service to other computers in the network
					</li></ul></div><p>
				<span class="strong"><strong><span class="application">chrony</span></strong></span> performs well in a wide range of conditions, including intermittent network connections, heavily congested networks, changing temperatures (ordinary computer clocks are sensitive to temperature), and systems that do not run continuously, or run on a virtual machine.
			</p><p>
				Typical accuracy between two machines synchronized over the Internet is within a few milliseconds, and for machines on a LAN within tens of microseconds. Hardware timestamping or a hardware reference clock may improve accuracy between two machines synchronized to a sub-microsecond level.
			</p><p>
				<span class="strong"><strong><span class="application">chrony</span></strong></span> consists of <code class="literal">chronyd</code>, a daemon that runs in user space, and <span class="strong"><strong><span class="application">chronyc</span></strong></span>, a command line program which can be used to monitor the performance of <code class="literal">chronyd</code> and to change various operating parameters when it is running.
			</p><p>
				The <span class="strong"><strong><span class="application">chrony</span></strong></span> daemon, <code class="literal">chronyd</code>, can be monitored and controlled by the command line utility <span class="strong"><strong><span class="application">chronyc</span></strong></span>. This utility provides a command prompt which allows entering a number of commands to query the current state of <code class="literal">chronyd</code> and make changes to its configuration. By default, <code class="literal">chronyd</code> accepts only commands from a local instance of <span class="strong"><strong><span class="application">chronyc</span></strong></span>, but it can be configured to accept monitoring commands also from remote hosts. The remote access should be restricted.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="using-chronyc-to-control-chronyd_using-chrony-to-configure-ntp"/>Using chronyc to control chronyd</h2></div></div></div><p>
					To make changes to the local instance of <code class="literal">chronyd</code> using the command line utility <span class="strong"><strong><span class="application">chronyc</span></strong></span> in interactive mode, enter the following command as <code class="literal">root</code>:
				</p><pre class="literallayout">~]# chronyc</pre><p>
					<span class="strong"><strong><span class="application">chronyc</span></strong></span> must run as <code class="literal">root</code> if some of the restricted commands are to be used.
				</p><p>
					The <span class="strong"><strong><span class="application">chronyc</span></strong></span> command prompt will be displayed as follows:
				</p><pre class="literallayout">chronyc&gt;</pre><p>
					You can type <code class="literal">help</code> to list all of the commands.
				</p><p>
					The utility can also be invoked in non-interactive command mode if called together with a command as follows:
				</p><pre class="literallayout"><code class="literal">chronyc <span class="emphasis"><em>command</em></span></code></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Changes made using <span class="strong"><strong><span class="application">chronyc</span></strong></span> are not permanent, they will be lost after a <code class="literal">chronyd</code> restart. For permanent changes, modify <code class="literal">/etc/chrony.conf</code>.
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="differences-between-ntp-and-chrony_using-chrony-to-configure-ntp"/>Differences between chrony and ntp</h1></div></div></div><p>
				<code class="literal">Network Time Protocol (NTP)</code> has two different implementations with similar basic functionality - <span class="strong"><strong><span class="application">ntp</span></strong></span> and <span class="strong"><strong><span class="application">chrony</span></strong></span>.
			</p><p>
				Both <span class="strong"><strong><span class="application">ntp</span></strong></span> and <span class="strong"><strong><span class="application">chrony</span></strong></span> can operate as an <code class="literal">NTP</code> client in order to synchronize the system clock with <code class="literal">NTP</code> servers and they can operate as an <code class="literal">NTP</code> server for other computers in the network. Each implementation has some unique features. For comparison of <span class="strong"><strong><span class="application">ntp</span></strong></span> and <span class="strong"><strong><span class="application">chrony</span></strong></span>, see <a class="link" href="https://chrony.tuxfamily.org/comparison.html">Comparison of NTP implementations</a>.
			</p><p>
				Configuration specific to an <code class="literal">NTP</code> client is identical in most cases. <code class="literal">NTP</code> servers are specified with the <code class="literal">server</code> directive. A pool of servers can be specified with the <code class="literal">pool</code> directive.
			</p><p>
				Configuration specific to an <code class="literal">NTP</code> server differs in how the client access is controlled. By default, <code class="literal">ntpd</code> responds to client requests from any address. The access can be restricted with the <code class="literal">restrict</code> directive, but it is not possible to disable the access completely if <code class="literal">ntpd</code> uses any servers as a client. <code class="literal">chronyd</code> allows no access by default and operates as an <code class="literal">NTP</code> client only. To make <span class="strong"><strong><span class="application">chrony</span></strong></span> operate as an <code class="literal">NTP</code> server, you need to specify some addresses within the <code class="literal">allow</code> directive.
			</p><p>
				<code class="literal">ntpd</code> and <code class="literal">chronyd</code> differ also in the default behavior with respect to corrections of the system clock. <code class="literal">ntpd</code> corrects the clock by step when the offset is larger than 128 milliseconds. If the offset is larger than 1000 seconds, <code class="literal">ntpd</code> exits unless it is the first correction of the clock and <code class="literal">ntpd</code> is started with the <code class="literal">-g</code> option. <code class="literal">chronyd</code> does not step the clock by default, but the default <code class="literal">chrony.conf</code> file provided in the <code class="literal">chrony</code> package allows steps in the first three updates of the clock. After that, all corrections are made slowly by speeding up or slowing down the clock. The <code class="literal">chronyc makestep</code> command can be issued to force <code class="literal">chronyd</code> to step the clock at any time.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="migrating-to-chrony_using-chrony-to-configure-ntp"/>Migrating to chrony</h1></div></div></div><p>
				In Red Hat Enterprise Linux 7, users could choose between <span class="strong"><strong><span class="application">ntp</span></strong></span> and <span class="strong"><strong><span class="application">chrony</span></strong></span> to ensure accurate timekeeping. For differences between <span class="strong"><strong><span class="application">ntp</span></strong></span> and <span class="strong"><strong><span class="application">chrony</span></strong></span>, <code class="literal">ntpd</code> and <code class="literal">chronyd</code>, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/system_administrators_guide/#sect-differences_between_ntpd_and_chronyd">Differences between ntpd and chronyd</a>.
			</p><p>
				In Red Hat Enterprise Linux 8, <span class="strong"><strong><span class="application">ntp</span></strong></span> is no longer supported. <span class="strong"><strong><span class="application">chrony</span></strong></span> is enabled by default. For this reason, you might need to migrate from <span class="strong"><strong><span class="application">ntp</span></strong></span> to <span class="strong"><strong><span class="application">chrony</span></strong></span>.
			</p><p>
				Migrating from <span class="strong"><strong><span class="application">ntp</span></strong></span> to <span class="strong"><strong><span class="application">chrony</span></strong></span> is straightforward in most cases. The corresponding names of the programs, configuration files and services are:
			</p><div class="table"><a id="tabl-corresponding-names-when-migrating-to-chrony"/><p class="title"><strong>Table 5.1. Corresponding names of the programs, configuration files and services when migrating from ntp to chrony</strong></p><div class="table-contents"><table summary="Corresponding names of the programs, configuration files and services when migrating from ntp to chrony" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><thead><tr><th style="text-align: left" valign="top">ntp name</th><th style="text-align: left" valign="top">chrony name</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
								/etc/ntp.conf
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								/etc/chrony.conf
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								/etc/ntp/keys
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								/etc/chrony.keys
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								ntpd
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								chronyd
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								ntpq
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								chronyc
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								ntpd.service
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								chronyd.service
							</p>
							 </td></tr><tr><td style="text-align: left" valign="top"> <p>
								ntp-wait.service
							</p>
							 </td><td style="text-align: left" valign="top"> <p>
								chrony-wait.service
							</p>
							 </td></tr></tbody></table></div></div><p>
				The <span class="strong"><strong><span class="application">ntpdate</span></strong></span> and <span class="strong"><strong><span class="application">sntp</span></strong></span> utilities, which are included in the <code class="literal">ntp</code> distribution, can be replaced with <code class="literal">chronyd</code> using the <code class="literal">-q</code> option or the <code class="literal">-t</code> option. The configuration can be specified on the command line to avoid reading <code class="literal">/etc/chrony.conf</code>. For example, instead of running <code class="literal">ntpdate ntp.example.com</code>, <code class="literal">chronyd</code> could be started as:
			</p><pre class="literallayout"># chronyd -q 'server ntp.example.com iburst'
2018-05-18T12:37:43Z chronyd version 3.3 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +SECHASH +IPV6 +DEBUG)
2018-05-18T12:37:43Z Initial frequency -2.630 ppm
2018-05-18T12:37:48Z System clock wrong by 0.003159 seconds (step)
2018-05-18T12:37:48Z chronyd exiting</pre><p>
				The <span class="strong"><strong><span class="application">ntpstat</span></strong></span> utility, which was previously included in the <code class="literal">ntp</code> package and supported only <code class="literal">ntpd</code>, now supports both <code class="literal">ntpd</code> and <code class="literal">chronyd</code>. It is available in the <code class="literal">ntpstat</code> package.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migration_script"/>Migration script</h2></div></div></div><p>
					A Python script called <code class="literal">ntp2chrony.py</code> is included in the documentation of the <code class="literal">chrony</code> package (<code class="literal">/usr/share/doc/chrony</code>). The script automatically converts an existing <code class="literal">ntp</code> configuration to <code class="literal">chrony</code>. It supports the most common directives and options in the <code class="literal">ntp.conf</code> file. Any lines that are ignored in the conversion are included as comments in the generated <code class="literal">chrony.conf</code> file for review. Keys that are specified in the <code class="literal">ntp</code> key file, but are not marked as trusted keys in <code class="literal">ntp.conf</code> are included in the generated <code class="literal">chrony.keys</code> file as comments.
				</p><p>
					By default, the script does not overwrite any files. If <code class="literal">/etc/chrony.conf</code> or <code class="literal">/etc/chrony.keys</code> already exist, the <code class="literal">-b</code> option can be used to rename the file as a backup. The script supports other options. The <code class="literal">--help</code> option prints all supported options.
				</p><p>
					An example of an invocation of the script with the default <code class="literal">ntp.conf</code> provided in the <code class="literal">ntp</code> package is:
				</p><pre class="literallayout"># python3 /usr/share/doc/chrony/ntp2chrony.py -b -v
Reading /etc/ntp.conf
Reading /etc/ntp/crypto/pw
Reading /etc/ntp/keys
Writing /etc/chrony.conf
Writing /etc/chrony.keys</pre><p>
					The only directive ignored in this case is <code class="literal">disable monitor</code>, which has a chrony equivalent in the <code class="literal">noclientlog</code> directive, but it was included in the default <code class="literal">ntp.conf</code> only to mitigate an amplification attack.
				</p><p>
					The generated <code class="literal">chrony.conf</code> file typically includes a number of <code class="literal">allow</code> directives corresponding to the restrict lines in <code class="literal">ntp.conf</code>. If you do not want to run <code class="literal">chronyd</code> as an <code class="literal">NTP</code> server, remove all <code class="literal">allow</code> directives from <code class="literal">chrony.conf</code>.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="timesync_role"/>Timesync role</h2></div></div></div><p>
					Note that using <a class="link" href="using-chrony-to-configure-ntp.html#managing-time-synchronization-using-rhel-system-roles_using-chrony-to-configure-ntp" title="Managing time synchronization using RHEL System Roles">the timesync role</a> on your Red Hat Enterprise Linux 7 system facilitates the migration to <span class="strong"><strong><span class="application">chrony</span></strong></span>, because you can use the same playbook on all versions of RHEL starting with RHEL 6 regardless of whether the system uses <span class="strong"><strong><span class="application">ntp</span></strong></span> or <span class="strong"><strong><span class="application">chrony</span></strong></span> to implement the NTP protocol.
				</p><p>
					For more information on using the <code class="literal">timesync</code> role to manage time synchronization, see <a class="link" href="https://github.com/linux-system-roles/timesync">System roles documentation</a>.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-chrony_using-chrony-to-configure-ntp"/>Configuring chrony</h1></div></div></div><p>
				The default configuration file for <code class="literal">chronyd</code> is <code class="literal">/etc/chrony.conf</code>. The <code class="literal">-f</code> option can be used to specify an alternate configuration file path. See the <code class="literal">chrony.conf(5)</code> man page for further options. For a complete list of the directives that can be used see <a class="link" href="https://chrony.tuxfamily.org/doc/3.3/chrony.conf.html">The chronyd configuration file</a>.
			</p><p>
				Below is a selection of <code class="literal">chronyd</code> configuration options:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Comments</span></dt><dd>
							Comments should be preceded by #, %, ; or !
						</dd><dt><span class="term">allow</span></dt><dd><p class="simpara">
							Optionally specify a host, subnet, or network from which to allow <code class="literal">NTP</code> connections to a machine acting as <code class="literal">NTP</code> server. The default is not to allow connections.
						</p><p class="simpara">
							Examples:
						</p></dd></dl></div><pre class="literallayout">allow 192.0.2.0/24</pre><p>
				Use this command to grant access to a specific network.
			</p><pre class="literallayout">allow 2001:0db8:85a3::8a2e:0370:7334</pre><p>
				Use this this command to grant access to an <code class="literal">IPv6</code>.
			</p><p>
				The UDP port number 123 needs to be open in the firewall in order to allow the client access:
			</p><pre class="literallayout">~]#  firewall-cmd --zone=public --add-port=123/udp</pre><p>
				If you want to open port 123 permanently, use the <code class="literal">--permanent</code> option:
			</p><pre class="literallayout">~]#  firewall-cmd --permanent --zone=public --add-port=123/udp</pre><div class="variablelist"><dl class="variablelist"><dt><span class="term">cmdallow</span></dt><dd>
							This is similar to the <code class="literal">allow</code> directive (see section <code class="literal">allow</code>), except that it allows control access (rather than <code class="literal">NTP</code> client access) to a particular subnet or host. (By "control access" is meant that <span class="strong"><strong><span class="application">chronyc</span></strong></span> can be run on those hosts and successfully connect to <code class="literal">chronyd</code> on this computer.) The syntax is identical. There is also a <code class="literal">cmddeny all</code> directive with similar behavior to the <code class="literal">cmdallow all</code> directive.
						</dd><dt><span class="term">dumpdir</span></dt><dd>
							Path to the directory to save the measurement history across restarts of <code class="literal">chronyd</code> (assuming no changes are made to the system clock behavior whilst it is not running). If this capability is to be used (via the <code class="literal">dumponexit</code> command in the configuration file, or the <code class="literal">dump</code> command in <span class="strong"><strong><span class="application">chronyc</span></strong></span>), the <code class="literal">dumpdir</code> command should be used to define the directory where the measurement histories are saved.
						</dd><dt><span class="term">dumponexit</span></dt><dd>
							If this command is present, it indicates that <code class="literal">chronyd</code> should save the measurement history for each of its time sources recorded whenever the program exits. (See the <code class="literal">dumpdir</code> command above).
						</dd><dt><span class="term">hwtimestamp</span></dt><dd>
							The <code class="literal">hwtimestamp</code> directive enables hardware timestamping for extremely accurate synchronization. For more details, see the <code class="literal">chrony.conf(5)</code> manual page.
						</dd><dt><span class="term">local</span></dt><dd><p class="simpara">
							The <code class="literal">local</code> keyword is used to allow <code class="literal">chronyd</code> to appear synchronized to real time from the viewpoint of clients polling it, even if it has no current synchronization source. This option is normally used on the "master" computer in an isolated network, where several computers are required to synchronize to one another, and the "master" is kept in line with real time by manual input.
						</p><p class="simpara">
							An example of the command is:
						</p><pre class="literallayout">local stratum 10</pre><p class="simpara">
							A large value of 10 indicates that the clock is so many hops away from a reference clock that its time is unreliable. If the computer ever has access to another computer which is ultimately synchronized to a reference clock, it will almost certainly be at a stratum less than 10. Therefore, the choice of a high value like 10 for the <code class="literal">local</code> command prevents the machine’s own time from ever being confused with real time, were it ever to leak out to clients that have visibility of real servers.
						</p></dd><dt><span class="term">log</span></dt><dd><p class="simpara">
							The <code class="literal">log</code> command indicates that certain information is to be logged. It accepts the following options:
						</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">measurements</span></dt><dd>
										This option logs the raw <code class="literal">NTP</code> measurements and related information to a file called <code class="literal">measurements.log</code>.
									</dd><dt><span class="term">statistics</span></dt><dd>
										This option logs information about the regression processing to a file called <code class="literal">statistics.log</code>.
									</dd><dt><span class="term">tracking</span></dt><dd>
										This option logs changes to the estimate of the system’s gain or loss rate, and any slews made, to a file called <code class="literal">tracking.log</code>.
									</dd><dt><span class="term">rtc</span></dt><dd>
										This option logs information about the system’s real-time clock.
									</dd><dt><span class="term">refclocks</span></dt><dd>
										This option logs the raw and filtered reference clock measurements to a file called <code class="literal">refclocks.log</code>.
									</dd><dt><span class="term">tempcomp</span></dt><dd><p class="simpara">
										This option logs the temperature measurements and system rate compensations to a file called <code class="literal">tempcomp.log</code>.
									</p><p class="simpara">
										The log files are written to the directory specified by the <code class="literal">logdir</code> command.
									</p><p class="simpara">
										An example of the command is:
									</p><pre class="literallayout">log measurements statistics tracking</pre></dd></dl></div></dd><dt><span class="term">logdir</span></dt><dd><p class="simpara">
							This directive allows the directory where log files are written to be specified.
						</p><p class="simpara">
							An example of the use of this directive is:
						</p><pre class="literallayout">logdir /var/log/chrony</pre></dd><dt><span class="term">makestep</span></dt><dd><p class="simpara">
							Normally <code class="literal">chronyd</code> will cause the system to gradually correct any time offset, by slowing down or speeding up the clock as required. In certain situations, the system clock may be so far adrift that this slewing process would take a very long time to correct the system clock. This directive forces <code class="literal">chronyd</code> to step system clock if the adjustment is larger than a threshold value, but only if there were no more clock updates since <code class="literal">chronyd</code> was started than a specified limit (a negative value can be used to disable the limit). This is particularly useful when using reference clock, because the <code class="literal">initstepslew</code> directive only works with <code class="literal">NTP</code> sources.
						</p><p class="simpara">
							An example of the use of this directive is:
						</p><pre class="literallayout">makestep 1000 10</pre><p class="simpara">
							This would step the system clock if the adjustment is larger than 1000 seconds, but only in the first ten clock updates.
						</p></dd><dt><span class="term">maxchange</span></dt><dd><p class="simpara">
							This directive sets the maximum allowed offset corrected on a clock update. The check is performed only after the specified number of updates to allow a large initial adjustment of the system clock. When an offset larger than the specified maximum occurs, it will be ignored for the specified number of times and then <code class="literal">chronyd</code> will give up and exit (a negative value can be used to never exit). In both cases a message is sent to syslog.
						</p><p class="simpara">
							An example of the use of this directive is:
						</p><pre class="literallayout">maxchange 1000 1 2</pre><p class="simpara">
							After the first clock update, <code class="literal">chronyd</code> will check the offset on every clock update, it will ignore two adjustments larger than 1000 seconds and exit on another one.
						</p></dd><dt><span class="term">maxupdateskew</span></dt><dd><p class="simpara">
							One of <code class="literal">chronyd</code>'s tasks is to work out how fast or slow the computer’s clock runs relative to its reference sources. In addition, it computes an estimate of the error bounds around the estimated value.
						</p><p class="simpara">
							If the range of error is too large, it indicates that the measurements have not settled down yet, and that the estimated gain or loss rate is not very reliable.
						</p><p class="simpara">
							The <code class="literal">maxupdateskew</code> parameter is the threshold for determining whether an estimate is too unreliable to be used. By default, the threshold is 1000 ppm.
						</p><p class="simpara">
							The format of the syntax is:
						</p><pre class="literallayout">maxupdateskew <span class="emphasis"><em>skew-in-ppm</em></span></pre><p class="simpara">
							Typical values for <span class="emphasis"><em>skew-in-ppm</em></span> might be 100 for a dial-up connection to servers over a telephone line, and 5 or 10 for a computer on a LAN.
						</p><p class="simpara">
							It should be noted that this is not the only means of protection against using unreliable estimates. At all times, <code class="literal">chronyd</code> keeps track of both the estimated gain or loss rate, and the error bound on the estimate. When a new estimate is generated following another measurement from one of the sources, a weighted combination algorithm is used to update the master estimate. So if <code class="literal">chronyd</code> has an existing highly-reliable master estimate and a new estimate is generated which has large error bounds, the existing master estimate will dominate in the new master estimate.
						</p></dd><dt><span class="term">minsources</span></dt><dd><p class="simpara">
							The <code class="literal">minsources</code> directive sets the minimum number of sources that need to be considered as selectable in the source selection algorithm before the local clock is updated.
						</p><p class="simpara">
							The format of the syntax is:
						</p><pre class="literallayout">minsources <span class="emphasis"><em>number-of-sources</em></span></pre><p class="simpara">
							By default, <span class="emphasis"><em>number-of-sources</em></span> is 1. Setting minsources to a larger number can be used to improve the reliability, because multiple sources will need to correspond with each other.
						</p></dd><dt><span class="term">noclientlog</span></dt><dd>
							This directive, which takes no arguments, specifies that client accesses are not to be logged. Normally they are logged, allowing statistics to be reported using the clients command in <span class="strong"><strong><span class="application">chronyc</span></strong></span> and enabling the clients to use interleaved mode with the <code class="literal">xleave</code> option in the <code class="literal">server</code> directive.
						</dd><dt><span class="term">reselectdist</span></dt><dd><p class="simpara">
							When <code class="literal">chronyd</code> selects synchronization source from available sources, it will prefer the one with minimum synchronization distance. However, to avoid frequent reselecting when there are sources with similar distance, a fixed distance is added to the distance for sources that are currently not selected. This can be set with the <code class="literal">reselectdist</code> option. By default, the distance is 100 microseconds.
						</p><p class="simpara">
							The format of the syntax is:
						</p><pre class="literallayout">reselectdist <span class="emphasis"><em>dist-in-seconds</em></span></pre></dd><dt><span class="term">stratumweight</span></dt><dd><p class="simpara">
							The <code class="literal">stratumweight</code> directive sets how much distance should be added per stratum to the synchronization distance when <code class="literal">chronyd</code> selects the synchronization source from available sources.
						</p><p class="simpara">
							The format of the syntax is:
						</p><pre class="literallayout">stratumweight <span class="emphasis"><em>dist-in-seconds</em></span></pre><p class="simpara">
							By default, <span class="emphasis"><em>dist-in-seconds</em></span> is 1 millisecond. This means that sources with lower stratum are usually preferred to sources with higher stratum even when their distance is significantly worse. Setting <code class="literal">stratumweight</code> to 0 makes <code class="literal">chronyd</code> ignore stratum when selecting the source.
						</p></dd><dt><span class="term">rtcfile</span></dt><dd><p class="simpara">
							The <code class="literal">rtcfile</code> directive defines the name of the file in which <code class="literal">chronyd</code> can save parameters associated with tracking the accuracy of the system’s real-time clock (RTC).
						</p><p class="simpara">
							The format of the syntax is:
						</p><pre class="literallayout">rtcfile /var/lib/chrony/rtc</pre><p class="simpara">
							<code class="literal">chronyd</code> saves information in this file when it exits and when the <code class="literal">writertc</code> command is issued in <span class="strong"><strong><span class="application">chronyc</span></strong></span>. The information saved is the RTC’s error at some epoch, that epoch (in seconds since January 1 1970), and the rate at which the RTC gains or loses time. Not all real-time clocks are supported as their code is system-specific. Note that if this directive is used then the real-time clock should not be manually adjusted as this would interfere with <span class="strong"><strong><span class="application">chrony</span></strong></span>'s need to measure the rate at which the real-time clock drifts if it was adjusted at random intervals.
						</p></dd><dt><span class="term">rtcsync</span></dt><dd>
							The <code class="literal">rtcsync</code> directive is present in the <code class="literal">/etc/chrony.conf</code> file by default. This will inform the kernel the system clock is kept synchronized and the kernel will update the real-time clock every 11 minutes.
						</dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring-chrony-for-security_using-chrony-to-configure-ntp"/>Configuring chrony for security</h2></div></div></div><p>
					<span class="strong"><strong><span class="application">chronyc</span></strong></span> can access <code class="literal">chronyd</code> in two ways:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Internet Protocol, IPv4 or IPv6.
						</li><li class="listitem">
							Unix domain socket, which is accessible locally by the <code class="literal">root</code> or <code class="literal">chrony</code> user.
						</li></ul></div><p>
					By default, <span class="strong"><strong><span class="application">chronyc</span></strong></span> connects to the Unix domain socket. The default path is <code class="literal">/var/run/chrony/chronyd.sock</code>. If this connection fails, which can happen for example when <span class="strong"><strong><span class="application">chronyc</span></strong></span> is running under a non-root user, <span class="strong"><strong><span class="application">chronyc</span></strong></span> tries to connect to 127.0.0.1 and then ::1.
				</p><p>
					Only the following monitoring commands, which do not affect the behavior of <code class="literal">chronyd</code>, are allowed from the network:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							activity
						</li><li class="listitem">
							manual list
						</li><li class="listitem">
							rtcdata
						</li><li class="listitem">
							smoothing
						</li><li class="listitem">
							sources
						</li><li class="listitem">
							sourcestats
						</li><li class="listitem">
							tracking
						</li><li class="listitem">
							waitsync
						</li></ul></div><p>
					The set of hosts from which <code class="literal">chronyd</code> accepts these commands can be configured with the <code class="literal">cmdallow</code> directive in the configuration file of <code class="literal">chronyd</code>, or the <code class="literal">cmdallow</code> command in <span class="strong"><strong><span class="application">chronyc</span></strong></span>. By default, the commands are accepted only from localhost (127.0.0.1 or ::1).
				</p><p>
					All other commands are allowed only through the Unix domain socket. When sent over the network, <code class="literal">chronyd</code> responds with a <code class="literal">Not authorised</code> error, even if it is from localhost.
				</p><div class="orderedlist"><p class="title"><strong>Accessing chronyd remotely with <span class="strong"><strong><span class="application">chronyc</span></strong></span></strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Allow access from both IPv4 and IPv6 addresses by adding the following to the <code class="literal">/etc/chrony.conf</code> file:
						</p><pre class="literallayout">bindcmdaddress 0.0.0.0</pre><p class="simpara">
							or
						</p><pre class="literallayout">bindcmdaddress :</pre></li><li class="listitem"><p class="simpara">
							Allow commands from the remote IP address, network, or subnet by using the <code class="literal">cmdallow</code> directive.
						</p><div class="informalexample"><p>
							Add the following content to the <code class="literal">/etc/chrony.conf</code> file:
						</p><pre class="literallayout">cmdallow 192.168.1.0/24</pre></div></li><li class="listitem"><p class="simpara">
							Open port 323 in the firewall to connect from a remote system.
						</p><pre class="literallayout">~]#  firewall-cmd --zone=public --add-port=323/udp</pre><p class="simpara">
							If you want to open port 323 permanently, use the <code class="literal">--permanent</code>.
						</p><pre class="literallayout">~]#  firewall-cmd --permanent --zone=public --add-port=323/udp</pre></li></ol></div><p>
					Note that the <code class="literal">allow</code> directive is for <code class="literal">NTP</code> access whereas the <code class="literal">cmdallow</code> directive is to enable receiving of remote commands. It is possible to make these changes temporarily using <span class="strong"><strong><span class="application">chronyc</span></strong></span> running locally. Edit the configuration file to make permanent changes.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using-chrony_using-chrony-to-configure-ntp"/>Using Chrony</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-installing_chrony"/>Installing chrony</h2></div></div></div><p>
					The <span class="strong"><strong><span class="application">chrony</span></strong></span> suite is installed by default on Red Hat Enterprise Linux. To ensure that it is, run the following command as <code class="literal">root</code>:
				</p><pre class="literallayout">~]# yum install chrony</pre><p>
					The default location for the <span class="strong"><strong><span class="application">chrony</span></strong></span> daemon is <code class="literal">/usr/sbin/chronyd</code>. The command line utility will be installed to <code class="literal">/usr/bin/chronyc</code>.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-checking_the_status_of_chronyd"/>Checking the status of chronyd</h2></div></div></div><p>
					To check the status of <code class="literal">chronyd</code>, issue the following command:
				</p><pre class="literallayout">~]$ <code class="literal">systemctl status chronyd</code>
chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; enabled)
   Active: active (running) since Wed 2013-06-12 22:23:16 CEST; 11h ago</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-starting_chronyd"/>Starting chronyd</h2></div></div></div><p>
					To start <code class="literal">chronyd</code>, issue the following command as <code class="literal">root</code>:
				</p><pre class="literallayout">~]# systemctl start chronyd</pre><p>
					To ensure <code class="literal">chronyd</code> starts automatically at system start, issue the following command as <code class="literal">root</code>:
				</p><pre class="literallayout">~]# systemctl enable chronyd</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-stopping_chronyd"/>Stopping chronyd</h2></div></div></div><p>
					To stop <code class="literal">chronyd</code>, issue the following command as <code class="literal">root</code>:
				</p><pre class="literallayout">~]# systemctl stop chronyd</pre><p>
					To prevent <code class="literal">chronyd</code> from starting automatically at system start, issue the following command as <code class="literal">root</code>:
				</p><pre class="literallayout">~]# systemctl disable chronyd</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-checking_if_chrony_is_synchronized"/>Checking if chrony is synchronized</h2></div></div></div><p>
					To check if <span class="strong"><strong><span class="application">chrony</span></strong></span> is synchronized, make use of the <code class="literal">tracking</code>, <code class="literal">sources</code>, and <code class="literal">sourcestats</code> commands.
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sect-checking_chrony_tracking"/>Checking chrony tracking</h3></div></div></div><p>
						To check <span class="strong"><strong><span class="application">chrony</span></strong></span> tracking, issue the following command:
					</p><pre class="literallayout">~]$ <code class="literal">chronyc tracking</code>
Reference ID    : CB00710F (foo.example.net)
Stratum         : 3
Ref time (UTC)  : Fri Jan 27 09:49:17 2017
System time     :  0.000006523 seconds slow of NTP time
Last offset     : -0.000006747 seconds
RMS offset      : 0.000035822 seconds
Frequency       : 3.225 ppm slow
Residual freq   : 0.000 ppm
Skew            : 0.129 ppm
Root delay      : 0.013639022 seconds
Root dispersion : 0.001100737 seconds
Update interval : 64.2 seconds
Leap status     : Normal</pre><p>
						The fields are as follows:
					</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Reference ID</span></dt><dd>
									This is the reference ID and name (or <code class="literal">IP</code> address) if available, of the server to which the computer is currently synchronized. Reference ID is a hexadecimal number to avoid confusion with IPv4 addresses.
								</dd><dt><span class="term">Stratum</span></dt><dd>
									The stratum indicates how many hops away from a computer with an attached reference clock we are. Such a computer is a stratum-1 computer, so the computer in the example is two hops away (that is to say, a.b.c is a stratum-2 and is synchronized from a stratum-1).
								</dd><dt><span class="term">Ref time</span></dt><dd>
									This is the time (UTC) at which the last measurement from the reference source was processed.
								</dd><dt><span class="term">System time</span></dt><dd>
									In normal operation, <code class="literal">chronyd</code> never steps the system clock, because any jump in the timescale can have adverse consequences for certain application programs. Instead, any error in the system clock is corrected by slightly speeding up or slowing down the system clock until the error has been removed, and then returning to the system clock’s normal speed. A consequence of this is that there will be a period when the system clock (as read by other programs using the <code class="literal">gettimeofday()</code> system call, or by the date command in the shell) will be different from <code class="literal">chronyd</code>'s estimate of the current true time (which it reports to <code class="literal">NTP</code> clients when it is operating in server mode). The value reported on this line is the difference due to this effect.
								</dd><dt><span class="term">Last offset</span></dt><dd>
									This is the estimated local offset on the last clock update.
								</dd><dt><span class="term">RMS offset</span></dt><dd>
									This is a long-term average of the offset value.
								</dd><dt><span class="term">Frequency</span></dt><dd>
									The "frequency" is the rate by which the system’s clock would be wrong if <code class="literal">chronyd</code> was not correcting it. It is expressed in ppm (parts per million). For example, a value of 1 ppm would mean that when the system’s clock thinks it has advanced 1 second, it has actually advanced by 1.000001 seconds relative to true time.
								</dd><dt><span class="term">Residual freq</span></dt><dd><p class="simpara">
									This shows the "residual frequency" for the currently selected reference source. This reflects any difference between what the measurements from the reference source indicate the frequency should be and the frequency currently being used.
								</p><p class="simpara">
									The reason this is not always zero is that a smoothing procedure is applied to the frequency. Each time a measurement from the reference source is obtained and a new residual frequency computed, the estimated accuracy of this residual is compared with the estimated accuracy (see <code class="literal">skew</code>) of the existing frequency value. A weighted average is computed for the new frequency, with weights depending on these accuracies. If the measurements from the reference source follow a consistent trend, the residual will be driven to zero over time.
								</p></dd><dt><span class="term">Skew</span></dt><dd>
									This is the estimated error bound on the frequency.
								</dd><dt><span class="term">Root delay</span></dt><dd>
									This is the total of the network path delays to the stratum-1 computer from which the computer is ultimately synchronized. Root delay values are printed in nanosecond resolution. In certain extreme situations, this value can be negative. (This can arise in a symmetric peer arrangement where the computers’ frequencies are not tracking each other and the network delay is very short relative to the turn-around time at each computer.)
								</dd><dt><span class="term">Root dispersion</span></dt><dd>
									This is the total dispersion accumulated through all the computers back to the stratum-1 computer from which the computer is ultimately synchronized. Dispersion is due to system clock resolution, statistical measurement variations etc. Root dispersion values are printed in nanosecond resolution.
								</dd><dt><span class="term">Leap status</span></dt><dd>
									This is the leap status, which can be Normal, Insert second, Delete second or Not synchronized.
								</dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sect-checking_chrony_sources"/>Checking chrony sources</h3></div></div></div><p>
						The sources command displays information about the current time sources that <code class="literal">chronyd</code> is accessing.
					</p><p>
						The optional argument -v can be specified, meaning verbose. In this case, extra caption lines are shown as a reminder of the meanings of the columns.
					</p><pre class="literallayout">~]$ chronyc sources
	210 Number of sources = 3
MS Name/IP address         Stratum Poll Reach LastRx Last sample
===============================================================================
#* GPS0                          0   4   377    11   -479ns[ -621ns] /-  134ns
^? a.b.c                         2   6   377    23   -923us[ -924us] +/-   43ms
^ d.e.f                         1   6   377    21  -2629us[-2619us] +/-   86ms</pre><p>
						The columns are as follows:
					</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">M</span></dt><dd>
									This indicates the mode of the source. <code class="literal">^</code> means a server, <code class="literal">=</code> means a peer and <code class="literal">#</code> indicates a locally connected reference clock.
								</dd><dt><span class="term">S</span></dt><dd>
									This column indicates the state of the sources. "*" indicates the source to which <code class="literal">chronyd</code> is currently synchronized. "+" indicates acceptable sources which are combined with the selected source. "-" indicates acceptable sources which are excluded by the combining algorithm. "?" indicates sources to which connectivity has been lost or whose packets do not pass all tests. "x" indicates a clock which <code class="literal">chronyd</code> thinks is a <span class="emphasis"><em>falseticker</em></span> (its time is inconsistent with a majority of other sources). "~" indicates a source whose time appears to have too much variability. The "?" condition is also shown at start-up, until at least 3 samples have been gathered from it.
								</dd><dt><span class="term">Name/IP address</span></dt><dd>
									This shows the name or the <code class="literal">IP</code> address of the source, or reference ID for reference clock.
								</dd><dt><span class="term">Stratum</span></dt><dd>
									This shows the stratum of the source, as reported in its most recently received sample. Stratum 1 indicates a computer with a locally attached reference clock. A computer that is synchronized to a stratum 1 computer is at stratum 2. A computer that is synchronized to a stratum 2 computer is at stratum 3, and so on.
								</dd><dt><span class="term">Poll</span></dt><dd><p class="simpara">
									This shows the rate at which the source is being polled, as a base-2 logarithm of the interval in seconds. Thus, a value of 6 would indicate that a measurement is being made every 64 seconds.
								</p><p class="simpara">
									<code class="literal">chronyd</code> automatically varies the polling rate in response to prevailing conditions.
								</p></dd><dt><span class="term">Reach</span></dt><dd>
									This shows the source’s reach register printed as an octal number. The register has 8 bits and is updated on every received or missed packet from the source. A value of 377 indicates that a valid reply was received for all of the last eight transmissions.
								</dd><dt><span class="term">LastRx</span></dt><dd>
									This column shows how long ago the last sample was received from the source. This is normally in seconds. The letters <code class="literal">m</code>, <code class="literal">h</code>, <code class="literal">d</code> or <code class="literal">y</code> indicate minutes, hours, days or years. A value of 10 years indicates there were no samples received from this source yet.
								</dd><dt><span class="term">Last sample</span></dt><dd>
									This column shows the offset between the local clock and the source at the last measurement. The number in the square brackets shows the actual measured offset. This may be suffixed by <code class="literal">ns</code> (indicating nanoseconds), <code class="literal">us</code> (indicating microseconds), <code class="literal">ms</code> (indicating milliseconds), or <code class="literal">s</code> (indicating seconds). The number to the left of the square brackets shows the original measurement, adjusted to allow for any slews applied to the local clock since. The number following the <code class="literal">+/-</code> indicator shows the margin of error in the measurement. Positive offsets indicate that the local clock is ahead of the source.
								</dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sect-checking_chrony_source_statistics"/>Checking chrony source statistics</h3></div></div></div><p>
						The <code class="literal">sourcestats</code> command displays information about the drift rate and offset estimation process for each of the sources currently being examined by <code class="literal">chronyd</code>.
					</p><p>
						The optional argument <code class="literal">-v</code> can be specified, meaning verbose. In this case, extra caption lines are shown as a reminder of the meanings of the columns.
					</p><pre class="literallayout">~]$ <code class="literal">chronyc sourcestats</code>
210 Number of sources = 1
Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
===============================================================================
abc.def.ghi                11   5   46m     -0.001      0.045      1us    25us</pre><p>
						The columns are as follows:
					</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Name/IP address</span></dt><dd>
									This is the name or <code class="literal">IP</code> address of the <code class="literal">NTP</code> server (or peer) or reference ID of the reference clock to which the rest of the line relates.
								</dd><dt><span class="term">NP</span></dt><dd>
									This is the number of sample points currently being retained for the server. The drift rate and current offset are estimated by performing a linear regression through these points.
								</dd><dt><span class="term">NR</span></dt><dd>
									This is the number of runs of residuals having the same sign following the last regression. If this number starts to become too small relative to the number of samples, it indicates that a straight line is no longer a good fit to the data. If the number of runs is too low, <code class="literal">chronyd</code> discards older samples and re-runs the regression until the number of runs becomes acceptable.
								</dd><dt><span class="term">Span</span></dt><dd>
									This is the interval between the oldest and newest samples. If no unit is shown the value is in seconds. In the example, the interval is 46 minutes.
								</dd><dt><span class="term">Frequency</span></dt><dd>
									This is the estimated residual frequency for the server, in parts per million. In this case, the computer’s clock is estimated to be running 1 part in <span class="emphasis"><em>10<sup>9</sup></em></span> slow relative to the server.
								</dd><dt><span class="term">Freq Skew</span></dt><dd>
									This is the estimated error bounds on Freq (again in parts per million).
								</dd><dt><span class="term">Offset</span></dt><dd>
									This is the estimated offset of the source.
								</dd><dt><span class="term">Std Dev</span></dt><dd>
									This is the estimated sample standard deviation.
								</dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-manually_adjusting-the-System_clock"/>Manually Adjusting the System Clock</h2></div></div></div><p>
					To step the system clock immediately, bypassing any adjustments in progress by slewing, issue the following command as <code class="literal">root</code>:
				</p><pre class="literallayout">~]# chronyc makestep</pre><p>
					If the <code class="literal">rtcfile</code> directive is used, the real-time clock should not be manually adjusted. Random adjustments would interfere with <span class="strong"><strong><span class="application">chrony</span></strong></span>'s need to measure the rate at which the real-time clock drifts.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="setting-up-chrony-for-different-environments_using-chrony-to-configure-ntp"/>Setting up chrony for different environments</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-setting_up_chrony_for_a_system_in_an_isolated_network"/>Setting up chrony for a system in an isolated network</h2></div></div></div><p>
					For a network that is never connected to the Internet, one computer is selected to be the master timeserver. The other computers are either direct clients of the master, or clients of clients. On the master, the drift file must be manually set with the average rate of drift of the system clock. If the master is rebooted, it will obtain the time from surrounding systems and calculate an average to set its system clock. Thereafter it resumes applying adjustments based on the drift file. The drift file will be updated automatically when the <code class="literal">settime</code> command is used.
				</p><p>
					On the system selected to be the master, using a text editor running as <code class="literal">root</code>, edit <code class="literal">/etc/chrony.conf</code> as follows:
				</p><pre class="literallayout">driftfile /var/lib/chrony/drift
commandkey 1
keyfile /etc/chrony.keys
initstepslew 10 client1 client3 client6
local stratum 8
manual
allow 192.0.2.0</pre><p>
					Where <code class="literal">192.0.2.0</code> is the network or subnet address from which the clients are allowed to connect.
				</p><p>
					On the systems selected to be direct clients of the master, using a text editor running as <code class="literal">root</code>, edit the <code class="literal">/etc/chrony.conf</code> as follows:
				</p><pre class="literallayout">server master
driftfile /var/lib/chrony/drift
logdir /var/log/chrony
log measurements statistics tracking
keyfile /etc/chrony.keys
commandkey 24
local stratum 10
initstepslew 20 master
allow 192.0.2.123</pre><p>
					Where <code class="literal">192.0.2.123</code> is the address of the master, and <code class="literal">master</code> is the host name of the master. Clients with this configuration will resynchronize the master if it restarts.
				</p><p>
					On the client systems which are not to be direct clients of the master, the <code class="literal">/etc/chrony.conf</code> file should be the same except that the <code class="literal">local</code> and <code class="literal">allow</code> directives should be omitted.
				</p><p>
					In an isolated network, you can also use the <code class="literal">local</code> directive that enables a local reference mode, which allows <code class="literal">chronyd</code> operating as an <code class="literal">NTP</code> server to appear synchronized to real time, even when it was never synchronized or the last update of the clock happened a long time ago.
				</p><p>
					To allow multiple servers in the network to use the same local configuration and to be synchronized to one another, without confusing clients that poll more than one server, use the <code class="literal">orphan</code> option of the <code class="literal">local</code> directive which enables the orphan mode. Each server needs to be configured to poll all other servers with <code class="literal">local</code>. This ensures that only the server with the smallest reference ID has the local reference active and other servers are synchronized to it. When the server fails, another one will take over.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using-chrony-with-hw-timestamping_using-chrony-to-configure-ntp"/>Chrony with HW timestamping</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="understanding-hw-timestamping_using-chrony-to-configure-ntp"/>Understanding hardware timestamping</h2></div></div></div><p>
					Hardware timestamping is a feature supported in some Network Interface Controller (NICs) which provides accurate timestamping of incoming and outgoing packets. <code class="literal">NTP</code> timestamps are usually created by the kernel and <span class="strong"><strong><span class="application">chronyd</span></strong></span> with the use of the system clock. However, when HW timestamping is enabled, the NIC uses its own clock to generate the timestamps when packets are entering or leaving the link layer or the physical layer. When used with <code class="literal">NTP</code>, hardware timestamping can significantly improve the accuracy of synchronization. For best accuracy, both <code class="literal">NTP</code> servers and <code class="literal">NTP</code> clients need to use hardware timestamping. Under ideal conditions, a sub-microsecond accuracy may be possible.
				</p><p>
					Another protocol for time synchronization that uses hardware timestamping is <code class="literal">PTP</code>.
				</p><p>
					Unlike <code class="literal">NTP</code>, <code class="literal">PTP</code> relies on assistance in network switches and routers. If you want to reach the best accuracy of synchronization, use <code class="literal">PTP</code> on networks that have switches and routers with <code class="literal">PTP</code> support, and prefer <code class="literal">NTP</code> on networks that do not have such switches and routers.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-verifying-hw-timestamping"/>Verifying support for hardware timestamping</h2></div></div></div><p>
					To verify that hardware timestamping with <code class="literal">NTP</code> is supported by an interface, use the <code class="literal">ethtool -T</code> command. An interface can be used for hardware timestamping with <code class="literal">NTP</code> if <code class="literal">ethtool</code> lists the <code class="literal">SOF_TIMESTAMPING_TX_HARDWARE</code> and <code class="literal">SOF_TIMESTAMPING_TX_SOFTWARE</code> capabilities and also the <code class="literal">HWTSTAMP_FILTER_ALL</code> filter mode.
				</p><div class="example"><a id="verifying-hw-timestamping"/><p class="title"><strong>Example 5.1. Verifying support for hardware timestamping on a specific interface</strong></p><div class="example-contents"><pre class="literallayout">~]# ethtool -T eth0</pre><p>
						Output:
					</p><pre class="literallayout">Timestamping parameters for eth0:
Capabilities:
        hardware-transmit     (SOF_TIMESTAMPING_TX_HARDWARE)
        software-transmit     (SOF_TIMESTAMPING_TX_SOFTWARE)
        hardware-receive      (SOF_TIMESTAMPING_RX_HARDWARE)
        software-receive      (SOF_TIMESTAMPING_RX_SOFTWARE)
        software-system-clock (SOF_TIMESTAMPING_SOFTWARE)
        hardware-raw-clock    (SOF_TIMESTAMPING_RAW_HARDWARE)
PTP Hardware Clock: 0
Hardware Transmit Timestamp Modes:
        off                   (HWTSTAMP_TX_OFF)
        on                    (HWTSTAMP_TX_ON)
Hardware Receive Filter Modes:
        none                  (HWTSTAMP_FILTER_NONE)
        all                   (HWTSTAMP_FILTER_ALL)
        ptpv1-l4-sync         (HWTSTAMP_FILTER_PTP_V1_L4_SYNC)
        ptpv1-l4-delay-req    (HWTSTAMP_FILTER_PTP_V1_L4_DELAY_REQ)
        ptpv2-l4-sync         (HWTSTAMP_FILTER_PTP_V2_L4_SYNC)
        ptpv2-l4-delay-req    (HWTSTAMP_FILTER_PTP_V2_L4_DELAY_REQ)
        ptpv2-l2-sync         (HWTSTAMP_FILTER_PTP_V2_L2_SYNC)
        ptpv2-l2-delay-req    (HWTSTAMP_FILTER_PTP_V2_L2_DELAY_REQ)
        ptpv2-event           (HWTSTAMP_FILTER_PTP_V2_EVENT)
        ptpv2-sync            (HWTSTAMP_FILTER_PTP_V2_SYNC)
        ptpv2-delay-req       (HWTSTAMP_FILTER_PTP_V2_DELAY_REQ)</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-enabling-hw-timestamping"/>Enabling hardware timestamping</h2></div></div></div><p>
					To enable hardware timestamping, use the <code class="literal">hwtimestamp</code> directive in the <code class="literal">/etc/chrony.conf</code> file. The directive can either specify a single interface, or a wildcard character can be used to enable hardware timestamping on all interfaces that support it. Use the wildcard specification in case that no other application, like <span class="strong"><strong><span class="application">ptp4l</span></strong></span> from the <code class="literal">linuxptp</code> package, is using hardware timestamping on an interface. Multiple <code class="literal">hwtimestamp</code> directives are allowed in the chrony configuration file.
				</p><div class="example"><a id="enabling-hardware-timestamping"/><p class="title"><strong>Example 5.2. Enabling hardware timestamping by using the hwtimestamp directive</strong></p><div class="example-contents"><pre class="literallayout">hwtimestamp eth0
hwtimestamp eth1
hwtimestamp *</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-configuraing-polling-interval"/>Configuring client polling interval</h2></div></div></div><p>
					The default range of a polling interval (64-1024 seconds) is recommended for servers on the Internet. For local servers and hardware timestamping, a shorter polling interval needs to be configured in order to minimize offset of the system clock.
				</p><p>
					The following directive in <code class="literal">/etc/chrony.conf</code> specifies a local <code class="literal">NTP</code> server using one second polling interval:
				</p><pre class="literallayout">server ntp.local minpoll 0 maxpoll 0</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-enabling-interleaved-mode"/>Enabling interleaved mode</h2></div></div></div><p>
					<code class="literal">NTP</code> servers that are not hardware <code class="literal">NTP</code> appliances, but rather general purpose computers running a software <code class="literal">NTP</code> implementation, like <span class="strong"><strong><span class="application">chrony</span></strong></span>, will get a hardware transmit timestamp only after sending a packet. This behavior prevents the server from saving the timestamp in the packet to which it corresponds. In order to enable <code class="literal">NTP</code> clients receiving transmit timestamps that were generated after the transmission, configure the clients to use the <code class="literal">NTP</code> interleaved mode by adding the <code class="literal">xleave</code> option to the server directive in <code class="literal">/etc/chrony.conf</code>:
				</p><pre class="literallayout">server ntp.local minpoll 0 maxpoll 0 xleave</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-configuration-many-clients"/>Configuring server for large number of clients</h2></div></div></div><p>
					The default server configuration allows a few thousands of clients at most to use the interleaved mode concurrently. To configure the server for a larger number of clients, increase the <code class="literal">clientloglimit</code> directive in <code class="literal">/etc/chrony.conf</code>. This directive specifies the maximum size of memory allocated for logging of clients' access on the server:
				</p><pre class="literallayout">clientloglimit 100000000</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-verifying-hardware-timestamping"/>Verifying hardware timestamping</h2></div></div></div><p>
					To verify that the interface has successfully enabled hardware timestamping, check the system log. The log should contain a message from <code class="literal">chronyd</code> for each interface with successfully enabled hardware timestamping.
				</p><div class="example"><a id="verifying-hardware-timestamping"/><p class="title"><strong>Example 5.3. Log messages for interfaces with enabled hardware timestamping</strong></p><div class="example-contents"><pre class="literallayout">chronyd[4081]: Enabled HW timestamping on eth0
chronyd[4081]: Enabled HW timestamping on eth1</pre></div></div><p>
					When <code class="literal">chronyd</code> is configured as an <code class="literal">NTP</code> client or peer, you can have the transmit and receive timestamping modes and the interleaved mode reported for each <code class="literal">NTP</code> source by the <code class="literal">chronyc ntpdata</code> command:
				</p><div class="example"><a id="Report-mode-for-source"/><p class="title"><strong>Example 5.4. Reporting the transmit, receive timestamping and interleaved mode for each NTP source</strong></p><div class="example-contents"><pre class="literallayout">~]# chronyc ntpdata</pre><p>
						Output:
					</p><pre class="literallayout">Remote address  : 203.0.113.15 (CB00710F)
Remote port     : 123
Local address   : 203.0.113.74 (CB00714A)
Leap status     : Normal
Version         : 4
Mode            : Server
Stratum         : 1
Poll interval   : 0 (1 seconds)
Precision       : -24 (0.000000060 seconds)
Root delay      : 0.000015 seconds
Root dispersion : 0.000015 seconds
Reference ID    : 47505300 (GPS)
Reference time  : Wed May 03 13:47:45 2017
Offset          : -0.000000134 seconds
Peer delay      : 0.000005396 seconds
Peer dispersion : 0.000002329 seconds
Response time   : 0.000152073 seconds
Jitter asymmetry: +0.00
NTP tests       : 111 111 1111
Interleaved     : Yes
Authenticated   : No
TX timestamping : Hardware
RX timestamping : Hardware
Total TX        : 27
Total RX        : 27
Total valid RX  : 27</pre></div></div><div class="example"><a id="stability-NTP-measurements"/><p class="title"><strong>Example 5.5. Reporting the stability of NTP measurements</strong></p><div class="example-contents"><pre class="literallayout"># chronyc sourcestats</pre><p>
						With hardware timestamping enabled, stability of <code class="literal">NTP</code> measurements should be in tens or hundreds of nanoseconds, under normal load. This stability is reported in the <code class="literal">Std Dev</code> column of the output of the <code class="literal">chronyc sourcestats</code> command:
					</p><p>
						Output:
					</p><pre class="literallayout">210 Number of sources = 1
Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
ntp.local                  12   7    11     +0.000      0.019     +0ns    49ns</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-configuring-PTP-NTP-bridge"/>Configuring PTP-NTP bridge</h2></div></div></div><p>
					If a highly accurate Precision Time Protocol (<code class="literal">PTP</code>) grandmaster is available in a network that does not have switches or routers with <code class="literal">PTP</code> support, a computer may be dedicated to operate as a <code class="literal">PTP</code> slave and a stratum-1 <code class="literal">NTP</code> server. Such a computer needs to have two or more network interfaces, and be close to the grandmaster or have a direct connection to it. This will ensure highly accurate synchronization in the network.
				</p><p>
					Configure the <span class="strong"><strong><span class="application">ptp4l</span></strong></span> and <span class="strong"><strong><span class="application">phc2sys</span></strong></span> programs from the <code class="literal">linuxptp</code> packages to use one interface to synchronize the system clock using <code class="literal">PTP</code>.
				</p><p>
					Configure <code class="literal">chronyd</code> to provide the system time using the other interface:
				</p><div class="example"><a id="configuring-NTP-bridge"/><p class="title"><strong>Example 5.6. Configuring chronyd to provide the system time using the other interface</strong></p><div class="example-contents"><pre class="literallayout">bindaddress 203.0.113.74
hwtimestamp eth1
local stratum 1</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="achieving-settings-supported-by-ntp_using-chrony-to-configure-ntp"/>Achieving some settings previously supported by ntp in chrony</h1></div></div></div><p>
				Some settings that were in previous major version of Red Hat Enterprise Linux supported by <span class="strong"><strong><span class="application">ntp</span></strong></span>, are not supported by <span class="strong"><strong><span class="application">chrony</span></strong></span>. This section lists such settings, and describes ways to achieve them on a system with <span class="strong"><strong><span class="application">chrony</span></strong></span>.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="monitoring_by_ntpq_and_ntpdc"/>Monitoring by ntpq and ntpdc</h2></div></div></div><p>
					<code class="literal">chronyd</code> cannot be monitored by the <span class="strong"><strong><span class="application">ntpq</span></strong></span> and <span class="strong"><strong><span class="application">ntpdc</span></strong></span> utilities from the <span class="strong"><strong><span class="appplication">ntp</span></strong></span> distribution, because <span class="strong"><strong><span class="application">chrony</span></strong></span> does not support the <code class="literal">NTP</code> modes 6 and 7. It supports a different protocol and <span class="strong"><strong><span class="application">chronyc</span></strong></span> is the client implementation. For more information, see the <code class="literal">chronyc(1)</code> man page.
				</p><p>
					To monitor the status of the system clock sychronized by <code class="literal">chronyd</code>, you can:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Use the tracking command
						</li><li class="listitem">
							Use the <span class="strong"><strong><span class="application">ntpstat</span></strong></span> utility, which supports <span class="strong"><strong><span class="application">chrony</span></strong></span> and provides a similar output as it used to with <code class="literal">ntpd</code>
						</li></ul></div><div class="example"><a id="exam-use-tracking-command"/><p class="title"><strong>Example 5.7. Using the tracking command</strong></p><div class="example-contents"><pre class="literallayout">$ chronyc -n tracking
Reference ID    : 0A051B0A (10.5.27.10)
Stratum         : 2
Ref time (UTC)  : Thu Mar 08 15:46:20 2018
System time     : 0.000000338 seconds slow of NTP time
Last offset     : +0.000339408 seconds
RMS offset      : 0.000339408 seconds
Frequency       : 2.968 ppm slow
Residual freq   : +0.001 ppm
Skew            : 3.336 ppm
Root delay      : 0.157559142 seconds
Root dispersion : 0.001339232 seconds
Update interval : 64.5 seconds
Leap status     : Normal</pre></div></div><div class="example"><a id="exam-use-ntpstat-utility"/><p class="title"><strong>Example 5.8. Using the ntpstat utility</strong></p><div class="example-contents"><pre class="literallayout">$ ntpstat
synchronised to NTP server (10.5.27.10) at stratum 2
   time correct to within 80 ms
   polling server every 64 s</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="using_authentication_mechanism_based_on_public_key_cryptography"/>Using authentication mechanism based on public key cryptography</h2></div></div></div><p>
					In Red Hat Enterprise Linux 7, <span class="strong"><strong><span class="application">ntp</span></strong></span> supported <span class="strong"><strong><span class="application">Autokey</span></strong></span>, which is an authentication mechanism based on public key cryptography. <span class="strong"><strong><span class="application">Autokey</span></strong></span> is not supported in <code class="literal">chronyd</code>.
				</p><p>
					On a Red Hat Enterprise Linux 8 system, it is recommended to use symmetric keys instead. Generate the keys with the <code class="literal">chronyc keygen</code> command. A client and server need to share a key specified in <code class="literal">/etc/chrony.keys</code>. The client can enable authentication using the <code class="literal">key</code> option in the <code class="literal">server</code>, <code class="literal">pool</code>, or <code class="literal">peer</code> directive.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="using_ephemeral_symmetric_associations"/>Using ephemeral symmetric associations</h2></div></div></div><p>
					In Red Hat Enterprise Linux 7, <code class="literal">ntpd</code> supported ephemeral symmetric associations, which can be mobilized by packets from peers which are not specified in the <code class="literal">ntp.conf</code> configuration file. In Red Hat Enterprise Linux 8, <code class="literal">chronyd</code> needs all peers to be specified in <code class="literal">chrony.conf</code>. Ephemeral symmetric associations are not supported.
				</p><p>
					Note that using the client/server mode enabled by the <code class="literal">server</code> or <code class="literal">pool</code> directive is more secure compared to the symmetric mode enabled by the <code class="literal">peer</code> directive.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="multicast_broadcast_client"/>multicast/broadcast client</h2></div></div></div><p>
					Red Hat Enterprise Linux 7 supported the broadcast/multicast <code class="literal">NTP</code> mode, which simplifies configuration of clients. With this mode, clients can be configured to just listen for packets sent to a multicast/broadcast address instead of listening for specific names or addresses of individual servers, which may change over time.
				</p><p>
					In Red Hat Enterprise Linux 8, <code class="literal">chronyd</code> does not support the broadcast/multicast mode. The main reason is that it is less accurate and less secure than the ordinary client/server and symmetric modes.
				</p><p>
					There are several options of migration from an <code class="literal">NTP</code> broadcast/multicast setup:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							Configure DNS to translate a single name, such as ntp.example.com, to multiple addresses of different servers
						</p><p class="simpara">
							Clients can have a static configuration using only a single pool directive to synchronize with multiple servers. If a server from the pool becomes unreacheable, or otherwise unsuitable for synchronization, the clients automatically replace it with another server from the pool.
						</p></li><li class="listitem"><p class="simpara">
							Distribute the list of <code class="literal">NTP</code> servers over DHCP
						</p><p class="simpara">
							When NetworkManager gets a list of <code class="literal">NTP</code> servers from the DHCP server, <code class="literal">chronyd</code> is automatically configured to use them. This feature can be disabled by adding <code class="literal">PEERNTP=no</code> to the <code class="literal">/etc/sysconfig/network</code> file.
						</p></li><li class="listitem"><p class="simpara">
							Use the <code class="literal">Precision Time Protocol (PTP)</code>
						</p><p class="simpara">
							This option is suitable mainly for environments where servers change frequently, or if a larger group of clients needs to be able to synchronize to each other without having a designated server.
						</p><p class="simpara">
							<code class="literal">PTP</code> was designed for multicast messaging and works similarly to the <code class="literal">NTP</code> broadcast mode. A <code class="literal">PTP</code> implementation is available in the <code class="literal">linuxptp</code> package.
						</p><p class="simpara">
							<code class="literal">PTP</code> normally requires hardware timestamping and support in network switches to perform well. However, <code class="literal">PTP</code> is expected to work better than <code class="literal">NTP</code> in the broadcast mode even with software timestamping and no support in network switches.
						</p><p class="simpara">
							In networks with very large number of <code class="literal">PTP</code> slaves in one communication path, it is recommended to configure the <code class="literal">PTP</code> slaves with the <code class="literal">hybrid_e2e</code> option in order to reduce the amount of network traffic generated by the slaves. You can configure a computer running <code class="literal">chronyd</code> as an <code class="literal">NTP</code> client, and possibly <code class="literal">NTP</code> server, to operate also as a <code class="literal">PTP</code> grandmaster to distribute synchronized time to a large number of computers using multicast messaging.
						</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="chrony-additional-resources_using-chrony-to-configure-ntp"/>Additional resources</h1></div></div></div><p>
				The following sources of information provide additional resources regarding <span class="strong"><strong><span class="application">chrony</span></strong></span>.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="installed_documentation_3"/>Installed Documentation</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<code class="literal">chronyc(1)</code> man page — Describes the <span class="strong"><strong><span class="application">chronyc</span></strong></span> command-line interface tool including commands and command options.
						</li><li class="listitem">
							<code class="literal">chronyd(8)</code> man page — Describes the <code class="literal">chronyd</code> daemon including commands and command options.
						</li><li class="listitem">
							<code class="literal">chrony.conf(5)</code> man page — Describes the <span class="strong"><strong><span class="application">chrony</span></strong></span> configuration file.
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="online_documentation_3"/>Online Documentation</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="https://chrony.tuxfamily.org/doc/3.3/chronyc.html">https://chrony.tuxfamily.org/doc/3.3/chronyc.html</a>
						</li><li class="listitem">
							<a class="link" href="https://chrony.tuxfamily.org/doc/3.3/chronyd.html">https://chrony.tuxfamily.org/doc/3.3/chronyd.html</a>
						</li><li class="listitem">
							<a class="link" href="https://chrony.tuxfamily.org/doc/3.3/chrony.conf.html">https://chrony.tuxfamily.org/doc/3.3/chrony.conf.html</a>
						</li></ul></div><p>
					For answers to FAQs, see <a class="link" href="https://chrony.tuxfamily.org/faq.html">https://chrony.tuxfamily.org/faq.html</a>
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="managing-time-synchronization-using-rhel-system-roles_using-chrony-to-configure-ntp"/>Managing time synchronization using RHEL System Roles</h1></div></div></div><p>
				You can manage time synchronization on multiple target machines using the <code class="literal">timesync</code> role.
			</p><p>
				The <code class="literal">timesync</code> role installs and configures an NTP or PTP implementation to operate as an NTP client or PTP slave in order to synchronize the system clock with NTP servers or grandmasters in PTP domains.
			</p><p>
				Note that using the <code class="literal">timesync</code> role also facilitates <a class="link" href="using-chrony-to-configure-ntp.html#migrating-to-chrony_using-chrony-to-configure-ntp" title="Migrating to chrony">migration to chrony</a>, because you can use the same playbook on all versions of Red Hat Enterprise Linux starting with RHEL 6 regardless of whether the system uses <span class="strong"><strong><span class="application">ntp</span></strong></span> or <span class="strong"><strong><span class="application">chrony</span></strong></span> to implement the NTP protocol.
			</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					The <code class="literal">timesync</code> role replaces the configuration of the given or detected provider service on the managed host. Previous settings are lost, even if they are not specified in the role variables. The only preserved setting is the choice of provider if the <code class="literal">timesync_ntp_provider</code> variable is not defined.
				</p></div><p>
				The following example shows how to apply the <code class="literal">timesync</code> role in a situation with just one pool of servers.
			</p><div class="example"><a id="idm140276670108416"/><p class="title"><strong>Example 5.9. An example playbook applying the timesync role for a single pool of servers</strong></p><div class="example-contents"><pre class="literallayout">---
- hosts: timesync-test
  vars:
    timesync_ntp_servers:
      - hostname: 2.rhel.pool.ntp.org
        pool: yes
        iburst: yes
  roles:
    - rhel-system-roles.timesync</pre></div></div><p>
				For more information on using the <code class="literal">timesync</code> role, see <a class="link" href="https://github.com/linux-system-roles/timesync">System roles documentation</a>.
			</p></div></div></body></html>