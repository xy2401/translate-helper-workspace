<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. IPVLAN入门</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. IPVLAN入门</h1></div></div></div><p>本文档介绍了IPVLAN驱动程序。
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ipvlan-overview_getting-started-with-ipvlan"></a> IPVLAN概述</h1></div></div></div><p>IPVLAN是虚拟网络设备的驱动程序，可以在容器环境中用于访问主机网络。无论主机网络内创建的IPVLAN设备数量是多少，IPVLAN都会向外部网络公开单个MAC地址。这意味着用户可以在多个容器中拥有多个IPVLAN设备，并且相应的交换机可以读取单个MAC地址。当本地交换机对其可以管理的MAC地址总数施加约束时，IPVLAN驱动程序很有用。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ipvlan-modes_getting-started-with-ipvlan"></a> IPVLAN模式</h1></div></div></div><p>IPVLAN可使用以下模式：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
						<span class="strong"><strong>L2模式</strong></span>
					</p><p class="simpara">在IPVLAN <span class="strong"><strong>L2模式下</strong></span> ，虚拟设备接收并响应地址解析协议（ARP）请求。<code class="literal">netfilter</code>框架仅在拥有虚拟设备的容器内运行。在容器化流量的默认命名空间中不执行<code class="literal">netfilter</code>链。使用<span class="strong"><strong>L2模式</strong></span>可提供良好的性能，但对网络流量的控制较少。
					</p></li><li class="listitem"><p class="simpara">
						<span class="strong"><strong>L3模式</strong></span>
					</p><p class="simpara">在<span class="strong"><strong>L3模式下</strong></span> ，虚拟设备仅处理<span class="strong"><strong>L3</strong></span>流量及以上流量。虚拟设备不响应ARP请求，用户必须手动为相关对等体上的IPVLAN IP地址配置邻居条目。相关容器的出口流量登陆到默认命名空间中的<code class="literal">netfilter</code> POSTROUTING和OUTPUT链，而入口流量的线程与<span class="strong"><strong>L2模式</strong></span>相同。使用<span class="strong"><strong>L3模式</strong></span>可提供良好的控制，但会降低网络流量性能。
					</p></li><li class="listitem"><p class="simpara">
						<span class="strong"><strong>L3S模式</strong></span>
					</p><p class="simpara">在<span class="strong"><strong>L3S模式下</strong></span> ，虚拟设备的处理方式与<span class="strong"><strong>L3模式</strong></span>相同，只是相关容器的出口和入口流量都位于默认命名空间中的<code class="literal">netfilter</code>链上。<span class="strong"><strong>L3S模式的</strong></span>行为与<span class="strong"><strong>L3模式</strong></span>类似，但可以更好地控制网络。
					</p></li></ul></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>在<span class="strong"><strong>L3</strong></span>和<span class="strong"><strong>L3S模式</strong></span>下，IPVLAN虚拟设备不接收广播和多播流量。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="overview-of-macvlan_getting-started-with-ipvlan"></a> MACVLAN概述</h1></div></div></div><p>MACVLAN驱动程序允许在单个NIC上创建多个虚拟网络设备，每个设备都由其自己唯一的MAC地址标识。落在物理NIC上的分组通过目的地的MAC地址被多路分解为相关的MACVLAN设备。MACVLAN设备不添加任何级别的封装。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ipvlan-and-macvlan_getting-started-with-ipvlan"></a> IPVLAN和MACVLAN的比较</h1></div></div></div><p>下表显示了MACVLAN和IPVLAN之间的主要区别。</p><div class="informaltable"><table border="1"><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th valign="top" style="text-align:left">MACVLAN</th><th valign="top" style="text-align:left">IPVLAN</th></tr></thead><tbody><tr><td valign="top" style="text-align:left"> <p>使用每个MACVLAN设备的MAC地址。交换机中MAC表的MAC地址超限可能导致连接失效。
							</p>
							 </td><td valign="top" style="text-align:left"> <p>使用单个MAC地址，不限制IPVLAN设备的数量。
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>全局命名空间的Netfilter规则不会影响子命名空间中MACVLAN设备的流量。
							</p>
							 </td><td valign="top" style="text-align:left"> <p>可以在<span class="strong"><strong>L3模式</strong></span>和<span class="strong"><strong>L3S模式下</strong></span>控制进出IPVLAN设备的流量。
							</p>
							 </td></tr></tbody></table></div><p>请注意，IPVLAN和MACVLAN都不需要任何级别的封装。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-ipvlan-network_getting-started-with-ipvlan"></a>配置IPVLAN网络</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="creating-and-configuring-the-ipvlan-device-using-iproute2_configuring-ipvlan-network"></a>使用iproute2创建和配置IPVLAN设备</h2></div></div></div><p>此过程说明如何使用iproute2设置IPVLAN设备。
				</p><h4><a id="procedure_43"></a>程序</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">要创建IPVLAN设备，请输入以下命令：</p><pre class="literallayout">~]# ip link add link <span class="emphasis"><em>real_NIC_device</em></span> name <span class="emphasis"><em>IPVLAN_device</em></span> type ipvlan mode l2</pre><p class="simpara">请注意，网络接口控制器（NIC）是将计算机连接到网络的硬件组件。
						</p><div class="example"><a id="idm139932781356608"></a><p class="title"><strong>例10.1。创建IPVLAN设备</strong></p><div class="example-contents"><pre class="screen">~]# ip link add link enp0s31f6 name my_ipvlan type ipvlan mode l2
~]# ip link
47: my_ipvlan@enp0s31f6: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000 link/ether e8:6a:6e:8a:a2:44 brd ff:ff:ff:ff:ff:ff</pre></div></div></li><li class="listitem"><p class="simpara">要为接口分配<code class="literal">IPv4</code>或<code class="literal">IPv6</code>地址，请输入以下命令：</p><pre class="literallayout">~]# ip addr add dev <span class="emphasis"><em>IPVLAN_device</em></span> <span class="emphasis"><em>IP_address/subnet_mask_prefix</em></span></pre></li><li class="listitem"><p class="simpara">如果在<span class="strong"><strong>L3模式</strong></span>或<span class="strong"><strong>L3S模式</strong></span>下配置IPVLAN设备，请进行以下设置：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">在远程主机上配置远程对等方的邻居设置：</p><pre class="literallayout">~]# ip neigh add dev <span class="emphasis"><em>peer_device</em></span> <span class="emphasis"><em>IPVLAN_device_IP_address</em></span> lladdr <span class="emphasis"><em>MAC_address</em></span></pre><p class="simpara">其中<span class="emphasis"><em>MAC_address</em></span>是IPVLAN设备所基于的真实NIC的MAC地址。
								</p></li><li class="listitem"><p class="simpara">使用以下命令为<span class="strong"><strong>L3模式</strong></span>配置IPVLAN设备：</p><pre class="literallayout">~]# ip neigh add dev <span class="emphasis"><em>real_NIC_device</em></span> <span class="emphasis"><em>peer_IP_address</em></span> lladdr <span class="emphasis"><em>peer_MAC_address</em></span></pre><p class="simpara">对于<span class="strong"><strong>L3S模式</strong></span> ：</p><pre class="literallayout">~]# ip route dev add <span class="emphasis"><em>real_NIC_device</em></span> <span class="emphasis"><em>peer_IP_address/32</em></span></pre><p class="simpara">其中IP-address表示远程对等体的地址。
								</p></li></ol></div></li><li class="listitem"><p class="simpara">要将IPVLAN设备设置为活动状态，请输入以下命令：</p><pre class="literallayout">~]# ip link set dev <span class="emphasis"><em>IPVLAN_device</em></span> up</pre></li><li class="listitem"><p class="simpara">要检查IPVLAN设备是否处于活动状态，请在远程主机上执行以下命令：</p><pre class="literallayout">~]# ping <span class="emphasis"><em>IP_address</em></span></pre><p class="simpara">其中<span class="emphasis"><em>IP_address</em></span>使用IPVLAN设备的IP地址。
						</p></li></ol></div></div></div></div></body></html>