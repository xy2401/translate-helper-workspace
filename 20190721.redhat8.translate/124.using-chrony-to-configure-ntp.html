<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 使用Chrony套件配置NTP</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 使用Chrony套件配置NTP</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-ntp-with-chrony-intro_using-chrony-to-configure-ntp"></a>使用chrony配置NTP的简介</h1></div></div></div><p>由于IT中的多种原因，准确的计时非常重要。例如，在网络中，需要包和日志中的准确时间戳。在Linux系统中， <code class="literal">NTP</code>协议由在用户空间中运行的守护程序实现。
			</p><p>用户空间守护程序更新内核中运行的系统时钟。系统时钟可以通过使用各种时钟源来节省时间。通常，使用<span class="emphasis"><em>时间戳计数器</em></span> （ <span class="strong"><strong>TSC</strong></span> ）。TSC是一个CPU寄存器，用于计算自上次复位以来的周期数。它非常快，分辨率高，没有中断。
			</p><p>在Red Hat Enterprise Linux 8中， <code class="literal">NTP</code>协议由<code class="literal">chronyd</code>守护程序实现，可从<code class="literal">chrony</code>软件包中的存储库获得。
			</p><p>这些部分描述了<span class="strong"><strong><span class="application">chrony</span></strong></span>套件的使用。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="chrony-intro_using-chrony-to-configure-ntp"></a> chrony套件简介</h1></div></div></div><p>
				<span class="strong"><strong><span class="application">chrony</span></strong></span>是<code class="literal">Network Time Protocol (NTP)</code>一种实现。你可以使用<span class="strong"><strong><span class="application">chrony</span></strong></span> ：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">使系统时钟与<code class="literal">NTP</code>服务器同步</li><li class="listitem">使系统时钟与参考时钟同步，例如GPS接收器</li><li class="listitem">使用手动时间输入同步系统时钟</li><li class="listitem">作为<code class="literal">NTPv4(RFC 5905)</code>服务器或对等体，为网络中的其他计算机提供时间服务</li></ul></div><p>
				<span class="strong"><strong><span class="application">chrony</span></strong></span>在各种条件下表现良好，包括间歇性网络连接，高度拥挤的网络，温度变化（普通计算机时钟对温度敏感），以及不能连续运行或在虚拟机上运行的系统。
			</p><p>通过Internet同步的两台机器之间的典型精度在几毫秒内，而局域网上的机器在几十微秒内的典型精度。硬件时间戳或硬件参考时钟可以提高同步到亚微秒级别的两台机器之间的准确度。
			</p><p>
				<span class="strong"><strong><span class="application">chrony</span></strong></span>由<code class="literal">chronyd</code> ，一个在用户空间中运行的守护进程和<span class="strong"><strong><span class="application">chronyc组成</span></strong></span> ，这是一个命令行程序，可用于监视<code class="literal">chronyd</code>的性能并在运行时更改各种操作参数。
			</p><p>的<span class="strong"><strong><span class="application">chrony</span></strong></span>守护程序， <code class="literal">chronyd</code> ，可以监测和由命令行实用程序<span class="strong"><strong><span class="application">chronyc</span></strong></span>控制。该实用程序提供了一个命令提示符，允许输入许多命令来查询<code class="literal">chronyd</code>的当前状态并更改其配置。默认情况下， <code class="literal">chronyd</code>仅接受来自<span class="strong"><strong><span class="application">chronyc</span></strong></span>本地实例的<span class="strong"><strong><span class="application">命令</span></strong></span> ，但可以将其配置为也接受来自远程主机的监视命令。应限制远程访问。
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="using-chronyc-to-control-chronyd_using-chrony-to-configure-ntp"></a>使用chronyc来控制chronyd</h2></div></div></div><p>要在交互模式下使用命令行实用程序<span class="strong"><strong><span class="application">chronyc</span></strong></span>更改<code class="literal">chronyd</code>的本地实例， <code class="literal">chronyd</code>以<code class="literal">root</code>身份输入以下命令：</p><pre class="literallayout">~]# chronyc</pre><p>
					如果要使用某些受限制的命令， <span class="strong"><strong><span class="application">chronyc</span></strong></span>必须以<code class="literal">root</code> <span class="strong"><strong><span class="application">身份</span></strong></span>运行。
				</p><p><span class="strong"><strong><span class="application">chronyc</span></strong></span>命令提示符将显示如下：</p><pre class="literallayout">chronyc&gt;</pre><p>您可以键入<code class="literal">help</code>以列出所有命令。
				</p><p>如果与命令一起调用，也可以在非交互式命令模式下调用该实用程序，如下所示：</p><pre class="literallayout"><code class="literal">chronyc <span class="emphasis"><em>command</em></span></code></pre><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>使用<span class="strong"><strong><span class="application">chronyc</span></strong></span>进行的更改不是永久性的，它们会在<code class="literal">chronyd</code>重启后丢失。要进行永久性更改，请修改<code class="literal">/etc/chrony.conf</code> 。
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="differences-between-ntp-and-chrony_using-chrony-to-configure-ntp"></a> chrony和ntp之间的差异</h1></div></div></div><p>
				<code class="literal">Network Time Protocol (NTP)</code>有两种不同的实现，具有类似的基本功能 - <span class="strong"><strong><span class="application">ntp</span></strong></span>和<span class="strong"><strong><span class="application">chrony</span></strong></span> 。
			</p><p><span class="strong"><strong><span class="application">ntp</span></strong></span>和<span class="strong"><strong><span class="application">chrony</span></strong></span>都可以作为<code class="literal">NTP</code>客户端运行，以便将系统时钟与<code class="literal">NTP</code>服务器同步，并且它们可以作为网络中其他计算机的<code class="literal">NTP</code>服务器运行。每个实现都有一些独特的功能。有关<span class="strong"><strong><span class="application">ntp</span></strong></span>和<span class="strong"><strong><span class="application">chrony的</span></strong></span> <a class="link" href="https://chrony.tuxfamily.org/comparison.html">比较</a> ，请参阅<a class="link" href="https://chrony.tuxfamily.org/comparison.html">NTP实现的比较</a> 。
			</p><p>在大多数情况下，特定于<code class="literal">NTP</code>客户端的配置是相同的。<code class="literal">NTP</code>服务器使用<code class="literal">server</code>指令指定。可以使用<code class="literal">pool</code>指令指定服务器<code class="literal">pool</code> 。
			</p><p>特定于<code class="literal">NTP</code>服务器的配置在控制客户端访问的方式上有所不同。默认情况下， <code class="literal">ntpd</code>响应来自任何地址的客户端请求。可以使用<code class="literal">restrict</code>指令限制访问，但如果<code class="literal">ntpd</code>将任何服务器用作客户端，则无法完全禁用访问。 <code class="literal">chronyd</code>默认情况下不允许访问，仅作为<code class="literal">NTP</code>客户端运行。要使<span class="strong"><strong><span class="application">chrony</span></strong></span>作为<code class="literal">NTP</code>服务器运行，您需要在<code class="literal">allow</code>指令中指定一些地址。
			</p><p>
				<code class="literal">ntpd</code>和<code class="literal">chronyd</code>在系统时钟校正方面的默认行为也不同。当偏移量大于128毫秒时， <code class="literal">ntpd</code>逐步校正时钟。如果偏移量大于1000秒，则<code class="literal">ntpd</code>退出，除非它是时钟的第一次校正，并且使用<code class="literal">-g</code>选项启动<code class="literal">ntpd</code> 。 <code class="literal">chronyd</code>默认情况下不会计时，但<code class="literal">chrony</code>软件包中提供的默认<code class="literal">chrony.conf</code>文件允许在时钟的前三次更新中执行步骤。之后，通过加速或减慢时钟来缓慢地进行所有校正。可以发出<code class="literal">chronyc makestep</code>命令以强制<code class="literal">chronyd</code>随时执行时钟。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="migrating-to-chrony_using-chrony-to-configure-ntp"></a>迁移到chrony</h1></div></div></div><p>在Red Hat Enterprise Linux 7中，用户可以在<span class="strong"><strong><span class="application">ntp</span></strong></span>和<span class="strong"><strong><span class="application">chrony</span></strong></span>之间进行选择，以确保准确的计时。对于<span class="strong"><strong><span class="application">ntp</span></strong></span>和<span class="strong"><strong><span class="application">chrony</span></strong></span> ， <code class="literal">ntpd</code>和<code class="literal">chronyd</code> <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/system_administrators_guide/#sect-differences_between_ntpd_and_chronyd">之间的差异</a> ，请参阅<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/system_administrators_guide/#sect-differences_between_ntpd_and_chronyd">ntpd和chronyd之间的差异</a> 。
			</p><p>在Red Hat Enterprise Linux 8中，不再支持<span class="strong"><strong><span class="application">ntp</span></strong></span> 。 <span class="strong"><strong><span class="application">chrony</span></strong></span>默认启用。因此，您可能需要从<span class="strong"><strong><span class="application">ntp</span></strong></span>迁移到<span class="strong"><strong><span class="application">chrony</span></strong></span> 。
			</p><p>在大多数情况下，从<span class="strong"><strong><span class="application">ntp</span></strong></span>迁移到<span class="strong"><strong><span class="application">chrony</span></strong></span>很简单。程序，配置文件和服务的相应名称是：</p><div class="table"><a id="tabl-corresponding-names-when-migrating-to-chrony"></a><p class="title"><strong>表5.1。从ntp迁移到chrony时程序，配置文件和服务的相应名称</strong></p><div class="table-contents"><table border="1" summary="Corresponding names of the programs, configuration files and services when migrating from ntp to chrony"><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th valign="top" style="text-align:left">ntp名称</th><th valign="top" style="text-align:left">chrony名字</th></tr></thead><tbody><tr><td valign="top" style="text-align:left"> <p>/etc/ntp.conf中</p>
							 </td><td valign="top" style="text-align:left"> <p>/etc/chrony.conf</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>的/ etc / NTP /键</p>
							 </td><td valign="top" style="text-align:left"> <p>/etc/chrony.keys</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>NTPD</p>
							 </td><td valign="top" style="text-align:left"> <p>chronyd</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>则ntpq</p>
							 </td><td valign="top" style="text-align:left"> <p>chronyc</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>ntpd.service</p>
							 </td><td valign="top" style="text-align:left"> <p>chronyd.service</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>NTP-wait.service</p>
							 </td><td valign="top" style="text-align:left"> <p>chrony-wait.service</p>
							 </td></tr></tbody></table></div></div><p><code class="literal">ntp</code>发行版中包含的<span class="strong"><strong><span class="application">ntpdate</span></strong></span>和<span class="strong"><strong><span class="application">sntp</span></strong></span>实用程序可以使用<code class="literal">-q</code>选项或<code class="literal">-t</code>选项替换为<code class="literal">chronyd</code> 。可以在命令行上指定配置，以避免读取<code class="literal">/etc/chrony.conf</code> 。例如， <code class="literal">chronyd</code>可以启动为：而不是运行<code class="literal">ntpdate ntp.example.com</code> 。</p><pre class="literallayout"># chronyd -q 'server ntp.example.com iburst'
2018-05-18T12:37:43Z chronyd version 3.3 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +SECHASH +IPV6 +DEBUG)
2018-05-18T12:37:43Z Initial frequency -2.630 ppm
2018-05-18T12:37:48Z System clock wrong by 0.003159 seconds (step)
2018-05-18T12:37:48Z chronyd exiting</pre><p><span class="strong"><strong><span class="application">ntpstat</span></strong></span>实用程序以前包含在<code class="literal">ntp</code>包中，仅支持<code class="literal">ntpd</code> ，现在支持<code class="literal">ntpd</code>和<code class="literal">chronyd</code> 。它在<code class="literal">ntpstat</code>包中提供。
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migration_script"></a>迁移脚本</h2></div></div></div><p>名为<code class="literal">ntp2chrony.py</code>的Python脚本包含在<code class="literal">chrony</code>软件包的文档中（ <code class="literal">/usr/share/doc/chrony</code> ）。该脚本自动将现有的<code class="literal">ntp</code>配置转换为<code class="literal">chrony</code> 。它支持<code class="literal">ntp.conf</code>文件中最常用的指令和选项。转换中忽略的任何行都作为注释包含在生成的<code class="literal">chrony.conf</code>文件中以供查看。在<code class="literal">ntp</code>密钥文件中指定但未在<code class="literal">ntp.conf</code>中标记为可信密钥的密钥作为注释包含在生成的<code class="literal">chrony.keys</code>文件中。
				</p><p>默认情况下，脚本不会覆盖任何文件。如果<code class="literal">/etc/chrony.conf</code>或<code class="literal">/etc/chrony.keys</code>已存在，则可以使用<code class="literal">-b</code>选项将文件重命名为备份。该脚本支持其他选项。<code class="literal">--help</code>选项打印所有支持的选项。
				</p><p>使用<code class="literal">ntp</code>包中提供的默认<code class="literal">ntp.conf</code>调用脚本的示例如下：</p><pre class="literallayout"># python3 /usr/share/doc/chrony/ntp2chrony.py -b -v
Reading /etc/ntp.conf
Reading /etc/ntp/crypto/pw
Reading /etc/ntp/keys
Writing /etc/chrony.conf
Writing /etc/chrony.keys</pre><p>在这种情况下忽略的唯一指令是<code class="literal">disable monitor</code> ，它在<code class="literal">noclientlog</code>指令中具有chrony等效物，但它仅包含在默认的<code class="literal">ntp.conf</code>以减轻放大攻击。
				</p><p>生成的<code class="literal">chrony.conf</code>文件通常包含许多与<code class="literal">ntp.conf</code>的限制行对应的<code class="literal">allow</code>指令。如果您不想将<code class="literal">chronyd</code>作为<code class="literal">NTP</code>服务器运行，请从<code class="literal">chrony.conf</code>删除所有<code class="literal">allow</code>指令。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="timesync_role"></a> Timesync角色</h2></div></div></div><p>请注意，在Red Hat Enterprise Linux 7系统上使用<a class="link" href="using-chrony-to-configure-ntp.html#managing-time-synchronization-using-rhel-system-roles_using-chrony-to-configure-ntp" title="使用RHEL系统角色管理时间同步">timesync角色</a>有助于迁移到<span class="strong"><strong><span class="application">chrony</span></strong></span> ，因为无论系统是使用<span class="strong"><strong><span class="application">ntp</span></strong></span>还是<span class="strong"><strong><span class="application">chrony</span></strong></span>来实现NTP协议，您都可以在从RHEL 6开始的所有RHEL版本上使用相同的playbook 。
				</p><p>有关使用<code class="literal">timesync</code>角色管理时间同步的更多信息，请参阅<a class="link" href="https://github.com/linux-system-roles/timesync">系统角色文档</a> 。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-chrony_using-chrony-to-configure-ntp"></a>配置chrony</h1></div></div></div><p><code class="literal">chronyd</code>的默认配置文件是<code class="literal">/etc/chrony.conf</code> 。<code class="literal">-f</code>选项可用于指定备用配置文件路径。有关更多选项，请参见<code class="literal">chrony.conf(5)</code>手册页。有关可以使用的指令的完整列表，请参阅<a class="link" href="https://chrony.tuxfamily.org/doc/3.3/chrony.conf.html">chronyd配置文件</a> 。
			</p><p>以下是一系列<code class="literal">chronyd</code>配置选项：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">评论</span></dt><dd>评论前面应该是＃，％,;要么 ！
						</dd><dt><span class="term">允许</span></dt><dd><p class="simpara">（可选）指定允许<code class="literal">NTP</code>连接到充当<code class="literal">NTP</code>服务器的计算机的主机，子网或网络。默认情况下不允许连接。
						</p><p class="simpara">例子：</p></dd></dl></div><pre class="literallayout">allow 192.0.2.0/24</pre><p>使用此命令可以授予对特定网络的访问权限。
			</p><pre class="literallayout">allow 2001:0db8:85a3::8a2e:0370:7334</pre><p>使用此命令可以授予对<code class="literal">IPv6</code>访问权限。
			</p><p>需要在防火墙中打开UDP端口号123才能允许客户端访问：</p><pre class="literallayout">~]#  firewall-cmd --zone=public --add-port=123/udp</pre><p>如果要永久打开端口123，请使用<code class="literal">--permanent</code>选项：</p><pre class="literallayout">~]#  firewall-cmd --permanent --zone=public --add-port=123/udp</pre><div class="variablelist"><dl class="variablelist"><dt><span class="term">cmdallow</span></dt><dd>这与<code class="literal">allow</code>指令类似（请参阅<code class="literal">allow</code>部分），但它允许对特定子网或主机的控制访问（而不是<code class="literal">NTP</code>客户端访问）。（“控制访问”是指<span class="strong"><strong><span class="application">chronyc</span></strong></span>可以在这些主机上运行并成功连接到此计算机上的<code class="literal">chronyd</code> 。）语法相同。还有一个<code class="literal">cmddeny all</code>类似行为的指令<code class="literal">cmdallow all</code>指令。
						</dd><dt><span class="term">DUMPDIR</span></dt><dd>目录的路径，用于在重新启动<code class="literal">chronyd</code>保存测量历史记录（假设在未运行时未对系统时钟行为进行更改）。如果要使用此功能（通过配置文件中的<code class="literal">dumponexit</code>命令或<span class="strong"><strong><span class="application">chronyc中</span></strong></span>的<code class="literal">dump</code>命令），则应使用<code class="literal">dumpdir</code>命令定义保存测量历史记录的目录。
						</dd><dt><span class="term">dumponexit</span></dt><dd>如果存在此命令，则表示<code class="literal">chronyd</code>应保存程序退出时记录的每个时间源的测量历史记录。（参见上面的<code class="literal">dumpdir</code>命令）。
						</dd><dt><span class="term">hwtimestamp</span></dt><dd><code class="literal">hwtimestamp</code>指令启用硬件时间戳，以实现极其精确的同步。有关更多详细信息，请参阅<code class="literal">chrony.conf(5)</code>手册页。
						</dd><dt><span class="term">本地</span></dt><dd><p class="simpara"><code class="literal">local</code>关键字用于允许<code class="literal">chronyd</code>从客户端轮询它的角度看实时同步，即使它没有当前的同步源。此选项通常用于隔离网络中的“主”计算机，其中需要多台计算机彼此同步，并且“主”通过手动输入与实时保持一致。
						</p><p class="simpara">该命令的一个示例是：</p><pre class="literallayout">local stratum 10</pre><p class="simpara">大的值10表示时钟与参考时钟相距很多跳，其时间不可靠。如果计算机可以访问另一台最终与参考时钟同步的计算机，那么它几乎肯定会处于小于10的阶层。因此，为<code class="literal">local</code>命令选择高值（如10）可以防止机器自己的时间与实时混淆，是否会泄露给具有真实服务器可见性的客户端。
						</p></dd><dt><span class="term">日志</span></dt><dd><p class="simpara"><code class="literal">log</code>命令表示要记录某些信息。它接受以下选项：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">测量</span></dt><dd>此选项将原始<code class="literal">NTP</code>测量和相关信息记录到名为<code class="literal">measurements.log</code>的文件中。
									</dd><dt><span class="term">统计</span></dt><dd>此选项将有关回归处理的信息记录到名为<code class="literal">statistics.log</code>的文件中。
									</dd><dt><span class="term">追踪</span></dt><dd>此选项将更改记录到系统的增益或丢失率的估计值，以及对称为<code class="literal">tracking.log</code>的文件所做的任何调整。
									</dd><dt><span class="term">RTC</span></dt><dd>此选项记录有关系统实时时钟的信息。
									</dd><dt><span class="term">refclocks</span></dt><dd>此选项将原始和过滤的参考时钟测量记录到名为<code class="literal">refclocks.log</code>的文件中。
									</dd><dt><span class="term">tempcomp</span></dt><dd><p class="simpara">此选项将温度测量和系统速率补偿记录到名为<code class="literal">tempcomp.log</code>的文件中。
									</p><p class="simpara">日志文件将写入<code class="literal">logdir</code>命令指定的目录。
									</p><p class="simpara">该命令的一个示例是：</p><pre class="literallayout">log measurements statistics tracking</pre></dd></dl></div></dd><dt><span class="term">LOGDIR</span></dt><dd><p class="simpara">该指令允许指定写入日志文件的目录。
						</p><p class="simpara">使用此指令的一个示例是：</p><pre class="literallayout">logdir /var/log/chrony</pre></dd><dt><span class="term">makestep</span></dt><dd><p class="simpara">通常<code class="literal">chronyd</code>将使系统逐步校正任何时间偏移，通过根据需要减慢或加速时钟。在某些情况下，系统时钟可能到目前为止，这种转换过程需要很长时间才能纠正系统时钟。如果调整大于阈值，则此指令强制<code class="literal">chronyd</code>步进系统时钟，但仅当由于<code class="literal">chronyd</code>启动时没有更多时钟更新而不是指定限制（负值可用于禁用限制）。这在使用参考时钟时特别有用，因为<code class="literal">initstepslew</code>指令仅适用于<code class="literal">NTP</code>源。
						</p><p class="simpara">使用此指令的一个示例是：</p><pre class="literallayout">makestep 1000 10</pre><p class="simpara">如果调整大于1000秒，这将使系统时钟步进，但仅在前十个时钟更新中。
						</p></dd><dt><span class="term">maxchange</span></dt><dd><p class="simpara">该指令设置在时钟更新时更正的最大允许偏移量。仅在指定的更新次数之后执行检查，以允许对系统时钟进行大的初始调整。当出现大于指定最大值的偏移量时，它将在指定的次数内被忽略，然后<code class="literal">chronyd</code>将放弃并退出（负值可用于永不退出）。在这两种情况下都会向syslog发送一条消息。
						</p><p class="simpara">使用此指令的一个示例是：</p><pre class="literallayout">maxchange 1000 1 2</pre><p class="simpara">在第一次更新时， <code class="literal">chronyd</code>将检查每次更新时的偏移量，它将忽略大于1000秒的两次调整并退出另一次。
						</p></dd><dt><span class="term">maxupdateskew</span></dt><dd><p class="simpara"><code class="literal">chronyd</code>的任务之一是确定计算机时钟相对于其参考源的运行速度或速度。此外，它计算估计值周围的误差范围的估计值。
						</p><p class="simpara">如果误差范围太大，则表明测量尚未稳定下来，并且估计的增益或损失率不是非常可靠。
						</p><p class="simpara"><code class="literal">maxupdateskew</code>参数是用于确定估计是否太<code class="literal">maxupdateskew</code>的阈值。默认情况下，阈值为1000 ppm。
						</p><p class="simpara">语法格式为：</p><pre class="literallayout">maxupdateskew <span class="emphasis"><em>skew-in-ppm</em></span></pre><p class="simpara">对于通过电话线与服务器进行拨号连接，以及在LAN上的计算机为5或10时，以<span class="emphasis"><em>ppm</em></span>为单位的典型<span class="emphasis"><em>偏差</em></span>值可能为100。</p><p class="simpara">应该指出的是，这不是防止使用不可靠估计的唯一手段。在任何时候， <code class="literal">chronyd</code>跟踪估计的增益或损失率以及估计值的误差。当在来自其中一个源的另一个测量之后生成新估计时，使用加权组合算法来更新主估计。因此，如果<code class="literal">chronyd</code>具有现有的高可靠性主估计并且生成具有大误差界限的新估计，则现有主估计将在新主估计中占主导地位。
						</p></dd><dt><span class="term">minsources</span></dt><dd><p class="simpara"><code class="literal">minsources</code>指令设置在更新本地时钟之前在源选择算法中需要考虑为可选择的最小源数。
						</p><p class="simpara">语法格式为：</p><pre class="literallayout">minsources <span class="emphasis"><em>number-of-sources</em></span></pre><p class="simpara">默认情况下， <span class="emphasis"><em>source-of-sources</em></span>为1。将minsources设置为更大的数字可用于提高可靠性，因为多个源将需要彼此对应。
						</p></dd><dt><span class="term">noclientlog</span></dt><dd>该指令不带参数，指定不记录客户端访问。通常会记录它们，允许使用<span class="strong"><strong><span class="application">chronyc中</span></strong></span>的clients命令报告统计信息，并允许客户端在<code class="literal">server</code>指令中使用交叉模式和<code class="literal">xleave</code>选项。
						</dd><dt><span class="term">reselectdist</span></dt><dd><p class="simpara">当<code class="literal">chronyd</code>从可用源中选择同步源时，它将<code class="literal">chronyd</code>选择具有最小同步距离的源。但是，为避免在有相似距离的光源时频繁重新选择，将固定距离添加到当前未选择的光源的距离。可以使用<code class="literal">reselectdist</code>选项进行设置。默认情况下，距离为100微秒。
						</p><p class="simpara">语法格式为：</p><pre class="literallayout">reselectdist <span class="emphasis"><em>dist-in-seconds</em></span></pre></dd><dt><span class="term">stratumweight</span></dt><dd><p class="simpara"><code class="literal">stratumweight</code>指令设置当<code class="literal">chronyd</code>从可用来源选择同步源时，每个层应该向同步距离添加多少距离。
						</p><p class="simpara">语法格式为：</p><pre class="literallayout">stratumweight <span class="emphasis"><em>dist-in-seconds</em></span></pre><p class="simpara">默认情况下， <span class="emphasis"><em>dist-in-seconds</em></span>为1毫秒。这意味着具有较低层的源通常优于具有较高层的源，即使它们的距离明显更差。将<code class="literal">stratumweight</code>设置为0会使<code class="literal">chronyd</code>在选择源时忽略层。
						</p></dd><dt><span class="term">rtcfile</span></dt><dd><p class="simpara"><code class="literal">rtcfile</code>指令定义文件的名称，其中<code class="literal">chronyd</code>可以保存与跟踪系统实时时钟（RTC）精度相关的参数。
						</p><p class="simpara">语法格式为：</p><pre class="literallayout">rtcfile /var/lib/chrony/rtc</pre><p class="simpara">
							<code class="literal">chronyd</code>在此文件中保存的信息，当它退出而当<code class="literal">writertc</code>命令<span class="strong"><strong><span class="application">chronyc</span></strong></span>发出。保存的信息是RTC在某个时期的错误，该时期（自1970年1月1日以来的秒数），以及RTC获得或失去时间的速率。并非所有实时时钟都受支持，因为它们的代码是特定于系统的。请注意，如果使用此指令，则不应手动调整实时时钟，因为如果以随机间隔调整实时时钟漂移的速度，这将干扰<span class="strong"><strong><span class="application">chrony</span></strong></span>测量实际时钟漂移速率的需要。
						</p></dd><dt><span class="term">RTCSYNC</span></dt><dd>默认情况下， <code class="literal">rtcsync</code>指令存在于<code class="literal">/etc/chrony.conf</code>文件中。这将通知内核系统时钟保持同步，内核将每11分钟更新一次实时时钟。
						</dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring-chrony-for-security_using-chrony-to-configure-ntp"></a>配置chrony以确保安全性</h2></div></div></div><p>
					<span class="strong"><strong><span class="application">chronyc</span></strong></span>可以通过两种方式访问<code class="literal">chronyd</code> ：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Internet协议，IPv4或IPv6。
						</li><li class="listitem">Unix域套接字，可由<code class="literal">root</code>或<code class="literal">chrony</code>用户在本地访问。
						</li></ul></div><p>默认情况下， <span class="strong"><strong><span class="application">chronyc</span></strong></span>连接到Unix域套接字。默认路径为<code class="literal">/var/run/chrony/chronyd.sock</code> 。如果此连接失败，例如当<span class="strong"><strong><span class="application">chronyc</span></strong></span>在非root用户下运行时， <span class="strong"><strong><span class="application">chronyc会</span></strong></span>尝试连接到127.0.0.1然后再连接:: 1。
				</p><p>只允许以下监控命令（不影响<code class="literal">chronyd</code>的行为）来自网络：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">活动</li><li class="listitem">手册清单</li><li class="listitem">rtcdata</li><li class="listitem">平滑</li><li class="listitem">来源</li><li class="listitem">sourcestats</li><li class="listitem">追踪</li><li class="listitem">waitsync</li></ul></div><p>从该组主机<code class="literal">chronyd</code>接受这些命令可以与被配置<code class="literal">cmdallow</code>的配置文件中的指令<code class="literal">chronyd</code>或<code class="literal">cmdallow</code>在<span class="strong"><strong><span class="application">chronyc</span></strong></span>命令。默认情况下，仅从localhost（127.0.0.1或:: 1）接受命令。
				</p><p>所有其他命令只能通过Unix域套接字。当通过网络发送时， <code class="literal">chronyd</code>响应<code class="literal">Not authorised</code>错误，即使它来自localhost。
				</p><div class="orderedlist"><p class="title"><strong>使用chronyc远程访问<span class="strong"><strong><span class="application">chronyd</span></strong></span></strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">通过将以下内容添加到<code class="literal">/etc/chrony.conf</code>文件，允许从IPv4和IPv6地址进行访问：</p><pre class="literallayout">bindcmdaddress 0.0.0.0</pre><p class="simpara">要么</p><pre class="literallayout">bindcmdaddress :</pre></li><li class="listitem"><p class="simpara">使用<code class="literal">cmdallow</code>指令允许来自远程IP地址，网络或子网的命令。
						</p><div class="informalexample"><p>将以下内容添加到<code class="literal">/etc/chrony.conf</code>文件中：</p><pre class="literallayout">cmdallow 192.168.1.0/24</pre></div></li><li class="listitem"><p class="simpara">在防火墙中打开端口323以从远程系统连接。
						</p><pre class="literallayout">~]#  firewall-cmd --zone=public --add-port=323/udp</pre><p class="simpara">如果要永久打开端口323，请使用<code class="literal">--permanent</code> 。
						</p><pre class="literallayout">~]#  firewall-cmd --permanent --zone=public --add-port=323/udp</pre></li></ol></div><p>请注意， <code class="literal">allow</code>指令用于<code class="literal">NTP</code>访问，而<code class="literal">cmdallow</code>指令用于启用远程命令的接收。可以使用<span class="strong"><strong><span class="application">本地</span></strong></span>运行的<span class="strong"><strong><span class="application">chronyc</span></strong></span>临时进行这些更改。编辑配置文件以进行永久性更改。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using-chrony_using-chrony-to-configure-ntp"></a>使用Chrony</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-installing_chrony"></a>安装chrony</h2></div></div></div><p><span class="strong"><strong><span class="application">chrony</span></strong></span>套件默认安装在Red Hat Enterprise Linux上。要确保它，请以<code class="literal">root</code>身份运行以下命令：</p><pre class="literallayout">~]# yum install chrony</pre><p><span class="strong"><strong><span class="application">chrony</span></strong></span>守护程序的默认位置是<code class="literal">/usr/sbin/chronyd</code> 。命令行实用程序将安装到<code class="literal">/usr/bin/chronyc</code> 。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-checking_the_status_of_chronyd"></a>检查chronyd的状态</h2></div></div></div><p>要检查<code class="literal">chronyd</code>的状态，请发出以下命令：</p><pre class="literallayout">~]$ <code class="literal">systemctl status chronyd</code>
chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; enabled)
   Active: active (running) since Wed 2013-06-12 22:23:16 CEST; 11h ago</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-starting_chronyd"></a>从chronyd开始</h2></div></div></div><p>要启动<code class="literal">chronyd</code> ，请以<code class="literal">root</code> <code class="literal">chronyd</code>发出以下命令：</p><pre class="literallayout">~]# systemctl start chronyd</pre><p>要确保<code class="literal">chronyd</code>在系统启动时自动启动，请以<code class="literal">root</code>身份发出以下命令：</p><pre class="literallayout">~]# systemctl enable chronyd</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-stopping_chronyd"></a>停止chronyd</h2></div></div></div><p>要停止<code class="literal">chronyd</code> ，请以<code class="literal">root</code> <code class="literal">chronyd</code>发出以下命令：</p><pre class="literallayout">~]# systemctl stop chronyd</pre><p>要防止<code class="literal">chronyd</code>在系统启动时自动启动，请以<code class="literal">root</code>身份发出以下命令：</p><pre class="literallayout">~]# systemctl disable chronyd</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-checking_if_chrony_is_synchronized"></a>检查chrony是否同步</h2></div></div></div><p>要检查<span class="strong"><strong><span class="application">chrony</span></strong></span>是否已同步，请使用<code class="literal">tracking</code> ， <code class="literal">sources</code>和<code class="literal">sourcestats</code>命令。
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sect-checking_chrony_tracking"></a>检查chrony跟踪</h3></div></div></div><p>要检查<span class="strong"><strong><span class="application">chrony</span></strong></span>跟踪，请发出以下命令：</p><pre class="literallayout">~]$ <code class="literal">chronyc tracking</code>
Reference ID    : CB00710F (foo.example.net)
Stratum         : 3
Ref time (UTC)  : Fri Jan 27 09:49:17 2017
System time     :  0.000006523 seconds slow of NTP time
Last offset     : -0.000006747 seconds
RMS offset      : 0.000035822 seconds
Frequency       : 3.225 ppm slow
Residual freq   : 0.000 ppm
Skew            : 0.129 ppm
Root delay      : 0.013639022 seconds
Root dispersion : 0.001100737 seconds
Update interval : 64.2 seconds
Leap status     : Normal</pre><p>字段如下：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">参考ID</span></dt><dd>这是计算机当前同步到的服务器的引用ID和名称（或<code class="literal">IP</code>地址）（如果可用）。引用ID是十六进制数，以避免与IPv4地址混淆。
								</dd><dt><span class="term">地层</span></dt><dd>该层表示距离具有附加参考时钟的计算机有多少跳。这样的计算机是层1计算机，因此该示例中的计算机距离两跳（也就是说，abc是层-2并且从层-1同步）。
								</dd><dt><span class="term">参考时间</span></dt><dd>这是处理参考源的最后一次测量的时间（UTC）。
								</dd><dt><span class="term">系统时间</span></dt><dd>在正常操作中， <code class="literal">chronyd</code>从不调整系统时钟，因为时间刻度的任何跳跃都会对某些应用程序产生不利影响。相反，通过稍微加快或减慢系统时钟来纠正系统时钟中的任何错误，直到错误消除为止，然后返回到系统时钟的正常速度。这样做的结果是，系统时钟（由其他程序使用<code class="literal">gettimeofday()</code>系统调用或shell中的date命令读取）将与<code class="literal">chronyd</code>对当前true的估计不同time（在服务器模式下运行时向<code class="literal">NTP</code>客户端报告）。此行上报告的值是由此影响的差异。
								</dd><dt><span class="term">最后的偏移</span></dt><dd>这是上次更新时的估计本地偏移量。
								</dd><dt><span class="term">RMS偏移</span></dt><dd>这是偏移值的长期平均值。
								</dd><dt><span class="term">频率</span></dt><dd>“频率”是指如果<code class="literal">chronyd</code>没有纠正它，系统时钟错误的<code class="literal">chronyd</code> 。它以ppm（百万分率）表示。例如，1 ppm的值意味着当系统的时钟认为它已提前1秒时，它实际上相对于真实时间提前了1.000001秒。
								</dd><dt><span class="term">剩余频率</span></dt><dd><p class="simpara">这显示了当前所选参考源的“残余频率”。这反映了来自参考源的测量值指示频率应该与当前使用的频率之间的任何差异。
								</p><p class="simpara">这并不总是为零的原因是平滑过程应用于频率。每次获得来自参考源的测量值并计算新的残余频率时，将该残差的估计精度与现有频率值的估计精度（参见<code class="literal">skew</code> ）进行比较。计算新频率的加权平均值，权重取决于这些精度。如果来自参考源的测量值遵循一致趋势，则残差将随时间推移为零。
								</p></dd><dt><span class="term">斜</span></dt><dd>这是频率上的估计误差。
								</dd><dt><span class="term">根延迟</span></dt><dd>这是计算机最终同步的stratum-1计算机的网络路径延迟总数。根延迟值以纳秒分辨率打印。在某些极端情况下，此值可能为负值。（这可能出现在对称的对等安排中，其中计算机的频率没有相互跟踪，并且网络延迟相对于每台计算机的周转时间非常短。）
								</dd><dt><span class="term">根分散</span></dt><dd>这是通过所有计算机累积回到计算机最终同步的stratum-1计算机的总色散。色散是由于系统时钟分辨率，统计测量变化等。根色散值以纳秒分辨率打印。
								</dd><dt><span class="term">闰态</span></dt><dd>这是跳跃状态，可以是“正常”，“插入第二”，“删除第二”或“未同步”。
								</dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sect-checking_chrony_sources"></a>检查chrony来源</h3></div></div></div><p>sources命令显示有关<code class="literal">chronyd</code>正在访问的当前时间源的信息。
					</p><p>可以指定可选参数-v，这意味着详细。在这种情况下，额外的标题行显示为列的含义的提醒。
					</p><pre class="literallayout">~]$ chronyc sources
	210 Number of sources = 3
MS Name/IP address         Stratum Poll Reach LastRx Last sample
===============================================================================
#* GPS0                          0   4   377    11   -479ns[ -621ns] /-  134ns
^? a.b.c                         2   6   377    23   -923us[ -924us] +/-   43ms
^ d.e.f                         1   6   377    21  -2629us[-2619us] +/-   86ms</pre><p>列如下：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">中号</span></dt><dd>这表示源的模式。 <code class="literal">^</code>表示服务器， <code class="literal">=</code>表示对等， <code class="literal">#</code>表示本地连接的参考时钟。
								</dd><dt><span class="term">小号</span></dt><dd>此列指示源的状态。 “*”表示<code class="literal">chronyd</code>当前同步的源。 “+”表示与所选源组合的可接受来源。 “ - ”表示由组合算法排除的可接受的源。 “？“表示连接丢失或其数据包未通过所有测试的源。”x“表示<code class="literal">chronyd</code>认为是一个<span class="emphasis"><em>falseticker</em></span>的时钟（它的时间与大多数其他源不一致）。”〜“表示一个源，其中时间似乎有太多的变化。“？“条件也会在启动时显示，直到从中收集至少3个样本。
								</dd><dt><span class="term">名称/ IP地址</span></dt><dd>这显示了源的名称或<code class="literal">IP</code>地址，或参考时钟的参考ID。
								</dd><dt><span class="term">地层</span></dt><dd>这显示了源的层，如其最近收到的样本中所报告的。层1表示具有本地连接的参考时钟的计算机。与第1层计算机同步的计算机位于第2层。与第2层计算机同步的计算机位于第3层，依此类推。
								</dd><dt><span class="term">轮询</span></dt><dd><p class="simpara">这显示了轮询源的速率，以秒为单位的基数2对数。因此，值6表示每64秒进行一次测量。
								</p><p class="simpara">
									<code class="literal">chronyd</code>根据当时的情况自动改变投票率。
								</p></dd><dt><span class="term">达到</span></dt><dd>这表示源的到达寄存器打印为八进制数。该寄存器有8位，并在来自源的每个接收或丢失的数据包上更新。值377表示接收到所有最后八次传输的有效回复。
								</dd><dt><span class="term">LastRx</span></dt><dd>此列显示从源收到最后一个样本的时间。这通常是几秒钟。字母<code class="literal">m</code> ， <code class="literal">h</code> ， <code class="literal">d</code>或<code class="literal">y</code>表示分钟，小时，天或年。值10年表示尚未从该来源收到样品。
								</dd><dt><span class="term">最后一个样本</span></dt><dd>此列显示本地时钟与上次测量时源的偏移量。方括号中的数字表示实际测量的偏移量。这可以以<code class="literal">ns</code> （表示纳秒）， <code class="literal">us</code> （表示微秒）， <code class="literal">ms</code> （表示毫秒）或<code class="literal">s</code> （表示秒）为后缀。方括号左侧的数字显示原始测量值，经过调整以允许应用于本地时钟的任何压摆。<code class="literal">+/-</code>指示符后面的数字表示测量中的误差范围。正偏移表示本地时钟位于源之前。
								</dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sect-checking_chrony_source_statistics"></a>检查chrony源统计信息</h3></div></div></div><p><code class="literal">sourcestats</code>命令显示有关<code class="literal">chronyd</code>当前正在检查的每个源的漂移率和偏移估计过程的<code class="literal">chronyd</code> 。
					</p><p>可以指定可选参数<code class="literal">-v</code> ，这意味着详细。在这种情况下，额外的标题行显示为列的含义的提醒。
					</p><pre class="literallayout">~]$ <code class="literal">chronyc sourcestats</code>
210 Number of sources = 1
Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
===============================================================================
abc.def.ghi                11   5   46m     -0.001      0.045      1us    25us</pre><p>列如下：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">名称/ IP地址</span></dt><dd>这是<code class="literal">NTP</code>服务器（或对等方）的名称或<code class="literal">IP</code>地址，或该线路其余部分所涉及的参考时钟的引用ID。
								</dd><dt><span class="term">NP</span></dt><dd>这是当前为服务器保留的采样点数。通过这些点执行线性回归来估计漂移率和电流偏移。
								</dd><dt><span class="term">NR</span></dt><dd>这是在最后一次回归之后具有相同符号的残差的运行次数。如果此数字相对于样本数量开始变得太小，则表明直线不再适合数据。如果运行次数太少， <code class="literal">chronyd</code>会丢弃较旧的样本并重新运行回归，直到运行次数变得可接受为止。
								</dd><dt><span class="term">跨度</span></dt><dd>这是最旧和最新样本之间的间隔。如果未显示任何单位，则该值以秒为单位。在该示例中，间隔为46分钟。
								</dd><dt><span class="term">频率</span></dt><dd>这是服务器的估计残留频率，单位为百万分之一。在这种情况下，计算机的时钟估计相对于服务器以<span class="emphasis"><em>10 <sup>9 9的</sup></em></span>速度运行1个部分。
								</dd><dt><span class="term">Freq Skew</span></dt><dd>这是Freq的估计误差范围（再次以百万分率计）。
								</dd><dt><span class="term">抵消</span></dt><dd>这是源的估计偏移量。
								</dd><dt><span class="term">Std Dev</span></dt><dd>这是估计的样本标准偏差。
								</dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-manually_adjusting-the-System_clock"></a>手动调整系统时钟</h2></div></div></div><p>要立即调整系统时钟，通过回转绕过任何正在进行的调整，请以<code class="literal">root</code>身份发出以下命令：</p><pre class="literallayout">~]# chronyc makestep</pre><p>如果使用<code class="literal">rtcfile</code>指令，则不应手动调整实时时钟。随机调整会干扰<span class="strong"><strong><span class="application">chrony</span></strong></span>测量实时时钟漂移速率的需要。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="setting-up-chrony-for-different-environments_using-chrony-to-configure-ntp"></a>为不同的环境设置chrony</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-setting_up_chrony_for_a_system_in_an_isolated_network"></a>为隔离网络中的系统设置chrony</h2></div></div></div><p>对于从未连接到Internet的网络，选择一台计算机作为主时间服务器。其他计算机可以是主服务器的直接客户端，也可以是客户端的客户端。在主站上，必须使用系统时钟的平均漂移率手动设置漂移文件。如果重新启动主设备，它将从周围系统获取时间并计算平均值以设置其系统时钟。此后，它将继续根据漂移文件应用调整。使用<code class="literal">settime</code>命令时，漂移文件将自动更新。
				</p><p>在选择作为主服务器的系统上，使用以<code class="literal">root</code>身份运行的文本编辑器，编辑<code class="literal">/etc/chrony.conf</code> ，如下所示：</p><pre class="literallayout">driftfile /var/lib/chrony/drift
commandkey 1
keyfile /etc/chrony.keys
initstepslew 10 client1 client3 client6
local stratum 8
manual
allow 192.0.2.0</pre><p><code class="literal">192.0.2.0</code>是允许客户端连接的网络或子网地址。
				</p><p>在选择作为主服务器的直接客户端的系统上，使用以<code class="literal">root</code>身份运行的文本编辑器，编辑<code class="literal">/etc/chrony.conf</code> ，如下所示：</p><pre class="literallayout">server master
driftfile /var/lib/chrony/drift
logdir /var/log/chrony
log measurements statistics tracking
keyfile /etc/chrony.keys
commandkey 24
local stratum 10
initstepslew 20 master
allow 192.0.2.123</pre><p>其中<code class="literal">192.0.2.123</code>是主站的地址， <code class="literal">master</code>是<code class="literal">master</code>的主机名。具有此配置的客户端将在重新启动时重新同步主服务器。
				</p><p>在不是主服务器的直接客户端的客户机系统上，/ <code class="literal">/etc/chrony.conf</code>文件应该是相同的，除了应该省略<code class="literal">local</code>和<code class="literal">allow</code>指令。
				</p><p>在隔离网络中，您还可以使用<code class="literal">local</code>指令启用本地参考模式，这允许<code class="literal">chronyd</code>作为<code class="literal">NTP</code>服务器运行时实时同步，即使它从未同步或时钟的最后更新发生很长时间过去。
				</p><p>要允许网络中的多个服务器使用相同的本地配置并相互同步，而不会混淆轮询多个服务器的客户端，请使用启用孤立模式的<code class="literal">local</code>指令的<code class="literal">orphan</code>选项。需要将每个服务器配置为使用<code class="literal">local</code>轮询所有其他服务器。这可确保只有具有最小引用ID的服务器才能使本地引用处于活动状态，并且其他服务器将与其同步。当服务器发生故障时，另一个服务器将接管。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using-chrony-with-hw-timestamping_using-chrony-to-configure-ntp"></a> Chrony与HW时间戳</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="understanding-hw-timestamping_using-chrony-to-configure-ntp"></a>了解硬件时间戳</h2></div></div></div><p>硬件时间戳是某些网络接口控制器（NIC）支持的功能，可为传入和传出的数据包提供准确的时间戳。<code class="literal">NTP</code>时间戳通常由内核和<span class="strong"><strong><span class="application">chronyd</span></strong></span>使用系统时钟创建。但是，启用HW时间戳时，NIC会使用自己的时钟生成数据包进入或离开链路层或物理层时的时间戳。与<code class="literal">NTP</code>使用时，硬件时间戳可以显着提高同步的准确性。为获得最佳准确性， <code class="literal">NTP</code>服务器和<code class="literal">NTP</code>客户端都需要使用硬件时间戳。在理想条件下，亚微秒精度可能是可能的。
				</p><p>另一种使用硬件时间戳的时间同步协议是<code class="literal">PTP</code> 。</p><p>与<code class="literal">NTP</code>不同， <code class="literal">PTP</code>依赖于网络交换机和路由器的协助。如果你想达到同步的最佳精度，使用<code class="literal">PTP</code>上有交换机和路由器与网络<code class="literal">PTP</code>支持，而宁愿<code class="literal">NTP</code>上没有这样的交换机和路由器网络。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-verifying-hw-timestamping"></a>验证对硬件时间戳的支持</h2></div></div></div><p>要验证接口是否支持使用<code class="literal">NTP</code>硬件时间戳，请使用<code class="literal">ethtool -T</code>命令。如果<code class="literal">ethtool</code>列出<code class="literal">SOF_TIMESTAMPING_TX_HARDWARE</code>和<code class="literal">SOF_TIMESTAMPING_TX_SOFTWARE</code>功能以及<code class="literal">HWTSTAMP_FILTER_ALL</code>过滤器模式，则接口可用于使用<code class="literal">NTP</code>进行硬件时间戳。
				</p><div class="example"><a id="verifying-hw-timestamping"></a><p class="title"><strong>例5.1。验证对特定接口上的硬件时间戳的支持</strong></p><div class="example-contents"><pre class="literallayout">~]# ethtool -T eth0</pre><p>输出：</p><pre class="literallayout">Timestamping parameters for eth0:
Capabilities:
        hardware-transmit     (SOF_TIMESTAMPING_TX_HARDWARE)
        software-transmit     (SOF_TIMESTAMPING_TX_SOFTWARE)
        hardware-receive      (SOF_TIMESTAMPING_RX_HARDWARE)
        software-receive      (SOF_TIMESTAMPING_RX_SOFTWARE)
        software-system-clock (SOF_TIMESTAMPING_SOFTWARE)
        hardware-raw-clock    (SOF_TIMESTAMPING_RAW_HARDWARE)
PTP Hardware Clock: 0
Hardware Transmit Timestamp Modes:
        off                   (HWTSTAMP_TX_OFF)
        on                    (HWTSTAMP_TX_ON)
Hardware Receive Filter Modes:
        none                  (HWTSTAMP_FILTER_NONE)
        all                   (HWTSTAMP_FILTER_ALL)
        ptpv1-l4-sync         (HWTSTAMP_FILTER_PTP_V1_L4_SYNC)
        ptpv1-l4-delay-req    (HWTSTAMP_FILTER_PTP_V1_L4_DELAY_REQ)
        ptpv2-l4-sync         (HWTSTAMP_FILTER_PTP_V2_L4_SYNC)
        ptpv2-l4-delay-req    (HWTSTAMP_FILTER_PTP_V2_L4_DELAY_REQ)
        ptpv2-l2-sync         (HWTSTAMP_FILTER_PTP_V2_L2_SYNC)
        ptpv2-l2-delay-req    (HWTSTAMP_FILTER_PTP_V2_L2_DELAY_REQ)
        ptpv2-event           (HWTSTAMP_FILTER_PTP_V2_EVENT)
        ptpv2-sync            (HWTSTAMP_FILTER_PTP_V2_SYNC)
        ptpv2-delay-req       (HWTSTAMP_FILTER_PTP_V2_DELAY_REQ)</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-enabling-hw-timestamping"></a>启用硬件时间戳</h2></div></div></div><p>要启用硬件时间戳，请使用<code class="literal">/etc/chrony.conf</code>文件中的<code class="literal">hwtimestamp</code>指令。该指令可以指定单个接口，也可以使用通配符在所有支持它的接口上启用硬件时间戳。使用通配符说明书中没有其他应用程序，如从<span class="strong"><strong><span class="application">ptp4l</span></strong></span>情况<code class="literal">linuxptp</code>包中，使用在接口上的硬件时间戳。chrony配置文件中允许多个<code class="literal">hwtimestamp</code>指令。
				</p><div class="example"><a id="enabling-hardware-timestamping"></a><p class="title"><strong>例5.2。使用hwtimestamp指令启用硬件时间戳</strong></p><div class="example-contents"><pre class="literallayout">hwtimestamp eth0
hwtimestamp eth1
hwtimestamp *</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-configuraing-polling-interval"></a>配置客户端轮询间隔</h2></div></div></div><p>建议Internet上的服务器使用轮询间隔的默认范围（64-1024秒）。对于本地服务器和硬件时间戳，需要配置较短的轮询间隔，以便最小化系统时钟的偏移。
				</p><p><code class="literal">/etc/chrony.conf</code>的以下指令使用一秒轮询间隔指定本地<code class="literal">NTP</code>服务器：</p><pre class="literallayout">server ntp.local minpoll 0 maxpoll 0</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-enabling-interleaved-mode"></a>启用交错模式</h2></div></div></div><p>
					<code class="literal">NTP</code>服务器不是硬件<code class="literal">NTP</code>设备，而是运行软件<code class="literal">NTP</code>实现的通用计算机，如<span class="strong"><strong><span class="application">chrony</span></strong></span> ，只有在发送数据包后才会获得硬件传输时间戳。此行为可防止服务器将时间戳保存在与其对应的数据包中。为了使<code class="literal">NTP</code>客户端接收发送发送后生成的时间戳，配置客户端使用<code class="literal">NTP</code>通过将交错模式<code class="literal">xleave</code>选项以在服务器指令<code class="literal">/etc/chrony.conf</code> ：</p><pre class="literallayout">server ntp.local minpoll 0 maxpoll 0 xleave</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-configuration-many-clients"></a>为大量客户端配置服务器</h2></div></div></div><p>默认服务器配置允许最多几千个客户端同时使用交错模式。要配置服务器的客户端数量较多，增加了<code class="literal">clientloglimit</code>在指令<code class="literal">/etc/chrony.conf</code> 。此伪指令指定为在服务器上记录客户端访问而分配的最大内存大小：</p><pre class="literallayout">clientloglimit 100000000</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-verifying-hardware-timestamping"></a>验证硬件时间戳</h2></div></div></div><p>要验证接口是否已成功启用硬件时间戳，请检查系统日志。对于具有成功启用的硬件时间戳的每个接口，日志应包含来自<code class="literal">chronyd</code>的消息。
				</p><div class="example"><a id="verifying-hardware-timestamping"></a><p class="title"><strong>例5.3。记录具有已启用硬件时间戳的接口的消息</strong></p><div class="example-contents"><pre class="literallayout">chronyd[4081]: Enabled HW timestamping on eth0
chronyd[4081]: Enabled HW timestamping on eth1</pre></div></div><p>当<code class="literal">chronyd</code>配置为<code class="literal">NTP</code>客户端或对等端时，您可以通过<code class="literal">chronyc ntpdata</code>命令为每个<code class="literal">NTP</code>源报告发送和接收时间戳模式以及交错模式：</p><div class="example"><a id="Report-mode-for-source"></a><p class="title"><strong>例5.4。报告每个NTP源的传输，接收时间戳和交错模式</strong></p><div class="example-contents"><pre class="literallayout">~]# chronyc ntpdata</pre><p>输出：</p><pre class="literallayout">Remote address  : 203.0.113.15 (CB00710F)
Remote port     : 123
Local address   : 203.0.113.74 (CB00714A)
Leap status     : Normal
Version         : 4
Mode            : Server
Stratum         : 1
Poll interval   : 0 (1 seconds)
Precision       : -24 (0.000000060 seconds)
Root delay      : 0.000015 seconds
Root dispersion : 0.000015 seconds
Reference ID    : 47505300 (GPS)
Reference time  : Wed May 03 13:47:45 2017
Offset          : -0.000000134 seconds
Peer delay      : 0.000005396 seconds
Peer dispersion : 0.000002329 seconds
Response time   : 0.000152073 seconds
Jitter asymmetry: +0.00
NTP tests       : 111 111 1111
Interleaved     : Yes
Authenticated   : No
TX timestamping : Hardware
RX timestamping : Hardware
Total TX        : 27
Total RX        : 27
Total valid RX  : 27</pre></div></div><div class="example"><a id="stability-NTP-measurements"></a><p class="title"><strong>例5.5。报告NTP测量的稳定性</strong></p><div class="example-contents"><pre class="literallayout"># chronyc sourcestats</pre><p>启用硬件时间戳后，在正常负载下， <code class="literal">NTP</code>测量的稳定性应为几十或几百纳秒。在<code class="literal">chronyc sourcestats</code>命令的输出的<code class="literal">Std Dev</code>列中报告此稳定性：</p><p>输出：</p><pre class="literallayout">210 Number of sources = 1
Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
ntp.local                  12   7    11     +0.000      0.019     +0ns    49ns</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="sect-configuring-PTP-NTP-bridge"></a>配置PTP-NTP网桥</h2></div></div></div><p>如果在没有支持<code class="literal">PTP</code>交换机或路由器的网络中可以使用高度精确的精确时间协议（ <code class="literal">PTP</code> ）grandmaster，则计算机可以专用于作为<code class="literal">PTP</code>从站和stratum-1 <code class="literal">NTP</code>服务器运行。这样的计算机需要具有两个或更多网络接口，并且靠近大师或与其直接连接。这将确保网络中的高度准确同步。
				</p><p>从<code class="literal">linuxptp</code>软件包配置<span class="strong"><strong><span class="application">ptp4l</span></strong></span>和<span class="strong"><strong><span class="application">phc2sys</span></strong></span>程序，使用一个接口使用<code class="literal">PTP</code>同步系统时钟。</p><p>配置<code class="literal">chronyd</code>以使用其他接口提供系统时间：</p><div class="example"><a id="configuring-NTP-bridge"></a><p class="title"><strong>例5.6。配置chronyd以使用其他接口提供系统时间</strong></p><div class="example-contents"><pre class="literallayout">bindaddress 203.0.113.74
hwtimestamp eth1
local stratum 1</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="achieving-settings-supported-by-ntp_using-chrony-to-configure-ntp"></a>在chrony中实现以前由ntp支持的一些设置</h1></div></div></div><p><span class="strong"><strong><span class="application">chty</span></strong></span>不支持<span class="strong"><strong><span class="application">ntp</span></strong></span>支持的以前主要版本的Red Hat Enterprise Linux中的某些设置。本节列出了这些设置，并描述了在具有<span class="strong"><strong><span class="application">chrony</span></strong></span>的系统上实现它们的方法。
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="monitoring_by_ntpq_and_ntpdc"></a>由ntpq和ntpdc监控</h2></div></div></div><p>
					<code class="literal">chronyd</code>不能由<span class="strong"><strong><span class="application">命令ntpq</span></strong></span>和<span class="strong"><strong><span class="application">ntpdc</span></strong></span>公用事业从<span class="strong"><strong><span class="appplication">NTP</span></strong></span>分布进行监控，因为<span class="strong"><strong><span class="application">chrony</span></strong></span>不支持<code class="literal">NTP</code>模式6和7。它支持不同的协议， <span class="strong"><strong><span class="application">chronyc</span></strong></span>是客户端实现。有关更多信息，请参见<code class="literal">chronyc(1)</code>手册页。
				</p><p>要监视<code class="literal">chronyd</code>同步的系统时钟的状态，您可以：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">使用跟踪命令</li><li class="listitem">使用<span class="strong"><strong><span class="application">ntpstat</span></strong></span>实用程序，它支持<span class="strong"><strong><span class="application">chrony</span></strong></span>并提供与<code class="literal">ntpd</code>相似的输出
						</li></ul></div><div class="example"><a id="exam-use-tracking-command"></a><p class="title"><strong>例5.7。使用跟踪命令</strong></p><div class="example-contents"><pre class="literallayout">$ chronyc -n tracking
Reference ID    : 0A051B0A (10.5.27.10)
Stratum         : 2
Ref time (UTC)  : Thu Mar 08 15:46:20 2018
System time     : 0.000000338 seconds slow of NTP time
Last offset     : +0.000339408 seconds
RMS offset      : 0.000339408 seconds
Frequency       : 2.968 ppm slow
Residual freq   : +0.001 ppm
Skew            : 3.336 ppm
Root delay      : 0.157559142 seconds
Root dispersion : 0.001339232 seconds
Update interval : 64.5 seconds
Leap status     : Normal</pre></div></div><div class="example"><a id="exam-use-ntpstat-utility"></a><p class="title"><strong>例5.8。使用ntpstat实用程序</strong></p><div class="example-contents"><pre class="literallayout">$ ntpstat
synchronised to NTP server (10.5.27.10) at stratum 2
   time correct to within 80 ms
   polling server every 64 s</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="using_authentication_mechanism_based_on_public_key_cryptography"></a>使用基于公钥加密的认证机制</h2></div></div></div><p>在Red Hat Enterprise Linux 7中， <span class="strong"><strong><span class="application">ntp</span></strong></span>支持<span class="strong"><strong><span class="application">Autokey</span></strong></span> ，这是一种基于公钥加密的认证机制。<span class="strong"><strong><span class="application">chronyd</span></strong></span>不支持<code class="literal">chronyd</code> 。
				</p><p>在Red Hat Enterprise Linux 8系统上，建议使用对称密钥。使用<code class="literal">chronyc keygen</code>命令生成密钥。客户端和服务器需要共享<code class="literal">/etc/chrony.keys</code>指定的<code class="literal">/etc/chrony.keys</code> 。客户端可以使用<code class="literal">server</code> ， <code class="literal">pool</code>或<code class="literal">peer</code>指令中的<code class="literal">key</code>选项启用身份验证。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="using_ephemeral_symmetric_associations"></a>使用短暂的对称关联</h2></div></div></div><p>在Red Hat Enterprise Linux 7中， <code class="literal">ntpd</code>支持短暂的对称关联，这些关联可以通过<code class="literal">ntp.conf</code>配置文件中未指定的来自对等体的数据包来调动。在Red Hat Enterprise Linux 8中， <code class="literal">chronyd</code>需要在<code class="literal">chrony.conf</code>指定所有对等体。不支持短暂的对称关联。
				</p><p>请注意，与<code class="literal">peer</code>指令启用的对称模式相比，使用<code class="literal">server</code>或<code class="literal">pool</code>指令启用的客户端/服务器模式更安全。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="multicast_broadcast_client"></a>多播/广播客户端</h2></div></div></div><p>红帽企业Linux 7支持广播/多播<code class="literal">NTP</code>模式，简化了客户端的配置。使用此模式，客户端可以配置为仅侦听发送到多播/广播地址的数据包，而不是侦听单个服务器的特定名称或地址，这些名称或地址可能会随时间而变化。
				</p><p>在Red Hat Enterprise Linux 8中， <code class="literal">chronyd</code>不支持广播/多播模式。主要原因是它比普通客户端/服务器和对称模式更不准确且安全性更低。
				</p><p>从<code class="literal">NTP</code>广播/多播设置迁移有多种选择：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">配置DNS以将单个名称（例如ntp.example.com）转换为不同服务器的多个地址</p><p class="simpara">客户端可以仅使用单个池指令进行静态配置，以与多个服务器同步。如果池中的服务器变得无法访问，或者不适合同步，则客户端会自动将其替换为池中的其他服务器。
						</p></li><li class="listitem"><p class="simpara">通过DHCP分发<code class="literal">NTP</code>服务器列表</p><p class="simpara">当NetworkManager从DHCP服务器获取<code class="literal">NTP</code>服务器列表时， <code class="literal">chronyd</code>会自动配置为使用它们。可以通过在<code class="literal">/etc/sysconfig/network</code>文件中添加<code class="literal">PEERNTP=no</code>来禁用此功能。
						</p></li><li class="listitem"><p class="simpara">使用<code class="literal">Precision Time Protocol (PTP)</code>
						</p><p class="simpara">此选项主要适用于服务器频繁更改的环境，或者较大的客户端组需要能够在没有指定服务器的情况下彼此同步的情况。
						</p><p class="simpara">
							<code class="literal">PTP</code>设计用于多播消息传递，其工作方式与<code class="literal">NTP</code>广播模式类似。<code class="literal">linuxptp</code>包中提供了<code class="literal">PTP</code>实现。
						</p><p class="simpara">
							<code class="literal">PTP</code>通常需要硬件时间戳并支持网络交换机才能正常运行。但是，即使使用软件时间戳并且不支持网络交换机， <code class="literal">PTP</code>也可以在广播模式下比<code class="literal">NTP</code>更好地工作。
						</p><p class="simpara">在一个通信路径中具有大量<code class="literal">PTP</code>从站的网络中，建议使用<code class="literal">hybrid_e2e</code>选项配置<code class="literal">PTP</code>从站，以减少从站生成的网络流量。您可以将运行<code class="literal">chronyd</code>的计算机配置为<code class="literal">NTP</code>客户端，也可以配置为<code class="literal">NTP</code>服务器，以便作为<code class="literal">PTP</code>主计算机使用多播消息传递将同步时间分配给大量计算机。
						</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="chrony-additional-resources_using-chrony-to-configure-ntp"></a>其他资源</h1></div></div></div><p>以下信息来源提供有关<span class="strong"><strong><span class="application">chrony的</span></strong></span>额外资源。
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="installed_documentation_3"></a>已安装的文档</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<code class="literal">chronyc(1)</code>手册页 - 介绍<span class="strong"><strong><span class="application">chronyc</span></strong></span>命令行界面工具，包括命令和命令选项。
						</li><li class="listitem">
							<code class="literal">chronyd(8)</code>手册页 - 描述<code class="literal">chronyd</code>守护程序，包括命令和命令选项。
						</li><li class="listitem">
							<code class="literal">chrony.conf(5)</code>手册页 - 描述<span class="strong"><strong><span class="application">chrony</span></strong></span>配置文件。
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="online_documentation_3"></a>在线文档</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="https://chrony.tuxfamily.org/doc/3.3/chronyc.html">https://chrony.tuxfamily.org/doc/3.3/chronyc.html</a>
						</li><li class="listitem">
							<a class="link" href="https://chrony.tuxfamily.org/doc/3.3/chronyd.html">https://chrony.tuxfamily.org/doc/3.3/chronyd.html</a>
						</li><li class="listitem">
							<a class="link" href="https://chrony.tuxfamily.org/doc/3.3/chrony.conf.html">https://chrony.tuxfamily.org/doc/3.3/chrony.conf.html</a>
						</li></ul></div><p>有关常见问题解答的解答，请参阅<a class="link" href="https://chrony.tuxfamily.org/faq.html">https://chrony.tuxfamily.org/faq.html</a>
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="managing-time-synchronization-using-rhel-system-roles_using-chrony-to-configure-ntp"></a>使用RHEL系统角色管理时间同步</h1></div></div></div><p>您可以使用<code class="literal">timesync</code>角色管理多台目标计算机上的时间同步。
			</p><p><code class="literal">timesync</code>角色安装和配置NTP或PTP实现以作为NTP客户端或PTP从属设备运行，以便将系统时钟与PTP域中的NTP服务器或大师同步。
			</p><p>请注意，使用<code class="literal">timesync</code>角色还有助于<a class="link" href="using-chrony-to-configure-ntp.html#migrating-to-chrony_using-chrony-to-configure-ntp" title="迁移到chrony">迁移到chrony</a> ，因为无论系统是使用<span class="strong"><strong><span class="application">ntp</span></strong></span>还是<span class="strong"><strong><span class="application">chrony</span></strong></span>来实现NTP协议，您都可以在从RHEL 6开始的所有Red Hat Enterprise Linux版本上使用相同的playbook。
			</p><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p><code class="literal">timesync</code>角色替换托管主机上给定或检测到的提供程序服务的配置。以前的设置会丢失，即使它们未在角色变量中指定。如果未定义<code class="literal">timesync_ntp_provider</code>变量，则唯一保留的设置是提供程序的选择。
				</p></div><p>以下示例显示如何在仅包含一个服务器池的情况下应用<code class="literal">timesync</code>角色。
			</p><div class="example"><a id="idm140276670108416"></a><p class="title"><strong>例5.9。应用单个服务器池的timesync角色的示例playbook</strong></p><div class="example-contents"><pre class="literallayout">---
- hosts: timesync-test
  vars:
    timesync_ntp_servers:
      - hostname: 2.rhel.pool.ntp.org
        pool: yes
        iburst: yes
  roles:
    - rhel-system-roles.timesync</pre></div></div><p>有关使用<code class="literal">timesync</code>角色的更多信息，请参阅<a class="link" href="https://github.com/linux-system-roles/timesync">系统角色文档</a> 。
			</p></div></div></body></html>