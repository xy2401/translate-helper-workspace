<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 使用authselect</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 使用authselect</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="what-is-authselect-used-for"></a>解释authselect</h1></div></div></div><p>
				<code class="literal">Authselect</code>是一个简化Red Hat Enterprise Linux主机上用户身份验证配置的实用程序。<code class="literal">Authselect</code>提供两种现成的配置文件，可以与所有现代身份管理系统一起使用：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">sssd</code>个人资料</li><li class="listitem"><code class="literal">winbind</code>简介</li></ul></div><p>出于传统兼容性原因，还可以使用<code class="literal">nis</code>配置文件。
			</p><p>Red Hat建议在半集中式身份管理环境中使用<code class="literal">authselect</code> ，例如，如果您的公司使用LDAP，winbind或nis数据库对用户进行身份验证以使用您域中的服务。
			</p><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p>如果您的主机是Red Hat Enterprise Linux身份管理或Active Directory的一部分，请不要使用<code class="literal">authselect</code> 。在将主机加入Red Hat Identity Management域时调用的<code class="literal">ipa-client-install</code>命令完全负责在主机上配置身份验证。类似地，在将主机加入Active Directory域时调用的<code class="literal">realm join</code>命令完全负责在主机上配置身份验证。
				</p></div><p>在以前的Red Hat Enterprise Linux版本中使用的<code class="literal">authconfig</code>实用程序创建并修改了许多不同的配置文件，使得故障排除成为一项艰巨的任务。<code class="literal">Authselect</code>使测试和故障排除变得简单，因为它只修改这些目录中的文件：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<code class="literal">/etc/nsswitch.conf中</code>
					</li><li class="listitem">
						<code class="literal">/etc/pam.d/*</code>文件</li><li class="listitem">
						<code class="literal">/etc/dconf/db/distro.d/*</code>文件</li></ul></div><p>GNU C库和某些其他应用程序使用名称服务开关（NSS）配置文件<code class="literal">/etc/nsswitch.conf</code>来确定从哪个类别获取名称服务信息的源，以及以什么顺序获取。每类信息都由数据库名称标识。
			</p><p>Linux-PAM（可插入认证模块）是一个模块系统，用于处理系统上应用程序（服务）的认证任务。身份验证的性质是动态可配置的：系统管理员可以选择各个服务提供应用程序如何对用户进行身份验证。此动态配置由<code class="literal">/etc/pam.d/</code>目录中的配置文件的内容设置，该目录列出将执行此服务所需的身份验证任务的PAM，以及事件中PAM-API的相应行为单个PAM失败。
			</p><p>为给定主机选择<code class="literal">authselect</code>配置文件后，配置文件将应用于登录主机的每个用户。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="choosing-authselect-profile"></a>选择authselect配置文件</h1></div></div></div><p>作为系统管理员，您可以为特定主机的<code class="literal">authselect</code>实用程序选择配置文件。该配置文件将应用于登录主机的每个用户。
			</p><h3><a id="procedure"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">选择适合您的身份验证提供程序的<code class="literal">authselect</code>配置文件。例如，要登录使用LDAP的公司的网络，请选择<code class="literal">sssd</code> 。以root身份运行命令：</p><pre class="literallayout"># authselect select <code class="literal">sssd</code></pre></li><li class="listitem"><p class="simpara">（可选）查看<code class="literal">/etc/nsswitch.conf</code>文件的内容：</p><pre class="literallayout">passwd:     sss files
group:      sss files
netgroup:   sss files
automount:  sss files
services:   sss files
...</pre><p class="simpara"><code class="literal">/etc/nsswitch.conf</code>文件的内容显示选择<code class="literal">sssd</code>配置文件意味着如果请求有关前五个项目之一的信息，则系统首先使用<code class="literal">sssd</code> 。只有在<code class="literal">sssd</code>缓存和提供身份验证的服务器上找不到请求的信息，或者<code class="literal">sssd</code>未运行时，系统<code class="literal">sssd</code>查看本地文件，即<code class="literal">/etc/*</code> 。
					</p><p class="simpara">例如，如果请求关于用户id的信息，则首先在<code class="literal">sssd</code>缓存中搜索用户id。如果在那里找不到，则查询<code class="literal">/etc/passwd</code>文件。类似地，如果请求用户的组从属关系，则首先在<code class="literal">sssd</code>缓存中搜索它，并且只有在那里找不到时，才查阅<code class="literal">/etc/group</code>文件。
					</p><p class="simpara">实际上，通常不会咨询本地<code class="literal">files</code>数据库。唯一的例外是<code class="literal">root</code>用户的情况，它永远不会被<code class="literal">sssd</code>处理，而是由<code class="literal">files</code>处理。
					</p></li><li class="listitem"><p class="simpara">（可选）查看<code class="literal">/etc/pam.d/system-auth</code>文件的内容：</p><pre class="literallayout"># Generated by authselect on Tue Sep 11 22:59:06 2018
# Do not modify this file manually.

auth        required        pam_env.so
auth        required        pam_faildelay.so delay=2000000
auth        [default=1 ignore=ignore success=ok]    pam_succeed_if.so uid &gt;= 1000 quiet
auth        [default=1 ignore=ignore success=ok]    pam_localuser.so
auth        sufficient      pam_unix.so nullok try_first_pass
auth        requisite       pam_succeed_if.so uid &gt;= 1000 quiet_success
auth        sufficient      pam_sss.so forward_pass
auth        required        pam_deny.so

account     required        pam_unix.so
account     sufficient      pam_localuser.so
...</pre><p class="simpara">除其他外，/ <code class="literal">/etc/pam.d/system-auth</code>文件包含以下信息：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">用户密码锁定条件</li><li class="listitem">使用智能卡进行身份验证的可能性</li><li class="listitem"><p class="simpara">用指纹进行身份验证的可能性</p><p class="simpara">您可以通过将以下选项添加到<code class="literal">authselect select sssd</code>或<code class="literal">authselect select winbind</code>命令来修改默认配置文件设置，例如：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
										<code class="literal">与-faillock</code>
									</li><li class="listitem">
										<code class="literal">与-智能卡</code>
									</li><li class="listitem">
										<code class="literal">与指纹</code>
									</li></ul></div></li></ul></div><p class="simpara">要查看可用选项的完整列表，请参阅<a class="xref" href="using-authselect.html#migrating-from-authconfig-to-authselect" title="将脚本从authconfig转换为authselect">“将脚本从authconfig转换为authselect”一节</a>或authselect-migration（7）手册页。
					</p></li></ol></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>在完成<code class="literal">authselect</code>选择过程之前，请确保已正确配置与配置文件相关的配置文件。例如，如果<code class="literal">sssd</code>守护程序未正确配置并处于活动状态，则使用pam_unix运行<code class="literal">authselect select</code>结果只能使本地用户能够进行身份验证。
				</p></div><p>如果通过添加上述<code class="literal">authselect select</code>命令行选项之一来调整现成的配置文件对于您的用例是不够的，您可以：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">通过更改<code class="literal">/etc/authselect/user-nsswitch.conf</code>文件来修改现成的配置文件。有关详细信息，请参阅<a class="xref" href="using-authselect.html#modifying-ready-made-authselect-profile" title="修改现成的authselect配置文件">“修改现成的authselect配置文件”一节</a> 。
					</li><li class="listitem">创建自己的自定义配置文件有关详细信息，请参阅<a class="xref" href="using-authselect.html#creating-own-authselect-profile" title="创建和部署您自己的自定义authselect配置文件">“创建和部署自己的自定义authselect配置文件”一节</a> 。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="modifying-ready-made-authselect-profile"></a>修改现成的authselect配置文件</h1></div></div></div><p>作为系统管理员，您可以修改其中一个默认配置文件，即<code class="literal">sssd</code> ， <code class="literal">winbind</code>或<code class="literal">nis</code>配置文件，以满足您的需求。您可以修改<code class="literal">/etc/authselect/user-nsswitch.conf</code>文件中的任何项目，但以下情况除外：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">passwd文件</li><li class="listitem">组</li><li class="listitem">网络组</li><li class="listitem">自动挂载</li><li class="listitem">服务</li></ul></div><p>之后运行<code class="literal">authselect select</code> <code class="literal">profile_name</code>将导致从<code class="literal">/etc/authselect/user-nsswitch.conf</code>传输到<code class="literal">/etc/nsswitch.conf</code>文件的配置文件的允许更改，但默认配置文件配置会覆盖不可接受的更改。
			</p><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>不要直接修改<code class="literal">/etc/nsswitch.conf</code>文件。
				</p></div><h3><a id="procedure_2"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">选择<code class="literal">authselect</code>配置文件，例如：</p><pre class="literallayout"># <code class="literal">authselect select</code> <code class="literal">sssd</code></pre></li><li class="listitem">编辑<code class="literal">/etc/authselect/user-nsswitch.conf</code>文件。
					</li><li class="listitem"><p class="simpara">应用<code class="literal">/etc/authselect/user-nsswitch.conf</code>文件中的更改：</p><pre class="literallayout"># <code class="literal">authselect apply-changes</code></pre></li><li class="listitem">（可选）查看<code class="literal">/etc/nsswitch.conf</code>文件以验证<code class="literal">/etc/authselect/user-nsswitch.conf</code>中的更改是否已在那里传播。
					</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="creating-own-authselect-profile"></a>创建和部署您自己的自定义authselect配置文件</h1></div></div></div><p>作为系统管理员，您可以通过自定义其中一个默认配置文件<code class="literal">sssd</code> ， <code class="literal">winbind</code>或<code class="literal">nis</code>配置文件来创建和部署自定义配置文件。如果<a class="xref" href="using-authselect.html#modifying-ready-made-authselect-profile" title="修改现成的authselect配置文件">“修改现成的authselect配置文件”</a>部分不足以满足您的需求，这将特别有用。部署自定义配置文件时，配置文件将应用于登录到给定主机的每个用户。
			</p><h3><a id="procedure_3"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">使用<code class="literal">authselect create-profile</code>命令创建自定义配置<code class="literal">authselect create-profile</code> 。例如，要创建一个名为<code class="literal">user-profile</code>的自定义配置<code class="literal">user-profile</code> ，该<code class="literal">user-profile</code>基于现成的<code class="literal">sssd</code>配置文件，但您可以自己配置<code class="literal">/etc/nsswitch.conf</code>文件中的项目：</p><pre class="literallayout"># <code class="literal">authselect create-profile</code> <code class="literal">user-profile</code> -b <code class="literal">sssd</code> <code class="literal">--symlink-meta</code> <code class="literal">--symlink-pam</code>
New profile was created at /etc/authselect/custom/user-profile</pre><p class="simpara">在命令中包含<code class="literal">--symlink-pam</code>选项意味着PAM模板将是原始配置文件文件的符号链接，而不是它们的副本;包括<code class="literal">--symlink-meta</code>选项意味着元文件（如README和<code class="literal">--symlink-meta</code>将是原始配置文件的符号链接，而不是它们的副本。这可确保原始配置文件中PAM模板和元文件的所有未来更新也将反映在您的自定义配置文件中。
					</p><p class="simpara">该命令已在<code class="literal">/etc/authselect/custom/user-profile/</code>目录中创建了<code class="literal">/etc/nsswitch.conf</code>文件的副本。
					</p></li><li class="listitem">配置<code class="literal">/etc/authselect/custom/user-profile/nsswitch.conf</code>文件。
					</li><li class="listitem"><p class="simpara">通过运行<code class="literal">authselect select</code>命令并添加custom / <span class="emphasis"><em>name_of_the_profile</em></span>作为参数来选择自定义配置文件。例如，要选择<code class="literal">user-profile</code>文件<code class="literal">user-profile</code>文件：</p><pre class="literallayout"># <code class="literal">authselect select</code> custom/<code class="literal">user-profile</code></pre><p class="simpara">选择计算机的<code class="literal">user-profile</code>文件<code class="literal">user-profile</code>文件意味着如果随后由Red Hat更新了<code class="literal">sssd</code>配置文件，除了对<code class="literal">/etc/nsswitch.conf</code>文件所做的更新之外，您将受益于所有更新。
					</p></li></ol></div><h3><a id="example"></a>例</h3><p>以下过程说明如何基于<code class="literal">sssd</code>配置文件创建配置文件，该配置文件仅查询<code class="literal">/etc/hosts</code>文件中主机名的本地静态表查找，而不是<code class="literal">dns</code>或<code class="literal">myhostname</code>数据库。
			</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">通过编辑以下行来编辑<code class="literal">/etc/nsswitch.conf</code>文件：</p><pre class="screen">hosts:      files</pre></li><li class="listitem"><p class="simpara">基于<code class="literal">sssd</code>创建自定义配置文件，该配置文件排除对<code class="literal">/etc/nsswitch.conf</code>更改：</p><pre class="literallayout"># <code class="literal">authselect create-profile</code> <code class="literal">user-profile</code> -b <code class="literal">sssd</code> --symlink-meta --symlink-pam</pre></li><li class="listitem"><p class="simpara">选择个人资料：</p><pre class="literallayout"># <code class="literal">authselect select</code> custom/<code class="literal">user-profile</code></pre></li><li class="listitem"><p class="simpara">（可选）检查选择自定义配置文件</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">根据所选的<code class="literal">sssd</code>配置文件创建了<code class="literal">/etc/pam.d/system-auth</code>文件</li><li class="listitem"><p class="simpara">保持<code class="literal">/etc/nsswitch.conf</code>的配置不变：</p><pre class="literallayout">hosts:      files</pre><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>相反，运行<code class="literal">authselect select</code> <code class="literal">sssd</code>会导致</p><pre class="screen">hosts:      files dns myhostname</pre></div></li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="migrating-from-authconfig-to-authselect"></a>将脚本从authconfig转换为authselect</h1></div></div></div><p>如果使用<code class="literal">ipa-client-install</code>或<code class="literal">realm join</code>加入域，则可以安全地删除脚本中的任何<code class="literal">authconfig</code>调用。如果无法做到这一点，请将每个<code class="literal">authconfig</code>调用替换为其等效的<code class="literal">authselect</code>调用。在此过程中，选择正确的配置文件和相应的选项。另外，编辑必要的配置文件：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<code class="literal">的/etc/krb5.conf</code>
					</li><li class="listitem">
						<code class="literal">/etc/sssd/sssd.conf</code> （对于<code class="literal">sssd</code>配置文件）或<code class="literal">/etc/samba/smb.conf</code> （对于<code class="literal">winbind</code>配置文件）</li></ul></div><p>
				<a class="xref" href="using-authselect.html#tab-relation-of-authconfig-options-to-authselect-profiles" title="表1.1。authconfig选项与authselect配置文件的关系">表1.1“的authconfig选项相对于authselect配置文件”</a>和<a class="xref" href="using-authselect.html#tab-relation-of-authconfig-options-to-authselect-profile-options" title="表1.2。Authselect authconfig选项的配置文件选项等效项">表1.2“的authconfig选项Authselect配置文件选项等同物”</a>显示<code class="literal">authselect</code>的当量<code class="literal">authconfig</code>选项。
			</p><div class="table"><a id="tab-relation-of-authconfig-options-to-authselect-profiles"></a><p class="title"><strong>表1.1。authconfig选项与authselect配置文件的关系</strong></p><div class="table-contents"><table border="1" summary="Relation of authconfig options to authselect profiles"><colgroup><col class="col_1"><col class="col_2"></colgroup><tbody><tr><td valign="top" style="text-align:left"> <p>
								<span class="strong"><strong>Authconfig选项</strong></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>
								<span class="strong"><strong>自动选择个人资料</strong></span>
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enableldap --enableldapauth</p>
							 </td><td valign="top" style="text-align:left"> <p>
								<code class="literal">SSSD</code>
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablesssd --enablesssdauth</p>
							 </td><td valign="top" style="text-align:left"> <p>
								<code class="literal">SSSD</code>
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablekrb5</p>
							 </td><td valign="top" style="text-align:left"> <p>
								<code class="literal">SSSD</code>
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablewinbind --enablewinbindauth</p>
							 </td><td valign="top" style="text-align:left"> <p>
								<code class="literal">winbind的</code>
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablenis</p>
							 </td><td valign="top" style="text-align:left"> <p>
								<code class="literal">NIS</code>
							</p>
							 </td></tr></tbody></table></div></div><div class="table"><a id="tab-relation-of-authconfig-options-to-authselect-profile-options"></a><p class="title"><strong>表1.2。Authselect authconfig选项的配置文件选项等效项</strong></p><div class="table-contents"><table border="1" summary="Authselect profile option equivalents of authconfig options"><colgroup><col class="col_1"><col class="col_2"></colgroup><tbody><tr><td valign="top" style="text-align:left"> <p>
								<span class="strong"><strong>Authconfig选项</strong></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>
								<span class="strong"><strong>自动选择配置文件功能</strong></span>
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablesmartcard</p>
							 </td><td valign="top" style="text-align:left"> <p>与-智能卡</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablefingerprint</p>
							 </td><td valign="top" style="text-align:left"> <p>与指纹</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enableecryptfs</p>
							 </td><td valign="top" style="text-align:left"> <p>与-ecryptfs</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablemkhomedir</p>
							 </td><td valign="top" style="text-align:left"> <p>与-mkhomedir</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablefaillock</p>
							 </td><td valign="top" style="text-align:left"> <p>与-faillock</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablepamaccess</p>
							 </td><td valign="top" style="text-align:left"> <p>与-pamaccess</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablewinbindkrb5</p>
							 </td><td valign="top" style="text-align:left"> <p>与-KRB5</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>--enablepamaccess</p>
							 </td><td valign="top" style="text-align:left"> <p>与-pamaccess</p>
							 </td></tr></tbody></table></div></div><p>
				<a class="xref" href="using-authselect.html#tab-examples-of-authconfig-commands-to-authselect-commands" title="Table 1.3. Examples of authselect commands equivalents to authconfig commands">表1.3“与authconfig命令等效的authselect命令</a>示例<a class="xref" href="using-authselect.html#tab-examples-of-authconfig-commands-to-authselect-commands" title="表1.3。authselect命令的示例与authconfig命令等效">”</a>显示了对<code class="literal">authconfig</code> Kickstart调用到对<code class="literal">authselect</code>的Kickstart调用的示例转换。
			</p><div class="table"><a id="tab-examples-of-authconfig-commands-to-authselect-commands"></a><p class="title"><strong>表1.3。authselect命令的示例与authconfig命令等效</strong></p><div class="table-contents"><table border="1" summary="Examples of authselect commands equivalents to authconfig commands"><colgroup><col class="col_1"><col class="col_2"></colgroup><tbody><tr><td valign="top" style="text-align:left"> <p>
								<span class="strong"><strong>authconfig命令</strong></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>
								<span class="strong"><strong>authselect等效</strong></span>
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>authconfig --enableldap --enableldapauth --enablefaillock --updateall</p>
							 </td><td valign="top" style="text-align:left"> <p>authselect选择sssd with-faillock</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>authconfig --enablesssd --enablesssdauth --enablesmartcard --smartcardmodule = sssd --updateall</p>
							 </td><td valign="top" style="text-align:left"> <p>authselect使用-smartcard选择sssd</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>authconfig --enableecryptfs --enablepamaccess --updateall</p>
							 </td><td valign="top" style="text-align:left"> <p>authselect选择sssd with-ecryptfs with-pamaccess</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>authconfig --enablewinbind --enablewinbindauth --winbindjoin = Administrator --updateall</p>
							 </td><td valign="top" style="text-align:left"> <p>领域加入-U管理员--client-software = winbind <code class="literal">WINBINDDOMAIN</code>
							</p>
							 </td></tr></tbody></table></div></div></div></div></body></html>