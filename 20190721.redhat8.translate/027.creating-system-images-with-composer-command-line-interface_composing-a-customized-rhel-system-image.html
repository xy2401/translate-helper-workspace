<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 使用Image Builder命令行界面创建系统映像</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 使用Image Builder命令行界面创建系统映像</h1></div></div></div><p>Image Builder是一个用于创建自定义系统映像的工具。要控制Image Builder并创建自定义系统映像，请使用命令行界面，该界面是目前使用Image Builder的首选方法。
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="composer-command-line-interface_creating-system-images-with-composer-command-line-interface"></a> Image Builder命令行界面</h1></div></div></div><p>Image Builder命令行界面是目前使用Image Builder的首选方法。它提供的功能比<a class="link" href="creating-system-images-with-composer-web-console-interface_composing-a-customized-rhel-system-image.html" title="Chapter 9. 使用Image Builder Web控制台界面创建系统映像">Web控制台界面更多</a> 。要使用此接口，请使用合适的选项和子命令运行<code class="literal">composer-cli</code>命令。
			</p><p>命令行界面的工作流程可以总结如下：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">将蓝图定义导出（ <span class="emphasis"><em>保存</em></span> ）为纯文本文件</li><li class="listitem">在文本编辑器中编辑此文件</li><li class="listitem">将蓝图文本文件导入（ <span class="emphasis"><em>推送</em></span> ）回Image Builder</li><li class="listitem">运行构图以从蓝图构建图像</li><li class="listitem">导出图像文件以下载它</li></ol></div><p>除了实现此过程的基本子命令之外， <code class="literal">composer-cli</code>命令还提供了许多子命令来检查已配置的蓝图和组合的状态。
			</p><p>要运行<code class="literal">composer-cli</code>命令，用户必须位于<code class="literal">weldr</code>或<code class="literal">root</code>组中。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="creating-a-composer-blueprint-with-command-line-interface_creating-system-images-with-composer-command-line-interface"></a>使用命令行界面创建Image Builder蓝图</h1></div></div></div><p>此过程描述如何使用命令行界面创建新的Image Builder蓝图。
			</p><div class="orderedlist"><p class="title"><strong>程序</strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">使用以下内容创建纯文本文件：</p><pre class="screen">name = "<span class="emphasis"><em>BLUEPRINT-NAME</em></span>"
description = "<span class="emphasis"><em>LONG FORM DESCRIPTION TEXT</em></span>"
version = "<span class="emphasis"><em>0.0.1</em></span>"
modules = []
groups = []</pre><p class="simpara">将<span class="emphasis"><em>BLUEPRINT-NAME</em></span>和<span class="emphasis"><em>LONG FORM DESCRIPTION TEXT</em></span>替换为您的蓝图的名称和描述。
					</p><p class="simpara">根据<a class="link" href="https://semver.org/">语义版本控制</a>方案将<span class="emphasis"><em>0.0.1</em></span>替换为版本号。
					</p></li><li class="listitem"><p class="simpara">对于要包含在蓝图中的每个包，请将以下行添加到该文件中：</p><pre class="screen">[[packages]]
name = "<span class="emphasis"><em>package-name</em></span>"
version = "<span class="emphasis"><em>package-version</em></span>"</pre><p class="simpara">将<span class="emphasis"><em>package-name</em></span>替换为<span class="emphasis"><em>包的名称</em></span> ，例如<span class="strong"><strong><span class="package">httpd</span></strong></span> ， <span class="strong"><strong><span class="package">gdb-doc</span></strong></span>或<span class="strong"><strong><span class="package">coreutils</span></strong></span> 。
					</p><p class="simpara">将<span class="emphasis"><em>package-version</em></span>替换为要使用的版本。该字段支持<code class="literal">dnf</code>版本规范：</p><div class="informalexample"><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">对于特定版本，请使用准确的版本号，例如<span class="strong"><strong>8.30</strong></span> 。
							</li><li class="listitem">有关最新版本，请使用星号<span class="strong"><strong>*</strong></span> 。
							</li><li class="listitem">对于最新的次要版本，请使用<span class="strong"><strong>8之类的</strong></span>格式。
							</li></ul></div></div></li><li class="listitem"><p class="simpara">蓝图可以通过多种方式进行定制。对于此示例，可以通过执行以下步骤禁用同步多线程（SMT）。有关其他可用的自定义设置，请参阅“图像自定义”部分。
					</p><pre class="screen">[customizations.kernel]
append = "nosmt=force"</pre></li><li class="listitem">将文件另存为BLUEPRINT <span class="emphasis"><em>-NAME</em></span> .toml并关闭文本编辑器。
					</li><li class="listitem"><p class="simpara">推送（导入）蓝图：</p><pre class="screen"># composer-cli blueprints push <span class="emphasis"><em>BLUEPRINT-NAME</em></span>.toml</pre><p class="simpara">将<span class="emphasis"><em>BLUEPRINT-NAME</em></span>替换为您在先前步骤中使用的值。
					</p></li><li class="listitem"><p class="simpara">要验证蓝图是否已推送并存在，请列出现有蓝图：</p><pre class="screen"># composer-cli blueprints list</pre></li><li class="listitem"><p class="simpara">检查蓝图中列出的组件和版本及其依赖项是否有效：</p><pre class="screen"># composer-cli blueprints depsolve <span class="emphasis"><em>BLUEPRINT-NAME</em></span></pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="editing-a-composer-blueprint-with-command-line-interface_creating-system-images-with-composer-command-line-interface"></a>使用命令行界面编辑Image Builder蓝图</h1></div></div></div><p>此过程描述如何在命令行界面中编辑现有的Image Builder蓝图。
			</p><div class="orderedlist"><p class="title"><strong>程序</strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">将蓝图保存（导出）到本地文本文件：</p><pre class="screen"># composer-cli blueprints save <span class="emphasis"><em>BLUEPRINT-NAME</em></span></pre></li><li class="listitem">使用您选择的文本编辑器编辑BLUEPRINT <span class="emphasis"><em>-NAME</em></span> .toml文件并进行更改。
					</li><li class="listitem"><p class="simpara">在完成编辑之前，请确保该文件是有效的蓝图：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">删除此行（如果存在）：</p><pre class="screen">packages = []</pre></li><li class="listitem">增加版本号。请记住，Image Builder蓝图版本必须使用<a class="link" href="https://semver.org/">语义版本控制</a>方案。另请注意，如果不更改版本，则会自动增加版本的<span class="strong"><strong>修补程序</strong></span>组件。
							</li><li class="listitem"><p class="simpara">检查内容是否是有效的TOML规范。有关更多信息，请参阅<a class="link" href="https://github.com/toml-lang/toml#toml/">TOML文档</a> 。
							</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>TOML文档是社区产品，Red Hat不支持。您可以通过<a class="link" href="https://github.com/toml-lang/toml/issues">https://github.com/toml-lang/toml/issues</a>报告该工具的任何问题
								</p></div></li></ol></div></li><li class="listitem">保存文件并关闭编辑器。
					</li><li class="listitem"><p class="simpara">将蓝图推送（导入）回Image Builder：</p><pre class="screen"># composer-cli blueprints push <span class="emphasis"><em>BLUEPRINT-NAME</em></span>.toml</pre><p class="simpara">请注意，您必须提供包含<code class="literal">.toml</code>扩展名的文件名，而在其他命令中，您只能使用蓝图的名称。
					</p></li><li class="listitem"><p class="simpara">要验证上传到Image Builder的内容是否与您的编辑匹配，请列出蓝图的内容：</p><pre class="screen"># composer-cli blueprints show <span class="emphasis"><em>BLUEPRINT-NAME</em></span></pre></li><li class="listitem"><p class="simpara">检查蓝图中列出的组件和版本及其依赖项是否有效：</p><pre class="screen"># composer-cli blueprints depsolve <span class="emphasis"><em>BLUEPRINT-NAME</em></span></pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="creating-a-system-image-with-composer-in-the-command-line-interface_creating-system-images-with-composer-command-line-interface"></a>使用命令行界面中的Image Builder创建系统映像</h1></div></div></div><p>此过程说明如何使用Image Builder命令行界面构建自定义映像。
			</p><div class="itemizedlist"><p class="title"><strong>先决条件</strong></p><ul class="itemizedlist"><li class="listitem">您有为图像准备的蓝图。
					</li></ul></div><div class="orderedlist"><p class="title"><strong>程序</strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">开始撰写：</p><pre class="screen"># composer-cli compose start <span class="emphasis"><em>BLUEPRINT-NAME</em></span> <span class="emphasis"><em>IMAGE-TYPE</em></span></pre><p class="simpara">将<span class="emphasis"><em>BLUEPRINT-NAME</em></span>替换为蓝图名称，将<span class="emphasis"><em>IMAGE-TYPE</em></span>替换为图像类型。有关可能的值，请参阅<code class="literal">composer-cli compose types</code>命令的输出。
					</p><p class="simpara">撰写过程在后台开始，并显示撰写的UUID。
					</p></li><li class="listitem"><p class="simpara">等到撰写完成。请注意，这可能需要几分钟时间。
					</p><p class="simpara">要检查撰写的状态：</p><pre class="screen"># composer-cli compose status</pre><p class="simpara">完成的撰写显示状态值<span class="strong"><strong>FINISHED</strong></span> 。通过UUID识别列表中的撰写。</p></li><li class="listitem"><p class="simpara">完成撰写后，下载生成的图像文件：</p><pre class="screen"># composer-cli compose image <span class="emphasis"><em>UUID</em></span></pre><p class="simpara">将<span class="emphasis"><em>UUID</em></span>替换为前面步骤中显示的UUID值。
					</p><p class="simpara">或者，您可以直接在<code class="literal">/var/lib/lorax/composer/results/ <span class="emphasis"><em>UUID</em></span> /</code>路径下访问映像文件。
					</p><p class="simpara">您还可以使用<code class="literal">composer-cli compose logs <span class="emphasis"><em>UUID</em></span></code>命令下载日志，或使用<code class="literal">composer-cli compose metadata <span class="emphasis"><em>UUID</em></span></code>命令下载<code class="literal">composer-cli compose metadata <span class="emphasis"><em>UUID</em></span></code> 。
					</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="basic-composer-command-line-commands_creating-system-images-with-composer-command-line-interface"></a> Basic Image Builder命令行命令</h1></div></div></div><p>Image Builder命令行界面提供以下子命令。
			</p><div class="variablelist"><p class="title"><strong>蓝图操纵</strong></p><dl class="variablelist"><dt><span class="term">列出所有可用的蓝图</span></dt><dd><pre class="screen"># composer-cli blueprints list</pre></dd><dt><span class="term">以TOML格式显示蓝图内容</span></dt><dd><pre class="screen"># composer-cli blueprints show <span class="emphasis"><em>BLUEPRINT-NAME</em></span></pre></dd><dt><span class="term">将TOML格式的蓝图内容保存（导出）到文件中</span></dt><dd><pre class="screen"># composer-cli blueprints save <span class="emphasis"><em>BLUEPRINT-NAME</em></span></pre></dd><dt><span class="term">删除蓝图</span></dt><dd><pre class="screen"># composer-cli blueprints delete <span class="emphasis"><em>BLUEPRINT-NAME</em></span></pre></dd><dt><span class="term">将TOML格式的蓝图文件推送（导入）到Image Builder中</span></dt><dd><pre class="screen"># composer-cli blueprints push <span class="emphasis"><em>BLUEPRINT-NAME</em></span></pre></dd></dl></div><div class="variablelist"><p class="title"><strong>从蓝图组成图像</strong></p><dl class="variablelist"><dt><span class="term">开始撰写</span></dt><dd><pre class="screen"># composer-cli compose start <span class="emphasis"><em>BLUEPRINT</em></span> <span class="emphasis"><em>COMPOSE-TYPE</em></span></pre><p class="simpara">将<span class="emphasis"><em>BLUEPRINT</em></span>替换为要构建的蓝图的名称，将<span class="emphasis"><em>COMPOSE-TYPE</em></span>替换为输出图像类型。
						</p></dd><dt><span class="term">列出所有作曲</span></dt><dd><pre class="screen"># composer-cli compose list</pre></dd><dt><span class="term">列出所有作曲及其状态</span></dt><dd><pre class="screen"># composer-cli compose status</pre></dd><dt><span class="term">取消正在运行的撰写</span></dt><dd><pre class="screen"># composer-cli compose cancel <span class="emphasis"><em>COMPOSE-UUID</em></span></pre></dd><dt><span class="term">删除完成的作品</span></dt><dd><pre class="screen"># composer-cli compose delete <span class="emphasis"><em>COMPOSE-UUID</em></span></pre></dd><dt><span class="term">显示有关撰写的详细信息</span></dt><dd><pre class="screen"># composer-cli compose info <span class="emphasis"><em>COMPOSE-UUID</em></span></pre></dd><dt><span class="term">下载撰写的图像文件</span></dt><dd><pre class="screen"># composer-cli compose image <span class="emphasis"><em>COMPOSE-UUID</em></span></pre></dd></dl></div><div class="itemizedlist"><p class="title"><strong>相关信息</strong></p><ul class="itemizedlist"><li class="listitem"><p class="simpara"><span class="emphasis"><em>composer-cli</em></span> （1）手册页提供了可用子命令和选项的完整列表：</p><pre class="screen">$ man composer-cli</pre></li><li class="listitem"><p class="simpara"><code class="literal">composer-cli</code>命令提供有关子命令和选项的帮助：</p><pre class="screen"># composer-cli help</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="composer-blueprint-format_creating-system-images-with-composer-command-line-interface"></a>图像生成器蓝图格式</h1></div></div></div><p>Image Builder蓝图以Tom's Obvious，Minimal Language（TOML）格式显示给用户。
			</p><p>典型蓝图文件的元素包括：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">蓝图元数据</span></dt><dd><pre class="screen">name = "<span class="emphasis"><em>BLUEPRINT-NAME</em></span>"
description = "<span class="emphasis"><em>LONG FORM DESCRIPTION TEXT</em></span>"
version = "<span class="emphasis"><em>VERSION</em></span>"
modules = []
groups = []</pre><p class="simpara">将<span class="emphasis"><em>BLUEPRINT-NAME</em></span>和<span class="emphasis"><em>LONG FORM DESCRIPTION TEXT</em></span>替换为您的蓝图的名称和描述。
						</p><p class="simpara">根据<a class="link" href="https://semver.org/">语义版本控制</a>方案将<span class="emphasis"><em>VERSION</em></span>替换为版本号。
						</p><p class="simpara">此部分仅对整个蓝图文件存在一次。
						</p><p class="simpara">入口<span class="emphasis"><em>模块</em></span>描述了要安装到映像中的包名称和匹配的版本glob。
						</p><p class="simpara">条目<span class="emphasis"><em>组</em></span>描述要安装到映像中的一组包。
						</p></dd><dt><span class="term">要包含在图像中的包</span></dt><dd><pre class="screen">[[packages]]
name = "<span class="emphasis"><em>package-name</em></span>"
version = "<span class="emphasis"><em>package-version</em></span>"</pre><p class="simpara">将<span class="emphasis"><em>package-name</em></span>替换为<span class="emphasis"><em>包的名称</em></span> ，例如<span class="strong"><strong><span class="package">httpd</span></strong></span> ， <span class="strong"><strong><span class="package">gdb-doc</span></strong></span>或<span class="strong"><strong><span class="package">coreutils</span></strong></span> 。
						</p><p class="simpara">将<span class="emphasis"><em>package-version</em></span>替换为要使用的版本。该字段支持<code class="literal">dnf</code>版本规范：</p><div class="informalexample"><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">对于特定版本，请使用准确的版本号，例如<span class="strong"><strong>8.30</strong></span> 。
								</li><li class="listitem">有关最新版本，请使用星号<span class="strong"><strong>*</strong></span> 。
								</li><li class="listitem">对于最新的次要版本，请使用<span class="strong"><strong>8之类的</strong></span>格式。
								</li></ul></div></div><p class="simpara">对每个要包含的包重复此块。
						</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="image-customizations_creating-system-images-with-composer-command-line-interface"></a>支持的图像自定义</h1></div></div></div><p>目前，蓝图中支持许多图像自定义。为了使用这些选项，必须首先在蓝图中配置它们并将其导入（推送）到Image Builder。
			</p><div class="informalexample"><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>随附的驾驶舱 - 作曲家GUI目前不支持这些自定义。</p></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">设置图像主机名</span></dt><dd><pre class="screen">[customizations]
hostname = "<span class="emphasis"><em>baseimage</em></span>"</pre></dd><dt><span class="term">生成的系统映像的用户规范</span></dt><dd><pre class="screen">[[customizations.user]]
name = "<span class="emphasis"><em>USER-NAME</em></span>"
description = "<span class="emphasis"><em>USER-DESCRIPTION</em></span>"
password = "<span class="emphasis"><em>PASSWORD-HASH</em></span>"
key = "<span class="emphasis"><em>ssh-rsa (...) key-name</em></span>"
home = "/home/<span class="emphasis"><em>USER-NAME</em></span>/"
shell = "<span class="emphasis"><em>/usr/bin/bash</em></span>"
groups = [<span class="emphasis"><em>"users", "wheel"</em></span>]
uid = <span class="emphasis"><em>NUMBER</em></span>
gid = <span class="emphasis"><em>NUMBER</em></span></pre><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>要生成哈希，必须在系统上安装<span class="strong"><strong>python3</strong></span> 。以下命令将安装<span class="strong"><strong>python3</strong></span>包。
							</p><pre class="screen"># yum install python3</pre></div><p class="simpara">用实际密码哈希替换<span class="emphasis"><em>PASSWORD-HASH</em></span> 。要生成哈希，请使用例如。这个命令：</p><pre class="screen">$ python3 -c 'import crypt,getpass;pw=getpass.getpass();print(crypt.crypt(pw) if (pw==getpass.getpass("Confirm: ")) else exit())'</pre><p class="simpara">用实际公钥替换<span class="emphasis"><em>ssh-rsa（...）key-name</em></span> 。
						</p><p class="simpara">用合适的值替换其他占位符。
						</p><p class="simpara">根据需要省略任何行，只需要用户名。
						</p><p class="simpara">对每个要包含的用户重复此块。
						</p></dd><dt><span class="term">生成的系统映像的组规范</span></dt><dd><pre class="screen">[[customizations.group]]
name = "<span class="emphasis"><em>GROUP-NAME</em></span>"
gid = <span class="emphasis"><em>NUMBER</em></span></pre><p class="simpara">对每个要包含的组重复此块。
						</p></dd><dt><span class="term">设置现有用户的ssh密钥</span></dt><dd><pre class="screen">[[customizations.sshkey]]
user = "<span class="emphasis"><em>root</em></span>"
KEY = "<span class="emphasis"><em>PUBLIC SSH KEY</em></span>"</pre><div class="informalexample"><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>此选项仅适用于现有用户。要创建用户并设置ssh密钥，请使用<span class="strong"><strong>用户规范进行生成的系统映像</strong></span>自定义。
							</p></div></div></dd><dt><span class="term">将内核引导参数选项附加到默认值</span></dt><dd><pre class="screen">[customizations.kernel]
append = "<span class="emphasis"><em>KERNEL OPTION</em></span>"</pre></dd></dl></div></div></div></body></html>