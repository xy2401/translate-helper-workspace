<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 了解虚拟网络</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 了解虚拟网络</h1></div></div></div><p>必须通过主机硬件来促进虚拟机与网络上的其他设备和位置的连接。
		</p><p>虚拟网络使用虚拟网络交换机的概念。虚拟网络交换机是在主机物理机服务器上运行的软件构造。虚拟机（来宾）通过虚拟网络交换机连接到网络。
		</p><p>下图显示了将两个虚拟机连接到网络的虚拟网络交换机：</p><div class="informalfigure"><div class="mediaobject"><img src="images/vn-02-switchandtwoguests.png" alt="vn 02 switchandtwoguests"></div></div><p>从客户操作系统的角度来看，虚拟网络连接与物理网络连接相同。
		</p><p>主机物理机服务器将虚拟网络交换机视为网络接口。首次安装并启动libvirtd守护程序（ <span class="strong"><strong>libvirtd</strong></span> ）时，表示虚拟网络交换机的默认网络接口为<span class="strong"><strong>virbr0</strong></span> 。
		</p><p>可以像使用任何其他网络接口一样使用<code class="literal">ip</code>命令查看此接口。
		</p><pre class="literallayout">$ <span class="strong"><strong>ip addr show virbr0</strong></span>
3: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state
 UNKNOWN link/ether 1b:c4:94:cf:fd:17 brd ff:ff:ff:ff:ff:ff
 inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</pre><p>默认情况下，单个主机上的所有guest虚拟机都连接到同一个<code class="literal">libvirt</code>虚拟网络，名为<span class="strong"><strong>default</strong></span> 。此网络上的访客可以建立以下连接：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
					<span class="strong"><strong>彼此之间以及与虚拟化主机</strong></span>
				</p><p class="simpara">入站和出站流量都是可能的，但受客户机操作系统网络堆栈中的防火墙和附加到客户机接口的<code class="literal">libvirt</code>网络过滤规则的影响。
				</p></li><li class="listitem"><p class="simpara">
					<span class="strong"><strong>与虚拟主机之外的网络上的其他主机</strong></span>
				</p><p class="simpara">只有出站流量是可能的，并且受网络地址转换（NAT）规则以及主机系统防火墙的影响。
				</p></li></ul></div><p>对于从虚拟机进行基本的仅出站网络访问，通常不需要额外的网络设置，因为默认网络与<code class="literal">libvirt</code>软件包一起安装，并在<code class="literal">libvirtd</code>服务启动时自动启动。
		</p><p>如果需要更高级的功能，可以使用<code class="literal">virsh</code>创建和配置其他网络，并且可以编辑VM的XML配置文件以使用这些新网络之一。
		</p><p>有关默认配置的更多信息，请参阅<a class="xref" href="understanding-virtual-networking-overview_configuring-and-managing-virtualization.html#virtual-networking-default-configuration_understanding-virtual-networking-overview" title="虚拟网络默认配置">“虚拟网络默认配置”一节</a> 。
		</p><p>如果需要，可以将guest虚拟机接口设置为以下模式之一：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
					<a class="link" href="understanding-virtual-networking-overview_configuring-and-managing-virtualization.html#virtual-networking-routed-mode_understanding-virtual-networking-overview" title="路由模式下的虚拟网络">路由模式</a>
				</li><li class="listitem">
					<a class="link" href="understanding-virtual-networking-overview_configuring-and-managing-virtualization.html#virtual-networking-bridged-mode_understanding-virtual-networking-overview" title="桥接模式下的虚拟网络">桥接模式</a>
				</li><li class="listitem">
					<a class="link" href="understanding-virtual-networking-overview_configuring-and-managing-virtualization.html#virtual-networking-isolated-mode_understanding-virtual-networking-overview" title="隔离模式下的虚拟网络">隔离模式</a>
				</li><li class="listitem">
					<a class="link" href="understanding-virtual-networking-overview_configuring-and-managing-virtualization.html#virtual-networking-open-mode_understanding-virtual-networking-overview" title="开放模式下的虚拟网络">打开模式</a>
				</li></ul></div><p>虚拟网络使用网络地址转换（NAT）为虚拟网络和<code class="literal">dnsmasq</code>分配IP地址范围，以自动为虚拟机网络接口卡（NIC）分配IP地址并连接到域名服务（DNS）。
		</p><p>以下功能可用于虚拟网络：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
					<a class="link" href="understanding-virtual-networking-overview_configuring-and-managing-virtualization.html#virtual-networking-network-address-translation_understanding-virtual-networking-overview" title="虚拟网络网络地址转换">网络地址转换（NAT）</a>
				</li><li class="listitem">
					<a class="link" href="understanding-virtual-networking-overview_configuring-and-managing-virtualization.html#virtual-networking-dns-and-dhcp_understanding-virtual-networking-overview" title="虚拟网络DNS和DHCP">DNS和DHCP</a>
				</li></ul></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="virtual-networking-routed-mode_understanding-virtual-networking-overview"></a>路由模式下的虚拟网络</h1></div></div></div><p>使用<span class="emphasis"><em>路由</em></span>模式时，虚拟交换机连接到连接到主机的物理LAN，在不使用NAT的情况下来回传递流量。虚拟交换机可以检查所有流量并使用网络数据包中包含的信息来做出路由决策。使用此模式时，所有虚拟机都在其自己的子网中，通过虚拟交换机进行路由。这样可以启用传入连接，但需要为外部网络上的系统提供额外的路由表条目。路由模式在OSI网络模型的第3层运行。
			</p><div class="informalfigure"><div class="mediaobject"><img src="images/vn-06-routed-switch.png" alt="vn 06路由交换机"></div></div><h3><a id="common_topologies"></a>常见拓扑</h3><p>以下是使用路由模式的两种常见拓扑：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">DMZ</li><li class="listitem">虚拟服务器托管</li></ul></div><h4><a id="dmz"></a> DMZ</h4><p>出于安全原因，您可以创建一个网络，其中一个或多个节点放置在受控子网中。这种子网络称为非军事区（DMZ）。
			</p><div class="informalfigure"><div class="mediaobject"><img src="images/vn-09-routed-mode-DMZ.png" alt="vn 09路由模式DMZ"></div></div><p>DMZ中的主机通常为WAN（外部）主机以及LAN（内部）主机提供服务。由于这需要可以从多个位置访问它们，并且考虑到这些位置基于其安全性和信任级别以不同方式进行控制和操作，因此路由模式是此环境的最佳配置。
			</p><h4><a id="virtual_server_hosting"></a>虚拟服务器托管</h4><p>虚拟服务器托管提供商可能有多台主机，每台主机都有两个物理网络连接。一个接口用于管理和记帐，另一个用于虚拟机连接。每个虚拟机都有自己的公共IP地址，但主机使用专用IP地址，因此虚拟机的管理只能由内部管理员执行。
			</p><div class="informalfigure"><div class="mediaobject"><img src="images/vn-10-routed-mode-datacenter.png" alt="vn 10路由模式数据中心"></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="virtual-networking-bridged-mode_understanding-virtual-networking-overview"></a>桥接模式下的虚拟网络</h1></div></div></div><p>使用<span class="emphasis"><em>桥接</em></span>模式时，虚拟机（VM）连接到桥接设备，该桥接设备也直接连接到连接到本地以太网的物理以太网设备。结果，VM在物理网络上直接可见。这将启用传入连接，但不需要任何额外的路由表条目。
			</p><div class="informalfigure"><div class="mediaobject"><img src="images/vn-Bridged-Mode-Diagram.png" alt="vn桥接模式图"></div></div><p>桥接模式下的VM必须连接到主机上的现有Linux网桥，因此需要在主机接口上创建网桥。相比之下，其他VM网络模式会自动创建并连接到<code class="literal">virbr0</code>虚拟网桥。
			</p><p>所有虚拟机都显示在与主机相同的子网中。同一物理网络上的所有其他物理机都知道虚拟机，并可以访问它们。桥接在OSI网络模型的第2层上运行。
			</p><p>通过使用绑定将它们连接在一起，可以在管理程序上使用多个物理接口。然后将绑定添加到网桥，然后将虚拟机添加到网桥上。但是，绑定驱动程序具有多种操作模式，并且这些模式中只有少数适用于正在使用VM的网桥。
			</p><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p>使用桥接模式时，应该与虚拟机一起使用的唯一绑定模式是模式1，模式2和模式4。使用模式0,3,5或6可能会导致连接失败。另请注意，应使用介质无关接口（MII）监视来监视绑定模式，因为地址解析协议（ARP）监视不起作用。
				</p></div><h3><a id="common_scenarios"></a>常见情景</h3><p>桥接模式最常见的用例包括：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">在现有网络中与主机一起部署虚拟机，使虚拟机和物理机之间的差异对最终用户透明。
					</li><li class="listitem">部署虚拟机而不对现有物理网络配置设置进行任何更改。
					</li><li class="listitem">部署必须易于现有物理网络访问的虚拟机。将虚拟机放置在必须访问现有广播域（例如DHCP）内的服务的物理网络上。</li><li class="listitem">将虚拟机连接到使用VLAN的现有网络。
					</li></ul></div><h3><a id="additional_resources_34"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">有关bridge_opts参数的详细说明（用于配置桥接网络模式），请参阅“ <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.1/html/administration_guide/appe-custom_network_properties#Explanation_of_bridge_opts_Parameters">Red Hat Virtualization Administration Guide”</a> 。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="virtual-networking-isolated-mode_understanding-virtual-networking-overview"></a>隔离模式下的虚拟网络</h1></div></div></div><p>使用<span class="emphasis"><em>隔离</em></span>模式时，连接到虚拟交换机的guest虚拟机可以相互通信，也可以与主机通信，但是它们的流量不会通过主机外部，并且它们无法从主机外部接收流量。在此模式下使用dnsmasq是DHCP等基本功能所必需的。</p><div class="informalfigure"><div class="mediaobject"><img src="images/vn-07-isolated-switch.png" alt="vn 07隔离开关"></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="virtual-networking-network-address-translation_understanding-virtual-networking-overview"></a>虚拟网络网络地址转换</h1></div></div></div><p>默认情况下，虚拟网络交换机以NAT模式运行。它们使用IP伪装而不是源NAT（SNAT）或目标NAT（DNAT）。IP伪装使连接的guest虚拟机能够使用主机IP地址与任何外部网络进行通信。当虚拟网络交换机在NAT模式下运行时，主机外部的计算机无法与内部的VM通信。
			</p><div class="informalfigure"><div class="mediaobject"><img src="images/vn-04-hostwithnatswitch.png" alt="vn 04 hostwithnatswitch"></div></div><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p>虚拟网络交换机使用iptables规则配置的NAT。建议在交换机运行时编辑这些规则，因为不正确的规则可能导致交换机无法通信。
				</p></div><p>如果交换机未运行，您可以设置正向模式NAT的公共IP范围，以便通过运行以下命令创建端口伪装范围：</p><pre class="literallayout"># <span class="strong"><strong>iptables -j SNAT --to-source [start]-[end]</strong></span></pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="virtual-networking-open-mode_understanding-virtual-networking-overview"></a>开放模式下的虚拟网络</h1></div></div></div><p>使用<span class="emphasis"><em>开放</em></span>模式进行网络连接时， <code class="literal">libvirt</code>不会为网络生成任何<code class="literal">iptables</code>规则。因此，在libvirt范围之外添加的<code class="literal">iptables</code>规则不会被覆盖，因此用户可以手动管理<code class="literal">iptables</code>规则。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="virtual-networking-dns-and-dhcp_understanding-virtual-networking-overview"></a>虚拟网络DNS和DHCP</h1></div></div></div><p><code class="literal">libvirt</code>包包括<code class="literal">dnsmasq</code> ，用于为虚拟网络提供动态主机配置协议（DHCP）服务器和域名系统（DNS）转发器。
			</p><p><code class="literal">dnsmasq</code> DHCP服务可以为虚拟网络交换机分配地址池。可以通过DHCP将IP信息分配给虚拟机。</p><p>
				<code class="literal">dnsmasq</code>接受来自虚拟网络上的虚拟机的DNS查询，并将它们转发到真实的DNS服务器。
			</p><p>对于需要它的每个虚拟网络交换机， <code class="literal">dnsmasq</code>会自动配置并启动<code class="literal">libvirt</code>实例。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="virtual-networking-default-configuration_understanding-virtual-networking-overview"></a>虚拟网络默认配置</h1></div></div></div><p>首次安装libvirtd守护程序（ <code class="literal">libvirtd</code> ）时，它包含NAT模式下的初始虚拟网络交换机配置。使用此配置，以便安装的guest虚拟机可以通过主机与外部网络进行通信。下图显示了<code class="literal">libvirtd</code>的默认配置：</p><div class="informalfigure"><div class="mediaobject"><img src="images/vn-08-network-overview.png" alt="vn 08网络概述"></div></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>虚拟网络可以限制为特定的物理接口。这在具有多个接口的物理系统（例如， <span class="strong"><strong>eth0</strong></span> ， <span class="strong"><strong>eth1</strong></span>和<span class="strong"><strong>eth2</strong></span> ）上可能很有用。这仅在路由和NAT模式下有用，可以在<code class="literal">dev=&lt;interface&gt;</code>选项中定义，也可以在创建新虚拟网络时在RHEL 8 Web控制台中定义。
				</p></div></div></div></body></html>