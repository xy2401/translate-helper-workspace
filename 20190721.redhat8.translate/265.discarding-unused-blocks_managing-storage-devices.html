<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 丢弃未使用的块</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 丢弃未使用的块</h1></div></div></div><p>您可以在支持它们的块设备上执行或计划丢弃操作。
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="block-discard-operations_discarding-unused-blocks"></a>阻止丢弃操作</h1></div></div></div><p>块丢弃操作会丢弃已安装的文件系统不再使用的块。它们适用于：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">固态硬盘（SSD）</li><li class="listitem">精简配置存储</li></ul></div><h3><a id="requirements"></a>要求</h3><p>文件系统下的块设备必须支持物理丢弃操作。
			</p><p>如果<code class="literal">/sys/block/<span class="emphasis"><em><span class="replaceable">device</span></em></span>/queue/discard_max_bytes</code>文件中的值不为零，则支持物理丢弃操作。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="types-of-block-discard-operations_discarding-unused-blocks"></a>块丢弃操作的类型</h1></div></div></div><p>您可以使用不同的方法运行丢弃操作：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">批量丢弃</span></dt><dd>由用户明确运行。它们会丢弃所选文件系统中所有未使用的块。
						</dd><dt><span class="term">在线丢弃</span></dt><dd>在安装时指定。它们在没有用户干预的情况下实时运行。在线丢弃操作仅丢弃正在从已过渡到空闲的块。
						</dd><dt><span class="term">定期丢弃</span></dt><dd>是否由<code class="literal">systemd</code>服务定期运行批处理操作。
						</dd></dl></div><p>XFS和ext4文件系统以及VDO都支持所有类型。</p><h3><a id="recommendations_2"></a>建议</h3><p>Red Hat建议您使用批量或定期丢弃。
			</p><p>仅在以下情况下使用在线放弃：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">系统的工作量是批量丢弃不可行的，或者</li><li class="listitem">在线丢弃操作是维持性能所必需的。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="performing-batch-block-discard_discarding-unused-blocks"></a>执行批量块丢弃</h1></div></div></div><p>此过程执行批处理块丢弃操作以丢弃已装入文件系统上的未使用块。
			</p><h3><a id="prerequisites_12"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">文件系统已安装。
					</li><li class="listitem">文件系统底层的块设备支持物理丢弃操作。
					</li></ul></div><h3><a id="procedure_22"></a>程序</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">使用<code class="literal">fstrim</code>实用程序：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">要仅对选定的文件系统执行放弃，请使用：</p><pre class="screen"># fstrim <span class="emphasis"><em><span class="replaceable">mount-point</span></em></span></pre></li><li class="listitem"><p class="simpara">要在所有已安装的文件系统上执行丢弃，请使用：</p><pre class="screen"># fstrim --all</pre></li></ul></div></li></ul></div><p>如果您执行<code class="literal">fstrim</code>命令：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">不支持丢弃操作的设备，或</li><li class="listitem">由多个设备组成的逻辑设备（LVM或MD），其中任何一个设备都不支持丢弃操作，</li></ul></div><p>将显示以下消息：</p><pre class="screen"># fstrim <span class="emphasis"><em><span class="replaceable">/mnt/non_discard</span></em></span>

fstrim: <span class="emphasis"><em><span class="replaceable">/mnt/non_discard</span></em></span>: the discard operation is not supported</pre><h3><a id="additional_resources_15"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">fstrim(8)</code>手册页</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enabling-online-block-discard_discarding-unused-blocks"></a>启用在线区块丢弃</h1></div></div></div><p>此过程启用联机块丢弃操作，可自动丢弃所有支持的文件系统上未使用的块。
			</p><h3><a id="procedure_23"></a>程序</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">在挂载时启用在线丢弃：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">手动安装文件系统时，添加<code class="literal">-o discard</code> mount选项：</p><pre class="screen"># mount -o discard <span class="emphasis"><em><span class="replaceable">device</span></em></span> <span class="emphasis"><em><span class="replaceable">mount-point</span></em></span></pre></li><li class="listitem">在持久安装文件系统时，将<code class="literal">discard</code>选项添加到<code class="literal">/etc/fstab</code>文件中的mount条目。
							</li></ul></div></li></ul></div><h3><a id="additional_resources_16"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">mount(8)</code>手册页</li><li class="listitem"><code class="literal">fstab(5)</code>手册页</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enabling-periodic-block-discard_discarding-unused-blocks"></a>启用周期性块丢弃</h1></div></div></div><p>此过程使<code class="literal">systemd</code>计时器能够定期丢弃所有支持的文件系统上未使用的块。
			</p><h3><a id="procedure_24"></a>程序</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">启用并启动<code class="literal">systemd</code>计时器：</p><pre class="screen"># systemctl enable --now fstrim.timer</pre></li></ul></div></div></div></body></html>