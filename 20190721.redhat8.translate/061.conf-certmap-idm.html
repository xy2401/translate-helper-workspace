<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 在Identity Management中配置证书映射规则</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 在Identity Management中配置证书映射规则</h1></div></div></div><p>
			<a id="con-idm-certmapdata_conf-certmap-idm"></a>
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="certificate_mapping_rules_for_configuring_authentication_on_smart_cards"></a>用于配置智能卡身份验证的证书映射规则</h1></div></div></div><p>证书映射规则是允许用户在身份管理（IdM）管理员无权访问某些用户证书时使用证书进行身份验证的便捷方式。这种缺乏访问权限通常是由证书已由外部证书颁发机构颁发的事实引起的。特殊用例由Active Directory（AD）的证书系统颁发的证书表示，IdM域与该证书系统处于信任关系中。
			</p><p>如果IdM环境很大并且许多用户使用智能卡，则证书映射规则也很方便。在这种情况下，添加完整证书可能很复杂。主题和发行者在大多数情况下都是可预测的，因此比完整证书更容易提前添加。作为系统管理员，您可以创建证书映射规则，并在将证书颁发给特定用户之前将证书映射数据添加到用户条目。颁发证书后，即使完整证书未上传到其条目中，用户也可以使用证书登录。
			</p><p>此外，由于证书必须定期更新，因此证书映射规则可减少管理开销。续订用户证书后，管理员不必更新用户条目。例如，如果映射基于<code class="literal">Subject</code>和<code class="literal">Issuer</code>值，并且新证书与旧证书具有相同的主题和颁发者，则映射仍然适用。相反，如果使用了完整证书，则管理员必须将新证书上载到用户条目以替换旧证书。
			</p><p>要设置证书映射：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">管理员必须将证书映射数据（通常是颁发者和主题）或完整证书加载到用户帐户中。
					</li><li class="listitem"><p class="simpara">管理员必须创建证书映射规则，以允许成功登录用户的IdM</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">其帐户包含证书映射数据条目</li><li class="listitem">其证书映射数据条目与证书上的信息匹配</li></ol></div><p class="simpara">有关构成映射规则的各个组件以及如何获取和使用它们的详细信息，请参阅<a class="link" href="conf-certmap-idm.html#sc-id-mapping_conf-certmap-idm">IdM中的标识映射规则的组件</a>和<a class="link" href="conf-certmap-idm.html#sc-id-issuer-obtain-example_conf-certmap-idm">从证书中获取颁发者以在匹配规则中使用</a> 。
					</p></li></ol></div><p>之后，当最终用户提交他的证书（存储在<a class="link" href="dc-web-ui-auth.html#cert-idm-users-auth-procedure_dc-web-ui-auth">文件系统</a>或<a class="link" href="configuring-idm-for-smart-card-auth_cert-intro.html#logging-in-to-idm-with-smart-cards_configuring-idm-for-smart-card-auth" title="使用智能卡登录IdM">智能卡中）时</a> ，他会成功进行身份验证。
			</p><p>
				<a id="con-idm-ad-certmapdata_conf-certmap-idm"></a>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="certificate_mapping_rules_for_trusts_with_active_directory_domains"></a>具有Active Directory域的信任的证书映射规则</h2></div></div></div><p>本节概述了当IdM部署与Active Directory（AD）域处于信任关系时可能出现的不同证书映射用例。
				</p><p>证书映射规则是为具有由受信任的AD证书系统颁发的智能卡证书的用户启用对IdM资源的访问的便捷方式。根据AD配置，可能存在以下情况：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">如果证书由AD颁发但用户和证书存储在IdM中，则身份验证请求的映射和整个处理在IdM端进行。有关配置此方案的详细信息，请参阅<a class="link" href="conf-certmap-idm.html#conf-certmap-for-users-in-idm" title="为存储在IdM中的用户配置证书映射">为存储在IdM中的用户配置证书映射</a> 。</li><li class="listitem"><p class="simpara">如果用户存储在AD中，则认证请求的处理在AD中进行。有三种不同的子句：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">AD用户条目包含整个证书。有关如何在此方案中配置IdM的详细信息，请参阅<a class="link" href="conf-certmap-idm.html#conf-certmap-for-ad-certs" title="为AD用户条目包含整个证书的用户配置证书映射">为AD用户条目包含整个证书的用户配置证书映射</a> 。
								</li><li class="listitem">AD配置为将用户证书映射到用户帐户。在这种情况下，AD用户条目不包含整个证书，而是包含名为<code class="literal">altSecurityIdentities</code>的属性。有关如何在此方案中配置IdM的详细信息，请参阅<a class="link" href="conf-certmap-idm.html#conf-certmap-for-ad-map_conf-certmap-idm">配置证书映射，如果AD配置为将用户证书映射到用户帐户</a> 。
								</li><li class="listitem">AD用户条目既不包含整个证书也不包含映射数据。在这种情况下，唯一的解决方案是使用<code class="literal">ipa idoverrideuser-add</code>命令将整个证书添加到IdM中AD用户的ID覆盖。有关详细信息，请参阅<a class="link" href="conf-certmap-idm.html#conf-certmap-ad-no-cert-no-map" title="如果AD用户条目不包含证书或映射数据，则配置证书映射">配置证书映射，如果AD用户条目不包含证书或映射数据</a> 。
								</li></ul></div></li></ul></div><p>
					<a id="sc-id-mapping_conf-certmap-idm"></a>
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="components_of_an_identity_mapping_rule_in_idm"></a> IdM中标识映射规则的组件</h2></div></div></div><p>本节介绍IdM中<span class="emphasis"><em>身份映射规则</em></span>的组件以及如何配置它们。每个组件都有一个可以覆盖的默认值。您可以在Web UI或CLI中定义组件。在CLI中，使用<code class="literal">ipa certmaprule-add</code>命令创建标识映射规则。
				</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">映射规则</span></dt><dd><p class="simpara">映射规则组件<span class="emphasis"><em>将</em></span>证书与一个或多个用户帐户相关联（或<span class="emphasis"><em>映射</em></span> ）。该规则定义了一个LDAP搜索过滤器，用于将证书与预期的用户帐户相关联。
							</p><p class="simpara">不同证书颁发机构（CA）颁发的证书可能具有不同的属性，可能在不同的域中使用。因此，IdM不会无条件地应用映射规则，而只会应用于适当的证书。使用<span class="emphasis"><em>匹配规则</em></span>定义适当的证书。
							</p><p class="simpara">请注意，如果将映射规则选项保留为空，则会在<code class="literal">userCertificate</code>属性中将证书作为DER编码的二进制文件进行搜索。
							</p><p class="simpara">使用<code class="literal">--maprule</code>选项在CLI中定义映射规则。
							</p></dd><dt><span class="term">匹配规则</span></dt><dd><p class="simpara">匹配规则组件选择要应用映射规则的证书。默认匹配规则将使用<code class="literal">digitalSignature key</code>用法和<code class="literal">clientAuth extended key</code>用法匹配证书。
							</p><p class="simpara">使用<code class="literal">--matchrule</code>选项在CLI中定义匹配规则。
							</p></dd><dt><span class="term">域名列表</span></dt><dd><p class="simpara">域列表指定您希望IdM在处理标识映射规则时在其中搜索用户的标识域。如果您未指定选项，则IdM仅在IdM客户端所属的本地域中搜索用户。
							</p><p class="simpara">使用<code class="literal">--domain</code>选项在CLI中定义域。
							</p></dd><dt><span class="term">优先</span></dt><dd><p class="simpara">当多个规则适用于证书时，优先级最高的规则优先。所有其他规则都将被忽略。
							</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">数值越小，身份映射规则的优先级越高。例如，优先级为1的规则优先级高于优先级为2的规则。
									</li><li class="listitem">如果规则没有定义优先级值，则它具有最低优先级。
									</li></ul></div><p class="simpara">使用<code class="literal">--priority</code>选项在CLI中定义映射规则优先级。
							</p></dd></dl></div><div class="title"><strong>证书映射规则示例1</strong></div><p>要使用CLI定义名为<code class="literal">simple_rule</code>的证书映射规则，该规则允许对<code class="literal">EXAMPLE.ORG</code>组织的<code class="literal">Smart Card CA</code>颁发的证书进行身份验证，只要该证书上的<code class="literal">Subject</code>与IdM中用户帐户中的<code class="literal">certmapdata</code>条目匹配：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add simple_rule --matchrule '&lt;ISSUER&gt;CN=Smart Card CA,O=EXAMPLE.ORG' --maprule '(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})'</strong></span></pre><p>
					<a id="sc-id-issuer-obtain-example_conf-certmap-idm"></a>
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="obtaining_the_issuer_from_a_certificate_for_use_in_a_matching_rule"></a>从证书中获取颁发者以用于匹配规则</h2></div></div></div><p>此过程描述如何从证书中获取颁发者信息，以便您可以将其复制并粘贴到证书映射规则的匹配规则中。要获取匹配规则所需的颁发者格式，请使用<code class="literal">openssl x509</code>实用程序。
				</p><h3><a id="prerequisites_17"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">您拥有<code class="literal">.pem</code>或<code class="literal">.crt</code>格式的用户证书</li></ul></div><h3><a id="procedure_30"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">从证书中获取用户信息。使用<code class="literal">openssl x509</code>证书显示和签名实用程序：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">-noout</code>选项可防止输出请求的编码版本</li><li class="listitem"><code class="literal">-issuer</code>选项输出颁发者名称</li><li class="listitem"><code class="literal">-in</code>选项指定从中读取证书的输入文件名</li><li class="listitem"><p class="simpara">带有<code class="literal">RFC2253</code>值的<code class="literal">-nameopt</code>选项首先显示具有最具体的相对可分辨名称（RDN）的输出</p><p class="simpara">如果输入文件包含身份管理证书，则该命令的输出显示使用<code class="literal">Organisation</code>信息定义颁发者：</p><pre class="literallayout"># <span class="strong"><strong>openssl x509 -noout -issuer -in idm_user.crt -nameopt RFC2253</strong></span>
issuer=CN=Certificate Authority,O=REALM.EXAMPLE.COM</pre><p class="simpara">如果输入文件包含Active Directory证书，则该命令的输出显示使用<code class="literal">Domain Component</code>信息定义颁发者：</p><pre class="literallayout"># <span class="strong"><strong>openssl x509 -noout -issuer -in ad_user.crt -nameopt RFC2253</strong></span>
issuer=CN=AD-WIN2012R2-CA,DC=AD,DC=EXAMPLE,DC=COM</pre></li></ul></div></li><li class="listitem"><p class="simpara">（可选）在CLI中根据匹配规则创建新的映射规则，该规则指定证书颁发者必须是<code class="literal">ad.example.com</code>域的<code class="literal">ad.example.com</code>压缩<code class="literal">AD-WIN2012R2-CA</code> ，并且证书上的主题必须与<code class="literal">certmapdata</code>条目匹配在IdM中的用户帐户中：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add simple_rule --matchrule '&lt;ISSUER&gt;CN=AD-WIN2012R2-CA,DC=AD,DC=EXAMPLE,DC=COM' --maprule '(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})'</strong></span></pre></li></ol></div><h3><a id="additional_information"></a>附加信息</h3><p>有关<code class="literal">certmap</code>命令的详细信息，包括匹配规则和映射规则支持的格式的信息，以及优先级和域字段的说明，请参见<code class="literal">sss-certmap(5)</code>手册页。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="conf-certmap-for-users-in-idm"></a>为存储在IdM中的用户配置证书映射</h1></div></div></div><p>此用户案例描述了如果正在配置证书身份验证的用户存储在IdM中，系统管理员必须采取以在IdM中启用证书映射的步骤。</p><h3><a id="prerequisites_18"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">用户在IdM中拥有一个帐户。</li><li class="listitem">管理员具有要添加到用户条目的整个证书或证书映射数据。
					</li></ul></div><p>
				<a id="proc-add-maprule_conf-certmap-for-users-in-idm"></a>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_mapping_rule_in_idm"></a>在IdM中添加证书映射规则</h2></div></div></div><p>本节介绍如何设置证书映射规则，以便具有与映射规则及其证书映射数据条目中指定的条件匹配的证书的IdM用户可以向IdM进行身份验证。</p><p>
					<a id="proc-add-maprule-webui_proc-add-maprule"></a>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_web_ui"></a>在IdM Web UI中添加证书映射规则</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">以管理员身份登录IdM Web UI。
							</li><li class="listitem">导航到<code class="literal">Authentication</code> → <code class="literal">Certificate Identity Mapping Rules</code> → <code class="literal">Certificate Identity Mapping Rules</code> 。
							</li><li class="listitem"><p class="simpara">单击<code class="literal">Add</code> 。
							</p><div class="figure"><a id="proc-add-maprule-new-certmaprule-add"></a><p class="title"><strong>图11.1。在IdM Web UI中添加新的证书映射规则</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-certmaprule-add.png" alt="新的certmaprule添加"></div></div></div></li><li class="listitem">输入规则名称。
							</li><li class="listitem"><p class="simpara">输入映射规则。例如，要使IdM在提供给它们的任何证书中搜索<code class="literal">Issuer</code>和<code class="literal">Subject</code>条目，并根据所提供证书的这两个条目中找到的信息进行身份验证的决定：</p><pre class="literallayout"><span class="strong"><strong>(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})</strong></span></pre></li><li class="listitem"><p class="simpara">输入匹配规则。例如，仅允许<code class="literal">EXAMPLE.ORG</code>组织的<code class="literal">Smart Card CA</code>颁发的证书对IdM的用户进行身份验证：</p><pre class="literallayout"><span class="strong"><strong>&lt;ISSUER&gt;CN=Smart Card CA,O=EXAMPLE.ORG</strong></span></pre><div class="figure"><a id="proc-add-maprule-certmaprule-add-details"></a><p class="title"><strong>图11.2。在IdM Web UI中输入证书映射规则的详细信息</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/certmaprule-add-details1.png" alt="certmaprule添加details1"></div></div></div></li><li class="listitem">点击<code class="literal">Add</code>在对话框的底部添加规则并关闭对话框。
							</li><li class="listitem"><p class="simpara">系统安全服务守护程序（SSSD）定期重新读取证书映射规则。要强制立即加载新创建的规则，请重新启动SSSD：</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>现在，您具有证书映射规则设置，该规则将在智能卡证书上找到的映射规则中指定的数据类型与IdM用户条目中的证书映射数据进行比较。找到匹配后，它会对匹配的用户进行身份验证。
					</p><p>
						<a id="proc-add-maprule-cli_proc-add-maprule"></a>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_cli"></a>在IdM CLI中添加证书映射规则</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">获取管理员的凭据：</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">输入映射规则和映射规则所基于的匹配规则。例如，要使IdM在所提供的任何证书中搜索<code class="literal">Issuer</code>和<code class="literal">Subject</code>条目，并根据所提供证书的这两个条目中找到的信息进行认证或不认证，只识别由<code class="literal">Smart Card CA</code>颁发的证书。 <code class="literal">EXAMPLE.ORG</code>组织：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add <code class="literal">rule_name</code> --matchrule '&lt;ISSUER&gt;CN=Smart Card CA,O=EXAMPLE.ORG' --maprule '(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})'</strong></span>
-------------------------------------------------------
Added Certificate Identity Mapping Rule "rule_name"
-------------------------------------------------------
  Rule name: rule_name
  Mapping rule: (ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})
  Matching rule: &lt;ISSUER&gt;CN=Smart Card CA,O=EXAMPLE.ORG
  Enabled: TRUE</pre></li><li class="listitem"><p class="simpara">系统安全服务守护程序（SSSD）定期重新读取证书映射规则。要强制立即加载新创建的规则，请重新启动SSSD：</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>现在，您具有证书映射规则设置，该规则将在智能卡证书上找到的映射规则中指定的数据类型与IdM用户条目中的证书映射数据进行比较。找到匹配后，它会对匹配的用户进行身份验证。
					</p><p>
						<a id="proc-add-certmapdata-to-user_conf-certmap-for-users-in-idm"></a>
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_certificate_mapping_data_to_a_user_entry_in_idm"></a>将证书映射数据添加到IdM中的用户条目</h2></div></div></div><p>本节介绍如何将证书映射数据输入到IdM用户条目，以便用户可以使用多个证书进行身份验证，只要它们都包含证书映射数据条目中指定的值。
				</p><p>
					<a id="proc-add-certmapdata-to-user-webui_conf-certmap-for-users-in-idm"></a>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_certificate_mapping_data_to_a_user_entry_in_the_idm_web_ui"></a>将证书映射数据添加到IdM Web UI中的用户条目</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">以管理员身份登录IdM Web UI。
							</li><li class="listitem">导航到<code class="literal">Users</code> → <code class="literal">Active users</code> → <code class="literal">idm_user</code> 。
							</li><li class="listitem">找到<code class="literal">Certificate mapping data</code>选项，然后单击<code class="literal">Add</code> 。
							</li><li class="listitem"><p class="simpara">如果您拥有<code class="literal">idm_user</code>证书， <code class="literal">idm_user</code>可以使用：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">在命令行界面中，使用<code class="literal">cat</code>实用程序或文本编辑器显示证书：</p><pre class="literallayout">[root@server ~]# <span class="strong"><strong>cat idm_user_certificate.pem</strong></span>
-----BEGIN CERTIFICATE-----
MIIFFTCCA/2gAwIBAgIBEjANBgkqhkiG9w0BAQsFADA6MRgwFgYDVQQKDA9JRE0u
RVhBTVBMRS5DT00xHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0x
ODA5MDIxODE1MzlaFw0yMDA5MDIxODE1MzlaMCwxGDAWBgNVBAoMD0lETS5FWEFN
[...output truncated...]</pre></li><li class="listitem">复制证书。
									</li><li class="listitem"><p class="simpara">在IdM Web UI中，单击“ <code class="literal">Certificate</code>旁边的“ <code class="literal">Add</code> ，然后将<code class="literal">Certificate</code>粘贴到打开的窗口中。
									</p><div class="figure"><a id="conf-certmap-for-users-in-idm-add-user-certmapdata-cert"></a><p class="title"><strong>图11.3。添加用户的证书映射数据：证书</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/user-add-cert.png" alt="用户添加证书"></div></div></div><p class="simpara">或者，如果您没有自己的<code class="literal">idm_user</code>证书但知道证书的<code class="literal">Issuer</code>人和<code class="literal">Subject</code> ，请选中<code class="literal">Issuer and subject</code>的单选按钮， <code class="literal">Issuer and subject</code>在两个相应的框中输入值。
									</p><div class="figure"><a id="conf-certmap-for-users-in-idm-add-user-certmapdata-data"></a><p class="title"><strong>图11.4。添加用户的证书映射数据：颁发者和主题</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/user-add-certdata.png" alt="用户添加certdata"></div></div></div></li></ol></div></li><li class="listitem">单击<code class="literal">Add</code> 。
							</li><li class="listitem"><p class="simpara">（可选）如果您可以访问<code class="literal">.pem</code>格式的整个证书，请验证用户和证书是否已链接：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">使用<code class="literal">sss_cache</code>实用程序使SSSD缓存中的<code class="literal">idm_user</code>记录无效并强制重新加载<code class="literal">idm_user</code>信息：</p><pre class="literallayout"># <span class="strong"><strong>sss_cache -u idm_user</strong></span></pre></li><li class="listitem"><p class="simpara">使用包含IdM用户证书的文件名运行<code class="literal">ipa certmap-match</code>命令：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmap-match idm_user_cert.pem</strong></span>
--------------
1 user matched
--------------
 Domain: IDM.EXAMPLE.COM
 User logins: idm_user
----------------------------
Number of entries returned 1
----------------------------</pre><p class="simpara">输出确认现在您已将证书映射数据添加到<code class="literal">idm_user</code>并且存在<a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">在IdM</a>中<a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">添加证书映射规则中</a>定义的相应映射规则。这意味着您可以使用与定义的证书映射数据匹配的任何证书作为<code class="literal">idm_user</code>进行身份验证。
									</p></li></ol></div></li></ol></div><p>
						<a id="proc-add-certmapdata-to-user-cli_conf-certmap-for-users-in-idm"></a>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_certificate_mapping_data_to_a_user_entry_in_the_idm_cli"></a>将证书映射数据添加到IdM CLI中的用户条目</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">获取管理员的凭据：</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">如果您拥有<code class="literal">idm_user</code>证书，请使用<code class="literal">ipa user-add-cert</code>命令<code class="literal">ipa user-add-cert</code>到用户帐户：</p><pre class="literallayout"># <span class="strong"><strong>CERT=`cat idm_user_cert.pem | tail -n +2| head -n -1 | tr -d '\r\n'\`</strong></span>
# <span class="strong"><strong>ipa user-add-certmapdata idm_user --certificate $CERT</strong></span></pre><p class="simpara">或者，如果您没有自己的<code class="literal">idm_user</code>证书，但知道<code class="literal">Issuer</code>和idm_user证书的<code class="literal">Subject</code> ：</p><pre class="literallayout"># <span class="strong"><strong>ipa user-add-certmapdata idm_user --subject "O=EXAMPLE.ORG,CN=test" --issuer "CN=Smart Card CA,O=EXAMPLE.ORG"</strong></span>
--------------------------------------------
Added certificate mappings to user "idm_user"
--------------------------------------------
  User login: idm_user
  Certificate mapping data: X509:&lt;I&gt;O=EXAMPLE.ORG,CN=Smart Card CA&lt;S&gt;CN=test,O=EXAMPLE.ORG</pre></li><li class="listitem"><p class="simpara">（可选）如果您可以访问<code class="literal">.pem</code>格式的整个证书，请验证用户和证书是否已链接：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">使用<code class="literal">sss_cache</code>实用程序使SSSD缓存中的<code class="literal">idm_user</code>记录无效并强制重新加载<code class="literal">idm_user</code>信息：</p><pre class="literallayout"># <span class="strong"><strong>sss_cache -u idm_user</strong></span></pre></li><li class="listitem"><p class="simpara">使用包含IdM用户证书的文件名运行<code class="literal">ipa certmap-match</code>命令：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmap-match idm_user_cert.pem</strong></span>
--------------
1 user matched
--------------
 Domain: IDM.EXAMPLE.COM
 User logins: idm_user
----------------------------
Number of entries returned 1
----------------------------</pre><p class="simpara">输出确认现在您已将证书映射数据添加到<code class="literal">idm_user</code>并且存在<a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">在IdM</a>中<a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">添加证书映射规则中</a>定义的相应映射规则。这意味着您可以使用与定义的证书映射数据匹配的任何证书作为<code class="literal">idm_user</code>进行身份验证。
									</p></li></ol></div></li></ol></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="conf-certmap-for-ad-certs"></a>为AD用户条目包含整个证书的用户配置证书映射</h1></div></div></div><p>此用户案例描述了在IdM部署与Active Directory（AD）信任，用户存储在AD中并且AD中的用户条目包含整个证书时，在IdM中启用证书映射所需的步骤。
			</p><h3><a id="prerequisites_19"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">用户在IdM中没有帐户。</li><li class="listitem">用户在AD中拥有一个包含证书的帐户。
					</li><li class="listitem">IdM管理员可以访问IdM证书映射规则可以基于的数据。
					</li></ul></div><p>
				<a id="proc-add-maprule-ad-cert_conf-certmap-for-ad-certs"></a>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_mapping_rule_for_users_whose_ad_entry_contains_whole_certificates"></a>为AD条目包含完整证书的用户添加证书映射规则</h2></div></div></div><p>
					<a id="proc-add-maprule-webui-ad-cert_proc-add-maprule-ad-cert"></a>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_web_ui_2"></a>在IdM Web UI中添加证书映射规则</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">以管理员身份登录IdM Web UI。
							</li><li class="listitem">导航到<code class="literal">Authentication</code> → <code class="literal">Certificate Identity Mapping Rules</code> → <code class="literal">Certificate Identity Mapping Rules</code> 。
							</li><li class="listitem"><p class="simpara">单击<code class="literal">Add</code> 。
							</p><div class="figure"><a id="proc-add-maprule-ad-cert-new-certmaprule-add-ad-cert"></a><p class="title"><strong>图11.5。在IdM Web UI中添加新的证书映射规则</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-certmaprule-add.png" alt="新的certmaprule添加"></div></div></div></li><li class="listitem">输入规则名称。
							</li><li class="listitem"><p class="simpara">输入映射规则。与AD中可用的证书相比，将提供给IdM的整个证书用于身份验证：</p><pre class="literallayout"><span class="strong"><strong>(userCertificate;binary={cert!bin})</strong></span></pre></li><li class="listitem"><p class="simpara">输入匹配规则。例如，仅允许<code class="literal">AD.EXAMPLE.COM</code>域的<code class="literal">AD-ROOT-CA</code>颁发的证书进行身份验证：</p><pre class="literallayout"><span class="strong"><strong>&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com</strong></span></pre><div class="figure"><a id="proc-add-maprule-ad-cert-certmaprule-add-details-ad-cert"></a><p class="title"><strong>图11.6。具有存储在AD中的证书的用户的证书映射规则</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/certmaprule-add-details-ad-cert.png" alt="certmaprule添加详细信息广告证书"></div></div></div></li><li class="listitem">单击<code class="literal">Add</code> 。
							</li><li class="listitem"><p class="simpara">系统安全服务守护程序（SSSD）定期重新读取证书映射规则。要强制立即加载新创建的规则，请在CLI中重新启动SSSD ::</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="proc-add-maprule-cli-ad-cert_proc-add-maprule-ad-cert"></a>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_cli_2"></a>在IdM CLI中添加证书映射规则</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">获取管理员的凭据：</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">输入映射规则和映射规则所基于的匹配规则。要使用与AD中可用的证书相比，提供用于身份验证的整个证书，只允许<code class="literal">AD.EXAMPLE.COM</code>域的<code class="literal">AD-ROOT-CA</code>颁发的证书进行身份验证：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add <code class="literal">simpleADrule</code> --matchrule '&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com' --maprule '(userCertificate;binary={cert!bin})' --domain ad.example.com</strong></span>
-------------------------------------------------------
Added Certificate Identity Mapping Rule "simpleADrule"
-------------------------------------------------------
  Rule name: simpleADrule
  Mapping rule: (userCertificate;binary={cert!bin})
  Matching rule: &lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com
  Domain name: ad.example.com
  Enabled: TRUE</pre></li><li class="listitem"><p class="simpara">系统安全服务守护程序（SSSD）定期重新读取证书映射规则。要强制立即加载新创建的规则，请重新启动SSSD：</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="conf-certmap-for-ad-map_conf-certmap-idm"></a>
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_certificate_mapping_if_ad_is_configured_to_map_user_certificates_to_user_accounts"></a>如果AD配置为将用户证书映射到用户帐户，则配置证书映射</h1></div></div></div><p>此用户案例描述了如果IdM部署与Active Directory（AD）信任，用户存储在AD中并且AD中的用户条目包含证书映射数据，则在IdM中启用证书映射所需的步骤。
			</p><h3><a id="prerequisites_20"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">用户在IdM中没有帐户。</li><li class="listitem">用户在AD中有一个帐户，其中包含<code class="literal">altSecurityIdentities</code>属性，即IdM <code class="literal">certmapdata</code> atttribute的AD等效项。
					</li><li class="listitem">IdM管理员可以访问IdM证书映射规则可以基于的数据。
					</li></ul></div><p>
				<a id="add-ad-maprule_conf-certmap-for-ad-map"></a>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_mapping_rule_if_the_trusted_ad_domain_is_configured_to_map_user_certificates"></a>如果可信AD域配置为映射用户证书，则添加证书映射规则</h2></div></div></div><p>
					<a id="proc-add-ad-maprule-webui_conf-certmap-for-ad-map"></a>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_web_ui_3"></a>在IdM Web UI中添加证书映射规则</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">以管理员身份登录IdM Web UI。
							</li><li class="listitem">导航到<code class="literal">Authentication</code> → <code class="literal">Certificate Identity Mapping Rules</code> → <code class="literal">Certificate Identity Mapping Rules</code> 。
							</li><li class="listitem"><p class="simpara">单击<code class="literal">Add</code> 。
							</p><div class="figure"><a id="conf-certmap-for-ad-map-new-certmaprule-add-ad-map"></a><p class="title"><strong>图11.7。在IdM Web UI中添加新的证书映射规则</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-certmaprule-add.png" alt="新的certmaprule添加"></div></div></div></li><li class="listitem">输入规则名称。
							</li><li class="listitem"><p class="simpara">输入映射规则。例如，要对提供的任何证书中的<code class="literal">Issuer</code>和<code class="literal">Subject</code>条目进行AD DC搜索，并<code class="literal">Subject</code>所呈现证书的这两个条目中的信息进行身份验证或不进行身份验证的决定：</p><pre class="literallayout"><span class="strong"><strong>(altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500})</strong></span></pre></li><li class="listitem"><p class="simpara">输入匹配规则。例如，要仅允许<code class="literal">AD.EXAMPLE.COM</code>域的<code class="literal">AD-ROOT-CA</code>颁发的证书对IdM的用户进行身份验证：</p><pre class="literallayout"><span class="strong"><strong>&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com</strong></span></pre></li><li class="listitem"><p class="simpara">输入域名：</p><pre class="literallayout"><span class="strong"><strong>ad.example.com</strong></span></pre><div class="figure"><a id="conf-certmap-for-ad-map-certmaprule-add-details-ad-map"></a><p class="title"><strong>图11.8。如果AD配置为映射，则为证书映射规则</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/certmaprule-add-details-ad-map.png" alt="certmaprule添加详细信息广告地图"></div></div></div></li><li class="listitem">单击<code class="literal">Add</code> 。
							</li><li class="listitem"><p class="simpara">系统安全服务守护程序（SSSD）定期重新读取证书映射规则。要强制立即加载新创建的规则，请在CLI中重新启动SSSD ::</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="proc-add-ad-maprule-cli_conf-certmap-for-ad-map"></a>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_cli_3"></a>在IdM CLI中添加证书映射规则</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">获取管理员的凭据：</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">输入映射规则和映射规则所基于的匹配规则。例如，要在所提供的任何证书中进行AD搜索<code class="literal">Issuer</code>和<code class="literal">Subject</code>条目，并且仅允许<code class="literal">AD.EXAMPLE.COM</code>域的<code class="literal">AD-ROOT-CA</code>颁发的证书：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add ad_configured_for_mapping_rule --matchrule '&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com' --maprule '(altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500})' --domain=ad.example.com</strong></span>
-------------------------------------------------------
Added Certificate Identity Mapping Rule "ad_configured_for_mapping_rule"
-------------------------------------------------------
  Rule name: ad_configured_for_mapping_rule
  Mapping rule: (altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500})
  Matching rule: &lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com
  Domain name: ad.example.com
  Enabled: TRUE</pre></li><li class="listitem"><p class="simpara">系统安全服务守护程序（SSSD）定期重新读取证书映射规则。要强制立即加载新创建的规则，请重新启动SSSD：</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="check-if-ad-maprule-exists_conf-certmap-for-ad-map"></a>
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="checking_certificate_mapping_data_on_the_ad_side"></a>检查AD侧的证书映射数据</h2></div></div></div><p><code class="literal">altSecurityIdentities</code>属性是IdM中<code class="literal">certmapdata</code>用户属性的Active Directory（AD）等效项。在可信AD域配置为将用户证书映射到用户帐户的方案中，在IdM中配置证书映射时，IdM系统管理员需要检查AD中用户条目中是否正确设置了<code class="literal">altSecurityIdentities</code>属性。</p><p>要检查AD是否包含存储在AD中的用户的正确信息，请使用<code class="literal">ldapsearch</code>命令。
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">例如，要检查与<code class="literal">adserver.ad.example.com</code>服务器<code class="literal">altSecurityIdentities</code>属性中的用户条目设置<code class="literal">ad_user</code>并且matchrule规定证书<code class="literal">ad_user</code>用于认证到AD的颁发<code class="literal">AD-ROOT-CA</code> <code class="literal">ad.example.com</code>域的主题是<code class="literal">&lt;S&gt;DC=com,DC=example,DC=ad,CN=Users,CN=ad_user</code> ：</p><pre class="literallayout"><span class="strong"><strong>$ ldapsearch -o ldif-wrap=no -LLL -h adserver.ad.example.com</strong></span> \
<span class="strong"><strong>-p 389 -D cn=Administrator,cn=users,dc=ad,dc=example,dc=com</strong></span> \
<span class="strong"><strong>-W -b cn=users,dc=ad,dc=example,dc=com "(cn=ad_user)"</strong></span> \
<span class="strong"><strong>altSecurityIdentities</strong></span>
Enter LDAP Password:
dn: CN=ad_user,CN=Users,DC=ad,DC=example,DC=com
altSecurityIdentities: X509:&lt;I&gt;DC=com,DC=example,DC=ad,CN=AD-ROOT-CA&lt;S&gt;DC=com,DC=example,DC=ad,CN=Users,CN=ad_user</pre></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="conf-certmap-ad-no-cert-no-map"></a>如果AD用户条目不包含证书或映射数据，则配置证书映射</h1></div></div></div><p>此用户案例描述了在IdM部署与Active Directory（AD）信任，用户存储在AD中以及AD中的用户条目既不包含整个证书也不包含证书映射数据时，在IdM中启用证书映射所需的步骤。
			</p><h3><a id="prerequisites_21"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">用户在IdM中没有帐户。</li><li class="listitem">用户在AD中拥有一个帐户，该帐户既不包含整个证书也不包含<code class="literal">altSecurityIdentities</code>属性，即<code class="literal">altSecurityIdentities</code>等效于IdM <code class="literal">certmapdata</code> atttribute。
					</li><li class="listitem">IdM管理员具有要在IdM中添加到AD用户的<code class="literal">user ID override</code>的整个AD用户证书。</li></ul></div><p>
				<a id="add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map"></a>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_mapping_rule_if_the_ad_user_entry_contains_no_certificate_or_mapping_data"></a>如果AD用户条目不包含证书或映射数据，则添加证书映射规则</h2></div></div></div><p>
					<a id="proc-add-certmaprule-ad-no-cert-no-map-webui_conf-certmap-ad-no-cert-no-map"></a>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_web_ui_4"></a>在IdM Web UI中添加证书映射规则</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">以管理员身份登录IdM Web UI。
							</li><li class="listitem">导航到<code class="literal">Authentication</code> → <code class="literal">Certificate Identity Mapping Rules</code> → <code class="literal">Certificate Identity Mapping Rules</code> 。
							</li><li class="listitem"><p class="simpara">单击<code class="literal">Add</code> 。
							</p><div class="figure"><a id="conf-certmap-ad-no-cert-no-map-new-certmaprule-add-ad-no-cert-no-map"></a><p class="title"><strong>图11.9。在IdM Web UI中添加新的证书映射规则</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-certmaprule-add.png" alt="新的certmaprule添加"></div></div></div></li><li class="listitem">输入规则名称。
							</li><li class="listitem"><p class="simpara">输入映射规则。要使用IdM进行身份验证的整个证书与存储在用户ID中的证书相比，覆盖IdM中AD用户条目的条目：</p><pre class="literallayout"><span class="strong"><strong>(userCertificate;binary={cert!bin})</strong></span></pre></li><li class="listitem"><p class="simpara">输入匹配规则。例如，仅允许<code class="literal">AD.EXAMPLE.COM</code>域的<code class="literal">AD-ROOT-CA</code>颁发的证书进行身份验证：</p><pre class="literallayout"><span class="strong"><strong>&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com</strong></span></pre></li><li class="listitem"><p class="simpara">输入域名。例如，要在<code class="literal">ad.example.com</code>域中搜索用户：</p><div class="figure"><a id="conf-certmap-ad-no-cert-no-map-certmaprule-add-details-ad-no-cert-no-map"></a><p class="title"><strong>图11.10。证书映射规则，用于没有证书或AD中存储的映射数据的用户</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/certmaprule-add-details-ad-cert.png" alt="certmaprule添加详细信息广告证书"></div></div></div></li><li class="listitem">单击<code class="literal">Add</code> 。
							</li><li class="listitem"><p class="simpara">系统安全服务守护程序（SSSD）定期重新读取证书映射规则。要强制立即加载新创建的规则，请在CLI中重新启动SSSD：</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="proc-add-certmaprule-ad-no-cert-no-map-cli_conf-certmap-ad-no-cert-no-map"></a>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_cli_4"></a>在IdM CLI中添加证书映射规则</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">获取管理员的凭据：</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">输入映射规则和映射规则所基于的匹配规则。使用于身份验证的整个证书与存储在用户ID中的证书相比，覆盖IdM中AD用户条目的条目，仅允许<code class="literal">AD.EXAMPLE.COM</code>域的<code class="literal">AD-ROOT-CA</code>颁发的证书进行身份验证：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add <code class="literal">simpleADrule</code> --matchrule '&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com' --maprule '(userCertificate;binary={cert!bin})' --domain ad.example.com</strong></span>
-------------------------------------------------------
Added Certificate Identity Mapping Rule "simpleADrule"
-------------------------------------------------------
  Rule name: simpleADrule
  Mapping rule: (userCertificate;binary={cert!bin})
  Matching rule: &lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com
  Domain name: ad.example.com
  Enabled: TRUE</pre></li><li class="listitem"><p class="simpara">系统安全服务守护程序（SSSD）定期重新读取证书映射规则。要强制立即加载新创建的规则，请重新启动SSSD：</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="add-certmapdata-no-cert-no-map_conf-certmap-ad-no-cert-no-map"></a>
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_to_an_ad_user_s_id_override_if_the_user_entry_in_ad_contains_no_certificate_or_mapping_data"></a>如果AD中的用户条目不包含证书或映射数据，则将证书添加到AD用户的ID覆盖</h2></div></div></div><p>
					<a id="proc-add-certmapdata-to-ad-user-webui_conf-certmap-ad-no-cert-no-map"></a>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_to_an_ad_user_s_id_override_in_the_idm_web_ui"></a>在IdM Web UI中将证书添加到AD用户的ID覆盖</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">导航到“ <code class="literal">Identity</code> →“ <code class="literal">ID Views</code> →“ <code class="literal">Default Trust View</code> 。
							</li><li class="listitem"><p class="simpara">单击<code class="literal">Add</code> 。
							</p><div class="figure"><a id="conf-certmap-ad-no-cert-no-map-new-useridoverride-add"></a><p class="title"><strong>图11.11。在IdM Web UI中添加新的用户ID覆盖</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-useridoverride-add.png" alt="新的useridoverride添加"></div></div></div></li><li class="listitem">在<code class="literal">User to override</code>的<code class="literal">User to override</code>字段中，输入<code class="literal">ad_user@ad.example.com</code> 。
							</li><li class="listitem"><p class="simpara">将<code class="literal">ad_user</code>证书复制并粘贴到“ <code class="literal">Certificate</code>字段中。
							</p><div class="figure"><a id="conf-certmap-ad-no-cert-no-map-useridoverride-add-details"></a><p class="title"><strong>图11.12。配置AD用户的用户ID覆盖</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/useridoverride-add-details.png" alt="useridoverride添加详细信息"></div></div></div></li><li class="listitem">单击<code class="literal">Add</code> 。
							</li><li class="listitem"><p class="simpara">（可选）验证用户和证书是否已链接：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">使用<code class="literal">sss_cache</code>实用程序使SSSD缓存中的<code class="literal">ad_user@ad.example.com</code>记录无效，并强制重新加载<code class="literal">ad_user@ad.example.com</code>信息：</p><pre class="literallayout"># <span class="strong"><strong>sss_cache -u ad_user@ad.example.com</strong></span></pre></li><li class="listitem"><p class="simpara">使用包含AD用户证书的文件名运行<code class="literal">ipa certmap-match</code>命令：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmap-match ad_user_cert.pem</strong></span>
--------------
1 user matched
--------------
 Domain: AD.EXAMPLE.COM
 User logins: ad_user@ad.example.com
----------------------------
Number of entries returned 1
----------------------------</pre><p class="simpara">输出确认您已将证书映射数据添加到<code class="literal">ad_user@ad.example.com</code>并且<a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">如果AD用户条目不包含证书或映射数据，则会</a>在<a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">添加证书映射规则中</a>定义相应的映射规则。这意味着您可以使用与定义的证书映射数据匹配的任何证书进行身份验证，如<code class="literal">ad_user@ad.example.com</code> 。
									</p></li></ol></div></li></ol></div><p>
						<a id="proc-add-certmapdata-to-ad-user-cli_conf-certmap-ad-no-cert-no-map"></a>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_to_an_ad_user_s_id_override_in_the_idm_cli"></a>在IdM CLI中将证书添加到AD用户的ID覆盖</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">获取管理员的凭据：</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">证书添加<code class="literal">ad_user@ad.example.com</code>使用用户帐户<code class="literal">ipa idoverrideuser-add-cert</code>的命令：</p><pre class="literallayout"># <span class="strong"><strong>CERT=`cat ad_user_cert.pem | tail -n +2| head -n -1 | tr -d '\r\n'\`</strong></span>
# <span class="strong"><strong>ipa idoverrideuser-add-cert ad_user@ad.example.com --certificate $CERT</strong></span></pre></li><li class="listitem"><p class="simpara">（可选）验证用户和证书是否已链接：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">使用<code class="literal">sss_cache</code>实用程序使SSSD缓存中的<code class="literal">ad_user@ad.example.com</code>记录无效，并强制重新加载<code class="literal">ad_user@ad.example.com</code>信息：</p><pre class="literallayout"># <span class="strong"><strong>sss_cache -u ad_user@ad.example.com</strong></span></pre></li><li class="listitem"><p class="simpara">使用包含AD用户证书的文件名运行<code class="literal">ipa certmap-match</code>命令：</p><pre class="literallayout"># <span class="strong"><strong>ipa certmap-match ad_user_cert.pem</strong></span>
--------------
1 user matched
--------------
 Domain: AD.EXAMPLE.COM
 User logins: ad_user@ad.example.com
----------------------------
Number of entries returned 1
----------------------------</pre><p class="simpara">输出确认您已将证书映射数据添加到<code class="literal">ad_user@ad.example.com</code>并且<a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">如果AD用户条目不包含证书或映射数据，则会</a>在<a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">添加证书映射规则中</a>定义相应的映射规则。这意味着您可以使用与定义的证书映射数据匹配的任何证书进行身份验证，如<code class="literal">ad_user@ad.example.com</code> 。
									</p></li></ol></div></li></ol></div><p>
						<a id="sc-cert-mapping-rule-examples_conf-certmap-ad-no-cert-no-map"></a>
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="combining_several_identity_mapping_rules_into_one"></a>将多个身份映射规则合并为一个</h1></div></div></div><p>要将多个标识映射规则组合到一个组合规则中，请使用<code class="literal">|</code> （或）在各个映射规则之前的字符，并使用<code class="literal">()</code>括号将它们分开，例如：</p><div class="title"><strong>证书映射过滤器示例1</strong></div><p>
					
</p><pre class="literallayout">$ <span class="strong"><strong>ipa certmaprule-add ad_cert_for_ipa_and_ad_users \ --maprule='(|(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})(altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500}))' \ --matchrule='&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com' \ --domain=ad.example.com</strong></span></pre><p>

				</p><p>在上面的示例中， - <code class="literal">--maprule</code>选项中的过滤器定义包括以下条件：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<code class="literal">ipacertmapdata = X509：&lt;I&gt; {issuer_dn！nss_x500} &lt;S&gt; {subject_dn！nss_x500}</code>是一个过滤器，它将主题和颁发者从智能卡证书链接到IdM用户帐户中的<code class="literal">ipacertmapdata</code>属性的值，如<a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">在IdM</a>中<a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">添加证书映射规则中所述</a>
					</li><li class="listitem">
						<code class="literal">altSecurityIdentities = X509：&lt;I&gt; {issuer_dn！ad_x500} &lt;S&gt; {subject_dn！ad_x500}</code>是一个过滤器，用于将主题和颁发者从智能卡证书链接到AD用户帐户中<code class="literal">altSecurityIdentities</code>属性的值， <a class="link" href="conf-certmap-idm.html#add-ad-maprule_conf-certmap-for-ad-map">如在可信AD域配置为映射用户证书时添加证书映射规则中所述</a>
					</li><li class="listitem">添加<code class="literal">--domain=ad.example.com</code>选项意味着映射到给定证书的用户不仅会在本地<code class="literal">idm.example.com</code>域中搜索，还会在<code class="literal">ad.example.com</code>域中搜索</li></ul></div><p><code class="literal">--maprule</code>选项中的过滤器定义接受逻辑运算符<code class="literal">|</code> （或），以便您可以指定多个条件。在这种情况下，规则映射满足至少一个条件的所有用户帐户。
			</p><div class="title"><strong>证书映射过滤器示例2</strong></div><p>
					
</p><pre class="literallayout">$ <span class="strong"><strong>ipa certmaprule-add ipa_cert_for_ad_users</strong></span> \
  <span class="strong"><strong>--maprule='(|(userCertificate;binary={cert!bin})(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})(altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500}))'</strong></span> \
  <span class="strong"><strong>--matchrule='&lt;ISSUER&gt;CN=Certificate Authority,O=REALM.EXAMPLE.COM'</strong></span> \
  <span class="strong"><strong>--domain=idm.example.com --domain=ad.example.com</strong></span></pre><p>

				</p><p>在上面的示例中， - <code class="literal">--maprule</code>选项中的过滤器定义包括以下条件：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<code class="literal">的userCertificate;二进制= {证书！bin}</code>是一个过滤器，它返回包含整个证书的用户条目。对于AD用户， <a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">如果AD用户条目不包含证书或映射数据，则</a>在<a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">添加证书映射规则</a>中将详细描述创建此类型的过滤器。
					</li><li class="listitem">
						<code class="literal">ipacertmapdata = X509：&lt;I&gt; {issuer_dn！nss_x500} &lt;S&gt; {subject_dn！nss_x500}</code>是一个过滤器，它将主题和颁发者从智能卡证书链接到IdM用户帐户中的<code class="literal">ipacertmapdata</code>属性的值，如<a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">在IdM</a>中<a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">添加证书映射规则中所述</a> 。</li><li class="listitem">
						<code class="literal">altSecurityIdentities = X509：&lt;I&gt; {issuer_dn！ad_x500} &lt;S&gt; {subject_dn！ad_x500}</code>是一个筛选器，它将主题和颁发者从智能卡证书链接到AD用户帐户中<code class="literal">altSecurityIdentities</code>属性的值，如<a class="link" href="conf-certmap-idm.html#add-ad-maprule_conf-certmap-for-ad-map">添加证书映射规则（如果可信AD域配置为映射用户证书）中所述</a> 。
					</li></ul></div><p><code class="literal">--maprule</code>选项中的过滤器定义接受逻辑运算符<code class="literal">|</code> （或），以便您可以指定多个条件。在这种情况下，规则映射满足至少一个条件的所有用户帐户。
			</p></div></div></body></html>