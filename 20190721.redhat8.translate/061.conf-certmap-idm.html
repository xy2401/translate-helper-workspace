<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 11. Configuring certificate mapping rules in Identity Management</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="conf-certmap-idm"/>Chapter 11. Configuring certificate mapping rules in Identity Management</h1></div></div></div><p>
			<a id="con-idm-certmapdata_conf-certmap-idm"/>
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="certificate_mapping_rules_for_configuring_authentication_on_smart_cards"/>Certificate mapping rules for configuring authentication on smart cards</h1></div></div></div><p>
				Certificate mapping rules are a convenient way of allowing users to authenticate using certificates in scenarios when the Identity Management (IdM) administrator does not have access to certain users' certificates. This lack of access is typically caused by the fact that the certificates have been issued by an external certificate authority. A special use case is represented by certificates issued by the Certificate System of an Active Directory (AD) with which the IdM domain is in a trust relationship.
			</p><p>
				Certificate mapping rules are also convenient if the IdM environment is large with a lot of users using smart cards. In this situation, adding full certificates can be complicated. The subject and issuer are predictable in most scenarios and thus easier to add ahead of time than the full certificate. As a system administrator, you can create a certificate mapping rule and add certificate mapping data to a user entry even before a certificate is issued to a particular user. Once the certificate is issued, the user will be able to log in using the certificate even though the full certificate is not uploaded into his entry.
			</p><p>
				In addition, as certificates have to be renewed at regular intervals, certificate mapping rules reduce administrative overhead. When a user’s certificate gets renewed, the administrator does not have to update the user entry. For example, if the mapping is based on the <code class="literal">Subject</code> and <code class="literal">Issuer</code> values, and if the new certificate has the same subject and issuer as the old one, the mapping still applies. If, in contrast, the full certificate was used, then the administrator would have to upload the new certificate to the user entry to replace the old one.
			</p><p>
				To set up certificate mapping:
			</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
						An administrator has to load the certificate mapping data (typically the issuer and subject) or the full certificate into a user account.
					</li><li class="listitem"><p class="simpara">
						An administrator has to create a certificate mapping rule to allow successful logging into IdM for a user
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								whose account contains a certificate mapping data entry
							</li><li class="listitem">
								whose certificate mapping data entry matches the information on the certificate
							</li></ol></div><p class="simpara">
						For details on the individual components that make up a mapping rule and how to obtain and use them, see <a class="link" href="conf-certmap-idm.html#sc-id-mapping_conf-certmap-idm">Components of an identity mapping rule in IdM</a> and <a class="link" href="conf-certmap-idm.html#sc-id-issuer-obtain-example_conf-certmap-idm">Obtaining the issuer from a certificate for use in a matching rule</a>.
					</p></li></ol></div><p>
				Afterwards, when the end-user presents his certificate, stored either in the <a class="link" href="dc-web-ui-auth.html#cert-idm-users-auth-procedure_dc-web-ui-auth">filesystem</a> or on a <a class="link" href="configuring-idm-for-smart-card-auth_cert-intro.html#logging-in-to-idm-with-smart-cards_configuring-idm-for-smart-card-auth" title="Logging in to IdM with smart cards">smart card</a>, he authenticates successfully.
			</p><p>
				<a id="con-idm-ad-certmapdata_conf-certmap-idm"/>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="certificate_mapping_rules_for_trusts_with_active_directory_domains"/>Certificate mapping rules for trusts with Active Directory domains</h2></div></div></div><p>
					This section outlines the different certificate mapping use cases that are possible if an IdM deployment is in a trust relationship with an Active Directory (AD) domain.
				</p><p>
					Certificate mapping rules are a convenient way to enable access to IdM resources for users who have smart card certificates that were issued by the trusted AD Certificate System. Depending on the AD configuration, the following scenarios are possible:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							If the certificate is issued by AD but the user and the certificate are stored in IdM, the mapping and the whole processing of the authentication request takes place on the IdM side. For details of configuring this scenario, see <a class="link" href="conf-certmap-idm.html#conf-certmap-for-users-in-idm" title="Configuring certificate mapping for users stored in IdM">Configuring certificate mapping for users stored in IdM</a>.
						</li><li class="listitem"><p class="simpara">
							If the user is stored in AD, the processing of the authentication request takes place in AD. There are three different subcases:
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									The AD user entry contains the whole certificate. For details how to configure IdM in this scenario, see <a class="link" href="conf-certmap-idm.html#conf-certmap-for-ad-certs" title="Configuring certificate mapping for users whose AD user entry contains the whole certificate">Configuring certificate mapping for users whose AD user entry contains the whole certificate</a>.
								</li><li class="listitem">
									AD is configured to map user certificates to user accounts. In this case, the AD user entry does not contain the whole certificate but instead contains an attribute called <code class="literal">altSecurityIdentities</code>. For details how to configure IdM in this scenario, see <a class="link" href="conf-certmap-idm.html#conf-certmap-for-ad-map_conf-certmap-idm">Configuring certificate mapping if AD is configured to map user certificates to user accounts</a>.
								</li><li class="listitem">
									The AD user entry contains neither the whole certificate nor the mapping data. In this case, the only solution is to use the <code class="literal">ipa idoverrideuser-add</code> command to add the whole certificate to the AD user’s ID override in IdM. For details, see <a class="link" href="conf-certmap-idm.html#conf-certmap-ad-no-cert-no-map" title="Configuring certificate mapping if AD user entry contains no certificate or mapping data">Configuring certificate mapping if AD user entry contains no certificate or mapping data</a>.
								</li></ul></div></li></ul></div><p>
					<a id="sc-id-mapping_conf-certmap-idm"/>
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="components_of_an_identity_mapping_rule_in_idm"/>Components of an identity mapping rule in IdM</h2></div></div></div><p>
					This section describes the components of an <span class="emphasis"><em>identity mapping rule</em></span> in IdM and how to configure them. Each component has a default value that you can override. You can define the components in either the web UI or the CLI. In the CLI, the identity mapping rule is created using the <code class="literal">ipa certmaprule-add</code> command.
				</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Mapping rule</span></dt><dd><p class="simpara">
								The mapping rule component associates (or <span class="emphasis"><em>maps</em></span>) a certificate with one or more user accounts. The rule defines an LDAP search filter that associates a certificate with the intended user account.
							</p><p class="simpara">
								Certificates issued by different certificate authorities (CAs) might have different properties and might be used in different domains. Therefore, IdM does not apply mapping rules unconditionally, but only to the appropriate certificates. The appropriate certificates are defined using <span class="emphasis"><em>matching rules</em></span>.
							</p><p class="simpara">
								Note that if you leave the mapping rule option empty, the certificates are searched in the <code class="literal">userCertificate</code> attribute as a DER encoded binary file.
							</p><p class="simpara">
								Define the mapping rule in the CLI using the <code class="literal">--maprule</code> option.
							</p></dd><dt><span class="term">Matching rule</span></dt><dd><p class="simpara">
								The matching rule component selects a certificate to which you want to apply the mapping rule. The default matching rule matches certificates with the <code class="literal">digitalSignature key</code> usage and <code class="literal">clientAuth extended key</code> usage.
							</p><p class="simpara">
								Define the matching rule in the CLI using the <code class="literal">--matchrule</code> option.
							</p></dd><dt><span class="term">Domain list</span></dt><dd><p class="simpara">
								The domain list specifies the identity domains in which you want IdM to search the users when processing identity mapping rules. If you leave the option unspecified, IdM searches the users only in the local domain to which the IdM client belongs.
							</p><p class="simpara">
								Define the domain in the CLI using the <code class="literal">--domain</code> option.
							</p></dd><dt><span class="term">Priority</span></dt><dd><p class="simpara">
								When multiple rules are applicable to a certificate, the rule with the highest priority takes precedence. All other rules are ignored.
							</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
										The lower the numerical value, the higher the priority of the identity mapping rule. For example, a rule with a priority 1 has higher priority than a rule with a priority 2.
									</li><li class="listitem">
										If a rule has no priority value defined, it has the lowest priority.
									</li></ul></div><p class="simpara">
								Define the mapping rule priority in the CLI using the <code class="literal">--priority</code> option.
							</p></dd></dl></div><div class="title"><strong>Certificate Mapping Rule Example 1</strong></div><p>
						To define, using the CLI, a certificate mapping rule called <code class="literal">simple_rule</code> that allows authentication for a certificate issued by the <code class="literal">Smart Card CA</code> of the <code class="literal">EXAMPLE.ORG</code> organisation as long as the <code class="literal">Subject</code> on that certificate matches a <code class="literal">certmapdata</code> entry in a user account in IdM:
					</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add simple_rule --matchrule '&lt;ISSUER&gt;CN=Smart Card CA,O=EXAMPLE.ORG' --maprule '(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})'</strong></span></pre><p>
					<a id="sc-id-issuer-obtain-example_conf-certmap-idm"/>
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="obtaining_the_issuer_from_a_certificate_for_use_in_a_matching_rule"/>Obtaining the issuer from a certificate for use in a matching rule</h2></div></div></div><p>
					This procedure describes how to obtain the issuer information from a certificate so that you can copy and paste it into the matching rule of a certificate mapping rule. To get the issuer format required by a matching rule, use the <code class="literal">openssl x509</code> utility.
				</p><h3><a id="prerequisites_17"/>Prerequisites</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							You have the user certificate in a <code class="literal">.pem</code> or <code class="literal">.crt</code> format
						</li></ul></div><h3><a id="procedure_30"/>Procedure</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Obtain the user information from the certificate. Use the <code class="literal">openssl x509</code> certificate display and signing utility with:
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									the <code class="literal">-noout</code> option to prevent the output of an encoded version of the request
								</li><li class="listitem">
									the <code class="literal">-issuer</code> option to output the issuer name
								</li><li class="listitem">
									the <code class="literal">-in</code> option to specify the input filename to read the certificate from
								</li><li class="listitem"><p class="simpara">
									the <code class="literal">-nameopt</code> option with the <code class="literal">RFC2253</code> value to display the output with the most specific relative distinguished name (RDN) first
								</p><p class="simpara">
									If the input file contains an Identity Management certificate, the output of the command shows that the Issuer is defined using the <code class="literal">Organisation</code> information:
								</p><pre class="literallayout"># <span class="strong"><strong>openssl x509 -noout -issuer -in idm_user.crt -nameopt RFC2253</strong></span>
issuer=CN=Certificate Authority,O=REALM.EXAMPLE.COM</pre><p class="simpara">
									If the input file contains an Active Directory certificate, the output of the command shows that the Issuer is defined using the <code class="literal">Domain Component</code> information:
								</p><pre class="literallayout"># <span class="strong"><strong>openssl x509 -noout -issuer -in ad_user.crt -nameopt RFC2253</strong></span>
issuer=CN=AD-WIN2012R2-CA,DC=AD,DC=EXAMPLE,DC=COM</pre></li></ul></div></li><li class="listitem"><p class="simpara">
							Optionally, to create a new mapping rule in the CLI based on a matching rule which specifies that the certificate issuer must be the extracted <code class="literal">AD-WIN2012R2-CA</code> of the <code class="literal">ad.example.com</code> domain and the subject on the certificate must match the <code class="literal">certmapdata</code> entry in a user account in IdM:
						</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add simple_rule --matchrule '&lt;ISSUER&gt;CN=AD-WIN2012R2-CA,DC=AD,DC=EXAMPLE,DC=COM' --maprule '(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})'</strong></span></pre></li></ol></div><h3><a id="additional_information"/>Additional information</h3><p>
					For details about the <code class="literal">certmap</code> command, including information about the supported formats for the matching rule and the mapping rule, and an explanation of the priority and domain fields, see the <code class="literal">sss-certmap(5)</code> man page.
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="conf-certmap-for-users-in-idm"/>Configuring certificate mapping for users stored in IdM</h1></div></div></div><p>
				This user story describes the steps a system administrator must take to enable certificate mapping in IdM if the user for whom certificate authentication is being configured is stored in IdM.
			</p><h3><a id="prerequisites_18"/>Prerequisites</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						The user has an account in IdM.
					</li><li class="listitem">
						The administrator has either the whole certificate or the certificate mapping data to add to the user entry.
					</li></ul></div><p>
				<a id="proc-add-maprule_conf-certmap-for-users-in-idm"/>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_mapping_rule_in_idm"/>Adding a certificate mapping rule in IdM</h2></div></div></div><p>
					This section describes how to set up a certificate mapping rule so that IdM users with certificates that match the conditions specified in the mapping rule and in their certificate mapping data entries can authenticate to IdM.
				</p><p>
					<a id="proc-add-maprule-webui_proc-add-maprule"/>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_web_ui"/>Adding a certificate mapping rule in the IdM web UI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Log in to the IdM web UI as an administrator.
							</li><li class="listitem">
								Navigate to <code class="literal">Authentication</code> → <code class="literal">Certificate Identity Mapping Rules</code> → <code class="literal">Certificate Identity Mapping Rules</code>.
							</li><li class="listitem"><p class="simpara">
								Click <code class="literal">Add</code>.
							</p><div class="figure"><a id="proc-add-maprule-new-certmaprule-add"/><p class="title"><strong>Figure 11.1. Adding a new certificate mapping rule in the IdM web UI</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-certmaprule-add.png" alt="new certmaprule add"/></div></div></div></li><li class="listitem">
								Enter the rule name.
							</li><li class="listitem"><p class="simpara">
								Enter the mapping rule. For example, to make IdM search for the <code class="literal">Issuer</code> and <code class="literal">Subject</code> entries in any certificate presented to them, and base its decision to authenticate or not on the information found in these two entries of the presented certificate:
							</p><pre class="literallayout"><span class="strong"><strong>(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the matching rule. For example, to only allow certificates issued by the <code class="literal">Smart Card CA</code> of the <code class="literal">EXAMPLE.ORG</code> organization to authenticate users to IdM:
							</p><pre class="literallayout"><span class="strong"><strong>&lt;ISSUER&gt;CN=Smart Card CA,O=EXAMPLE.ORG</strong></span></pre><div class="figure"><a id="proc-add-maprule-certmaprule-add-details"/><p class="title"><strong>Figure 11.2. Entering the details for a certificate mapping rule in the IdM web UI</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/certmaprule-add-details1.png" alt="certmaprule add details1"/></div></div></div></li><li class="listitem">
								Click <code class="literal">Add</code> at the bottom of the dialog box to add the rule and close the box.
							</li><li class="listitem"><p class="simpara">
								The System Security Services Daemon (SSSD) periodically re-reads the certificate mapping rules. To force the newly-created rule to be loaded immediately, restart SSSD:
							</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						Now you have a certificate mapping rule set up that compares the type of data specified in the mapping rule that it finds on a smart card certificate with the certificate mapping data in your IdM user entries. Once it finds a match, it authenticates the matching user.
					</p><p>
						<a id="proc-add-maprule-cli_proc-add-maprule"/>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_cli"/>Adding a certificate mapping rule in the IdM CLI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Obtain the administrator’s credentials:
							</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the mapping rule and the matching rule the mapping rule is based on. For example, to make IdM search for the <code class="literal">Issuer</code> and <code class="literal">Subject</code> entries in any certificate presented, and base its decision to authenticate or not on the information found in these two entries of the presented certificate, recognizing only certificates issued by the <code class="literal">Smart Card CA</code> of the <code class="literal">EXAMPLE.ORG</code> organization:
							</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add <code class="literal">rule_name</code> --matchrule '&lt;ISSUER&gt;CN=Smart Card CA,O=EXAMPLE.ORG' --maprule '(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})'</strong></span>
-------------------------------------------------------
Added Certificate Identity Mapping Rule "rule_name"
-------------------------------------------------------
  Rule name: rule_name
  Mapping rule: (ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})
  Matching rule: &lt;ISSUER&gt;CN=Smart Card CA,O=EXAMPLE.ORG
  Enabled: TRUE</pre></li><li class="listitem"><p class="simpara">
								The System Security Services Daemon (SSSD) periodically re-reads the certificate mapping rules. To force the newly-created rule to be loaded immediately, restart SSSD:
							</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						Now you have a certificate mapping rule set up that compares the type of data specified in the mapping rule that it finds on a smart card certificate with the certificate mapping data in your IdM user entries. Once it finds a match, it authenticates the matching user.
					</p><p>
						<a id="proc-add-certmapdata-to-user_conf-certmap-for-users-in-idm"/>
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_certificate_mapping_data_to_a_user_entry_in_idm"/>Adding certificate mapping data to a user entry in IdM</h2></div></div></div><p>
					This section describes how to enter certificate mapping data to an IdM user entry so that the user can authenticate using multiple certificates as long as they all contain the values specified in the certificate mapping data entry.
				</p><p>
					<a id="proc-add-certmapdata-to-user-webui_conf-certmap-for-users-in-idm"/>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_certificate_mapping_data_to_a_user_entry_in_the_idm_web_ui"/>Adding certificate mapping data to a user entry in the IdM web UI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Log into the IdM web UI as an administrator.
							</li><li class="listitem">
								Navigate to <code class="literal">Users</code> → <code class="literal">Active users</code> → <code class="literal">idm_user</code>.
							</li><li class="listitem">
								Find the <code class="literal">Certificate mapping data</code> option and click <code class="literal">Add</code>.
							</li><li class="listitem"><p class="simpara">
								If you have the certificate of <code class="literal">idm_user</code> at your disposal:
							</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
										In the Command-Line Interface, display the certificate using the <code class="literal">cat</code> utility or a text editor:
									</p><pre class="literallayout">[root@server ~]# <span class="strong"><strong>cat idm_user_certificate.pem</strong></span>
-----BEGIN CERTIFICATE-----
MIIFFTCCA/2gAwIBAgIBEjANBgkqhkiG9w0BAQsFADA6MRgwFgYDVQQKDA9JRE0u
RVhBTVBMRS5DT00xHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0x
ODA5MDIxODE1MzlaFw0yMDA5MDIxODE1MzlaMCwxGDAWBgNVBAoMD0lETS5FWEFN
[...output truncated...]</pre></li><li class="listitem">
										Copy the certificate.
									</li><li class="listitem"><p class="simpara">
										In the IdM web UI, click <code class="literal">Add</code> next to <code class="literal">Certificate</code> and paste the certificate into the window that opens up.
									</p><div class="figure"><a id="conf-certmap-for-users-in-idm-add-user-certmapdata-cert"/><p class="title"><strong>Figure 11.3. Adding a user’s certificate mapping data: certificate</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/user-add-cert.png" alt="user add cert"/></div></div></div><p class="simpara">
										Alternatively, if you do not have the certificate of <code class="literal">idm_user</code> at your disposal but know the <code class="literal">Issuer</code> and the <code class="literal">Subject</code> of the certificate, check the radio button of <code class="literal">Issuer and subject</code> and enter the values in the two respective boxes.
									</p><div class="figure"><a id="conf-certmap-for-users-in-idm-add-user-certmapdata-data"/><p class="title"><strong>Figure 11.4. Adding a user’s certificate mapping data: issuer and subject</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/user-add-certdata.png" alt="user add certdata"/></div></div></div></li></ol></div></li><li class="listitem">
								Click <code class="literal">Add</code>.
							</li><li class="listitem"><p class="simpara">
								Optionally, if you have access to the whole certificate in the <code class="literal">.pem</code> format, verify that the user and certificate are linked:
							</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
										Use the <code class="literal">sss_cache</code> utility to invalidate the record of <code class="literal">idm_user</code> in the SSSD cache and force a reload of the <code class="literal">idm_user</code> information:
									</p><pre class="literallayout"># <span class="strong"><strong>sss_cache -u idm_user</strong></span></pre></li><li class="listitem"><p class="simpara">
										Run the <code class="literal">ipa certmap-match</code> command with the name of the file containing the certificate of the IdM user:
									</p><pre class="literallayout"># <span class="strong"><strong>ipa certmap-match idm_user_cert.pem</strong></span>
--------------
1 user matched
--------------
 Domain: IDM.EXAMPLE.COM
 User logins: idm_user
----------------------------
Number of entries returned 1
----------------------------</pre><p class="simpara">
										The output confirms that now you have certificate mapping data added to <code class="literal">idm_user</code> and that a corresponding mapping rule defined in <a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">Adding a certificate mapping rule in IdM</a> exists. This means that you can use any certificate that matches the defined certificate mapping data to authenticate as <code class="literal">idm_user</code>.
									</p></li></ol></div></li></ol></div><p>
						<a id="proc-add-certmapdata-to-user-cli_conf-certmap-for-users-in-idm"/>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_certificate_mapping_data_to_a_user_entry_in_the_idm_cli"/>Adding certificate mapping data to a user entry in the IdM CLI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Obtain the administrator’s credentials:
							</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">
								If you have the certificate of <code class="literal">idm_user</code> at your disposal, add the certificate to the user account using the <code class="literal">ipa user-add-cert</code> command:
							</p><pre class="literallayout"># <span class="strong"><strong>CERT=`cat idm_user_cert.pem | tail -n +2| head -n -1 | tr -d '\r\n'\`</strong></span>
# <span class="strong"><strong>ipa user-add-certmapdata idm_user --certificate $CERT</strong></span></pre><p class="simpara">
								Alternatively, if you do not have the certificate of <code class="literal">idm_user</code> at your disposal but know the <code class="literal">Issuer</code> and the <code class="literal">Subject</code> of idm_user’s certificate:
							</p><pre class="literallayout"># <span class="strong"><strong>ipa user-add-certmapdata idm_user --subject "O=EXAMPLE.ORG,CN=test" --issuer "CN=Smart Card CA,O=EXAMPLE.ORG"</strong></span>
--------------------------------------------
Added certificate mappings to user "idm_user"
--------------------------------------------
  User login: idm_user
  Certificate mapping data: X509:&lt;I&gt;O=EXAMPLE.ORG,CN=Smart Card CA&lt;S&gt;CN=test,O=EXAMPLE.ORG</pre></li><li class="listitem"><p class="simpara">
								Optionally, if you have access to the whole certificate in the <code class="literal">.pem</code> format, verify that the user and certificate are linked:
							</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
										Use the <code class="literal">sss_cache</code> utility to invalidate the record of <code class="literal">idm_user</code> in the SSSD cache and force a reload of the <code class="literal">idm_user</code> information:
									</p><pre class="literallayout"># <span class="strong"><strong>sss_cache -u idm_user</strong></span></pre></li><li class="listitem"><p class="simpara">
										Run the <code class="literal">ipa certmap-match</code> command with the name of the file containing the certificate of the IdM user:
									</p><pre class="literallayout"># <span class="strong"><strong>ipa certmap-match idm_user_cert.pem</strong></span>
--------------
1 user matched
--------------
 Domain: IDM.EXAMPLE.COM
 User logins: idm_user
----------------------------
Number of entries returned 1
----------------------------</pre><p class="simpara">
										The output confirms that now you have certificate mapping data added to <code class="literal">idm_user</code> and that a corresponding mapping rule defined in <a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">Adding a certificate mapping rule in IdM</a> exists. This means that you can use any certificate that matches the defined certificate mapping data to authenticate as <code class="literal">idm_user</code>.
									</p></li></ol></div></li></ol></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="conf-certmap-for-ad-certs"/>Configuring certificate mapping for users whose AD user entry contains the whole certificate</h1></div></div></div><p>
				This user story describes the steps necessary for enabling certificate mapping in IdM if the IdM deployment is in trust with Active Directory (AD), the user is stored in AD and the user entry in AD contains the whole certificate.
			</p><h3><a id="prerequisites_19"/>Prerequisites</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						The user does not have an account in IdM.
					</li><li class="listitem">
						The user has an account in AD which contains a certificate.
					</li><li class="listitem">
						The IdM administrator has access to data on which the IdM certificate mapping rule can be based.
					</li></ul></div><p>
				<a id="proc-add-maprule-ad-cert_conf-certmap-for-ad-certs"/>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_mapping_rule_for_users_whose_ad_entry_contains_whole_certificates"/>Adding a certificate mapping rule for users whose AD entry contains whole certificates</h2></div></div></div><p>
					<a id="proc-add-maprule-webui-ad-cert_proc-add-maprule-ad-cert"/>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_web_ui_2"/>Adding a certificate mapping rule in the IdM web UI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Log into the IdM web UI as an administrator.
							</li><li class="listitem">
								Navigate to <code class="literal">Authentication</code> → <code class="literal">Certificate Identity Mapping Rules</code> → <code class="literal">Certificate Identity Mapping Rules</code>.
							</li><li class="listitem"><p class="simpara">
								Click <code class="literal">Add</code>.
							</p><div class="figure"><a id="proc-add-maprule-ad-cert-new-certmaprule-add-ad-cert"/><p class="title"><strong>Figure 11.5. Adding a new certificate mapping rule in the IdM web UI</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-certmaprule-add.png" alt="new certmaprule add"/></div></div></div></li><li class="listitem">
								Enter the rule name.
							</li><li class="listitem"><p class="simpara">
								Enter the mapping rule. To have the whole certificate that is presented to IdM for authentication compared to what is available in AD:
							</p><pre class="literallayout"><span class="strong"><strong>(userCertificate;binary={cert!bin})</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the matching rule. For example, to only allow certificates issued by the <code class="literal">AD-ROOT-CA</code> of the <code class="literal">AD.EXAMPLE.COM</code> domain to authenticate:
							</p><pre class="literallayout"><span class="strong"><strong>&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com</strong></span></pre><div class="figure"><a id="proc-add-maprule-ad-cert-certmaprule-add-details-ad-cert"/><p class="title"><strong>Figure 11.6. Certificate mapping rule for a user with a certificate stored in AD</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/certmaprule-add-details-ad-cert.png" alt="certmaprule add details ad cert"/></div></div></div></li><li class="listitem">
								Click <code class="literal">Add</code>.
							</li><li class="listitem"><p class="simpara">
								The System Security Services Daemon (SSSD) periodically re-reads the certificate mapping rules. To force the newly-created rule to be loaded immediately, restart SSSD in the CLI::
							</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="proc-add-maprule-cli-ad-cert_proc-add-maprule-ad-cert"/>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_cli_2"/>Adding a certificate mapping rule in the IdM CLI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Obtain the administrator’s credentials:
							</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the mapping rule and the matching rule the mapping rule is based on. To have the whole certificate that is presented for authentication compared to what is available in AD, only allowing certificates issued by the <code class="literal">AD-ROOT-CA</code> of the <code class="literal">AD.EXAMPLE.COM</code> domain to authenticate:
							</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add <code class="literal">simpleADrule</code> --matchrule '&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com' --maprule '(userCertificate;binary={cert!bin})' --domain ad.example.com</strong></span>
-------------------------------------------------------
Added Certificate Identity Mapping Rule "simpleADrule"
-------------------------------------------------------
  Rule name: simpleADrule
  Mapping rule: (userCertificate;binary={cert!bin})
  Matching rule: &lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com
  Domain name: ad.example.com
  Enabled: TRUE</pre></li><li class="listitem"><p class="simpara">
								The System Security Services Daemon (SSSD) periodically re-reads the certificate mapping rules. To force the newly-created rule to be loaded immediately, restart SSSD:
							</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="conf-certmap-for-ad-map_conf-certmap-idm"/>
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_certificate_mapping_if_ad_is_configured_to_map_user_certificates_to_user_accounts"/>Configuring certificate mapping if AD is configured to map user certificates to user accounts</h1></div></div></div><p>
				This user story describes the steps necessary for enabling certificate mapping in IdM if the IdM deployment is in trust with Active Directory (AD), the user is stored in AD and the user entry in AD contains certificate mapping data.
			</p><h3><a id="prerequisites_20"/>Prerequisites</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						The user does not have an account in IdM.
					</li><li class="listitem">
						The user has an account in AD which contains the <code class="literal">altSecurityIdentities</code> attribute, the AD equivalent of the IdM <code class="literal">certmapdata</code> atttribute.
					</li><li class="listitem">
						The IdM administrator has access to data on which the IdM certificate mapping rule can be based.
					</li></ul></div><p>
				<a id="add-ad-maprule_conf-certmap-for-ad-map"/>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_mapping_rule_if_the_trusted_ad_domain_is_configured_to_map_user_certificates"/>Adding a certificate mapping rule if the trusted AD domain is configured to map user certificates</h2></div></div></div><p>
					<a id="proc-add-ad-maprule-webui_conf-certmap-for-ad-map"/>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_web_ui_3"/>Adding a certificate mapping rule in the IdM web UI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Log into the IdM web UI as an administrator.
							</li><li class="listitem">
								Navigate to <code class="literal">Authentication</code> → <code class="literal">Certificate Identity Mapping Rules</code> → <code class="literal">Certificate Identity Mapping Rules</code>.
							</li><li class="listitem"><p class="simpara">
								Click <code class="literal">Add</code>.
							</p><div class="figure"><a id="conf-certmap-for-ad-map-new-certmaprule-add-ad-map"/><p class="title"><strong>Figure 11.7. Adding a new certificate mapping rule in the IdM web UI</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-certmaprule-add.png" alt="new certmaprule add"/></div></div></div></li><li class="listitem">
								Enter the rule name.
							</li><li class="listitem"><p class="simpara">
								Enter the mapping rule. For example, to make AD DC search for the <code class="literal">Issuer</code> and <code class="literal">Subject</code> entries in any certificate presented, and base its decision to authenticate or not on the information found in these two entries of the presented certificate:
							</p><pre class="literallayout"><span class="strong"><strong>(altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500})</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the matching rule. For example, to only allow certificates issued by the <code class="literal">AD-ROOT-CA</code> of the <code class="literal">AD.EXAMPLE.COM</code> domain to authenticate users to IdM:
							</p><pre class="literallayout"><span class="strong"><strong>&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the domain:
							</p><pre class="literallayout"><span class="strong"><strong>ad.example.com</strong></span></pre><div class="figure"><a id="conf-certmap-for-ad-map-certmaprule-add-details-ad-map"/><p class="title"><strong>Figure 11.8. Certificate mapping rule if AD is configured for mapping</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/certmaprule-add-details-ad-map.png" alt="certmaprule add details ad map"/></div></div></div></li><li class="listitem">
								Click <code class="literal">Add</code>.
							</li><li class="listitem"><p class="simpara">
								The System Security Services Daemon (SSSD) periodically re-reads the certificate mapping rules. To force the newly-created rule to be loaded immediately, restart SSSD in the CLI::
							</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="proc-add-ad-maprule-cli_conf-certmap-for-ad-map"/>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_cli_3"/>Adding a certificate mapping rule in the IdM CLI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Obtain the administrator’s credentials:
							</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the mapping rule and the matching rule the mapping rule is based on. For example, to make AD search for the <code class="literal">Issuer</code> and <code class="literal">Subject</code> entries in any certificate presented, and only allow certificates issued by the <code class="literal">AD-ROOT-CA</code> of the <code class="literal">AD.EXAMPLE.COM</code> domain:
							</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add ad_configured_for_mapping_rule --matchrule '&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com' --maprule '(altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500})' --domain=ad.example.com</strong></span>
-------------------------------------------------------
Added Certificate Identity Mapping Rule "ad_configured_for_mapping_rule"
-------------------------------------------------------
  Rule name: ad_configured_for_mapping_rule
  Mapping rule: (altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500})
  Matching rule: &lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com
  Domain name: ad.example.com
  Enabled: TRUE</pre></li><li class="listitem"><p class="simpara">
								The System Security Services Daemon (SSSD) periodically re-reads the certificate mapping rules. To force the newly-created rule to be loaded immediately, restart SSSD:
							</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="check-if-ad-maprule-exists_conf-certmap-for-ad-map"/>
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="checking_certificate_mapping_data_on_the_ad_side"/>Checking certificate mapping data on the AD side</h2></div></div></div><p>
					The <code class="literal">altSecurityIdentities</code> attribute is the Active Directory (AD) equivalent of <code class="literal">certmapdata</code> user attribute in IdM. When configuring certificate mapping in IdM in the scenario when a trusted AD domain is configured to map user certificates to user accounts, the IdM system administrator needs to check that the <code class="literal">altSecurityIdentities</code> attribute is set correctly in the user entries in AD.
				</p><p>
					To check that AD contains the right information for the user stored in AD, use the <code class="literal">ldapsearch</code> command.
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							For example, to check with the <code class="literal">adserver.ad.example.com</code> server that the <code class="literal">altSecurityIdentities</code> attribute is set in the user entry of <code class="literal">ad_user</code> and that the matchrule stipulates that the certificate that <code class="literal">ad_user</code> uses to authenticate to AD was issued by <code class="literal">AD-ROOT-CA</code> of the <code class="literal">ad.example.com</code> domain and that the subject is <code class="literal">&lt;S&gt;DC=com,DC=example,DC=ad,CN=Users,CN=ad_user</code>:
						</p><pre class="literallayout"><span class="strong"><strong>$ ldapsearch -o ldif-wrap=no -LLL -h adserver.ad.example.com</strong></span> \
<span class="strong"><strong>-p 389 -D cn=Administrator,cn=users,dc=ad,dc=example,dc=com</strong></span> \
<span class="strong"><strong>-W -b cn=users,dc=ad,dc=example,dc=com "(cn=ad_user)"</strong></span> \
<span class="strong"><strong>altSecurityIdentities</strong></span>
Enter LDAP Password:
dn: CN=ad_user,CN=Users,DC=ad,DC=example,DC=com
altSecurityIdentities: X509:&lt;I&gt;DC=com,DC=example,DC=ad,CN=AD-ROOT-CA&lt;S&gt;DC=com,DC=example,DC=ad,CN=Users,CN=ad_user</pre></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="conf-certmap-ad-no-cert-no-map"/>Configuring certificate mapping if AD user entry contains no certificate or mapping data</h1></div></div></div><p>
				This user story describes the steps necessary for enabling certificate mapping in IdM if the IdM deployment is in trust with Active Directory (AD), the user is stored in AD and the user entry in AD contains neither the whole certificate nor certificate mapping data.
			</p><h3><a id="prerequisites_21"/>Prerequisites</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						The user does not have an account in IdM.
					</li><li class="listitem">
						The user has an account in AD which contains neither the whole certificate nor the <code class="literal">altSecurityIdentities</code> attribute, the AD equivalent of the IdM <code class="literal">certmapdata</code> atttribute.
					</li><li class="listitem">
						The IdM administrator has the whole AD user certificate to add to the AD user’s <code class="literal">user ID override</code> in IdM.
					</li></ul></div><p>
				<a id="add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map"/>
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_mapping_rule_if_the_ad_user_entry_contains_no_certificate_or_mapping_data"/>Adding a certificate mapping rule if the AD user entry contains no certificate or mapping data</h2></div></div></div><p>
					<a id="proc-add-certmaprule-ad-no-cert-no-map-webui_conf-certmap-ad-no-cert-no-map"/>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_web_ui_4"/>Adding a certificate mapping rule in the IdM web UI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Log into the IdM web UI as an administrator.
							</li><li class="listitem">
								Navigate to <code class="literal">Authentication</code> → <code class="literal">Certificate Identity Mapping Rules</code> → <code class="literal">Certificate Identity Mapping Rules</code>.
							</li><li class="listitem"><p class="simpara">
								Click <code class="literal">Add</code>.
							</p><div class="figure"><a id="conf-certmap-ad-no-cert-no-map-new-certmaprule-add-ad-no-cert-no-map"/><p class="title"><strong>Figure 11.9. Adding a new certificate mapping rule in the IdM web UI</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-certmaprule-add.png" alt="new certmaprule add"/></div></div></div></li><li class="listitem">
								Enter the rule name.
							</li><li class="listitem"><p class="simpara">
								Enter the mapping rule. To have the whole certificate that is presented to IdM for authentication compared to the certificate stored in the user ID override entry of the AD user entry in IdM:
							</p><pre class="literallayout"><span class="strong"><strong>(userCertificate;binary={cert!bin})</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the matching rule. For example, to only allow certificates issued by the <code class="literal">AD-ROOT-CA</code> of the <code class="literal">AD.EXAMPLE.COM</code> domain to authenticate:
							</p><pre class="literallayout"><span class="strong"><strong>&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the domain name. For example, to search for users in the <code class="literal">ad.example.com</code> domain:
							</p><div class="figure"><a id="conf-certmap-ad-no-cert-no-map-certmaprule-add-details-ad-no-cert-no-map"/><p class="title"><strong>Figure 11.10. Certificate mapping rule for a user with no certificate or mapping data stored in AD</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/certmaprule-add-details-ad-cert.png" alt="certmaprule add details ad cert"/></div></div></div></li><li class="listitem">
								Click <code class="literal">Add</code>.
							</li><li class="listitem"><p class="simpara">
								The System Security Services Daemon (SSSD) periodically re-reads the certificate mapping rules. To force the newly-created rule to be loaded immediately, restart SSSD in the CLI:
							</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="proc-add-certmaprule-ad-no-cert-no-map-cli_conf-certmap-ad-no-cert-no-map"/>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_mapping_rule_in_the_idm_cli_4"/>Adding a certificate mapping rule in the IdM CLI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Obtain the administrator’s credentials:
							</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">
								Enter the mapping rule and the matching rule the mapping rule is based on. To have the whole certificate that is presented for authentication compared to the certificate stored in the user ID override entry of the AD user entry in IdM, only allowing certificates issued by the <code class="literal">AD-ROOT-CA</code> of the <code class="literal">AD.EXAMPLE.COM</code> domain to authenticate:
							</p><pre class="literallayout"># <span class="strong"><strong>ipa certmaprule-add <code class="literal">simpleADrule</code> --matchrule '&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com' --maprule '(userCertificate;binary={cert!bin})' --domain ad.example.com</strong></span>
-------------------------------------------------------
Added Certificate Identity Mapping Rule "simpleADrule"
-------------------------------------------------------
  Rule name: simpleADrule
  Mapping rule: (userCertificate;binary={cert!bin})
  Matching rule: &lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com
  Domain name: ad.example.com
  Enabled: TRUE</pre></li><li class="listitem"><p class="simpara">
								The System Security Services Daemon (SSSD) periodically re-reads the certificate mapping rules. To force the newly-created rule to be loaded immediately, restart SSSD:
							</p><pre class="literallayout"># <span class="strong"><strong>systemctl restart sssd</strong></span></pre></li></ol></div><p>
						<a id="add-certmapdata-no-cert-no-map_conf-certmap-ad-no-cert-no-map"/>
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_certificate_to_an_ad_user_s_id_override_if_the_user_entry_in_ad_contains_no_certificate_or_mapping_data"/>Adding a certificate to an AD user’s ID override if the user entry in AD contains no certificate or mapping data</h2></div></div></div><p>
					<a id="proc-add-certmapdata-to-ad-user-webui_conf-certmap-ad-no-cert-no-map"/>
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_to_an_ad_user_s_id_override_in_the_idm_web_ui"/>Adding a certificate to an AD user’s ID override in the IdM web UI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
								Navigate to <code class="literal">Identity</code> → <code class="literal">ID Views</code> → <code class="literal">Default Trust View</code>.
							</li><li class="listitem"><p class="simpara">
								Click <code class="literal">Add</code>.
							</p><div class="figure"><a id="conf-certmap-ad-no-cert-no-map-new-useridoverride-add"/><p class="title"><strong>Figure 11.11. Adding a new user ID override in the IdM web UI</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/new-useridoverride-add.png" alt="new useridoverride add"/></div></div></div></li><li class="listitem">
								In the <code class="literal">User to override</code> field, enter <code class="literal">ad_user@ad.example.com</code>.
							</li><li class="listitem"><p class="simpara">
								Copy and paste the certificate of <code class="literal">ad_user</code> into the <code class="literal">Certificate</code> field.
							</p><div class="figure"><a id="conf-certmap-ad-no-cert-no-map-useridoverride-add-details"/><p class="title"><strong>Figure 11.12. Configuring the User ID override for an AD user</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/useridoverride-add-details.png" alt="useridoverride add details"/></div></div></div></li><li class="listitem">
								Click <code class="literal">Add</code>.
							</li><li class="listitem"><p class="simpara">
								Optionally, verify that the user and certificate are linked:
							</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
										Use the <code class="literal">sss_cache</code> utility to invalidate the record of <code class="literal">ad_user@ad.example.com</code> in the SSSD cache and force a reload of the <code class="literal">ad_user@ad.example.com</code> information:
									</p><pre class="literallayout"># <span class="strong"><strong>sss_cache -u ad_user@ad.example.com</strong></span></pre></li><li class="listitem"><p class="simpara">
										Run the <code class="literal">ipa certmap-match</code> command with the name of the file containing the certificate of the AD user:
									</p><pre class="literallayout"># <span class="strong"><strong>ipa certmap-match ad_user_cert.pem</strong></span>
--------------
1 user matched
--------------
 Domain: AD.EXAMPLE.COM
 User logins: ad_user@ad.example.com
----------------------------
Number of entries returned 1
----------------------------</pre><p class="simpara">
										The output confirms that you have certificate mapping data added to <code class="literal">ad_user@ad.example.com</code> and that a corresponding mapping rule defined in <a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">Adding a certificate mapping rule if the AD user entry contains no certificate or mapping data</a> exists. This means that you can use any certificate that matches the defined certificate mapping data to authenticate as <code class="literal">ad_user@ad.example.com</code>.
									</p></li></ol></div></li></ol></div><p>
						<a id="proc-add-certmapdata-to-ad-user-cli_conf-certmap-ad-no-cert-no-map"/>
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding_a_certificate_to_an_ad_user_s_id_override_in_the_idm_cli"/>Adding a certificate to an AD user’s ID override in the IdM CLI</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
								Obtain the administrator’s credentials:
							</p><pre class="literallayout"># <span class="strong"><strong>kinit admin</strong></span></pre></li><li class="listitem"><p class="simpara">
								Add the certificate of <code class="literal">ad_user@ad.example.com</code> to the user account using the <code class="literal">ipa idoverrideuser-add-cert</code> command:
							</p><pre class="literallayout"># <span class="strong"><strong>CERT=`cat ad_user_cert.pem | tail -n +2| head -n -1 | tr -d '\r\n'\`</strong></span>
# <span class="strong"><strong>ipa idoverrideuser-add-cert ad_user@ad.example.com --certificate $CERT</strong></span></pre></li><li class="listitem"><p class="simpara">
								Optionally, verify that the user and certificate are linked:
							</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
										Use the <code class="literal">sss_cache</code> utility to invalidate the record of <code class="literal">ad_user@ad.example.com</code> in the SSSD cache and force a reload of the <code class="literal">ad_user@ad.example.com</code> information:
									</p><pre class="literallayout"># <span class="strong"><strong>sss_cache -u ad_user@ad.example.com</strong></span></pre></li><li class="listitem"><p class="simpara">
										Run the <code class="literal">ipa certmap-match</code> command with the name of the file containing the certificate of the AD user:
									</p><pre class="literallayout"># <span class="strong"><strong>ipa certmap-match ad_user_cert.pem</strong></span>
--------------
1 user matched
--------------
 Domain: AD.EXAMPLE.COM
 User logins: ad_user@ad.example.com
----------------------------
Number of entries returned 1
----------------------------</pre><p class="simpara">
										The output confirms that you have certificate mapping data added to <code class="literal">ad_user@ad.example.com</code> and that a corresponding mapping rule defined in <a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">Adding a certificate mapping rule if the AD user entry contains no certificate or mapping data</a> exists. This means that you can use any certificate that matches the defined certificate mapping data to authenticate as <code class="literal">ad_user@ad.example.com</code>.
									</p></li></ol></div></li></ol></div><p>
						<a id="sc-cert-mapping-rule-examples_conf-certmap-ad-no-cert-no-map"/>
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="combining_several_identity_mapping_rules_into_one"/>Combining several identity mapping rules into one</h1></div></div></div><p>
				To combine several identity mapping rules into one combined rule, use the <code class="literal">|</code> (or) character to precede the individual mapping rules, and separate them using <code class="literal">()</code> brackets, for example:
			</p><div class="title"><strong>Certificate Mapping Filter Example 1</strong></div><p>
					
</p><pre class="literallayout">$ <span class="strong"><strong>ipa certmaprule-add ad_cert_for_ipa_and_ad_users \ --maprule='(|(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})(altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500}))' \ --matchrule='&lt;ISSUER&gt;CN=AD-ROOT-CA,DC=ad,DC=example,DC=com' \ --domain=ad.example.com</strong></span></pre><p>

				</p><p>
				In the above example, the filter definition in the <code class="literal">--maprule</code> option includes these criteria:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<code class="literal">ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500}</code> is a filter that links the subject and issuer from a smart card certificate to the value of the <code class="literal">ipacertmapdata</code> attribute in an IdM user account, as described in <a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">Adding a certificate mapping rule in IdM</a>
					</li><li class="listitem">
						<code class="literal">altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500}</code> is a filter that links the subject and issuer from a smart card certificate to the value of the <code class="literal">altSecurityIdentities</code> attribute in an AD user account, as described in <a class="link" href="conf-certmap-idm.html#add-ad-maprule_conf-certmap-for-ad-map">Adding a certificate mapping rule if the trusted AD domain is configured to map user certificates</a>
					</li><li class="listitem">
						The addition of the <code class="literal">--domain=ad.example.com</code> option means that users mapped to a given certificate are not only searched in the local <code class="literal">idm.example.com</code> domain but also in the <code class="literal">ad.example.com</code> domain
					</li></ul></div><p>
				The filter definition in the <code class="literal">--maprule</code> option accepts the logical operator <code class="literal">|</code> (or), so that you can specify multiple criteria. In this case, the rule maps all user accounts that meet at least one of the criteria.
			</p><div class="title"><strong>Certificate Mapping Filter Example 2</strong></div><p>
					
</p><pre class="literallayout">$ <span class="strong"><strong>ipa certmaprule-add ipa_cert_for_ad_users</strong></span> \
  <span class="strong"><strong>--maprule='(|(userCertificate;binary={cert!bin})(ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500})(altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500}))'</strong></span> \
  <span class="strong"><strong>--matchrule='&lt;ISSUER&gt;CN=Certificate Authority,O=REALM.EXAMPLE.COM'</strong></span> \
  <span class="strong"><strong>--domain=idm.example.com --domain=ad.example.com</strong></span></pre><p>

				</p><p>
				In the above example, the filter definition in the <code class="literal">--maprule</code> option includes these criteria:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<code class="literal">userCertificate;binary={cert!bin}</code> is a filter that returns user entries that include the whole certificate. For AD users, creating this type of filter is described in detail in <a class="link" href="conf-certmap-idm.html#add-certmaprule-ad-no-cert-no-map_conf-certmap-ad-no-cert-no-map">Adding a certificate mapping rule if the AD user entry contains no certificate or mapping data</a>.
					</li><li class="listitem">
						<code class="literal">ipacertmapdata=X509:&lt;I&gt;{issuer_dn!nss_x500}&lt;S&gt;{subject_dn!nss_x500}</code> is a filter that links the subject and issuer from a smart card certificate to the value of the <code class="literal">ipacertmapdata</code> attribute in an IdM user account, as described in <a class="link" href="conf-certmap-idm.html#proc-add-maprule_conf-certmap-for-users-in-idm">Adding a certificate mapping rule in IdM</a>.
					</li><li class="listitem">
						<code class="literal">altSecurityIdentities=X509:&lt;I&gt;{issuer_dn!ad_x500}&lt;S&gt;{subject_dn!ad_x500}</code> is a filter that links the subject and issuer from a smart card certificate to the value of the <code class="literal">altSecurityIdentities</code> attribute in an AD user account, as described in <a class="link" href="conf-certmap-idm.html#add-ad-maprule_conf-certmap-for-ad-map">Adding a certificate mapping rule if the trusted AD domain is configured to map user certificates</a>.
					</li></ul></div><p>
				The filter definition in the <code class="literal">--maprule</code> option accepts the logical operator <code class="literal">|</code> (or), so that you can specify multiple criteria. In this case, the rule maps all user accounts that meet at least one of the criteria.
			</p></div></div></body></html>