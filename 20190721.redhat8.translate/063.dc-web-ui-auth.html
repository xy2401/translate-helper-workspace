<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 使用存储在IdM客户端桌面上的证书配置身份验证</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 使用存储在IdM客户端桌面上的证书配置身份验证</h1></div></div></div><p>通过配置身份管理（IdM），IdM系统管理员可以使用证书颁发机构（CA）颁发给用户的证书，使用户能够对IdM Web UI和命令行界面（CLI）进行身份验证。
		</p><p>Web浏览器可以在不属于IdM域的系统上运行。
		</p><p>此用户案例提供了有关如何使用存储在IdM客户端桌面上的证书有效配置和测试登录到Identity Management Web UI和CLI的说明。在关注此用户故事时，</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">如果要使用证书进行身份验证的用户已经拥有证书，则可以跳过<a class="xref" href="dc-web-ui-auth.html#requesting-and-exporting-a-user-certificate_dc-web-ui-auth" title="请求新用户证书并将其导出到客户端">名为“请求新用户证书并将其导出到客户端”</a>的部分;</li><li class="listitem">如果IdM CA已颁发用户证书，则可以跳过<a class="xref" href="dc-web-ui-auth.html#making-sure-cert-and-user-are-linked-idm" title="确保证书和用户链接在一起">名为“确保证书和用户链接在一起”</a>的部分。</li></ul></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>只有Identity Management用户可以使用证书登录Web UI。Active Directory用户可以使用其用户名和密码登录。
			</p></div><p>
			<a id="cert-idm-users-auth-preparing-the-server_dc-web-ui-auth"></a>
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring_the_identity_management_server_for_certificate_authentication_in_the_web_ui"></a>在Web UI中配置Identity Management Server以进行证书身份验证</h1></div></div></div><p>作为身份管理（IdM）管理员，您可以允许用户使用证书对您的IdM环境进行身份验证。
			</p><h3><a id="procedure_25"></a>程序</h3><p>作为身份管理管理员：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">在Identity Management服务器上，获取管理员权限并创建shell脚本以配置服务器。
					</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">运行<code class="literal">ipa-advise config-server-for-smart-card-auth</code>命令，并将其输出保存到文件中，例如<code class="literal">server_certificate_script.sh</code> ：</p><pre class="literallayout"># kinit admin
# ipa-advise config-server-for-smart-card-auth &gt; <code class="literal">server_certificate_script.sh</code></pre></li><li class="listitem"><p class="simpara">使用<code class="literal">chmod</code>实用程序向文件添加执行权限：</p><pre class="literallayout"># chmod +x <code class="literal">server_certificate_script.sh</code></pre></li></ol></div></li><li class="listitem"><p class="simpara">在Identity Management域中的所有服务器上，运行<code class="literal">server_certificate_script.sh</code>脚本</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">如果IdM CA是唯一颁发了要为其启用证书身份验证的用户的证书的证书颁发机构，则使用IdM证书颁发机构证书的路径<code class="literal">/etc/ipa/ca.crt</code>作为输入：</p><pre class="literallayout"># <code class="literal">./server_certificate_script.sh</code> <code class="literal">/etc/ipa/ca.crt</code></pre></li><li class="listitem"><p class="simpara">如果不同的外部CA签署了要为其启用证书身份验证的用户的证书，则将路径指向相关CA证书作为输入：</p><pre class="literallayout"># <code class="literal">./server_certificate_script.sh</code> <code class="literal">/tmp/ca1.pem</code> <code class="literal">/tmp/ca2.pem</code></pre></li></ol></div></li></ol></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>如果要对整个拓扑中启用的用户进行证书身份验证，请不要忘记在将来添加到系统的每个新副本上运行该脚本。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="requesting-and-exporting-a-user-certificate_dc-web-ui-auth"></a>请求新用户证书并将其导出到客户端</h1></div></div></div><p>作为身份管理（IdM）管理员，您可以为IdM环境中的用户创建证书，并将其导出到要为其启用证书身份验证的IdM客户端。
			</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>如果要使用证书进行身份验证的用户已拥有证书，则可以跳过此部分。
				</p></div><h3><a id="procedure_26"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">（可选）创建一个新目录，例如<code class="literal">~/certdb/</code> ，并使其成为临时证书数据库。询问时，创建NSS证书数据库密码以加密要在后续步骤中生成的证书的密钥：</p><pre class="literallayout"># mkdir <code class="literal">~/certdb/</code>
# certutil -N -d <code class="literal">~/certdb/</code>
Enter a password which will be used to encrypt your keys.
The password should be at least 8 characters long,
and should contain at least one non-alphabetic character.

Enter new password:
Re-enter password:</pre></li><li class="listitem"><p class="simpara">创建证书签名请求（CSR）并将输出重定向到文件。例如，要创建名为CSR的<code class="literal">certificate_request.csr</code>为<code class="literal">4096</code>的位证书<code class="literal">idm_user</code>在用户<code class="literal">IDM.EXAMPLE.COM</code>境界，设置证书私钥的昵称<code class="literal">idm_user</code> ，方便可检索性，并设置符合<code class="literal">CN=idm_user,O=IDM.EXAMPLE.COM</code> ：</p><pre class="literallayout"># certutil -R -d <code class="literal">~/certdb/</code> -a -g <code class="literal">4096</code> -n <code class="literal">idm_user</code> -s "CN=<code class="literal">idm_user</code>,O=IDM.EXAMPLE.COM" &gt; <code class="literal">certificate_request.csr</code></pre></li><li class="listitem"><p class="simpara">出现提示时，输入使用<code class="literal">certutil</code>创建临时数据库时输入的相同密码。然后继续输入randlomly直到告诉停止：</p><pre class="literallayout">Enter Password or Pin for "NSS Certificate DB":

A random seed must be generated that will be used in the
creation of your key.  One of the easiest ways to create a
random seed is to use the timing of keystrokes on a keyboard.

To begin, type keys on the keyboard until this progress meter
is full.  DO NOT USE THE AUTOREPEAT FUNCTION ON YOUR KEYBOARD!


Continue typing until the progress meter is full:</pre></li><li class="listitem"><p class="simpara">将证书请求文件提交给服务器。指定要与新颁发的证书关联的Kerberos主体，用于存储证书的输出文件以及可选的证书配置文件。例如，要获取<code class="literal">IECUserRoles</code>配置文件的证书，为<code class="literal">idm_user</code> @ <code class="literal">IDM.EXAMPLE.COM</code>主体添加用户角色扩展的配置文件，并将其保存在<code class="literal">~/idm_user.pem</code>文件中：</p><pre class="literallayout"># ipa cert-request <code class="literal">certificate_request.csr</code> --principal=<code class="literal">idm_user</code>@<code class="literal">IDM.EXAMPLE.COM</code> --profile-id=<code class="literal">IECUserRoles</code> --certificate-out=<code class="literal">~/idm_user.pem</code></pre></li><li class="listitem"><p class="simpara">将证书添加到NSS数据库。使用<code class="literal">-n</code>选项设置先前创建CSR时使用的昵称，以使证书与NSS数据库中的私钥匹配。<code class="literal">-t</code>选项设置信任级别。有关详细信息，请参见certutil（1）手册页。<code class="literal">-i</code>选项指定输入证书文件。例如，要将具有<code class="literal">idm_user</code>昵称的证书添加到NSS数据库，该昵称存储在<code class="literal">~/certdb/</code> database中的<code class="literal">~/idm_user.pem</code>文件中：</p><pre class="literallayout"># certutil -A -d <code class="literal">~/certdb/</code> -n <code class="literal">idm_user</code> -t "P,," -i <code class="literal">~/idm_user.pem</code></pre></li><li class="listitem"><p class="simpara">验证NSS数据库中的密钥是否未显示<code class="literal">(orphan)</code>作为其昵称。例如，要验证存储在<code class="literal">~/certdb/</code> database中的证书是不是孤立的：</p><pre class="literallayout"># certutil -K -d <code class="literal">~/certdb/</code>
&lt; 0&gt; rsa      5ad14d41463b87a095b1896cf0068ccc467df395   <span class="strong"><strong>NSS Certificate DB:[replaceable]<code class="literal">idm_user</code></strong></span></pre></li><li class="listitem"><p class="simpara">使用<code class="literal">pk12util</code>命令将证书从NSS数据库导出为PKCS12格式。例如，要将<code class="literal">/root/certdb</code> NSS数据库中带有<code class="literal">idm_user</code>昵称的证书导出到<code class="literal">~/idm_user.p12</code>文件中：</p><pre class="literallayout"># pk12util -d <code class="literal">~/certdb</code> -o <code class="literal">~/idm_user.p12</code> -n <code class="literal">idm_user</code>
Enter Password or Pin for "NSS Certificate DB":
Enter password for PKCS12 file:
Re-enter password:
pk12util: PKCS12 EXPORT SUCCESSFUL</pre></li><li class="listitem"><p class="simpara">将证书传输到要为其启用<code class="literal">idm_user</code>证书身份验证的主机：</p><pre class="literallayout"># scp <code class="literal">~/idm_user.p12</code> <code class="literal">idm_user@client.idm.example.com:/home/idm_user/</code></pre></li><li class="listitem"><p class="simpara">在已转移证书的主机上，出于安全原因，使“其他”组无法访问存储.pkcs12文件的目录：</p><pre class="literallayout"># chmod o-rwx <code class="literal">/home/idm_user/</code></pre></li><li class="listitem"><p class="simpara">出于安全原因，从服务器中删除临时NSS数据库和.pkcs12文件：</p><pre class="literallayout"># rm <code class="literal">~/certdb/</code>
# rm <code class="literal">~/idm_user.p12</code></pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="making-sure-cert-and-user-are-linked-idm"></a>确保证书和用户链接在一起</h1></div></div></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>如果IdM CA已颁发用户证书，则可以跳过此部分。</p></div><p>要使证书身份验证起作用，您需要确保证书已链接到将用于向身份管理（IdM）进行身份验证的用户。
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">如果证书由不属于Identity Management环境的证书颁发机构提供，请按照<a class="link" href="conf-certmap-idm.html#adding_certificate_mapping_data_to_a_user_entry_in_idm" title="Adding certificate mapping data to a user entry in IdM">将用户帐户链接到证书中</a>所述的过程<a class="link" href="conf-certmap-idm.html#adding_certificate_mapping_data_to_a_user_entry_in_idm" title="将证书映射数据添加到IdM中的用户条目">链接用户和证书</a> 。
					</li><li class="listitem">如果证书由Identity Management CA提供，则证书已自动添加到用户条目中，您无需将证书链接到用户帐户。有关在IdM中创建新证书的详细信息，请参阅<a class="xref" href="dc-web-ui-auth.html#requesting-and-exporting-a-user-certificate_dc-web-ui-auth" title="请求新用户证书并将其导出到客户端">“请求新用户证书并将其导出到客户端”一节</a> 。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-browser-for-cert-auth_dc-web-ui-auth"></a>配置浏览器以启用证书身份验证</h1></div></div></div><p>要使证书身份验证在Identity Management Web UI中正常工作，您需要将用户和证书颁发机构（CA）证书导入到要在其上启用证书身份验证的主机上运行的Mozilla Firefox或Google Chrome浏览器中。主机本身不必是IdM域的一部分。
			</p><p>Identity Management支持以下浏览器连接到Web UI：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Mozilla Firefox 38及更高版本</li><li class="listitem">谷歌Chrome 46及更高版本</li></ul></div><p>以下过程说明如何配置Mozilla Firefox 57.0.1浏览器。
			</p><h3><a id="procedure_27"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">打开Firefox，然后导航到<code class="literal">Preferences</code> → <code class="literal">Privacy &amp; Security</code> 。
					</p><p class="simpara">
						<a id="fig.privacy-security_dc-web-ui-auth"></a> 。首选项中的隐私和安全部分</p><div class="informalfigure"><div class="mediaobject"><img src="images/privacy_and_security.png" alt="隐私和安全"></div></div></li><li class="listitem"><p class="simpara">单击“ <span class="guibutton">查看证书”</span> 。
					</p><p class="simpara">
						<a id="fig.view-certificates_dc-web-ui-auth"></a> 。查看隐私和安全中的证书</p><div class="informalfigure"><div class="mediaobject"><img src="images/view_certificates.png" alt="查看证书"></div></div></li><li class="listitem">在“ <code class="literal">Your Certificates</code>选项卡中，单击“ <span class="guibutton">导入”</span> 。找到并打开PKCS12格式的用户证书，然后单击“ <span class="guibutton">确定”</span>和“ <span class="guibutton">确定”</span> 。</li><li class="listitem"><p class="simpara">确保Firefox将身份管理证书颁发机构识别为受信任的颁发机构：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">在本地保存IdM CA证书：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">通过在Firefox地址栏中写入IdM服务器的名称，导航到IdM Web UI。单击“不安全连接”警告页面上的“ <code class="literal">Advanced</code> ”。
									</p><p class="simpara">
										<a id="fig.connection-not-secure-idm_dc-web-ui-auth"></a> 。不安全的连接</p><div class="informalfigure"><div class="mediaobject"><img src="images/connection-not-secure-idm.png" alt="连接不安全idm"></div></div></li><li class="listitem"><p class="simpara">
										<code class="literal">Add Exception</code> 。单击<code class="literal">View</code> 。
									</p><p class="simpara">
										<a id="fig.view-ca-certificate-idm_dc-web-ui-auth"></a> 。查看证书的详细信息</p><div class="informalfigure"><div class="mediaobject"><img src="images/view-ca-certificate-idm.png" alt="查看ca证书idm"></div></div></li><li class="listitem"><p class="simpara">在<code class="literal">Details</code>选项卡中，突出显示<code class="literal">Certificate Authority</code>字段。
									</p><p class="simpara">
										<a id="fig.exporting-ca-cert-idm_dc-web-ui-auth"></a> 。导出CA证书</p><div class="informalfigure"><div class="mediaobject"><img src="images/exporting-ca-cert-idm.png" alt="导出ca cert idm"></div></div></li><li class="listitem">单击<span class="guibutton">导出</span> 。保存CA证书，例如保存为<code class="literal">CertificateAuthority.crt</code>文件，然后单击“ <span class="guibutton">关闭</span> ”和“ <span class="guibutton">取消”</span> 。
									</li></ul></div></li><li class="listitem"><p class="simpara">将IdM CA证书作为受信任的证书颁发机构证书导入Firefox：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">打开Firefox，导航到“首选项”并单击“ <span class="guibutton">隐私和安全”</span> 。
									</p><p class="simpara">
										<a id="fig.privacy-security-2_dc-web-ui-auth"></a> 。首选项中的隐私和安全部分</p><div class="informalfigure"><div class="mediaobject"><img src="images/privacy_and_security.png" alt="隐私和安全"></div></div></li><li class="listitem"><p class="simpara">单击“ <span class="guibutton">查看证书”</span> 。
									</p><p class="simpara">
										<a id="fig.view-certificates-2_dc-web-ui-auth"></a> 。查看隐私和安全中的证书</p><div class="informalfigure"><div class="mediaobject"><img src="images/view_certificates.png" alt="查看证书"></div></div></li><li class="listitem">在“ <code class="literal">Authorities</code>选项卡中，单击“ <span class="guibutton">导入”</span> 。找到并打开您在<code class="literal">CertificateAuthority.crt</code>文件中的上一步中保存的CA证书。信任证书以识别网站，然后单击“ <span class="guibutton">确定”</span>和“ <span class="guibutton">确定”</span> 。</li></ul></div></li></ol></div></li><li class="listitem">继续<a class="link" href="dc-web-ui-auth.html#cert-idm-users-auth-procedure_dc-web-ui-auth">使用证书作为身份管理用户对身份管理Web UI</a>进行<a class="link" href="dc-web-ui-auth.html#cert-idm-users-auth-procedure_dc-web-ui-auth">身份验证</a> 。
					</li></ol></div><p>
				<a id="cert-idm-users-auth-procedure_dc-web-ui-auth"></a>
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="authenticating_to_the_identity_management_web_ui_with_a_certificate_as_an_identity_management_user"></a>使用证书作为身份管理用户身份验证身份管理Web UI</h1></div></div></div><p>此过程描述使用存储在Identity Management客户端桌面上的证书作为Identity Management（IdM）Web UI的用户进行身份验证。
			</p><h3><a id="procedure_28"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem">在浏览器中，导航到Identity Management Web UI，例如<code class="literal">https:</code> // <code class="literal">server.idm.example.com/ipa/ui</code> 。</li><li class="listitem"><p class="simpara">单击<span class="guibutton">使用证书登录</span> 。
					</p><p class="simpara">
						<a id="fig.cert-login_dc-web-ui-auth"></a> 。在Identity Management Web UI中<span class="guibutton">使用证书登录</span></p><div class="informalfigure"><div class="mediaobject"><img src="images/smart_card_login.png" alt="智能卡登录"></div></div></li><li class="listitem">应该已经选择了用户的证书。取消选中“ <span class="guibutton">记住此决定”</span> ，然后单击“ <span class="guibutton">确定”</span> 。</li></ol></div><p>您现在被认证为与证书对应的用户。
			</p><h3><a id="additional_resources_5"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">有关使用存储在智能卡上的证书对IdM Web UI进行身份验证的信息，请参阅<a class="xref" href="configuring-idm-for-smart-card-auth_cert-intro.html" title="Chapter 9. 配置身份管理以进行智能卡身份验证">第9章， <em>配置身份管理以进行智能卡身份验证</em></a> 。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="authenticating-idm-cli-user-certificate_dc-web-ui-auth"></a>配置IdM客户端以使用证书启用CLI身份验证</h1></div></div></div><p>要在IdM客户端的命令行界面（CLI）中为IdM用户进行证书身份验证，请将IdM用户的证书和私钥导入IdM客户端。有关创建和传输用户证书的详细信息，请参阅<a class="xref" href="dc-web-ui-auth.html#requesting-and-exporting-a-user-certificate_dc-web-ui-auth" title="请求新用户证书并将其导出到客户端">“请求新用户证书并将其导出到客户端”一节</a> 。
			</p><h3><a id="procedure_29"></a>程序</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">登录到IdM客户端，并准备好包含用户证书和私钥的.p12文件。要获取并缓存Kerberos票证授予票证（TGT），请使用带有<code class="literal">X509_username:/path/to/file.p12</code>属性的<code class="literal">-X</code>选项运行带有用户主体的<code class="literal">kinit</code>命令，以指定在何处查找用户的X509身份信息。例如，要使用存储在<code class="literal">~/idm_user.p12</code>文件中的用户身份信息获取<code class="literal">idm_user</code>的TGT：</p><pre class="literallayout">$ <span class="strong"><strong>kinit -X X509_idm_user='PKCS12:~/idm_user.p12' idm_user</strong></span></pre><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>该命令还支持.pem文件格式： <span class="strong"><strong>kinit -X X509_username ='FILE：/path/to/cert.pem,/path/to/key'user_principal</strong></span>
						</p></div></li></ul></div></div></div></body></html>