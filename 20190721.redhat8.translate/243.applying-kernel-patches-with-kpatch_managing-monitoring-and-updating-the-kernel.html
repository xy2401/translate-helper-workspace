<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 使用kpatch应用内核补丁</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 使用kpatch应用内核补丁</h1></div></div></div><p><code class="literal">kpatch</code>实时内核修补解决方案允许您修补正在运行的内核，而无需重新启动或重新启动任何进程。 <code class="literal">kpatch</code>使系统管理员能够立即将关键安全补丁应用到内核，而无需等待长时间运行的任务完成，用户注销或计划停机。它可以在不牺牲安全性或稳定性的情况下更好地控制正常运行时间。
		</p><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p><code class="literal">kpatch</code>和其他内核子组件之间存在一些不兼容性。在使用<code class="literal">kpatch</code>之前<a class="xref" href="applying-kernel-patches-with-kpatch_managing-monitoring-and-updating-the-kernel.html#limitations-of-kpatch_applying-kernel-patches-without-restarting-the-system" title="Limitations of kpatch">，请</a>仔细阅读<a class="xref" href="applying-kernel-patches-with-kpatch_managing-monitoring-and-updating-the-kernel.html#limitations-of-kpatch_applying-kernel-patches-without-restarting-the-system" title="kpatch的局限性">“限制kpatch”一</a> <code class="literal">kpatch</code> 。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="access-to-kernel-patches_applying-kernel-patches-without-restarting-the-system"></a>访问内核补丁</h1></div></div></div><p>实时内核修补功能实现为作为RPM包提供的内核模块（ <code class="literal">kmod</code> ）。<code class="literal">kpatch</code>实用程序用于安装和删除内核模块以进行实时内核修补。
			</p><p>拥有高级订阅的客户有资格申请实时内核补丁，作为红帽支持加速修复解决方案的一部分。
			</p><p>通常使用需要重新启动的“修补程序”内核的合格客户现在可以请求不需要停机时间的kpatch补丁。在包含已发布修复程序的勘误表后30天，将支持kpatch修补程序。
			</p><p>需要加速修复选项的客户应该打开支持案例<a class="link" href="https://access.redhat.com/support/cases/#/case/new">红帽客户门户</a>并讨论适当的加速修复选项。要获得最快的支持，请包括CVE id或Bug编号以及要修补的精确内核版本。使用<code class="literal">uname -r</code>命令获取内核版本。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="components-of-kpatch_applying-kernel-patches-without-restarting-the-system"></a> kpatch的组成部分</h1></div></div></div><p><code class="literal">kpatch</code>的组件如下：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">kpatch.service</span></dt><dd><code class="literal">multiuser.target</code>所需的<code class="literal">systemd</code>服务，它在引导时加载<code class="literal">kpatch</code>模块。
						</dd><dt><span class="term">补丁模块</span></dt><dd><p class="simpara">

						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">新内核代码的交付机制。
								</li><li class="listitem">这是另一个与正在应用的补丁相匹配的内核模块。
								</li><li class="listitem">补丁模块包含内核所需修补程序的代码。
								</li><li class="listitem">补丁模块向<code class="literal">livepatch</code>内核子系统注册，并提供有关要替换的原始函数的信息，以及指向替换函数的相应指针。
								</li></ul></div></dd><dt><span class="term"><code class="literal">kpatch</code>实用程序</span></dt><dd>一个命令行工具，允许您管理补丁模块。
						</dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="how-kpatch-works_applying-kernel-patches-without-restarting-the-system"></a> kpatch如何工作</h1></div></div></div><p><code class="literal">kpatch</code>内核修补解决方案使用<code class="literal">livepatch</code>内核子系统将旧函数重定向到新函数。将实时内核修补程序应用于系统时，会发生以下情况：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">模块中新编译的代码被复制到<code class="literal">/var/lib/kpatch/</code>目录并注册，以便在下次启动时通过<code class="literal">systemd</code>重新应用到内核。
					</li><li class="listitem">kpatch模块被加载到正在运行的内核中，新函数被注册到<code class="literal">ftrace</code>机制，其指针指向新代码的内存中的位置。
					</li><li class="listitem">当内核访问修补函数时，它会被<code class="literal">ftrace</code>机制重定向，该机制绕过原始函数并将内核重定向到函数的修补版本。
					</li></ol></div><div class="figure"><a id="applying-kernel-patches-without-restarting-the-system-figu-how-kpatch-works"></a><p class="title"><strong>图6.1。kpatch如何工作</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/rhel_kpatch_overview.png" alt="rhel kpatch概述"></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="installing-kpatch-modules_applying-kernel-patches-without-restarting-the-system"></a>安装kpatch模块</h1></div></div></div><p>此过程描述如何通过<code class="literal">kpatch</code>实用程序安装kpatch模块。
			</p><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p>Red Hat强烈反对使用任何kpatch模块，这些模块并非由Red Hat本身的特定用途提供。
				</p></div><h3><a id="prerequisites_18"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">已安装的<code class="literal">kpatch</code>实用程序。要安装<code class="literal">kpatch</code> ，请运行以下命令：</p><pre class="screen"># yum install kpatch</pre></li><li class="listitem"><p class="simpara">带有<code class="literal">kpatch</code>模块的RPM包。
					</p><p class="simpara">要获取kpatch模块，请打开支持案例。在支持案例中表明您需要一个kpatch补丁。还要通知命令返回的内核版本：</p><pre class="screen">$ uname -r</pre><p class="simpara">您还可以指出应由<code class="literal">kpatch</code>更正的Bugzilla问题。
					</p><p class="simpara">有关如何创建支持案例的更多信息，请参阅<a class="link" href="https://access.redhat.com/articles/38363">如何在客户门户上打开和管理支持案例？</a>
					</p></li></ul></div><h3><a id="procedure_21"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">列出已安装的kpatch模块以查看是否已安装该修补程序：</p><pre class="screen"># kpatch list
Loaded patch modules:
kpatch_4_18_0_100_1_1
Installed patch modules:
kpatch_4_18_0_100_1_1 (4.18.0-100.el8.x86_64)
kpatch_4_18_0_200_1_1 (4.18.0-200.el8.x86_64)</pre><p class="simpara">输出显示模块已加载到内核中，这意味着内核现在使用<code class="literal">kpatch-patch- 4_18_0_100-1-1.el8.x86_64.rpm</code>包中的最新修补程序进行修补。它还显示它已保存到<code class="literal">/var/lib/kpatch/</code>目录，以便在将来重新启动到内核版本4.18.0-100和4.18.0-200期间由<code class="literal">systemd</code>加载。
					</p></li><li class="listitem"><p class="simpara">安装kpatch模块：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">如果未安装kpatch模块，请使用<code class="literal">yum</code>安装RPM软件包。例如，要安装<code class="literal">kpatch-patch-4.18.0-100.el8.x86_64.rpm</code> ，请发出以下命令：</p><pre class="screen"># yum install kpatch-patch-4_18_0_100-1-1.el8.x86_64.rpm</pre><p class="simpara">上面的示例命令安装并加载kpatch模块。
							</p></li><li class="listitem"><p class="simpara">如果安装了旧版本的kpatch模块，请使用<code class="literal">yum</code>更新。例如，升级到<code class="literal">kpatch-patch-4_18_0_100-1-2.el8.x86_64.rpm</code>运行：</p><pre class="screen"># yum update kpatch-patch-4_18_0_100-1-2.el8.x86_64.rpm</pre><p class="simpara">升级RPM包会自动替换正在运行的内核中的相关内核模块并更新<code class="literal">/var/lib/kpatch/</code>结构。
							</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>RPM包中的kpatch模块是累积的。因此，您可以跳过安装kpatch-patch-4_18_0_100-1-1，而是安装kpatch-patch-4_18_0_100-1-2（如果可用）。
								</p></div></li></ul></div></li><li class="listitem"><p class="simpara">加载kpatch模块：</p><pre class="screen"># kpatch load kpatch_4_18_0_200_1_1</pre><p class="simpara">上面的示例命令显示了如何加载已安装的kpatch模块。
					</p></li><li class="listitem"><p class="simpara">通过运行以下命令验证是否已加载kpatch模块：</p><pre class="screen"># kpatch list</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="removing-kpatch-modules_applying-kernel-patches-without-restarting-the-system"></a>删除kpatch模块</h1></div></div></div><p>此过程描述如何通过<code class="literal">kpatch</code>实用程序删除已安装的kpatch模块。
			</p><h3><a id="procedure_22"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">列出已安装的kpatch模块：</p><pre class="screen"># kpatch list
Loaded patch modules:
kpatch_4_18_0_100_1_1
Installed patch modules:
kpatch_4_18_0_100_1_1 (4.18.0-100.el8.x86_64)
kpatch_4_18_0_200_1_1 (4.18.0-200.el8.x86_64)</pre><p class="simpara">上面的示例输出显示已安装<code class="literal">kpatch_4_18_0_100_1_1</code>和<code class="literal">kpatch_4_18_0_200_1_1</code> kpatch模块。
					</p></li><li class="listitem"><p class="simpara">卸载相关的kpatch模块：</p><pre class="screen"># kpatch unload kpatch-4_18_0_100-1-2</pre></li><li class="listitem"><p class="simpara">卸载kpatch模块：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">使用kpatch：</p><pre class="screen"># kpatch uninstall kpatch-4_18_0_100-1-2</pre><p class="simpara">上面的命令从<code class="literal">/var/lib/kpatch/</code>目录中卸载kpatch模块。
							</p><p class="simpara">此命令的默认行为是从与当前内核版本对应的内核中卸载<code class="literal">kpatch</code> 。但是，您可以通过<code class="literal">kernel-version</code>选项指定不同的内核版本：</p><pre class="screen"># kpatch uninstall --kernel-version 4.18.0-200.el8.x86_64 kpatch-4_18_0_200-1-1</pre></li><li class="listitem"><p class="simpara">使用yum：</p><pre class="screen"># yum erase kpatch-patch-4_18_0_100-1-1.el8.x86_64</pre><p class="simpara">上面的命令卸载了kpatch RPM软件包，并从<code class="literal">/var/lib/kpatch/</code>删除了补丁模块。
							</p></li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="kpatch-support_applying-kernel-patches-without-restarting-the-system"></a> kpatch支持</h1></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">拥有Premium SLA订阅的客户支持实时内核。
					</li><li class="listitem">仅在当前异步勘误阶段内的活动Red Hat Enterprise Linux 8维护流上支持实时内核修补。有关当前支持阶段的信息，请参阅<a class="link" href="https://access.redhat.com/support/policy/updates/errata/#Overview">Red Hat Enterprise Linux生命周期</a> 。
					</li><li class="listitem">目前，扩展更新支持（EUS）上不提供实时内核修补。
					</li><li class="listitem">Red Hat Enterprise Linux实时（RT）内核不支持实时内核修补。
					</li><li class="listitem">Red Hat支持每个内核版本包含一个内核模块的RPM。例如，如果客户为一个内核版本请求多个补丁，则补丁将合并为一个RPM。</li><li class="listitem">并非所有问题都包含在实时内核修补中，包括硬件启用。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="support-for-third-party-live-patching_applying-kernel-patches-without-restarting-the-system"></a>支持第三方实时修补</h1></div></div></div><p>
				<code class="literal">kpatch</code>是Red Hat支持的唯一实时内核修补实用程序，它通过您的Red Hat支持合同提供RPM模块。Red Hat不支持Red Hat本身未提供的任何实时内核补丁。
			</p><p>如果您需要支持第三方实时补丁引起的问题，Red Hat建议您在任何需要确定根本原因的调查开始时使用实时内核修补供应商打开案例。这允许在供应商允许的情况下提供源代码，并允许其支持组织在将调查升级到Red Hat支持之前提供根本原因确定方面的帮助。
			</p><p>对于使用第三方实时内核补丁运行的任何系统，Red Hat保留要求使用Red Hat附带的软件进行复制的权利。如果无法做到这一点，我们需要在您的测试环境中部署类似的系统和工作负载，而不应用实时补丁，以确认是否观察到相同的行为。
			</p><p>有关第三方软件支持策略的详细信息，请参阅<a class="link" href="https://access.redhat.com/articles/1067">Red Hat全球支持服务如何处理第三方软件，驱动程序和/或未经认证的硬件/虚拟机监控程序或客户机操作系统？</a>
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="limitations-of-kpatch_applying-kernel-patches-without-restarting-the-system"></a> kpatch的局限性</h1></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<code class="literal">kpatch</code>不是通用的内核升级机制。它用于在无法立即重新启动系统时应用简单的安全性和错误修复更新。
					</li><li class="listitem">在加载补丁期间或之后，请勿使用<code class="literal">SystemTap</code>或<code class="literal">kprobe</code>工具。在移除此类探针之后，补丁可能无法生效。
					</li><li class="listitem">使用<code class="literal">kpatch</code>时，请勿暂停或休眠系统。这可能导致临时禁用补丁。
					</li></ul></div></div></div></body></html>