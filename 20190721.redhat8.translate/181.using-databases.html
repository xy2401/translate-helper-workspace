<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. Red Hat Enterprise Linux 8上的数据库服务器</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. Red Hat Enterprise Linux 8上的数据库服务器</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="introduction-to-databases_using-databases"></a>数据库和数据库服务器简介</h1></div></div></div><p>数据库是有组织的数据集合。数据库中的数据被存储并可以电子方式访问。
			</p><p>数据库中的数据组织通常旨在支持：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">现实的各个方面的建模</li><li class="listitem">根据属性查询和过滤数据</li></ul></div><p>Red Hat Enterprise Linux 8提供以下数据库服务器：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">MariaDB 10.3</li><li class="listitem">MySQL 8.0</li><li class="listitem">PostgeSQL 10</li><li class="listitem">PostgreSQL 9.6</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using-mariadb"></a>在Red Hat Enterprise Linux 8上使用MariaDB</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="introduction-to-mariadb_using-mariadb"></a>在Red Hat Enterprise Linux 8上开始使用MariaDB</h2></div></div></div><p><span class="strong"><strong>MariaDB</strong></span>服务器是一个基于MySQL技术的开源快速且强大的数据库服务器。
				</p><p>
					<span class="strong"><strong>MariaDB</strong></span>是一个关系数据库，它将数据转换为结构化信息，并提供用于访问数据的SQL接口。它包括多个存储引擎和插件，以及地理信息系统（GIS）和JavaScript Object Notation（JSON）功能。
				</p><p>本节介绍如何在安装<span class="strong"><strong>MariaDB</strong></span>中<a class="link" href="using-databases.html#installing-mariadb_using-mariadb" title="安装MariaDB">安装</a> <span class="strong"><strong>MariaDB</strong></span>服务器，或者如何从Red Hat Enterprise Linux 7默认版本<span class="strong"><strong>MariaDB 5.5</strong></span> <a class="link" href="using-databases.html#migrating-to-mariadb_10_3_using-mariadb" title="Migrating to MariaDB 10.3">迁移到</a> Red Hat Enterprise Linux 8默认版本<span class="strong"><strong>MariaDB 10.3</strong></span> ， <a class="link" href="using-databases.html#migrating-to-mariadb_10_3_using-mariadb" title="迁移到MariaDB 10.3">迁移到MariaDB 10.3</a> 。迁移的先决条件之一是执行数据备份， <a class="link" href="using-databases.html#backuping-mariadb_using-mariadb" title="备份MariaDB数据">备份MariaDB数据中</a>对此进行了描述。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="installing-mariadb_using-mariadb"></a>安装MariaDB</h2></div></div></div><p>要安装<span class="strong"><strong>MariaDB</strong></span> ，请执行以下过程：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">确保AppStream存储库中提供的<code class="literal">mariadb</code>和<code class="literal">mariadb-server</code>软件包安装在所需的服务器上：</p><pre class="literallayout">~]# yum install mariadb mariadb-server</pre></li><li class="listitem"><p class="simpara">启动<code class="literal">mariadb</code>服务：</p><pre class="literallayout">~]# systemctl start mariadb.service</pre></li><li class="listitem"><p class="simpara">启用<code class="literal">mariadb</code>服务以在启动时启动：</p><pre class="literallayout">~]# systemctl enable mariadb.service</pre></li></ol></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>请注意，由于RPM软件包冲突，因此无法在Red Hat Enterprise Linux 8.0中并行安装<span class="strong"><strong>MariaDB</strong></span>和<span class="strong"><strong>MySQL</strong></span>数据库服务器。Red Hat Software Collection for Red Hat Enterprise Linux 6和Red Hat Enterprise Linux 7可以并行安装组件。在Red Hat Enterprise Linux 8中，可以在容器中使用不同版本的数据库服务器。
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sect-mariadb-secure-configurations"></a>改善MariaDB安装安全性</h3></div></div></div><p>通过运行<code class="literal">mysql_secure_installation</code>命令，可以在安装<span class="strong"><strong>MariaDB</strong></span>时提高安全性：</p><pre class="literallayout">~]# mysql_secure_installation</pre><p>此命令启动完全交互式脚本，该脚本会提示进程中的每个步骤。
					</p><p>该脚本可以通过以下方式提高安全性：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">设置root帐户的密码</li><li class="listitem">删除匿名用户</li><li class="listitem">禁止远程（本地主机外）root登录</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring-mariadb_using-mariadb"></a>配置MariaDB</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="configuring_the_mariadb_server_for_networking"></a>配置MariaDB服务器以进行联网</h3></div></div></div><p>要配置<span class="strong"><strong>MariaDB</strong></span>服务器以进行网络连接，请使用<code class="literal">/etc/my.cnf.d/mariadb-server.cnf</code>文件的<code class="literal">[mysqld]</code>部分，您可以在其中设置以下配置指令：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
								<code class="literal">绑定地址</code>
							</p><p class="simpara">绑定地址是服务器将侦听的地址。
							</p><p class="simpara">可能的选项包括：主机名，IPv4地址或IPv6地址。
							</p></li><li class="listitem"><p class="simpara">
								<code class="literal">skip-networking</code> + fna可能的值是：</p><p class="simpara">0  - 倾听所有客户</p><p class="simpara">1  - 仅收听本地客户</p></li><li class="listitem"><p class="simpara">
								<code class="literal">港口</code>
							</p><p class="simpara"><span class="strong"><strong>MariaDB</strong></span>侦听TCP / IP连接的端口。
							</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="backuping-mariadb_using-mariadb"></a>备份MariaDB数据</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="backup-types_using-mariadb"></a> MariaDB备份的类型</h3></div></div></div><p>从MariaDB数据库备份数据有两种主要方法：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">逻辑备份</li><li class="listitem">物理备份</li></ul></div><p>
						<span class="strong"><strong>逻辑备份</strong></span>包含还原数据所需的SQL语句。此类备份以纯文本文件的形式导出信息和记录。
					</p><p>逻辑备份优于物理备份的主要优点是可移植性和灵活性。可以在其他硬件配置，MariaDB版本或数据库管理系统（DBMS）上恢复数据，这是物理备份无法实现的。
					</p><p>请注意，如果<code class="literal">mariadb.service</code>正在运行，则可以执行逻辑备份。逻辑备份不包括日志和配置文件。
					</p><p>
						<span class="strong"><strong>物理备份</strong></span>包含存储内容的文件和目录的副本。
					</p><p>与逻辑备份相比，物理备份具有以下优点：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">输出更紧凑。
							</li><li class="listitem">备份的尺寸较小。
							</li><li class="listitem">备份和还原速度更快。
							</li><li class="listitem">备份包括日志和配置文件。
							</li></ul></div><p>请注意，必须在<code class="literal">mariadb.service</code>未运行或数据库中的所有表都被锁定时执行物理备份，以防止在备份期间进行更改。
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="mariadb_backup_methods"></a> MariaDB备份方法</h3></div></div></div><p>您可以使用以下方法之一备份<span class="strong"><strong>MariaDB</strong></span>数据库中的数据：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								<a class="xref" href="using-databases.html#backuping-mariadb_logical_backup" title="使用mysqldump进行逻辑备份">“mysqldump的逻辑备份”一节</a>
							</li><li class="listitem">
								<a class="xref" href="using-databases.html#backuping-mariadb_physical_backup" title="使用Mariabackup工具进行物理在线备份">“使用Mariabackup工具进行物理在线备份”一节</a>
							</li><li class="listitem">
								<a class="xref" href="using-databases.html#backuping-mariadb_filesystem_backup" title="文件系统备份">“文件系统备份”一节</a>
							</li><li class="listitem">
								<a class="xref" href="using-databases.html#backuping-mariadb_replication" title="复制作为备份解决方案">“复制作为备份解决方案”一节</a>
							</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="backuping-mariadb_logical_backup"></a>使用mysqldump进行逻辑备份</h3></div></div></div><p><span class="strong"><strong><span class="application">mysqldump</span></strong></span>客户端是一个备份实用程序，可用于转储数据库或数据库集合，以便备份或传输到另一个数据库服务器。<span class="strong"><strong><span class="application">mysqldump</span></strong></span>的输出通常由SQL语句组成，这些语句可以创建表，填充表或创建表并填充表。或者， <span class="strong"><strong><span class="application">mysqldump</span></strong></span>还可以生成其他格式的文件，包括CSV或其他分隔文本格式，以及XML。</p><p>有关使用<span class="strong"><strong><span class="application">mysqldump</span></strong></span>进行逻辑备份的更多信息，请参阅<a class="link" href="https://mariadb.com/kb/en/library/mysqldump/">MariaDB文档</a> 。
					</p><p>要执行<span class="strong"><strong><span class="application">mysqldump</span></strong></span>备份，可以使用以下选项之一：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">备份选定的数据库</li><li class="listitem">从一个数据库备份表的子集</li><li class="listitem">备份多个数据库</li><li class="listitem">备份所有数据库</li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="frequently_used_commands_in_mysqldump_backups"></a> mysqldump备份中经常使用的命令</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">要备份整个数据库，请运行：</p><pre class="literallayout">~]# mysqldump [options] db_name &gt; backup-file.sql</pre></li><li class="listitem"><p class="simpara">要从一个数据库备份表的子集，请在命令末尾添加所选表的列表：</p><pre class="literallayout">~]# mysqldump [options] db_name [tbl_name …​]</pre></li><li class="listitem"><p class="simpara">要将转储文件加载回服务器，请运行：</p><pre class="literallayout">~]# mysql db_name &lt; backup-file.sql</pre><p class="simpara">要么</p><pre class="literallayout">~]# mysql -e "source /path-to-backup/backup-file.sql" db_name</pre></li><li class="listitem"><p class="simpara">要通过将数据从一个<span class="strong"><strong>MariaDB</strong></span>服务器复制到另一个服务器来填充数据库，请运行：</p><pre class="literallayout">~]# mysqldump --opt db_name | mysql --host=remote_host -C db_name</pre></li><li class="listitem"><p class="simpara">要一次转储多个数据库，请运行：</p><pre class="literallayout">~]# mysqldump [options] --databases db_name1 [db_name2 …​] &gt; my_databases.sql</pre></li><li class="listitem"><p class="simpara">要转储所有数据库，请运行：</p><pre class="literallayout">~]# mysqldump [options]--all-databases &gt; all_databases.sql</pre></li><li class="listitem"><p class="simpara">要查看mysqldump支持的选项列表，请运行：</p><pre class="literallayout">~]$ mysqldump --help</pre></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="backuping-mariadb_physical_backup"></a>使用Mariabackup工具进行物理在线备份</h3></div></div></div><p>
						<span class="strong"><strong><span class="application">Mariabackup</span></strong></span>是一种基于Percona XtraBackup技术的工具，可以对InnoDB，Aria和MyISAM表进行物理在线备份。
					</p><p>
						<span class="strong"><strong><span class="application">Mariabackup</span></strong></span>由AppStream存储库中的<code class="literal">mariadb-backup</code>软件包提供，支持<span class="strong"><strong>MariaDB</strong></span>服务器的完整备份功能，包括加密和压缩数据。
					</p><p>要安装<span class="strong"><strong><span class="application">Mariabackup</span></strong></span> ，请以<code class="literal">root</code> <span class="strong"><strong><span class="application">身份</span></strong></span>运行以下命令：</p><pre class="literallayout">~]# yum install mariadb-backup</pre><p>要配置<span class="strong"><strong><span class="application">Mariabackup，</span></strong></span>通过添加以下行到设定的用户名和密码<code class="literal">[xtrabackup]</code>或<code class="literal">[mysqld]</code>的部分<code class="literal">*.cnf</code>配置文件，您需要创建（例如， <code class="literal">/etc/my.cnf.d/mariabackup.cnf</code> ）：</p><pre class="literallayout">[xtrabackup]
user=myuser
password=mypassword</pre><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>
							<span class="strong"><strong><span class="application">Mariabackup</span></strong></span>不读取配置文件的<code class="literal">[mariadb]</code>部分中的选项。如果在<span class="strong"><strong>MariaDB</strong></span>服务器上指定了非默认数据目录，则必须在配置文件的<code class="literal">[xtrabackup]</code>或<code class="literal">[mysqld]</code>部分中指定此目录，以便<span class="strong"><strong><span class="application">Mariabackup</span></strong></span>能够找到数据目录。
						</p><p>要指定此类数据目录，请在<span class="strong"><strong>MariaDB</strong></span>配置文件的<code class="literal">[xtrabackup]</code>或<code class="literal">[mysqld]</code>部分中包含以下行：</p><pre class="literallayout">datadir=/var/mycustomdatadir</pre></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p><span class="strong"><strong><span class="application">Mariabackup的</span></strong></span>用户必须具有<code class="literal">RELOAD</code> ， <code class="literal">LOCK TABLES</code>和<code class="literal">REPLICATION CLIENT</code>权限才能使用备份。
						</p></div><p>要使用<span class="strong"><strong><span class="application">Mariabackup</span></strong></span>创建数据库备份，请运行以下命令：</p><pre class="literallayout">~]$ mariabackup --backup --target-dir &lt;backup_directory&gt; --user &lt;backup_user&gt; --password &lt;backup_passwd&gt;</pre><p><code class="literal">target-dir</code>选项定义将存储备份文件的目录。
					</p><p>请注意，如果要执行完整备份，目标目录必须为空或不存在。
					</p><p>有关使用<span class="strong"><strong><span class="application">Mariabackup</span></strong></span>执行备份的详细信息，请参阅使用<span class="strong"><strong><span class="application">Mariabackup</span></strong></span>进行<a class="link" href="https://mariadb.com/kb/en/library/full-backup-and-restore-with-mariadb-backup/">完全备份和还原</a> 。
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="backuping-mariadb_filesystem_backup"></a>文件系统备份</h3></div></div></div><p>要执行文件系统备份，请将数据文件复制到另一个位置。复制数据文件时，请确保<code class="literal">mariadb</code>服务未运行。
					</p><p>要创建<span class="strong"><strong>MariaDB</strong></span>数据文件的文件系统备份，请更改为<code class="literal">root</code>用户，并使用以下过程：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">停止<code class="literal">mariadb</code>服务：</p><pre class="literallayout">~]# systemctl stop mariadb.service</pre></li><li class="listitem"><p class="simpara">将数据文件复制到所需位置：</p><pre class="literallayout">~]# cp -r /var/lib/mysql /backup-location</pre></li><li class="listitem"><p class="simpara">启动<code class="literal">mariadb</code>服务：</p><pre class="literallayout">~]# systemctl start mariadb.service</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="backuping-mariadb_replication"></a>复制作为备份解决方案</h3></div></div></div><p>复制是主服务器的备用备份解决方案。如果主服务器复制到从属服务器，则可以在从属服务器上运行备份，而不会对主服务器产生任何影响。
					</p><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p>复制不是一个充分的备份解决方案。复制可保护主服务器免受硬件故障的影响，但不能确保防止数据丢失。
						</p></div><p>有关复制作为备份解决方案的更多信息，请参阅<a class="link" href="https://mariadb.com/kb/en/library/replication-as-a-backup-solution/">MariaDB文档</a> 。
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrating-to-mariadb_10_3_using-mariadb"></a>迁移到MariaDB 10.3</h2></div></div></div><p>Red Hat Enterprise Linux 7包含<span class="strong"><strong>MariaDB 5.5</strong></span>作为MySQL数据库系列服务器的默认实现。更高版本的<span class="strong"><strong>MariaDB</strong></span>数据库服务器可用作Red Hat Enterprise Linux 6和Red Hat Enterprise Linux 7的软件集合。Red Hat Enterprise Linux 8提供<span class="strong"><strong>MariaDB 10.3</strong></span>和<span class="strong"><strong>MySQL 8.0</strong></span> 。
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="notable-differences-in-mariadb-rhel7-rhel8"></a> MariaDB的RHEL 7和RHEL 8版本之间存在显着差异</h3></div></div></div><p><span class="strong"><strong>MariaDB 5.5</strong></span>和<span class="strong"><strong>MariaDB</strong></span> 10.3之间最重要的变化如下：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								<span class="strong"><strong>MariaDB</strong></span> Galera Cluster是一个同步多主集群，自10.1以来就是<span class="strong"><strong>MariaDB</strong></span>的标准部分。
							</li><li class="listitem">默认情况下不再启用ARCHIVE存储引擎，需要专门启用插件。
							</li><li class="listitem">默认情况下不再启用BLACKHOLE存储引擎，需要专门启用插件。
							</li><li class="listitem"><p class="simpara">InnoDB用作默认存储引擎，而不是XtraDB，后者在<span class="strong"><strong>MariaDB 10.1</strong></span>及更早版本中使用。
							</p><p class="simpara">有关更多详细信息，请参阅<a class="link" href="https://mariadb.com/kb/en/library/why-does-mariadb-102-use-innodb-instead-of-xtradb/">为什么MariaDB 10.2使用InnoDB而不是XtraDB？</a> 。
							</p></li><li class="listitem">新的<code class="literal">mariadb-connector-c</code>软件包为MySQL和MariaDB提供了一个通用的客户端库。该库可用于任何版本的<span class="strong"><strong>MySQL</strong></span>和<span class="strong"><strong>MariaDB</strong></span>数据库服务器。因此，用户可以将应用程序的一个版本连接到随Red Hat Enterprise Linux 8一起分发的任何MySQL和<span class="strong"><strong>MariaDB</strong></span>服务器。
							</li></ul></div><p>要从<span class="strong"><strong>MariaDB 5.5</strong></span>迁移到<span class="strong"><strong>MariaDB 10.3</strong></span> ，您需要执行多个配置更改，如<a class="xref" href="using-databases.html#migrating-to-mariadb_10_3_conf_changes" title="Configuration changes">“配置更改”一节</a>中<a class="xref" href="using-databases.html#migrating-to-mariadb_10_3_conf_changes" title="配置更改">所述</a> 。
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="migrating-to-mariadb_10_3_conf_changes"></a>配置更改</h3></div></div></div><p>从<span class="strong"><strong>MariaDB 5.5</strong></span>到<span class="strong"><strong>MariaDB 10.3</strong></span>的建议迁移路径是首先升级到<span class="strong"><strong>MariaDB 10.0</strong></span> ，然后依次升级到一个版本。
					</p><p>有关配置更改从<span class="strong"><strong>MariaDB的5.5</strong></span>迁移到<span class="strong"><strong>MariaDB的10.0</strong></span>时的详细信息，请参阅<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_software_collections/2/html-single/2.0_release_notes/#sect-Migration-MariaDB/">迁移到MariaDB的10.0</a>红帽软件集合文档。
					</p><p>这些文档中描述了迁移到以下连续版本的<span class="strong"><strong>MariaDB</strong></span>以及所需的配置更改：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								在Red Hat Software Collections文档中<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_software_collections/2/html-single/2.2_release_notes/#sect-Migration-MariaDB">迁移到MariaDB 10.1</a> 。
							</li><li class="listitem">
								在Red Hat Software Collections文档中<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_software_collections/3/html-single/3.0_release_notes/#sect-Migration-MariaDB">迁移到MariaDB 10.2</a> 。
							</li><li class="listitem">
								在上游文档中<a class="link" href="https://mariadb.com/kb/en/library/upgrading-from-mariadb-102-to-mariadb-103/">从MariaDB 10.2升级到MariaDB 10.3</a> 。
							</li></ul></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>也可以直接从<span class="strong"><strong>MariaDB 5.5</strong></span>迁移到<span class="strong"><strong>MariaDB 10.3</strong></span> ，但您必须执行上述迁移文档中描述的差异所需的所有配置更改。
						</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="mariadb-in-place-upgrade"></a>使用mysql_upgrade工具进行就地升级</h3></div></div></div><p>要将数据库文件迁移到Red Hat Enterprise Linux 8，Red Hat Enterprise Linux 7上的<span class="strong"><strong>MariaDB</strong></span>用户需要使用<code class="literal">mysql_upgrade</code>工具执行就地升级。
					</p><p>要执行就地升级，您需要将二进制数据文件复制到Red Hat Enterprise Linux 8系统上的<code class="literal">/var/lib/mysql/</code> data目录并使用<code class="literal">mysql_upgrade</code>工具。
					</p><p>您可以使用此方法从以下位置迁移数据：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>MariaDB 5.5</strong></span>的Red Hat Enterprise Linux 7版本
							</li><li class="listitem"><p class="simpara">Red Hat Software Collections版本：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
										<span class="strong"><strong>MariaDB 5.5</strong></span> （不再支持）</li><li class="listitem">
										<span class="strong"><strong>MariaDB 10.0</strong></span> （不再支持）</li><li class="listitem">
										<span class="strong"><strong>MariaDB 10.1</strong></span>
									</li><li class="listitem">
										<span class="strong"><strong>MariaDB 10.2</strong></span>
									</li></ul></div></li></ul></div><p>请注意，建议先连续一个版本升级到<span class="strong"><strong>MariaDB 10.2</strong></span> 。请参阅“ <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_software_collections/3/">Red Hat软件集合发行说明”中</a>的相应“迁移”章节。
					</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>如果从RedDB Enterprise Linux 7版本的<span class="strong"><strong>MariaDB</strong></span>升级，源数据将存储在<code class="literal">/var/lib/mysql/</code>目录中。对于<span class="strong"><strong>MariaDB</strong></span>的Red Hat Software Collections版本，源数据目录是<code class="literal">/var/opt/rh/&lt;collection_name&gt;/lib/mysql/</code> （ <code class="literal">mariadb55</code> ，它使用<code class="literal">/opt/rh/mariadb55/root/var/lib/mysql/</code> data目录）。
						</p></div><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>在执行升级之前，请按照<a class="xref" href="using-databases.html#backuping-mariadb_using-mariadb" title="Backing up MariaDB data">“备份MariaDB数据”一节中的说明备份</a>存储在<span class="strong"><strong>MariaDB</strong></span>数据库中的所有<a class="xref" href="using-databases.html#backuping-mariadb_using-mariadb" title="备份MariaDB数据">数据</a> 。
						</p></div><p>要执行就地升级，请更改为<code class="literal">root</code>用户，然后使用以下过程：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">确保在Red Hat Enterprise Linux 8系统上安装了<code class="literal">mariadb-server</code>软件包：</p><pre class="literallayout">~]# yum install mariadb-server</pre></li><li class="listitem"><p class="simpara">确保在复制数据时，mariadb守护程序未在源系统和目标系统上运行：</p><pre class="literallayout">~]# systemctl stop mariadb.service</pre></li><li class="listitem">将数据从源位置复制到Red Hat Enterprise Linux 8目标系统上的<code class="literal">/var/lib/mysql/</code>目录。
							</li><li class="listitem"><p class="simpara">为目标系统上的复制文件设置适当的权限和SELinux上下文：</p><pre class="literallayout">~]# restorecon -vr /var/lib/mysql</pre></li><li class="listitem"><p class="simpara">在目标系统上启动<span class="strong"><strong>MariaDB</strong></span>服务器：</p><pre class="literallayout">~]# systemctl start mariadb.service</pre></li><li class="listitem"><p class="simpara">运行<code class="literal">mysql_upgrade</code>命令检查并修复内部表：</p><pre class="literallayout">~]# systemctl mysql_upgrade</pre></li><li class="listitem">升级完成后，请确保<code class="literal">/etc/my.cnf.d/</code>目录中的所有配置文件仅包含<span class="strong"><strong>MariaDB 10.3的</strong></span>有效选项。
							</li></ol></div><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>存在与就地升级相关的某些风险和已知问题。例如，某些查询可能不起作用，或者它们将以与升级之前不同的顺序运行。有关这些风险和问题的更多信息，以及有关就地升级的一般信息，请参阅<a class="link" href="https://mariadb.com/kb/en/library/mariadb-1030-release-notes/">MariaDB 10.3发行说明</a> 。
						</p></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="using-postgresql"></a>在Red Hat Enterprise Linux 8上使用PostgreSQL</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="introduction-to-postgresql_using-postgresql"></a>在Red Hat Enterprise Linux 8上开始使用PostgreSQL</h2></div></div></div><p><span class="strong"><strong>PostgreSQL</strong></span>服务器是一个基于SQL语言的开源健壮且高度可扩展的数据库服务器。它提供了一个对象关系数据库系统，允许管理大量数据集和大量并发用户。出于这些原因，可以在群集中使用PostgreSQL服务器来管理大量数据。
				</p><p><span class="strong"><strong>PostgreSQL</strong></span>服务器包含用于确保数据完整性，构建容错环境或构建应用程序的功能。它允许使用用户自己的数据类型，自定义函数或来自不同编程语言的代码扩展数据库，而无需重新编译数据库。
				</p><p>本节介绍如何在安装<span class="strong"><strong>PostgreSQL</strong></span>中<a class="link" href="using-databases.html#installing-postgresql_using-postgresql" title="安装PostgreSQL">安装PostgreSQL</a>或如何从Red Hat Enterprise Linux 7默认版本<span class="strong"><strong>PostgreSQL 9.2</strong></span>迁移到Red Hat Enterprise Linux 8默认版本<span class="strong"><strong>PostgreSQL 10.0</strong></span> <a class="link" href="using-databases.html#migrating-to-postgresql_using-postgresql" title="迁移到PostgreSQL 10.0">迁移到PostgreSQL 10.0</a> 。迁移的先决条件之一是执行数据备份。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="installing-postgresql_using-postgresql"></a>安装PostgreSQL</h2></div></div></div><p>在RHEL 8中， <span class="strong"><strong>PostgreSQL</strong></span>服务器有两个版本：10和9.6，由两个流提供。本节假定使用默认流中的<span class="strong"><strong>PostgreSQL 10</strong></span> 。有关更改流的信息，请参阅<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/installing_managing_and_removing_user_space_components/">安装，管理和删除用户空间组件</a> 。
				</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>按照设计，不可能并行安装同一模块的多个版本（流）。例如，您只需要从<code class="literal">postgresql</code>模块中选择一个可用的流，10（默认）或9.6。Red Hat Software Collection for Red Hat Enterprise Linux 6和Red Hat Enterprise Linux 7可以并行安装组件。在Red Hat Enterprise Linux 8中，可以在容器中使用不同版本的数据库服务器。
					</p></div><p>要安装<span class="strong"><strong>PostgreSQL，请</strong></span>遵循以下过程：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">确保Application Stream存储库中提供的<code class="literal">postgresql-server</code>软件包安装在所需的服务器上：</p><pre class="literallayout">~]# yum install postgresql-server</pre></li><li class="listitem"><p class="simpara">初始化数据目录</p><pre class="literallayout">postgresql-setup --initdb</pre></li><li class="listitem"><p class="simpara">启动<code class="literal">postgresql</code>服务：</p><pre class="literallayout">~]# systemctl start postgresql.service</pre></li><li class="listitem"><p class="simpara">启用<code class="literal">postgresql</code>服务以在启动时启动：</p><pre class="literallayout">~]# systemctl enable postgresql.service</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring-postgresql_using-postgresql"></a>配置PostgreSQL</h2></div></div></div><p>要更改<span class="strong"><strong>PostgreSQL</strong></span>配置，请使用<code class="literal">/var/lib/pgsql/data/postgresql.conf</code>文件。然后，重新启动<code class="literal">postgresql</code>服务以使更改生效：</p><pre class="literallayout">systemctl restart postgresql.service</pre><p>除了<code class="literal">/var/lib/pgsql/data/postgresql.conf</code>之外，还存在其他用于更改<span class="strong"><strong>PostgreSQL</strong></span>配置的文件：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<code class="literal">postgresql.auto.conf</code>
						</li><li class="listitem">
							<code class="literal">`pg_ident.conf'里</code>
						</li><li class="listitem">
							<code class="literal">的pg_hba.conf</code>
						</li></ul></div><p><code class="literal">postgresql.auto.conf</code>文件与<code class="literal">/var/lib/pgsql/data/postgresql.conf</code>类似，保存基本的<span class="strong"><strong>PostgreSQL</strong></span>设置。但是，此文件位于服务器控件之下。它由<code class="literal">ALTER SYSTEM</code>查询编辑，无法手动编辑。
				</p><p><code class="literal">pg_ident.conf</code>文件用于将用户身份从外部身份验证机制映射到postgresql用户身份。
				</p><p><code class="literal">pg_hba.conf</code>文件用于配置<span class="strong"><strong>PostgreSQL</strong></span>数据库的详细用户权限。
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="initializing-database-cluster_using-postgresql"></a>初始化数据库集群</h3></div></div></div><p>在<span class="strong"><strong>PostgreSQL</strong></span>数据库中，所有数据都存储在一个目录中，称为数据库集群。您可以选择存储数据的位置，但Red Hat建议将数据存储在缺省的<code class="literal">/var/lib/pgsql/data</code>目录中。
					</p><p>要初始化此数据目录，请运行：</p><pre class="literallayout">postgresql-setup --initdb</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="backing-up-postgresql-data_using-postgresql"></a>备份PostgreSQL数据</h2></div></div></div><p>要备份<span class="strong"><strong>PostgreSQL</strong></span>数据，请使用以下方法之一：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">SQL转储</li><li class="listitem">文件系统级备份</li><li class="listitem">连续存档</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="backuping-postgresql-sql-dump_backing-up-postgresql-data"></a>使用SQL转储备份PostgreSQL数据</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="perforing-sql-dump_backing-up-postgresql-data"></a>执行SQL转储</h4></div></div></div><p>SQL转储方法基于使用SQL命令生成文件。将此文件上载回数据库服务器时，它会以与转储时相同的状态重新创建数据库。SQL转储由<span class="strong"><strong><span class="application">pg_dump</span></strong></span>实用程序确保，该实用程序是<span class="strong"><strong>PostgreSQL</strong></span>客户端应用程序。<code class="literal">pg_dump</code>命令的基本用法是命令将其结果写入标准输出：</p><pre class="literallayout">pg_dump dbname &gt; dumpfile</pre><p>生成的SQL文件可以是文本格式，也可以是其他不同格式，这样可以实现并行性和更详细的对象恢复控制。
						</p><p>您可以从任何有权访问数据库的远程主机执行SQL转储。<span class="strong"><strong><span class="application">pg_dump</span></strong></span>实用程序不以特殊权限运行，但必须具有对要备份的所有表的读访问权限。要备份整个数据库，必须以数据库超级用户身份运行它。
						</p><p>要指定<span class="strong"><strong><span class="application">pg_dump</span></strong></span>将联系的数据库服务器，请使用以下命令行选项：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara"><code class="literal">-h</code>选项用于定义主机。
								</p><p class="simpara">默认主机是本地主机或<code class="literal">PGHOST</code>环境变量指定的主机。
								</p></li><li class="listitem"><p class="simpara"><code class="literal">-p</code>选项用于定义端口。
								</p><p class="simpara">默认端口由<code class="literal">PGPORT</code>环境变量或编译的默认值指示。
								</p></li></ul></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>请注意， <span class="strong"><strong><span class="application">pg_dump</span></strong></span>仅转储单个数据库。它不会转储有关角色或表空间的信息，因为此类信息是群集范围的。
							</p><p>要备份给定集群中的每个数据库并保留集群范围的数据（例如角色和表空间定义），请使用<code class="literal">pg_dumpall</code>命令：</p><pre class="literallayout">pg_dumpall &gt; dumpfile</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="restoring-from-sql-dump"></a>从SQL转储还原数据库</h4></div></div></div><p>要从SQL转储还原数据库：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">创建一个新数据库（dbname）：</p><pre class="literallayout">createdb <code class="literal">dbname</code></pre></li><li class="listitem"><p class="simpara">确保已拥有对象或已被授予转储数据库中对象权限的所有用户已存在。
								</p><p class="simpara">如果此类用户不存在，则还原将无法重新创建具有原始所有权和权限的对象。
								</p></li><li class="listitem"><p class="simpara">运行<span class="strong"><strong><span class="application">psql</span></strong></span>实用程序以还原由<span class="strong"><strong><span class="application">pg_dump</span></strong></span>实用程序创建的文本文件转储：</p><pre class="literallayout">psql dbname &lt; dumpfile</pre></li></ol></div><p>其中<code class="literal">dumpfile</code>是<code class="literal">pg_dump</code>命令的输出。
						</p><p>如果要还原非文本文件转储，请使用<code class="literal">pg_restore</code>实用程序：</p><pre class="literallayout">pg_restore non-plain-text-file</pre><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="restoring_a_database_on_another_server"></a>在另一台服务器上恢复数据库</h5></div></div></div><p>可以将数据库直接从一个服务器转储到另一个服务器，因为<span class="strong"><strong><span class="application">pg_dump</span></strong></span>和<span class="strong"><strong><span class="application">psql</span></strong></span>可以写入和读取管道。
							</p><p>要将数据库从一个服务器转储到另一个服务器，请运行</p><pre class="literallayout">pg_dump -h host1 dbname | psql -h host2 dbname</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="handling_sql_errors_during_restore"></a>在还原期间处理SQL错误</h5></div></div></div><p>默认情况下，如果发生SQL错误， <span class="strong"><strong><span class="application">psql将</span></strong></span>继续执行。因此，仅部分恢复数据库。
							</p><p>如果要更改此默认行为，请使用以下方法之一：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">如果通过设置<code class="literal">ON_ERROR_STOP</code>变量发生SQL错误，则使<span class="strong"><strong><span class="application">psql</span></strong></span>退出，退出状态为3：</p><pre class="literallayout">psql --set ON_ERROR_STOP=on dbname &lt; dumpfile</pre></li><li class="listitem"><p class="simpara">指定将整个转储还原为单个事务，以便通过使用带有以下选项之一的<code class="literal">psql</code>完全还原或取消还原：</p><pre class="literallayout">psql -1</pre><p class="simpara">要么</p><pre class="literallayout">psql --single-transaction</pre><p class="simpara">请注意，使用此方法时，即使是较小的错误也可以取消已运行数小时的还原操作。
									</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="advantages-sql-dump_backing-up-postgresql-data"></a> SQL转储的优点和缺点</h4></div></div></div><p>与其他<span class="strong"><strong>PostgreSQL</strong></span>备份方法相比，SQL转储具有以下优点：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">SQL转储是唯一不是服务器版本特定的<span class="strong"><strong>PostgreSQL</strong></span>备份方法。<span class="strong"><strong><span class="application">pg_dump</span></strong></span>实用程序的输出可以重新加载到<span class="strong"><strong>PostgreSQL的</strong></span>更高版本中，这对于文件系统级备份或连续存档是不可能的。
								</li><li class="listitem">SQL转储是将数据库传输到其他计算机体系结构时唯一有效的方法，例如从32位服务器转移到64位服务器。
								</li><li class="listitem">SQL转储提供内部一致的转储。转储表示pg_dump开始运行时数据库的快照。
								</li><li class="listitem"><span class="strong"><strong><span class="application">pg_dump</span></strong></span>实用程序在运行时不会阻止数据库上的其他操作。
								</li></ul></div><p>SQL转储的缺点是与文件系统级备份相比需要更多时间。
						</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="additional_resources_42"></a>其他资源</h4></div></div></div><p>有关SQL转储的更多信息，请参阅<a class="link" href="https://www.postgresql.org/docs/10/static/backup-dump.html">PostgreSQL 10文档</a> 。
						</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="backuping-postgresql-system-level-backup_backing-up-postgresql-data"></a>使用文件系统级备份备份PostgreSQL数据</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="performing_a_file_system_level_backup"></a>执行文件系统级备份</h4></div></div></div><p>要执行文件系统级备份，您需要复制<span class="strong"><strong>PostgreSQL</strong></span>用于将数据库中的数据存储到另一个位置的文件：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">选择数据库集群的位置并初始化此集群，如<a class="xref" href="using-databases.html#initializing-database-cluster_using-postgresql" title="Initializing a database cluster">“初始化数据库集群”一节</a>中<a class="xref" href="using-databases.html#initializing-database-cluster_using-postgresql" title="初始化数据库集群">所述</a> 。
								</li><li class="listitem"><p class="simpara">停止postgresql服务：</p><pre class="literallayout">~]# systemctl stop postgresql.service</pre></li><li class="listitem"><p class="simpara">使用任何方法进行文件系统备份，例如：</p><pre class="literallayout">tar -cf backup.tar /var/lib/pgsql/data</pre></li><li class="listitem"><p class="simpara">启动postgresql服务：</p><pre class="literallayout">~]# systemctl start postgresql.service</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="advantages_and_disadvantages_of_a_file_system_level_backup"></a>文件系统级备份的优缺点</h4></div></div></div><p>与其他<span class="strong"><strong>PostgreSQL</strong></span>备份方法相比，文件系统级备份具有以下优势：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">文件系统级备份通常比SQL转储更快。
								</li></ul></div><p>与其他<span class="strong"><strong>PostgreSQL</strong></span>备份方法相比，文件系统级备份具有以下缺点：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">备份是特定于体系结构的，并且特定于Red Hat Enterprise Linux 7。如果升级不成功，它只能用作返回Red Hat Enterprise Linux 7的备份，但不能与<span class="strong"><strong>PostgreSQL 10.0</strong></span>一起使用。
								</li><li class="listitem">必须在数据备份之前和数据恢复之前关闭数据库服务器。
								</li><li class="listitem">无法备份和恢复某些单个文件或表。文件系统备份仅适用于完整备份和还原整个数据库群集。
								</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="alternative_approaches_to_file_system_level_backup"></a>文件系统级备份的替代方法</h4></div></div></div><p>文件系统备份的替代方法包括：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">数据目录的一致快照</li><li class="listitem">rsync实用程序</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="additional_resources_43"></a>其他资源</h4></div></div></div><p>有关文件系统级备份的详细信息，请参阅<a class="link" href="https://www.postgresql.org/docs/10/static/backup-file.html">PostgreSQL 10文档</a> 。
						</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="backuping-postgresql-continuous-archiving_backing-up-postgresql-data"></a>通过连续存档备份PostgreSQL数据</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="intro-continuous-archiving"></a>连续归档简介</h4></div></div></div><p>
							<span class="strong"><strong>PostgreSQL</strong></span>将对数据库数据文件所做的每一项更改记录到一个<code class="literal">pg_wal/</code>写日志（WAL）文件中，该文件位于集群数据目录的<code class="literal">pg_wal/</code>子目录中。此日志主要用于崩溃恢复。崩溃后，自上一个检查点以来所做的日志条目可用于将数据库恢复到一致性。
						</p><p>连续归档方法（也称为<code class="literal">online backup</code> ）将WAL文件与文件系统级备份相结合。如果需要数据库恢复，则可以从文件系统备份还原数据库，然后从备份的WAL文件重播日志以使系统进入当前状态。
						</p><p>对于此备份方法，您需要一系列连续的归档WAL文件，这些文件至少会延伸回备份的开始时间。
						</p><p>如果要开始使用连续归档备份方法，请确保在进行第一次基本备份之前设置并测试归档WAL文件的过程。
						</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>您不能将<span class="strong"><strong><span class="application">pg_dump</span></strong></span>和<span class="strong"><strong><span class="application">pg_dumpall</span></strong></span>转储用作连续归档备份解决方案的一部分。这些转储产生逻辑备份，而不是文件系统级备份。因此，它们不包含足够的信息以供WAL重放使用。
							</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="performing-continuous-archiving-backup"></a>执行连续归档备份</h4></div></div></div><p>要使用连续存档方法执行数据库备份和还原，请按照下列步骤操作：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
									<a class="xref" href="using-databases.html#making-base-backup" title="进行基本备份">称为“进行基本备份”的部分</a>
								</li><li class="listitem">
									<a class="xref" href="using-databases.html#restoring-database-with-continuous-archiving" title="使用连续存档备份还原数据库">“使用连续归档备份还原数据库”一节</a>
								</li></ol></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="making-base-backup"></a>进行基本备份</h5></div></div></div><p>要执行基本备份，请使用<span class="strong"><strong><span class="application">pg_basebackup</span></strong></span>工具，该工具可以单个文件或<code class="literal">tar</code>存档的形式创建基本备份。
							</p><p>要使用基本备份，您需要保留在文件系统备份期间和之后生成的所有WAL段文件。基本备份过程创建一个备份历史记录文件，该文件存储在WAL归档区域中，并以文件系统备份所需的第一个WAL段文件命名。如果已经安全地归档了备份历史文件中指定的文件系统备份和备份期间使用的WAL段文件，则可以删除名称数量较少的所有归档WAL段，因为不再需要它们来恢复文件系统备份。但是，请考虑保留多个备份集以确保您可以恢复数据。
							</p><p>备份历史记录文件是一个小文本文件，其中包含您为<span class="strong"><strong><span class="application">pg_basebackup</span></strong></span>提供的标签字符串，开始和结束时间以及备份的WAL段。如果使用标签字符串标识关联的转储文件，则存档的历史记录文件足以告诉您要还原的转储文件。
							</p><p>使用连续归档方法，您需要将所有归档的WAL文件保留回上一次基本备份。因此，基本备份的理想频率取决于：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">存档卷可用于存档的WAL文件。
									</li><li class="listitem"><p class="simpara">在需要恢复的情况下，最大可能的数据恢复持续时间。
									</p><p class="simpara">在自上次备份以来的较长时间内，系统会重放更多的WAL段，因此恢复需要更多时间。
									</p></li></ul></div><p>有关进行基本备份的详细信息，请参阅<a class="link" href="https://www.postgresql.org/docs/10/static/continuous-archiving.html#BACKUP-BASE-BACKUP">PostgreSQL 10文档</a> 。
							</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="restoring-database-with-continuous-archiving"></a>使用连续存档备份还原数据库</h5></div></div></div><p>要使用连续备份还原数据库：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">停止服务器：</p><pre class="literallayout">~]# systemctl stop postgresql.service</pre></li><li class="listitem"><p class="simpara">将必要的数据复制到临时位置。
									</p><p class="simpara">优选地，复制整个集群数据目录和任何表空间。请注意，这需要系统上有足够的可用空间来容纳现有数据库的两个副本。
									</p><p class="simpara">如果没有足够的空间，请保存群集的<code class="literal">pg_wal</code>目录的内容，该目录可能包含在系统关闭之前未归档的日志。
									</p></li><li class="listitem">删除群集数据目录下以及您正在使用的任何表空间的根目录下的所有现有文件和子目录。
									</li><li class="listitem"><p class="simpara">从文件系统备份还原数据库文件。
									</p><p class="simpara">确保：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">使用正确的所有权（数据库系统用户，而不是<code class="literal">root</code> ）还原文件</li><li class="listitem">使用正确的权限还原文件</li><li class="listitem"><code class="literal">pg_tblspc/</code>子目录中的符号链接已正确还原</li></ul></div></li><li class="listitem"><p class="simpara">删除<code class="literal">pg_wal/</code>子目录中的所有文件</p><p class="simpara">这些文件来自文件系统备份，因此已过时。如果您没有存档<code class="literal">pg_wal/</code> ，请使用适当的权限重新创建它。
									</p></li><li class="listitem">如果存在此类文件，请将步骤2中保存的未归档WAL段文件复制到<code class="literal">pg_wal/</code> 。
									</li><li class="listitem">在集群数据目录中创建<code class="literal">recovery.conf</code>恢复命令文件。
									</li><li class="listitem"><p class="simpara">启动服务器：</p><pre class="literallayout">~]# systemctl start postgresql.service</pre><p class="simpara">服务器将进入恢复模式并继续读取所需的归档WAL文件。
									</p><p class="simpara">如果由于外部错误而终止恢复，则可以简单地重新启动服务器并继续恢复。恢复过程完成后，服务器会将<code class="literal">recovery.conf</code>重命名为<code class="literal">recovery.done</code>以防止服务器启动正常数据库操作后意外重新进入恢复模式。
									</p></li><li class="listitem"><p class="simpara">检查数据库的内容以确保数据库已恢复到所需状态。
									</p><p class="simpara">如果数据库尚未恢复到所需状态，请返回步骤1。如果数据库已恢复到所需状态，请允许用户通过将<code class="literal">pg_hba.conf</code>文件恢复为正常进行连接。
									</p></li></ol></div><p>有关使用连续备份进行还原的详细信息，请参阅<a class="link" href="https://www.postgresql.org/docs/10/static/continuous-archiving.html#BACKUP-PITR-RECOVERY">PostgreSQL 10文档</a> 。
							</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="advantages-continuous-archiving"></a>连续归档的优缺点</h4></div></div></div><p>与其他<span class="strong"><strong>PostgreSQL</strong></span>备份方法相比，连续归档具有以下优势：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">使用连续备份方法，可以使用不完全一致的文件系统备份，因为备份中的任何内部不一致都会通过日志重播得到纠正。不需要文件系统快照; <code class="literal">tar</code>或类似的归档工具就足够了。
								</li><li class="listitem">通过继续存档WAL文件可以实现连续备份，因为日志重放的WAL文件序列可以无限长。这对于大型数据库尤其有用。
								</li><li class="listitem">持续备份支持时间点恢复。没有必要重放WAL条目到最后。可以在任何时候停止重放，并且自从进行基本备份以来，数据库可以随时恢复到其状态。
								</li><li class="listitem">如果一系列WAL文件连续可用于已加载相同基本备份文件的另一台计算机，则可以在任何时候使用几乎最新的数据库副本还原另一台计算机。
								</li></ul></div><p>与其他<span class="strong"><strong>PostgreSQL</strong></span>备份方法相比，连续归档具有以下缺点：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">连续备份方法仅支持还原整个数据库群集，而不是子集。
								</li><li class="listitem">连续备份需要大量的归档存储。
								</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="additional_resources_44"></a>其他资源</h4></div></div></div><p>有关连续归档方法的更多信息，请参阅<a class="link" href="https://www.postgresql.org/docs/10/static/continuous-archiving.html">PostgreSQL 10文档</a> 。
						</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="migrating-to-postgresql_using-postgresql"></a>迁移到PostgreSQL 10.0</h2></div></div></div><p>Red Hat Enterprise Linux 7包含<span class="strong"><strong>PostgreSQL 9.2</strong></span>作为<span class="strong"><strong>PostgreSQL</strong></span>服务器的默认版本。此外，还提供了几个版本的<span class="strong"><strong>PostgreSQL</strong></span>作为Red Hat Enterprise Linux 6和Red Hat Enterprise Linux 7的软件集合。Red Hat Enterprise Linux 8提供<span class="strong"><strong>PostgreSQL 10.0</strong></span>和<span class="strong"><strong>PostgreSQL 9.6</strong></span> 。
				</p><p>本节假设从Red Hat Enterprise Linux 7系统版本的<span class="strong"><strong>Postgreql 9.2</strong></span>迁移到默认流提供的Red Hat Enterprise Linux 8版本的<span class="strong"><strong>PostgreSQL 10</strong></span> 。
				</p><p>Red Hat Enterprise Linux 7上的<span class="strong"><strong>PostgreSQL</strong></span>用户可以使用两个迁移路径将数据库文件迁移到Red Hat Enterprise Linux 8：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<a class="link" href="using-databases.html#postgresql-in-place-upgrade" title="使用pg_upgrade工具快速升级">使用pg_upgrade工具快速升级</a>
						</li><li class="listitem">
							<a class="link" href="using-databases.html#postgresql-dump-and-restore-upgrade" title="转储和恢复升级">转储和恢复升级</a>
						</li></ul></div><p>最好使用快速升级方法，该方法比转储和恢复过程更快。
				</p><p>ba *跨架构升级*使用<code class="literal">plpython</code>或<code class="literal">plpython2</code>扩展的系统</p><p>+ Red Hat Enterprise Linux 8应用程序流存储库仅包含<code class="literal">postgresql-plpython3</code>包，而不包括<code class="literal">postgresql-plpython2</code>包。
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">从Red Hat Software Collections版本的<span class="strong"><strong>PostgreSQL</strong></span>迁移不支持快速升级。</li></ul></div><p>作为从<span class="strong"><strong>PostgreSQL 9.2</strong></span>迁移到<span class="strong"><strong>PostgreSQL 10.0</strong></span>的先决条件，备份<span class="strong"><strong>PostgreSQL</strong></span>数据库。
				</p><p>转储数据库和执行SQL文件备份是转储和还原过程的必要部分。但是，如果执行快速升级，建议您这样做。
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="postgresql-in-place-upgrade"></a>使用pg_upgrade工具快速升级</h3></div></div></div><p>在快速升级期间，您需要将二进制数据文件复制到<code class="literal">/var/lib/pgsql/data/</code>目录并使用<code class="literal">pg_upgrade</code>工具。您可以使用此方法从Red Hat Enterprise Linux 7版本的<span class="strong"><strong>PostgreSQL 9.2</strong></span>迁移数据。默认情况下，所有数据都存储在Red Hat Enterprise Linux 7和Red Hat Enterprise Linux 8系统的<code class="literal">/var/lib/pgsql/data/</code>目录中。要从Red Hat Software Collections版本的<span class="strong"><strong>PostgreSQL</strong></span>迁移，请使用<a class="link" href="using-databases.html#postgresql-dump-and-restore-upgrade" title="转储和恢复升级">转储和恢复升级</a> 。
					</p><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>在执行升级之前，请备份存储在<span class="strong"><strong>PostgreSQL</strong></span>数据库中的所有数据。
						</p></div><p>要执行快速升级，请使用以下过程：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">在RHEL 8系统上，安装<code class="literal">postgresql-server</code>和<code class="literal">postgresql-upgrade</code>软件包：</p><pre class="literallayout">~]# yum install postgresql-server postgresql-upgrade</pre><p class="simpara">或者，如果您在RHEL 7上使用任何<span class="strong"><strong>PostgreSQL</strong></span>服务器模块，也可以在RHEL 8系统上以两个版本安装它们，针对<span class="strong"><strong>PostgreSQL 9.2</strong></span> （作为<code class="literal">postgresql-upgrade</code>软件包安装）和<span class="strong"><strong>PostgreSQL 10</strong></span> （作为<code class="literal">postgresql-server</code>软件包安装）进行编译。 ）。如果您需要编译第三方<span class="strong"><strong>PostgreSQL</strong></span>服务器模块，请根据<code class="literal">postgresql-devel</code>和<code class="literal">postgresql-upgrade-devel</code>包构建它。
							</p></li><li class="listitem"><p class="simpara">检查以下项目：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">基本配置：在RHEL 8系统上，检查服务器是否使用缺省的<code class="literal">/var/lib/pgsql/data</code>目录，并正确初始化和启用数据库。此外，数据文件必须存储在<code class="literal">/usr/lib/systemd/system/postgresql.service</code>文件中提到的相同路径中。
									</li><li class="listitem">
										<span class="strong"><strong>PostgreSQL</strong></span>服务器：您的系统可以运行多个<span class="strong"><strong>PostgreSQL</strong></span>服务器。确保所有这些服务器的数据目录都是独立处理的。
									</li><li class="listitem">
										<span class="strong"><strong>PostgreSQL</strong></span>服务器模块：确保您在RHEL 8系统上安装了在{RHE} 7上使用的<span class="strong"><strong>PostgreSQL</strong></span>服务器模块。请注意，插件安装在<code class="literal">/usr/lib64/pgsql/</code>目录中（或32位系统上的<code class="literal">/usr/lib/pgsql/</code>目录中）。
									</li></ul></div></li><li class="listitem"><p class="simpara">确保在复制数据时， <code class="literal">postgresql</code>服务未在源系统和目标系统上运行。
							</p><pre class="literallayout">~]# systemctl stop postgresql.service</pre></li><li class="listitem">将数据库文件从源位置复制到RHEL 8系统上的<code class="literal">/var/lib/pgsql/data/</code>目录。
							</li><li class="listitem"><p class="simpara">通过以<span class="strong"><strong>PostgreSQL</strong></span>用户身份运行以下命令来执行升级过程：</p><pre class="literallayout">~]$ /bin/postgresql-setup --upgrade</pre><p class="simpara">这将在后台启动<code class="literal">pg_upgrade</code>进程。
							</p><p class="simpara">如果失败， <code class="literal">postgresql-setup</code>提供信息性错误消息。
							</p></li><li class="listitem"><p class="simpara">将先前配置从<code class="literal">/var/lib/pgsql/data-old</code>复制到新集群。
							</p><p class="simpara">请注意，快速升级不会在较新的数据堆栈中重用先前的配置，并且从头开始生成配置。如果要手动组合旧配置和新配置，请使用数据目录中的* .conf文件。
							</p></li><li class="listitem"><p class="simpara">启动新的<span class="strong"><strong>PostgreSQL 10</strong></span>服务器：</p><pre class="literallayout">~]# systemctl start postgresql.service</pre></li><li class="listitem"><p class="simpara">运行位于<span class="strong"><strong>PostgreSQL</strong></span>主目录中的<code class="literal">analyze_new_cluster.sh</code>脚本：</p><pre class="literallayout">su postgres -c '~/analyze_new_cluster.sh'</pre></li><li class="listitem"><p class="simpara">如果您希望<span class="strong"><strong>PostgreSQL 10</strong></span>服务器在引导时自动启动，请运行：</p><pre class="literallayout">~]# systemctl enable postgresql.service</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="postgresql-dump-and-restore-upgrade"></a>转储和恢复升级</h3></div></div></div><p>使用转储和还原升级时，需要将所有数据库内容转储到SQL文件转储文件中。
					</p><p>请注意，转储和还原升级比快速升级方法慢，并且可能需要在生成的SQL文件中进行一些手动修复。
					</p><p>您可以使用此方法从以下位置迁移数据：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The Red Hat Enterprise Linux7版本的<span class="strong"><strong>PostgreSQL 9.2</strong></span>
							</li><li class="listitem"><p class="simpara">Red Hat Software Collections版本：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
										<span class="strong"><strong>PostgreSQL 9.2</strong></span> （不再支持）</li><li class="listitem">
										<span class="strong"><strong>PostgreSQL 9.4</strong></span> （不再支持）</li><li class="listitem">
										<span class="strong"><strong>PostgreSQL 9.6</strong></span>
									</li><li class="listitem">
										<span class="strong"><strong>PostgreSQL 10</strong></span>
									</li></ul></div></li></ul></div><p>在Red Hat Enterprise Linux 7和Red Hat Enterprise Linux 8系统上， <span class="strong"><strong>PostgreSQL</strong></span>数据默认存储在<code class="literal">/var/lib/pgsql/data/</code>目录中。对于Red Hat Software Collections版本的<span class="strong"><strong>PostgreSQL</strong></span> ，默认数据目录是<code class="literal">/var/opt/rh/collection_name/lib/pgsql/data/</code> （ <code class="literal">postgresql92</code>除外，后者使用<code class="literal">/opt/rh/postgresql92/root/var/lib/pgsql/data/</code>目录）。
					</p><p>要执行转储和还原升级，请将用户更改为<code class="literal">root</code> ，并使用以下过程从Redgre Enterprise Linux 7系统版本的<span class="strong"><strong>PostgreSQL 9.2</strong></span>迁移到Red Hat Enterprise Linux 8默认版本的<span class="strong"><strong>PostgreSQL 10</strong></span> ：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">在RHEL 7系统上，启动<span class="strong"><strong>PostgreSQL 9.2</strong></span>服务器：</p><pre class="literallayout">~]# systemctl start postgresql.service</pre></li><li class="listitem"><p class="simpara">在RHEL 7系统上，将所有数据库内容转储到<code class="literal">pgdump_file.sql</code>文件中：</p><pre class="literallayout">su - postgres -c "pg_dumpall &gt; ~/pgdump_file.sql"</pre></li><li class="listitem"><p class="simpara">确保正确转储数据库：</p><pre class="literallayout">su - postgres -c 'less "$HOME/pgdump_file.sql"'</pre><p class="simpara">因此，将显示转储的sql文件的路径： <code class="literal">/var/lib/pgsql/pgdump_file.sql</code> 。
							</p></li><li class="listitem"><p class="simpara">在RHEL 8系统上，安装<code class="literal">postgresql-server</code>软件包：</p><pre class="literallayout">~]# yum install postgresql-server</pre><p class="simpara">或者，如果您在RHEL 7上使用了任何<span class="strong"><strong>PostgreSQL</strong></span>服务器模块，也可以在RHEL 8系统上安装它们。如果您需要编译第三方<span class="strong"><strong>PostgreSQL</strong></span>服务器模块，请根据<code class="literal">postgresql-devel</code>包进行构建。
							</p></li><li class="listitem"><p class="simpara">在RHEL 8系统上，初始化<span class="strong"><strong>PostgreSQL 10.0</strong></span>服务器的数据目录：</p><pre class="literallayout">~]# postgresql-setup --initdb</pre></li><li class="listitem"><p class="simpara">在RHEL 8系统上，将<code class="literal">pgdump_file.sql</code>复制到<span class="strong"><strong>PostgreSQL</strong></span>主目录中，并检查文件是否已正确复制：</p><pre class="literallayout">su - postgres -c 'test -e "$HOME/pgdump_file.sql" &amp;&amp; echo exists'</pre></li><li class="listitem"><p class="simpara">从RHEL 7系统复制配置文件：</p><pre class="literallayout">su - postgres -c 'ls -1 $PGDATA/*.conf'</pre><p class="simpara">要复制的配置文件是：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
										<code class="literal">/var/lib/pgsql/data/pg_hba.conf</code>
									</li><li class="listitem">
										<code class="literal">/var/lib/pgsql/data/pg_ident.conf</code>
									</li><li class="listitem">
										<code class="literal">/var/lib/pgsql/data/postgresql.conf</code>
									</li></ul></div></li><li class="listitem"><p class="simpara">在RHEL 8系统上，启动新的<span class="strong"><strong>PostgreSQL 10</strong></span>服务器：</p><pre class="literallayout">~]# systemctl start postgresql.service</pre></li><li class="listitem"><p class="simpara">在RHEL 8系统上，从转储的sql文件导入数据：</p><pre class="literallayout">su - postgres -c 'psql -f ~/pgdump_file.sql postgres'</pre></li></ol></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>从Red Hat Software Collections版本的<span class="strong"><strong>PostgreSQL</strong></span>升级时，请调整命令以包含<code class="literal">scl enable collection_name.</code> 例如，要从<code class="literal">rh-postgresql96</code>软件集合中转储数据，请使用以下命令：</p><pre class="literallayout">su - postgres -c 'scl enable rh-postgresql96 "pg_dumpall &gt; ~/pgdump_file.sql"'</pre></div></div></div></div></div></body></html>