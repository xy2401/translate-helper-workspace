<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 在IBM Z上的RHEL 8中开始使用虚拟化</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 在IBM Z上的RHEL 8中开始使用虚拟化</h1></div></div></div><p>在IBM Z硬件上使用RHEL 8时，可以使用KVM虚拟化。但是，在系统上<a class="link" href="getting-started-with-virtualization-in-rhel-8-on-ibm-z_configuring-and-managing-virtualization.html#enabling-virtualization-on-ibm-z_getting-started-with-virtualization-in-rhel-8-on-ibm-z" title="在IBM Z上启用虚拟化">启用KVM管理程序</a>时，与AMD64和Intel 64体系结构上的虚拟化相比，需要额外的步骤。某些RHEL 8虚拟化<a class="link" href="getting-started-with-virtualization-in-rhel-8-on-ibm-z_configuring-and-managing-virtualization.html#how-virtualization-on-ibm-z-differs-from-amd64-and-intel64_getting-started-with-virtualization-in-rhel-8-on-ibm-z" title="How virtualization on IBM Z differs from AMD64 and Intel 64">功能</a>在IBM Z上也具有<a class="link" href="getting-started-with-virtualization-in-rhel-8-on-ibm-z_configuring-and-managing-virtualization.html#how-virtualization-on-ibm-z-differs-from-amd64-and-intel64_getting-started-with-virtualization-in-rhel-8-on-ibm-z" title="IBM Z上的虚拟化与AMD64和Intel 64的不同之处">不同或受限制的功能</a> 。</p><p>除了以下部分中的信息之外，在IBM Z上使用虚拟化与在AMD64和Intel 64上使用相同。因此，您可以查看其他RHEL 8虚拟化文档，以获取有关在IBM Z上使用虚拟化的更多信息。</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enabling-virtualization-on-ibm-z_getting-started-with-virtualization-in-rhel-8-on-ibm-z"></a>在IBM Z上启用虚拟化</h1></div></div></div><p>要设置KVM管理程序并能够在运行RHEL 8的IBM Z系统上创建虚拟机（VM），请按照以下说明操作。
			</p><h3><a id="prerequisites_11"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">RHEL 8已在主机上安装并注册。
					</li><li class="listitem"><p class="simpara">可以使用以下系统资源：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">主机的6 GB可用磁盘空间，以及每个目标guest虚拟机的另外6 GB。</li><li class="listitem">主机使用2 GB RAM，每个预定客户使用另外2 GB RAM。</li></ul></div></li><li class="listitem">您的IBM Z主机系统需要使用z13 CPU或更高版本。
					</li><li class="listitem"><p class="simpara">RHEL 8必须安装在逻辑分区（LPAR）上。此外，LPAR必须支持<span class="emphasis"><em>启动 - 解释执行</em></span> （SIE）虚拟化功能。
					</p><p class="simpara">要验证这一点，请在<code class="literal">/proc/cpuinfo</code>文件中搜索<code class="literal">sie</code> 。
					</p><pre class="literallayout"># <span class="strong"><strong>grep sie /proc/cpuinfo/</strong></span>
features        : esan3 zarch stfle msa ldisp eimm dfp edat etf3eh highgprs te sie</pre></li></ul></div><h3><a id="procedure_12"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">加载KVM内核模块：</p><pre class="literallayout"># <span class="strong"><strong>modprobe kvm</strong></span></pre></li><li class="listitem"><p class="simpara">验证是否已加载KVM内核模块：</p><pre class="literallayout"># <span class="strong"><strong>lsmod | grep kvm</strong></span></pre><p class="simpara">如果KVM成功加载，则此命令的输出包括<code class="literal">kvm</code> ：</p></li><li class="listitem"><p class="simpara">在虚拟化模块中安装软件包：</p><pre class="literallayout"># <span class="strong"><strong>yum module install virt</strong></span></pre></li><li class="listitem"><p class="simpara">安装<code class="literal">virt-install</code>软件包：</p><pre class="literallayout"># <span class="strong"><strong>yum install virt-install</strong></span></pre></li><li class="listitem"><p class="simpara">验证您的系统是否已准备好成为虚拟化主机：</p><pre class="literallayout"># <span class="strong"><strong>virt-host-validate</strong></span>
[...]
QEMU: Checking if device /dev/kvm is accessible                : PASS
QEMU: Checking if device /dev/vhost-net exists                 : PASS
QEMU: Checking if device /dev/net/tun exists                   : PASS
QEMU: Checking for cgroup 'memory' controller support          : PASS
QEMU: Checking for cgroup 'memory' controller mount-point      : PASS
[...]</pre></li><li class="listitem"><p class="simpara">如果所有<span class="strong"><strong>virt-host-validate</strong></span>检查都返回<code class="literal">PASS</code>值，则系统已准备好<a class="link" href="getting-started-with-virtualization-in-rhel-8_configuring-and-managing-virtualization.html#assembly_creating-virtual-machines_virt-getting-started" title="创建虚拟机">创建虚拟机</a> 。
					</p><p class="simpara">如果任何检查返回<code class="literal">FAIL</code>值，请按照显示的说明解决问题。
					</p><p class="simpara">如果任何检查返回<code class="literal">WARN</code>值，请考虑按照显示的说明来改进虚拟化功能。
					</p></li></ol></div><h3><a id="additional_information_3"></a>附加信息</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">请注意，如果主机CPU不支持虚拟化， <span class="strong"><strong>virt-host-validate将</strong></span>生成以下输出：</p><pre class="literallayout">QEMU: Checking for hardware virtualization: FAIL (Only emulated CPUs are available, performance will be significantly limited)</pre><p class="simpara">但是，尝试在此类主机系统上创建VM将失败，而不是出现性能问题。
					</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="how-virtualization-on-ibm-z-differs-from-amd64-and-intel64_getting-started-with-virtualization-in-rhel-8-on-ibm-z"></a> IBM Z上的虚拟化与AMD64和Intel 64的不同之处</h1></div></div></div><p>IBM Z系统上的RHEL 8中的KVM虚拟化与AMD64和Intel 64系统上的KVM的不同之处如下：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">没有图形输出</span></dt><dd>使用VNC协议连接到VM时，无法显示VM图形输出。这是因为IBM Z不支持<code class="literal">gnome-desktop</code>实用程序。</dd><dt><span class="term">PCI和USB设备</span></dt><dd><p class="simpara">虚拟PCI和USB设备上不支持IBM Z。这也意味着， <code class="literal">virtio- <span class="emphasis"><em>*</em></span> -pci</code>设备不受支持， <code class="literal">virtio- <span class="emphasis"><em>*</em></span> -ccw</code>设备应改为使用。例如，使用<code class="literal">virtio-net-ccw</code>而不是<code class="literal">virtio-net-pci</code> 。
						</p><p class="simpara">请注意，支持PCI设备的直接连接，也称为PCI passthrough。
						</p></dd><dt><span class="term">设备启动顺序</span></dt><dd><p class="simpara">IBM Z不支持<code class="literal">&lt;boot dev=' <span class="emphasis"><em>device</em></span> '&gt;</code> XML配置元素。要定义设备引导顺序，请使用XML的<code class="literal">&lt;devices&gt;</code>部分中的<code class="literal">&lt;boot order=' <span class="emphasis"><em>number</em></span> '&gt;</code>元素。例如：</p><pre class="programlisting">&lt;devices&gt;
  &lt;disk type='file' snapshot='external'&gt;
    &lt;driver name="tap" type="aio" cache="default"/&gt;
    &lt;source file='/var/lib/xen/images/fv0' startupPolicy='optional'&gt;
      &lt;seclabel relabel='no'/&gt;
    &lt;/source&gt;
    &lt;target dev='hda' bus='ide'/&gt;
    &lt;iotune&gt;
      &lt;total_bytes_sec&gt;10000000&lt;/total_bytes_sec&gt;
      &lt;read_iops_sec&gt;400000&lt;/read_iops_sec&gt;
      &lt;write_iops_sec&gt;100000&lt;/write_iops_sec&gt;
    &lt;/iotune&gt;
    &lt;boot order='2'/&gt;
    [...]
  &lt;/disk&gt;</pre><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>在AMD64和Intel 64主机上，首选使用<code class="literal">&lt;boot order=' <span class="emphasis"><em>number</em></span> '&gt;</code>进行引导顺序管理。
							</p></div></dd><dt><span class="term">vfio-AP</span></dt><dd>IBM Z主机上的VM可以使用<span class="emphasis"><em>vfio-ap</em></span>加密设备passthrough，这在任何其他体系结构上都不受支持。
						</dd><dt><span class="term">SMBIOS</span></dt><dd>IBM Z上不提供SMBIOS配置。</dd><dt><span class="term">看门狗设备</span></dt><dd><p class="simpara">如果在IBM Z主机上的VM中使用监视程序设备，请使用<code class="literal">diag288</code>模型。例如：</p><pre class="programlisting">&lt;devices&gt;
  &lt;watchdog model='diag288' action='poweroff'/&gt;
&lt;/devices&gt;</pre></dd><dt><span class="term">KVM-时钟</span></dt><dd><code class="literal">kvm-clock</code>服务特定于AMD64和Intel 64系统，不必为IBM Z上的VM时间管理进行配置。</dd><dt><span class="term">v2v和p2v</span></dt><dd><code class="literal">virt-v2v</code>和<code class="literal">virt-p2v</code>实用程序仅支持AMD64和Intel 64架构。因此，IBM Z上未提供它们。</dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="related-information-getting-started-with-virtualization-in-rhel-8-on-ibm-z"></a>相关信息</h1></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">在IBM Z系统上设置VM时，建议保护来宾操作系统免受<a class="link" href="https://access.redhat.com/security/vulnerabilities/speculativeexecution">“Spectre”</a>漏洞的影响。为此，请使用<code class="literal">virsh edit</code>命令修改VM的XML配置，并使用以下方法之一配置其CPU：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">使用主机CPU模型，例如如下：</p><pre class="programlisting">&lt;cpu mode='host-model' check='partial'&gt;
  &lt;model fallback='allow'/&gt;
&lt;/cpu&gt;</pre><p class="simpara">这样，如果主机支持， <code class="literal">bpb</code> guest <code class="literal">bpb</code>提供<code class="literal">ppa15</code>和<code class="literal">bpb</code>功能。
							</p></li><li class="listitem"><p class="simpara">如果使用特定主机模型，请添加<code class="literal">ppa15</code>和<code class="literal">pbp</code>功能。以下示例使用zEC12 CPU模型：</p><pre class="programlisting">&lt;cpu mode='custom' match='exact' check='partial'&gt;
    &lt;model fallback='allow'&gt;zEC12&lt;/model&gt;
    &lt;feature policy='force' name='ppa15'/&gt;
    &lt;feature policy='force' name='bpb'/&gt;
&lt;/cpu&gt;</pre><p class="simpara">请注意，在使用z12 CPU的主机上使用<code class="literal">ppa15</code>功能和<code class="literal">z114</code>和<code class="literal">z196</code> CPU型号时，还需要使用最新的微码级别（捆绑包95或更高版本）。
							</p></li></ul></div></li><li class="listitem">请注意，不支持在z / VM OS上运行KVM。
					</li></ul></div></div></div></body></html>