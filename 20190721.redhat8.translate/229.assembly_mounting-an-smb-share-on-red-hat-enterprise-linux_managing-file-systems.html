<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 在Red Hat Enterprise Linux上安装SMB共享</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 在Red Hat Enterprise Linux上安装SMB共享</h1></div></div></div><p>服务器消息块（SMB）协议实现用于访问服务器上资源的应用层网络协议，例如文件共享和共享打印机。
		</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>在SMB的上下文中，您可以找到有关通用Internet文件系统（CIFS）协议的提及，这是SMB的一种方言。支持SMB和CIFS协议，并且安装SMB和CIFS共享所涉及的内核模块和实用程序都使用名称<code class="literal">cifs</code> 。
			</p></div><p>本节介绍如何从SMB服务器安装共享。有关使用Samba在Red Hat Enterprise Linux上设置SMB服务器的详细信息，请参阅“ <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring-and-deploying-different-types-of-servers/assembly_using-samba">配置和部署不同类型的服务器”中</a>有关使用Samba的部分。
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="prerequisites-assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a>先决条件</h1></div></div></div><p>在Microsoft Windows上，默认情况下会实施SMB。在Red Hat Enterprise Linux上，内核的<code class="literal">cifs.ko</code>文件系统模块支持挂载SMB共享。因此安装<code class="literal">cifs-utils</code>包：</p><pre class="literallayout"># yum install cifs-utils</pre><p><code class="literal">cifs-utils</code>包提供了以下工具：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">挂载SMB和CIFS共享</li><li class="listitem">在内核的密钥环中管理NT Lan Manager（NTLM）凭据</li><li class="listitem">在SMB和CIFS共享上的安全描述符中设置和显示访问控制列表（ACL）</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="con_supported-smb-protocol-versions_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a>支持的SMB协议版本</h1></div></div></div><p><code class="literal">cifs.ko</code>内核模块支持以下SMB协议版本：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">SMB 1</li><li class="listitem">SMB 2.0</li><li class="listitem">SMB 2.1</li><li class="listitem">SMB 3.0</li></ul></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>根据协议版本，并非所有SMB功能都已实现。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="con_unix-extensions-support_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a> UNIX扩展支持</h1></div></div></div><p>Samba使用SMB协议中的<code class="literal">CAP_UNIX</code>功能位来提供UNIX扩展功能。<code class="literal">cifs.ko</code>内核模块也支持这些扩展。但是，Samba和内核模块仅支持SMB 1协议中的UNIX扩展。
			</p><p>要使用UNIX扩展：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">将<code class="literal">server min protocol</code>文件的<code class="literal">[global]</code>部分中的<code class="literal">/etc/samba/smb.conf</code>参数设置为<code class="literal">NT1</code> 。这是Samba服务器上的默认设置。
					</li><li class="listitem"><p class="simpara">通过为mount命令提供<code class="literal">-o vers=1.0</code>选项，使用SMB 1协议挂载共享。例如：</p><pre class="literallayout"># mount -t cifs <span class="strong"><strong>-o vers=1.0</strong></span>,username=<span class="emphasis"><em>user_name</em></span> <span class="emphasis"><em>//server_name/share_name</em></span> <span class="emphasis"><em>/mnt/</em></span></pre><p class="simpara">默认情况下，内核模块使用SMB 2或服务器支持的最高协议版本。将<code class="literal">-o vers=1.0</code>选项传递给<code class="literal">mount</code>命令会强制内核模块使用UNIX扩展所需的SMB 1协议。
					</p></li></ol></div><p>要验证是否已启用UNIX扩展，请显示已安装共享的选项：</p><pre class="literallayout"># mount
...
<span class="emphasis"><em>//server/share</em></span> on <span class="emphasis"><em>/mnt</em></span> type cifs (...,<code class="literal">unix</code>,...)</pre><p>如果<code class="literal">unix</code>条目显示在mount选项列表中，则启用UNIX扩展。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_manually-mounting-an-smb-share_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a>手动挂载SMB共享</h1></div></div></div><p>如果您只需要临时安装SMB共享，则可以使用<code class="literal">mount</code>实用程序手动安装它。
			</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>重新引导系统时，不会再次自动挂载手动挂载的共享。要配置Red Hat Enterprise Linux在系统引导时自动挂载共享，请参阅<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_mounting-an-smb-share-automatically-when-the-system-boots_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux" title="Mounting an SMB share automatically when the system boots">“</a>在系统引导时自动挂载<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_mounting-an-smb-share-automatically-when-the-system-boots_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux" title="系统引导时自动挂载SMB共享">SMB共享”一节</a> 。
				</p></div><h3><a id="prerequisites_3"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">安装了<code class="literal">cifs-utils</code>软件包。
					</li></ul></div><h3><a id="procedure_12"></a>程序</h3><p>要手动安装SMB共享，请使用带<code class="literal">mount</code>参数的<code class="literal">-t cifs</code>实用程序：</p><pre class="literallayout"># mount -t cifs -o username=<span class="emphasis"><em>user_name</em></span> <span class="emphasis"><em>//server_name/share_name</em></span> <span class="emphasis"><em>/mnt/</em></span>
Password for <span class="emphasis"><em>user_name@//server_name/share_name</em></span>:  <span class="emphasis"><em>password</em></span></pre><p>在<code class="literal">-o</code>参数中，您可以指定用于装入共享的选项。有关详细信息，请参阅<code class="literal">OPTIONS</code>手册页中的<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#con_frequently-used-mount-options_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux" title="经常使用的挂载选项">“常用安装选项”</a>一节和“ <code class="literal">mount.cifs(8)</code>部分。
			</p><div class="example"><a id="example_mounting-a-share-using-an-encrypted-smb30-connection_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a><p class="title"><strong>例5.1。使用加密的SMB 3.0连接挂载共享</strong></p><div class="example-contents"><p>通过加密的SMB 3.0连接将<code class="literal">\\server\example\</code> share作为<code class="literal"><span class="emphasis"><em>DOMAIN</em></span>\Administrator</code>用户安装到<code class="literal">/mnt/</code>目录中：</p><pre class="literallayout"># mount -t cifs -o username=<span class="emphasis"><em>DOMAIN</em></span>\Administrator,seal,vers=3.0 //server/example /mnt/
Password for <span class="emphasis"><em>DOMAIN</em></span>\Administrator@//server_name/share_name:  <span class="emphasis"><em>password</em></span></pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_mounting-an-smb-share-automatically-when-the-system-boots_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a>系统引导时自动挂载SMB共享</h1></div></div></div><p>如果在服务器上永久需要访问已安装的SMB共享，请在引导时自动安装共享。
			</p><h3><a id="prerequisites_4"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">安装了<code class="literal">cifs-utils</code>软件包。
					</li></ul></div><h3><a id="procedure_13"></a>程序</h3><p>要在系统引导时自动挂载SMB共享，请将共享条目添加到<code class="literal">/etc/fstab</code>文件中。例如：</p><pre class="literallayout"><span class="emphasis"><em>//server_name/share_name</em></span>  <span class="emphasis"><em>/mnt</em></span>  cifs  credentials=<span class="emphasis"><em>/root/smb.cred</em></span>  0 0</pre><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>要使系统能够自动挂载共享，必须将用户名，密码和域名存储在凭证文件中。有关详细信息，请参阅<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_authenticating-to-an-smb-share-using-a-credentials-file_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux" title="使用凭证文件对SMB共享进行身份验证">“使用凭据文件向SMB共享进行身份验证”一节</a> 。
				</p></div><p>在<code class="literal">/etc/fstab</code>中行的第四个字段中，指定安装选项，例如凭证文件的路径。有关详细信息，请参阅<code class="literal">OPTIONS</code>手册页中的<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#con_frequently-used-mount-options_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux" title="经常使用的挂载选项">“常用安装选项”</a>一节和“ <code class="literal">mount.cifs(8)</code>部分。
			</p><p>要验证共享是否已成功安装，请输入：</p><pre class="literallayout"># mount /mnt/</pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_authenticating-to-an-smb-share-using-a-credentials-file_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a>使用凭证文件对SMB共享进行身份验证</h1></div></div></div><p>在某些情况下，例如在引导时自动挂载共享时，应安装共享而不输入用户名和密码。要实现此目的，请创建凭证文件。
			</p><h3><a id="prerequisites_5"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">安装了<code class="literal">cifs-utils</code>软件包。
					</li></ul></div><h3><a id="procedure_14"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">创建一个文件，例如<code class="literal">/root/smb.cred</code> ，并指定该文件的用户名，密码和域名：</p><pre class="literallayout">username=<span class="emphasis"><em>user_name</em></span>
password=<span class="emphasis"><em>password</em></span>
domain=<span class="emphasis"><em>domain_name</em></span></pre></li><li class="listitem"><p class="simpara">将权限设置为仅允许所有者访问该文件：</p><pre class="literallayout"># chown user_name /root/smb.cred
# chmod 600 /root/smb.cred</pre></li></ol></div><p>您现在可以将<code class="literal">credentials=<span class="emphasis"><em>file_name</em></span></code>挂载选项传递给<code class="literal">mount</code>实用程序，或者在<code class="literal">/etc/fstab</code>文件中使用它来挂载共享，而不会提示您输入用户名和密码。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="assembly_performing-a-multi-user-smb-mount_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a>执行多用户SMB安装</h1></div></div></div><p>默认情况下，您提供的用于装入共享的凭据可确定装入点的访问权限。例如，如果在装载共享时使用<code class="literal"><span class="emphasis"><em>DOMAIN</em></span>\example</code>用户，则共享上的所有操作都将作为此用户执行，无论哪个本地用户执行操作。
			</p><p>但是，在某些情况下，管理员希望在系统引导时自动挂载共享，但用户应使用自己的凭据对共享内容执行操作。<code class="literal">multiuser</code>安装选项允许您配置此方案。
			</p><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>要使用<code class="literal">multiuser</code>安装选项，必须另外将<code class="literal">sec</code> mount选项设置为支持以非交互方式提供凭据的安全类型，例如<code class="literal">krb5</code>或带有凭证文件的<code class="literal">ntlmssp</code>选项。有关详细信息，请参阅<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_accessing-a-share-as-a-user_assembly_performing-a-multi-user-smb-mount" title="以用户身份访问共享">“以用户身份访问共享”一节</a> 。
				</p></div><p><code class="literal">root</code>用户使用<code class="literal">multiuser</code>选项和对共享内容具有最小访问权限的帐户来安装共享。然后，普通用户可以使用<code class="literal">cifscreds</code>实用程序向当前会话的内核密钥环提供其用户名和密码。如果用户访问已安装共享的内容，则内核将使用内核密钥环中的凭据，而不是最初用于装入共享的凭据。
			</p><p>使用此功能包括以下步骤：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<a class="link" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_mounting-a-share-with-the-multiuser-option_assembly_performing-a-multi-user-smb-mount" title="使用多用户选项挂载共享">使用<code class="literal">multiuser</code>选项挂载共享</a> 。
					</li><li class="listitem">
						<a class="link" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_verifying-if-an-smb-share-is-mounted-with-the-multiuser-option_assembly_performing-a-multi-user-smb-mount" title="使用多用户选项验证是否已装入SMB共享">（可选）使用<code class="literal">multiuser</code>选项验证是否已成功装入共享</a> 。
					</li><li class="listitem">
						<a class="link" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_accessing-a-share-as-a-user_assembly_performing-a-multi-user-smb-mount" title="以用户身份访问共享">以用户身份访问共享</a> 。
					</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="prerequisites-assembly_performing-a-multi-user-smb-mount"></a>先决条件</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">安装了<code class="literal">cifs-utils</code>软件包。
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="proc_mounting-a-share-with-the-multiuser-option_assembly_performing-a-multi-user-smb-mount"></a>使用多用户选项挂载共享</h2></div></div></div><p>在用户可以使用自己的凭据访问共享之前，请使用权限有限的帐户以<code class="literal">root</code>用户身份挂载共享。
				</p><h4><a id="procedure_15"></a>程序</h4><p>在系统引导时使用<code class="literal">multiuser</code>选项自动挂载共享：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">在<code class="literal">/etc/fstab</code>文件中创建共享条目。例如：</p><pre class="literallayout"><span class="emphasis"><em>//server_name/share_name</em></span>  <span class="emphasis"><em>/mnt</em></span>  cifs  <code class="literal">multiuser,sec=ntlmssp</code>,credentials=<span class="emphasis"><em>/root/smb.cred</em></span>  0 0</pre></li><li class="listitem"><p class="simpara">挂载分享：</p><pre class="literallayout"># mount /mnt/</pre></li></ol></div><p>如果您不想在系统引导时自动挂载共享，请通过将<code class="literal">-o multiuser,sec=security_type</code>传递给<code class="literal">mount</code>命令来手动挂载它。有关手动安装SMB共享的详细信息，请参阅<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_manually-mounting-an-smb-share_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux" title="手动挂载SMB共享">“手动安装SMB共享”一节</a> 。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="proc_verifying-if-an-smb-share-is-mounted-with-the-multiuser-option_assembly_performing-a-multi-user-smb-mount"></a>使用多用户选项验证是否已装入SMB共享</h2></div></div></div><p>要验证是否使用<code class="literal">multiuser</code>选项装入共享，请显示装入选项。
				</p><h4><a id="procedure_16"></a>程序</h4><pre class="literallayout"># mount
...
<span class="emphasis"><em>//server_name/share_name</em></span> on <span class="emphasis"><em>/mnt</em></span> type cifs (sec=ntlmssp,<code class="literal">multiuser</code>,...)</pre><p>如果<code class="literal">multiuser</code>条目显示在装入选项列表中，则启用该功能。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="proc_accessing-a-share-as-a-user_assembly_performing-a-multi-user-smb-mount"></a>以用户身份访问共享</h2></div></div></div><p>如果使用<code class="literal">multiuser</code>选项装入SMB共享，则用户可以将服务器的凭据提供给内核的密钥环：</p><pre class="literallayout"># cifscreds add -u <span class="emphasis"><em>SMB_user_name</em></span> <span class="emphasis"><em>server_name</em></span>
Password: <span class="emphasis"><em>password</em></span></pre><p>当用户在包含已装入的SMB共享的目录中执行操作时，服务器将为此用户应用文件系统权限，而不是在装入共享时最初使用的权限。
				</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>多个用户可以同时使用自己的凭据在已装载的共享上执行操作。
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="con_frequently-used-mount-options_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux"></a>经常使用的挂载选项</h1></div></div></div><p>挂载SMB共享时，挂载选项确定：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">如何与服务器建立连接。例如，连接到服务器时使用哪个SMB协议版本。
					</li><li class="listitem">如何将共享挂载到本地文件系统。例如，如果系统覆盖远程文件和目录权限，则允许多个本地用户访问服务器上的内容。
					</li></ul></div><p>要在<code class="literal">/etc/fstab</code>文件的第四个字段或mount命令的<code class="literal">-o</code>参数中设置多个选项，请用逗号分隔它们。例如，请参阅<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_mounting-a-share-with-the-multiuser-option_assembly_performing-a-multi-user-smb-mount" title="使用多用户选项挂载共享">“使用多用户选项挂载共享”一节</a> 。
			</p><p>以下列表提供了常用的挂载选项：</p><div class="informaltable"><table border="1"><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th valign="top" style="text-align:left">选项</th><th valign="top" style="text-align:left">描述</th></tr></thead><tbody><tr><td valign="top" style="text-align:left"> <p>credentials = <span class="emphasis"><em>file_name</em></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>设置凭证文件的路径。请参阅<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#proc_authenticating-to-an-smb-share-using-a-credentials-file_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux" title="使用凭证文件对SMB共享进行身份验证">“使用凭据文件向SMB共享进行身份验证”一节</a>
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>dir_mode = <span class="emphasis"><em>mode</em></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>如果服务器不支持CIFS UNIX扩展，则设置目录模式。
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>file_mode = <span class="emphasis"><em>mode</em></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>如果服务器不支持CIFS UNIX扩展，则设置文件模式。
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>密码= <span class="emphasis"><em>密码</em></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>设置用于向SMB服务器进行身份验证的密码。或者，使用<code class="literal">credentials</code>选项指定凭证文件。
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>密封</p>
							 </td><td valign="top" style="text-align:left"> <p>为使用SMB 3.0或更高版本协议的连接启用加密支持。因此，请使用<code class="literal">seal</code>以及设置为<code class="literal">vers</code>或更高版本的<code class="literal">3.0</code>安装选项。请参见<a class="xref" href="assembly_mounting-an-smb-share-on-red-hat-enterprise-linux_managing-file-systems.html#example_mounting-a-share-using-an-encrypted-smb30-connection_assembly_mounting-an-smb-share-on-red-hat-enterprise-linux" title="例5.1。使用加密的SMB 3.0连接挂载共享">例5.1“使用加密的SMB 3.0连接挂载共享”</a> 。
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>sec = <span class="emphasis"><em>security_mode</em></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>设置安全模式（如<code class="literal">ntlmsspi</code> ）以启用NTLMv2密码哈希并启用数据包签名。有关支持的值的列表，请参阅<code class="literal">mount.cifs(8)</code>手册页中的选项说明。
							</p>
							 <p>如果服务器不支持<code class="literal">ntlmv2</code>安全模式，请使用<code class="literal">sec=ntlmssp</code> ，这是默认设置。
							</p>
							 <p>出于安全原因，请勿使用不安全的<code class="literal">ntlm</code>安全模式。
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>username = <span class="emphasis"><em>user_name</em></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>设置用于向SMB服务器进行身份验证的用户名。或者，使用<code class="literal">credentials</code>选项指定凭证文件。
							</p>
							 </td></tr><tr><td valign="top" style="text-align:left"> <p>vers = <span class="emphasis"><em>SMB_protocol_version</em></span>
							</p>
							 </td><td valign="top" style="text-align:left"> <p>设置用于与服务器通信的SMB协议版本。
							</p>
							 </td></tr></tbody></table></div><p>有关完整列表，请参见<code class="literal">OPTIONS</code>手册页中的<code class="literal">mount.cifs(8)</code>部分。
			</p></div></div></body></html>