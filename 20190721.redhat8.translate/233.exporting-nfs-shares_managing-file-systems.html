<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 导出NFS共享</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 导出NFS共享</h1></div></div></div><p>作为系统管理员，您可以使用NFS服务器通过网络共享系统上的目录。
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="introduction-to-nfs_exporting-nfs-shares"></a> NFS简介</h1></div></div></div><p>本节介绍NFS服务的基本概念。
			</p><p>网络文件系统（NFS）允许远程主机通过网络安装文件系统，并与这些文件系统进行交互，就好像它们是本地安装的一样。这使您可以将资源整合到网络上的中央服务器上。
			</p><p>NFS服务器引用<code class="literal">/etc/exports</code>配置文件以确定是否允许客户端访问任何导出的文件系统。验证后，用户可以使用所有文件和目录操作。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="supported-nfs-versions_exporting-nfs-shares"></a>支持的NFS版本</h1></div></div></div><p>本节列出了Red Hat Enterprise Linux中支持的NFS版本及其功能。
			</p><p>目前，Red Hat Enterprise Linux 8支持以下主要版本的NFS：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">NFS版本3（NFSv3）支持安全的异步写入，并且在错误处理方面比以前的NFSv2更强大;它还支持64位文件大小和偏移，允许客户端访问超过2 GB的文件数据。
					</li><li class="listitem">NFS版本4（NFSv4）通过防火墙和Internet工作，不再需要<code class="literal">rpcbind</code>服务，支持访问控制列表（ACL），并利用有状态操作。
					</li></ul></div><p>Red Hat不再支持NFS版本2（NFSv2）。
			</p><h3><a id="default_nfs_version_2"></a>默认NFS版本</h3><p>Red Hat Enterprise Linux 8中的默认NFS版本是4.2。NFS客户端默认尝试使用NFSv4.2挂载，当服务器不支持NFSv4.2时，会回退到NFSv4.1。然后，mount将回退到NFSv4.0，然后再回到NFSv3。
			</p><h3><a id="features_of_minor_nfs_versions_2"></a>次要NFS版本的功能</h3><p>以下是Red Hat Enterprise Linux 8中NFSv4.2的功能：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">服务器端副本</span></dt><dd>使NFS服务器能够有效地复制数据，而不会使用<code class="literal">copy_file_range()</code>系统调用浪费网络资源。
						</dd><dt><span class="term">稀疏文件</span></dt><dd>允许文件具有一个或多个<span class="emphasis"><em>孔</em></span> ，这些<span class="emphasis"><em>孔</em></span>是未分配的或未初始化的数据块，仅包含零。NFSv4.2中的<code class="literal">lseek()</code>操作支持<code class="literal">seek_hole()</code>和<code class="literal">seek_data()</code> ，它使应用程序能够映射稀疏文件中的孔的位置。
						</dd><dt><span class="term">空间预订</span></dt><dd>允许存储服务器保留可用空间，从而禁止服务器空间不足。NFSv4.2支持使用<code class="literal">allocate()</code>操作来保留空间，使用<code class="literal">deallocate()</code>操作来保留空间，并使用<code class="literal">fallocate()</code>操作来预分配或释放文件中的空间。
						</dd><dt><span class="term">标记的NFS</span></dt><dd>强制实施数据访问权限，并在客户端和服务器之间为NFS文件系统上的单个文件启用SELinux标签。
						</dd><dt><span class="term">布局增强功能</span></dt><dd>提供<code class="literal">layoutstats()</code>操作，使某些并行NFS（pNFS）服务器能够收集更好的性能统计信息。
						</dd></dl></div><p>以下是NFSv4.1的功能：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">增强网络的性能和安全性，还包括对pNFS的客户端支持。</li><li class="listitem">不再需要单独的TCP连接用于回调，这允许NFS服务器即使在无法联系客户端时也授予授权：例如，当NAT或防火墙干扰时。
					</li><li class="listitem">提供一次语义（重启操作除外），防止以前的问题，如果回复丢失且操作发送两次，某些操作有时会返回不准确的结果。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="the-tcp-and-udp-protocols-in-nfsv3-and-nfsv4_exporting-nfs-shares"></a> NFSv3和NFSv4中的TCP和UDP协议</h1></div></div></div><p>NFSv4要求在IP网络上运行传输控制协议（TCP）。
			</p><p>NFSv3还可以在早期的Red Hat Enterprise Linux版本中使用用户数据报协议（UDP）。在Red Hat Enterprise Linux 8中，不再支持NFS over UDP。默认情况下，NFS服务器中禁用UDP。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="services-required-by-nfs_exporting-nfs-shares"></a> NFS所需的服务</h1></div></div></div><p>本节列出了运行NFS服务器或挂载NFS共享所需的系统服务。红帽企业Linux自动启动这些服务。
			</p><p>红帽企业Linux使用内核级支持和服务进程的组合来提供NFS文件共享。所有NFS版本都依赖于客户端和服务器之间的远程过程调用（RPC）。要共享或装载NFS文件系统，以下服务将根据实现的NFS版本协同工作：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">的nfsd</code></span></dt><dd>NFS服务器为共享NFS文件系统的请求提供服务。
						</dd><dt><span class="term"><code class="literal">RPCBIND</code></span></dt><dd>接受来自本地RPC服务的端口预留。然后，这些端口可用（或通告），以便相应的远程RPC服务可以访问它们。<code class="literal">rpcbind</code>服务响应RPC服务请求并设置与请求的RPC服务的连接。这不适用于NFSv4。
						</dd><dt><span class="term"><code class="literal">rpc.mountd</code></span></dt><dd>NFS服务器使用此过程处理来自NFSv3客户端的<code class="literal">MOUNT</code>请求。它检查NFS服务器当前是否已导出所请求的NFS共享，并允许客户端访问它。如果允许装入请求，则<code class="literal">nfs-mountd</code>服务将回复成功状态，并将此NFS共享的文件句柄提供回NFS客户端。
						</dd><dt><span class="term"><code class="literal">rpc.nfsd</code></span></dt><dd>此过程可以定义服务器通告的显式NFS版本和协议。它与Linux内核一起使用以满足NFS客户端的动态需求，例如每次NFS客户端连接时提供服务器线程。此过程对应于<code class="literal">nfs-server</code>服务。
						</dd><dt><span class="term"><code class="literal">门锁配套</code></span></dt><dd>这是在客户端和服务器上运行的内核线程。它实现了网络锁管理器（NLM）协议，该协议使NFSv3客户端能够锁定服务器上的文件。无论何时运行NFS服务器以及何时挂载NFS文件系统，它都会自动启动。
						</dd><dt><span class="term"><code class="literal">的rpc.statd</code></span></dt><dd>此过程实现网络状态监视器（NSM）RPC协议，该协议在NFS服务器重新启动时通知NFS客户端，而不会正常关闭。<code class="literal">rpc-statd</code>服务由<code class="literal">nfs-server</code>服务自动启动，不需要用户配置。这不适用于NFSv4。
						</dd><dt><span class="term"><code class="literal">rpc.rquotad</code></span></dt><dd>此过程为远程用户提供用户配额信息。<code class="literal">rpc-rquotad</code>服务由<code class="literal">nfs-server</code>服务自动启动，不需要用户配置。
						</dd><dt><span class="term"><code class="literal">rpc.idmapd</code></span></dt><dd><p class="simpara">此过程提供NFSv4客户端和服务器上行调用，它们在线上NFSv4名称（ <code class="literal"><span class="emphasis"><em>user</em></span> @ <span class="emphasis"><em>domain</em></span></code>形式的字符串）与本地UID和GID之间进行映射。要使<code class="literal">idmapd</code>与NFSv4一起运行，必须配置<code class="literal">/etc/idmapd.conf</code>文件。至少应指定<code class="literal">Domain</code>参数，该参数定义NFSv4映射域。如果NFSv4映射域与DNS域名相同，则可以跳过此参数。客户端和服务器必须就NFSv4映射域达成一致，以使ID映射正常运行。
						</p><p class="simpara">只有NFSv4服务器使用<code class="literal">rpc.idmapd</code> ，它由<code class="literal">nfs-idmapd</code>服务启动。NFSv4客户端使用基于密钥环的<code class="literal">nfsidmap</code>实用程序，该实用程序由内核按需调用以执行ID映射。如果<code class="literal">nfsidmap</code>出现问题，客户端将回退到使用<code class="literal">rpc.idmapd</code> 。
						</p></dd></dl></div><h3><a id="the_rpc_services_with_nfsv4_2"></a>使用NFSv4的RPC服务</h3><p>安装和锁定协议已合并到NFSv4协议中。服务器还侦听众所周知的TCP端口2049。因此，NFSv4不需要与<code class="literal">rpcbind</code> ， <code class="literal">lockd</code>和<code class="literal">rpc-statd</code>服务进行交互。NFS服务器上仍然需要<code class="literal">nfs-mountd</code>服务来设置导出，但不涉及任何线上操作。
			</p><h3><a id="additional_resources_5"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">要配置不需要<code class="literal">rpcbind</code>的仅NFSv4服务器，请参阅<a class="xref" href="exporting-nfs-shares_managing-file-systems.html#configuring-an-nfsv4-only-server_exporting-nfs-shares" title="配置仅NFSv4服务器">“配置仅限NFSv4的服务器”一节</a> 。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="nfs-host-name-formats_exporting-nfs-shares"></a> NFS主机名格式</h1></div></div></div><p>本节介绍在挂载或导出NFS共享时可用于指定主机的不同格式。
			</p><p>您可以使用以下格式指定主机：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">单机</span></dt><dd><p class="simpara">以下任一项：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">完全限定的域名（可由服务器解析）</li><li class="listitem">主机名（可以由服务器解析）</li><li class="listitem">一个IP地址。
								</li></ul></div></dd><dt><span class="term">使用通配符指定的系列机器</span></dt><dd><p class="simpara">你可以使用<code class="literal">*</code>或<code class="literal">?</code> 用于指定字符串匹配的字符。
						</p><p class="simpara">通配符不能与IP地址一起使用;但是，如果反向DNS查找失败，它们可能会意外地工作。在完全限定的域名中指定通配符时，通配符中不包含点（ <code class="literal">.</code> ）。例如， <code class="literal">*.example.com</code>包含<code class="literal">one.example.com</code>但不包含<code class="literal">one.two.example.com</code> 。
						</p></dd><dt><span class="term">IP网络</span></dt><dd><p class="simpara">以下任一格式均有效：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									<span class="emphasis"><em><span class="replaceable"><code class="literal">abcd/z</code></span></em></span> ，其中<span class="emphasis"><em><span class="replaceable"><code class="literal">abcd</code></span></em></span>是网络， <span class="emphasis"><em><span class="replaceable"><code class="literal">z</code></span></em></span>是网络掩码中的位数;例如<code class="literal">192.168.0.0/24</code> 。
								</li><li class="listitem">
									<span class="emphasis"><em><span class="replaceable"><code class="literal">abcd/netmask</code></span></em></span> ，其中<span class="emphasis"><em><span class="replaceable"><code class="literal">abcd</code></span></em></span>是网络， <span class="emphasis"><em><span class="replaceable"><code class="literal">netmask</code></span></em></span>是网络掩码;例如， <code class="literal">192.168.100.8/255.255.255.0</code> 。
								</li></ul></div></dd><dt><span class="term">网络组</span></dt><dd><code class="literal">@ <span class="emphasis"><em>group-name</em></span></code>格式，其中<span class="emphasis"><em><span class="replaceable"><code class="literal">group-name</code></span></em></span>是NIS网络组名称。
						</dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="nfs-server-configuration_exporting-nfs-shares"></a> NFS服务器配置</h1></div></div></div><p>本节介绍在NFS服务器上配置导出的两种方法的语法和选项：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">手动编辑<code class="literal">/etc/exports</code>配置文件</li><li class="listitem">在命令行上使用<code class="literal">exportfs</code>实用程序</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="the-etc-exports-configuration-file_exporting-nfs-shares"></a> / etc / exports配置文件</h2></div></div></div><p><code class="literal">/etc/exports</code>文件控制将哪些文件系统导出到远程主机并指定选项。它遵循以下语法规则：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">空行被忽略。
						</li><li class="listitem">要添加注释，请使用井号（ <code class="literal">#</code> ）开始一行。
						</li><li class="listitem">您可以使用反斜杠（ <code class="literal">\</code> ）包装长行。
						</li><li class="listitem">每个导出的文件系统都应该在各自的行上。
						</li><li class="listitem">在导出的文件系统之后放置的任何授权主机列表必须用空格字符分隔。
						</li><li class="listitem">每个主机的选项必须直接放在主机标识符后面的括号中，而主机和第一个括号之间没有任何空格。
						</li></ul></div><h4><a id="export_entry"></a>出口入境</h4><p>导出的文件系统的每个条目都具有以下结构：</p><pre class="screen"><span class="emphasis"><em><span class="replaceable">export</span></em></span> <span class="emphasis"><em><span class="replaceable">host</span></em></span>(<span class="emphasis"><em><span class="replaceable">options</span></em></span>)</pre><p>还可以指定多个主机以及每个主机的特定选项。为此，请将它们列在与空格分隔的列表相同的行中，每个主机名后跟其各自的选项（在括号中），如下所示：</p><pre class="screen"><span class="emphasis"><em><span class="replaceable">export</span></em></span> <span class="emphasis"><em><span class="replaceable">host1</span></em></span>(<span class="emphasis"><em><span class="replaceable">options1</span></em></span>) <span class="emphasis"><em><span class="replaceable">host2</span></em></span>(<span class="emphasis"><em><span class="replaceable">options2</span></em></span>) <span class="emphasis"><em><span class="replaceable">host3</span></em></span>(<span class="emphasis"><em><span class="replaceable">options3</span></em></span>)</pre><p>在这个结构中：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><span class="replaceable">出口</span></em></span></span></dt><dd>要导出的目录</dd><dt><span class="term"><span class="emphasis"><em><span class="replaceable">主办</span></em></span></span></dt><dd>正在共享导出的主机或网络</dd><dt><span class="term"><span class="emphasis"><em><span class="replaceable">选项</span></em></span></span></dt><dd>用于主机的选项</dd></dl></div><div class="example"><a id="idm139870592684128"></a><p class="title"><strong>例3.1。一个简单的/ etc / exports文件</strong></p><div class="example-contents"><p>在最简单的形式中， <code class="literal">/etc/exports</code>文件仅指定导出的目录和允许访问它的主机：</p><pre class="screen">/exported/directory bob.example.com</pre><p>这里， <code class="literal">bob.example.com</code>可以从NFS服务器挂载<code class="literal">/exported/directory/</code> 。由于此示例中未指定任何选项，因此NFS使用默认选项。
					</p></div></div><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p><code class="literal">/etc/exports</code>文件的格式非常精确，特别是在使用空格字符方面。请记住始终使用空格字符将导出的文件系统与主机和主机彼此分开。但是，除注释行外，文件中不应有其他空格字符。
					</p><p>例如，以下两行并不代表同一件事：</p><pre class="screen">/home bob.example.com(rw)
/home bob.example.com (rw)</pre><p>第一行只允许来自<code class="literal">bob.example.com</code>用户对<code class="literal">/home</code>目录进行读写访问。第二行允许来自<code class="literal">bob.example.com</code>用户将目录挂载为只读（默认），而世界其他地方可以将其挂载读/写。
					</p></div><h4><a id="default_options"></a>默认选项</h4><p>导出条目的默认选项是：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">RO</code></span></dt><dd>导出的文件系统是只读的。远程主机无法更改文件系统上共享的数据。要允许主机更改文件系统（即读取和写入），请指定rw选项。
							</dd><dt><span class="term"><code class="literal">同步</code></span></dt><dd>在将先前请求所做的更改写入磁盘之前，NFS服务器不会回复请求。要改为启用异步写入，请指定选项<code class="literal">async</code> 。
							</dd><dt><span class="term"><code class="literal">wdelay</code></span></dt><dd>如果NFS服务器怀疑另一个写请求即将发生，它将延迟写入磁盘。这可以提高性能，因为它减少了必须通过单独的写命令访问磁盘的次数，从而减少了写入开销。要禁用此功能，请指定<code class="literal">no_wdelay</code>选项，该选项仅在同时指定了默认同步选项时才可用。
							</dd><dt><span class="term"><code class="literal">root_squash</code></span></dt><dd><p class="simpara">这可以防止远程（而不是本地）连接的root用户拥有root权限;相反，NFS服务器为它们分配用户ID <code class="literal">nfsnobody</code> 。这有效地“压缩”远程root用户对最低本地用户的能力，防止在远程服务器上可能的未授权写入。要禁用root压缩，请指定<code class="literal">no_root_squash</code>选项。
							</p><p class="simpara">要<code class="literal">all_squash</code>每个远程用户（包括root用户），请使用<code class="literal">all_squash</code>选项。要指定NFS服务器应从特定主机分配给远程用户的用户和组ID，请分别使用<code class="literal">anonuid</code>和<code class="literal">anongid</code>选项，如下所示：</p><pre class="screen"><span class="emphasis"><em><span class="replaceable">export</span></em></span> <span class="emphasis"><em><span class="replaceable">host</span></em></span>(anonuid=<span class="emphasis"><em><span class="replaceable">uid</span></em></span>,anongid=<span class="emphasis"><em><span class="replaceable">gid</span></em></span>)</pre><p class="simpara">这里， <span class="emphasis"><em><span class="replaceable">uid</span></em></span>和<span class="emphasis"><em><span class="replaceable">gid</span></em></span>分别是用户ID号和组ID号。使用<code class="literal">anonuid</code>和<code class="literal">anongid</code>选项可以为远程NFS用户创建特殊的用户和组帐户以进行共享。
							</p></dd></dl></div><p>默认情况下，红帽企业Linux下的NFS支持访问控制列表（ACL）。要禁用此功能，请在导出文件系统时指定<code class="literal">no_acl</code>选项。
				</p><h4><a id="default_and_overridden_options"></a>默认和重写选项</h4><p>必须显式覆盖每个导出文件系统的每个默认值。例如，如果未指定<code class="literal">rw</code>选项，则导出的文件系统将以只读方式共享。以下是<code class="literal">/etc/exports</code>一个示例行，它覆盖了两个默认选项：</p><pre class="screen">/another/exported/directory 192.168.0.3(rw,async)</pre><p>在此示例中， <code class="literal">192.168.0.3</code>可以挂载<code class="literal">/another/exported/directory/</code>读取和写入，并且对磁盘的所有写入都是异步的。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="the-exportfs-utility_exporting-nfs-shares"></a> exportfs实用程序</h2></div></div></div><p><code class="literal">exportfs</code>实用程序使root用户可以选择性地导出或取消导出目录，而无需重新启动NFS服务。如果给出了正确的选项， <code class="literal">exportfs</code>实用程序会将导出的文件系统写入<code class="literal">/var/lib/nfs/xtab</code> 。由于<code class="literal">nfs-mountd</code>服务在决定对文件系统的访问权限时引用<code class="literal">xtab</code>文件，因此对导出的文件系统列表的更改会立即生效。
				</p><h4><a id="common_exportfs_options"></a>常见的exportfs选项</h4><p>以下是<code class="literal">exportfs</code>可用的常用选项列表：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">-r</code></span></dt><dd>通过在<code class="literal">/etc/lib/nfs/xtab</code>构造新的导出列表，导致<code class="literal">/etc/exports</code>列出的所有目录。此选项使用对<code class="literal">/etc/exports</code>所做的任何更改有效刷新导出列表。
							</dd><dt><span class="term"><code class="literal">-一个</code></span></dt><dd>导致所有目录都被导出或取消导出，具体取决于传递给<code class="literal">exportfs</code>其他选项。如果未指定其他选项， <code class="literal">exportfs</code>导出<code class="literal">/etc/exports</code>指定的所有文件系统。
							</dd><dt><span class="term"><code class="literal">-o <span class="emphasis"><em><span class="replaceable">文件系统</span></em></span></code></span></dt><dd>指定要导出的目录，这些目录未在<code class="literal">/etc/exports</code>列出。将<span class="emphasis"><em><span class="replaceable">文件系统</span></em></span>替换为要导出的其他文件系统。这些文件系统的格式必须与<code class="literal">/etc/exports</code>中指定的格式相同。在将导出的文件系统永久添加到导出的文件系统列表之前，此选项通常用于测试导出的文件系统。
							</dd><dt><span class="term"><code class="literal">-一世</code></span></dt><dd>忽略<code class="literal">/etc/exports</code> ;只有从命令行给出的选项才用于定义导出的文件系统。
							</dd><dt><span class="term"><code class="literal">-u</code></span></dt><dd>取消导出所有共享目录。<code class="literal">exportfs -ua</code>命令在保持所有NFS服务启动的同时挂起NFS文件共享。要重新启用NFS共享，请使用<code class="literal">exportfs -r</code> 。
							</dd><dt><span class="term"><code class="literal">-v</code></span></dt><dd>详细操作，执行<code class="literal">exportfs</code>命令时，将更详细地显示正在导出或取消导出的文件系统。
							</dd></dl></div><p>如果没有选项传递给<code class="literal">exportfs</code>实用程序，它将显示当前导出的文件系统的列表。
				</p><h3><a id="additional_resources_6"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">有关指定主机名的不同方法的信息，请参阅<a class="xref" href="exporting-nfs-shares_managing-file-systems.html#nfs-host-name-formats_exporting-nfs-shares" title="NFS主机名格式">“NFS主机名格式”一节</a> 。
						</li><li class="listitem">有关导出选项的完整列表，请参见<code class="literal">exports(5)</code>手册页。
						</li><li class="listitem">有关<code class="literal">exportfs</code>实用程序的更多信息，请参见<code class="literal">exportfs(8)</code>手册页。
						</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="nfs-and-rpcbind_exporting-nfs-shares"></a> NFS和rpcbind</h1></div></div></div><p>本节介绍了NFSv3所需的<code class="literal">rpcbind</code>服务的用途。
			</p><p><code class="literal">rpcbind</code>服务将远程过程调用（RPC）服务映射到它们侦听的端口。RPC进程在启动时通知<code class="literal">rpcbind</code> ，注册他们正在侦听的端口以及他们希望服务的RPC程序编号。然后，客户端系统使用特定的RPC程序编号联系服务器上的<code class="literal">rpcbind</code> 。<code class="literal">rpcbind</code>服务将客户端重定向到正确的端口号，以便它可以与请求的服务进行通信。
			</p><p>由于基于RPC的服务依赖于<code class="literal">rpcbind</code>与传入的客户端请求建立所有连接，因此<code class="literal">rpcbind</code>必须在任何这些服务启动之前可用。
			</p><p><code class="literal">rpcbind</code>访问控制规则会影响所有基于RPC的服务。或者，可以为每个NFS RPC守护程序指定访问控制规则。
			</p><h3><a id="additional_resources_7"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">有关访问控制规则的精确语法，请参见<code class="literal">rpc.mountd(8)</code>和<code class="literal">rpc.statd(8)</code>手册页。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="installing-nfs_exporting-nfs-shares"></a>安装NFS</h1></div></div></div><p>此过程将安装装入或导出NFS共享所需的所有软件包。
			</p><h3><a id="procedure_4"></a>程序</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">安装<code class="literal">nfs-utils</code>包：</p><pre class="screen"># yum install nfs-utils</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="starting-the-nfs-server_exporting-nfs-shares"></a>启动NFS服务器</h1></div></div></div><p>此过程描述如何启动NFS服务器，这是导出NFS共享所必需的。
			</p><h3><a id="prerequisites"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">对于支持NFSv2或NFSv3连接的服务器， <code class="literal">rpcbind</code>服务必须正在运行。要验证<code class="literal">rpcbind</code>是否处于活动状态，请使用以下命令：</p><pre class="screen">$ systemctl status rpcbind</pre><p class="simpara">如果服务已停止，请启动并启用它：</p><pre class="screen">$ systemctl enable --now rpcbind</pre></li></ul></div><h3><a id="procedure_5"></a>程序</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">要启动NFS服务器并使其在引导时自动启动，请使用以下命令：</p><pre class="screen"># systemctl enable --now nfs-server</pre></li></ul></div><h3><a id="additional_resources_8"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">要配置不需要<code class="literal">rpcbind</code>的仅NFSv4服务器，请参阅<a class="xref" href="exporting-nfs-shares_managing-file-systems.html#configuring-an-nfsv4-only-server_exporting-nfs-shares" title="配置仅NFSv4服务器">“配置仅限NFSv4的服务器”一节</a> 。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="troubleshooting-nfs-and-rpcbind_exporting-nfs-shares"></a> NFS和rpcbind故障排除</h1></div></div></div><p>由于<code class="literal">rpcbind</code>服务提供RPC服务与用于与之通信的端口号之间的协调，因此在进行故障排除时使用<code class="literal">rpcbind</code>查看当前RPC服务的状态非常有用。<code class="literal">rpcinfo</code>实用程序显示每个基于RPC的服务，包括端口号，RPC程序号，版本号和IP协议类型（TCP或UDP）。
			</p><h3><a id="procedure_6"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">要确保为<code class="literal">rpcbind</code>启用了正确的基于NFS RPC的服务，请使用以下命令：</p><pre class="screen"># rpcinfo -p</pre><div class="example"><a id="idm139870535080784"></a><p class="title"><strong>例3.2。 rpcinfo -p命令输出</strong></p><div class="example-contents"><p>以下是此命令的示例输出：</p><pre class="screen">   program vers proto   port  service
    100000    4   tcp    111  portmapper
    100000    3   tcp    111  portmapper
    100000    2   tcp    111  portmapper
    100000    4   udp    111  portmapper
    100000    3   udp    111  portmapper
    100000    2   udp    111  portmapper
    100005    1   udp  20048  mountd
    100005    1   tcp  20048  mountd
    100005    2   udp  20048  mountd
    100005    2   tcp  20048  mountd
    100005    3   udp  20048  mountd
    100005    3   tcp  20048  mountd
    100024    1   udp  37769  status
    100024    1   tcp  49349  status
    100003    3   tcp   2049  nfs
    100003    4   tcp   2049  nfs
    100227    3   tcp   2049  nfs_acl
    100021    1   udp  56691  nlockmgr
    100021    3   udp  56691  nlockmgr
    100021    4   udp  56691  nlockmgr
    100021    1   tcp  46193  nlockmgr
    100021    3   tcp  46193  nlockmgr
    100021    4   tcp  46193  nlockmgr</pre></div></div><p class="simpara">如果其中一个NFS服务未正确启动，则<code class="literal">rpcbind</code>将无法将来自该服务的客户端的RPC请求映射到正确的端口。
					</p></li><li class="listitem"><p class="simpara">在许多情况下，如果<code class="literal">rpcinfo</code>输出中不存在NFS，则重新启动NFS会导致服务正确注册<code class="literal">rpcbind</code>并开始工作：</p><pre class="screen"># systemctl restart nfs-server</pre></li></ol></div><h3><a id="additional_resources_9"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">有关更多信息和<code class="literal">rpcinfo</code>选项列表，请参见<code class="literal">rpcinfo(8)</code>手册页。
					</li><li class="listitem">要配置不需要<code class="literal">rpcbind</code>的仅NFSv4服务器，请参阅<a class="xref" href="exporting-nfs-shares_managing-file-systems.html#configuring-an-nfsv4-only-server_exporting-nfs-shares" title="配置仅NFSv4服务器">“配置仅限NFSv4的服务器”一节</a> 。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-the-nfs-server-to-run-behind-a-firewall_exporting-nfs-shares"></a>配置NFS服务器以在防火墙后运行</h1></div></div></div><p>NFS需要<code class="literal">rpcbind</code>服务，该服务为RPC服务动态分配端口，并可能导致配置防火墙规则的问题。此过程描述如何配置NFS服务器以在防火墙后工作。
			</p><h3><a id="procedure_7"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">要允许客户端访问防火墙后面的NFS共享，请在<code class="literal">/etc/nfs.conf</code>文件的<code class="literal">[mountd]</code>部分中设置RPC服务运行的端口：</p><pre class="screen">[mountd]

port=<span class="emphasis"><em><span class="replaceable">port-number</span></em></span></pre><p class="simpara">这会将<code class="literal">-p <span class="emphasis"><em><span class="replaceable">port-number</span></em></span></code>选项添加到<code class="literal">rpc.mount</code>命令行： <code class="literal">rpc.mount -p <span class="emphasis"><em><span class="replaceable">port-number</span></em></span></code> 。
					</p></li><li class="listitem"><p class="simpara">要允许NFSv4.0回调通过防火墙，请设置<code class="literal">/proc/sys/fs/nfs/nfs_callback_tcpport</code>并允许服务器连接到客户端上的该端口。
					</p><p class="simpara">NFSv4.1或更高版本不需要此步骤，纯NFSv4环境中不需要<code class="literal">mountd</code> ， <code class="literal">statd</code>和<code class="literal">lockd</code>的其他端口。
					</p></li><li class="listitem">要指定RPC服务<code class="literal">nlockmgr</code>要使用的端口，请在<code class="literal">/etc/modprobe.d/lockd.conf</code>文件中设置<code class="literal">nlm_tcpport</code>和<code class="literal">nlm_udpport</code>选项的端口号。
					</li><li class="listitem"><p class="simpara">重启NFS服务器：</p><pre class="screen">#  systemctl restart nfs-server</pre><p class="simpara">如果NFS无法启动，请检查<code class="literal">/var/log/messages</code> 。通常，如果指定已在使用的端口号，则NFS无法启动。
					</p></li><li class="listitem"><p class="simpara">确认更改已生效：</p><pre class="screen"># rpcinfo -p</pre></li></ol></div><h3><a id="additional_resources_10"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">要配置不需要<code class="literal">rpcbind</code>的仅NFSv4服务器，请参阅<a class="xref" href="exporting-nfs-shares_managing-file-systems.html#configuring-an-nfsv4-only-server_exporting-nfs-shares" title="配置仅NFSv4服务器">“配置仅限NFSv4的服务器”一节</a> 。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="exporting-rpc-quota-through-a-firewall_exporting-nfs-shares"></a>通过防火墙导出RPC配额</h1></div></div></div><p>如果导出使用磁盘配额的文件系统，则可以使用配额远程过程调用（RPC）服务向NFS客户端提供磁盘配额数据。
			</p><h3><a id="procedure_8"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">启用并启动<code class="literal">rpc-rquotad</code>服务：</p><pre class="screen"># systemctl enable --now rpc-rquotad</pre><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>如果启用了<code class="literal">rpc-rquotad</code>服务，则在启动nfs-server服务后自动启动。
						</p></div></li><li class="listitem"><p class="simpara">要使配额RPC服务在防火墙后可访问，需要打开TCP（或UDP，如果启用了UDP）端口875。默认端口号在<code class="literal">/etc/services</code>文件中定义。
					</p><p class="simpara">您可以通过将<code class="literal">-p port-number</code>附加到<code class="literal">/etc/sysconfig/rpc-rquotad</code>文件中的<code class="literal">RPCRQUOTADOPTS</code>变量来覆盖默认端口号。
					</p></li><li class="listitem">默认情况下，远程主机只能读取配额。如果要允许客户端设置配额，请将<code class="literal">-S</code>选项附加到<code class="literal">/etc/sysconfig/rpc-rquotad</code>文件中的<code class="literal">RPCRQUOTADOPTS</code>变量。
					</li><li class="listitem"><p class="simpara">重新启动<code class="literal">rpc-rquotad</code>以使<code class="literal">/etc/sysconfig/rpc-rquotad</code>文件中的更改生效：</p><pre class="screen"># systemctl restart rpc-rquotad</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enabling-nfs-over-rdma-nfsordma_exporting-nfs-shares"></a>通过RDMA启用NFS（NFSoRDMA）</h1></div></div></div><p>如果存在支持RDMA的硬件，则远程直接内存访问（RDMA）服务在Red Hat Enterprise Linux 8中自动运行。
			</p><h3><a id="procedure_9"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">安装<code class="literal">rdma</code>和<code class="literal">rdma-core</code>软件包：</p><pre class="screen"># yum install rdma rdma-core</pre></li><li class="listitem"><p class="simpara">要启用NFSoRDMA <span class="emphasis"><em>服务器</em></span>模块的自动加载，请在<code class="literal">/etc/rdma/rdma.conf</code>配置文件的新行中添加<code class="literal">SVCRDMA_LOAD=yes</code>选项。
					</p><p class="simpara"><code class="literal">/etc/nfs.conf</code>文件的<code class="literal">[nfsd]</code>部分中的<code class="literal">rdma=20049</code>选项指定NFSoRDMA服务侦听客户端的端口号。RFC 5667标准规定，在通过RDMA提供NFSv4服务时，服务器必须侦听端口<code class="literal">20049</code> 。</p><p class="simpara"><code class="literal">/etc/rdma/rdma.conf</code>文件包含一行默认设置<code class="literal">XPRTRDMA_LOAD=yes</code>选项，该选项请求<code class="literal">rdma</code>服务加载NFSoRDMA <span class="emphasis"><em>客户端</em></span>模块。
					</p></li><li class="listitem"><p class="simpara">重启<code class="literal">nfs-server</code>服务：</p><pre class="screen"># systemctl restart nfs-server</pre></li></ol></div><h3><a id="additional_resources_11"></a>其他资源</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">RFC 5667标准： <a class="link" href="https://tools.ietf.org/html/rfc5667">https</a> ： <a class="link" href="https://tools.ietf.org/html/rfc5667">//tools.ietf.org/html/rfc5667</a> 。</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configuring-an-nfsv4-only-server_exporting-nfs-shares"></a>配置仅NFSv4服务器</h1></div></div></div><p>作为NFS服务器管理员，您可以将NFS服务器配置为仅支持NFSv4，从而最大限度地减少开放端口的数量并在系统上运行服务。
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="benefits-and-drawbacks-of-an-nfsv4-only-server_configuring-an-nfsv4-only-server"></a>仅NFSv4服务器的优点和缺点</h2></div></div></div><p>本节介绍将NFS服务器配置为仅支持NFSv4的优缺点。
				</p><p>默认情况下，NFS服务器支持Red Hat Enterprise Linux 8中的NFSv2，NFSv3和NFSv4连接。但是，您也可以将NFS配置为仅支持NFS 4.0及更高版本。这最大限度地减少了系统上的开放端口和运行服务的数量，因为NFSv4不需要<code class="literal">rpcbind</code>服务来侦听网络。
				</p><p>当NFS服务器配置为仅NFSv4时，尝试使用NFSv2或NFSv3挂载共享的客户端将失败，并显示如下错误：</p><pre class="screen">Requested NFS version or transport protocol is not supported.</pre><p>或者，您也可以禁用侦听<code class="literal">RPCBIND</code> ， <code class="literal">MOUNT</code>和<code class="literal">NSM</code>协议调用，这些调用在仅NFSv4的情况下是不必要的。
				</p><p>禁用这些附加选项的效果是：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">尝试使用NFSv2或NFSv3从服务器挂载共享的客户端无响应。
						</li><li class="listitem">NFS服务器本身无法挂载NFSv2和NFSv3文件系统。
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="nfs-and-rpcbind_configuring-an-nfsv4-only-server"></a> NFS和rpcbind</h2></div></div></div><p>本节介绍了NFSv3所需的<code class="literal">rpcbind</code>服务的用途。
				</p><p><code class="literal">rpcbind</code>服务将远程过程调用（RPC）服务映射到它们侦听的端口。RPC进程在启动时通知<code class="literal">rpcbind</code> ，注册他们正在侦听的端口以及他们希望服务的RPC程序编号。然后，客户端系统使用特定的RPC程序编号联系服务器上的<code class="literal">rpcbind</code> 。<code class="literal">rpcbind</code>服务将客户端重定向到正确的端口号，以便它可以与请求的服务进行通信。
				</p><p>由于基于RPC的服务依赖于<code class="literal">rpcbind</code>与传入的客户端请求建立所有连接，因此<code class="literal">rpcbind</code>必须在任何这些服务启动之前可用。
				</p><p><code class="literal">rpcbind</code>访问控制规则会影响所有基于RPC的服务。或者，可以为每个NFS RPC守护程序指定访问控制规则。
				</p><h4><a id="additional_resources_12"></a>其他资源</h4><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">有关访问控制规则的精确语法，请参见<code class="literal">rpc.mountd(8)</code>和<code class="literal">rpc.statd(8)</code>手册页。
						</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring-the-nfs-server-to-support-only-nfsv4_configuring-an-nfsv4-only-server"></a>配置NFS服务器以仅支持NFSv4</h2></div></div></div><p>此过程描述如何将NFS服务器配置为仅支持NFS 4.0及更高版本。
				</p><h4><a id="procedure_10"></a>程序</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">通过将以下行添加到<code class="literal">/etc/nfs.conf</code>配置文件的<code class="literal">[nfsd]</code>部分来禁用NFSv2和NFSv3：</p><pre class="screen">[nfsd]

vers2=no
vers3=no</pre></li><li class="listitem"><p class="simpara">（可选）禁用侦听<code class="literal">RPCBIND</code> ， <code class="literal">MOUNT</code>和<code class="literal">NSM</code>协议调用，这些调用在仅NFSv4的情况下不是必需的。禁用相关服务：</p><pre class="screen"># systemctl mask --now rpc-statd.service rpcbind.service rpcbind.socket</pre></li><li class="listitem"><p class="simpara">重启NFS服务器：</p><pre class="screen"># systemctl restart nfs-server</pre></li></ol></div><p>一旦启动或重新启动NFS服务器，更改将立即生效。
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="verifying-the-nfsv4-only-configuration_configuring-an-nfsv4-only-server"></a>验证仅NFSv4配置</h2></div></div></div><p>此过程描述如何使用<code class="literal">netstat</code>实用程序验证是否在仅NFSv4模式下配置了NFS服务器。
				</p><h4><a id="procedure_11"></a>程序</h4><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">使用<code class="literal">netstat</code>实用程序列出侦听TCP和UDP协议的服务：</p><pre class="screen"># netstat --listening --tcp --udp</pre><div class="example"><a id="idm139870467981824"></a><p class="title"><strong>例3.3。仅在NFSv4服务器上输出</strong></p><div class="example-contents"><p>以下是仅NFSv4服务器上的<code class="literal">netstat</code>输出示例;侦听<code class="literal">RPCBIND</code> ， <code class="literal">MOUNT</code>和<code class="literal">NSM</code>也被禁用。在这里， <code class="literal">nfs</code>是唯一的侦听NFS服务：</p><pre class="screen"># netstat --listening --tcp --udp

Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:ssh             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:nfs             0.0.0.0:*               LISTEN
tcp6       0      0 [::]:ssh                [::]:*                  LISTEN
tcp6       0      0 [::]:nfs                [::]:*                  LISTEN
udp        0      0 localhost.locald:bootpc 0.0.0.0:*</pre></div></div><div class="example"><a id="idm139870576605664"></a><p class="title"><strong>例3.4。在配置仅NFSv4服务器之前输出</strong></p><div class="example-contents"><p>相比之下，配置仅NFSv4服务器之前的<code class="literal">netstat</code>输出包括<code class="literal">sunrpc</code>和<code class="literal">mountd</code>服务：</p><pre class="screen"># netstat --listening --tcp --udp

Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address State
tcp        0      0 0.0.0.0:ssh             0.0.0.0:*       LISTEN
tcp        0      0 0.0.0.0:40189           0.0.0.0:*       LISTEN
tcp        0      0 0.0.0.0:46813           0.0.0.0:*       LISTEN
tcp        0      0 0.0.0.0:nfs             0.0.0.0:*       LISTEN
tcp        0      0 0.0.0.0:sunrpc          0.0.0.0:*       LISTEN
tcp        0      0 0.0.0.0:mountd          0.0.0.0:*       LISTEN
tcp6       0      0 [::]:ssh                [::]:*          LISTEN
tcp6       0      0 [::]:51227              [::]:*          LISTEN
tcp6       0      0 [::]:nfs                [::]:*          LISTEN
tcp6       0      0 [::]:sunrpc             [::]:*          LISTEN
tcp6       0      0 [::]:mountd             [::]:*          LISTEN
tcp6       0      0 [::]:45043              [::]:*          LISTEN
udp        0      0 localhost:1018          0.0.0.0:*
udp        0      0 localhost.locald:bootpc 0.0.0.0:*
udp        0      0 0.0.0.0:mountd          0.0.0.0:*
udp        0      0 0.0.0.0:46672           0.0.0.0:*
udp        0      0 0.0.0.0:sunrpc          0.0.0.0:*
udp        0      0 0.0.0.0:33494           0.0.0.0:*
udp6       0      0 [::]:33734              [::]:*
udp6       0      0 [::]:mountd             [::]:*
udp6       0      0 [::]:sunrpc             [::]:*
udp6       0      0 [::]:40243              [::]:*</pre></div></div></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="related-information-exporting-nfs-shares"></a>相关信息</h1></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Linux NFS wiki： <a class="link" href="https://linux-nfs.org">https</a> ： <a class="link" href="https://linux-nfs.org">//linux-nfs.org</a>
					</li></ul></div></div></div></body></html>