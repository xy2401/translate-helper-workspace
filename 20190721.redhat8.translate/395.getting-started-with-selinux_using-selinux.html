<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. SELinux入门</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. SELinux入门</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="introduction-to-selinux_getting-started-with-selinux"></a> SELinux简介</h1></div></div></div><p>安全性增强型Linux（SELinux）提供了额外的系统安全性。SELinux从根本上回答了这个问题： <span class="emphasis"><em>可以&lt;subject&gt;对&lt;object&gt;执行&lt;action&gt;吗？</em></span>例如： <span class="emphasis"><em>Web服务器可以访问用户主目录中的文件吗？</em></span>
			</p><p>基于用户，组和其他权限的标准访问策略（称为自由访问控制（DAC））不允许系统管理员创建全面且细粒度的安全策略，例如将特定应用程序限制为仅查看日志文件，同时允许其他应用程序将新数据附加到日志文件中。
			</p><p>SELinux实现强制访问控制（MAC）。每个进程和系统资源都有一个称为<span class="emphasis"><em>SELinux上下文</em></span>的特殊安全标签。SELinux上下文（有时称为<span class="emphasis"><em>SELinux标签</em></span> ）是一个标识符，它抽象出系统级详细信息并关注实体的安全属性。这不仅提供了在SELinux策略中引用对象的一致方式，而且还消除了在其他识别方法中可以找到的任何歧义。例如，文件可以在使用绑定装入的系统上具有多个有效路径名。
			</p><p>SELinux策略在一系列规则中使用这些上下文，这些规则定义了进程如何相互交互以及各种系统资源。默认情况下，除非规则明确授予访问权限，否则策略不允许任何交互。
			</p><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>请记住，在DAC规则之后检查SELinux策略规则。如果DAC规则首先拒绝访问，则不使用SELinux策略规则，这意味着如果传统的DAC规则阻止访问，则不会记录SELinux拒绝。
				</p></div><p>SELinux上下文有几个字段：用户，角色，类型和安全级别。SELinux类型信息在SELinux策略中可能是最重要的，因为定义进程和系统资源之间允许的交互的最常见策略规则使用SELinux类型而不是完整的SELinux上下文。SELinux类型以<code class="literal">_t</code>结尾。例如，Web服务器的类型名称为<code class="literal">httpd_t</code> 。通常在<code class="literal">/var/www/html/</code>找到的文件和目录的类型上下文是<code class="literal">httpd_sys_content_t</code> 。通常在<code class="literal">/tmp</code>和<code class="literal">/var/tmp/</code>找到的文件和目录的类型上下文是<code class="literal">tmp_t</code> 。Web服务器端口的类型上下文是<code class="literal">http_port_t</code> 。
			</p><p>有一个策略规则允许Apache（作为<code class="literal">httpd_t</code>运行的Web服务器进程）使用通常位于<code class="literal">/var/www/html/</code>和其他Web服务器目录（ <code class="literal">httpd_sys_content_t</code> ）中的上下文来访问文件和目录。对于通常在<code class="literal">/tmp</code>和<code class="literal">/var/tmp/</code>找到的文件，策略中没有允许规则，因此不允许访问。使用SELinux，即使Apache遭到攻击，恶意脚本获得访问权限，它仍然无法访问<code class="literal">/tmp</code>目录。
			</p><div class="figure"><a id="fig-intro-httpd-mysqld"></a><p class="title"><strong>图1.1。SELinux如何帮助以安全的方式运行Apache和MariaDB。</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/selinux-intro-apache-mariadb.png" alt="SELinux_Apache_MariaDB_example"></div></div></div><p>如前面的方案所示，SELinux允许运行为<code class="literal">httpd_t</code>的Apache进程访问<code class="literal">/var/www/html/</code>目录，并且它拒绝访问<code class="literal">/data/mysql/</code>目录的相同进程，因为<code class="literal">httpd_t</code>没有允许规则和<code class="literal">mysqld_db_t</code>类型上下文）。另一方面，作为<code class="literal">mysqld_t</code>运行的MariaDB进程能够访问<code class="literal">/data/mysql/</code>目录，SELinux也正确地拒绝使用<code class="literal">mysqld_t</code>类型访问标记为<code class="literal">httpd_sys_content_t</code>的<code class="literal">/var/www/html/</code>目录的<code class="literal">httpd_sys_content_t</code> 。
			</p><h3><a id="additional_resources"></a>其他资源</h3><p>要更好地了解SELinux基本概念，请参阅以下文档：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">selinux(8)</code>手册页。
					</li><li class="listitem">
						<a class="link" href="https://people.redhat.com/duffy/selinux/selinux-coloring-book_A4-Stapled.pdf">SELinux着色书</a>
					</li></ul></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<a class="link" href="http://selinuxproject.org/page/FAQ">SELinux Wiki常见问题解答</a>
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="benefits-of-selinux_getting-started-with-selinux"></a>运行SELinux的好处</h1></div></div></div><p>SELinux具有以下优势：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">标记了所有进程和文件。SELinux策略规则定义了进程如何与文件交互，以及进程如何相互交互。仅当存在特定允许的SELinux策略规则时，才允许访问。
					</li><li class="listitem">细粒度的访问控制。超越由用户自行控制并基于Linux用户和组ID的传统UNIX权限，SELinux访问决策基于所有可用信息，例如SELinux用户，角色，类型和（可选）安全级别。
					</li><li class="listitem">SELinux策略在行政上定义并在系统范围内实施。
					</li><li class="listitem">改进了针对权限提升攻击的缓解措施。进程在域中运行，因此彼此分离。SELinux策略规则定义进程如何访问文件和其他进程。如果进程受到攻击，则攻击者只能访问该进程的正常功能，并且只能访问已配置进程的文件。例如，如果Apache HTTP Server遭到入侵，则攻击者无法使用该进程读取用户主目录中的文件，除非添加或配置了特定的SELinux策略规则以允许此类访问。
					</li><li class="listitem">SELinux可用于强制执行数据机密性和完整性，以及保护进程免受不受信任的输入的影响。
					</li></ul></div><p>但是，SELinux不是：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">防毒软件，</li><li class="listitem">替换密码，防火墙和其他安全系统，</li><li class="listitem">一体化安全解决方案。
					</li></ul></div><p>SELinux旨在增强现有的安全解决方案，而不是取代它们。即使在运行SELinux时，重要的是继续遵循良好的安全实践，例如使用难以猜测的密码和防火墙保持软件最新。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="selinux-examples_getting-started-with-selinux"></a> SELinux的例子</h1></div></div></div><p>以下示例演示了SELinux如何提高安全性：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">默认操作是拒绝。如果不存在SELinux策略规则以允许访问，例如打开文件的进程，则拒绝访问。
					</li><li class="listitem">SELinux可以限制Linux用户。SELinux策略中存在许多受限制的SELinux用户。Linux用户可以映射到受限的SELinux用户，以利用应用于他们的安全规则和机制。例如，将Linux用户映射到SELinux <code class="literal">user_u</code>用户会导致Linux用户无法运行，除非另外配置了用户ID（setuid）应用程序（如<code class="literal">sudo</code>和<code class="literal">su</code> ，以及防止他们执行潜在恶意文件和应用程序在其主目录中。
					</li><li class="listitem">增加了流程和数据分离。SELinux <span class="emphasis"><em>域</em></span>的概念允许定义哪些进程可以访问某些文件和目录。例如，在运行SELinux时，除非另行配置，否则攻击者无法破坏Samba服务器，然后使用该Samba服务器作为攻击媒介来读取和写入其他进程（如MariaDB数据库）使用的文件。
					</li><li class="listitem">SELinux有助于减轻配置错误造成的损害。域名系统（DNS）服务器通常在所谓的区域传输中彼此之间复制信息。攻击者可以使用区域传输来使用虚假信息更新DNS服务器。在Red Hat Enterprise Linux中将Berkeley Internet名称域（BIND）作为DNS服务器运行时，即使管理员忘记限制哪些服务器可以执行区域传输，默认的SELinux策略也会阻止使用区域更新区域文件<a href="#ftn.idm140064316617104" class="footnote" id="idm140064316617104"><sup class="footnote">[1]</sup></a>通过<code class="literal">named</code>守护进程本身的BIND以及其他进程进行传输。
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="selinux-architecture_getting-started-with-selinux"></a> SELinux架构和包</h1></div></div></div><p>SELinux是一个内置于Linux内核中的Linux安全模块（LSM）。内核中的SELinux子系统由安全策略驱动，该策略由管理员控制并在引导时加载。SELinux拦截系统上所有与安全相关的内核级访问操作，并在加载的安全策略的上下文中进行检查。如果加载的策略允许操作，则继续。否则，操作被阻止，进程收到错误。
			</p><p>SELinux决策（例如允许或禁止访问）被缓存。此缓存称为访问向量缓存（AVC）。使用这些缓存决策时，需要更少检查SELinux策略规则，从而提高性能。请记住，如果DAC规则首先拒绝访问，则SELinux策略规则不起作用。原始审计消息记录到<code class="literal">/var/log/audit/audit.log</code> ，它们以<code class="literal">type=AVC</code>字符串开头。
			</p><p>在Red Hat Enterprise Linux 8中，系统服务由<code class="literal">systemd</code>守护程序控制; <code class="literal">systemd</code>启动和停止所有服务，用户和进程使用<code class="literal">systemctl</code>实用程序与<code class="literal">systemd</code>进行通信。<code class="literal">systemd</code>守护程序可以查阅SELinux策略并检查调用进程的标签和调用者尝试管理的单元文件的标签，然后询问SELinux是否允许调用者访问。这种方法加强了对关键系统功能的访问控制，包括启动和停止系统服务。
			</p><p><code class="literal">systemd</code>守护程序也可用作SELinux Access Manager。它检索运行<code class="literal">systemctl</code>的进程的标签或向<code class="literal">systemd</code>发送<code class="literal">D-Bus</code>消息的进程。然后守护程序查找进程要配置的单元文件的标签。最后，如果SELinux策略允许进程标签和单元文件标签之间的特定访问， <code class="literal">systemd</code>可以从内核检索信息。这意味着需要与<code class="literal">systemd</code>进行特定服务交互的受损应用程序现在可以由SELinux限制。策略编写者还可以使用这些细粒度控件来限制管理员。
			</p><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>为避免不正确的SELinux标记和后续问题，请确保使用<code class="literal">systemctl start</code>命令启动服务。
				</p></div><p>红帽企业版Linux 8提供了以下用于使用SELinux的软件包：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">策略： <code class="literal">selinux-policy-targeted</code> ， <code class="literal">selinux-policy-mls</code>
					</li><li class="listitem">工具： <code class="literal">policycoreutils</code> ， <code class="literal">policycoreutils-gui</code> ， <code class="literal">libselinux-utils</code> ， <code class="literal">policycoreutils-python-utils</code> ， <code class="literal">setools-console</code> ， <code class="literal">checkpolicy</code>
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="selinux-states-and-modes_getting-started-with-selinux"></a> SELinux状态和模式</h1></div></div></div><p>SELinux可以以三种模式之一运行：强制执行，允许执行或禁用。
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">强制模式是默认的，推荐的操作模式;在执行模式下，SELinux正常运行，在整个系统上强制执行加载的安全策略。
					</li><li class="listitem">在许可模式下，系统就像SELinux强制执行加载的安全策略一样，包括标记对象和在日志中发出访问拒绝条目，但它实际上并不否认任何操作。虽然不建议用于生产系统，但许可模式对SELinux策略开发和调试很有帮助。
					</li><li class="listitem">强烈建议不要使用残疾人模式;系统不仅避免强制执行SELinux策略，还避免标记任何持久对象（如文件），从而使将来很难启用SELinux。
					</li></ul></div><p>使用<code class="literal">setenforce</code>实用程序在强制模式和许可模式之间切换。使用<code class="literal">setenforce</code>进行的更改不会在重新启动后持续存在。要更改为强制模式，请输入<code class="literal">setenforce 1</code>命令作为Linux root用户。要更改为许可模式，请输入<code class="literal">setenforce 0</code>命令。使用<code class="literal">getenforce</code>实用程序查看当前的SELinux模式：</p><pre class="screen"># getenforce
Enforcing</pre><pre class="screen"># setenforce 0
# getenforce
Permissive</pre><pre class="screen"># setenforce 1
# getenforce
Enforcing</pre><p>在Red Hat Enterprise Linux中，您可以在系统以强制模式运行时将各个域设置为许可模式。例如，要使<span class="emphasis"><em>httpd_t</em></span>域允许：</p><pre class="screen"># semanage permissive -a <span class="emphasis"><em>httpd_t</em></span></pre><p>请注意，许可域是一种强大的工具，可能会危及系统的安全性。Red Hat建议谨慎使用允许域，例如，在调试特定方案时。
			</p></div><div class="footnotes"><br><hr><div id="ftn.idm140064316617104" class="footnote"><p><a href="#idm140064316617104" class="simpara"><sup class="simpara">[1]</sup></a>包含DNS服务器使用的信息（如主机名到IP地址映射<a href="#idm140064316617104" class="simpara"><sup class="simpara">）的</sup></a>文本文件。
						</p></div></div></div></body></html>