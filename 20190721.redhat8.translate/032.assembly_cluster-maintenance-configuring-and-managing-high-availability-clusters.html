<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 执行集群维护</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 执行集群维护</h1></div></div></div><p>为了在群集的节点上执行维护，您可能需要停止或移动在该群集上运行的资源和服务。或者，您可能需要停止群集软件，同时保持服务不变。Pacemaker提供了多种执行系统维护的方法。
		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">如果需要在群集中停止节点，同时继续在另一个节点上提供该群集上运行的服务，则可以将群集节点置于待机模式。处于待机模式的节点不再能够托管资源。节点上当前活动的任何资源都将移动到另一个节点，如果没有其他节点有资格运行该资源，则会停止。有关待机模式的信息，请参阅<a class="link" href="assembly_cluster-maintenance-configuring-and-managing-high-availability-clusters.html#proc_stopping-individual-node-cluster-maintenance" title="将节点置于待机模式">将节点置于待机模式</a> 。
				</li><li class="listitem"><p class="simpara">如果需要将单个资源从当前运行的节点移出而不停止该资源，则可以使用<code class="literal">pcs resource move</code>命令将<code class="literal">pcs resource move</code>到其他节点。有关<code class="literal">pcs resource move</code>命令的信息，请参阅<a class="link" href="assembly_cluster-maintenance-configuring-and-managing-high-availability-clusters.html#assembly_manually-move-resources-cluster-maintenance" title="手动移动群集资源">手动移动群集资源</a> 。
				</p><p class="simpara">执行<code class="literal">pcs resource move</code>命令时，会向资源添加约束，以防止它在当前运行的节点上运行。当您准备好移回资源时，可以执行<code class="literal">pcs resource clear</code>或<code class="literal">pcs constraint delete</code>命令来删除约束。但是，这并不一定会将资源移回原始节点，因为此时资源可以运行的位置取决于最初配置资源的方式。您可以使用<code class="literal">pcs resource relocate run</code>命令将<code class="literal">pcs resource relocate run</code>到其首选节点，如将<a class="link" href="assembly_cluster-maintenance-configuring-and-managing-high-availability-clusters.html#proc_moving-resource-to-preferred-node-manually-move-resources" title="将资源移动到其首选节点">资源移动到其首选节点中所述</a> 。
				</p></li><li class="listitem">如果需要完全停止正在运行的资源并阻止群集再次启动它，则可以使用<code class="literal">pcs resource disable</code>命令。有关<code class="literal">pcs resource disable</code>命令的信息，请参阅<a class="link" href="assembly_cluster-maintenance-configuring-and-managing-high-availability-clusters.html#proc_disabling-resources-cluster-maintenance" title="启用，禁用和禁止群集资源">启用，禁用和禁止群集资源</a> 。
				</li><li class="listitem">如果要阻止Pacemaker对资源执行任何操作（例如，如果要在执行资源维护时禁用恢复操作，或者需要重新加载<code class="literal">/etc/sysconfig/pacemaker</code>设置），请使用<code class="literal">pcs resource unmanage</code>命令，如将<a class="link" href="assembly_cluster-maintenance-configuring-and-managing-high-availability-clusters.html#proc_unmanaging-resources-cluster-maintenance" title="将资源设置为非托管模式">资源设置为非托管模式中所述</a> 。Pacemaker远程连接资源永远不应该是不受管理的。
				</li><li class="listitem">如果需要将群集置于不启动或停止服务的状态，则可以设置<code class="literal">maintenance-mode</code>群集属性。将群集置于维护模式会自动取消管理所有资源。有关将群集置于维护模式的信息，请参阅<a class="link" href="assembly_cluster-maintenance-configuring-and-managing-high-availability-clusters.html#proc_setting-maintenance-mode-cluster-maintenance" title="将群集置于维护模式">将群集置于维护模式</a> 。
				</li><li class="listitem">如果需要更新组成RHEL高可用性和弹性存储附加组件的软件包，则可以一次更新一个节点上的软件包，也可以整个集群更新软件包，如<a class="link" href="assembly_cluster-maintenance-configuring-and-managing-high-availability-clusters.html#proc_updating-cluster-packages-cluster-maintenance" title="更新RHEL高可用性集群">更新Red Hat Enterprise Linux中所述。高可用性集群</a> 。
				</li><li class="listitem">如果需要在Pacemaker远程节点上执行维护，则可以通过禁用远程节点资源从群集中删除该节点，如<a class="link" href="assembly_cluster-maintenance-configuring-and-managing-high-availability-clusters.html#proc_upgrading-remote-nodes-cluster-maintenance" title="升级远程节点和来宾节点">升级远程节点和来宾节点中所述</a> 。
				</li></ul></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_stopping-individual-node-cluster-maintenance"></a>将节点置于待机模式</h1></div></div></div><p>当群集节点处于待机模式时，该节点将无法再承载资源。节点上当前活动的任何资源都将移动到另一个节点。
			</p><p>以下命令将指定的节点置于待机模式。如果指定<code class="literal">--all</code> ，则此命令将所有节点置于待机模式。
			</p><p>更新资源的包时可以使用此命令。您还可以在测试配置时使用此命令，以在不实际关闭节点的情况下模拟恢复。
			</p><pre class="literallayout">pcs node standby <span class="emphasis"><em>node</em></span> | --all</pre><p>以下命令从指定模式中删除指定的节点。运行此命令后，指定的节点就可以托管资源。如果指定<code class="literal">--all</code> ，则此命令将从待机模式中删除所有节点。
			</p><pre class="literallayout">pcs node unstandby <span class="emphasis"><em>node</em></span> | --all</pre><p>请注意，执行<code class="literal">pcs node standby</code>命令时，这会阻止资源在指示的节点上运行。执行<code class="literal">pcs node unstandby</code>命令时，这允许资源在指定的节点上运行。这不一定会将资源移回指定的节点;资源可以在该点运行的位置取决于您最初配置资源的方式。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="assembly_manually-move-resources-cluster-maintenance"></a>手动移动群集资源</h1></div></div></div><p>您可以覆盖群集并强制资源从其当前位置移动。有两种情况你想要这样做：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">当节点处于维护状态时，您需要将该节点上运行的所有资源移动到其他节点</li><li class="listitem">当需要移动单独指定的资源时</li></ul></div><p>要将节点上运行的所有资源移动到其他节点，请将节点置于待机模式。
			</p><p>您可以通过以下任一方式移动单独指定的资源。
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">您可以使用<code class="literal">pcs resource move</code>命令将资源从当前正在运行的节点上移出。
					</li><li class="listitem">您可以使用<code class="literal">pcs resource relocate run</code>命令将资源移动到其首选节点，具体取决于当前群集状态，约束，资源位置和其他设置。
					</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="proc_moving-resource-from-node-manually-move-resources"></a>从当前节点移动资源</h2></div></div></div><p>要将资源从当前运行的节点移出，请使用以下命令，指定所定义<span class="emphasis"><em>资源</em></span>的resource_id。如果要指示运行要移动的资源的节点，请指定<code class="literal">destination_node</code> 。
				</p><pre class="literallayout">pcs resource move <span class="emphasis"><em>resource_id</em></span> [<span class="emphasis"><em>destination_node</em></span>] [--master] [lifetime=<span class="emphasis"><em>lifetime</em></span>]</pre><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>执行<code class="literal">pcs resource move</code>命令时，会向资源添加约束，以防止它在当前运行的节点上运行。您可以执行<code class="literal">pcs resource clear</code>或<code class="literal">pcs constraint delete</code>命令来删除约束。这不一定会将资源移回原始节点;资源可以在该点运行的位置取决于您最初配置资源的方式。
					</p></div><p>如果指定<code class="literal">pcs resource move</code>命令的<code class="literal">--master</code>参数，则约束的范围仅限于主角色，您必须指定<span class="emphasis"><em>master_id</em></span>而不是<span class="emphasis"><em>resource_id</em></span> 。
				</p><p>您可以选择为<code class="literal">pcs resource move</code>命令配置<code class="literal">lifetime</code>参数，以指示约束应保留的时间段。您可以根据ISO 8601中定义的格式指定<code class="literal">lifetime</code>参数的单位，这要求您将单位指定为大写字母，例如Y（多年），M（表示月份），W（表示周），D（天数），H（小时），M（分钟）和S（秒）。
				</p><p>要将分钟单位（M）与月份单位（M）区分开来，必须在以分钟为单位指定值之前指定PT。例如，5M的<code class="literal">lifetime</code>参数表示5个月的间隔，而PT5M的<code class="literal">lifetime</code>参数表示5分钟的间隔。
				</p><p><code class="literal">cluster-recheck-interval</code>群集属性定义的间隔检查<code class="literal">lifetime</code>参数。默认情况下，此值为15分钟。如果您的配置要求更频繁地检查此参数，则可以使用以下命令重置此值。
				</p><pre class="literallayout">pcs property set cluster-recheck-interval=<span class="emphasis"><em>value</em></span></pre><p>您可以选择为<code class="literal">pcs resource move</code>命令配置<code class="literal">--wait[= <span class="emphasis"><em>n</em></span> ]</code>参数，以指示在资源启动时返回0之前等待资源在目标节点上启动的秒数，如果资源有，则为1还没开始。如果未指定n，则将使用默认资源超时。
				</p><p>以下命令将资源<code class="literal">resource1</code>移动到节点<code class="literal">example-node2</code>并阻止它移回到最初运行它的节点一小时三十分钟。
				</p><pre class="literallayout">pcs resource move resource1 example-node2 lifetime=PT1H30M</pre><p>以下命令将资源<code class="literal">resource1</code>移动到节点<code class="literal">example-node2</code>并阻止它移回其最初运行30分钟的节点。
				</p><pre class="literallayout">pcs resource move resource1 example-node2 lifetime=PT30M</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="proc_moving-resource-to-preferred-node-manually-move-resources"></a>将资源移动到其首选节点</h2></div></div></div><p>资源移动后，由于故障转移或管理员手动移动节点，即使在导致故障转移的情况得到纠正后，也不一定会移回原始节点。要将资源重定位到其首选节点，请使用以下命令。优选节点由当前集群状态，约束，资源位置和其他设置确定，并且可以随时间改变。
				</p><pre class="literallayout">pcs resource relocate run [<span class="emphasis"><em>resource1</em></span>] [<span class="emphasis"><em>resource2</em></span>] ...</pre><p>如果未指定任何资源，则会将所有资源重定位到其首选节点。
				</p><p>此命令计算每个资源的首选节点，同时忽略资源粘性。在计算首选节点后，它会创建位置约束，这将导致资源移动到其首选节点。移动资源后，将自动删除约束。要删除<code class="literal">pcs resource relocate run</code>命令创建的所有约束，可以输入<code class="literal">pcs resource relocate clear</code>命令。要显示资源的当前状态及其忽略资源粘性的最佳节点，请输入<code class="literal">pcs resource relocate show</code>命令。
				</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_disabling-resources-cluster-maintenance"></a>启用，禁用和禁止群集资源</h1></div></div></div><p>除了<code class="literal">pcs resource move</code>和<code class="literal">pcs resource relocate</code>命令之外，还可以使用各种其他命令来控制群集资源的行为。
			</p><p>您可以使用以下命令手动停止正在运行的资源并阻止群集再次启动它。根据配置的其余部分（约束，选项，故障等），资源可能仍保持启动状态。如果指定<code class="literal">--wait</code>选项，则<span class="strong"><strong><span class="application">pcs</span></strong></span>将等待“n”秒以使资源停止，然后在资源停止时返回0，如果资源未停止则返回1。如果未指定“n”，则默认为60分钟。
			</p><pre class="literallayout">pcs resource disable <span class="emphasis"><em>resource_id</em></span> [--wait[=<span class="emphasis"><em>n</em></span>]]</pre><p>您可以使用以下命令允许群集启动资源。根据配置的其余部分，资源可能会保持停止状态。如果指定<code class="literal">--wait</code>选项，则<span class="strong"><strong><span class="application">pcs</span></strong></span>将等待“n”秒以启动资源，然后在资源启动时返回0，如果资源尚未启动则返回1。如果未指定“n”，则默认为60分钟。
			</p><pre class="literallayout">pcs resource enable <span class="emphasis"><em>resource_id</em></span> [--wait[=<span class="emphasis"><em>n</em></span>]]</pre><p>使用以下命令可防止资源在指定节点上运行，或在未指定节点的情况下在当前节点上运行。
			</p><pre class="literallayout">pcs resource ban <span class="emphasis"><em>resource_id</em></span> [<span class="emphasis"><em>node</em></span>] [--master] [lifetime=<span class="emphasis"><em>lifetime</em></span>] [--wait[=<span class="emphasis"><em>n</em></span>]]</pre><p>请注意，执行<code class="literal">pcs resource ban</code>命令时，会向资源添加-INFINITY位置约束，以防止它在指定节点上运行。您可以执行<code class="literal">pcs resource clear</code>或<code class="literal">pcs constraint delete</code>命令来删除约束。这不一定会将资源移回指定的节点;资源可以在该点运行的位置取决于您最初配置资源的方式。
			</p><p>如果指定<code class="literal">pcs resource ban</code>命令的<code class="literal">--master</code>参数，则约束的范围仅限于主角色，您必须指定<span class="emphasis"><em>master_id</em></span>而不是<span class="emphasis"><em>resource_id</em></span> 。
			</p><p>您可以选择为<code class="literal">pcs resource ban</code>命令配置<code class="literal">lifetime</code>参数，以指示约束应保留的时间段。
			</p><p>您可以选择为<code class="literal">pcs resource ban</code>命令配置<code class="literal">--wait[= <span class="emphasis"><em>n</em></span> ]</code>参数，以指示在资源启动时返回0之前等待资源在目标节点上启动的秒数，如果资源有，则返回1还没开始。如果未指定n，则将使用默认资源超时。
			</p><p>您可以使用<code class="literal">pcs resource</code>命令的<code class="literal">debug-start</code>参数强制指定资源在当前节点上启动，忽略群集建议并打印启动资源的输出。这主要用于调试资源;群集上的启动资源（几乎）始终由Pacemaker完成，而不是直接使用<code class="literal">pcs</code>命令完成。如果资源未启动，通常是由于资源配置错误（您在系统日志中调试），阻止资源启动的约束或资源被禁用。您可以使用此命令来测试资源配置，但通常不应该使用它来启动集群中的资源。
			</p><p><code class="literal">debug-start</code>命令的格式如下。
			</p><pre class="literallayout">pcs resource debug-start <span class="emphasis"><em>resource_id</em></span></pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_unmanaging-resources-cluster-maintenance"></a>将资源设置为非托管模式</h1></div></div></div><p>当资源处于<code class="literal">unmanaged</code>模式时，资源仍在配置中，但Pacemaker不管理资源。
			</p><p>以下命令将指示的资源设置<code class="literal">unmanaged</code>模式。
			</p><pre class="literallayout">pcs resource unmanage <span class="emphasis"><em>resource1</em></span>  [<span class="emphasis"><em>resource2</em></span>] ...</pre><p>以下命令将资源设置为<code class="literal">managed</code>模式，这是默认状态。
			</p><pre class="literallayout">pcs resource manage <span class="emphasis"><em>resource1</em></span>  [<span class="emphasis"><em>resource2</em></span>] ...</pre><p>您可以使用<code class="literal">pcs resource manage</code>或<code class="literal">pcs resource unmanage</code>命令指定资源组的名称。该命令将作用于组中的所有资源，以便您可以使用单个命令将组中的所有资源设置为<code class="literal">managed</code>或非<code class="literal">unmanaged</code>模式，然后单独管理所包含的资源。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_setting-maintenance-mode-cluster-maintenance"></a>将群集置于维护模式</h1></div></div></div><p>当群集处于维护模式时，除非另有说明，否则群集不会启动或停止任何服务。完成维护模式后，群集会对任何服务的当前状态进行健全性检查，然后停止或启动任何需要它的服务。
			</p><p>要将群集置于维护模式，请使用以下命令将<code class="literal">maintenance-mode</code> cluster属性设置为<code class="literal">true</code> 。
			</p><pre class="literallayout"># <code class="literal">pcs property set maintenance-mode=true</code></pre><p>要从维护模式中删除群集，请使用以下命令将<code class="literal">maintenance-mode</code> cluster属性设置为<code class="literal">false</code> 。
			</p><pre class="literallayout"># <code class="literal">pcs property set maintenance-mode=false</code></pre><p>您可以使用以下命令从配置中删除集群属性。
			</p><pre class="literallayout">pcs property unset <span class="emphasis"><em>property</em></span></pre><p>或者，您可以通过将<code class="literal">pcs property set</code>命令的value字段留空来从配置中删除集群属性。这会将该属性恢复为其默认值。例如，如果先前已将<code class="literal">symmetric-cluster</code>属性设置为<code class="literal">false</code> ，则以下命令将从配置中删除您设置的值，并将<code class="literal">symmetric-cluster</code>的值恢复为<code class="literal">true</code> ，这是其默认值。
			</p><pre class="literallayout"># <code class="literal">pcs property set symmetric-cluster=</code></pre></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_updating-cluster-packages-cluster-maintenance"></a>更新RHEL高可用性集群</h1></div></div></div><p>更新组成RHEL高可用性和弹性存储加载项的软件包可以通过以下两种方式之一单独或作为一个整体来完成：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<span class="emphasis"><em>滚动更新</em></span> ：从服务中一次删除一个节点，更新其软件，然后将其集成回群集。这允许群集在每个节点更新时继续提供服务和管理资源。
					</li><li class="listitem">
						<span class="emphasis"><em>整个群集更新</em></span> ：停止整个群集，将更新应用于所有节点，然后重新启动群集。
					</li></ul></div><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p>在执行红帽企业LInux高可用性和弹性存储群集的软件更新过程时，确保在启动这些更新之前，任何将进行更新的节点都不是群集的活动成员，这一点至关重要。
				</p></div><p>有关每种方法的完整说明以及更新要遵循的过程，请参阅<a class="link" href="https://access.redhat.com/articles/2059253/">将软件更新应用于RHEL高可用性或弹性存储群集的建议实践</a> 。
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="proc_upgrading-remote-nodes-cluster-maintenance"></a>升级远程节点和来宾节点</h1></div></div></div><p>如果在活动的远程节点或来宾节点上停止<code class="literal">pacemaker_remote</code>服务，则群集将在停止节点之前正常地从节点迁移资源。这允许您执行软件升级和其他例行维护过程，而无需从群集中删除节点。但是，一旦<code class="literal">pacemaker_remote</code>关闭，群集将立即尝试重新连接。如果未在资源的监视器超时内重新启动<code class="literal">pacemaker_remote</code> ，则群集将认为监视器操作失败。
			</p><p>如果您希望在活动的Pacemaker Remote节点上停止<code class="literal">pacemaker_remote</code>服务时避免监视器故障，则可以使用以下过程将节点从群集中取出，然后再执行可能会停止<code class="literal">pacemaker_remote</code>任何系统管理
			</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">使用<code class="literal">pcs resource disable <span class="emphasis"><em>resourcename</em></span></code>停止节点的连接资源，这会将所有服务移出节点。对于访客节点，这也将停止VM，因此必须在群集外部启动VM（例如，使用<code class="literal">virsh</code> ）以执行任何维护。
					</li><li class="listitem">执行所需的维护。
					</li><li class="listitem">准备好将节点返回到群集时，请使用<code class="literal">pcs resource enable</code>重新启用<code class="literal">pcs resource enable</code> 。
					</li></ol></div></div></div></body></html>