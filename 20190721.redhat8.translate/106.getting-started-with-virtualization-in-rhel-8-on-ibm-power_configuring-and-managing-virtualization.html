<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 在IBM POWER上使用RHEL 8中的虚拟化入门</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 在IBM POWER上使用RHEL 8中的虚拟化入门</h1></div></div></div><p>在IBM POWER8或POWER9硬件上使用RHEL 8时，可以使用KVM虚拟化。但是，在系统上<a class="link" href="getting-started-with-virtualization-in-rhel-8-on-ibm-power_configuring-and-managing-virtualization.html#enabling-virtualization-on-ibm-power_getting-started-with-virtualization-in-rhel-8-on-ibm-power" title="在IBM POWER上启用虚拟化">启用KVM管理程序</a>时，与AMD64和Intel64体系结构上的虚拟化相比，需要额外的步骤。某些RHEL 8虚拟化<a class="link" href="getting-started-with-virtualization-in-rhel-8-on-ibm-power_configuring-and-managing-virtualization.html#how-virtualization-on-ibm-power-differs-from-amd64-and-intel64_getting-started-with-virtualization-in-rhel-8-on-ibm-power" title="How virtualization on IBM POWER differs from AMD64 and Intel 64">功能</a>在IBM POWER上也具有<a class="link" href="getting-started-with-virtualization-in-rhel-8-on-ibm-power_configuring-and-managing-virtualization.html#how-virtualization-on-ibm-power-differs-from-amd64-and-intel64_getting-started-with-virtualization-in-rhel-8-on-ibm-power" title="IBM POWER上的虚拟化与AMD64和Intel 64的不同之处">不同或受限制的功能</a> 。</p><p>除了以下部分中的信息之外，在IBM POWER上使用虚拟化的工作方式与AMD64和Intel 64上的相同。因此，您可以查看其他RHEL 8虚拟化文档，以获取有关在IBM POWER上使用虚拟化的更多信息。</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="enabling-virtualization-on-ibm-power_getting-started-with-virtualization-in-rhel-8-on-ibm-power"></a>在IBM POWER上启用虚拟化</h1></div></div></div><p>要设置KVM管理程序并能够在运行RHEL 8的IBM POWER8或IBM POWER9系统上创建虚拟机（VM），请按照以下说明操作。
			</p><h3><a id="prerequisites_10"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">RHEL 8已在主机上安装并注册。
					</li><li class="listitem"><p class="simpara">可以使用以下系统资源：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">主机的6 GB可用磁盘空间，以及每个目标guest虚拟机的另外6 GB。</li><li class="listitem">主机使用2 GB RAM，每个预定客户使用另外2 GB RAM。</li></ul></div></li><li class="listitem"><p class="simpara">您的CPU机器类型必须支持IBM POWER虚拟化。
					</p><p class="simpara">要验证这一点，请查询<code class="literal">/proc/cpuinfo</code>文件中的平台信息。
					</p><pre class="literallayout"># <span class="strong"><strong>grep ^platform /proc/cpuinfo/</strong></span>
platform        : PowerNV</pre><p class="simpara">如果此命令的输出包含<code class="literal">PowerNV</code>条目，则表明您正在运行PowerNV计算机类型，并且可以在IBM POWER上使用虚拟化。</p></li></ul></div><h3><a id="procedure_11"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">加载KVM-HV内核模块</p><pre class="literallayout"># <span class="strong"><strong>modprobe kvm_hv</strong></span></pre></li><li class="listitem"><p class="simpara">验证是否已加载KVM内核模块</p><pre class="literallayout"># <span class="strong"><strong>lsmod | grep kvm</strong></span></pre><p class="simpara">如果KVM成功加载，则此命令的输出包括<code class="literal">kvm_hv</code> 。</p></li><li class="listitem"><p class="simpara">在虚拟化模块中安装软件包：</p><pre class="literallayout"># <span class="strong"><strong>yum module install virt</strong></span></pre></li><li class="listitem"><p class="simpara">安装<code class="literal">virt-install</code>软件包：</p><pre class="literallayout"># <span class="strong"><strong>yum install virt-install</strong></span></pre></li><li class="listitem"><p class="simpara">验证您的系统是否已准备好成为虚拟化主机：</p><pre class="literallayout"># <span class="strong"><strong>virt-host-validate</strong></span>
[...]
QEMU: Checking if device /dev/vhost-net exists                          : PASS
QEMU: Checking if device /dev/net/tun exists                            : PASS
QEMU: Checking for cgroup 'memory' controller support                   : PASS
QEMU: Checking for cgroup 'memory' controller mount-point               : PASS
[...]
QEMU: Checking for cgroup 'blkio' controller support                    : PASS
QEMU: Checking for cgroup 'blkio' controller mount-point                : PASS
QEMU: Checking if IOMMU is enabled by kernel                            : PASS</pre></li><li class="listitem"><p class="simpara">如果所有<span class="strong"><strong>virt-host-validate</strong></span>检查都返回<code class="literal">PASS</code>值，则系统已准备好<a class="link" href="getting-started-with-virtualization-in-rhel-8_configuring-and-managing-virtualization.html#assembly_creating-virtual-machines_virt-getting-started" title="创建虚拟机">创建虚拟机</a> 。
					</p><p class="simpara">如果任何检查返回<code class="literal">FAIL</code>值，请按照显示的说明解决问题。
					</p><p class="simpara">如果任何检查返回<code class="literal">WARN</code>值，请考虑按照显示的说明来改进虚拟化功能。
					</p></li></ol></div><h3><a id="additional_information_2"></a>附加信息</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">请注意，如果主机CPU不支持虚拟化， <span class="strong"><strong>virt-host-validate将</strong></span>生成以下输出：</p><pre class="literallayout">QEMU: Checking for hardware virtualization: FAIL (Only emulated CPUs are available, performance will be significantly limited)</pre><p class="simpara">但是，尝试在此类主机系统上创建VM将失败，而不是出现性能问题。
					</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="how-virtualization-on-ibm-power-differs-from-amd64-and-intel64_getting-started-with-virtualization-in-rhel-8-on-ibm-power"></a> IBM POWER上的虚拟化与AMD64和Intel 64的不同之处</h1></div></div></div><p>IBM POWER系统上的RHEL 8中的KVM虚拟化与AMD64和Intel 64系统上的KVM在许多方面不同，特别是：</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">内存要求</span></dt><dd>IBM POWER上的VM消耗更多内存。因此，IBM POWER主机上虚拟机（VM）的建议最小内存分配为2GB RAM。</dd><dt><span class="term">显示协议</span></dt><dd><p class="simpara">IBM POWER系统不支持SPICE协议。要显示VM的图形输出，请使用<code class="literal">VNC</code>协议。此外，仅支持以下虚拟图形卡设备：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									<code class="literal">vga</code> - 仅支持<code class="literal">-vga std</code>模式而不支持<code class="literal">-vga cirrus</code>模式。
								</li><li class="listitem">
									<code class="literal">virtio-vga</code>
								</li><li class="listitem">
									<code class="literal">virtio-gpu</code>
								</li></ul></div></dd><dt><span class="term">SMBIOS</span></dt><dd>SMBIOS配置不可用</dd><dt><span class="term">内存分配错误</span></dt><dd><p class="simpara">POWER8 VM（包括兼容模式VM）可能会失败，并出现类似于以下内容的错误：</p><pre class="literallayout">qemu-kvm: Failed to allocate KVM HPT of order 33 (try smaller maxmem?): Cannot allocate memory</pre><p class="simpara">这在使用RHEL 7.3及以前作为来宾操作系统的VM上更有可能发生。</p><p class="simpara">要解决此问题，请通过向主机的内核命令行添加<code class="literal">kvm_cma_resv_ratio=<span class="emphasis"><em>memory</em></span></code>来增加可用于guest虚拟机的散列页表（HPT）的CMA内存池，其中<span class="emphasis"><em>memory</em></span>是应为CMA池保留的主机内存的百分比（默认为5）。
						</p></dd><dt><span class="term">巨大的页面</span></dt><dd><p class="simpara">透明大页面（THP）不会在IBM POWER8 VM上提供任何显着的性能优势。但是，IBM POWER9虚拟机可以按预期受益于THP。
						</p><p class="simpara">此外，IBM POWER8系统上静态大页面的大小为16 MiB和16 GiB，而AMD64，Intel 64和IBM POWER9则为2 MiB和1 GiB。因此，要将配置有静态大页面的VM从IBM POWER8主机迁移到IBM POWER9主机，必须首先在VM上设置1GiB大页面。</p></dd><dt><span class="term">KVM-时钟</span></dt><dd>不必为IBM POWER9上的VM中的时间管理配置<code class="literal">kvm-clock</code>服务。
						</dd><dt><span class="term">pvpanic</span></dt><dd><p class="simpara">IBM POWER9系统不支持<code class="literal">pvpanic</code>设备。但是，此架构上默认提供并激活了等效功能。要在VM中启用它，请使用带有<code class="literal">&lt;on_crash&gt;</code>值的<code class="literal">preserve</code> XML配置元素。
						</p><p class="simpara">此外，请确保从<code class="literal">&lt;panic&gt;</code>部分删除<code class="literal">&lt;devices&gt;</code>元素，因为它的存在可能导致VM无法在IBM POWER系统上引导。
						</p></dd><dt><span class="term">单线程主机</span></dt><dd>在IBM POWER8系统上，主机必须以<span class="strong"><strong>单线程模式运行</strong></span>以支持VM。如果安装了<span class="emphasis"><em>qemu-kvm</em></span>软件包，则会自动配置。但是，在单线程主机上运行的VM仍可以使用多个线程。
						</dd><dt><span class="term">外围设备</span></dt><dd><p class="simpara">IBM POWER系统不支持AMD64和Intel 64系统上支持的许多外围设备，或者支持使用其他设备作为替代。
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">不支持用于PCI-E层次结构的设备，包括<code class="literal">ioh3420</code>和<code class="literal">xio3130-downstream</code> 。此功能由<code class="literal">spapr-pci-host-bridge</code>设备提供的多个独立PCI根桥替代。
								</li><li class="listitem">不支持UHCI和EHCI PCI控制器。请改用OHCI和XHCI控制器。
								</li><li class="listitem">不支持IDE设备，包括虚拟IDE CD-ROM（ <code class="literal">ide-cd</code> ）和虚拟IDE磁盘（ <code class="literal">ide-hd</code> ）。请改用<code class="literal">virtio-scsi</code>和<code class="literal">virtio-blk</code>设备。
								</li><li class="listitem">不支持仿真PCI NIC（ <code class="literal">rtl8139</code> ）。请改用<code class="literal">virtio-net</code>设备。
								</li><li class="listitem">不支持声音设备，包括<code class="literal">intel-hda</code> ， <code class="literal">hda-output</code>和<code class="literal">AC97</code> 。
								</li><li class="listitem">不支持USB重定向设备，包括<code class="literal">usb-redir</code>和<code class="literal">usb-tablet</code> 。
								</li></ul></div></dd><dt><span class="term">v2v和p2v</span></dt><dd><code class="literal">virt-v2v</code>和<code class="literal">virt-p2v</code>实用程序仅支持AMD64和Intel 64架构。因此，IBM POWER不提供它们。</dd></dl></div></div></div></body></html>