<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 4. Advanced topics</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="advanced-topics"/>Chapter 4. Advanced topics</h1></div></div></div><p>
			This section covers topics that are beyond the scope of the introductory tutorial but are useful in real-world RPM packaging.
		</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="signing-packages_advanced-topics"/>Signing packages</h1></div></div></div><p>
				Packages are signed to make sure no third party can alter their content. A user can add an additional layer of security by using the HTTPS protocol when downloading the package.
			</p><p>
				There are three ways to sign a package:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<a class="xref" href="advanced-topics.html#adding-a-signature_signing-packages" title="Adding a signature to an already existing package">the section called “Adding a signature to an already existing package”</a>.
					</li><li class="listitem">
						<a class="xref" href="advanced-topics.html#replacing-the-signature_signing-packages" title="Replacing the signature on an already existing package">the section called “Replacing the signature on an already existing package”</a>.
					</li><li class="listitem">
						<a class="xref" href="advanced-topics.html#signing-a-package-at-build-time_signing-packages" title="Signing a package at build-time">the section called “Signing a package at build-time”</a>.
					</li></ul></div><p>
				To be able to sign a package, you need to create a GNU Privacy Guard (GPG) key as described in <a class="xref" href="advanced-topics.html#creating-a-gpg-key_signing-packages" title="Creating a GPG key">the section called “Creating a GPG key”</a>.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="creating-a-gpg-key_signing-packages"/>Creating a GPG key</h2></div></div></div><h4><a id="procedure_19"/>Procedure</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Generate a GNU Privacy Guard (GPG) key pair:
						</p><pre class="literallayout"># gpg --gen-key</pre></li><li class="listitem"><p class="simpara">
							Confirm and see the generated key:
						</p><pre class="literallayout"># gpg --list-keys</pre></li><li class="listitem"><p class="simpara">
							Export the public key:
						</p><pre class="literallayout"># gpg --export -a '&lt;Key_name&gt;' &gt; RPM-GPG-KEY-pmanager</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								Include the real name that you have selected for the key instead of &lt;Key_name&gt;.
							</p></div></li><li class="listitem"><p class="simpara">
							Import the exported public key into an RPM database:
						</p><pre class="literallayout"># rpm --import RPM-GPG-KEY-pmanager</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="adding-a-signature_signing-packages"/>Adding a signature to an already existing package</h2></div></div></div><p>
					This section describes the most usual case when a package is built without a signature. The signature is added just before the release of the package.
				</p><p>
					To add a signature to a package, use the <code class="literal">--addsign</code> option provided by the <code class="literal">rpm-sign</code> package.
				</p><p>
					Having more than one signature enables to record the package’s path of ownership from the package builder to the end-user.
				</p><h4><a id="procedure_20"/>Procedure</h4><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							Add a signature to a package:
						</p><pre class="literallayout">$ rpm --addsign blather-7.9-1.x86_64.rpm</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								You are supposed to enter the password to unlock the secret key for the signature.
							</p></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="checking-the-signatures-of-a-package-with-multiple-signatures_signing-packages"/>Checking the signatures of a package with multiple signatures</h2></div></div></div><h4><a id="procedure_21"/>Procedure</h4><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							To check the signatures of a package with multiple signatures, run the following:
						</p><pre class="literallayout">$ rpm --checksig blather-7.9-1.x86_64.rpm
blather-7.9-1.x86_64.rpm: size pgp pgp md5 OK</pre><p class="simpara">
							The two <code class="literal">pgp</code> strings in the output of the <code class="literal">rpm --checksig</code> command show that the package has been signed twice.
						</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="a-practical-example-of-adding-a-signature_signing-packages"/>A practical example of adding a signature to an already existing package</h2></div></div></div><p>
					This section describes an example situation where adding a signature to an already existing package might be useful.
				</p><p>
					A division of a company creates a package and signs it with the division’s key. The company’s headquarters then checks the package’s signature and adds the corporate signature to the package, stating that the signed package is authentic.
				</p><p>
					With two signatures, the package makes its way to a retailer. The retailer checks the signatures and, if they match, adds their signature as well.
				</p><p>
					The package now makes its way to a company that wants to deploy the package. After checking every signature on the package, they know that it is an authentic copy. Depending on the deploying company’s internal controls, they may choose to add their own signature, to inform their employees that the package has received their corporate approval
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="replacing-the-signature_signing-packages"/>Replacing the signature on an already existing package</h2></div></div></div><p>
					This procedure describes how to change the public key without having to rebuild each package.
				</p><h4><a id="procedure_22"/>Procedure</h4><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							To change the public key, run the following:
						</p><pre class="literallayout">$ rpm --resign blather-7.9-1.x86_64.rpm</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								You are supposed to enter the password to unlock the secret key for the signature.
							</p></div></li></ul></div><p>
					The <code class="literal">--resign</code> option also enables you to change the public key for multiple packages, as shown in the following procedure.
				</p><h4><a id="procedure_23"/>Procedure</h4><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							To change the public key for multiple packages, execute:
						</p><pre class="literallayout">$ rpm --resign b*.rpm</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								You are supposed to enter the password to unlock the secret key for the signature.
							</p></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="signing-a-package-at-build-time_signing-packages"/>Signing a package at build-time</h2></div></div></div><h4><a id="procedure_24"/>Procedure</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Build the package with the <code class="literal">rpmbuild</code> command:
						</p><pre class="literallayout">$ rpmbuild blather-7.9.spec</pre></li><li class="listitem"><p class="simpara">
							Sign the package with the <code class="literal">rpmsign</code> command using the <code class="literal">--addsign</code> option:
						</p><pre class="literallayout">$ rpmsign --addsign blather-7.9-1.x86_64.rpm</pre></li><li class="listitem">
							Optionally, verify the signature of a package:
						</li></ol></div><pre class="literallayout">$ rpm --checksig blather-7.9-1.x86_64.rpm
blather-7.9-1.x86_64.rpm: size pgp md5 OK</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						When building and signing multiple packages, use the following syntax to avoid entering the Pretty Good Privacy (PGP) passphrase multiple times.
					</p><pre class="literallayout">$ rpmbuild -ba --sign b*.spec</pre><p>
						Note that you are supposed to enter the password to unlock the secret key for the signature.
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="more-on-macros_advanced-topics"/>More on macros</h1></div></div></div><p>
				This section covers selected built-in RPM Macros. For an exhaustive list of such macros, see <a class="link" href="http://rpm.org/user_doc/macros.html">RPM Documentation</a>.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="defining-your-own-macros_more-on-macros"/>Defining your own macros</h2></div></div></div><p>
					The following section describes how to create a custom macro.
				</p><h4><a id="procedure_25"/>Procedure</h4><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							Include the following line in the RPM SPEC file:
						</p><pre class="literallayout">%global &lt;name&gt;[(opts)] &lt;body&gt;</pre></li></ul></div><p>
					All whitespace surrounding <code class="literal">\</code> is removed. Name may be composed of alphanumeric characters, and the character <code class="literal">_</code> and must be at least 3 characters in length. Inclusion of the <code class="literal">(opts)</code> field is optional:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<code class="literal">Simple</code> macros do not contain the <code class="literal">(opts)</code> field. In this case, only recursive macro expansion is performed.
						</li><li class="listitem">
							<code class="literal">Parametrized</code> macros contain the <code class="literal">(opts)</code> field. The <code class="literal">opts</code> string between parentheses is passed to <code class="literal">getopt(3)</code> for <code class="literal">argc/argv</code> processing at the beginning of a macro invocation.
						</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						Older RPM SPEC files use the <code class="literal">%define &lt;name&gt; &lt;body&gt;</code> macro pattern instead. The differences between <code class="literal">%define</code> and <code class="literal">%global</code> macros are as follows:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								<code class="literal">%define</code> has local scope. It applies to a specific part of a SPEC file. The body of a <code class="literal">%define</code> macro is expanded when used.
							</li><li class="listitem">
								<code class="literal">%global</code> has global scope. It applies to an entire SPEC file. The body of a <code class="literal">%global</code> macro is expanded at definition time.
							</li></ul></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
						Macros are evaluated even if they are commented out or the name of the macro is given into the <code class="literal">%changelog</code> section of the SPEC file. To comment out a macro, use <code class="literal">%%</code>. For example: <code class="literal">%%global</code>.
					</p></div><h4><a id="additional_resources_5"/>Additional resources</h4><p>
					For comprehensive information on macros capabilities, see <a class="link" href="http://rpm.org/user_doc/macros.html">RPM Documentation</a>.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="using-the-setup-macro_more-on-macros"/>Using the %setup macro</h2></div></div></div><p>
					This section describes how to build packages with source code tarballs using different variants of the <code class="literal">%setup</code> macro. Note that the macro variants can be combined The <code class="literal">rpmbuild</code> output illustrates standard behavior of the <code class="literal">%setup</code> macro. At the beginning of each phase, the macro outputs <code class="literal">Executing(%…​)</code>, as shown in the below example.
				</p><div class="example"><a id="idm140116105892208"/><p class="title"><strong>Example 4.1. Example <code class="literal">%setup</code> macro output</strong></p><div class="example-contents"><pre class="literallayout">Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.DhddsG</pre><p>
						The shell output is set with <code class="literal">set -x</code> enabled. To see the content of <code class="literal">/var/tmp/rpm-tmp.DhddsG</code>, use the <code class="literal">--debug</code> option because <code class="literal">rpmbuild</code> deletes temporary files after a successful build. This displays the setup of environment variables followed by for example:
					</p><pre class="literallayout">cd '/builddir/build/BUILD'
rm -rf 'cello-1.0'
/usr/bin/gzip -dc '/builddir/build/SOURCES/cello-1.0.tar.gz' | /usr/bin/tar -xof -
STATUS=$?
if [ $STATUS -ne 0 ]; then
  exit $STATUS
fi
cd 'cello-1.0'
/usr/bin/chmod -Rf a+rX,u+w,g-w,o-w .</pre></div></div><p>
					The <code class="literal">%setup</code> macro:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Ensures that we are working in the correct directory.
						</li><li class="listitem">
							Removes residues of previous builds.
						</li><li class="listitem">
							Unpacks the source tarball.
						</li><li class="listitem">
							Sets up some default privileges.
						</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-the-setup-q-option"/>Using the %setup -q macro</h3></div></div></div><p>
						The <code class="literal">-q</code> option limits the verbosity of the <code class="literal">%setup</code> macro. Only <code class="literal">tar -xof</code> is executed instead of <code class="literal">tar -xvvof</code>. Use this option as the first option.
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-the-setup-n-option"/>Using the %setup -n macro</h3></div></div></div><p>
						The <code class="literal">-n</code> option is used to specify the name of the directory from expanded tarball.
					</p><p>
						This is used in cases when the directory from expanded tarball has a different name from what is expected (<code class="literal">%{name}-%{version}</code>), which can lead to an error of the <code class="literal">%setup</code> macro.
					</p><p>
						For example, if the package name is <code class="literal">cello</code>, but the source code is archived in <code class="literal">hello-1.0.tgz</code> and contains the <code class="literal">hello/</code> directory, the SPEC file content needs to be as follows:
					</p><pre class="literallayout">Name: cello
Source0: <a class="link" href="https://example.com/%{name}/release/hello-%{version}.tar.gz">https://example.com/%{name}/release/hello-%{version}.tar.gz</a>
…
%prep
%setup -n hello</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-the-setup-c-option"/>Using the %setup -c macro</h3></div></div></div><p>
						The <code class="literal">-c</code> option is used if the source code tarball does not contain any subdirectories and after unpacking, files from an archive fills the current directory.
					</p><p>
						The <code class="literal">-c</code> option then creates the directory and steps into the archive expansion as shown below:
					</p><pre class="literallayout">/usr/bin/mkdir -p cello-1.0
cd 'cello-1.0'</pre><p>
						The directory is not changed after archive expansion.
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-the-setup-dt-option"/>Using the %setup -D and %setup -T macros</h3></div></div></div><p>
						The <code class="literal">-D</code> option disables deleting of source code directory, and is particularly useful if the <code class="literal">%setup</code> macro is used several times. With the <code class="literal">-D</code> option, the following lines are not used:
					</p><pre class="literallayout">rm -rf 'cello-1.0'</pre><p>
						The <code class="literal">-T</code> option disables expansion of the source code tarball by removing the following line from the script:
					</p><pre class="literallayout">/usr/bin/gzip -dc '/builddir/build/SOURCES/cello-1.0.tar.gz' | /usr/bin/tar -xvvof -</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-the-setup-ab-option"/>Using the %setup -a and %setup -b macros</h3></div></div></div><p>
						The <code class="literal">-a</code> and <code class="literal">-b</code> options expand specific sources:
					</p><p>
						The <code class="literal">-b</code> option stands for <code class="literal">before</code>, and it expands specific sources before entering the working directory. The <code class="literal">-a</code> option stands for <code class="literal">after</code>, and it expands those sources after entering. Their arguments are source numbers from the SPEC file preamble.
					</p><p>
						In the following example, the <code class="literal">cello-1.0.tar.gz</code> archive contains an empty <code class="literal">examples</code> directory. The examples are shipped in a separate <code class="literal">examples.tar.gz</code> tarball and they expand into the directory of the same name. In this case, use <code class="literal">-a 1</code>, if you want to expand <code class="literal">Source1</code> after entering the working directory:
					</p><pre class="literallayout">Source0: <a class="link" href="https://example.com/%{name}/release/%{name}-%{version}.tar.gz">https://example.com/%{name}/release/%{name}-%{version}.tar.gz</a>
Source1: examples.tar.gz
…
%prep
%setup -a 1</pre><p>
						In the following example, examples are provided in a separate <code class="literal">cello-1.0-examples.tar.gz</code> tarball, which expands into <code class="literal">cello-1.0/examples</code>. In this case, use <code class="literal">-b 1</code>, to expand <code class="literal">Source1</code> before entering the working directory:
					</p><pre class="literallayout">Source0: <a class="link" href="https://example.com/%{name}/release/%{name}-%{version}.tar.gz">https://example.com/%{name}/release/%{name}-%{version}.tar.gz</a>
Source1: %{name}-%{version}-examples.tar.gz
…
%prep
%setup -b 1</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="common-rpm-macros-in-the-files-section_more-on-macros"/>Common RPM macros in the %files section</h2></div></div></div><p>
					This section lists advanced RPM Macros that are needed in the <code class="literal">%files</code> section of a SPEC file.
				</p><div class="table"><a id="idm140116105694720"/><p class="title"><strong>Table 4.1. Advanced RPM Macros in the <code class="literal">%files</code> section</strong></p><div class="table-contents"><table summary="Advanced RPM Macros in the %files section" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><thead><tr><th style="text-align: left" valign="top">Macro</th><th style="text-align: left" valign="top">Definition</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									%license
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The macro identifies the file listed as a LICENSE file and it will be installed and labeled as such by RPM. Example: <code class="literal">%license LICENSE</code>
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									%doc
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The macro identifies a file listed as documentation and it will be installed and labeled as such by RPM. The macro is used for documentation about the packaged software and also for code examples and various accompanying items. In the event code examples are included, care should be taken to remove executable mode from the file. Example: <code class="literal">%doc README</code>
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									%dir
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The macro ensures that the path is a directory owned by this RPM. This is important so that the RPM file manifest accurately knows what directories to clean up on uninstall. Example: <code class="literal">%dir %{_libdir}/%{name}</code>
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									%config(noreplace)
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The macro ensures that the following file is a configuration file and therefore should not be overwritten (or replaced) on a package install or update if the file has been modified from the original installation checksum. If there is a change, the file will be created with <code class="literal">.rpmnew</code> appended to the end of the filename upon upgrade or install so that the pre-existing or modified file on the target system is not modified. Example: <code class="literal">%config(noreplace) %{_sysconfdir}/%{name}/%{name}.conf</code>
								</p>
								 </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="displaying-the-built-in-macros_more-on-macros"/>Displaying the built-in macros</h2></div></div></div><p>
					Red Hat Enterprise Linux provides multiple built-in RPM macros.
				</p><h4><a id="procedure_26"/>Procedure</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
							To display all built-in RPM macros, run:
						</p><pre class="literallayout">rpm --showrc</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								The output is quite sizeable. To narrow the result, use the command above with the <code class="literal">grep</code> command.
							</p></div></li><li class="listitem"><p class="simpara">
							To find information about the RPMs macros for your system’s version of RPM, run:
						</p><pre class="literallayout">rpm -ql rpm</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								RPM macros are the files titled <code class="literal">macros</code> in the output directory structure.
							</p></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="rpm-distribution-macros_more-on-macros"/>RPM distribution macros</h2></div></div></div><p>
					Different distributions provide different sets of recommended RPM macros based on the language implementation of the software being packaged or the specific guidelines of the distribution.
				</p><p>
					The sets of recommended RPM macros are often provided as RPM packages, ready to be installed with the <code class="literal">yum</code> package manager.
				</p><p>
					Once installed, the macro files can be found in the <code class="literal">/usr/lib/rpm/macros.d/</code> directory.
				</p><p>
					To display the raw RPM macro definitions, run:
				</p><pre class="literallayout">rpm --showrc</pre><p>
					The above output displays the raw RPM macro definitions.
				</p><p>
					To determine what a macro does and how it can be helpful when packaging RPMs, run the <code class="literal">rpm --eval</code> command with the name of the macro used as its argument:
				</p><pre class="literallayout">rpm --eval %{_MACRO}</pre><p>
					For more information, see the <code class="literal">rpm</code> man page.
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-the-custom-macros_more-on-macros"/>Creating custom macros</h3></div></div></div><p>
						You can override the distribution macros in the <code class="literal">~/.rpmmacros</code> file with your custom macros. Any changes that you make affect every build on your machine.
					</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
							Defining any new macros in the <code class="literal">~/.rpmmacros</code> file is not recommended. Such macros would not be present on other machines, where users may want to try to rebuild your package.
						</p></div><p>
						To override a macro, run :
					</p><pre class="literallayout">%_topdir /opt/some/working/directory/rpmbuild</pre><p>
						You can create the directory from the example above, including all subdirectories through the <code class="literal">rpmdev-setuptree</code> utility. The value of this macro is by default <code class="literal">~/rpmbuild</code>.
					</p><pre class="literallayout">%_smp_mflags -l3</pre><p>
						The macro above is often used to pass to Makefile, for example <code class="literal">make %{?_smp_mflags}</code>, and to set a number of concurrent processes during the build phase. By default, it is set to <code class="literal">-jX</code>, where <code class="literal">X</code> is a number of cores. If you alter the number of cores, you can speed up or slow down a build of packages.
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="epoch-scriplets-and-triggers_advanced-topics"/>Epoch, Scriptlets and Triggers</h1></div></div></div><p>
				This section covers <code class="literal">Epoch</code>, <code class="literal">Scriptlets</code>, and <code class="literal">Triggers</code>, which represent advanced directives for RMP SPEC files.
			</p><p>
				All these directives influence not only the SPEC file, but also the end machine on which the resulting RPM is installed.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="packaging-epoch_epoch-scriplets-and-triggers"/>The Epoch directive</h2></div></div></div><p>
					The <code class="literal">Epoch</code> directive enables to define weighted dependencies based on version numbers.
				</p><p>
					If this directive is not listed in the RPM SPEC file, the <code class="literal">Epoch</code> directive is not set at all. This is contrary to common belief that not setting <code class="literal">Epoch</code> results in an <code class="literal">Epoch</code> of 0. However, the YUM utility treats an unset <code class="literal">Epoch</code> as the same as an <code class="literal">Epoch</code> of 0 for the purposes of depsolving.
				</p><p>
					However, listing <code class="literal">Epoch</code> in a SPEC file is usually omitted because in majority of cases introducing an <code class="literal">Epoch</code> value skews the expected RPM behavior when comparing versions of packages.
				</p><div class="example"><a id="idm140116045504304"/><p class="title"><strong>Example 4.2. Using Epoch</strong></p><div class="example-contents"><p>
						If you install the <code class="literal">foobar</code> package with <code class="literal">Epoch: 1</code> and <code class="literal">Version: 1.0</code>, and someone else packages <code class="literal">foobar</code> with <code class="literal">Version: 2.0</code> but without the <code class="literal">Epoch</code> directive, the new version will never be considered an update. The reason being that the <code class="literal">Epoch</code> version is preferred over the traditional <code class="literal">Name-Version-Release</code> marker that signifies versioning for RPM Packages.
					</p></div></div><p>
					Using of <code class="literal">Epoch</code> is thus quite rare. However, <code class="literal">Epoch</code> is typically used to resolve an upgrade ordering issue. The issue can appear as a side effect of upstream change in software version number schemes or versions incorporating alphabetical characters that cannot always be compared reliably based on encoding.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="scriptlets_epoch-scriplets-and-triggers"/>The Scriptlets directives</h2></div></div></div><p>
					<span class="strong"><strong>Scriptlets</strong></span> are a series of RPM directives that are executed before or after packages are installed or deleted.
				</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
						Use <span class="strong"><strong>Scriptlets</strong></span> only for tasks that cannot be done at build time or in an start up script.
					</p></div><h5><a id="scriptlets_directives"/>Scriptlets directives</h5><p>
					Note that a set of common <span class="strong"><strong>Scriptlet</strong></span> directives exists. They are similar to the SPEC file section headers, such as <code class="literal">%build</code> or <code class="literal">%install</code>. They are defined by multi-line segments of code, which are often written as a standard POSIX shell script. However, they can also be written in other programming languages that RPM for the target machine’s distribution accepts. RPM Documentation includes an exhaustive list of available languages.
				</p><p>
					The following table includes <span class="strong"><strong>Scriptlet</strong></span> directives listed in their execution order. Note that a package containing the scripts is installed between the <code class="literal">%pre</code> and <code class="literal">%post</code> directive, and it is uninstalled between the <code class="literal">%preun</code> and <code class="literal">%postun</code> directive.
				</p><div class="table"><a id="idm140115989106976"/><p class="title"><strong>Table 4.2. Scriptlet directives</strong></p><div class="table-contents"><table summary="Scriptlet directives" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><thead><tr><th style="text-align: left" valign="top">Directive</th><th style="text-align: left" valign="top">Definition</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">%pretrans</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Scriptlet that is executed just before installing or removing any package.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">%pre</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Scriptlet that is executed just before installing the package on the target system.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">%post</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Scriptlet that is executed just after the package was installed on the target system.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">%preun</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Scriptlet that is executed just before uninstalling the package from the target system.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">%postun</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Scriptlet that is executed just after the package was uninstalled from the target system.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									<code class="literal">%posttrans</code>
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Scriptlet that is executed at the end of the transaction.
								</p>
								 </td></tr></tbody></table></div></div><h5><a id="scriptlets_macros"/>Scriptlets macros</h5><p>
					The <span class="strong"><strong>Scriptlets</strong></span> directives also work with RPM macros.
				</p><p>
					The following example shows the use of systemd scriptlet macro, which ensures that systemd is notified about a new unit file.
				</p><pre class="literallayout">$ rpm --showrc | grep systemd
-14: <span class="emphasis"><em>transaction_systemd_inhibit %{</em></span>plugindir}/systemd_inhibit.so
-14: _journalcatalogdir /usr/lib/systemd/catalog
-14: _presetdir /usr/lib/systemd/system-preset
-14: _unitdir   /usr/lib/systemd/system
-14: _userunitdir       /usr/lib/systemd/user
/usr/lib/systemd/systemd-binfmt %{?<span class="strong"><strong>} &gt;/dev/null 2&gt;&amp;1 || : /usr/lib/systemd/systemd-sysctl %{?</strong></span>} &gt;/dev/null 2&gt;&amp;1 || :
-14: systemd_post
-14: systemd_postun
-14: systemd_postun_with_restart
-14: systemd_preun
-14: systemd_requires
Requires(post): systemd
Requires(preun): systemd
Requires(postun): systemd
-14: systemd_user_post  %systemd_post --user --global %{?<span class="strong"><strong>} -14: systemd_user_postun %{nil} -14: systemd_user_postun_with_restart %{nil} -14: systemd_user_preun systemd-sysusers %{?</strong></span>} &gt;/dev/null 2&gt;&amp;1 || :
echo %{?<span class="strong"><strong>} | systemd-sysusers - &gt;/dev/null 2&gt;&amp;1 || : systemd-tmpfiles --create %{?</strong></span>} &gt;/dev/null 2&gt;&amp;1 || :

$ rpm --eval %{systemd_post}

if [ $1 -eq 1 ] ; then
        # Initial installation
        systemctl preset  &gt;/dev/null 2&gt;&amp;1 || :
fi

$ rpm --eval %{systemd_postun}

systemctl daemon-reload &gt;/dev/null 2&gt;&amp;1 || :

$ rpm --eval %{systemd_preun}

if [ $1 -eq 0 ] ; then
        # Package removal, not upgrade
        systemctl --no-reload disable  &gt; /dev/null 2&gt;&amp;1 || :
        systemctl stop  &gt; /dev/null 2&gt;&amp;1 || :
fi</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="triggers_epoch-scriplets-and-triggers"/>The Triggers directives</h2></div></div></div><p>
					<span class="strong"><strong>Triggers</strong></span> are RPM directives which provide a method for interaction during package installation and uninstallation.
				</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
						<span class="strong"><strong>Triggers</strong></span> may be executed at an unexpected time, for example on update of the containing package. <span class="strong"><strong>Triggers</strong></span> are difficult to debug, therefore they need to be implemented in a robust way so that they do not break anything when executed unexpectedly. For these reasons, Red Hat recommends to minimize the use of <span class="strong"><strong>Triggers</strong></span>.
					</p></div><p>
					The order of execution and the details for each existing <span class="strong"><strong>Triggers</strong></span> are listed below:
				</p><pre class="literallayout">all-%pretrans
…​
any-%triggerprein (%triggerprein from other packages set off by new install)
new-%triggerprein
new-%pre      for new version of package being installed
…​           (all new files are installed)
new-%post     for new version of package being installed

any-%triggerin (%triggerin from other packages set off by new install)
new-%triggerin
old-%triggerun
any-%triggerun (%triggerun from other packages set off by old uninstall)

old-%preun    for old version of package being removed
…​           (all old files are removed)
old-%postun   for old version of package being removed

old-%triggerpostun
any-%triggerpostun (%triggerpostun from other packages set off by old un
            install)
…​
all-%posttrans</pre><p>
					The above items are found in the <code class="literal">/usr/share/doc/rpm-4.*/triggers</code> file.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="using-non-shell-scripts-in-a-spec-file_epoch-scriplets-and-triggers"/>Using non-shell scripts in a SPEC file</h2></div></div></div><p>
					The <code class="literal">-p</code> scriptlet option in a SPEC file enables the user to invoke a specific interpreter instead of the default shell scripts interpreter (<code class="literal">-p /bin/sh</code>).
				</p><p>
					The following procedure describes how to create a script, which prints out a message after installation of the <code class="literal">pello.py</code> program:
				</p><h4><a id="procedure_27"/>Procedure</h4><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
							Open the <code class="literal">pello.spec</code> file.
						</li><li class="listitem"><p class="simpara">
							Find the following line:
						</p><pre class="literallayout">install -m 0644 %{name}.py* %{buildroot}/usr/lib/%{name}/</pre></li><li class="listitem"><p class="simpara">
							Under the above line, insert:
						</p><pre class="literallayout">%post -p /usr/bin/python3
print("This is {} code".format("python"))</pre></li><li class="listitem">
							Build your package as described in <a class="xref" href="packaging-software_packaging-and-distributing-software.html#building-rpms_packaging-software" title="Building RPMs">the section called “Building RPMs”</a>.
						</li><li class="listitem"><p class="simpara">
							Install your package:
						</p><pre class="literallayout"># yum install /home/&lt;username&gt;/rpmbuild/RPMS/noarch/pello-0.1.2-1.el8.noarch.rpm</pre></li><li class="listitem"><p class="simpara">
							Check the output message after the installation:
						</p><pre class="literallayout">Installing       : pello-0.1.2-1.el8.noarch                              1/1
Running scriptlet: pello-0.1.2-1.el8.noarch                              1/1
This is python code</pre></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						To use a Python 3 script, include the following line under <code class="literal">install -m</code> in a SPEC file:
					</p><pre class="literallayout">%post -p /usr/bin/python3</pre><p>
						To use a Lua script, include the following line under <code class="literal">install -m</code> in a SPEC file:
					</p><pre class="literallayout">%post -p &lt;lua&gt;</pre><p>
						This way, you can specify any interpreter in a SPEC file.
					</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="rpm-conditionals_advanced-topics"/>RPM conditionals</h1></div></div></div><p>
				RPM Conditionals enable conditional inclusion of various sections of the SPEC file.
			</p><p>
				Conditional inclusions usually deal with:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						Architecture-specific sections
					</li><li class="listitem">
						Operating system-specific sections
					</li><li class="listitem">
						Compatibility issues between various versions of operating systems
					</li><li class="listitem">
						Existence and definition of macros
					</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="rpm-conditionals-syntax_rpm-conditionals"/>RPM conditionals syntax</h2></div></div></div><p>
					RPM conditionals use the following syntax:
				</p><p>
					If <span class="emphasis"><em>expression</em></span> is true, then do some action:
				</p><pre class="literallayout">%if expression
…​
%endif</pre><p>
					If <span class="emphasis"><em>expression</em></span> is true, then do some action, in other case, do another action:
				</p><pre class="literallayout">%if expression
…​
%else
…​
%endif</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="rpm-conditionals-examples_rpm-conditionals"/>RPM conditionals examples</h2></div></div></div><p>
					This section provides multiple examples of RPM conditionals.
				</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="the_if_conditionals"/>The %if conditionals</h3></div></div></div><div class="example"><a id="idm140116096756704"/><p class="title"><strong>Example 4.3. Using the %if conditional to handle compatibility between Red Hat Enterprise Linux 8 and other operating systems</strong></p><div class="example-contents"><pre class="literallayout">%if 0%{?rhel} == 8
sed -i '/AS_FUNCTION_DESCRIBE/ s/^/<span class="marked">/' configure.in sed -i '/AS_FUNCTION_DESCRIBE/ s/^/</span>/' acinclude.m4
%endif</pre></div></div><p>
						This conditional handles compatibility between RHEL 8 and other operating systems in terms of support of the AS_FUNCTION_DESCRIBE macro. If the package is built for RHEL, the <code class="literal">%rhel</code> macro is defined, and it is expanded to RHEL version. If its value is 8, meaning the package is build for RHEL 8, then the references to AS_FUNCTION_DESCRIBE, which is not supported by RHEL 8, are deleted from autoconfig scripts.
					</p><div class="example"><a id="idm140116045804496"/><p class="title"><strong>Example 4.4. Using the %if conditional to handle definition of macros</strong></p><div class="example-contents"><pre class="literallayout">%define ruby_archive %{name}-%{ruby_version}
%if 0%{?milestone:1}%{?revision:1} != 0
%define ruby_archive %{ruby_archive}-%{?milestone}%{?!milestone:%{?revision:r%{revision}}}
%endif</pre></div></div><p>
						This conditional handles definition of macros. If the <code class="literal">%milestone</code> or the <code class="literal">%revision</code> macros are set, the <code class="literal">%ruby_archive</code> macro, which defines the name of the upstream tarball, is redefined.
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="specialized_variants_of_if_conditionals"/>Specialized variants of %if conditionals</h3></div></div></div><p>
						The <code class="literal">%ifarch</code> conditional, <code class="literal">%ifnarch</code> conditional and <code class="literal">%ifos</code> conditional are specialized variants of the <code class="literal">%if</code> conditionals. These variants are commonly used, hence they have their own macros.
					</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="the_ifarch_conditional"/>The %ifarch conditional</h4></div></div></div><p>
							The <code class="literal">%ifarch</code> conditional is used to begin a block of the SPEC file that is architecture-specific. It is followed by one or more architecture specifiers, each separated by commas or whitespace.
						</p><div class="example"><a id="idm140116076332544"/><p class="title"><strong>Example 4.5. An example use of the %ifarch conditional</strong></p><div class="example-contents"><pre class="literallayout">%ifarch i386 sparc
…​
%endif</pre></div></div><p>
							All the contents of the SPEC file between <code class="literal">%ifarch</code> and <code class="literal">%endif</code> are processed only on the 32-bit AMD and Intel architectures or Sun SPARC-based systems.
						</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="the_ifnarch_conditional"/>The %ifnarch conditional</h4></div></div></div><p>
							The <code class="literal">%ifnarch</code> conditional has a reverse logic than <code class="literal">%ifarch</code> conditional.
						</p><div class="example"><a id="idm140116082257776"/><p class="title"><strong>Example 4.6. An example use of the %ifnarch conditional</strong></p><div class="example-contents"><pre class="literallayout">%ifnarch alpha
…​
%endif</pre></div></div><p>
							All the contents of the SPEC file between <code class="literal">%ifnarch</code> and <code class="literal">%endif</code> are processed only if not done on a Digital Alpha/AXP-based system.
						</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="the_ifos_conditional"/>The %ifos conditional</h4></div></div></div><p>
							The <code class="literal">%ifos</code> conditional is used to control processing based on the operating system of the build. It can be followed by one or more operating system names.
						</p><div class="example"><a id="idm140116097255488"/><p class="title"><strong>Example 4.7. An example use of the %ifos conditional</strong></p><div class="example-contents"><pre class="literallayout">%ifos linux
…​
%endif</pre></div></div><p>
							All the contents of the SPEC file between <code class="literal">%ifos</code> and <code class="literal">%endif</code> are processed only if the build was done on a Linux system.
						</p></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="packaging-python3_advanced-topics"/>Packaging of Python 3 RPMs</h1></div></div></div><p>
				Most Python projects use Setuptools for packaging, and define package information in the <code class="literal">setup.py</code> file. For more information on Setuptools packaging, see <a class="link" href="https://setuptools.readthedocs.io/en/latest/">Setuptools documentation</a>.
			</p><p>
				You can also package your Python project into an RPM package, which provides the following advantages compared to Setuptools packaging:
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						Specification of dependencies of a package on other RPMs (even non-Python)
					</li><li class="listitem"><p class="simpara">
						Cryptographic signing
					</p><p class="simpara">
						With cryptographic signing, content of RPM packages can be verified, integrated, and tested with the rest of the operating system.
					</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Typical-Python-RPM-package-spec-file-description"/>Typical SPEC file description for a Python RPM package</h2></div></div></div><p>
					An RPM SPEC file for Python projects has some specifics compared to non-Python RPM SPEC files. Most notably, a name of any RPM package of a Python library must always include the <code class="literal">python3</code> prefix.
				</p><p>
					Other specifics are shown in the following SPEC file <span class="strong"><strong>example for the <code class="literal">python3-detox</code> package</strong></span>. For description of such specifics, see the notes below the example.
				</p><pre class="programlisting">%global modname detox                                                           <a id="CO1-1"/><span><img src="images/callouts/1.png" alt="1"/></span>

Name:           python3-detox                                                   <a id="CO1-2"/><span><img src="images/callouts/2.png" alt="2"/></span>
Version:        0.12
Release:        4%{?dist}
Summary:        Distributing activities of the tox tool
License:        MIT
URL:             https://pypi.io/project/detox
Source0:        https://pypi.io/packages/source/d/%{modname}/%{modname}-%{version}.tar.gz

BuildArch:      noarch

BuildRequires:  python36-devel                                                  <a id="CO1-3"/><span><img src="images/callouts/3.png" alt="3"/></span>
BuildRequires:  python3-setuptools
BuildRequires:  python36-rpm-macros
BuildRequires:  python3-six
BuildRequires:  python3-tox
BuildRequires:  python3-py
BuildRequires:  python3-eventlet

%?python_enable_dependency_generator                                            <a id="CO1-4"/><span><img src="images/callouts/4.png" alt="4"/></span>

%description

Detox is the distributed version of the tox python testing tool. It makes efficient use of multiple CPUs by running all possible activities in parallel.
Detox has the same options and configuration that tox has, so after installation you can run it in the same way and with the same options that you use for tox.

    $ detox

%prep
%autosetup -n %{modname}-%{version}

%build
%py3_build                                                                      <a id="CO1-5"/><span><img src="images/callouts/5.png" alt="5"/></span>

%install
%py3_install

%check
%{__python3} setup.py test                                                      <a id="CO1-6"/><span><img src="images/callouts/6.png" alt="6"/></span>

%files -n python3-%{modname}
%doc CHANGELOG
%license LICENSE
%{_bindir}/detox
%{python3_sitelib}/%{modname}/
%{python3_sitelib}/%{modname}-%{version}*

%changelog
...</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td valign="top" align="left"><p><a href="#CO1-1"><span><img src="images/callouts/1.png" alt="1"/></span></a> </p></td><td valign="top" align="left"><p>
							The <span class="strong"><strong>modname</strong></span> macro contains the name of the Python project. In this example it is <code class="literal">detox</code>.
						</p></td></tr><tr><td valign="top" align="left"><p><a href="#CO1-2"><span><img src="images/callouts/2.png" alt="2"/></span></a> </p></td><td valign="top" align="left"><p>
							When packaging a Python project into RPM, the <code class="literal">python3</code> prefix always needs to be added to the original name of the project. The original name here is <code class="literal">detox</code> and the <span class="strong"><strong>name of the RPM</strong></span> is <code class="literal">python3-detox</code>.
						</p></td></tr><tr><td valign="top" align="left"><p><a href="#CO1-3"><span><img src="images/callouts/3.png" alt="3"/></span></a> </p></td><td valign="top" align="left"><p>
							<span class="strong"><strong>BuildRequires</strong></span> specifies what packages are required to build and test this package. In BuildRequires, always include items providing tools necessary for building Python packages: <code class="literal">python36-devel</code> and <code class="literal">python3-setuptools</code>. The <code class="literal">python36-rpm-macros</code> package is required so that files with <code class="literal">/usr/bin/python3</code> shebangs are automatically changed to <code class="literal">/usr/bin/python3.6</code>. For more information, see <a class="xref" href="advanced-topics.html#python-shebang-mangling" title="Handling hashbangs in Python scripts">the section called “Handling hashbangs in Python scripts”</a>.
						</p></td></tr><tr><td valign="top" align="left"><p><a href="#CO1-4"><span><img src="images/callouts/4.png" alt="4"/></span></a> </p></td><td valign="top" align="left"><p>
							Every Python package requires some other packages to work correctly. Such packages need to be specified in the SPEC file as well. To specify the <span class="strong"><strong>dependencies</strong></span>, you can use the <span class="strong"><strong>%python_enable_dependency_generator</strong></span> macro to automatically use dependencies defined in the <code class="literal">setup.py</code> file. If a package has dependencies that are not specified using Setuptools, specify them within additional <code class="literal">Requires</code> directives.
						</p></td></tr><tr><td valign="top" align="left"><p><a href="#CO1-5"><span><img src="images/callouts/5.png" alt="5"/></span></a> </p></td><td valign="top" align="left"><p>
							The <span class="strong"><strong>%py3_build</strong></span> and <span class="strong"><strong>%py3_install</strong></span> macros run the <code class="literal">setup.py build</code> and <code class="literal">setup.py install</code> commands, respectively, with additional arguments to specify installation locations, the interpreter to use, and other details.
						</p></td></tr><tr><td valign="top" align="left"><p><a href="#CO1-6"><span><img src="images/callouts/6.png" alt="6"/></span></a> </p></td><td valign="top" align="left"><p>
							The <span class="strong"><strong>check</strong></span> section provides a macro that runs the correct version of Python. The <span class="strong"><strong>%{__python3}</strong></span> macro contains a path for the Python 3 interpreter, for example <code class="literal">/usr/bin/python3</code>. We recommend to always use the macro rather than a literal path.
						</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="Common-macros-for-Python-RPM-packages"/>Common macros for Python 3 RPM packages</h2></div></div></div><p>
					In a SPEC file, always use the macros below rather than hardcoding their values.
				</p><p>
					In macro names, always use <code class="literal">python3</code> or <code class="literal">python2</code> instead of unversioned <code class="literal">python</code>.
				</p><div class="informaltable"><table border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/></colgroup><thead><tr><th style="text-align: left" valign="top">Macro</th><th style="text-align: left" valign="top">Normal Definition</th><th style="text-align: left" valign="top">Description</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									%{__python3}
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									/usr/bin/python3
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Python 3 interpreter
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									%{python3_version}
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									3.6
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The full version of the Python 3 interpreter.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									%{python3_sitelib}
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									/usr/lib/python3.6/site-packages
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Where pure-Python modules are installed.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									%{python3_sitearch}
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									/usr/lib64/python3.6/site-packages
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Where modules containing architecture-specific extensions are installed.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									%py3_build
								</p>
								 </td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> <p>
									Runs the <code class="literal">setup.py build</code> command with arguments suitable for a system package.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									%py3_install
								</p>
								 </td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> <p>
									Runs the <code class="literal">setup.py install</code> command with arguments suitable for a system package.
								</p>
								 </td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="automatic_provides_for_python_rpm_packages"/>Automatic provides for Python RPM packages</h2></div></div></div><p>
					When packaging a Python project, make sure that, if present, the following directories are included in the resulting RPM:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							<code class="literal">.dist-info</code>
						</li><li class="listitem">
							<code class="literal">.egg-info</code>
						</li><li class="listitem">
							<code class="literal">.egg-link</code>
						</li></ul></div><p>
					From these directories, the RPM build process automatically generates virtual <code class="literal">pythonX.Ydist</code> provides, for example <code class="literal">python3.6dist(detox)</code>. These virtual provides are used by packages that are specified by the <span class="strong"><strong>%python_enable_dependency_generator</strong></span> macro.
				</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="python-shebang-mangling"/>Handling hashbangs in Python scripts</h2></div></div></div><p>
					In Red Hat Enterprise Linux 8, executable Python scripts are expected to use hashbangs (shebangs) specifying explicitly at least the major Python version.
				</p><p>
					The <code class="literal">/usr/lib/rpm/redhat/brp-mangle-shebangs</code> buildroot policy (BRP) script is run automatically when building any RPM package, and attempts to correct hashbangs in all executable files. The BRP script will generate errors when encountering a Python script with an ambiguous hashbang, such as:
				</p><pre class="literallayout">#! /usr/bin/python</pre><p>
					or
				</p><pre class="literallayout">#! /usr/bin/env python</pre><p>
					To modify hashbangs in the Python scripts causing these build errors at RPM build time, use the <code class="literal">pathfix.py</code> script from the <code class="literal">platform-python-devel</code> package:
				</p><pre class="literallayout">pathfix.py -pn -i %{__python3} <span class="emphasis"><em>PATH</em></span> …​</pre><p>
					Multiple <code class="literal"><span class="emphasis"><em>PATH</em></span>s</code> can be specified. If a <code class="literal"><span class="emphasis"><em>PATH</em></span></code> is a directory, <code class="literal">pathfix.py</code> recursively scans for any Python scripts matching the pattern <code class="literal">^[a-zA-Z0-9_]+\.py$</code>, not only those with an ambiguous hashbang. Add this command to the <code class="literal">%prep</code> section or at the end of the <code class="literal">%install</code> section.
				</p><p>
					Alternatively, modify the packaged Python scripts so that they conform to the expected format. For this purpose, <code class="literal">pathfix.py</code> can be used outside the RPM build process, too. When running <code class="literal">pathfix.py</code> outside a RPM build, replace <code class="literal"><span class="emphasis"><em>__python3</em></span></code> from the example above with a path for the hashbang, such as <code class="literal">/usr/bin/python3</code>.
				</p><p>
					If the packaged Python scripts require Python version 2, replace the number 3 with 2 in the commands above.
				</p><p>
					Additionally, hashbangs in the form <code class="literal">/usr/bin/python3</code> are by default replaced with hashbangs pointing to Python from the <code class="literal">platform-python</code> package used for system tools with Red Hat Enterprise Linux.
				</p><p>
					To change the <code class="literal">/usr/bin/python3</code> hashbangs in their custom packages to point to a version of Python installed from Application Stream, in the form <code class="literal">/usr/bin/python3.6</code>, add the <code class="literal">python36-rpm-macros</code> package into the <span class="strong"><strong>BuildRequires</strong></span> section of the SPEC file:
				</p><pre class="literallayout">BuildRequires:  python36-rpm-macros</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						To prevent hashbang check and modification by the BRP script, use the following RPM directive:
					</p><pre class="literallayout">%undefine %brp_mangle_shebangs</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ruby-gem-packages_advanced-topics"/>RubyGems packages</h1></div></div></div><p>
				This section explains what RubyGems packages are, and how to re-package them into RPM.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="what-rubygems-are_ruby-gem-packages"/>What RubyGems are</h2></div></div></div><p>
					Ruby is a dynamic, interpreted, reflective, object-oriented, general-purpose programming language.
				</p><p>
					Programs written in Ruby are typically packaged using the RubyGems project, which provides a specific Ruby packaging format.
				</p><p>
					Packages created by RubyGems are called gems, and they can be re-packaged into RPM as well.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
						This documentation refers to terms related to the RubyGems concept with the <code class="literal">gem</code> prefix, for example .gemspec is used for the <code class="literal">gem specification</code>, and terms related to RPM are unqualified.
					</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ruby-gem-rpm-relation_ruby-gem-packages"/>How RubyGems relate to RPM</h2></div></div></div><p>
					RubyGems represent Ruby’s own packaging format. However, RubyGems contain metadata similar to those needed by RPM, which enables the conversion from RubyGems to RPM.
				</p><p>
					According to <a class="link" href="https://docs.fedoraproject.org/en-US/packaging-guidelines/Ruby/#_rubygems">Ruby Packaging Guidelines</a>, it is possible to re-package RubyGems packages into RPM in this way:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							Such RPMs fit with the rest of the distribution.
						</li><li class="listitem">
							End users are able to satisfy dependencies of a gem by installing the appropriate RPM-packaged gem.
						</li></ul></div><p>
					RubyGems use similar terminology as RPM, such as SPEC files, package names, dependencies and other items.
				</p><p>
					To fit into the rest of RHEL RPM distribution, packages created by RubyGems must follow the conventions listed below:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
							Names of gems must follow this pattern:
						</p><pre class="literallayout">rubygem-%{gem_name}</pre></li><li class="listitem"><p class="simpara">
							To implement a shebang line, the following string must be used:
						</p><pre class="literallayout">#!/usr/bin/ruby</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="creating-rpm-packages-from-rubygems_ruby-gem-packages"/>Creating RPM packages from RubyGems packages</h2></div></div></div><p>
					This section describes how to create RPM packages from packages created by RubyGems.
				</p><p>
					To create a source RPM for a RubyGems package, two files are needed:
				</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
							A gem file
						</li><li class="listitem">
							An RPM SPEC file
						</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="rubygems-spec-file-conventions"/>RubyGems SPEC file conventions</h3></div></div></div><p>
						A RubyGems SPEC file must meet the following conventions:
					</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								Contain a definition of <code class="literal">%{gem_name}</code>, which is the name from the gem’s specification.
							</li><li class="listitem">
								The source of the package must be the full URL to the released gem archive; the version of the package must be the gem’s version.
							</li><li class="listitem"><p class="simpara">
								Contain the <code class="literal">BuildRequires:</code> a directive defined as follows to be able to pull in the macros needed to build.
							</p><pre class="literallayout">BuildRequires:rubygems-devel</pre></li><li class="listitem">
								Not contain any RubyGems <code class="literal">Requires</code> or <code class="literal">Provides</code>, because those are autogenerated.
							</li><li class="listitem"><p class="simpara">
								Not contain the <code class="literal">BuildRequires:</code> directive defined as follows, unless you want to explicitly specify Ruby version compatibility:
							</p><pre class="literallayout">Requires: ruby(release)</pre><p class="simpara">
								The automatically generated dependency on RubyGems (<code class="literal">Requires: ruby(rubygems)</code>) is sufficient.
							</p></li></ul></div><h4><a id="macros"/>Macros</h4><p>
						Macros useful for packages created by RubyGems are provided by the <code class="literal">rubygems-devel</code> packages.
					</p><div class="table"><a id="idm140116083079552"/><p class="title"><strong>Table 4.3. RubyGems' macros</strong></p><div class="table-contents"><table summary="RubyGems' macros" border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/></colgroup><thead><tr><th style="text-align: left" valign="top">Macro name</th><th style="text-align: left" valign="top">Extended path</th><th style="text-align: left" valign="top">Usage</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
										%{gem_dir}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										/usr/share/gems
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										Top directory for the gem structure.
									</p>
									 </td></tr><tr><td style="text-align: left" valign="top"> <p>
										%{gem_instdir}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										%{gem_dir}/gems/%{gem_name}-%{version}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										Directory with the actual content of the gem.
									</p>
									 </td></tr><tr><td style="text-align: left" valign="top"> <p>
										%{gem_libdir}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										%{gem_instdir}/lib
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										The library directory of the gem.
									</p>
									 </td></tr><tr><td style="text-align: left" valign="top"> <p>
										%{gem_cache}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										%{gem_dir}/cache/%{gem_name}-%{version}.gem
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										The cached gem.
									</p>
									 </td></tr><tr><td style="text-align: left" valign="top"> <p>
										%{gem_spec}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										%{gem_dir}/specifications/%{gem_name}-%{version}.gemspec
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										The gem specification file.
									</p>
									 </td></tr><tr><td style="text-align: left" valign="top"> <p>
										%{gem_docdir}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										%{gem_dir}/doc/%{gem_name}-%{version}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										The RDoc documentation of the gem.
									</p>
									 </td></tr><tr><td style="text-align: left" valign="top"> <p>
										%{gem_extdir_mri}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										%{_libdir}/gems/ruby/%{gem_name}-%{version}
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										The directory for gem extension.
									</p>
									 </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="rubygems-spec-file-example"/>RubyGems SPEC file example</h3></div></div></div><p>
						This section provides an example SPEC file for building gems together with an explanation of its particular sections.
					</p><div class="title"><strong>An example RubyGems SPEC file</strong></div><p>
							
</p><pre class="literallayout">%prep
%setup -q -n  %{gem_name}-%{version}

# Modify the gemspec if necessary
# Also apply patches to code if necessary
%patch0 -p1

%build
# Create the gem as gem install only works on a gem file
gem build ../%{gem_name}-%{version}.gemspec

# %%gem_install compiles any C extensions and installs the gem into ./%%gem_dir
# by default, so that we can move it into the buildroot in %%install
%gem_install

%install
mkdir -p %{buildroot}%{gem_dir}
cp -a ./%{gem_dir}/* %{buildroot}%{gem_dir}/

# If there were programs installed:
mkdir -p %{buildroot}%{_bindir}
cp -a ./%{_bindir}/* %{buildroot}%{_bindir}

# If there are C extensions, copy them to the extdir.
mkdir -p %{buildroot}%{gem_extdir_mri}
cp -a .%{gem_extdir_mri}/{gem.build_complete,*.so} %{buildroot}%{gem_extdir_mri}/</pre><p>

						</p><p>
						The following table explains the specifics of particular items in a RubyGems SPEC file:
					</p><div class="table"><a id="idm140116089344336"/><p class="title"><strong>Table 4.4. RubyGems' SPEC directives specifics</strong></p><div class="table-contents"><table summary="RubyGems' SPEC directives specifics" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><thead><tr><th style="text-align: left" valign="top">SPEC directive</th><th style="text-align: left" valign="top">RubyGems specifics</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
										%prep
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										RPM can directly unpack gem archives, so you can run the <code class="literal">gem unpack</code> comamnd to extract the source from the gem. The <code class="literal">%setup -n %{gem_name}-%{version}</code> macro provides the directory into which the gem has been unpacked. At the same directory level, the <code class="literal">%{gem_name}-%{version}.gemspec</code> file is automatically created, which can be used to rebuild the gem later, to modify the <code class="literal">.gemspec</code>, or to apply patches to the code.
									</p>
									 </td></tr><tr><td style="text-align: left" valign="top"> <p>
										%build
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										This directive includes commands or series of commands for building the software into machine code. The <code class="literal">%gem_install</code> macro operates only on gem archives, and the gem is recreated with the next gem build. The gem file that is created is then used by <code class="literal">%gem_install</code> to build and install the code into the temporary directory, which is <code class="literal">./%{gem_dir}</code> by default. The <code class="literal">%gem_install</code> macro both builds and installs the code in one step. Before being installed, the built sources are placed into a temporary directory that is created automatically.
									</p>
									 <p>
										The <code class="literal">%gem_install</code> macro accepts two additional options: <code class="literal">-n &lt;gem_file&gt;</code>, which allows to override gem used for installation, and <code class="literal">-d &lt;install_dir&gt;</code>, which might override the gem installation destination; using this option is not recommended.
									</p>
									 <p>
										The <code class="literal">%gem_install</code> macro must not be used to install into the <code class="literal">%{buildroot}</code>.
									</p>
									 </td></tr><tr><td style="text-align: left" valign="top"> <p>
										%install
									</p>
									 </td><td style="text-align: left" valign="top"> <p>
										The installation is performed into the <code class="literal">%{buildroot}</code> hierarchy. You can create the directories that you need and then copy what was installed in the temporary directories into the <code class="literal">%{buildroot}</code> hierarchy. If this gem creates shared objects, they are moved into the architecture-specific <code class="literal">%{gem_extdir_mri}</code> path.
									</p>
									 </td></tr></tbody></table></div></div><p>
						For more information on RubyGems SPEC files, see <a class="link" href="https://docs.fedoraproject.org/en-US/packaging-guidelines/Ruby/">Ruby Packaging Guidelines</a>.
					</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="converting-rubygem-rpm-spec"/>Converting RubyGems packages to RPM SPEC files with gem2rpm</h3></div></div></div><p>
						The <code class="literal">gem2rpm</code> utility converts RubyGems packages to RPM SPEC files.
					</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="installing-gem2rpm"/>Installing gem2rpm</h4></div></div></div><h6><a id="procedure_28"/>Procedure</h6><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									To install <code class="literal">gem2rpm</code> from <a class="link" href="https://rubygems.org/">RubyGems.org</a>, run:
								</li></ul></div><pre class="literallayout">$ gem install gem2rpm</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="displaying-gem2rpm-options"/>Displaying all options of gem2rpm</h4></div></div></div><h6><a id="procedure_29"/>Procedure</h6><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
									To see all options of <code class="literal">gem2rpm</code>, run:
								</p><pre class="literallayout">gem2rpm --help</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="converting-rubygems-with-gem2rpm"/>Using gem2rpm to covert RubyGems packages to RPM SPEC files</h4></div></div></div><h6><a id="procedure_30"/>Procedure</h6><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									Download a gem in its latest version, and generate the RPM SPEC file for this gem:
								</li></ul></div><pre class="literallayout">$ gem2rpm --fetch &lt;gem_name&gt; &gt; &lt;gem_name&gt;.spec</pre><p>
							The described procedure creates an RPM SPEC file based on the information provided in the gem’s metadata. However, the gem misses some important information that is usually provided in RPMs, such as the license and the changelog. The generated SPEC file thus needs to be edited.
						</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="editing-gem2rpm-templates"/>Editing gem2rpm templates</h4></div></div></div><p>
							It is recommended to edit the template from which the RPM SPEC file is generated rather than the generated SPEC file itself.
						</p><p>
							The template is a standard Embedded Ruby (ERB) file, which includes variables listed in the following table.
						</p><div class="table"><a id="idm140116087093248"/><p class="title"><strong>Table 4.5. Variables in the gem2rpm template</strong></p><div class="table-contents"><table summary="Variables in the gem2rpm template" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><thead><tr><th style="text-align: left" valign="top">Variable</th><th style="text-align: left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
											package
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem::Package</code> variable for the gem.
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											spec
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem::Specification</code> variable for the gem (the same as format.spec).
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											config
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem2Rpm::Configuration</code> variable that can redefine default macros or rules used in spec template helpers.
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											runtime_dependencies
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem2Rpm::RpmDependencyList</code> variable providing a list of package runtime dependencies.
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											development_dependencies
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem2Rpm::RpmDependencyList</code> variable providing a list of package development dependencies.
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											tests
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem2Rpm::TestSuite</code> variable providing a list of test frameworks allowing their execution.
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											files
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem2Rpm::RpmFileList</code> variable providing an unfiltered list of files in a package.
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											main_files
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem2Rpm::RpmFileList</code> variable providing a list of files suitable for the main package.
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											doc_files
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem2Rpm::RpmFileList</code> variable providing a list of files suitable for the <code class="literal">-doc</code> subpackage.
										</p>
										 </td></tr><tr><td style="text-align: left" valign="top"> <p>
											format
										</p>
										 </td><td style="text-align: left" valign="top"> <p>
											The <code class="literal">Gem::Format</code> variable for the gem. Note that this variable is now deprecated.
										</p>
										 </td></tr></tbody></table></div></div><h5><a id="procedure_31"/>Procedure</h5><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">
									To see all available templates, run:
								</p><pre class="literallayout">$ gem2rpm --templates</pre></li></ul></div><p>
							To edit the <code class="literal">gem2rpm</code> templates, follow this procedure:
						</p><h5><a id="procedure_32"/>Procedure</h5><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
									Save the default template:
								</p><pre class="literallayout">$ gem2rpm -T &gt; rubygem-&lt;gem_name&gt;.spec.template</pre></li><li class="listitem">
									Edit the template as needed.
								</li><li class="listitem"><p class="simpara">
									Generate the SPEC file using the edited template:
								</p><pre class="literallayout">$ gem2rpm -t rubygem-&lt;gem_name&gt;.spec.template &lt;gem_name&gt;-&lt;latest_version.gem &gt; &lt;gem_name&gt;-GEM.spec</pre></li></ol></div><p>
							You can now build an RPM package using the edited template as described in <a class="xref" href="packaging-software_packaging-and-distributing-software.html#building-rpms_packaging-software" title="Building RPMs">the section called “Building RPMs”</a>.
						</p></div></div></div></div></div></body></html>