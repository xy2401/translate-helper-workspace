<html  xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 9. 安装Identity Management服务器：使用集成DNS和外部CA.</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"></head><body ><div class="chapter"><div class="titlepage"><div><div><h1 class="title">Chapter 9. 安装Identity Management服务器：使用集成DNS和外部CA.</h1></div></div></div><p>使用集成DNS安装新的Identity Management服务器具有以下优势：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">您可以使用本机身份管理工具自动执行大部分维护和DNS记录管理。例如，DNS SRV记录在安装过程中自动创建，稍后会自动更新。
					</li><li class="listitem">通过在安装Identity Management服务器期间设置全局转发器，可以与Internet的其余部分建立稳定的连接。全局转发器对于使用Active Directory的信任也很有用。
					</li><li class="listitem">您可以设置DNS反向区域，以防止来自域的电子邮件被Identity Management域外的电子邮件服务器视为垃圾邮件。
					</li></ul></div><p>使用集成DNS安装Identity Management具有一定的局限性：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">身份管理DNS不能用作通用DNS服务器。某些高级DNS功能不受支持。
					</li></ul></div><p>本章介绍如何使用外部CA作为根CA安装新的Identity Management服务器。</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="installing-an-ipa-server-with-an-external-ca-as-the-root-ca"></a>互动安装</h1></div></div></div><p>在使用<span class="strong"><strong>ipa-server-install</strong></span>实用程序进行交互式安装期间，系统会要求您提供系统的基本配置，例如领域，管理员密码和目录管理员密码。
				</p><p><code class="literal">ipa-server-install</code>安装脚本在<code class="literal">/var/log/ipaserver-install.log</code>创建日志文件。如果安装失败，日志可以帮助您确定问题。
				</p><p>此过程描述如何安装服务器：</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">集成DNS</li><li class="listitem">使用外部证书颁发机构（CA）作为根CA.</li></ul></div><h3><a id="prerequisites_2"></a>先决条件</h3><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">确定您使用的外部CA的类型（ <code class="literal">--external-ca-type</code>选项）。有关详细信息，请参见<span class="strong"><strong>ipa-server-install</strong></span> （1）手册页。
						</li><li class="listitem"><p class="simpara">或者，决定<code class="literal">--external-ca-profile</code>选项，以允许指定备用Active Directory证书服务（AD CS）模板。例如，要指定AD CS特定于安装的对象标识符：</p><pre class="literallayout">[root@server ~]# <span class="strong"><strong>ipa-server-install --external-ca --external-ca-type=ms-cs --external-ca-profile=1.3.6.1.4.1.311.21.8.8950086.10656446.2706058.12775672.480128.147.7130143.4405632:1</strong></span></pre></li></ul></div><h3><a id="procedure_4"></a>程序</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">使用<code class="literal">--external-ca</code>选项运行<span class="strong"><strong>ipa-server-install</strong></span>实用程序。
						</p><pre class="literallayout"># <span class="strong"><strong>ipa-server-install --external-ca</strong></span></pre><p class="simpara">如果您使用的是Microsoft证书服务CA，请同时使用<code class="literal">--external-ca-type</code>选项。有关详细信息，请参见<span class="strong"><strong>ipa-server-install</strong></span> （1）手册页。
						</p></li><li class="listitem"><p class="simpara">该脚本会提示您配置集成的DNS服务。输入<code class="literal">yes</code>或<code class="literal">no</code> 。在此过程中，我们将安装具有集成DNS的服务器。</p><pre class="screen">Do you want to configure integrated DNS (BIND)? [no]: <code class="literal">yes</code></pre><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>如果要安装没有集成DNS的服务器，安装脚本将不会提示您进行DNS配置，如下面的步骤所述。有关<a class="xref" href="installing-an-ipa-server-without-integrated-dns_installing-identity-management.html" title="Chapter 5. Installing an Identity Management server: Without integrated DNS, with an integrated CA"><em>安装没有DNS</em></a>的服务器的步骤的详细信息，请参阅<a class="xref" href="installing-an-ipa-server-without-integrated-dns_installing-identity-management.html" title="Chapter 9. 安装Identity Management服务器：没有集成的DNS，带有集成的CA.">第5章， <em>安装Identity Management服务器：没有集成的DNS，以及集成的CA.</em></a></p></div></li><li class="listitem"><p class="simpara">脚本会提示输入几个必需的设置，并在括号中提供建议的默认值。
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">要接受默认值，请按<span class="keycap"><strong>Enter键</strong></span> 。
								</li><li class="listitem"><p class="simpara">要提供自定义值，请输入所需的值。
								</p><pre class="screen">Server host name [server.example.com]:
Please confirm the domain name [example.com]:
Please provide a realm name [EXAMPLE.COM]:</pre><div class="warning" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">警告</h3><p>仔细计划这些名称。安装完成后，您将无法更改它们。
									</p></div></li></ul></div></li><li class="listitem"><p class="simpara">输入Directory Server超级用户（ <code class="literal">cn=Directory Manager</code> ）和Identity Management管理系统用户帐户（ <code class="literal">admin</code> ）的密码。
						</p><pre class="screen">Directory Manager password:
IPA admin password:</pre></li><li class="listitem"><p class="simpara">该脚本会提示输入DNS转发器。
						</p><pre class="screen">Do you want to configure DNS forwarders? [yes]:</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p class="simpara">要配置DNS转发器，请输入<code class="literal">yes</code> ，然后按照命令行上的说明进行操作。安装过程会将转发器IP地址添加到已安装的Identity Management服务器上的<code class="literal">/etc/named.conf</code>文件中。
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">有关转发策略默认设置，请参阅<span class="strong"><strong>ipa-dns-install</strong></span> （1）手册页中的<code class="literal">--forward-policy</code> description。
										</li></ul></div></li><li class="listitem"><p class="simpara">如果您不想使用DNS转发，请输入<code class="literal">no</code> 。
								</p><p class="simpara">如果没有DNS转发器，您的环境将被隔离，并且基础架构中其他DNS域的名称将无法解析。
								</p></li></ul></div></li><li class="listitem"><p class="simpara">脚本会提示检查是否需要配置与服务器关联的IP地址的任何DNS反向（PTR）记录。
						</p><pre class="screen">Do you want to search for missing reverse zones? [yes]:</pre><p class="simpara">如果您运行搜索并发现缺少反向区域，则脚本会询问您是否创建反向区域以及PTR记录。
						</p><pre class="screen">Do you want to create reverse zone for IP 192.0.2.1 [yes]:
Please specify the reverse zone name [2.0.192.in-addr.arpa.]:
Using reverse zone(s) 2.0.192.in-addr.arpa.</pre><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p>使用Identity Management管理反向区域是可选的。您可以使用外部DNS服务来实现此目的。
							</p></div></li><li class="listitem"><p class="simpara">输入<code class="literal">yes</code>以确认服务器配置。
						</p><pre class="screen">Continue to configure the system with these values? [no]: <code class="literal">yes</code></pre></li><li class="listitem"><p class="simpara">在配置证书系统实例期间，该实用程序将打印证书签名请求（CSR）的位置： <code class="literal">/root/ipa.csr</code> ：</p><pre class="screen">...

Configuring certificate server (pki-tomcatd): Estimated time 3 minutes 30 seconds
  [1/8]: creating certificate server user
  [2/8]: configuring certificate server instance
The next step is to get /root/ipa.csr signed by your CA and re-run /sbin/ipa-server-install as:
/sbin/ipa-server-install --external-cert-file=/path/to/signed_certificate --external-cert-file=/path/to/external_ca_certificate</pre><p class="simpara">当这个情况发生时：</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">将位于<code class="literal">/root/ipa.csr</code>的CSR提交给外部CA.该过程根据要用作外部CA的服务而不同。</li><li class="listitem"><p class="simpara">在基本64位编码的blob（来自Windows CA的PEM文件或Base_64证书）中检索颁发的证书和颁发CA的CA证书链。同样，该过程因每个证书服务而异。通常，网页或通知电子邮件中的下载链接允许管理员下载所有必需的证书。
								</p><div class="important" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">重要</h3><p>确保获得CA的完整证书链，而不仅仅是CA证书。
									</p></div></li><li class="listitem"><p class="simpara">再次运行<code class="literal">ipa-server-install</code> ，这次指定新颁发的CA证书和CA链文件的位置和名称。例如：</p><pre class="screen"># ipa-server-install --external-cert-file=<span class="emphasis"><em>/tmp/servercert20170601.pem</em></span> --external-cert-file=<span class="emphasis"><em>/tmp/cacert.pem</em></span></pre></li></ol></div></li><li class="listitem">安装脚本现在配置服务器。等待操作完成。
						</li></ol></div><div class="note" style="margin-left:0.5in;margin-right:0.5in"><h3 class="title">注意</h3><p><code class="literal">ipa-server-install --external-ca</code>命令有时会失败，并显示以下错误：</p><pre class="screen">ipa         : CRITICAL failed to configure ca instance Command '/usr/sbin/pkispawn -s CA -f /tmp/<span class="emphasis"><em>configuration_file</em></span>' returned non-zero exit status 1
Configuration of CA failed</pre><p>设置<code class="literal">*_proxy</code>环境变量时会发生此故障。有关此问题的解决方案，请参阅<a class="xref" href="installing-an-ipa-server-with-external-ca_installing-identity-management.html#troubleshooting-external-ca-installation-fails" title="故障排除：外部CA安装失败">“故障排除：外部CA安装失败”一节</a> 。
					</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="troubleshooting-external-ca-installation-fails"></a>故障排除：外部CA安装失败</h1></div></div></div><p><code class="literal">ipa-server-install --external-ca</code>命令失败，并显示以下错误：</p><pre class="literallayout">ipa         : CRITICAL failed to configure ca instance Command '/usr/sbin/pkispawn -s CA -f /tmp/<span class="emphasis"><em>configuration_file</em></span>' returned non-zero exit status 1
Configuration of CA failed</pre><p><code class="literal">env|grep proxy</code>命令显示如下变量：</p><pre class="literallayout"># <span class="strong"><strong>env|grep proxy</strong></span>
http_proxy=http://example.com:8080
ftp_proxy=http://example.com:8080
https_proxy=http://example.com:8080</pre><h3><a id="what_this_means"></a>这意味着什么：</h3><p><code class="literal">*_proxy</code>环境变量阻止安装服务器。
				</p><h3><a id="to_fix_the_problem"></a>解决问题：</h3><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">使用以下shell脚本取消设置<code class="literal">*_proxy</code>环境变量：</p><pre class="literallayout"># <span class="strong"><strong>for i in ftp http https; do unset ${i}_proxy; done</strong></span></pre></li><li class="listitem"><p class="simpara">运行<code class="literal">pkidestroy</code>实用程序以删除不成功的CA子系统安装：</p><pre class="literallayout"># <span class="strong"><strong>pkidestroy -s CA -i pki-tomcat; rm -rf /var/log/pki/pki-tomcat /etc/sysconfig/pki-tomcat /etc/sysconfig/pki/tomcat/pki-tomcat /var/lib/pki/pki-tomcat /etc/pki/pki-tomcat /root/ipa.csr</strong></span></pre></li><li class="listitem"><p class="simpara">删除失败的Identity Management服务器安装：</p><pre class="literallayout"># <span class="strong"><strong>ipa-server-install --uninstall</strong></span></pre></li><li class="listitem">重试运行<code class="literal">ipa-server-install --external-ca</code> 。
						</li></ol></div></div></div></body></html>