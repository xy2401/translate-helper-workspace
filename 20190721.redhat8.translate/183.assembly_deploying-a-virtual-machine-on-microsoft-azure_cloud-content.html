<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 1. Deploying a virtual machine on Microsoft Azure</title><link rel="stylesheet" type="text/css" href="Common_Content/css/epub.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.78.1"/></head><body><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="assembly_deploying-a-virtual-machine-on-microsoft-azure_cloud-content"/>Chapter 1. Deploying a virtual machine on Microsoft Azure</h1></div></div></div><p>
			The following topics provide step-by-step guidance for deploying a Red Hat Enterprise Linux 8 virtual machine (VM) on Microsoft Azure.
		</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist"><li class="listitem">
					You need a <a class="link" href="https://azure.microsoft.com/en-us/">Microsoft Azure</a> account and a <a class="link" href="https://access.redhat.com/">Red Hat Customer Portal</a> account to successfully complete the steps.
				</li><li class="listitem">
					Enroll in <a class="link" href="https://access.redhat.com/articles/3490141">Red Hat Cloud Access</a>. Red Hat Cloud Access allows you to move your Red Hat subscriptions from physical or on-premise systems onto Microsoft Azure with full support from Red Hat.
				</li></ul></div><div class="itemizedlist"><p class="title"><strong>Additional resources</strong></p><ul class="itemizedlist"><li class="listitem">
					<a class="link" href="https://access.redhat.com/articles/3490141">Red Hat Cloud Access</a>
				</li><li class="listitem">
					<a class="link" href="https://access.redhat.com/ecosystem/ccsp/microsoft-azure">Red Hat Azure Portal</a>
				</li></ul></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="con_azure-creation-methods_deploying-a-virtual-machine-on-microsoft-azure"/>Other methods for getting an image</h1></div></div></div><p>
				In addition to the manual steps provided in the following sections, there are other ways to get a Microsoft Azure VM image. These methods are listed below. Note that while these methods may be quicker, it may be useful to complete the manual steps and learn about the required packages and configuration changes necessary for Red Hat Enterprise Linux VMs operating in Microsoft Azure.
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<span class="strong"><strong>Composer</strong></span><br/> Composer provides a pre-built image for creating a VM for Microsoft Azure. See <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/installing_and_deploying_rhel/#preparing_composer_for_creating_azure_vhd_images">Preparing Composer for Creating Azure VHD Images</a>.
					</li></ul></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<span class="strong"><strong>Microsoft Azure Marketplace</strong></span><br/> Many Red Hat Enterprise Linux images are available from the <a class="link" href="https://azuremarketplace.microsoft.com/en-us/marketplace/">Microsoft Azure Marketplace</a>. Note that there are VM usage cost differences between using your Red Hat subscriptions through the Red Hat Cloud Access program (called Bring Your Own License, or BYOL, in Microsoft Azure) and using a Pay-As-You-Go marketplace image from Microsoft. See <a class="link" href="https://docs.microsoft.com/en-us/azure/marketplace/billing-options-azure-marketplace">Billing options in the Azure Marketplace</a> for more information.
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="about-vm-images_deploying-a-virtual-machine-on-microsoft-azure"/>Using a custom base image</h1></div></div></div><p>
				To manually configure a public cloud VM (or instance), you start with a base (starter) VM image. Once the base VM image is created, you modify configuration settings and add the packages required for the VM (or instance) to operate on the public cloud platform. Further configuration changes may be made after the image is uploaded and operating. This is typically required when the VM is used for a specific application.
			</p><p>
				To prepare a KVM cloud image of RHEL, follow the instructions below. To prepare a Hyper-V cloud image of RHEL, see the <a class="link" href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/redhat-create-upload-vhd#prepare-a-red-hat-based-virtual-machine-from-kvm">Microsoft Documentation</a>.
			</p><p>
				The recommended base VM image to use for all public cloud platforms is the <span class="strong"><strong>Red Hat Enterprise Linux 8 KVM Guest Image</strong></span> downloaded from the <a class="link" href="https://access.redhat.com/products/red-hat-enterprise-linux/">Red Hat Customer Portal</a>. The KVM Guest Image is pre-configured with the following cloud configuration settings.
			</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
						<span class="emphasis"><em>The root account is disabled.</em></span> For several public cloud platforms, you temporarily enable root account access to make configuration changes and install packages required for the public cloud. The instructions for temporarily enabling root account access are provided in this guide.
					</li><li class="listitem">
						<span class="emphasis"><em>A user account named <code class="literal">cloud-user</code> is pre-configured on the image.</em></span> The <code class="literal">cloud-user</code> account has sudo access.
					</li><li class="listitem">
						<span class="emphasis"><em>The image has <code class="literal">cloud-init</code> installed and enabled.</em></span> <code class="literal">cloud-init</code> is a service that handles provisioning of the VM (or instance) at initial boot.
					</li></ul></div><p>
				You can choose to use a custom Red Hat Enterprise Linux ISO image. However, note that when using a custom ISO image, additional configuration tasks may be necessary for the resulting VM to operate on the public cloud platform.
			</p><div class="title"><strong>Additional resources</strong></div><p>
					<a class="link" href="https://access.redhat.com/products/red-hat-enterprise-linux/">Red Hat Enterprise Linux</a>
				</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="required-system-packages_deploying-a-virtual-machine-on-microsoft-azure"/>Required system packages</h2></div></div></div><p>
					The procedure assumes you are creating a VM image for Azure using Red Hat Enterprise Linux or Fedora. To successfully complete the procedure, you need to have the packages listed in the following table installed. Note that these packages are located in the base <code class="literal">fedora</code> repository (if using Fedora).
				</p><div class="table"><a id="idm139646041348688"/><p class="title"><strong>Table 1.1. System Packages</strong></p><div class="table-contents"><table summary="System Packages" border="1"><colgroup><col class="col_1"/><col class="col_2"/><col class="col_3"/></colgroup><thead><tr><th style="text-align: left" valign="top">Package</th><th style="text-align: left" valign="top">Repository</th><th style="text-align: left" valign="top">Description</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									libvirt
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									rhel-8-for-x86_64-appstream-rpms
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Open source API, daemon, and management tool for managing platform virtualization
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									virt-install
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									rhel-8-for-x86_64-appstream-rpms
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									A command-line utility for building VMs
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									libguestfs
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									rhel-8-for-x86_64-appstream-rpms
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									A library for accessing and modifying virtual machine file systems
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									libguestfs-tools
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									rhel-8-for-x86_64-appstream-rpms
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									System administration tools for virtual machines; includes the guestfish utility
								</p>
								 </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="azure-vm-configuration-settings_deploying-a-virtual-machine-on-microsoft-azure"/>Azure virtual machine configuration settings</h2></div></div></div><p>
					Microsoft Azure VMs must have the following configuration settings. Some of these settings are enabled during the initial VM creation. Other settings are set when provisioning the VM image for Microsoft Azure. Keep these settings in mind as you move through the procedure and refer back to them if you need to.
				</p><div class="table"><a id="idm139646050820672"/><p class="title"><strong>Table 1.2. VM Configuration Settings</strong></p><div class="table-contents"><table summary="VM Configuration Settings" border="1"><colgroup><col class="col_1"/><col class="col_2"/></colgroup><thead><tr><th style="text-align: left" valign="top">Setting</th><th style="text-align: left" valign="top">Recommendation</th></tr></thead><tbody><tr><td style="text-align: left" valign="top"> <p>
									ssh
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									ssh must be enabled to provide remote access to your Azure VMs.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									dhcp
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									The primary virtual adapter should be configured for dhcp (IPv4 only).
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									Swap Space
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Do not create a dedicated swap file or swap partition. Swap space may be configured in the Windows Azure Linux Agent.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									NIC
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Choose <span class="strong"><strong>virtio</strong></span> for the primary virtual network adapter.
								</p>
								 </td></tr><tr><td style="text-align: left" valign="top"> <p>
									encryption
								</p>
								 </td><td style="text-align: left" valign="top"> <p>
									Do not use full disk encryption for the operating system disk. Red Hat does not currently support operating system disk encryption for RHEL VMs in Microsoft Azure. Data disks can be encrypted.
								</p>
								 </td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="create-a-vm-from-a-kvm-guest-image_deploying-a-virtual-machine-on-microsoft-azure"/>Creating a base image from a KVM Guest image</h2></div></div></div><p>
					Red Hat and the open source community continually optimize the KVM Guest image for virtualized environments. Once you have the image configured, you can use this image as a template for creating additional virtual machine instances.
				</p><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist"><li class="listitem">
							Download the latest Red Hat Enterprise Linux 8 KVM Guest image from the <a class="link" href="https://access.redhat.com/downloads/content/69/">Red Hat Customer Portal</a>.
						</li><li class="listitem"><p class="simpara">
							Create and start a basic Red Hat Enterprise Linux VM. For instructions, see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_virtualization/getting-started-with-virtualization-in-rhel-8_configuring-and-managing-virtualization#assembly_creating-virtual-machines_virt-getting-started">Configuring and managing virtualization</a> document. When creating the VM, use the following configuration settings.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									Change the default memory and CPUs to the capacity settings you want for the VM.
								</li><li class="listitem">
									Select <span class="strong"><strong>virtio</strong></span> for the virtual network interface.
								</li></ul></div></li><li class="listitem">
							Shut down the new VM after a login prompt appears.
						</li><li class="listitem"><p class="simpara">
							Set up root access to the VM. From your system, use <code class="literal">virt-customize</code> to generate a root password for the VM.
						</p><pre class="screen"># virt-customize -a &lt;guest-image-path&gt; --root-password password:&lt;PASSWORD&gt;</pre><p class="simpara">
							Example:
						</p><pre class="screen"># virt-customize -a /var/lib/libvirt/images/rhel-guest-image-8.0-120.x86_64.qcow2 --root-password password:redhat!
[   0.0] Examining the guest ...
[ 103.0] Setting a random seed
[ 103.0] Setting passwords
[ 112.0] Finishing off</pre></li><li class="listitem">
							Verfiy root access by starting the RHEL VM and logging in as <code class="literal">root</code>.
						</li><li class="listitem">
							Once you are logged in as root you can configure the image.
						</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="create-a-vm-from-an-iso-image_deploying-a-virtual-machine-on-microsoft-azure"/>Creating a base image from an ISO image</h2></div></div></div><p>
					The following procedure lists the steps and initial configuration requirements for creating a custom ISO image. Once you have the image configured, you can use this image as a template for creating additional virtual machine instances.
				</p><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist"><li class="listitem">
							Download the latest Red Hat Enterprise Linux 8 Binary DVD ISO image from the <a class="link" href="https://access.redhat.com/downloads/content/69/">Red Hat Customer Portal</a>.
						</li><li class="listitem"><p class="simpara">
							When creating the base VM from the ISO image, use the following initial configuration settings:
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									Choose the memory and CPUs you want to use for the VM.
								</li><li class="listitem">
									Select <span class="strong"><strong>virtio</strong></span> for the virtual network interface.
								</li><li class="listitem">
									Set a generic host name and verify that <span class="strong"><strong>ens3</strong></span> is enabled.
								</li></ul></div></li><li class="listitem"><p class="simpara">
							Review the following additional installation selection and modifications.
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									Select <span class="strong"><strong>Minimal Install</strong></span>.
								</li><li class="listitem"><p class="simpara">
									For <span class="strong"><strong>Installation Destination</strong></span>, select <span class="strong"><strong>Custom Storage Configuration</strong></span>. Use the following configuration information to make your selections.
								</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
											Verify at least 500 MB for <span class="strong"><strong>/boot</strong></span>. The remaining space may be used for root <span class="strong"><strong>/</strong></span>.
										</li><li class="listitem">
											Logical Volume Management (LVM) may be used but Standard Partitions are recommended.
										</li><li class="listitem">
											File System: xfs, ext4, or ext3 may be used.
										</li></ul></div></li><li class="listitem">
									<span class="strong"><strong>Microsoft Azure only:</strong></span> Remove swap space. Swap space is configured on the physical blade server in Azure by the WALinuxAgent.
								</li></ul></div></li><li class="listitem"><p class="simpara">
							When the install starts:
						</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
									Create a <span class="strong"><strong>root</strong></span> password.
								</li><li class="listitem">
									Create an administrative user account.
								</li></ul></div></li><li class="listitem">
							When installation is complete, reboot the VM and log in to the root account.
						</li><li class="listitem">
							Once you are logged in as root you can configure the image.
						</li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="configure-the-image"/>Configuring the base image for Microsoft Azure</h1></div></div></div><p>
				The base image requires configuration changes to serve as your gold Red Hat Enterprise Linux 8 VM image in Microsoft Azure. The following sections provide the additional configuration changes required.
			</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="installing-hyperv-drivers_deploying-a-virtual-machine-on-microsoft-azure"/>Installing Hyper-V device drivers</h2></div></div></div><p>
					Microsoft provides network and storage device drivers as part of their Linux Integration Services for Hyper-V package. Hyper-V device drivers may need to be installed on the VM image prior to provisioning it as a Microsoft Azure VM. Use the <code class="literal">lsinitrd | grep hv</code> command to verify that the drivers are installed.
				</p><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">
							Enter the following <code class="literal">grep</code> command to determine if all of the required Hyper-V device drivers are installed.
						</p><pre class="screen"># lsinitrd | grep hv</pre><p class="simpara">
							In the example below, all the drivers are installed.
						</p><pre class="screen"># lsinitrd | grep hv
drwxr-xr-x   2 root     root            0 Aug 12 14:21 usr/lib/modules/3.10.0-932.el7.x86_64/kernel/drivers/hv
-rw-r--r--   1 root     root        31272 Aug 11 08:45 usr/lib/modules/3.10.0-932.el7.x86_64/kernel/drivers/hv/hv_vmbus.ko.xz
-rw-r--r--   1 root     root        25132 Aug 11 08:46 usr/lib/modules/3.10.0-932.el7.x86_64/kernel/drivers/net/hyperv/hv_netvsc.ko.xz
-rw-r--r--   1 root     root         9796 Aug 11 08:45 usr/lib/modules/3.10.0-932.el7.x86_64/kernel/drivers/scsi/hv_storvsc.ko.xz</pre><p class="simpara">
							If all the drivers are not installed, complete the remaining steps.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								An <code class="literal">hv_vmbus</code> driver may already exist in the environment. Even if this driver is present, complete the following steps.
							</p></div></li><li class="listitem">
							Create a file named <code class="literal">dracut.conf</code> in <code class="literal">/etc/dracut.conf.d</code>.
						</li><li class="listitem"><p class="simpara">
							Add the following driver parameters to the <code class="literal">dracut.conf</code> file.
						</p><pre class="screen">add_drivers+=" hv_vmbus "
add_drivers+=" hv_netvsc "
add_drivers+=" hv_storvsc "</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								Note the spaces before and after the quotes, for example, <code class="literal">add_drivers+=" hv_vmbus "</code>. This ensures that unique drivers are loaded in the event that other Hyper-V drivers already exist in the environment.
							</p></div></li><li class="listitem"><p class="simpara">
							Regenerate the <code class="literal">intramfs</code> image.
						</p><pre class="screen"># dracut -f -v --regenerate-all</pre></li><li class="listitem">
							Verify that the drivers are installed by running the <code class="literal">lsinitrd | grep hv</code> command.
						</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="making-configuration-changes_deploying-a-virtual-machine-on-microsoft-azure"/>Making additional configuration changes</h2></div></div></div><p>
					The VM requires further configuration changes to operate in Microsoft Azure. Complete the following steps to make these changes.
				</p><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist"><li class="listitem">
							If necessary, power on the VM.
						</li><li class="listitem"><p class="simpara">
							Stop the <code class="literal">cloud-init</code> service (if present).
						</p><pre class="screen"># systemctl stop cloud-init</pre></li><li class="listitem"><p class="simpara">
							Remove the <code class="literal">cloud-init</code> software.
						</p><pre class="screen"># yum remove cloud-init</pre></li><li class="listitem"><p class="simpara">
							Edit the <code class="literal">/etc/ssh/sshd_config</code> file and enable password authentication.
						</p><pre class="screen">PasswordAuthentication yes</pre></li><li class="listitem"><p class="simpara">
							Set a generic host name.
						</p><pre class="screen"># hostnamectl set-hostname localhost.localdomain</pre></li><li class="listitem"><p class="simpara">
							Edit (or create) the <code class="literal">/etc/sysconfig/network-scripts/ifcfg-eth0</code> file. Use only the parameters listed below.
						</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
								The <code class="literal">ifcfg-eth0</code> file does not exist on the RHEL 8 DVD ISO image and needs to be created.
							</p></div><pre class="screen">DEVICE="eth0"
ONBOOT="yes"
BOOTPROTO="dhcp"
TYPE="Ethernet"
USERCTL="yes"
PEERDNS="yes"
IPV6INIT="no"</pre></li><li class="listitem"><p class="simpara">
							Remove all persistent network device rules (if present).
						</p><pre class="screen"># rm -f /etc/udev/rules.d/70-persistent-net.rules
# rm -f /etc/udev/rules.d/75-persistent-net-generator.rules
# rm -f /etc/udev/rules.d/80-net-name-slot-rules</pre></li><li class="listitem"><p class="simpara">
							Set <code class="literal">ssh</code> to start automatically.
						</p><pre class="screen"># systemctl enable sshd
# systemctl is-enabled sshd</pre></li><li class="listitem"><p class="simpara">
							Modify the kernel boot parameters.
						</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">
									Add <code class="literal">crashkernel=256</code> to the start of the <code class="literal">GRUB_CMDLINE_LINUX</code> line in <code class="literal">/etc/default/grub</code> file. If <code class="literal">crashkernel=auto</code> is present, change it to <code class="literal">crashkernel=256M</code>.
								</li><li class="listitem"><p class="simpara">
									Add the following lines to the end of the <code class="literal">GRUB_CMDLINE_LINUX</code> line (if not present).
								</p><pre class="screen">earlyprintk=ttyS0
console=ttyS0
rootdelay=300</pre></li><li class="listitem"><p class="simpara">
									Remove the following options, if they are present.
								</p><pre class="screen">rhgb
quiet</pre></li></ol></div></li><li class="listitem"><p class="simpara">
							Regenerate the <code class="literal">grub.cfg</code> file.
						</p><pre class="screen"># grub2-mkconfig -o /boot/grub2/grub.cfg</pre></li><li class="listitem"><p class="simpara">
							Register the VM and enable the Red Hat Enterprise Linux 8 repository.
						</p><pre class="screen"># subscription-manager register --auto-attach</pre></li><li class="listitem"><p class="simpara">
							Install and enable the Windows Azure Linux Agent (WALinuxAgent). The WALinuxAgent is included in Red Hat Enterprise Linux 8 Application Stream (AppStream). See <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/using_application_stream/">Using Application Stream</a> for more information.
						</p><pre class="screen"># yum install WALinuxAgent -y
# systemctl enable waagent</pre></li><li class="listitem"><p class="simpara">
							Edit the following lines in the <code class="literal">/etc/waagent.conf</code> file to configure swap space for provisioned VMs. Set swap space for whatever is appropriate for your provisioned VMs.
						</p><pre class="screen">Provisioning.DeleteRootPassword=n
ResourceDisk.Filesystem=ext4
ResourceDisk.EnableSwap=y
ResourceDisk.SwapSizeMB=2048</pre></li><li class="listitem"><p class="simpara">
							Unregister the VM from Red Hat Subscription Manager.
						</p><pre class="screen"># subscription-manager unregister</pre></li><li class="listitem"><p class="simpara">
							Prepare the VM for Microsoft Azure provisioning by cleaning up the existing provisioning details. Azure reprovisions the VM in Azure. This command generates warnings, which is expected.
						</p><pre class="screen"># waagent -force -deprovision</pre></li><li class="listitem"><p class="simpara">
							Clean the shell history and shut down the VM.
						</p><pre class="screen"># export HISTSIZE=0
# poweroff</pre></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="convert-image"/>Converting the image to a fixed VHD format</h1></div></div></div><p>
				All Azure VM images must be in a fixed VHD format. The image must be aligned on a 1 MB boundary before it is converted to VHD. This section describes how to convert the image from <code class="literal">qcow2</code> to a fixed <code class="literal">VHD</code> format and align the image if necessary. Once you have converted the image, it can be uploaded to Microsoft Azure.
			</p><div class="title"><strong>Procedure</strong></div><p>
					<span class="strong"><strong>Verifying the image size</strong></span>
				</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Convert the image from <code class="literal">qcow2</code> to <code class="literal">raw</code> format.
					</p><pre class="screen">$ qemu-img convert -f qcow2 -O raw &lt;image-xxx&gt;.qcow2 &lt;image-xxx&gt;.raw</pre></li><li class="listitem"><p class="simpara">
						Create a shell script using the contents below.
					</p><pre class="screen">#!/bin/bash
MB=$((1024 * 1024))
size=$(qemu-img info -f raw --output json "$1" | gawk 'match($0, /"virtual-size": ([0-9]+),/, val) {print val[1]}')
rounded_size=$((($size/$MB + 1) * $MB))
if [ $(($size % $MB)) -eq  0 ]
then
 echo "Your image is already aligned. You do not need to resize."
 exit 1
fi
echo "rounded size = $rounded_size"
export rounded_size</pre></li><li class="listitem"><p class="simpara">
						Run the script. The name <code class="literal">align.sh</code> is used in the example.
					</p><pre class="screen">$ sh align.sh &lt;image-xxx&gt;.raw</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
								If the message <span class="emphasis"><em>"Your image is already aligned. You do not need to resize."</em></span> is displayed, proceed to the following step.
							</li><li class="listitem">
								If a value is displayed, your image is not aligned. Go to <a class="link" href="assembly_deploying-a-virtual-machine-on-microsoft-azure_cloud-content.html#align-image">Aligning the image</a> and convert it to a fixed VHD format. Use the value displayed to resize the image.
							</li></ul></div></li><li class="listitem"><p class="simpara">
						Use the command below to convert the file to a fixed <code class="literal">VHD</code> format. The additional option <code class="literal">force_size</code> must be added when using Fedora 22 or later.
					</p><p class="simpara">
						<span class="strong"><strong>RHEL server or workstation (using qemu-image version 1.5.3)</strong></span>
					</p><pre class="screen">$ qemu-img convert -f raw -o subformat=fixed -O vpc &lt;image-xxx&gt;.raw &lt;image.xxx&gt;.vhd</pre><p class="simpara">
						<span class="strong"><strong>Fedora 22 or later (using qemu-img version 2.6 or later)</strong></span>
					</p><pre class="screen">$ qemu-img convert -f raw -o subformat=fixed,force_size -O vpc &lt;image-xxx&gt;.raw &lt;image.xxx&gt;.vhd</pre><p class="simpara">
						Once converted, the VHD file is ready for uploading to Microsoft Azure.
					</p></li></ol></div><p><a id="align-image"/>
				<span class="strong"><strong>Aligning the image</strong></span>
			</p><p>
				Complete the steps below only if the raw file is not aligned.
			</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Resize the raw file using the rounded value displayed when you ran the verification script.
					</p><pre class="screen">$ qemu-img resize -f raw &lt;image-xxx&gt;.raw &lt;rounded-value&gt;</pre></li><li class="listitem"><p class="simpara">
						Convert the raw image file to a VHD format.
					</p><p class="simpara">
						<span class="strong"><strong>RHEL server or workstation (using qemu-image version 1.5.3)</strong></span>
					</p><pre class="screen">$ qemu-img convert -f raw -o subformat=fixed -O vpc &lt;image-xxx&gt;.raw &lt;image.xxx&gt;.vhd</pre><p class="simpara">
						<span class="strong"><strong>Fedora 22 or later (using qemu-img version 2.6 or later)</strong></span>
					</p><pre class="screen">$ qemu-img convert -f raw -o subformat=fixed,force_size -O vpc &lt;image-xxx&gt;.raw &lt;image.xxx&gt;.vhd</pre><p class="simpara">
						Once converted, the VHD file is ready for uploading to Microsoft Azure.
					</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="install-the-azure-cli_deploying-a-virtual-machine-on-microsoft-azure"/>Installing the Azure CLI</h1></div></div></div><p>
				Complete the following steps to install the Azure command-line interface (Azure CLI 2.0). Azure CLI 2.0 is a Python-based utility that is used to create and manage VMs in Microsoft Azure.
			</p><div class="itemizedlist"><p class="title"><strong>Prerequisites</strong></p><ul class="itemizedlist"><li class="listitem">
						You need to have an account with <a class="link" href="https://azure.microsoft.com/en-us/free/">Microsoft Azure</a> before you can use Azure CLI.
					</li><li class="listitem">
						The Azure CLI installation requires Python 2.7.x or Python 3.x and OpenSSL 1.0.2.
					</li></ul></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Import the Microsoft repository key.
					</p><pre class="screen">$ sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc</pre></li><li class="listitem"><p class="simpara">
						Create a local Azure CLI repository entry.
					</p><pre class="screen">$ sudo sh -c 'echo -e "[azure-cli]\nname=Azure CLI\nbaseurl=https://packages.microsoft.com/yumrepos/azure-cli\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" &gt; /etc/yum.repos.d/azure-cli.repo'</pre></li><li class="listitem"><p class="simpara">
						Update the <code class="literal">yum</code> package index.
					</p><pre class="screen">$ yum check-update</pre></li><li class="listitem"><p class="simpara">
						Install python2.
					</p><pre class="screen">$ sudo yum install python2</pre></li><li class="listitem"><p class="simpara">
						Install the Azure CLI.
					</p><pre class="screen">$ sudo yumdownloader azure-cli
$ sudo rpm -ivh --nodeps azure-cli-2.0.64-1.el7.x86_64.rpm</pre><p class="simpara">
						If the <code class="literal">yumdownloader</code> command fails with "command not found", install the <span class="strong"><strong>dnf-utils</strong></span> package first. In the <code class="literal">rpm</code> command, replace the version of the <code class="literal">azure-cli</code> package with that downloaded using <code class="literal">yumdownloader</code>.
					</p></li><li class="listitem"><p class="simpara">
						Run the Azure CLI.
					</p><pre class="screen">$ az</pre></li></ol></div><div class="itemizedlist"><p class="title"><strong>Additional resources</strong></p><ul class="itemizedlist"><li class="listitem">
						<a class="link" href="https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest">Azure CLI</a>
					</li><li class="listitem">
						<a class="link" href="https://docs.microsoft.com/en-us/cli/azure/reference-index?view=azure-cli-latest">Azure CLI command reference</a>
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="create-azure-resources"/>Creating resources in Microsoft Azure</h1></div></div></div><p>
				Complete the procedures in the following sections to upload the <code class="literal">vhd</code> file, create a gold Azure custom image, and start a RHEL VM in Microsoft Azure.
			</p><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Enter the following command to authenticate your system with Microsoft Azure and log in.
					</p><pre class="screen">$ az login</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az login
To sign in, use a web browser to open the page https://aka.ms/devicelogin and enter the code FDMSCMETZ to authenticate.
  [
    {
      "cloudName": "AzureCloud",
      "id": "",
      "isDefault": true,
      "name": "",
      "state": "Enabled",
      "tenantId": "",
      "user": {
        "name": "",
        "type": "user"
      }
    }
  ]</pre></li><li class="listitem"><p class="simpara">
						Create a resource group in an Azure region.
					</p><pre class="screen">$ az group create --name &lt;resource-group&gt; --location &lt;azure-region&gt;</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az group create --name azrhelclirsgrp --location southcentralus
{
  "id": "/subscriptions//resourceGroups/azrhelclirsgrp",
  "location": "southcentralus",
  "managedBy": null,
  "name": "azrhelclirsgrp",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null
}</pre></li><li class="listitem"><p class="simpara">
						Create a storage account. See <a class="link" href="https://docs.microsoft.com/en-us/rest/api/storagerp/srp_sku_types">SKU Types</a> for more information about valid SKU values.
					</p><pre class="screen">$ az storage account create -l &lt;azure-region&gt; -n &lt;storage-account-name&gt; -g &lt;resource-group&gt; --sku &lt;sku_type&gt;</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az storage account create -l southcentralus -n azrhelclistact -g azrhelclirsgrp --sku Standard_LRS
{
  "accessTier": null,
  "creationTime": "2017-04-05T19:10:29.855470+00:00",
  "customDomain": null,
  "encryption": null,
  "id": "/subscriptions//resourceGroups/azrhelclirsgrp/providers/Microsoft.Storage/storageAccounts/azrhelclistact",
  "kind": "Storage",
  "lastGeoFailoverTime": null,
  "location": "southcentralus",
  "name": "azrhelclistact",
  "primaryEndpoints": {
    "blob": "https://azrhelclistact.blob.core.windows.net/",
    "file": "https://azrhelclistact.file.core.windows.net/",
    "queue": "https://azrhelclistact.queue.core.windows.net/",
    "table": "https://azrhelclistact.table.core.windows.net/"
},
"primaryLocation": "southcentralus",
"provisioningState": "Succeeded",
"resourceGroup": "azrhelclirsgrp",
"secondaryEndpoints": null,
"secondaryLocation": null,
"sku": {
  "name": "Standard_LRS",
  "tier": "Standard"
},
"statusOfPrimary": "available",
"statusOfSecondary": null,
"tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}</pre></li><li class="listitem"><p class="simpara">
						Get the storage account connection string.
					</p><pre class="screen">$ az storage account show-connection-string -n &lt;storage-account-name&gt; -g &lt;resource-group&gt;</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az storage account show-connection-string -n azrhelclistact -g azrhelclirsgrp
{
  "connectionString": "DefaultEndpointsProtocol=https;EndpointSuffix=core.windows.net;AccountName=azrhelclistact;AccountKey=NreGk...=="
}</pre></li><li class="listitem"><p class="simpara">
						Export the connection string. Copy the connection string and paste it into the following command. This string connects your system to the storage account.
					</p><pre class="screen">$ export AZURE_STORAGE_CONNECTION_STRING="&lt;storage-connection-string&gt;"</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ export AZURE_STORAGE_CONNECTION_STRING="DefaultEndpointsProtocol=https;EndpointSuffix=core.windows.net;AccountName=azrhelclistact;AccountKey=NreGk...=="</pre></li><li class="listitem"><p class="simpara">
						Create the storage container.
					</p><pre class="screen">$ az storage container create -n &lt;container-name&gt;</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az storage container create -n azrhelclistcont
{
  "created": true
}</pre></li><li class="listitem"><p class="simpara">
						Create a virtual network.
					</p><pre class="screen">$ az network vnet create -g &lt;resource group&gt; --name &lt;vnet-name&gt; --subnet-name &lt;subnet-name&gt;</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az network vnet create --resource-group azrhelclirsgrp --name azrhelclivnet1 --subnet-name azrhelclisubnet1
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
      "10.0.0.0/16"
      ]
  },
  "dhcpOptions": {
    "dnsServers": []
  },
  "etag": "W/\"\"",
  "id": "/subscriptions//resourceGroups/azrhelclirsgrp/providers/Microsoft.Network/virtualNetworks/azrhelclivnet1",
  "location": "southcentralus",
  "name": "azrhelclivnet1",
  "provisioningState": "Succeeded",
  "resourceGroup": "azrhelclirsgrp",
  "resourceGuid": "0f25efee-e2a6-4abe-a4e9-817061ee1e79",
  "subnets": [
    {
      "addressPrefix": "10.0.0.0/24",
      "etag": "W/\"\"",
      "id": "/subscriptions//resourceGroups/azrhelclirsgrp/providers/Microsoft.Network/virtualNetworks/azrhelclivnet1/subnets/azrhelclisubnet1",
      "ipConfigurations": null,
      "name": "azrhelclisubnet1",
      "networkSecurityGroup": null,
      "provisioningState": "Succeeded",
      "resourceGroup": "azrhelclirsgrp",
      "resourceNavigationLinks": null,
      "routeTable": null
    }
  ],
  "tags": {},
  "type": "Microsoft.Network/virtualNetworks",
  "virtualNetworkPeerings": null
  }
}</pre></li></ol></div><div class="itemizedlist"><p class="title"><strong>Additional resources</strong></p><ul class="itemizedlist"><li class="listitem">
						<a class="link" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/managed-disks-overview">Azure Managed Disks Overview</a>
					</li><li class="listitem">
						<a class="link" href="https://docs.microsoft.com/en-us/rest/api/storagerp/srp_sku_types">SKU Types</a>
					</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="upload-image-to-azure_deploying-a-virtual-machine-on-microsoft-azure"/>Uploading and creating an Azure gold image</h1></div></div></div><p>
				Complete the following steps to upload the VHD file to your container and create a gold Azure custom image.
			</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
					The exported storage connection string does not persist after a system reboot. If any of commands in the following steps fail, export the connection string again. See Step 5 in <a class="link" href="assembly_deploying-a-virtual-machine-on-microsoft-azure_cloud-content.html#create-azure-resources" title="Creating resources in Microsoft Azure">Creating resources in Microsoft Azure</a>.
				</p></div><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Upload the <code class="literal">vhd</code> file to the storage container. It may take several minutes. To get a list of storage containers, enter <code class="literal">az storage container list</code>.
					</p><pre class="screen">$ az storage blob upload --account-name &lt;storage-account-name&gt; --container-name &lt;container-name&gt; --type page --file &lt;path-to-vhd&gt; --name &lt;image-name&gt;.vhd</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az storage blob upload --account-name azrhelclistact --container-name azrhelclistcont --type page --file rhel-image-8.vhd --name rhel-image-8.vhd
Percent complete: %100.0</pre></li><li class="listitem"><p class="simpara">
						Get the URL for the uploaded <code class="literal">vhd</code> file. You will use this URL in the following step.
					</p><pre class="screen">$ az storage blob url -c &lt;container-name&gt; -n &lt;image-name&gt;.vhd</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az storage blob url -c azrhelclistcont -n rhel-image-8.vhd "https://azrhelclistact.blob.core.windows.net/azrhelclistcont/rhel-image-8.vhd"</pre></li><li class="listitem"><p class="simpara">
						Create the gold Azure custom image.
					</p><pre class="screen">$ az image create -n &lt;gold-image-name&gt; -g &lt;resource-group&gt; -l &lt;azure-region&gt; --source &lt;URL&gt; --os-type linux</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							The command may return the error "Only blobs formatted as VHDs can be imported." This error may mean that the image was not aligned to the nearest 1 MB boundary before it was converted to VHD. See <a class="link" href="assembly_deploying-a-virtual-machine-on-microsoft-azure_cloud-content.html#convert-image" title="Converting the image to a fixed VHD format">Converting the image to fixed VHD format</a> for more information.
						</p></div><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az image create -n rhel8 -g azrhelclirsgrp2 -l southcentralus --source https://azrhelclistact.blob.core.windows.net/azrhelclistcont/rhel-image-8.vhd --os-type linux</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="create-start-the-VM_deploying-a-virtual-machine-on-microsoft-azure"/>Creating and starting the VM in Microsoft Azure</h1></div></div></div><p>
				The following steps provide the minimum command options to create a managed-disk Azure VM from the image. See <a class="link" href="https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-create">az vm create</a> for additional options.
			</p><div class="orderedlist"><p class="title"><strong>Procedure</strong></p><ol class="orderedlist"><li class="listitem"><p class="simpara">
						Enter the following command to create the VM.
					</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
							The option <code class="literal">--generate-ssh-keys</code> creates a private/public key pair. Private and public key files are created in <code class="literal">~/.ssh</code> on your system. The public key is added to the <code class="literal">authorized_keys</code> file on the VM for the user specified by the <code class="literal">--admin-username</code> option. See <a class="link" href="assembly_deploying-a-virtual-machine-on-microsoft-azure_cloud-content.html#other-methods" title="Other authentication methods">Other authentication methods</a> for additional information.
						</p></div><pre class="screen">$ az vm create -g &lt;resource-group&gt; -l &lt;azure-region&gt; -n &lt;vm-name&gt; --vnet-name &lt;vnet-name&gt; --subnet &lt;subnet-name&gt; --size Standard_A2 --os-disk-name &lt;simple-name&gt; --admin-username &lt;administrator-name&gt; --generate-ssh-keys --image &lt;path-to-image&gt;</pre><p class="simpara">
						Example:
					</p><pre class="screen">[clouduser@localhost]$ az vm create -g azrhelclirsgrp2 -l southcentralus -n rhel-azure-vm-1 --vnet-name azrhelclivnet1 --subnet azrhelclisubnet1  --size Standard_A2 --os-disk-name vm-1-osdisk --admin-username clouduser --generate-ssh-keys --image rhel8

{
  "fqdns": "",
  "id": "/subscriptions//resourceGroups/azrhelclirsgrp/providers/Microsoft.Compute/virtualMachines/rhel-azure-vm-1",
  "location": "southcentralus",
  "macAddress": "",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4",
  "publicIpAddress": "&lt;public-IP-address&gt;",
  "resourceGroup": "azrhelclirsgrp2"</pre><p class="simpara">
						Note the <code class="literal">publicIpAddress</code>. You need this to log in to the VM in the following step.
					</p></li><li class="listitem"><p class="simpara">
						Start an SSH session and log in to the VM.
					</p><pre class="screen">[clouduser@localhost]$ ssh  -i /home/clouduser/.ssh/id_rsa clouduser@&lt;public-IP-address&gt;.
The authenticity of host ',&lt;public-IP-address&gt;' can't be established.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '&lt;public-IP-address&gt;' (ECDSA) to the list of known hosts.

[clouduser@rhel-azure-vm-1 ~]$</pre></li></ol></div><p>
				If you see a user prompt, you have successfully deployed your Azure VM.
			</p><p>
				You can now go to the Microsoft Azure portal and check the audit logs and properties of your resources. You can manage your VMs directly in the Microsoft Azure portal. If you are managing multiple VMs, you should use the Azure CLI. The Azure CLI provides a powerful interface to your resources in Azure. Enter <code class="literal">az --help</code> in the CLI or see the Azure CLI Command Reference to learn more about the commands you use to manage your VMs in Microsoft Azure.
			</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="other-methods"/>Other authentication methods</h1></div></div></div><p>
				While recommended for increased security, the use of the Azure-generated key pair is not a requirement. The following examples show two other methods for SSH authentication.
			</p><p>
				<span class="strong"><strong>Example 1:</strong></span> These command options provision a new VM without generating a public key file. They allow SSH authentication using a password.
			</p><pre class="screen">$ az vm create -g &lt;resource-group&gt; -l &lt;azure-region&gt; -n &lt;vm-name&gt; --vnet-name &lt;vnet-name&gt; --subnet &lt;subnet-name&gt; --size Standard_A2 --os-disk-name &lt;simple-name&gt; --authentication-type password --admin-username &lt;administrator-name&gt; --admin-password &lt;ssh-password&gt; --image &lt;path-to-image&gt;</pre><pre class="screen">$ ssh &lt;admin-username&gt;@&lt;public-ip-address&gt;</pre><p>
				<span class="strong"><strong>Example 2:</strong></span> These command options provision a new Azure VM and allow SSH authentication using an existing public key file.
			</p><pre class="screen">$ az vm create -g &lt;resource-group&gt; -l &lt;azure-region&gt; -n &lt;vm-name&gt; --vnet-name &lt;vnet-name&gt; --subnet &lt;subnet-name&gt; --size Standard_A2 --os-disk-name &lt;simple-name&gt; --admin-username &lt;administrator-name&gt; --ssh-key-value &lt;path-to-existing-ssh-key&gt; --image &lt;path-to-image&gt;</pre><pre class="screen">$ ssh -i &lt;path-to-existing-ssh-key&gt; &lt;admin-username&gt;@&lt;public-ip-address&gt;</pre></div></div></body></html>