<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Developing Applications with the Publish-Subscribe Model</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="Database Development Guide">
      <meta property="og:description" content>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="Database Development Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="database-development-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2019-01-31T23:23:15-08:00">
      <meta name="dcterms.title" content="Database Development Guide">
      <meta name="dcterms.dateCopyrighted" content="1996, 2019">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E96334-02">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19">
      
      <link rel="prev" href="xa.html" title="Previous" type="text/html">
      <link rel="next" href="odbc-driver.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="ADFNS">
    <meta name="dcterms.release" content="Release 19">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="xa.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="odbc-driver.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">Database Development Guide</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="advanced-part.html" property="item" typeof="WebPage"><span property="name">Advanced Topics for Application Developers</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Developing Applications with the Publish-Subscribe Model</li>
            </ol>
            <a id="GUID-AF669B8F-426E-45D2-BC02-7647CAD25B7A" name="GUID-AF669B8F-426E-45D2-BC02-7647CAD25B7A"></a><a id="ADFNS1111"></a><a id="ADFNS014"></a>
            
            <h2 id="ADFNS-GUID-AF669B8F-426E-45D2-BC02-7647CAD25B7A" class="sect2"><span class="enumeration_chapter">23 </span>Developing Applications with the Publish-Subscribe Model
            </h2>
         </header>
         <div class="ind">
            <div>
               <p>This chapter explains how to develop applications on the publish-subscribe model.</p>
               <div class="section">
                  <p class="subhead1" id="GUID-AF669B8F-426E-45D2-BC02-7647CAD25B7A__GUID-612C8B61-4E2D-43F4-82DD-C2C0D1DF1EE1">Topics:</p>
               </div>
               <!-- class="section" -->
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="publish-subscribe-model.html#GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25">Introduction to the Publish-Subscribe Model</a></p>
                  </li>
                  <li>
                     <p><a href="publish-subscribe-model.html#GUID-8DE18549-CD9E-4EA7-87B4-53FC4474570C">Publish-Subscribe Architecture</a></p>
                  </li>
                  <li>
                     <p><a href="publish-subscribe-model.html#GUID-327BA412-08EB-41E2-9059-B49355ABA51D">Publish-Subscribe Concepts</a></p>
                  </li>
                  <li>
                     <p><a href="publish-subscribe-model.html#GUID-3E344EF4-8AD0-442E-9E18-D0747C491E40">Examples of a Publish-Subscribe Mechanism</a></p>
                  </li>
               </ul>
            </div><a id="ADFNS826"></a><a id="ADFNS1601"></a><div class="props_rev_3"><a id="GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25" name="GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25"></a><h3 id="ADFNS-GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25" class="sect3">Introduction to the Publish-Subscribe Model</h3>
               <div>
                  <p>Because the database is the most significant resource of information within the enterprise, Oracle created a publish-subscribe solution for enterprise information delivery and messaging to complement this role.</p>
                  <p>Networking technologies and products enable a high degree of connectivity across a large number of computers, applications, and users. In these environments, it is important to provide asynchronous communications for the class of distributed systems that operate in a loosely-coupled and autonomous fashion, and which require operational immunity from network failures. This requirement is filled by various middleware products that are characterized as messaging, message-oriented middleware (MOM), message queuing, or publish-subscribe. </p>
                  <p>Applications that communicate through a publish and subscribe paradigm require the sending applications (publishers) to publish messages without explicitly specifying recipients or having knowledge of intended recipients. Similarly, receiving applications (subscribers) must receive only those messages that the subscriber has registered an interest in. </p>
                  <p>This decoupling between senders and recipients is usually accomplished by an intervening entity between the publisher and the subscriber, which serves as a level of indirection. This intervening entity is a queue that represents a subject or channel. <a href="publish-subscribe-model.html#GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25__i1006201">Figure 23-1</a> illustrates publish and subscribe functionality.
                  </p>
                  <div class="figure" id="GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25__i1006201">
                     <p class="titleinfigure">Figure 23-1 Oracle Publish-Subscribe Functionality</p><img width="460" src="img/adfns065.gif" alt="Description of Figure 23-1 follows" title="Description of Figure 23-1 follows" longdesc="img_text/adfns065.html"><br><a href="img_text/adfns065.html">Description of "Figure 23-1 Oracle Publish-Subscribe Functionality"</a></div>
                  <!-- class="figure" -->
                  <p>A subscriber subscribes to a queue by expressing interest in messages enqueued to that queue and by using a subject- or content-based rule as a filter. This results in a set of rule-based subscriptions associated with a given queue.</p>
                  <p>At runtime, publishers post messages to various queues. The queue (in other words, the delivery mechanisms of the underlying infrastructure) then delivers messages that match the various subscriptions to the appropriate subscribers. </p>
               </div>
            </div><a id="ADFNS1602"></a><div class="props_rev_3"><a id="GUID-8DE18549-CD9E-4EA7-87B4-53FC4474570C" name="GUID-8DE18549-CD9E-4EA7-87B4-53FC4474570C"></a><h3 id="ADFNS-GUID-8DE18549-CD9E-4EA7-87B4-53FC4474570C" class="sect3">Publish-Subscribe Architecture</h3>
               <div>
                  <p>Oracle Database includes these features to support database-enabled publish-subscribe messaging:</p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p><a href="publish-subscribe-model.html#GUID-893AB488-7C25-41DA-A88A-4B8871B68921">Database Events</a></p>
                     </li>
                     <li>
                        <p><a href="publish-subscribe-model.html#GUID-743BB76B-0681-4719-A9DB-14888A15DE3C">Oracle Advanced Queuing</a></p>
                     </li>
                     <li>
                        <p><a href="publish-subscribe-model.html#GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3">Client Notification</a></p>
                     </li>
                  </ul>
               </div><a id="ADFNS827"></a><div class="props_rev_3"><a id="GUID-893AB488-7C25-41DA-A88A-4B8871B68921" name="GUID-893AB488-7C25-41DA-A88A-4B8871B68921"></a><h4 id="ADFNS-GUID-893AB488-7C25-41DA-A88A-4B8871B68921" class="sect4">Database Events</h4>
                  <div>
                     <p>Database events support declarative definitions for publishing database events, detection, and runtime publication of such events. This feature enables active publication of information to end-users in an event-driven manner, to complement the traditional pull-oriented approaches to accessing information.</p>
                     <div class="infoboxnotealso" id="GUID-893AB488-7C25-41DA-A88A-4B8871B68921__GUID-6D1B89CC-703F-4B38-9F6A-E8F25D6050B2">
                        <p class="notep1">See Also:</p>
                        <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/adfns&amp;id=LNPLS2014" target="_blank"><span class="italic">Oracle Database PL/SQL Language Reference</span></a></p>
                     </div>
                  </div>
               </div><a id="ADFNS828"></a><div class="props_rev_3"><a id="GUID-743BB76B-0681-4719-A9DB-14888A15DE3C" name="GUID-743BB76B-0681-4719-A9DB-14888A15DE3C"></a><h4 id="ADFNS-GUID-743BB76B-0681-4719-A9DB-14888A15DE3C" class="sect4">Oracle Advanced Queuing</h4>
                  <div>
                     <p>Oracle Advanced Queuing (AQ) supports a queue-based publish-subscribe paradigm. Database queues serve as a durable store for messages, along with capabilities to allow publish and subscribe based on queues. A rules-engine and subscription service dynamically route messages to recipients based on expressed interest. This allows decoupling of addressing between senders and receivers to complement the existing explicit sender-receiver message addressing.</p>
                     <div class="infoboxnotealso" id="GUID-743BB76B-0681-4719-A9DB-14888A15DE3C__GUID-9C26EC05-F529-4820-95EC-CBAE0F75E577">
                        <p class="notep1">See Also:</p>
                        <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/adfns&amp;id=ADQUE1400" target="_blank"><span class="italic">Oracle Database Advanced Queuing User's Guide</span></a></p>
                     </div>
                  </div>
               </div><a id="ADFNS829"></a><div class="props_rev_3"><a id="GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3" name="GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3"></a><h4 id="ADFNS-GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3" class="sect4">Client Notification</h4>
                  <div>
                     <p>Client notifications support asynchronous delivery of messages to interested subscribers, enabling database clients to register interest in certain queues, and it enables these clients to receive notifications when publications on such queues occur. Asynchronous delivery of messages to database clients is in contrast to the traditional polling techniques used to retrieve information. </p>
                     <div class="infoboxnotealso" id="GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3__GUID-DD1C71DE-B133-462F-8DCD-19A6E402D8DE">
                        <p class="notep1">See Also:</p>
                        <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/adfns&amp;id=LNOCI090" target="_blank"><span class="italic">Oracle Call Interface Programmer's Guide</span></a></p>
                     </div>
                  </div>
               </div>
            </div><a id="ADFNS830"></a><a id="ADFNS831"></a><a id="ADFNS832"></a><a id="ADFNS833"></a><a id="ADFNS834"></a><a id="ADFNS835"></a><a id="ADFNS836"></a><a id="ADFNS837"></a><a id="ADFNS838"></a><a id="ADFNS839"></a><a id="ADFNS840"></a><a id="ADFNS841"></a><a id="ADFNS1603"></a><div class="props_rev_3"><a id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D" name="GUID-327BA412-08EB-41E2-9059-B49355ABA51D"></a><h3 id="ADFNS-GUID-327BA412-08EB-41E2-9059-B49355ABA51D" class="sect3">Publish-Subscribe Concepts</h3>
               <div>
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-45409F10-022D-462B-82F9-C040892A0AD6">queue</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>A <span class="bold">queue</span> is an entity that supports the notion of named subjects of interest. Queues can be characterized as persistent or nonpersistent (lightweight).
                     </p>
                     <p>A <span class="bold">persistent queue</span> serves as a durable container for messages. Messages are delivered in a deferred and reliable mode.
                     </p>
                     <p>The underlying infrastructure of a <span class="bold">nonpersistent, or lightweight, queue</span> pushes the messages published to connected clients in a lightweight, at-best-once, manner.
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-750D4E98-5667-43F0-9299-E9CC6E875BB4">agent</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>Publishers and subscribers are internally represented as agents.</p>
                     <p>An <strong class="term">agent</strong> is a persistent logical subscribing entity that expresses interest in a queue through a subscription. An agent has properties, such as an associated subscription, an address, and a delivery mode for messages. In this context, an agent is an electronic proxy for a publisher or subscriber. 
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-7C8F1412-98A1-495A-A092-4A2348EBC681">client</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>A <strong class="term">client</strong> is a transient physical entity. The attributes of a client include the physical process where the client programs run, the node name, and the client application logic. Several clients can act on behalf of a single agent. The same client, if authorized, can act on behalf of multiple agents.
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-02681D78-5693-4A18-937A-CFEAF633A130">rule on a queue</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>A <span class="bold">rule on a queue</span> is specified as a conditional expression using a predefined set of operators on the message format attributes or on the message header attributes. Each queue has an associated message content format that describes the structure of the messages represented by that queue. The message format might be unstructured (<code class="codeph">RAW</code>) or it might have a well-defined structure (ADT). This allows both subject- or content-based subscriptions.
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-418CECA5-CD69-4482-99F1-2A06748DD934">subscriber</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>Subscribers (agents) can specify subscriptions on a queue using a rule. Subscribers are durable and are stored in a catalog.</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-563417A5-2CF4-4204-805C-B1956410159D">database event publication framework</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>The database represents a significant source for publishing information. An event framework is proposed to allow declarative definition of database event publication. As these predefined events occur, the framework detects and publishes such events. This allows active delivery of information to end-users in an event-driven manner as part of the publish-subscribe capability. </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-3C12653C-8A63-46C3-B558-56DCE7CA5DC6">registration</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>Registration is the process of associated delivery information by a given client, acting on behalf of an agent. There is an important distinction between the subscription and registration related to the agent/client separation. </p>
                     <p>Subscription indicates an interest in a particular queue by an agent. It does not specify where and how delivery must occur. Delivery information is a physical property that is associated with a client, and it is a transient manifestation of the logical agent (the subscriber). A specific client process acting on behalf of an agent registers delivery information by associating a host and port, indicating <span class="italic">where</span> the delivery is to be done, and a callback, indicating <span class="italic">how</span> there delivery is to be done.
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-1F0EE71A-DDD6-4008-9A81-5972360971DC">publishing a message</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>Publishers publish messages to queues by using the appropriate queuing interfaces. The interfaces might depend on which model the queue is implemented on. For example, an enqueue call represents the publishing of a message.</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-BF4BEC05-D712-4762-A225-67D763430A56">rules engine </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>When a message is posted or published to a given queue, a rules engine extracts the set of candidate rules from all rules defined on that queue that match the published message. </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-130B82B0-9747-4C61-8CD0-CB6B3CBCCED2">subscription services</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>Corresponding to the list of candidate rules on a given queue, the set of subscribers that match the candidate rules can be evaluated. In turn, the set of agents corresponding to this subscription list can be determined and notified. </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-8229BFDF-812D-49A7-B76C-092061A21825">posting</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>The queue notifies all registered clients of the appropriate published messages. This concept is called <strong class="term">posting</strong>. When the queue must notify all interested clients, it posts the message to all registered clients. 
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-6F8CB4D6-F0CF-4033-9BF0-54DDDC2F0D2C">receiving a message</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>A subscriber can receive messages through any of these mechanisms:</p>
                     <ul style="list-style-type: disc;">
                        <li>
                           <p>A client process acting on behalf of the subscriber specifies a callback using the registration mechanism. The posting mechanism then asynchronously invokes the callback when a message matches the subscriber's subscription. The message content can be passed to the callback function (nonpersistent queues only).</p>
                        </li>
                        <li>
                           <p>A client process acting on behalf of the subscriber specifies a callback using the registration mechanism. The posting mechanism then asynchronously invokes the callback function, but without the full message content. This serves as a notification to the client, which subsequently retrieves the message content in a pull fashion (persistent queues only).</p>
                        </li>
                        <li>
                           <p>A client process acting on behalf of the subscriber simply retrieves messages from the queue in a periodic or other appropriate manner. While the messages are deferred, there is no asynchronous delivery to the end-client.</p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="ADFNS1604"></a><div class="props_rev_3"><a id="GUID-3E344EF4-8AD0-442E-9E18-D0747C491E40" name="GUID-3E344EF4-8AD0-442E-9E18-D0747C491E40"></a><h3 id="ADFNS-GUID-3E344EF4-8AD0-442E-9E18-D0747C491E40" class="sect3">Examples of a Publish-Subscribe Mechanism</h3>
               <div>
                  <div class="section">
                     <p>This example shows how database events, client notification, and AQ work to implement publish-subscribe.</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <ul style="list-style-type: disc;">
                        <li>
                           <p>Create under the user schema, <code class="codeph">pubsub</code>, with all objects necessary to support a publish-subscribe mechanism. In this particular code, the Agent <code class="codeph">snoop</code> subscribe to messages that are published at logon events. To use AQ functionality, user <code class="codeph">pubsub</code> needs <code class="codeph">AQ_ADMINISTRATOR_ROLE</code> privileges and <code class="codeph">EXECUTE</code> privilege on <code class="codeph">DBMS_AQ</code> and <code class="codeph">DBMS_AQADM</code>.
                           </p>
                        </li>
                     </ul><pre class="oac_no_warn" dir="ltr">Rem ------------------------------------------------------
REM create queue table for persistent multiple consumers:
Rem ------------------------------------------------------

Rem  Create or replace a queue table
BEGIN
DBMS_AQADM.CREATE_QUEUE_TABLE(
   Queue_table        =&gt;  'Pubsub.Raw_msg_table', 
   Multiple_consumers =&gt;   TRUE,
   Queue_payload_type =&gt;  'RAW',
   Compatible         =&gt;  '8.1');
END;
/
Rem ------------------------------------------------------
Rem  Create a persistent queue for publishing messages:
Rem ------------------------------------------------------

Rem  Create a queue for logon events
BEGIN
   DBMS_AQADM.CREATE_QUEUE(
         Queue_name     =&gt;   'Pubsub.Logon',
         Queue_table    =&gt;   'Pubsub.Raw_msg_table',
         Comment        =&gt;   'Q for error triggers');
END;
/

Rem ------------------------------------------------------
Rem  Start the queue:
Rem ------------------------------------------------------

BEGIN
   DBMS_AQADM.START_QUEUE('pubsub.logon');
END;
/

Rem ------------------------------------------------------
Rem  define new_enqueue for convenience:
Rem ------------------------------------------------------

CREATE OR REPLACE PROCEDURE New_enqueue(
               Queue_name      IN VARCHAR2,
               Payload         IN RAW ,
               Correlation     IN VARCHAR2 := NULL,
               Exception_queue IN VARCHAR2 := NULL)
AS

Enq_ct     DBMS_AQ.Enqueue_options_t;
Msg_prop   DBMS_AQ.Message_properties_t;
Enq_msgid  RAW(16);
Userdata   RAW(1000);
 
BEGIN
   Msg_prop.Exception_queue := Exception_queue;
   Msg_prop.Correlation := Correlation;
   Userdata := Payload;

DBMS_AQ.ENQUEUE(Queue_name, Enq_ct, Msg_prop, Userdata, Enq_msgid);
END;
/

Rem ------------------------------------------------------
Rem  add subscriber with rule based on current user name, 
Rem  using correlation_id
Rem ------------------------------------------------------

 
DECLARE
Subscriber Sys.Aq$_agent;
BEGIN
   Subscriber := sys.aq$_agent('SNOOP', NULL, NULL);
DBMS_AQADM.ADD_SUBSCRIBER(
    Queue_name         =&gt; 'Pubsub.logon',
    Subscriber         =&gt; subscriber,
    Rule               =&gt; 'CORRID = ''HR'' ');
END;
/

<span class="italic">Rem ------------------------------------------------------</span>
<span class="italic">Rem  create a trigger on logon on database:</span>
<span class="italic">Rem ------------------------------------------------------</span>


<span class="italic">Rem  create trigger on after logon:</span>
CREATE OR REPLACE TRIGGER pubsub.Systrig2
   AFTER LOGON
   ON DATABASE
   BEGIN
      New_enqueue('Pubsub.Logon', HEXTORAW('9999'), Dbms_standard.login_user);
   END;
/
</pre><ul style="list-style-type: disc;">
                        <li>
                           <p>After subscriptions are created, the next step is for the client to register for notification using callback functions. This is done using the Oracle Call Interface (OCI). This code performs necessary steps for registration. The initial steps of allocating and initializing session handles are omitted here for sake of clarity:</p>
                        </li>
                     </ul><pre class="oac_no_warn" dir="ltr">ub4 namespace = OCI_SUBSCR_NAMESPACE_AQ;

<span class="italic">/* callback function for notification of logon of user 'HR' on database: */</span>

ub4 notifySnoop(ctx, subscrhp, pay, payl, desc, mode)
dvoid *ctx;
OCISubscription *subscrhp;
dvoid *pay;
ub4 payl;
dvoid *desc;
ub4 mode;
{
    printf("Notification : User HR Logged on\n");
}

int main()
{
    OCISession *authp = (OCISession *) 0;
    OCISubscription *subscrhpSnoop = (OCISubscription *)0;

<span class="italic">    /*****************************************************</span>
<span class="italic">       Initialize OCI Process/Environment</span>
<span class="italic">       Initialize Server Contexts</span>
<span class="italic">       Connect to Server</span>
<span class="italic">       Set Service Context</span>
<span class="italic">    ******************************************************/</span>

<span class="italic">    /* Registration Code Begins */</span>

<span class="italic">    /* Each call to initSubscriptionHn allocates </span>
<span class="italic">           and Initialises a Registration Handle */</span>

   
    initSubscriptionHn(    &amp;subscrhpSnoop,  <span class="italic">  /* subscription handle */</span>
        "ADMIN:PUBSUB.SNOOP",<span class="italic"> /* subscription name */ </span>
<span class="italic">                  /* &lt;agent_name&gt;:&lt;queue_name&gt; */</span>
        (dvoid*)notifySnoop); <span class="italic">/* callback function */</span>

<span class="italic">     /*****************************************************</span>
<span class="italic">       The Client Process does not need a live Session for Callbacks</span>
<span class="italic">       End Session and Detach from Server</span>
<span class="italic">     ******************************************************/</span>

    OCISessionEnd ( svchp,  errhp, authp, (ub4) OCI_DEFAULT);

<span class="italic">    /* detach from server */</span>
    OCIServerDetach( srvhp, errhp, OCI_DEFAULT);

    while (1)    <span class="italic"> /* wait for callback */</span>
        sleep(1);

}

void initSubscriptionHn (subscrhp,
subscriptionName,
func)

OCISubscription **subscrhp;
char* subscriptionName;
dvoid * func;
{

<span class="italic">    /* allocate subscription handle: */</span>

    (void) OCIHandleAlloc((dvoid *) envhp, (dvoid **)subscrhp, 
        (ub4) OCI_HTYPE_SUBSCRIPTION,
        (size_t) 0, (dvoid **) 0);

<span class="italic">    /* set subscription name in handle: */</span>

    (void) OCIAttrSet((dvoid *) *subscrhp, (ub4) OCI_HTYPE_SUBSCRIPTION,
        (dvoid *) subscriptionName, 
        (ub4) strlen((char *)subscriptionName),
        (ub4) OCI_ATTR_SUBSCR_NAME, errhp);

<span class="italic">    /* set callback function in handle: */</span>

    (void) OCIAttrSet((dvoid *) *subscrhp, (ub4) OCI_HTYPE_SUBSCRIPTION,
        (dvoid *) func, (ub4) 0,
        (ub4) OCI_ATTR_SUBSCR_CALLBACK, errhp);

    (void) OCIAttrSet((dvoid *) *subscrhp, (ub4) OCI_HTYPE_SUBSCRIPTION,
        (dvoid *) 0, (ub4) 0,
        (ub4) OCI_ATTR_SUBSCR_CTX, errhp);

<span class="italic">    /* set namespace in handle: */</span>

    (void) OCIAttrSet((dvoid *) *subscrhp, (ub4) OCI_HTYPE_SUBSCRIPTION,
        (dvoid *) &amp;namespace, (ub4) 0,
        (ub4) OCI_ATTR_SUBSCR_NAMESPACE, errhp);

    checkerr(errhp, OCISubscriptionRegister(svchp, subscrhp, 1, errhp,

        OCI_DEFAULT));
}
</pre><p>If user <code class="codeph">HR</code> logs on to the database, the client is notified, and the call back function <code class="codeph">notifySnoop</code> is invoked.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>