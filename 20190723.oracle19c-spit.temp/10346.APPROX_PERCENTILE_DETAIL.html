<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>APPROX_PERCENTILE_DETAIL</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="SQL Language Reference ">
      <meta property="og:description" content>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="SQL Language Reference">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="sql-language-reference.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2019-02-12T15:36:36-08:00">
      
      <meta name="dcterms.dateCopyrighted" content="1996, 2019">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E96310-02">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19">
      
      <link rel="prev" href="APPROX_PERCENTILE_AGG.html" title="Previous" type="text/html">
      <link rel="next" href="APPROX_RANK.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="SQL Language Reference">
    <meta name="dcterms.isVersionOf" content="SQLRF">
    <meta name="dcterms.release" content="Release 19">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="APPROX_PERCENTILE_AGG.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="APPROX_RANK.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">SQL Language Reference </span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="Functions.html" property="item" typeof="WebPage"><span property="name">Functions</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">APPROX_PERCENTILE_DETAIL</li>
            </ol>
            <a id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54" name="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54"></a>
            
            <h2 id="SQLRF-GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54" class="sect2">APPROX_PERCENTILE_DETAIL</h2>
         </header>
         <div class="ind">
            <div>
               <div class="section">
                  <p class="subhead1" id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__GUID-3D35715C-C9AE-43DC-9A5C-55F4D72D22D2">Syntax</p>
                  <div class="figure" id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__GUID-1AE62F79-438F-4321-A689-B210E0C7047A"><img src="img/approx_percentile_detail.gif" alt="Description of approx_percentile_detail.eps follows" title="Description of approx_percentile_detail.eps follows" longdesc="img_text/approx_percentile_detail.html"><br><a href="img_text/approx_percentile_detail.html">Description of the illustration approx_percentile_detail.eps</a></div>
                  <!-- class="figure" -->
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p class="subhead1" id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__GUID-A33AF009-F000-4729-9C80-BDF5797652E0">Purpose</p>
                  <p><code class="codeph">APPROX_PERCENTILE_DETAIL</code> calculates approximate percentile information for the values of <span class="italic"><code class="codeph">expr</code></span> and returns a <code class="codeph">BLOB</code> value, called a detail, which contains that information in a special format.
                  </p>
                  <p>The acceptable data types for <span class="italic"><code class="codeph">expr</code></span> depend on the algorithm that you specify with the <code class="codeph">DETERMINISTIC</code> clause. Refer to the <a href="APPROX_PERCENTILE_DETAIL.html#GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__DETERMINISTIC-0889AFA7">DETERMINISTIC</a> clause for more information.
                  </p>
                  <p>This function is commonly used with the <code class="codeph">GROUP</code> <code class="codeph">BY</code> clause in a <code class="codeph">SELECT</code> statement. It calculates approximate percentile information for <span class="italic"><code class="codeph">expr</code></span> within each group of rows and returns a single detail for each group.
                  </p>
                  <p>The details returned by <code class="codeph">APPROX_PERCENTILE_DETAIL</code> can be used as input to the <code class="codeph">APPROX_PERCENTILE_AGG</code> function, which enables you to perform aggregations of the details, or the <code class="codeph">TO_APPROX_PERCENTILE</code> function, which converts a detail to a specified percentile value. You can use these three functions together to perform resource-intensive approximate percentile calculations once, store the resulting details, and then perform efficient aggregations and queries on those details. For example:
                  </p>
                  <ol>
                     <li>
                        <p>Use the <code class="codeph">APPROX_PERCENTILE_DETAIL</code> function to perform approximate percentile calculations and store the resulting details in a table or materialized view. These could be highly-granular percentile details, such as income percentile information for cities.
                        </p>
                     </li>
                     <li>
                        <p>Use the <code class="codeph">APPROX_PERCENTILE_AGG</code> function to aggregate the details obtained in the previous step and store the resulting details in a table or materialized view. These could be details of lower granularity, such as income percentile information for states.
                        </p>
                     </li>
                     <li>
                        <p>Use the <code class="codeph">TO_APPROX_PERCENTILE</code> function to convert the stored detail values to percentile values. You can use the <code class="codeph">TO_APPROX_PERCENTILE</code> function to query detail values created by the <code class="codeph">APPROX_PERCENTILE_DETAIL</code> function or the <code class="codeph">APPROX_PERCENTILE_AGG</code> function.
                        </p>
                     </li>
                  </ol>
                  <p id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__DETERMINISTIC-0889AFA7"><span class="bold">DETERMINISTIC</span></p>
                  <p>This clause lets you control the type of algorithm used to calculate the approximate percentile values.</p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p>If you specify <code class="codeph">DETERMINISTIC</code>, then this function calculates deterministic approximate percentile information. In this case, <span class="italic"><code class="codeph">expr</code></span> must evaluate to a numeric value, or to a value that can be implicitly converted to a numeric value.
                        </p>
                     </li>
                     <li>
                        <p>If you omit <code class="codeph">DETERMINSTIC</code>, then this function calculates nondeterministic approximate percentile information. In this case, <span class="italic"><code class="codeph">expr</code></span> must evaluate to a numeric or datetime value, or to a value that can be implicitly converted to a numeric or datetime value.
                        </p>
                     </li>
                  </ul>
                  <div class="infoboxnotealso" id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__GUID-79CBD605-CF2A-4C1D-A183-5B0C122CC744">
                     <p class="notep1">See Also:</p>
                     <ul style="list-style-type: disc;">
                        <li>
                           <p><a href="APPROX_PERCENTILE_AGG.html#GUID-72A1DAB0-4A3E-42BF-9E20-92273AD62E11">APPROX_PERCENTILE_AGG</a></p>
                        </li>
                        <li>
                           <p><a href="TO_APPROX_PERCENTILE.html#GUID-463702B2-9199-41ED-AE03-865CABAD3E23">TO_APPROX_PERCENTILE</a></p>
                        </li>
                     </ul>
                  </div>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p class="subhead1" id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__GUID-CB7E3569-26BF-4FE1-9CF8-9B1A020E4C2C">Examples</p>
                  <p>The examples in this section demonstrate how to use the <code class="codeph">APPROX_PERCENTILE_DETAIL</code>, <code class="codeph">APPROX_PERCENTILE_AGG</code>, and <code class="codeph">TO_APPROX_PERCENTILE</code> functions together to perform resource-intensive approximate percentile calculations once, store the resulting details, and then perform efficient aggregations and queries on those details.
                  </p>
                  <p id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__APPROX_PERCENTILE_DETAILEXAMPLE-088B773B"><span class="bold">APPROX_PERCENTILE_DETAIL: Example</span></p>
                  <p>The following statement queries the tables <code class="codeph">sh</code>.<code class="codeph">customers</code> and <code class="codeph">sh</code>.<code class="codeph">sales</code> for the monetary amounts for products sold to each customer. The <code class="codeph">APPROX_PERCENTILE_DETAIL</code> function returns the information in a detail, called <code class="codeph">city_detail</code>, for each city in which customers reside. The returned details are stored in a materialized view called <code class="codeph">amt_sold_by_city_mv</code>.
                  </p><pre class="oac_no_warn" dir="ltr">CREATE MATERIALIZED VIEW amt_sold_by_city_mv
ENABLE QUERY REWRITE AS
SELECT c.country_id country,
       c.cust_state_province state,
       c.cust_city city,
       APPROX_PERCENTILE_DETAIL(s.amount_sold) city_detail
FROM customers c, sales s
WHERE c.cust_id = s.cust_id
GROUP BY c.country_id, c.cust_state_province, c.cust_city;</pre><p id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__APPROX_PERCENTILE_AGGEXAMPLES-088B7917"><span class="bold">APPROX_PERCENTILE_AGG: Examples</span></p>
                  <p>The following statement uses the <code class="codeph">APPROX_PERCENTILE_AGG</code> function to read the details stored in <code class="codeph">amt_sold_by_city_mv</code> and create aggregated details that contain the monetary amounts for products sold to customers in each state. These aggregated details are stored in a materialized view called <code class="codeph">amt_sold_by_state_mv</code>.
                  </p><pre class="oac_no_warn" dir="ltr">CREATE MATERIALIZED VIEW amt_sold_by_state_mv AS
SELECT country,
       state,
       APPROX_PERCENTILE_AGG(city_detail) state_detail
FROM amt_sold_by_city_mv
GROUP BY country, state;</pre><p>The following statement is similar to the previous statement, except it creates aggregated details that contain the approximate monetary amounts for products sold to customers in each country. These aggregated details are stored in a materialized view called <code class="codeph">amt_sold_by_country_mv</code>.
                  </p><pre class="oac_no_warn" dir="ltr">CREATE MATERIALIZED VIEW amt_sold_by_country_mv AS
  SELECT country,
         APPROX_PERCENTILE_AGG(city_detail) country_detail
  FROM amt_sold_by_city_mv
  GROUP BY country;</pre><p id="GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__TO_APPROX_PERCENTILEEXAMPLES-088B7B3B"><span class="bold">TO_APPROX_PERCENTILE: Examples</span></p>
                  <p>The following statement uses the <code class="codeph">TO_APPROX_PERCENTILE</code> function to query the details stored in <code class="codeph">amt_sold_by_city_mv</code> and return approximate 25th percentile, 50th percentile, and 75th percentile values for monetary amounts for products sold to customers in each city:
                  </p><pre class="oac_no_warn" dir="ltr">SELECT country,
       state,
       city,
       TO_APPROX_PERCENTILE(city_detail, .25, 'NUMBER') "25th Percentile",
       TO_APPROX_PERCENTILE(city_detail, .50, 'NUMBER') "50th Percentile",
       TO_APPROX_PERCENTILE(city_detail, .75, 'NUMBER') "75th Percentile"
FROM amt_sold_by_city_mv
ORDER BY country, state, city;

COUNTRY STATE        CITY           25th Percentile 50th Percentile 75th Percentile
------- ------------ -------------- --------------- --------------- ---------------
  52769 Kuala Lumpur Kuala Lumpur             19.29            38.1           53.84
  52769 Penang       Batu Ferringhi           21.51           42.09           57.26
  52769 Penang       Georgetown               19.15           33.25           56.12
  52769 Selangor     Klang                    18.08           32.06           51.29
  52769 Selangor     Petaling Jaya            19.29           35.43            60.2
. . .
</pre><p>The following statement uses the <code class="codeph">TO_APPROX_PERCENTILE</code> function to query the details stored in <code class="codeph">amt_sold_by_state_mv</code> and return approximate 25th percentile, 50th percentile, and 75th percentile values for monetary amounts for products sold to customers in each state:
                  </p><pre class="oac_no_warn" dir="ltr">SELECT country,
       state,
       TO_APPROX_PERCENTILE(state_detail, .25, 'NUMBER') "25th Percentile",
       TO_APPROX_PERCENTILE(state_detail, .50, 'NUMBER') "50th Percentile",
       TO_APPROX_PERCENTILE(state_detail, .75, 'NUMBER') "75th Percentile"
FROM amt_sold_by_state_mv
ORDER BY country, state;

COUNTRY STATE        25th Percentile 50th Percentile 75th Percentile
------- ------------ --------------- --------------- ---------------
  52769 Kuala Lumpur           19.29            38.1           53.84
  52769 Penang                 20.19           36.84           56.12
  52769 Selangor               16.97           32.41           52.69
  52770 Drenthe                16.76            31.7           53.89
  52770 Flevopolder            20.38           39.73           61.81
. . .</pre><p>The following statement uses the <code class="codeph">TO_APPROX_PERCENTILE</code> function to query the details stored in <code class="codeph">amt_sold_by_country_mv</code> and return approximate 25th percentile, 50th percentile, and 75th percentile values for monetary amounts for products sold to customers in each country:
                  </p><pre class="oac_no_warn" dir="ltr">SELECT country,
       TO_APPROX_PERCENTILE(country_detail, .25, 'NUMBER') "25th Percentile",
       TO_APPROX_PERCENTILE(country_detail, .50, 'NUMBER') "50th Percentile",
       TO_APPROX_PERCENTILE(country_detail, .75, 'NUMBER') "75th Percentile"
FROM amt_sold_by_country_mv
ORDER BY country;

  COUNTRY 25th Percentile 50th Percentile 75th Percentile
--------- --------------- --------------- ---------------
    52769            19.1           35.43           52.78
    52770           19.29           38.99           59.58
    52771           11.99           44.99          561.47
    52772           18.08           33.72           54.16
    52773           15.67           29.61           50.65
. . .</pre><p><code class="codeph">APPROX_PERCENTILE_AGG</code> takes as its input a column of details containing approximate percentile information, and enables you to perform aggregations of that information. The following statement demonstrates how approximate percentile details can interpreted by <code class="codeph">APPROX_PERCENTILE_AGG</code> to provide an input to the <code class="codeph">TO_APPROX_PERCENTILE</code> function. Like the previous example, this query returns approximate 25th percentile values for monetary amounts for products sold to customers in each country. Note that the results are identical to those returned for the 25th percentile in the previous example.
                  </p><pre class="oac_no_warn" dir="ltr">SELECT country,
       TO_APPROX_PERCENTILE(APPROX_PERCENTILE_AGG(city_detail), .25, 'NUMBER') "25th Percentile"
FROM amt_sold_by_city_mv
GROUP BY country
ORDER BY country;

  COUNTRY 25th Percentile
---------- ---------------
     52769            19.1
     52770           19.29
     52771           11.99
     52772           18.08
     52773           15.67
. . .</pre><p><span class="bold">Query Rewrite and Materialized Views Based on Approximate Queries: Example</span></p>
                  <p>In <a href="APPROX_PERCENTILE_DETAIL.html#GUID-F9A0B9B5-671F-43CA-9FA7-69A2DD174F54__APPROX_PERCENTILE_DETAILEXAMPLE-088B773B">APPROX_PERCENTILE_DETAIL: Example</a>, the <code class="codeph">ENABLE</code> <code class="codeph">QUERY</code> <code class="codeph">REWRITE</code> clause is specified when creating the materialized view <code class="codeph">amt_sold_by_city_mv</code>. This enables queries that contain approximation functions, such as <code class="codeph">APPROX_MEDIAN</code> or <code class="codeph">APPROX_PERCENTILE</code>, to be rewritten using the materialized view.
                  </p>
                  <p>For example, ensure that query rewrite is enabled at either the database level or for the current session, and run the following query:</p><pre class="oac_no_warn" dir="ltr">SELECT c.country_id country,
       APPROX_MEDIAN(s.amount_sold) amount_median
FROM customers c, sales s
WHERE c.cust_id = s.cust_id
GROUP BY c.country_id;
</pre><p>Explain the plan by querying <code class="codeph">DBMS_XPLAN</code>:
                  </p><pre class="oac_no_warn" dir="ltr">SET LINESIZE 300
SET PAGESIZE 0
COLUMN plan_table_output FORMAT A150

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY_CURSOR(format=&gt;'BASIC'));</pre><p>As shown in the following plan, the optimizer used the materialized view <code class="codeph">amt_sold_by_city_mv</code> for the query:
                  </p><pre class="oac_no_warn" dir="ltr">EXPLAINED SQL STATEMENT:
------------------------
SELECT c.country_id country, APPROX_MEDIAN(s.amount_sold)
amount_median FROM customers c, sales s WHERE c.cust_id = s.cust_id
GROUP BY c.country_id

Plan hash value: 2232676046

-------------------------------------------------------------
| Id  | Operation                     | Name                |
-------------------------------------------------------------
|   0 | SELECT STATEMENT              |                     |
|   1 |  HASH GROUP BY APPROX         |                     |
|   2 |   MAT_VIEW REWRITE ACCESS FULL| AMT_SOLD_BY_CITY_MV |
-------------------------------------------------------------</pre></div>
               <!-- class="section" -->
            </div>
         </div>
      </article>
   </body>
</html>