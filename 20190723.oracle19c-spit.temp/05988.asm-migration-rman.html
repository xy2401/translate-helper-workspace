<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="abstract" content="Recovery Manager (RMAN) provides tools to migrate data to and from Oracle ASM.">
      <meta name="description" content="Recovery Manager (RMAN) provides tools to migrate data to and from Oracle ASM.">
      <title>Performing Oracle ASM Data Migration with RMAN</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="Administrator's Guide">
      <meta property="og:description" content="Recovery Manager (RMAN) provides tools to migrate data to and from Oracle ASM.">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="Administrator's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="automatic-storage-management-administrators-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2019-04-23T18:56:15-07:00">
      
      <meta name="dcterms.dateCopyrighted" content="2007, 2019">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E96198-03">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19">
      
      <link rel="prev" href="admin-asm-em.html" title="Previous" type="text/html">
      <link rel="next" href="manage-asm-asmca.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Automatic Storage Management Administrator's Guide">
    <meta name="dcterms.isVersionOf" content="OSTMG">
    <meta name="dcterms.release" content="Release 19">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="admin-asm-em.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="manage-asm-asmca.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">Administrator's Guide</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="part-instance-diskgroup.html" property="item" typeof="WebPage"><span property="name">Oracle ASM Instances and Disk Groups</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem"> Performing Oracle ASM Data Migration with RMAN</li>
            </ol>
            <a id="GUID-EE232095-823A-4717-8629-75E6A750FCDB" name="GUID-EE232095-823A-4717-8629-75E6A750FCDB"></a><a id="OSTMG12000"></a>
            
            <h2 id="OSTMG-GUID-EE232095-823A-4717-8629-75E6A750FCDB" class="sect2"><span class="enumeration_chapter">8 </span> Performing Oracle ASM Data Migration with RMAN
            </h2>
         </header>
         <div class="ind">
            <div>
               <p>Recovery Manager (RMAN) provides tools to migrate data to and from Oracle ASM.</p>
               <p>This chapter describes how to migrate data into and out of Oracle Automatic Storage Management (Oracle ASM) storage with Recovery Manager (RMAN). </p>
               <p> This chapter includes the following topics:</p>
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-B43E349F-9065-4422-8558-E22A0CE579C5">Overview of Oracle ASM Data Migration</a></p>
                  </li>
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">Preparing to Migrate the Database to Oracle ASM Using RMAN</a></p>
                  </li>
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">Migrating the Database to Oracle ASM Using RMAN</a></p>
                  </li>
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63">Migrating a Database from Oracle ASM to Alternative Storage</a></p>
                  </li>
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-3B8D0956-0888-452D-A9E4-9FB8D98577E0">Moving Data Files Between Oracle ASM Disk Groups Using RMAN</a></p>
                  </li>
               </ul>
               <p>The procedures in this chapter cover an Oracle ASM standalone environment on a Linux platform. File locations and procedures may be different for different Oracle configurations and on other operating system platforms.</p>
               <div class="infoboxnotealso" id="GUID-EE232095-823A-4717-8629-75E6A750FCDB__GUID-48C0CF37-8CCA-4A27-B715-76C99FE03C7E">
                  <p class="notep1">See Also:</p>
                  <p></p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p><a href="../bradv/introduction-backup-recovery.html#BRADV8001" target="_blank"><span class="italic">Oracle Database Backup and Recovery User's Guide</span></a> for complete information about using RMAN
                        </p>
                     </li>
                     <li>
                        <p>Operating system-specific documentation for migrating data in and out of Oracle ASM on specific platforms</p>
                     </li>
                     <li>
                        <p><a href="../cwadd/managing-oracle-cluster-registry-and-voting-files.html#CWADD92368" target="_blank"><span class="italic">Oracle Clusterware Administration and Deployment Guide</span></a> for information about managing and migrating Oracle Cluster Registry and voting files
                        </p>
                     </li>
                     <li>
                        <p><a href="../racad/managing-backup-and-recovery.html#RACAD059" target="_blank"><span class="italic">Oracle Real Applications Cluster Administration and Deployment Guide</span></a> for migrating data in and out of Oracle ASM in an Oracle RAC configuration
                        </p>
                     </li>
                     <li>
                        <p>Articles at <a href="https://support.oracle.com" target="_blank">My Oracle Support</a> (<a href="https://support.oracle.com" target="_blank"><code class="codeph">https://support.oracle.com</code></a>) for information about gathering and backing up Oracle ASM and Oracle ACFS metadata in a formatted manner, such as HTML format
                        </p>
                     </li>
                  </ul>
               </div>
            </div><a id="OSTMG89991"></a><div class="props_rev_3"><a id="GUID-B43E349F-9065-4422-8558-E22A0CE579C5" name="GUID-B43E349F-9065-4422-8558-E22A0CE579C5"></a><h3 id="OSTMG-GUID-B43E349F-9065-4422-8558-E22A0CE579C5" class="sect3">Overview of Oracle ASM Data Migration</h3>
               <div>
                  <p><a id="d60040e351" class="indexterm-anchor"></a>This section explains the basic concepts and tasks involved in migrating data to and from Oracle ASM.
                  </p>
                  <p> This section includes the following topics:</p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p><a href="asm-migration-rman.html#GUID-096830E5-3F25-47A7-A8E4-4728AC164F9E">Purpose of Oracle ASM Data Migration</a></p>
                     </li>
                     <li>
                        <p><a href="asm-migration-rman.html#GUID-93E85B47-D624-4814-B476-D7C7098A3A59">Basic Concepts of Oracle ASM Data Migration</a></p>
                     </li>
                     <li>
                        <p><a href="asm-migration-rman.html#GUID-55735241-F963-4FF5-BAD3-1D6ECF07D4FB">Basic Steps of Data Migration to Oracle ASM Using RMAN</a></p>
                     </li>
                  </ul>
               </div><a id="OSTMG89992"></a><div class="props_rev_3"><a id="GUID-096830E5-3F25-47A7-A8E4-4728AC164F9E" name="GUID-096830E5-3F25-47A7-A8E4-4728AC164F9E"></a><h4 id="OSTMG-GUID-096830E5-3F25-47A7-A8E4-4728AC164F9E" class="sect4">Purpose of Oracle ASM Data Migration</h4>
                  <div>
                     <p>Alternatives to Oracle ASM storage include file systems, raw disks, and SAN configurations. Oracle ASM includes numerous benefits over these storage alternatives, including performance optimization, redundancy protection, and load balancing. You do not need a third-party Logical Volume Manager because Oracle ASM manages disks for you. Oracle Real Application Clusters (Oracle RAC) databases benefit from Oracle ASM because it provides ready-made shared storage.</p>
                     <p>If a database currently uses a storage system other than Oracle ASM, then you can migrate all or part of the database into Oracle ASM, thereby simplifying database administration. You can also migrate a fast recovery area to Oracle ASM.</p>
                     <p>Native operating system commands such as Linux <code class="codeph">cp</code> or Windows <code class="codeph">COPY</code> cannot write or read files in Oracle ASM storage. Because RMAN can read and write Oracle ASM files, you can use RMAN to copy data files into and out of Oracle ASM storage or between Oracle ASM disk groups. This technique is useful if you must store backups on user-managed disks.
                     </p>
                  </div>
               </div><a id="OSTMG89993"></a><div class="props_rev_3"><a id="GUID-93E85B47-D624-4814-B476-D7C7098A3A59" name="GUID-93E85B47-D624-4814-B476-D7C7098A3A59"></a><h4 id="OSTMG-GUID-93E85B47-D624-4814-B476-D7C7098A3A59" class="sect4">Basic Concepts of Oracle ASM Data Migration</h4>
                  <div>
                     <p>You can migrate data to Oracle ASM with RMAN even if you are not using RMAN as your primary backup tool. The migration requires one RMAN database backup.</p>
                     <p>If you have sufficient disk space to hold the entire database both in Oracle ASM and alternative storage systems, then you can move a database directly into Oracle ASM. If you do not have sufficient storage, then you can back the database up to tape, create an Oracle ASM disk group that uses old disk space, and restore the database from tape to Oracle ASM.</p>
                     <p>After you set the location of the new recovery area, existing backups remain in the old recovery area and count against the total disk quota of the recovery area. The backups are deleted from the old recovery area when space is needed. These backups are usable by RMAN. It is not necessary to move legacy backups to the new Oracle ASM recovery area unless you need disk space. To free space consumed by files in the old recovery area, you can back them up to tape or migrate them to the Oracle ASM recovery area.</p>
                     <div class="infoboxnote" id="GUID-93E85B47-D624-4814-B476-D7C7098A3A59__GUID-2E7760E9-FC43-41FF-ADA7-4347061C429D">
                        <p class="notep1">Note:</p>
                        <p>A foreign archived redo log is a log received by a logical standby database for a LogMiner session. Foreign archived redo logs cannot be migrated. Unlike normal archived logs, foreign archived logs have a different internal database identifier (DBID). For this reason, they cannot be backed up or restored on a logical standby database.</p>
                     </div>
                     <p>Migrating a database from Oracle ASM to an alternative storage system is similar to migration from an alternative storage system to Oracle ASM. The primary change is to modify each step to refer to file locations in the alternative storage system.</p>
                  </div>
               </div><a id="OSTMG89994"></a><div class="props_rev_3"><a id="GUID-55735241-F963-4FF5-BAD3-1D6ECF07D4FB" name="GUID-55735241-F963-4FF5-BAD3-1D6ECF07D4FB"></a><h4 id="OSTMG-GUID-55735241-F963-4FF5-BAD3-1D6ECF07D4FB" class="sect4">Basic Steps of Data Migration to Oracle ASM Using RMAN</h4>
                  <div>
                     <p>This section discusses the process of migrating the entire database and fast recovery area from alternative storage to Oracle ASM using RMAN.</p>
                     <p>The fast recovery area is an optional disk location that you can use to store recovery-related files such as control file and online redo log copies, archived redo log files, flashback logs, and RMAN backups. Oracle Database and RMAN manage the files in the fast recovery area automatically. You can specify the disk quota, which is the user-specified maximum size of the fast recovery area. When the disk quota is reached, Oracle automatically deletes files that are no longer needed.</p>
                     <p>Flashback logs are Oracle-generated logs used to perform flashback database operations. The database can only write flashback logs to the fast recovery area. Flashback logs are written sequentially and are not archived. They cannot be backed up to disk.</p>
                     <p>To migrate the entire database and fast recovery area from alternative storage to Oracle ASM, perform the following steps:</p>
                     <ol>
                        <li>
                           <p>Back up the database and server parameter file, and disable Oracle Flashback Database.</p>
                           <p>The Oracle Flashback Database option returns the entire database to a prior consistent System Change Number (SCN) with the <code class="codeph">FLASHBACK</code> <code class="codeph">DATABASE</code> command in RMAN or SQL. A database flashback is different from traditional media recovery because it does not involve the restore of physical files, instead restoring your current data files to past states using saved images of changed data blocks. This feature uses flashback logs and archived redo logs.
                           </p>
                           <p>This step is described in <a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">Preparing to Migrate the Database to Oracle ASM Using RMAN</a>.
                           </p>
                        </li>
                        <li>
                           <p>Restore files to Oracle ASM, recover the database, and optionally migrate the fast recovery area to Oracle ASM.</p>
                           <p>This step is described in <a href="asm-migration-rman.html#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">Migrating the Database to Oracle ASM Using RMAN</a>.
                           </p>
                        </li>
                     </ol>
                     <p>To migrate files from Oracle ASM to alternative storage, see <a href="asm-migration-rman.html#GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63">Migrating a Database from Oracle ASM to Alternative Storage</a>.
                     </p>
                  </div>
               </div>
            </div><a id="OSTMG89995"></a><div class="props_rev_3"><a id="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D" name="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D"></a><h3 id="OSTMG-GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D" class="sect3">Preparing to Migrate the Database to Oracle ASM Using RMAN</h3>
               <div>
                  <p>This section explains how to prepare the database for migration. This section makes the following assumptions:</p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p>You want to migrate the database to two Oracle ASM disk groups: <code class="codeph">+DATA</code> for the database and <code class="codeph">+FRA</code> for the fast recovery area.
                        </p>
                     </li>
                     <li>
                        <p>The database to be migrated to Oracle ASM storage is named <code class="codeph">mydb</code>.
                        </p>
                     </li>
                  </ul>
                  <p>To prepare the database for Oracle ASM migration:</p>
                  <ol>
                     <li>
                        <p>If the <code class="codeph">COMPATIBLE</code> initialization parameter setting for the database is less than <code class="codeph">11.0.0</code>, then make any read-only transportable tablespaces read/write. 
                        </p>
                        <p>Read-only transportable tablespaces cannot be migrated because RMAN cannot back them up.</p>
                     </li>
                     <li>
                        <p>If the database is a physical standby database, and if managed recovery is started, then stop managed recovery. </p>
                        <p>A physical standby database is a copy of a production database that you can use for disaster protection.</p>
                        <p>For example, connect SQL*Plus to the database with <code class="codeph">SYSBACKUP</code> privileges (rather than <code class="codeph">SYSDBA</code> privileges) to enforce the separation of duty security model, and run the following statement to stop managed recovery:
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
</pre><p>Keep this terminal window open.</p>
                     </li>
                     <li>
                        <p>Copy the server parameter file or initialization parameter file to a temporary location.</p>
                        <p>The following example uses an operating system utility to copy the server parameter file:</p><pre class="oac_no_warn" dir="ltr">$ cp spfileMYDB.ora orig_spfileMYDB.ora
</pre></li>
                     <li>
                        <p>In a new terminal window, start RMAN session and connect as <code class="codeph">TARGET</code> to the database to be migrated. Optionally, connect to a recovery catalog. Connect with <code class="codeph">SYSBACKUP</code> privileges to enforce the separation of duty security model.
                        </p>
                     </li>
                     <li id="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D__BAJHEEDG">
                        <p>Back up the data files to the Oracle ASM disk group.</p>
                        <p>The following example uses a <code class="codeph">RUN</code> command to make a level 0 incremental backup and allocates four channels to increase the backup speed. A level 0 incremental backup is an RMAN incremental backup that backs up all data blocks in the data files being backed up. An incremental backup at level 0 is identical in content to a full backup, but unlike a full backup the level 0 backup is considered a part of the incremental backup strategy. 
                        </p>
                        <p>An incremental backup is a RMAN backup in which only modified blocks are backed up. Incremental backups are classified by <strong class="term">level</strong>. A level 0 incremental backup performs the same function as a full backup in that they both back up all blocks that have ever been used. The difference is that a full backup does not affect blocks backed up by subsequent incremental backups, whereas an incremental backup affects blocks backed up by subsequent incremental backups.
                        </p>
                        <p>A full backup is a non-incremental RMAN backup. Full does not refer to how much of the database is backed up, but to the fact that the backup is not incremental. Consequently, you can make a full backup of one data file.</p>
                        <p>Increase or decrease this number accordingly. The format clause specifies <code class="codeph">+DATA</code>, which is the name of the Oracle ASM disk group to be used for storing the database.
                        </p><pre class="oac_no_warn" dir="ltr">RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;
  BACKUP AS COPY
    INCREMENTAL LEVEL 0
    DATABASE
    FORMAT '+DATA'
    TAG 'ORA_ASM_MIGRATION';
}
</pre></li>
                     <li>
                        <p>If block change tracking is enabled for the database, then optionally make a level 1 incremental backup that you can use later to recover the database copy.</p>
                        <p>Block change tracking is a database option that causes Oracle to track data file blocks affected by each database update. The tracking information is stored in a block change tracking file. When block change tracking is enabled, RMAN uses the record of changed blocks from the change tracking file to improve incremental backup performance by only reading those blocks known to have changed, instead of reading data files in their entirety.</p>
                        <p>The following example makes an incremental level 1 copy of the level 0 backup created in the previous step:</p><pre class="oac_no_warn" dir="ltr">RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;
  BACKUP INCREMENTAL LEVEL 1 
    FOR RECOVER OF COPY WITH TAG 'ORA_ASM_MIGRATION' 
    DATABASE;
}
</pre></li>
                     <li>
                        <p>If the database is in <code class="codeph">ARCHIVELOG</code> mode, and if the database is open, then archive the online logs.
                        </p>
                        <p>The following example uses the <code class="codeph">SQL</code> command to archive the current redo logs:
                        </p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL "ALTER SYSTEM ARCHIVE LOG CURRENT";
</pre></li>
                     <li>
                        <p>If the database instance is currently using a server parameter file, then back it up.</p>
                        <p>The following example backs up the server parameter file:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; BACKUP AS BACKUPSET SPFILE;
</pre></li>
                     <li>
                        <p>If block change tracking is enabled, then disable it.</p>
                        <p>The following command disables block change tracking:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL "ALTER DATABASE DISABLE BLOCK CHANGE TRACKING";
</pre></li>
                     <li>
                        <p>If Flashback Database is enabled, then disable it and drop any guaranteed restore points.</p>
                        <div class="infoboxnote" id="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D__GUID-A7E02510-D67B-4FA9-B8B4-537CADDB6F39">
                           <p class="notep1">Note:</p>
                           <p>If you are not migrating the fast recovery area, then skip this step.</p>
                        </div>
                        <p>Disabling Oracle Flashback Database is necessary because you cannot migrate flashback logs to Oracle ASM. The following command disables Flashback Database:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL "ALTER DATABASE FLASHBACK OFF";
</pre><p>The following command drops the guaranteed restore point named <code class="codeph">Q106</code>:
                        </p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL "DROP RESTORE POINT Q106";
</pre></li>
                     <li>
                        <p>Shut down the database consistently.</p>
                        <p>The following command shuts down the database:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SHUTDOWN IMMEDIATE;</pre></li>
                  </ol>
               </div>
            </div><a id="OSTMG94244"></a><a id="OSTMG12121"></a><div class="props_rev_3"><a id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1" name="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1"></a><h3 id="OSTMG-GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1" class="sect3">Migrating the Database to Oracle ASM Using RMAN</h3>
               <div>
                  <p>The following procedure is intended to minimize database downtime. The steps differ slightly depending on whether you are migrating a primary or standby database. The procedure makes the same assumptions described in <a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">Preparing to Migrate the Database to Oracle ASM Using RMAN</a>. If you are not migrating the recovery area to Oracle ASM, then you must modify some steps, which are noted.
                  </p>
                  <div class="infoboxnote" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-F6A61E3E-6516-41E5-8AC7-41A90415B200">
                     <p class="notep1">Note:</p>
                     <p>The following procedure switches between SQL*Plus and RMAN, so keep a terminal window open for each utility.</p>
                  </div>
                  <p>To migrate the database to Oracle ASM:</p>
                  <ol>
                     <li>
                        <p>Follow the steps in <a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">Preparing to Migrate the Database to Oracle ASM Using RMAN</a>.
                        </p>
                     </li>
                     <li>
                        <p>Restore or create a server parameter file in Oracle ASM storage.</p>
                        <p>The steps depend on whether the database is using a server parameter file: </p>
                        <ul style="list-style-type: disc;">
                           <li>
                              <p>If the database is using a server parameter file, then restore it to the Oracle ASM disk group with the following commands, where <span class="italic"><code class="codeph">sid</code></span> is the SID of the instance:
                              </p><pre class="oac_no_warn" dir="ltr">RMAN&gt; STARTUP MOUNT;
RMAN&gt; RESTORE SPFILE TO '+DATA/spfile<span class="italic">sid</span>.ora';
RMAN&gt; SHUTDOWN IMMEDIATE;
</pre></li>
                           <li>
                              <p>If the database is not using a server parameter file, then create one in Oracle ASM. Run the <code class="codeph">CREATE SPFILE</code> command in SQL*Plus as follows, where <span class="italic"><code class="codeph">sid</code></span> is the SID of the database:
                              </p><pre class="oac_no_warn" dir="ltr">SQL&gt; CREATE SPFILE='+DATA/spfile<span class="italic">sid</span>.ora' FROM PFILE='?/dbs/init<span class="italic">sid</span>.ora';
</pre></li>
                        </ul>
                     </li>
                     <li id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__BAJCGAFE">
                        <p>Set Oracle Managed Files initialization parameters to Oracle ASM locations.</p>
                        <div class="infoboxnote" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-65F747BA-B195-4A7D-97A0-3C1E2BA2BA32">
                           <p class="notep1">Note:</p>
                           <p>If you are not migrating the fast recovery area, then do not change the <code class="codeph">DB_RECOVERY_FILE_DEST</code> and <code class="codeph">DB_RECOVERY_FILE_DEST_SIZE</code> initialization parameter settings. However, you must set <code class="codeph">DB_CREATE_ONLINE_LOG_DEST_</code><span class="italic"><code class="codeph">n</code></span> parameter to an Oracle ASM location for migration of the online redo logs.
                           </p>
                        </div>
                        <p>Set the <code class="codeph">DB_CREATE_FILE_DEST</code> and optional <code class="codeph">DB_CREATE_ONLINE_LOG_DEST_</code><span class="italic"><code class="codeph">n</code></span> initialization parameters to Oracle ASM disk groups. If the database uses a recovery area, then change the recovery area location to the Oracle ASM disk group. Also, change the recovery area size. 
                        </p>
                        <p>Run commands in SQL*Plus as shown in the following example. The example assumes that the size of the fast recovery area is 100 GB and specifies the disk group <code class="codeph">+FRA</code> for the fast recovery area.
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET DB_CREATE_FILE_DEST='+DATA' SID='*';
SQL&gt; ALTER SYSTEM SET DB_RECOVERY_FILE_DEST_SIZE=100G SID='*';
SQL&gt; ALTER SYSTEM SET DB_RECOVERY_FILE_DEST='+FRA' SID='*';
</pre></li>
                     <li>
                        <p>Set the <code class="codeph">CONTROL_FILES</code> initialization parameter to Oracle ASM locations.
                        </p>
                        <p>If you are migrating the fast recovery area, then enter the following commands in SQL*Plus to restart the database instance and set the control file locations to disk groups <code class="codeph">+DATA</code> and <code class="codeph">+FRA</code>: 
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET CONTROL_FILES='+DATA','+FRA' SCOPE=SPFILE SID='*';
</pre><p>If you are not migrating the fast recovery area, then enter the following commands in SQL*Plus to restart the database instance and set the control file locations to disk group <code class="codeph">+DATA</code>:
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET CONTROL_FILES='+DATA','+DATA' SCOPE=SPFILE SID='*';
</pre></li>
                     <li>
                        <p>Migrate the control file to Oracle ASM and mount the control file.</p>
                        <p>Switch to the RMAN terminal to restore the control file. In the following example, <span class="italic"><code class="codeph">original_cf_name</code></span> is a control file name in the initialization parameter file before migration:
                        </p><pre class="oac_no_warn" dir="ltr">RMAN&gt; STARTUP FORCE NOMOUNT;
RMAN&gt; RESTORE CONTROLFILE FROM '<span class="italic">original_cf_name</span>';
RMAN&gt; ALTER DATABASE MOUNT;
</pre></li>
                     <li>
                        <p>Migrate the data files to Oracle ASM.</p>
                        <p>Use RMAN to switch to the database copy that you created in step "Back up the data files to the Oracle ASM disk group" in <a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">Preparing to Migrate the Database to Oracle ASM Using RMAN</a>. The switch renames all the data files to files on Oracle ASM disk groups. Afterward, recover the database. If incremental backups were taken, then RMAN applies them during recovery. For example, enter the following commands at the RMAN prompt:
                        </p><pre class="oac_no_warn" dir="ltr">SWITCH DATABASE TO COPY;
RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;
  RECOVER DATABASE;
}
</pre></li>
                     <li>
                        <p>If the database uses block change tracking or Flashback Database, then enable these features.</p>
                        <div class="infoboxnote" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-1925625F-780B-442E-B533-8FA5234F2A2F">
                           <p class="notep1">Note:</p>
                           <p>If you are not migrating the recovery area, then you do not enable Flashback Database unless you had disabled it previously.</p>
                        </div>
                        <p>For example, enter the following statements in SQL*Plus:</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE ENABLE BLOCK CHANGE TRACKING USING FILE '+DATA';
SQL&gt; ALTER DATABASE FLASHBACK ON;
</pre></li>
                     <li>
                        <p>Place the database in its normal operation mode.</p>
                        <p>The normal operational mode depends on whether the database is a primary or standby database:</p>
                        <ul style="list-style-type: disc;">
                           <li>
                              <p>If the database is a primary database, then open it as follows:</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN;
</pre></li>
                           <li>
                              <p>If the database is a standby database, then resume managed recovery mode as follows:</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE;
</pre></li>
                        </ul>
                     </li>
                     <li>
                        <p>Drop the tempfiles and re-create them in Oracle ASM.</p>
                        <p>Use SQL*Plus to re-create the tempfiles. In the following example, the name of the tempfile in the original storage is <span class="italic"><code class="codeph">tempfile_name</code></span>. The name of the temporary tablespace is <span class="italic"><code class="codeph">temp_tbs_name</code></span>.
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE TEMPFILE '<span class="italic">tempfile_name</span>' DROP;
SQL&gt; ALTER TABLESPACE <span class="italic">temp_tbs_name</span> ADD TEMPFILE;
</pre></li>
                     <li>
                        <p>Migrate the online redo log files.</p>
                        <p>If this is a primary database, then add new log group members in Oracle ASM and drop the old members. You can use the following PL/SQL script to migrate the online redo log groups into an Oracle ASM disk group. The PL/SQL script assumes that the Oracle Managed Files initialization parameters specified in step "Set Oracle Managed Files initialization parameters to Oracle ASM locations" in <a href="asm-migration-rman.html#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">Migrating the Database to Oracle ASM Using RMAN</a> are set.
                        </p>
                     </li>
                     <li>
                        <p>Optionally, migrate backups and copies in the old fast recovery area to Oracle ASM as follows:</p>
                        <ol type="a">
                           <li>
                              <p>If foreign archived logs exists in the recovery area, then you cannot migrate them to Oracle ASM. Run the following command at the RMAN prompt:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; DELETE ARCHIVELOG ALL;
</pre></li>
                           <li>
                              <p>Back up archived redo log files, backup sets, and data file copies to Oracle ASM. For example, run the following command at the RMAN prompt:</p><pre class="oac_no_warn" dir="ltr">RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;

  BACKUP AS COPY ARCHIVELOG ALL DELETE INPUT;
  BACKUP BACKUPSET ALL DELETE INPUT;
  BACKUP AS COPY DATAFILECOPY ALL DELETE INPUT;
}</pre></li>
                        </ol>
                     </li>
                  </ol>
                  <div class="example" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-24DD750B-790F-4360-A6BF-0C5D04AD7D8A">
                     <p class="titleinexample">Example 8-1 Migrating the online redo logs</p><pre class="oac_no_warn" dir="ltr">SET SERVEROUTPUT ON;
DECLARE
   CURSOR rlc IS
      SELECT GROUP# GRP, THREAD# THR, BYTES, 'NO' SRL
      FROM   V$LOG
      UNION
      SELECT GROUP# GRP, THREAD# THR, BYTES, 'YES' SRL
      FROM   V$STANDBY_LOG
      ORDER BY 1;
   stmt     VARCHAR2(2048);
BEGIN
   FOR rlcRec IN rlc LOOP
      IF (rlcRec.srl = 'YES') THEN
         stmt := 'ALTER DATABASE ADD STANDBY LOGFILE THREAD ' ||
                 rlcRec.thr || ' SIZE ' || rlcRec.bytes;
         EXECUTE IMMEDIATE stmt;
         stmt := 'ALTER DATABASE DROP STANDBY LOGFILE GROUP ' || rlcRec.grp;
         EXECUTE IMMEDIATE stmt;
      ELSE
         stmt := 'ALTER DATABASE ADD LOGFILE THREAD ' ||
                 rlcRec.thr || ' SIZE ' ||  rlcRec.bytes;
         EXECUTE IMMEDIATE stmt;
         BEGIN
            stmt := 'ALTER DATABASE DROP LOGFILE GROUP ' || rlcRec.grp;
            DBMS_OUTPUT.PUT_LINE(stmt);
            EXECUTE IMMEDIATE stmt;
         EXCEPTION
            WHEN OTHERS THEN
               EXECUTE IMMEDIATE 'ALTER SYSTEM SWITCH LOGFILE';
               EXECUTE IMMEDIATE 'ALTER SYSTEM CHECKPOINT GLOBAL';
               EXECUTE IMMEDIATE stmt;
         END;
      END IF;
   END LOOP;
END;
/
</pre></div>
                  <!-- class="example" -->
               </div>
            </div><a id="OSTMG89996"></a><div class="props_rev_3"><a id="GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63" name="GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63"></a><h3 id="OSTMG-GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63" class="sect3">Migrating a Database from Oracle ASM to Alternative Storage</h3>
               <div>
                  <p>Migrating a database from Oracle ASM to an alternative storage system is essentially the reverse of the migration to Oracle ASM. Modify the steps in <a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">Preparing to Migrate the Database to Oracle ASM Using RMAN</a> and <a href="asm-migration-rman.html#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">Migrating the Database to Oracle ASM Using RMAN</a> as follows:
                  </p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p>If the procedure specifies Oracle Managed Files locations, then alter the procedure to use locations in alternative storage.</p>
                     </li>
                     <li>
                        <p>If the <code class="codeph">FORMAT</code> clause of the <code class="codeph">BACKUP</code> command specifies an Oracle ASM location, then change the backup format to an alternative storage location.
                        </p>
                     </li>
                     <li>
                        <p>If a file name used in a SQL statement is an Oracle ASM location, then change it to a file name in the alternative storage location.</p>
                     </li>
                  </ul>
               </div>
            </div><a id="OSTMG89997"></a><div class="props_rev_3"><a id="GUID-3B8D0956-0888-452D-A9E4-9FB8D98577E0" name="GUID-3B8D0956-0888-452D-A9E4-9FB8D98577E0"></a><h3 id="OSTMG-GUID-3B8D0956-0888-452D-A9E4-9FB8D98577E0" class="sect3">Moving Data Files Between Oracle ASM Disk Groups Using RMAN</h3>
               <div>
                  <p>You may want to move an active data file in an <code class="codeph">ARCHIVELOG</code> mode database from one Oracle ASM disk group to another. You can use RMAN <code class="codeph">BACKUP</code> <code class="codeph">AS</code> <code class="codeph">COPY</code> to copy the data file to the new disk group and <code class="codeph">SET</code> <code class="codeph">NEWNAME</code> and <code class="codeph">SWITCH</code> commands to rename the data file in the control file.
                  </p>
                  <p>You can also use the <code class="codeph">ALTER</code> <code class="codeph">DATABASE</code> <code class="codeph">MOVE</code> <code class="codeph">DATAFILE</code>. SQL statement to move data files. For information about moving data files online with <code class="codeph">ALTER</code> <code class="codeph">DATABASE</code> <code class="codeph">MOVE</code> <code class="codeph">DATAFILE</code>, refer to <a href="asm-files-directories-templates.html#GUID-CF6CB742-9DCD-4211-8A45-3C0B48AB6FBE" title="You can use the ALTER DATABASE MOVE DATAFILE SQL statement to move data files between disk groups while the database is open and users are accessing the data files.">Moving Data Files Between Disk Groups With ALTER DATABASE</a>.
                  </p>
                  <p>For this scenario using RMAN, assume that you are using disk groups <code class="codeph">DATA</code> and <code class="codeph">USERDATA</code> and you want to move the data file <code class="codeph">users.261.689589837</code> to disk group <code class="codeph">USERDATA</code>. Ensure that <code class="codeph">ARCHIVELOG</code> mode is enabled for the database before beginning the procedure to move data files.
                  </p>
                  <p>To move a data file from one Oracle ASM disk group to another disk group using the RMAN <code class="codeph">BACKUP</code> <code class="codeph">AS</code> <code class="codeph">COPY</code> procedure with the <code class="codeph">SET</code> <code class="codeph">NEWNAME</code> and <code class="codeph">SWITCH</code> commands, perform the following steps.
                  </p>
                  <ol>
                     <li>
                        <p>Start RMAN and connect to the target database.</p>
                        <p>For example:</p><pre class="oac_no_warn" dir="ltr">$ rman
RMAN&gt; CONNECT TARGET SYS@orcl
target database Password: <span class="italic">XXXXXXXXX</span>
connected to target database: ORCL (DBID=1217369048)
</pre></li>
                     <li>
                        <p>Generate a report that shows the names of the data files.</p>
                        <p>Run the following <code class="codeph">REPORT</code> command after connecting RMAN to the target database. Note the data file name of the file to be moved.
                        </p>
                        <p>For example:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; REPORT SCHEMA;

Report of database schema for database with db_unique_name ORCL
 
List of Permanent Datafiles
===========================
File Size(MB) Tablespace           RB segs Datafile Name
---- -------- -------------- ------- ------------------------
1    740      SYSTEM         ***     +DATA/orcl/datafile/system.258.689589737
2    570      SYSAUX         ***     +DATA/orcl/datafile/sysaux.259.689589785
3    55       UNDOTBS1       ***     +DATA/orcl/datafile/undotbs1.260.689589831
4    5        USERS          ***     +DATA/orcl/datafile/users.261.689589837

List of Temporary Files
=======================
File Size(MB) Tablespace           Maxsize(MB) Tempfile Name
---- -------- -------------- ----------- --------------------
1    20       TEMP           32767       +DATA/orcl/tempfile/temp.262.689589851
</pre></li>
                     <li>
                        <p>Back up the data file to the new Oracle ASM disk group. </p>
                        <p>Run the <code class="codeph">BACKUP</code> <code class="codeph">AS</code> <code class="codeph">COPY</code> command to back up the data file on <code class="codeph">DATA</code> to <code class="codeph">USERDATA</code>. 
                        </p>
                        <p>For example:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; BACKUP AS COPY
        DATAFILE "+DATA/orcl/datafile/users.261.689589837"
        FORMAT   "+USERDATA";

Starting backup at 16-JUN-09
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=51 device type=DISK
channel ORA_DISK_1: starting datafile copy
input datafile file number=00004 name=+DATA/orcl/datafile/users.261.689589837
output file name=+USERDATA/orcl/datafile/users.256.689682663
  tag=TAG20090616T103101 RECID=13 STAMP=689682663
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:01
Finished backup at 16-JUN-09
</pre><p>You could also specify the data file by the data file number and data file type.</p>
                        <p>For example:</p><pre class="oac_no_warn" dir="ltr">BACKUP AS COPY
  DATAFILE 4
  FORMAT   "+USERDATA";
</pre></li>
                     <li>
                        <p>Offline the data file that you intend to move to a new disk group.</p>
                        <p>Run the following <code class="codeph">SQL</code> command in the RMAN client. Use two single quotation marks around the name of the data file, not double quotation marks.
                        </p>
                        <p>For example:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL "ALTER DATABASE DATAFILE 
       ''+DATA/orcl/datafile/users.261.689589837'' OFFLINE";

sql statement: ALTER DATABASE DATAFILE
     ''+DATA/orcl/datafile/users.261.689589837''  OFFLINE
</pre></li>
                     <li>
                        <p>Point the control file to the newly created copy of the data file. </p>
                        <p>Run the <code class="codeph">SWITCH...TO COPY</code> command in the RMAN client. The <code class="codeph">TO</code> <code class="codeph">COPY</code> option of <code class="codeph">SWITCH</code> switches the data file to the most recent copy of the data file. 
                        </p>
                        <p>For example:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SWITCH DATAFILE "+DATA/orcl/datafile/users.261.689589837" TO COPY;

datafile 4 switched to datafile copy
    "+USERDATA/orcl/datafile/users.256.689682663"
</pre><p>The output of this command displays the new name of the data file.</p>
                     </li>
                     <li>
                        <p>Recover the renamed data file.</p>
                        <p>Run the <code class="codeph">RECOVER</code> command in the RMAN client.
                        </p>
                        <p>For example: </p><pre class="oac_no_warn" dir="ltr">RMAN&gt; RECOVER DATAFILE "+USERDATA/orcl/datafile/users.256.689682663";

Starting recover at 16-JUN-09
using channel ORA_DISK_1
starting media recovery
media recovery complete, elapsed time: 00:00:01
Finished recover at 16-JUN-09
</pre></li>
                     <li>
                        <p>Bring the data file online.</p>
                        <p>Run the <code class="codeph">SQL</code> command in the RMAN client. Use two single quotation marks around the name of the data file, not double quotation marks.
                        </p>
                        <p>For example: </p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL "ALTER DATABASE DATAFILE
      ''+USERDATA/orcl/datafile/users.256.689682663'' ONLINE";

sql statement: ALTER DATABASE DATAFILE
   ''+USERDATA/orcl/datafile/users.256.689682663'' ONLINE
</pre></li>
                     <li>
                        <p>Delete the data file copy from the original Oracle ASM disk group.</p>
                        <p>In this scenario, <code class="codeph">+DATA/orcl/datafile/users.261.689589837</code> is the original data file in <code class="codeph">DATA</code>. Because you issued <code class="codeph">SET NEWNAME</code> and <code class="codeph">SWITCH</code> commands for this data file, the original file is now recorded in the RMAN repository as a data file copy. Run a <code class="codeph">DELETE</code> command in the RMAN client to remove this file. 
                        </p>
                        <p>For example:</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; DELETE DATAFILECOPY "+DATA/orcl/datafile/users.261.689589837";

released channel: ORA_DISK_1
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=51 device type=DISK
List of Datafile Copies
=======================
Key     File S Completion Time Ckp SCN    Ckp Time       
------- ---- - --------------- ---------- ---------------
14      4    A 16-JUN-09       864471     16-JUN-09      
        Name: +DATA/orcl/datafile/users.261.689589837
        Tag: TAG20090615T084217

Do you really want to delete the above objects (enter YES or NO)? y
deleted datafile copy
datafile copy file name=+DATA/orcl/datafile/users.261.689589837 RECID=14 STAMP=689683255
Deleted 1 objects

</pre></li>
                  </ol>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>