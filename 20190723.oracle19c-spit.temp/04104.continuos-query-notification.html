<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Continuous Query Notification</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="JDBC Developer's Guide">
      <meta property="og:description" content>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="JDBC Developer's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="jdbc-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2019-02-13T13:20:37-08:00">
      <meta name="dcterms.title" content="JDBC Developer's Guide">
      <meta name="dcterms.dateCopyrighted" content="1999, 2019">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E96471-02">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19">
      
      <link rel="prev" href="advanced-queuing.html" title="Previous" type="text/html">
      <link rel="next" href="high-availablility.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="JJDBC">
    <meta name="dcterms.release" content="Release 19">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="advanced-queuing.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="high-availablility.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">JDBC Developer's Guide</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="performance-and-scalability.html" property="item" typeof="WebPage"><span property="name"> Performance and Scalability</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Continuous Query Notification </li>
            </ol>
            <a id="GUID-4987516F-872F-47D1-B9E7-270A28D50AF8" name="GUID-4987516F-872F-47D1-B9E7-270A28D50AF8"></a><a id="JJDBC28815"></a>
            
            <h2 id="JJDBC-GUID-4987516F-872F-47D1-B9E7-270A28D50AF8" class="sect2"><span class="enumeration_chapter">27 </span>Continuous Query Notification 
            </h2>
         </header>
         <div class="ind">
            <div>
               <p>This section describes the following topics:</p>
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-A66564C6-15CE-4D95-8AF6-E86954DD56C8">Overview of Continuos Query Notification</a></p>
                  </li>
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE">Creating a Registration</a></p>
                  </li>
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-6CA108CC-658D-447D-8B8A-ABBBF975871F">Associating a Query with a Registration</a></p>
                  </li>
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8">Notifying Database Change Events</a></p>
                  </li>
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-17D0D7C5-77C9-420D-9D13-F668C1056792">Deleting a Registration</a></p>
                  </li>
               </ul>
            </div>
            <div class="props_rev_3"><a id="GUID-A66564C6-15CE-4D95-8AF6-E86954DD56C8" name="GUID-A66564C6-15CE-4D95-8AF6-E86954DD56C8"></a><h3 id="JJDBC-GUID-A66564C6-15CE-4D95-8AF6-E86954DD56C8" class="sect3"><span class="enumeration_section">27.1 </span>Overview of Continuous Query Notification
               </h3>
               <div>
                  <p>Generally, a middle-tier data cache duplicates some data from the back-end database server. Its goal is to avoid redundant queries to the database. However, this is efficient only when the data rarely changes in the database. The data cache has to be updated or invalidated when the data changes in the database. Starting from 11<span class="italic">g</span> Release 1, Oracle JDBC drivers provide support for the Continuous Query Notification feature of Oracle Database. Using this functionality, multitier systems can take advantage of the Continuous Query Notification feature to maintain a data cache as up-to-date as possible, by receiving invalidation events from the JDBC drivers.
                  </p>
                  <p>The JDBC drivers can register SQL queries with the database and receive notifications in response to the following:</p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p>DML or DDL changes on the objects associated with the queries</p>
                     </li>
                     <li>
                        <p>DML or DDL changes that affect the result set</p>
                     </li>
                  </ul>
                  <p>The notifications are published when the DML or DDL transaction commits (changes made in a local transaction do not generate any event until they are committed).</p>
                  <p>To use Oracle JDBC driver support for Continuous Query Notification, perform the following:</p>
                  <ol>
                     <li>
                        <p>Registration: You first need to create a registration.</p>
                     </li>
                     <li>
                        <p>Query association: After you have created a registration, you can associate SQL queries with it. These queries are part of the registration.</p>
                     </li>
                     <li>
                        <p>Notification: Notifications are created in response to changes in tables or result set. Oracle database communicates these notifications to the JDBC drivers through a dedicated network connection and JDBC drivers convert these notifications to Java events.</p>
                     </li>
                  </ol>
                  <p>Also, you need to grant the <code class="codeph">CHANGE NOTIFICATION</code> privilege to the user. For example, if you connect to the database using the <code class="codeph">HR</code> user name, then you need to run the following command in the database:
                  </p><pre class="oac_no_warn" dir="ltr">grant change notification to HR;
</pre></div>
            </div><a id="JJDBC28816"></a><div class="props_rev_3"><a id="GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE" name="GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE"></a><h3 id="JJDBC-GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE" class="sect3"><span class="enumeration_section">27.2 </span>Creating a Registration
               </h3>
               <div>
                  <div class="section">
                     <p>Creating a registration is a one-time process and is done outside the currently used transaction. The API for creating a registration in the server is executed in its own transaction and is committed immediately. You need a JDBC connection to create a registration, however, the registration is not attached to the connection. You can close the connection after creating a registration, and the registration survives. In an Oracle RAC environment, a registration is a persistent entity that exists on all nodes. The registration exists in the Database. So, even if a node goes down, the registration continues to exist and is notified when the tables change.</p>
                     <p>There are two ways to create a registration:</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <ul style="list-style-type: disc;">
                        <li>
                           <p>The JDBC-style of registration: Use the JDBC driver to create a registration on the server. The JDBC driver launches a new thread that listens to notifications from the server (through a dedicated channel) and converts these notification messages into Java events. The driver then notifies all the listeners registered with this registration.</p>
                        </li>
                        <li>
                           <p>The PL/SQL-style of registration: If you want a PL/SQL stored procedure to handle the notifications, then create a PL/SQL-style registration. As in the JDBC-style of registration, the JDBC drivers enable you to attach statements (queries) to this registration. However the JDBC drivers do not get notifications from the server because the notifications are handled by the PL/SQL stored procedure.</p>
                        </li>
                     </ul>
                     <div class="infoboxnote" id="GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE__GUID-BA4D600F-5AB1-4140-91D9-B7E0B7087919">
                        <p class="notep1">Note:</p>
                        <p>This approach is useful only for nonmultithreaded languages, such as PHP.</p>
                     </div>
                     <p>There is no way to remove one particular object (table) from an existing registration. A workaround would be to either create a new registration without this object or ignore the events that are related to this object.</p>
                     <p>You can use the <code class="codeph">registerDatabaseChangeNotification</code> method of the <code class="codeph">oracle.jdbc.OracleConnection</code> interface to create a JDBC-style of registration. You can set certain registration options through the <code class="codeph">options</code> parameter of this method. The <span class="q">"Continuous Query Notification Registration Options"</span> table in the following section lists some of the registration options that can be set. To set these options, use the <code class="codeph">java.util.Properties</code> object. These options are defined in the <code class="codeph">oracle.jdbc.OracleConnection</code> interface. The registration options have a direct impact on the notification events that the JDBC drivers will create. The example (at the end of this chapter) illustrates how to use the Continuous Query Notification feature.
                     </p>
                     <p>The <code class="codeph">registerDatabaseChangeNotification</code> method creates a new database change registration in the database server with the given options. It returns a <code class="codeph">DatabaseChangeRegistration</code> object, which can then be used to associate a statement with this registration. It also opens a listener socket that will be used by the database to send notifications.
                     </p>
                     <div class="infoboxnote" id="GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE__GUID-A023C55E-14D5-4E46-8214-69CD567DE124">
                        <p class="notep1">Note:</p>
                        <p>If a listener socket (created by a different registration) exists, then this socket will be used by the new database change registration as well.</p>
                     </div>
                  </div>
                  <!-- class="section" -->
               </div><a id="JJDBC28817"></a><div class="props_rev_3"><a id="GUID-8A2BF5CA-CB76-4D88-B467-4A2AE63D89D4" name="GUID-8A2BF5CA-CB76-4D88-B467-4A2AE63D89D4"></a><h4 id="JJDBC-GUID-8A2BF5CA-CB76-4D88-B467-4A2AE63D89D4" class="sect4"><span class="enumeration_section">27.2.1 </span>Continuous Query Notification Registration Options
                  </h4>
                  <div>
                     <div class="section">
                        <p>The following table lists the Continuous Query Notification Registration Options:</p>
                     </div>
                     <!-- class="section" -->
                     <div class="tblformalwide" id="GUID-8A2BF5CA-CB76-4D88-B467-4A2AE63D89D4__CHDBDJHC">
                        <p class="titleintable">Table 27-1 Continuous Query Notification Registration Options</p>
                        <table cellpadding="4" cellspacing="0" class="FormalWide" title="Continuous Query Notification Registration Options" summary="table" width="100%" frame="hsides" border="1" rules="rows">
                           <thead>
                              <tr align="left" valign="top">
                                 <th align="left" valign="bottom" width="35%" id="d73901e214">Option</th>
                                 <th align="left" valign="bottom" width="65%" id="d73901e217">Description</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e222" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_IGNORE_DELETEOP</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e222 d73901e217 ">
                                    <p>If set to <code class="codeph">true</code>, <code class="codeph">DELETE</code> operations will not generate any database change event.
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e236" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_IGNORE_INSERTOP</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e236 d73901e217 ">
                                    <p>If set to <code class="codeph">true</code>, <code class="codeph">INSERT</code> operations will not generate any database change event.
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e250" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_IGNORE_UPDATEOP</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e250 d73901e217 ">
                                    <p>If set to <code class="codeph">true</code>, <code class="codeph">UPDATE</code> operations will not generate any database change event.
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e264" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_NOTIFY_CHANGELAG</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e264 d73901e217 ">
                                    <p>Specifies the number of transactions by which the client is willing to lag behind.</p>
                                    <p><span class="bold">Note:</span> If this option is set to any value other than <code class="codeph">0</code>, then <code class="codeph">ROWID</code> level granularity of information will not be available in the events, even if the <code class="codeph">DCN_NOTIFY_ROWIDS</code> option is set to <code class="codeph">true</code>.
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e288" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_NOTIFY_ROWIDS</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e288 d73901e217 ">
                                    <p>Database change events will include row-level details, such as operation type and <code class="codeph">ROWID</code>.
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e299" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_QUERY_CHANGE_NOTIFICATION</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e299 d73901e217 ">
                                    <p>Activates query change notification instead of object change notification.</p>
                                    <p><span class="bold">Note:</span> This option is available only when running against an 11.0 database.
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e311" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_LOCAL_HOST</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e311 d73901e217 ">
                                    <p>Specifies the IP address of the computer that will receive the notifications from the server.</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e319" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_LOCAL_TCP_PORT</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e319 d73901e217 ">
                                    <p>Specifies the TCP port that the driver should use for the listener socket.</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e327" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_QOS_PURGE_ON_NTFN</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e327 d73901e217 ">
                                    <p>Specifies if the registration should be expunged on the first notification event.</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e335" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_QOS_RELIABLE</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e335 d73901e217 ">
                                    <p>Specifies whether or not to make the notifications persistent, which comes at a performance cost.</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e343" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_TIMEOUT</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e343 d73901e217 ">
                                    <p>Specifies the time in seconds after which the registration will be automatically expunged by the database.</p>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                     <!-- class="inftblhruleinformal" -->
                     <div class="section">
                        <p>If there exists a registration, then you can also use the <code class="codeph">getDatabaseChangeRegistration</code> method to map the existing registration with a new <code class="codeph">DatabaseChangeRegistration</code> object. This method is particularly useful if you have created a registration using PL/SQL and want to associate a statement with it.
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="JJDBC28818"></a><div class="props_rev_3"><a id="GUID-6CA108CC-658D-447D-8B8A-ABBBF975871F" name="GUID-6CA108CC-658D-447D-8B8A-ABBBF975871F"></a><h3 id="JJDBC-GUID-6CA108CC-658D-447D-8B8A-ABBBF975871F" class="sect3"><span class="enumeration_section">27.3 </span>Associating a Query with a Registration
               </h3>
               <div>
                  <div class="section">
                     <p>After you have created a registration or mapped to an existing registration, you can associate a query with it. Like creating a registration, associating a query with a registration is a one-time process and is done outside of the currently used registration. The query will be associated even if the local transaction is rolled back.</p>
                     <p>You can associate a query with registration using the <code class="codeph">setDatabaseChangeRegistration</code> method defined in the <code class="codeph">OracleStatement</code> class. This method takes a <code class="codeph">DatabaseChangeRegistration</code> object as parameter. The following code snippet illustrates how to associate a query with a registration:
                     </p><pre class="oac_no_warn" dir="ltr">...
// conn is an OracleConnection object.
// prop is a Properties object containing the registration options.
DatabaseChangeRegistration dcr = conn.registerDatabaseChangeNotifictaion(prop);
...
Statement stmt = conn.createStatement();
// associating the query with the registration
((OracleStatement)stmt).setDatabaseChangeRegistration(dcr);
// any query that will be executed with the 'stmt' object will be associated with
// the registration 'dcr' until 'stmt' is closed or
// '((OracleStatement)stmt).setDatabaseChangeRegistration(null);' is executed.
...
</pre></div>
                  <!-- class="section" -->
               </div>
            </div><a id="JJDBC28819"></a><div class="props_rev_3"><a id="GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8" name="GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8"></a><h3 id="JJDBC-GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8" class="sect3"><span class="enumeration_section">27.4 </span>Notifying Database Change Events
               </h3>
               <div>
                  <div class="section">
                     <p>To receive Continuous Query Notifications, attach a listener to the registration. When a database change event occurs, the database server notifies the JDBC driver. The driver then constructs a new Java event, identifies the registration to be notified, and notifies the listeners attached to the registration. The event contains the object ID of the database object that has changed and the type of operation that caused the change. Depending on the registration options, the event may also contain row-level detail information. The listener code can then use the event to make decisions about the data cache.</p>
                     <div class="infoboxnote" id="GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8__GUID-7430853C-5CE4-4940-BD48-7133F9FE97F4">
                        <p class="notep1">Note:</p>
                        <p>The listener code must not slow down the JDBC notification mechanism. If the code is time-consuming, for example, if it refreshes the data cache by querying the database, then it needs to be executed within its own thread.</p>
                     </div>
                     <p>You can attach a listener to a registration using the <code class="codeph">addListener</code> method. The following code snippet illustrates how to attach a listener to a registration:
                     </p><pre class="oac_no_warn" dir="ltr">...
// conn is an OracleConnection object.
// prop is a Properties object containing the registration options.
DatabaseChangeRegistration dcr = conn.registerDatabaseChangeNotifictaion(prop);
...
// Attach the listener to the registration.
// Note: DCNListener is a custom listener and not a predefined or standard 
// lsiener
DCNListener list = new DCNListener();
dcr.addListener(list);
...
</pre></div>
                  <!-- class="section" -->
               </div>
            </div><a id="JJDBC28822"></a><a id="JJDBC28820"></a><div class="props_rev_3"><a id="GUID-17D0D7C5-77C9-420D-9D13-F668C1056792" name="GUID-17D0D7C5-77C9-420D-9D13-F668C1056792"></a><h3 id="JJDBC-GUID-17D0D7C5-77C9-420D-9D13-F668C1056792" class="sect3"><span class="enumeration_section">27.5 </span>Deleting a Registration
               </h3>
               <div>
                  <div class="section">
                     <p>You need to explicitly unregister a registration to delete it from the server and release the resources in the driver. You can unregister a registration using a connection different from one that was used for creating it. To unregister a registration, you can use the <code class="codeph">unregisterDatabaseChangeNotification</code> method defined in <code class="codeph">oracle.jdbc.OracleConnection</code>.
                     </p>
                     <p>You must pass the <code class="codeph">DatabaseChangeRegistration</code> object as a parameter to this method. This method deletes the registration from the server and the driver and closes the listener socket.
                     </p>
                     <p>If the registration was created outside of JDBC, say using PL/SQL, then you must pass the registration ID instead of the <code class="codeph">DatabaseChangeRegistration</code> object. The method will delete the registration from the server, however, it does not free any resources in the driver.
                     </p>
                     <p><a href="continuos-query-notification.html#GUID-17D0D7C5-77C9-420D-9D13-F668C1056792__CHDCJFGJ">Example 27-1</a> illustrates how to use the Continuous Query Notification feature. In this example, the <code class="codeph">HR</code> user is connecting to the database. Therefore in the database you need to grant the following privilege to the user:
                     </p><pre class="oac_no_warn" dir="ltr">grant change notification to HR;
</pre><p>This code will also work with Oracle Database 10<span class="italic">g</span> Release 2 (10.2). This code uses table registration. That is, when you register a <code class="codeph">SELECT</code> query, what you register is the name of the tables involved and not the query itself. In other words, you might select one single row of a table and if another row is updated, you will be notified although the result of your query has not changed.
                     </p>
                     <p>In this example, if you leave the registration open instead of closing it, then the Continuous Query Notification thread continues to run. Now if you run a DML query that changes the <code class="codeph">HR.DEPARTMENTS</code> table and commit it, say from SQL*Plus, then the Java program prints the notification.
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="example" id="GUID-17D0D7C5-77C9-420D-9D13-F668C1056792__CHDCJFGJ">
                     <p class="titleinexample">Example 27-1 Continuous Query Notification</p><pre class="oac_no_warn" dir="ltr">import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Properties;
import oracle.jdbc.OracleConnection;
import oracle.jdbc.OracleDriver;
import oracle.jdbc.OracleStatement;
import oracle.jdbc.dcn.DatabaseChangeEvent;
import oracle.jdbc.dcn.DatabaseChangeListener;
import oracle.jdbc.dcn.DatabaseChangeRegistration;
 
public class DBChangeNotification
{
  static final String USERNAME= "HR";
  static final String PASSWORD= "hr";
  static String URL;
  
  public static void main(String[] argv)
  {
    if(argv.length &lt; 1)
    {
      System.out.println("Error: You need to provide the URL in the first argument.");
      System.out.println("  For example: &gt; java -classpath .:ojdbc6.jar DBChangeNotification \"jdbc:oracle:thin:
@(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=yourhost.yourdomain.com)(PORT=5221))(CONNECT_DATA=
(SERVICE_NAME=orcl)))\"");
 
      System.exit(1);
    }
    URL = argv[0];
    DBChangeNotification demo = new DBChangeNotification();
    try
    {
      demo.run();
    }
    catch(SQLException mainSQLException )
    {
      mainSQLException.printStackTrace();
    }
  }
 
  void run() throws SQLException
  {
    OracleConnection conn = connect();
      
    // first step: create a registration on the server:
    Properties prop = new Properties();
    
    // if connected through the VPN, you need to provide the TCP address of the client.
    // For example:
    // prop.setProperty(OracleConnection.NTF_LOCAL_HOST,"14.14.13.12");
 
    // Ask the server to send the ROWIDs as part of the DCN events (small performance
    // cost):
    prop.setProperty(OracleConnection.DCN_NOTIFY_ROWIDS,"true");
// 
//Set the DCN_QUERY_CHANGE_NOTIFICATION option for query registration with finer granularity.
 prop.setProperty(OracleConnection.DCN_QUERY_CHANGE_NOTIFICATION,"true");
 
    // The following operation does a roundtrip to the database to create a new
    // registration for DCN. It sends the client address (ip address and port) that
    // the server will use to connect to the client and send the notification
    // when necessary. Note that for now the registration is empty (we haven't registered
    // any table). This also opens a new thread in the drivers. This thread will be
    // dedicated to DCN (accept connection to the server and dispatch the events to 
    // the listeners).
    DatabaseChangeRegistration dcr = conn.registerDatabaseChangeNotification(prop);
 
    try
    {
      // add the listenerr:
      DCNDemoListener list = new DCNDemoListener(this);
      dcr.addListener(list);
       
      // second step: add objects in the registration:
      Statement stmt = conn.createStatement();
      // associate the statement with the registration:
      ((OracleStatement)stmt).setDatabaseChangeRegistration(dcr);
      ResultSet rs = stmt.executeQuery("select * from dept where deptno='45'");
      while (rs.next())
      {}
      String[] tableNames = dcr.getTables();
      for(int i=0;i&lt;tableNames.length;i++)
        System.out.println(tableNames[i]+" is part of the registration.");
      rs.close();
      stmt.close();
    }
    catch(SQLException ex)
    {
      // if an exception occurs, we need to close the registration in order
      // to interrupt the thread otherwise it will be hanging around.
      if(conn != null)
        conn.unregisterDatabaseChangeNotification(dcr);
      throw ex;
    }
    finally
    {
      try
      {
        // Note that we close the connection!
        conn.close();
      }
      catch(Exception innerex){ innerex.printStackTrace(); }
    }
    
    synchronized( this ) 
    {
      // The following code modifies the dept table and commits:
      try
      {
        OracleConnection conn2 = connect();
        conn2.setAutoCommit(false);
        Statement stmt2 = conn2.createStatement();
        stmt2.executeUpdate("insert into dept (deptno,dname) values ('45','cool dept')",
Statement.RETURN_GENERATED_KEYS);
        ResultSet autoGeneratedKey = stmt2.getGeneratedKeys();
        if(autoGeneratedKey.next())
          System.out.println("inserted one row with ROWID="+autoGeneratedKey.getString(1));      
        stmt2.executeUpdate("insert into dept (deptno,dname) values ('50','fun dept')",
Statement.RETURN_GENERATED_KEYS);
        autoGeneratedKey = stmt2.getGeneratedKeys();
        if(autoGeneratedKey.next())
          System.out.println("inserted one row with ROWID="+autoGeneratedKey.getString(1));
        stmt2.close();
        conn2.commit();
        conn2.close();
      }
      catch(SQLException ex) { ex.printStackTrace(); }
 
      // wait until we get the event
      try{ this.wait();} catch( InterruptedException ie ) {}
    }
    
    // At the end: close the registration (comment out these 3 lines in order
    // to leave the registration open).
    OracleConnection conn3 = connect();
    conn3.unregisterDatabaseChangeNotification(dcr);
    conn3.close();
  }
  
  /**
   * Creates a connection the database.
   */
  OracleConnection connect() throws SQLException
  {
    OracleDriver dr = new OracleDriver();
    Properties prop = new Properties();
    prop.setProperty("user",DBChangeNotification.USERNAME);
    prop.setProperty("password",DBChangeNotification.PASSWORD);
    return (OracleConnection)dr.connect(DBChangeNotification.URL,prop);
  }
}
/**
 * DCN listener: it prints out the event details in stdout.
 */
class DCNDemoListener implements DatabaseChangeListener
{
  DBChangeNotification demo;
  DCNDemoListener(DBChangeNotification dem)
  {
    demo = dem;
  }
  public void onDatabaseChangeNotification(DatabaseChangeEvent e)
  {
    Thread t = Thread.currentThread();
    System.out.println("DCNDemoListener: got an event ("+this+" running on thread "+t+")");
    System.out.println(e.toString());
    synchronized( demo ){ demo.notify();}
  }
}</pre></div>
                  <!-- class="example" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>