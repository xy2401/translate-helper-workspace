<html lang="en-US" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="../app/v2/analytics.js"></script><link rel="canonical" href="remote-development-on-raspberry-pi.html"></link><meta charset="UTF-8"></meta><title>教程：Raspberry Pi上的远程开发 - 帮助| PyCharm</title><link rel="stylesheet" href="../app/v2/app.css"></link></head><body dir="ltr" data-id="Remote_Development_on_Raspberry_Pi"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索PyCharm帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="remote-development-on-raspberry-pi.html#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>PyCharm 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">键盘布局</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option value="primary_default" data-group="primary" selected="">Windows / Linux默认值</option><option value="primary_default_for_gnome" data-group="primary">GNOME</option><option value="primary_default_for_kde" data-group="primary">KDE</option><option value="primary_default_for_xwin" data-group="primary">XWin中</option><option value="primary_emacs" data-group="primary">Emacs的</option><option value="primary_visual_studio" data-group="primary">视觉工作室</option><option value="primary_netbeans" data-group="primary">NetBeans的</option><option value="primary_eclipse" data-group="primary">日食</option><option value="secondary_mac_os_x_10.5_" data-group="secondary">默认（Mac OS X 10.5+）</option><option value="secondary_mac_os_x" data-group="secondary">Mac OS X.</option><option value="secondary_eclipse_mac_os_x" data-group="secondary">Eclipse（Mac OS X）</option><option value="secondary_intellij_idea_classic_os_x" data-group="secondary">IntelliJ IDEA Classic（Mac OS X）</option><option value="secondary_xcode" data-group="secondary">Xcode中</option><option value="secondary_visual_studio" data-group="secondary">视觉工作室</option><option value="secondary_resharper" data-group="secondary">ReSharper的</option><option value="secondary_resharper_osx" data-group="secondary">ReSharper（Mac OS X）</option><option value="secondary_emacs" data-group="secondary">Emacs（Mac OS X）</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="active"><h1 id="Remote_Development_on_Raspberry_Pi.xml" data-toc="Remote_Development_on_Raspberry_Pi">教程：Raspberry Pi上的远程开发</h1><div class="chapter"><h2 id="intro" data-toc="Remote_Development_on_Raspberry_Pi#intro">介绍</h2>    <p id="489c418c">我们都知道，互联网服务提供商有一种超越他们联系的习惯，这有时会导致我们的联系不如我们所希望的那么好。此外，我们中的许多人都在使用Raspberry Pi来等待很酷的项目。所以，让我们使用Pi来检查我们的互联网连接！</p>    <p id="0191abbf">互联网连接的关键指标之一是它与互联网上其他主机的ping时间。因此，让我们编写一个程序，定期ping其他主机并记录结果。</p>    <p id="04f6fada">对于那些想要在其他远程计算机上远程执行代码的人，例如AWS实例或DigitalOcean Droplet，过程完全相同。</p>    <p id="3437a53a">本教程是在Windows上创建的，代码是在RPi上执行的，RPi是一台Linux计算机。在其他受支持的操作系统上，某些路径和工作流程可能略有不同。</p></div><div class="chapter"><h2 id="prereq" data-toc="Remote_Development_on_Raspberry_Pi#prereq">在你开始之前</h2>    <p id="0ced75a0">要执行本教程，请确保满足以下先决条件：</p>    <ul class="list _ul"><li class="list__item" id="c2748ecc"><p>你有专业版的PyCharm。</p></li><li class="list__item" id="7e3210e3"><p>代码将在任何Linux机器上运行。您也可以使用本地VM。</p></li></ul>    <p id="install-additional-software">您还需要一些额外的软件：</p>    <ul class="list _ul"><li class="list__item" id="55d546b2"><p><code class="code">PostgreSQL</code> ，因为它将用于创建数据库。</p></li><li class="list__item" id="8ac772f6"><p><code class="code">Libpq-dev</code> ， <code class="code">Psycopg2</code>需要。</p></li><li class="list__item" id="7d6bddfa"><p><code class="code">Python-dev</code> ，需要编译<code class="code">Psycopg2</code> 。</p></li></ul>    <p id="0ba3ed8c">要一次安装所有这些，请运行以下命令：</p>    <div class="code-block" data-lang="Console"><code class="code-block__wrapper">sudo apt-get update <span class="o">&amp;&amp;</span> sudo apt-get install -y postgresql libpq-dev python-dev</code></div></div><div class="chapter"><h2 id="raspberry-ping" data-toc="Remote_Development_on_Raspberry_Pi#raspberry-ping">覆盆子</h2>        <p id="6c23f01b">我们将构建的应用程序包含两部分：</p>            <ul class="list _ul"><li class="list__item" id="4e1ffcdb"><p><span class="control">首先</span> ，我们实际进行测量。为了测量结果，我们可以调用每个Linux机器（包括Raspberry Pi）附带的ping命令行工具。然后，我们将结果存储在PostgreSQL数据库中。</p></li><li class="list__item" id="3675e9c4"><p><span class="control">其次</span> ，我们将使用Flask应用程序对结果进行可视化，该应用程序使用Matplotlib绘制最近结果的图表。</p></li></ul>    </div><div class="chapter"><h2 id="prepare" data-toc="Remote_Development_on_Raspberry_Pi#prepare">准备你的Raspberry Pi</h2>    <p id="be4820e1">由于我们希望以后能够查看带有结果的网页，因此在我们的网络中为我们的Pi提供固定的IP非常重要。为此，请编辑<code class="code">/etc/network/interfaces</code> 。有关其他详细信息，请参阅<a href="https://thepihut.com/blogs/raspberry-pi-tutorials/16683276-how-to-setup-a-static-ip-address-on-your-raspberry-pi" data-bypass="yes" target="_blank"><span>本教</span></a></p>    <p id="b27559d8">在将Pi设置为使用静态IP之后，请在命令行上使用<code class="code">raspi-config</code> 。转到“ <span class="control">高级选项”</span> ，选择“ <span class="control">SSH”</span> ，然后选择“ <span class="control">是”</span> 。当你完成这项工作后，你就可以开始使用PyCharm了。</p></div><div class="chapter"><h2 id="creating-project" data-toc="Remote_Development_on_Raspberry_Pi#creating-project">创建一个项目</h2>        <p id="bec06beb">创建一个纯Python项目：为此，选择<span class="menupath" data-skip-index="skip">File |新项目</span> 。将项目命名为“raspberry.pi”请参阅<a href="creating-empty-project.html"><span>创建纯Python项目</span></a> 。</p>                <p id="f6d5f717">然后按照<a href="configuring-remote-interpreters-via-ssh.html"><span>使用SSH配置</span></a>远程解释器中所述添加SSH远程解释<a href="configuring-remote-interpreters-via-ssh.html"><span>器</span></a> 。配置SSH服务器时，请指定Pi（ <span class="control">主机</span> ）的IP地址，例如172.27.120.177。另外，指定用于登录设备的凭据。</p>        <p id="d8d2ae1f">接下来，在PyCharm中，按<kbd data-primary_default="Ctrl+Shift+A" data-primary_default_for_gnome="Ctrl+Shift+A" data-primary_default_for_kde="Ctrl+Shift+A" data-primary_default_for_xwin="Ctrl+Shift+A" data-primary_emacs="Escape, X" data-primary_visual_studio="Ctrl+Shift+A" data-primary_netbeans="Ctrl+I" data-primary_eclipse="Ctrl+Shift+A" data-secondary_mac_os_x_10.5_="⇧⌘A" data-secondary_mac_os_x="⇧⌘A" data-secondary_eclipse_mac_os_x="⌘3" data-secondary_intellij_idea_classic_os_x="N/A" data-secondary_xcode="N/A" data-secondary_visual_studio="⌃⇧A" data-secondary_resharper="N/A" data-secondary_resharper_osx="N/A" data-secondary_emacs="⎋, X">Ctrl + Shift + A</kbd> ，开始输入“启动SSH会话”：</p>        <figure><img alt="py start ssh session" title="py start ssh session" src="../img/idea/2019.1/py_start_ssh_session.png" id="4ddef8ee" width="408" height="101"></figure>        <p id="b104fa67">然后从主机列表中选择您的Raspberry Pi，您应该连接。</p>        <p id="2253455d">接下来， <a href="remote-development-on-raspberry-pi.html#install-additional-software">安装其他软件</a> 。</p>    </div><div class="chapter"><h2 id="setup-permission" data-toc="Remote_Development_on_Raspberry_Pi#setup-permission">在PostgreSQL中设置权限和创建数据库</h2>        <p id="870494ed">我们现在需要在PostgreSQL中设置权限。最简单的方法是返回我们的SSH终端，并运行以下命令以获得Postgres用户的SQL提示：</p>            <div class="code-block" data-lang="Console"><code class="code-block__wrapper">sudo -u postgres psql</code></div>            <p id="b54e3ada">现在让我们创建一个用户（Postgres术语中的'角色'），其名称与我们运行该过程的用户的名称相同：</p>        <div class="code-block" data-lang="Console"><code class="code-block__wrapper">创建角色pi与登录密码'hunter2' <span class="p">;</span></code></div>        <p id="183d32d9">重要的提示！确保PostgreSQL中的角色与Linux用户名同名。您可能还想替换更好的密码。在psql中使用分号（;）结束SQL语句非常重要，因为它假定您在使用分号终止之前编写多行语句。我们授予pi用户登录权限，这意味着用户可以登录。没有登录权限的角色用于创建组。</p>        <p id="database">接下来，创建一个数据库：</p>        <div class="code-block" data-lang="Console"><code class="code-block__wrapper">与OWNER pi一起创建数据库pi <span class="p">;</span></code></div>        <p id="6d2eeeb8">接下来，使用<code class="code">\q</code>退出<code class="code">psql</code> 。</p>    </div><div class="chapter"><h2 id="run" data-toc="Remote_Development_on_Raspberry_Pi#run">捕获ping</h2>    <p id="c2744a95">要获取有关Internet连接质量的信息，请使用系统的<code class="code">ping</code>实用程序ping服务器，然后使用正则表达式读取结果。那么让我们来看看<code class="code">ping</code>的输出：</p>    <div class="code-block" data-lang="Console"><code class="code-block__wrapper">PING jetbrains.com <span class="o">（</span> 54.217.236.18 <span class="o">）</span> 56 <span class="o">（</span> 84 <span class="o">）</span>字节的数据。

<span class="m">64</span>字节来自ec2-54-217-236-18.eu-west-1.compute.amazonaws.com <span class="o">（</span> 54.217.236.18 <span class="o">）</span> ： <span class="nv">icmp_seq</span> <span class="o">=</span> <span class="m">1</span> <span class="nv">ttl</span> <span class="o">=</span> <span class="m">47</span> <span class="nb">time</span> <span class="o">=</span> 32.9 ms <span class="m">64</span>字节来自ec2-54-217-236 -18.eu-west-1.compute.amazonaws.com <span class="o">（</span> 54.217.236.18 <span class="o">）</span> ： <span class="nv">icmp_seq</span> <span class="o">=</span> <span class="m">2</span> <span class="nv">ttl</span> <span class="o">=</span> <span class="m">47</span> <span class="nb">time</span> <span class="o">=</span> 32.9 ms <span class="m">64</span>字节来自ec2-54-217-236-18.eu- west-1.compute .amazonaws.com <span class="o">（</span> 54.217.236.18 <span class="o">）</span> ： <span class="nv">icmp_seq</span> <span class="o">=</span> <span class="m">3</span> <span class="nv">ttl</span> <span class="o">=</span> <span class="m">47</span> <span class="nb">time</span> <span class="o">=</span> 32.9 ms <span class="m">64</span>字节来自ec2-54-217-236-18.eu-west-1.compute.amazonaws.com <span class="o">（</span> 54.217.236.18 <span class="o">）</span> ： <span class="nv">icmp_seq</span> <span class="o">=</span> <span class="m">4</span> <span class="nv">ttl</span> <span class="o">=</span> <span class="m">47</span> <span class="nb">time</span> <span class="o">=</span> 32.9 ms --- jetbrains.com ping statistics ---发送<span class="m">4</span> <span class="m">个</span>包， <span class="m">4个</span>接收，0％丢包， <span class="nb">时间</span> 3003ms rtt min / avg / max / mdev <span class="o">=</span> 32.909 / 32.951 / 32.992 / 0.131毫秒</code></div>    <p id="3bc12e02">所有具有单独往返时间的行都以<code class="code">64 bytes from</code>开头。那么让我们创建一个文件<code class="code">ping.py</code> （ <span class="menupath" data-skip-index="skip">文件|新建 -  Python文件</span> ），然后开始编码。</p>    <p id="82a752dc">我们可以先获取ping的输出，然后遍历这些行，选择以数字开头，后跟“bytes from”字样的行：</p>    <div class="code-block" data-lang="Python"><code class="code-block__wrapper"><span class="n">主机</span> <span class="o">=</span> <span class="s">'jetbrains.com'</span> <span class="n">ping_output</span> <span class="o">=</span> <span class="n"><span class="o">subprocess32。</span></span> <span class="n"><span class="p">check_output（[</span></span> <span class="s">“平<span class="p">”，</span></span> <span class="n">宿主</span> <span class="s">“-c <span class="p">5”]），</span></span> <span class="k"><span class="ow">用于</span></span> <span class="n">ping_output</span> <span class="n">线</span> <span class="o">。</span> <span class="n">拆分</span> <span class="p">（</span> <span class="s">'</span> <span class="se">\ n</span> <span class="s">'</span> <span class="p">）：</span> <span class="k">如果</span> <span class="n">重新</span> <span class="o">。</span> <span class="n">匹配</span> <span class="p">（</span> <span class="s">“\ d +字节来自”</span> <span class="p">，</span> <span class="n">行</span> <span class="p">）：</span> <span class="k">print</span> <span class="p">（</span> <span class="n">line</span> <span class="p">）</span></code></div>    <p id="914c1941">此时如果运行代码（ <kbd data-primary_default="Ctrl+Shift+F10" data-primary_default_for_gnome="Ctrl+Shift+F10" data-primary_default_for_kde="Ctrl+Shift+F10" data-primary_default_for_xwin="Ctrl+Shift+F10" data-primary_emacs="Ctrl+Shift+F10" data-primary_visual_studio="Ctrl+F9" data-primary_netbeans="Shift+Alt+F6" data-primary_eclipse="Ctrl+Shift+F10" data-secondary_mac_os_x_10.5_="⌃⇧R" data-secondary_mac_os_x="⌃⇧F10" data-secondary_eclipse_mac_os_x="⌃⇧R" data-secondary_intellij_idea_classic_os_x="N/A" data-secondary_xcode="N/A" data-secondary_visual_studio="⌃F9" data-secondary_resharper="N/A" data-secondary_resharper_osx="N/A" data-secondary_emacs="⌃⇧F10">Ctrl + Shift + F10</kbd> ），您应该会看到此代码在Raspberry Pi上远程运行：</p>    <figure><img alt="py raspberry pi run" title="py raspberry pi run" src="../img/idea/2019.1/py_raspberry_pi_run.png" id="8a4e3a4d" width="807" height="230"></figure>    <p id="a205f7bc">要检查部署设置是否已正确设置，请指向“ <span class="menupath" data-skip-index="skip">工具”|</span>在主菜单上进行<span class="menupath" data-skip-index="skip">部署</span> 。应检查检查命令“ <span class="control">自动上载”</span> 。</p></div><div class="chapter"><h2 id="store" data-toc="Remote_Development_on_Raspberry_Pi#store">存储ping</h2>        <p id="5ffb1f6f">我们想在<code class="code">PostgreSQL</code>存储我们的ping，所以让我们为它们创建一个表。首先，我们需要创建一个PostgreSQL数据库：</p>        <figure><img alt="py数据库postgresql" title="py数据库postgresql" src="../img/idea/2019.1/py_database_postgresql.png" id="059b96d5" width="392" height="403"></figure>        <p id="87c23594">选择PostgreSQL后，将打开数据源页面：</p>        <figure><img alt="py创建postrgesql数据库常规设置" title="py创建postrgesql数据库常规设置" src="../img/idea/2019.1/py_create_postrgesql_database_general_settings.png" id="264033f4" width="563" height="313"></figure>        <p id="107a7b46">在此页面上，下载所需的驱动程序，输入所需的凭据，然后单击“ <span class="control">测试连接”</span>按钮以确保已连接。</p>        <p id="6899c5e3">由于我们的数据库只暴露给localhost，我们需要使用SSH隧道：</p>        <figure><img alt="py创建postrgesql数据库ssh隧道" title="py创建postrgesql数据库ssh隧道" src="../img/idea/2019.1/py_create_postrgesql_database_ssh_tunnel.png" id="84445753" width="568" height="241"></figure>        <p id="f9c37687">接下来，在连接之后，通过执行<a href="https://github.com/ErnstHaagsman/raspberryping/blob/master/setup_db.sql" data-bypass="yes" target="_blank"><span>setup_db.sql</span></a>脚本来创建表。为此，将脚本从GitHub复制粘贴到连接后立即打开的SQL控制台，然后使用绿色播放按钮执行。</p>        <p id="cc23e749">现在我们已经完成了这项工作，让我们扩展我们的脚本以将ping记录到数据库中。要从Python连接到数据库，我们需要安装<code class="code">psycopg2</code> 。为此，请指向<span class="menupath" data-skip-index="skip">文件|设置</span> （适用于Windows和Linux）或<span class="menupath" data-skip-index="skip">PyCharm / Preferences</span> （适用于macOS用户），然后单击页面<a href="project-interpreter.html"><span>Project Interpreter</span></a> ，然后使用<img class="inline-icon-16" src="../img/idea/2019.1/icons.general.add@2x.png" width="16" alt="图标一般添加">安装包。如果您想查看完整的脚本，可以<a href="https://github.com/ErnstHaagsman/raspberryping/blob/master/ping.py" data-bypass="yes" target="_blank"><span>查看GitHub</span></a> 。</p>    </div><div class="chapter"><h2 id="cron" data-toc="Remote_Development_on_Raspberry_Pi#cron">克龙</h2>        <p id="e73f4d3e">为了确保我们实际上定期记录ping，我们需要安排运行此脚本。为此，我们将使用<code class="code">cron</code> 。由于我们正在对数据库使用对等身份验证，因此我们需要确保脚本以<code class="code">pi</code>用户身份运行。因此，让我们打开一个SSH会话（确保我们以<code class="code">pi</code>身份登录），然后运行<code class="code">crontab -e</code>来编辑我们的用户crontab。然后在文件的底部添加以下行：</p>        <div class="code-block" data-lang="Console"><code class="code-block__wrapper">* / 5 * * * * /home/pi/raspberryping/ping.py jetbrains.com &gt;&gt; /var/log/raspberryping.log 2&gt; <span class="p">＆</span> 1</code></div>        <p id="8495c219"><span class="emphasis">确保文件末尾有换行符！</span></p>        <p id="8bddca82">第一个<code class="code">*/5</code>表示脚本将每5分钟运行一次。如果您想要不同的频率，您可以<a href="https://en.wikipedia.org/wiki/Cron" data-bypass="yes" target="_blank"><span>了解有关crontabs的更多信息</span></a> 。现在我们还需要创建日志文件并确保脚本可以写入它：</p>        <div class="code-block" data-lang="Console"><code class="code-block__wrapper">sudo touch /var/log/raspberryping.log sudo chown pi：pi /var/log/raspberryping.log</code></div>        <p id="4692c17a">此时请花点时间，稍后再回来时，应该记录一些ping时间。要验证，让我们查看PyCharm的数据库工具。打开<a href="database-tool-window.html">数据库工具窗口</a> （在屏幕右侧），然后双击该表。您应该看到它包含值：</p>        <figure><img alt="py数据库填充" title="py数据库填充" src="../img/idea/2019.1/py_databse_filled.png" id="eda03e09" width="806" height="257"></figure>    </div><div class="chapter"><h2 id="flask" data-toc="Remote_Development_on_Raspberry_Pi#flask">创建Flask应用程序</h2>            <p id="a4f2c6ab">如果我们看不到有关它们的统计数据，那么记录ping是没有好处的。因此，让我们编写一个小型Flask应用程序（安装Flask，在终端中使用<code class="code">pip install</code> ），并使用<a href="matplotlib-support.html">matplotlib</a>绘制最近ping时间的图表。</p>            <p id="1d15247c">在我们的Flask应用程序中，我们将创建两个路径：</p>            <ul class="list _ul"><li class="list__item" id="a2401666"><p>在<code class="code">/</code> ，我们将列出我们在过去一小时内使用基本统计数据（最近，平均，最后一小时的最长时间）确定的目的地。</p></li><li class="list__item" id="aa3f2d7b"><p>在<code class="code">/graphs/&lt;destination&gt;</code>我们将绘制过去3小时内ping的图表。</p></li></ul>            <p id="3daaeaf4"><code class="code">/</code> route很简单：我们只是执行一个查询来获取我们感兴趣的数据并将其传递给模板。<a href="https://github.com/ErnstHaagsman/raspberryping/blob/master/analyze.py" data-bypass="yes" target="_blank"><span>请参阅GitHub上的完整代码</span></a> 。</p>            <p id="7476d16b">为了确保一切正常，让我们在<code class="code">render_template</code>的调用上放置一个断点：</p>            <figure><img alt="py渲染模板断点" title="py渲染模板断点" src="../img/idea/2019.1/py_render_template_breakpoint.png" id="3c2e42f1" width="549" height="120"></figure>            <p id="ab659ad6">然后启动调试会话（ <img class="inline-icon-16" src="../img/idea/2019.1/icons.actions.startDebugger.svg@2x.png" width="16" alt="图标动作startDebugger svg"> ）并在浏览器中查看结果。</p>            <p id="7a00d5ff"><code class="code">/graphs/&lt;destination&gt;</code>路由要复杂得多。首先，我们必须在合理大小的垃圾箱中获得过去三个小时的平均值（比方说，10分钟）。其次，我们必须绘制图形。</p>                   </div><div class="chapter"><h2 id="querying-data" data-toc="Remote_Development_on_Raspberry_Pi#querying-data">查询数据</h2>            <p id="12955f23">所以我们要寻找的数据是：</p>            <ul class="list _ul"><li class="list__item" id="218c1f77"><p>在过去3小时内每10分钟一次</p></li><li class="list__item" id="1755e9f0"><p>获取指定目标的最小，平均和最长ping时间</p></li></ul>                <p id="e206f382">第一部分使这个查询相当复杂。即使PostgreSQL支持间隔，日期范围以及生成一系列日期的方法，也无法生成一系列范围。这个问题的一个解决方案是公用表表达式（CTE），这是一种执行子查询的方法，您可以在以后将其称为真实表。</p>                <p id="40a60746">要以10分钟的间隔获取最后三个小时的一系列时间戳很简单：</p>            <div class="code-block" data-lang="SQL"><code class="code-block__wrapper"><span class="k">从</span> <span class="n">generate_series中</span> <span class="k">选择</span> <span class="n">begin_time</span> <span class="p">（</span> <span class="n">now</span> <span class="p">（）</span> <span class="o">-</span> <span class="nb">interval'3</span> <span class="s1">hours'</span> <span class="p">，</span> <span class="n">now</span> <span class="p">（），</span> <span class="nb">interval</span> <span class="s1">'10 minutes'</span> <span class="p">）</span> <span class="n">begin_time</span> <span class="p">;</span></code></div>            <p id="ac68eb12"><a href="https://www.postgresql.org/docs/9.5/static/functions-srf.html" data-bypass="yes" target="_blank"><span>generate_series</span></a>函数有三个参数： <code class="code">begin</code> ， <code class="code">end</code>和<code class="code">step</code> 。该功能可以使用数字和时间戳，因此可以轻松实现。如果我们在这些时候想要ping，我们现在就完成了。但是，我们需要两个时间戳之间的时间。所以我们可以使用另一个SQL魔术： <a href="https://www.postgresql.org/docs/9.6/static/functions-window.html" data-bypass="yes" target="_blank"><span>窗口函数</span></a> ，它允许我们在我们当前所在的行之前或之后处理行。所以我们将<code class="code">end_time</code>添加到查询中：</p>            <div class="code-block" data-lang="SQL"><code class="code-block__wrapper"><span class="k">选择</span> <span class="n">begin_time</span> <span class="p">，</span> <span class="n">LEAD</span> <span class="p">（</span> <span class="n">begin_time</span> <span class="p">）</span> <span class="n">OVER</span> <span class="p">（</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">begin_time</span> <span class="k">ASC</span> <span class="p">）</span> <span class="k">作为</span> <span class="k">来自</span> <span class="n">generate_series的</span> <span class="n">end_time</span> <span class="p">（</span> <span class="n">now</span> <span class="p">（）</span> <span class="o">-</span> <span class="nb">interval'3</span> <span class="s1">hours'</span> <span class="p">，</span> <span class="n">now</span> <span class="p">（），</span> <span class="nb">interval</span> <span class="s1">'10 minutes'</span> <span class="p">）</span> <span class="n">begin_time</span> <span class="p">;</span></code></div>            <p id="0363ab95"><code class="code">LEAD</code>采用结果中下一行的值，按照<code class="code">OVER</code>子句中指定的方式排序。您可以使用<code class="code">LAG</code>以类似的方式获取上一行。所以现在我们可以用<code class="code">WITH intervals as ( … query goes here … )</code>来包装这个查询<code class="code">WITH intervals as ( … query goes here … )</code>以使它成为一个CTE。然后我们可以加入我们的ping表并获得我们正在寻找的结果：</p>            <div class="code-block" data-lang="SQL"><code class="code-block__wrapper"><span class="k">WITH</span> <span class="n">interval</span> <span class="k">AS</span> <span class="p">（</span> <span class="k">SELECT</span> <span class="n">begin_time</span> <span class="p">，</span> <span class="n">LEAD</span> <span class="p">（</span> <span class="n">begin_time</span> <span class="p">）</span> <span class="n">OVER</span> <span class="p">（</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">begin_time</span> <span class="p">）</span> <span class="k">AS</span> <span class="n">end_time</span> <span class="k">FROM</span> <span class="n">generate_series</span> <span class="p">（</span> <span class="n">now</span> <span class="p">（）</span> <span class="o">-</span> <span class="nb">INTERVAL'3</span> <span class="s1">hours'</span> <span class="p">，</span> <span class="n">now</span> <span class="p">（），</span> <span class="nb">INTERVAL</span> <span class="s1">'10 minutes'</span> <span class="p">）</span> <span class="n">begin_time</span> <span class="p">）</span> <span class="k">SELECT</span> <span class="n">i</span> <span class="p">。</span> <span class="n">begin_time</span> <span class="k">AT</span> <span class="n">TIME</span> <span class="k">ZONE</span> <span class="s1">'欧洲/柏林'</span> <span class="k">AS</span> <span class="n">begin_time</span> <span class="p">，</span> <span class="n">i</span> <span class="p">。</span> <span class="n">end_time</span> <span class="k">AT</span> <span class="n">TIME</span> <span class="k">ZONE</span> <span class="s1">'欧洲/柏林'</span> <span class="k">AS</span> <span class="n">end_time</span> <span class="p">，</span> <span class="n">p</span> <span class="p">。</span> <span class="n">目的地</span> <span class="p">，</span> <span class="k">计数</span> <span class="p">（</span> <span class="n"><span class="p">第</span></span> <span class="n"><span class="p">pingtime），</span></span> <span class="n">圆形</span> <span class="p"><span class="k"><span class="p">（AVG（</span></span></span> <span class="n"><span class="p">第</span></span> <span class="n"><span class="p"><span class="mi"><span class="p"><span class="k">pingtime），2）AS</span></span></span></span></span> <span class="k">平均</span> <span class="p">，</span> <span class="k">最大值</span> <span class="p">（</span> <span class="n"><span class="p">第</span></span> <span class="n"><span class="p">pingtime），</span></span> <span class="k">分钟</span> <span class="p">（</span> <span class="n"><span class="p">第</span></span> <span class="n"><span class="p"><span class="k">pingtime）FROM</span></span></span> <span class="n">间隔</span> <span class="n">我</span> <span class="k">离开</span> <span class="k">JOIN</span> <span class="n">坪</span> <span class="n">P</span> <span class="k">的</span> <span class="n">页</span> <span class="p">。</span> <span class="n">recorded_at</span> <span class="o">&gt; =</span> <span class="n">i</span> <span class="p">。</span> <span class="n">begin_time</span> <span class="k">和</span> <span class="n">p</span> <span class="p">。</span> <span class="n">recorded_at</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="p">。</span> <span class="n">end_time</span> <span class="n">我在</span> <span class="k">哪里</span> <span class="p">。</span> <span class="n">end_time</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">和</span> <span class="n">destination</span> <span class="o">=</span> <span class="o">％</span> <span class="n">s</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">i</span> <span class="p">。</span> <span class="n">begin_time</span> <span class="p">，</span> <span class="n">i</span> <span class="p">。</span> <span class="n">end_time</span> <span class="p">，</span> <span class="n">p</span> <span class="p">。</span> <span class="n">目的地</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">我</span> <span class="p">。</span> <span class="n">begin_time</span> <span class="k">ASC</span> <span class="p">;</span></code></div>            <p id="94ca746a">接下来，让我们执行此查询。为此，右键单击编辑器背景，然后在上下文菜单中选择“ <span class="control">执行</span> ”：</p>            <figure><img alt="py从pycharm执行sql" title="py从pycharm执行sql" src="../img/idea/2019.1/py_execute_sql_from_pycharm.png" id="d037cfeb" width="1011" height="862"></figure>            <p id="f0194bf5">（如果您没有看到<span class="control">Execute</span> ，请选择<span class="control">Attach Console</span>以让PyCharm了解您要执行查询的数据库）。</p>    <p id="b0bf950a">顺便说一句，您可以使查询工作速度提高30倍。要实现此显着加速，请将此索引添加到查询中：</p>    <div class="code-block" data-lang="SQL"><code class="code-block__wrapper"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">pings_recorded_at</span> <span class="k">ON</span> <span class="n">ping</span> <span class="p">（</span> <span class="n">recorded_at</span> <span class="p">）;</span></code></div>        </div><div class="chapter"><h2 id="graph" data-toc="Remote_Development_on_Raspberry_Pi#graph">绘制数据图</h2>            <p id="f2d87938">获取数据后，使用<a href="http://matplotlib.org/" data-bypass="yes" target="_blank"><span>matplotlib</span></a>生成一个折线图，其中包含每个bin的最小，平均和最大ping时间。Matplotlib可以使用<a href="http://matplotlib.org/devdocs/api/_as_gen/matplotlib.axes.Axes.plot_date.html" data-bypass="yes" target="_blank"><span>plot_date函数</span></a>轻松绘制基于时间的数据。</p>            <p id="38ec002c">当绘图准备就绪时，它将“保存”为<code class="code">.png</code>文件到StringIO对象，然后用于创建HTTP响应。通过将<code class="code">content_type</code>标头设置为<code class="code">image/png</code> ，可以排列所有内容。</p>            <p id="7f42a38e">所以最终的结果是：</p>            <figure><img alt="py raspberry pi ping时间图" title="py raspberry pi ping时间图" src="../img/idea/2019.1/py_raspberry_pi_ping_time_graph.png" id="f9c8402e" width="738" height="695"></figure>            <p id="baf007c9">如果要查看完整代码，请查看<a href="https://github.com/ErnstHaagsman/raspberryping/blob/master/analyze.py" data-bypass="yes" target="_blank"><span>GitHub上的analyze.py</span></a> 。</p>    </div>        <div class="chapter"><h2 id="summary" data-toc="Remote_Development_on_Raspberry_Pi#summary">摘要</h2>            <p id="4fa53505">恭喜您通过本教程！让我们重复在PyCharm的帮助下所做的事情：</p>            <ul class="list _ul"><li class="list__item" id="d3d0fed7"><a href="remote-development-on-raspberry-pi.html#creating-project">创建了一个项目</a></li><li class="list__item" id="e299c7ad"><p>在终端中， <a href="remote-development-on-raspberry-pi.html#setup-permission">设置权限并创建用户</a> 。</p></li><li class="list__item" id="c3f3e45a"><p><a href="remote-development-on-raspberry-pi.html#database">创建了一个数据库</a> 。</p></li><li class="list__item" id="d4060c7d"><p><a href="remote-development-on-raspberry-pi.html#run">捕获的ping</a> 。</p></li><li class="list__item" id="d23a6685"><p><a href="remote-development-on-raspberry-pi.html#store">在特殊数据库中存储ping</a> 。</p></li><li class="list__item" id="e70dbfa6"><p><a href="remote-development-on-raspberry-pi.html#flask">创建了Flask应用程序</a> </p></li><li class="list__item" id="2f6dd72e"><p><a href="remote-development-on-raspberry-pi.html#querying-data">查询数据</a> </p></li><li class="list__item" id="fc42a670"><p><a href="remote-development-on-raspberry-pi.html#graph">绘制数据</a> </p></li></ul>    </div><div class="last-modified" data-skip-index="skip">最后修改日期：2019年3月28日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="deployment-in-pycharm.html">教程：在PyCharm</a> <a class="navigation-links__next" href="python.html">Python中</a> <a class="navigation-links__prev" href="deployment-in-pycharm.html">部署</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="../app/v2/app.js"></script></body></html>