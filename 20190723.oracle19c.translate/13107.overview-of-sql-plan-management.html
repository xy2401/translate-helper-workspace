<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="SQL plan management is a preventative mechanism that enables the optimizer to automatically manage execution plans, ensuring that the database uses only known or verified plans."></meta>
      <meta name="description" content="SQL plan management is a preventative mechanism that enables the optimizer to automatically manage execution plans, ensuring that the database uses only known or verified plans."></meta>
      <title>SQL计划管理概述</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="SQL Tuning Guide"></meta>
      <meta property="og:description" content="SQL plan management is a preventative mechanism that enables the optimizer to automatically manage execution plans, ensuring that the database uses only known or verified plans."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="SQL Tuning Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="sql-tuning-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-01-31T14:57:08-08:00"></meta>
      <meta name="dcterms.title" content="SQL Tuning Guide"></meta>
      <meta name="dcterms.dateCopyrighted" content="2013, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96095-03"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="managing-sql-profiles.html" title="Previous" type="text/html"></link>
      <link rel="next" href="managing-sql-plan-baselines.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="TGSQL"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="managing-sql-profiles.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="managing-sql-plan-baselines.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">SQL调优指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="sql-controls.html" property="item" typeof="WebPage"><span property="name">SQL管理对象</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">SQL计划管理概述</li>
            </ol>
            <a id="GUID-F1C45056-F998-43E5-B362-83F88DA49E58" name="GUID-F1C45056-F998-43E5-B362-83F88DA49E58"></a><a id="TGSQL615"></a>
            
            <h2 id="TGSQL-GUID-F1C45056-F998-43E5-B362-83F88DA49E58" class="sect2"><span class="enumeration_chapter">27</span> SQL计划管理概述</h2>
         </header>
         <div class="ind">
            <div>
               <p><strong class="term">SQL计划管理</strong>是一种预防机制，使优化程序能够自动管理执行计划，确保数据库仅使用已知或已验证的计划。
               </p>
               <p>本章包含以下主题：</p>
            </div>
            <div>
               <ul class="ullinks">
                  <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-8A14C53D-8C2E-41BD-8B1F-AF32B4193418">关于SQL计划基准</a><br>SQL计划管理使用称为<strong class="term">SQL计划基准</strong>的机制，该<strong class="term">计划</strong>是一组允许优化程序用于SQL语句的已接受计划。
                  </li>
                  <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-C4749F43-89C3-4C27-9ED1-DA0D34A05586">SQL计划管理的目的</a><br>SQL计划管理可防止计划更改导致的性能下降。
                  </li>
                  <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-D09EA02C-12A8-439F-B06B-04C4D539BFCE">计划捕获</a><br><strong class="term">SQL计划捕获</strong>是指针对一组SQL语句捕获和存储有关SQL Management Base中的计划的相关信息的技术。
                  </li>
                  <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-67A76171-62CB-49A5-B5BD-CFFE26511E90">计划选择</a><br><span class="bold">SQL计划选择</span>是优化程序根据存储的计划历史记录检测计划更改的能力，以及使用SQL计划基准来选择计划以避免潜在的性能回归。
                  </li>
                  <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-3AB2B2F2-A7CD-404C-A36D-8CB5AD5A78B4">计划进化</a><br>通常，SQL <strong class="term">计划演变</strong>是优化程序验证新计划并将其添加到现有SQL计划基准的过程。
                  </li>
                  <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-169AFEFC-6DB2-483B-90D3-877B0FD2AC67">SQL计划管理的存储架构</a><br>SQL计划管理基础结构记录已解析语句的签名，以及已接受和未接受的计划。
                  </li>
               </ul>
               <div class="familylinks">
                  <div class="parentlink">
                     <p><strong>父主题：</strong> <a href="sql-controls.html#GUID-2889EBC8-1FAD-412F-9779-865028473607" title="SQL管理对象是一种稳定单个SQL语句的执行计划的功能。SQL配置文件和SQL计划基准是SQL管理对象。">SQL管理对象</a></p>
                  </div>
               </div>
            </div>
            
            <div class="sect2"><a id="GUID-8A14C53D-8C2E-41BD-8B1F-AF32B4193418" name="GUID-8A14C53D-8C2E-41BD-8B1F-AF32B4193418"></a><h3 id="TGSQL-GUID-8A14C53D-8C2E-41BD-8B1F-AF32B4193418" class="sect3"><span class="enumeration_section">27.1</span>关于SQL计划基准</h3>
               <div>
                  <p>SQL计划管理使用称为<strong class="term">SQL计划基准</strong>的机制，该<strong class="term">计划</strong>是一组允许优化程序用于SQL语句的已接受计划。
                  </p>
                  <p>在此上下文中，计划包括优化程序重现执行计划所需的所有与计划相关的信息（例如，SQL计划标识符，提示集，绑定值和优化程序环境）。基线实现为一组计划行和重现计划所需的轮廓。大纲是一组用于强制执行特定计划的优化程序提示。</p>
                  <p>SQL计划管理的主要组成部分如下：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>计划捕获</p>
                        <p>此组件存储有关一组SQL语句的计划的相关信息。</p>
                     </li>
                     <li>
                        <p>计划选择</p>
                        <p>此组件是优化程序根据存储的计划历史记录检测计划更改，以及使用SQL计划基准来选择适当的计划以避免潜在的性能回归。</p>
                     </li>
                     <li>
                        <p>计划进化</p>
                        <p>此组件是手动或自动向现有SQL计划基准添加新计划的过程。在典型的用例中，只有在验证计划执行良好后，数据库才会将计划接受到计划基准中。</p>
                     </li>
                  </ul>
               </div>
               <div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-F1C45056-F998-43E5-B362-83F88DA49E58" title="SQL计划管理是一种预防机制，使优化程序能够自动管理执行计划，确保数据库仅使用已知或已验证的计划。">SQL计划管理概述</a></p>
                     </div>
                  </div>
               </div>
               
            </div><a id="TGSQL617"></a><div class="props_rev_3"><a id="GUID-C4749F43-89C3-4C27-9ED1-DA0D34A05586" name="GUID-C4749F43-89C3-4C27-9ED1-DA0D34A05586"></a><h3 id="TGSQL-GUID-C4749F43-89C3-4C27-9ED1-DA0D34A05586" class="sect3"><span class="enumeration_section">27.2</span> SQL计划管理的目的</h3>
               <div>
                  <p>SQL计划管理可防止计划更改导致的性能下降。</p>
                  <p>第二个目标是通过仅验证和接受可提高性能的计划更改来优雅地适应新的优化程序统计信息或索引等更改。</p>
                  <div class="infoboxnote" id="GUID-C4749F43-89C3-4C27-9ED1-DA0D34A05586__GUID-87C898B3-4B7F-4FC0-8F09-F88670FE1118">
                     <p class="notep1">注意：</p>
                     <p>当事件导致不可逆转的执行计划更改（例如删除索引）时，SQL计划基准无法提供帮助。</p>
                  </div>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-F7111F80-83ED-42B2-B3DF-188A5C7427F4">SQL计划管理的好处</a><br>SQL计划管理可以改进或保留数据库升级以及系统和数据更改中的SQL性能。
                     </li>
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-27C85EB8-C4CE-40C5-B99C-F4ADDC09A617">SQL计划基准和SQL配置文件之间的差异</a><br>SQL配置文件和SQL计划基准都通过确保优化程序仅使用最佳计划来帮助提高SQL语句的性能。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-F1C45056-F998-43E5-B362-83F88DA49E58" title="SQL计划管理是一种预防机制，使优化程序能够自动管理执行计划，确保数据库仅使用已知或已验证的计划。">SQL计划管理概述</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL780"></a><div class="props_rev_3"><a id="GUID-F7111F80-83ED-42B2-B3DF-188A5C7427F4" name="GUID-F7111F80-83ED-42B2-B3DF-188A5C7427F4"></a><h4 id="TGSQL-GUID-F7111F80-83ED-42B2-B3DF-188A5C7427F4" class="sect4"><span class="enumeration_section">27.2.1</span> SQL计划管理的好处</h4>
                  <div>
                     <p>SQL计划管理可以改进或保留数据库升级以及系统和数据更改中的SQL性能。</p>
                     <p>具体而言，好处包括：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>安装新优化程序版本的数据库升级通常会导致一小部分SQL语句的计划更改。</p>
                           <p>大多数计划更改都会导致改进或无性能变化。但是，某些计划更改可能会导致性能下降。SQL计划基准可显着降低升级产生的潜在回归。</p>
                           <p>升级时，数据库仅使用计划基准中的计划。数据库将不在当前基线中的新计划放入保留区域，然后对其进行评估以确定它们是否使用的资源少于基准中的当前计划。如果计划表现更好，那么数据库会将它们提升到基线;否则，数据库不会提升它们。</p>
                        </li>
                        <li>
                           <p>正在进行的系统和数据更改可能会影响某些SQL语句的计划，从而可能导致性能下降。</p>
                           <p>SQL计划基准有助于最大限度地降低性能回归并稳定SQL性能。</p>
                        </li>
                        <li>
                           <p>新应用程序模块的部署将新的SQL语句引入数据库。</p>
                           <p>应用程序软件可以使用在标准测试配置中为新语句开发的适当SQL执行计划。如果系统配置与测试配置明显不同，则数据库可以随时间推移SQL计划基准以产生更好的性能。</p>
                        </li>
                     </ul>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-F7111F80-83ED-42B2-B3DF-188A5C7427F4__GUID-175522B5-5614-4790-8048-2D4AAA4CD717">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../upgrd/intro-to-upgrading-oracle-database.html#UPGRD001" target="_blank"><span class="italic">Oracle数据库升级指南</span></a> ，了解如何升级Oracle数据库</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-C4749F43-89C3-4C27-9ED1-DA0D34A05586" title="SQL计划管理可防止计划更改导致的性能下降。">SQL计划管理的目的</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL781"></a><div class="props_rev_3"><a id="GUID-27C85EB8-C4CE-40C5-B99C-F4ADDC09A617" name="GUID-27C85EB8-C4CE-40C5-B99C-F4ADDC09A617"></a><h4 id="TGSQL-GUID-27C85EB8-C4CE-40C5-B99C-F4ADDC09A617" class="sect4"><span class="enumeration_section">27.2.2</span> SQL计划基准和SQL配置文件之间的差异</h4>
                  <div>
                     <p>SQL配置文件和SQL计划基准都通过确保优化程序仅使用最佳计划来帮助提高SQL语句的性能。</p>
                     <p>配置文件和基线都是使用提示在内部实现的。但是，这些机制存在显着差异，包括：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>通常，SQL计划基准是主动的，而SQL配置文件是反应性的。</p>
                           <p>通常，您会<span class="italic">在</span>发生重大性能问题<span class="italic">之前</span>创建SQL计划基准。SQL计划基准阻止优化程序在将来使用次优计划。
                           </p>
                           <p>调用SQL Tuning Advisor时，数据库会创建SQL配置文件，通常只有<span class="italic">在</span> SQL语句显示高负载症状<span class="italic">后</span>才会执行此操作。SQL配置文件主要用于提供持续解决导致计划不理想的优化程序错误。因为SQL配置文件机制是被动的，所以当发生剧烈的数据库更改时，它无法保证稳定的性能。
                           </p>
                           <div class="figure" id="GUID-27C85EB8-C4CE-40C5-B99C-F4ADDC09A617__GUID-5FDDC457-26D0-453B-8991-E6066D88AAB3">
                              <p class="titleinfigure">图27-1 SQL计划基准和SQL配置文件</p><img src="img/tgsql_vm_028.png" alt="下面是图27-1的描述" title="下面是图27-1的描述" longdesc="img_text/tgsql_vm_028.html"><br><a href="img_text/tgsql_vm_028.html">“图27-1 SQL计划基准和SQL配置文件”的说明</a></div>
                           <!-- class="figure" -->
                        </li>
                        <li>
                           <p>SQL计划基准重现特定计划，而SQL配置文件则更正优化程序成本估算。</p>
                           <p>SQL计划基准是一组已接受的计划。每个计划都使用一组完整指定特定计划的大纲提示来实施。SQL配置文件也使用提示实现，但这些提示未指定任何特定计划。相反，提示在优化器估计中纠正导致次优计划的错误计算。例如，提示可以校正表的基数估计。</p>
                           <p>由于概要文件不会将优化程序约束到任何一个计划，因此SQL概要文件比SQL计划基准更灵活。例如，初始化参数和优化程序统计信息的更改使优化程序可以选择更好的计划。</p>
                        </li>
                     </ul>
                     <p>Oracle建议您使用SQL Tuning Advisor。通过这种方式，您可以遵循顾问程序为SQL配置文件和计划基准提出的建议，而不是尝试确定哪种机制最适合每个SQL语句。</p>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-27C85EB8-C4CE-40C5-B99C-F4ADDC09A617__GUID-0A19FE9C-0DDB-4830-9E95-DCA30532B662">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="influencing-the-optimizer.html#GUID-B198573A-C64B-4071-9CD8-738355A20DD7" title="提示嵌入在SQL注释中。">关于优化器提示</a> ”</span></p>
                           </li>
                           <li>
                              <p><span class="q">“ <a href="managing-sql-profiles.html#GUID-C7FE0936-63B8-46EF-A03E-7E59F704606E" title="如有必要，SQL Tuning Advisor建议使用SQL配置文件。您可以使用DBMS_SQLTUNE来实现，更改，删除和传输SQL配置文件。">管理SQL配置文件</a> ”</span></p>
                           </li>
                           <li>
                              <p><span class="q">“ <a href="sql-tuning-advisor.html#GUID-8E1A39CB-A491-4254-8B31-9B1DF7B52AA1" title="使用SQL Tuning Advisor获取有关提高高负载SQL语句性能的建议，并通过仅执行最佳计划来防止回归。">使用SQL Tuning Advisor分析SQL</a> ”</span></p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-C4749F43-89C3-4C27-9ED1-DA0D34A05586" title="SQL计划管理可防止计划更改导致的性能下降。">SQL计划管理的目的</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL784"></a><div class="props_rev_3"><a id="GUID-D09EA02C-12A8-439F-B06B-04C4D539BFCE" name="GUID-D09EA02C-12A8-439F-B06B-04C4D539BFCE"></a><h3 id="TGSQL-GUID-D09EA02C-12A8-439F-B06B-04C4D539BFCE" class="sect3"><span class="enumeration_section">27.3</span>计划捕获</h3>
               <div>
                  <p><strong class="term">SQL计划捕获</strong>是指针对一组SQL语句捕获和存储有关SQL Management Base中的计划的相关信息的技术。
                  </p>
                  <p>捕获计划意味着使SQL计划管理意识到此计划。您可以通过设置初始化参数将初始计划捕获配置为自动进行，也可以使用<code class="codeph">DBMS_SPM</code>程序包手动捕获计划。
                  </p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-5A1E6CF4-70E5-4C26-A67B-EFDBB93EC621">自动初始计划捕获</a><br>启用后，数据库会检查执行的SQL语句是否符合自动捕获的条件。
                     </li>
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-30DAEDBC-9CA6-49AB-ADEB-AC0CBA128D43">手动计划捕获</a><br>在SQL计划管理中， <strong class="term">手动计划捕获</strong>是指用户启动的现有计划批量加载到SQL计划基准中。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-F1C45056-F998-43E5-B362-83F88DA49E58" title="SQL计划管理是一种预防机制，使优化程序能够自动管理执行计划，确保数据库仅使用已知或已验证的计划。">SQL计划管理概述</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL623"></a><div class="props_rev_3"><a id="GUID-5A1E6CF4-70E5-4C26-A67B-EFDBB93EC621" name="GUID-5A1E6CF4-70E5-4C26-A67B-EFDBB93EC621"></a><h4 id="TGSQL-GUID-5A1E6CF4-70E5-4C26-A67B-EFDBB93EC621" class="sect4"><span class="enumeration_section">27.3.1</span>自动初始计划捕获</h4>
                  <div>
                     <p>启用后，数据库会检查执行的SQL语句是否符合自动捕获的条件。</p>
                     <p>您可以通过将<code class="codeph">OPTIMIZER_CAPTURE_SQL_PLAN_BASELINES</code>设置为<code class="codeph">true</code>来启用<strong class="term">自动初始计划捕获</strong> （默认值为<code class="codeph">false</code> ）。请注意，初始化参数<code class="codeph">OPTIMIZER_USE_SQL_PLAN_BASELINES</code>是独立的。例如，如果<code class="codeph">OPTIMIZER_CAPTURE_SQL_PLAN_BASELINES</code>为<code class="codeph">true</code> ，则无论<code class="codeph">OPTIMIZER_USE_SQL_PLAN_BASELINES</code>是<code class="codeph">true</code>还是<code class="codeph">false</code> ，数据库都会创建初始计划基准。
                     </p>
                     <p>本节包含以下主题：</p>
                  </div>
                  <div>
                     <ul class="ullinks">
                        <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-A3A528EB-CC02-426D-90F7-3AE9FCBDC201">自动初始计划捕获的资格</a><br>要有资格进行自动计划捕获，执行的语句必须是可重复的，并且任何捕获筛选器都不能排除它。
                        </li>
                        <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-09CD2E8A-902E-488F-8570-A5839643BF5E">计划匹配自动初始计划捕获</a><br>如果数据库执行可重复的SQL语句，并且此语句通过<code class="codeph">DBMS_SPM.CONFIGURE</code>过滤器，则数据库将尝试匹配SQL计划基准中的计划。
                        </li>
                     </ul>
                     <div class="infoboxnotealso" id="GUID-5A1E6CF4-70E5-4C26-A67B-EFDBB93EC621__GUID-702A2CBC-483F-4EF9-8594-4B9F839E3516">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="overview-of-sql-plan-management.html#GUID-67A76171-62CB-49A5-B5BD-CFFE26511E90" title="SQL计划选择是优化程序根据存储的计划历史记录检测计划更改的能力，以及使用SQL计划基准来选择计划以避免潜在的性能回归。">计划选择</a> ”</span></p>
                           </li>
                           <li>
                              <p><a href="../refrn/OPTIMIZER_USE_SQL_PLAN_BASELINES.html#REFRN10293" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">OPTIMIZER_USE_SQL_PLAN_BASELINES</code>初始化参数</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-D09EA02C-12A8-439F-B06B-04C4D539BFCE" title="SQL计划捕获是指针对一组SQL语句捕获和存储有关SQL Management Base中的计划的相关信息的技术。">计划捕获</a></p>
                        </div>
                     </div>
                  </div>
                  
                  <div class="sect4"><a id="GUID-A3A528EB-CC02-426D-90F7-3AE9FCBDC201" name="GUID-A3A528EB-CC02-426D-90F7-3AE9FCBDC201"></a><h5 id="TGSQL-GUID-A3A528EB-CC02-426D-90F7-3AE9FCBDC201" class="sect5"><span class="enumeration_section">27.3.1.1</span>自动初始计划捕获的资格</h5>
                     <div>
                        <p>要有资格进行自动计划捕获，执行的语句必须是可重复的，并且任何捕获筛选器都不能排除它。</p>
                        <p>默认情况下，数据库将所有可重复的SQL语句视为符合捕获条件，但以下情况除外：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="italic">未</span>指定<code class="codeph">AS SELECT</code>子句时的<code class="codeph">CREATE TABLE</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">DROP TABLE</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">插入 ...VALUES</code></p>
                           </li>
                        </ul>
                        <p>第一次检查资格是重复执行。如果语句执行的次数少于两次，则数据库不认为它符合SQL计划基准的条件。如果语句至少执行两次，那么根据定义它是可重复的，因此数据库认为它有资格进行进一步检查。</p>
                        <div class="infoboxnote" id="GUID-A3A528EB-CC02-426D-90F7-3AE9FCBDC201__GUID-27EA6C35-0D01-4CFF-B492-B6E002D44388">
                           <p class="notep1">注意：</p>
                           <p>SQL计划管理不保护使用<code class="codeph">EXPLAIN PLAN</code>解释但尚未执行的语句。
                           </p>
                        </div>
                        <p>对于可重复的语句， <code class="codeph">DBMS_SPM.CONFIGURE</code>过程使您可以创建<a href="glossary.html#GUID-B07EE39D-D28D-4BDE-BF79-356DDB5306BD"><span class="xrefglossterm">自动捕获筛选器</span></a> 。因此，您只能捕获所需的语句，并排除非关键语句，从而节省<code class="codeph">SYSAUX</code>表空间中的空间。非关键查询通常具有以下特征：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>没有经常执行到重要</p>
                           </li>
                           <li>
                              <p>不是资源密集型的</p>
                           </li>
                           <li>
                              <p>不够复杂，无法从SQL计划管理中受益</p>
                           </li>
                        </ul>
                        <p>对于指定的参数，过滤器包括（ <code class="codeph">allow=&gt;TRUE</code> ）或排除（ <code class="codeph">allow=&gt;FALSE</code> ）具有指定值的语句的计划。要获得捕获资格，任何过滤器都不得<span class="italic">排除</span>可重复的声明。<code class="codeph">DBMS_SPM.CONFIGURE</code>过程支持SQL文本的过滤器，解析模式名称，模块和操作。
                        </p>
                        <p>任何参数的空值都会删除过滤器。通过将<code class="codeph">parameter_value=&gt;'%'</code>与<code class="codeph">allow=FALSE</code>结合使用，可以筛选出参数的所有值，然后创建单独的筛选器以仅包含指定的值。<code class="codeph">DBA_SQL_MANAGEMENT_CONFIG</code>视图显示当前过滤器。
                        </p>
                     </div>
                     <div>
                        <div class="infoboxnotealso" id="GUID-A3A528EB-CC02-426D-90F7-3AE9FCBDC201__GUID-1988DD3F-9D2D-4BC8-8F8B-18AC0B989513">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><span class="q">“ <a href="managing-sql-plan-baselines.html#GUID-82EFB280-8868-47E1-8360-6A9CA995BD56" title="如果OPTIMIZER_CAPTURE_SQL_PLAN_BASELINES = true，则可以使用DBMS_SPM.CONFIGURE过程为可重复语句创建自动捕获筛选器。">配置自动计划捕获的过滤器</a> ”</span></p>
                              </li>
                              <li>
                                 <p><a href="../arpls/DBMS_SPM.html#ARPLS-GUID-D855D4B9-D071-4BB2-A554-38479867DE76" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解有关<code class="codeph">DBMS_SPM.CONFIGURE</code>过程的更多信息</p>
                              </li>
                              <li>
                                 <p><a href="../refrn/DBA_SQL_MANAGEMENT_CONFIG.html#REFRN-GUID-4E9C3D2A-93B8-49C5-9169-C54A9EB7431C" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解有关<code class="codeph">DBA_SQL_MANAGEMENT_CONFIG</code>视图的更多信息</p>
                              </li>
                           </ul>
                        </div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-5A1E6CF4-70E5-4C26-A67B-EFDBB93EC621" title="启用后，数据库会检查执行的SQL语句是否符合自动捕获的条件。">自动初始计划捕获</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
                  <div class="sect4"><a id="GUID-09CD2E8A-902E-488F-8570-A5839643BF5E" name="GUID-09CD2E8A-902E-488F-8570-A5839643BF5E"></a><h5 id="TGSQL-GUID-09CD2E8A-902E-488F-8570-A5839643BF5E" class="sect5"><span class="enumeration_section">27.3.1.2</span>自动初始计划捕获的计划匹配</h5>
                     <div>
                        <p>如果数据库执行可重复的SQL语句，并且此语句通过<code class="codeph">DBMS_SPM.CONFIGURE</code>过滤器，则数据库将尝试匹配SQL计划基准中的计划。
                        </p>
                        <p>对于自动初始计划捕获，计划匹配算法如下：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>如果一个SQL计划基线<span class="italic">不</span>存在，则优化程序的语句计划的历史和SQL计划基准，标志着该语句的初步计划所接受并将其添加到SQL计划基准。
                              </p>
                           </li>
                           <li>
                              <p>如果存在SQL计划基准，则优化程序行为取决于在分析时派生的基于成本的计划：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果此计划与SQL计划基准中的计划<span class="italic">不</span>匹配，则优化程序会将新计划标记为未接受，并将其添加到SQL计划基准。
                                    </p>
                                 </li>
                                 <li>
                                    <p>如果这个计划<span class="italic">不</span>匹配的SQL计划基准计划，再没有什么被添加到SQL计划基准。
                                    </p>
                                 </li>
                              </ul>
                           </li>
                        </ul>
                     </div>
                     <div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-5A1E6CF4-70E5-4C26-A67B-EFDBB93EC621" title="启用后，数据库会检查执行的SQL语句是否符合自动捕获的条件。">自动初始计划捕获</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
               </div><a id="TGSQL624"></a><div class="props_rev_3"><a id="GUID-30DAEDBC-9CA6-49AB-ADEB-AC0CBA128D43" name="GUID-30DAEDBC-9CA6-49AB-ADEB-AC0CBA128D43"></a><h4 id="TGSQL-GUID-30DAEDBC-9CA6-49AB-ADEB-AC0CBA128D43" class="sect4"><span class="enumeration_section">27.3.2</span>手动计划捕获</h4>
                  <div>
                     <p>在SQL计划管理中， <strong class="term">手动计划捕获</strong>是指用户启动的现有计划批量加载到SQL计划基准中。
                     </p>
                     <p>使用Cloud Control或PL / SQL从<a href="glossary.html#GUID-FFE0E053-D523-4035-AC92-7121EF756610"><span class="xrefglossterm">AWR</span></a> ， <a href="glossary.html#GUID-52FB0AE5-7346-44E5-BE92-3C09385B1DDC"><span class="xrefglossterm">SQL调优集（STS）</span></a> ， <a href="glossary.html#GUID-577D0DD3-FB98-4B1B-BCFB-95313BB35C01"><span class="xrefglossterm">共享SQL区域</span></a> ，临时表或<a href="glossary.html#GUID-A1BD6A75-73B9-4F68-8FD6-A89057E95ADF"><span class="xrefglossterm">存储的大纲</span></a>加载SQL语句的执行计划。
                     </p>
                     <div class="figure" id="GUID-30DAEDBC-9CA6-49AB-ADEB-AC0CBA128D43__GUID-8906F5AC-F4C7-4658-8C97-EAC577D1235E">
                        <p class="titleinfigure">图27-2将计划加载到SQL计划基准中</p><img src="img/tgsql_vm_007.png" alt="下面是图27-2的描述" title="下面是图27-2的描述" longdesc="img_text/tgsql_vm_007.html"><br><a href="img_text/tgsql_vm_007.html">“图27-2将计划加载到SQL计划基准”中的描述</a></div>
                     <!-- class="figure" -->
                     <p>加载行为取决于批量加载中表示的每个语句是否存在SQL计划基准：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>如果该语句的基线不存在，则数据库执行以下操作：</p>
                           <ol>
                              <li>
                                 <p>为语句创建计划历史记录和计划基准</p>
                              </li>
                              <li>
                                 <p>将声明的初始计划标记为已接受</p>
                              </li>
                              <li>
                                 <p>将计划添加到新基准</p>
                              </li>
                           </ol>
                        </li>
                        <li>
                           <p>如果存在该语句的基线，则数据库将执行以下操作：</p>
                           <ol>
                              <li>
                                 <p>将已加载的计划标记为已接受</p>
                              </li>
                              <li>
                                 <p>将计划添加到语句的计划基准， <span class="italic">而不</span>验证计划的性能</p>
                              </li>
                           </ol>
                        </li>
                     </ul>
                     <p>手动加载的计划始终被标记为已接受，因为优化程序假定管理员手动加载的任何计划都具有可接受的性能。您可以通过在<code class="codeph">DBMS_SPM.LOAD_PLANS_FROM_ <span class="codeinlineitalic">%</span></code>函数中将<code class="codeph">enabled</code>参数设置为<code class="codeph">NO</code>来加载计划而不启用它们。
                     </p>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-30DAEDBC-9CA6-49AB-ADEB-AC0CBA128D43__GUID-FE1F2FF2-A733-438C-B80F-621BA916D30D">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../arpls/DBMS_SPM.html#GUID-74594B3C-6D36-4008-8E2E-20EEB278D0BB" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解有关<code class="codeph">DBMS_SPM.LOAD_PLANS_FROM_ <span class="codeinlineitalic">%</span></code>函数的更多信息</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-D09EA02C-12A8-439F-B06B-04C4D539BFCE" title="SQL计划捕获是指针对一组SQL语句捕获和存储有关SQL Management Base中的计划的相关信息的技术。">计划捕获</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL625"></a><div class="props_rev_3"><a id="GUID-67A76171-62CB-49A5-B5BD-CFFE26511E90" name="GUID-67A76171-62CB-49A5-B5BD-CFFE26511E90"></a><h3 id="TGSQL-GUID-67A76171-62CB-49A5-B5BD-CFFE26511E90" class="sect3"><span class="enumeration_section">27.4</span>计划选择</h3>
               <div>
                  <p><span class="bold">SQL计划选择</span>是优化程序根据存储的计划历史记录检测计划更改的能力，以及使用SQL计划基准来选择计划以避免潜在的性能回归。
                  </p>
                  <p>当数据库执行SQL语句的<a href="glossary.html#GUID-AB764C9E-2F03-49A9-BF8B-36A9FBD03BCE"><span class="xrefglossterm">硬解析</span></a>时，优化程序会生成最佳成本计划。默认情况下，优化程序然后尝试在语句的SQL计划基准中查找匹配计划。如果不存在计划基准，则数据库将运行具有最佳成本计划的语句。
                  </p>
                  <p>如果存在计划基准，则优化程序行为取决于新生成的计划是否在计划基准中：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>如果新计划在基准中，则数据库使用找到的计划执行语句。</p>
                     </li>
                     <li>
                        <p>如果新计划<span class="italic">不在</span>基准中，则优化程序会将新生成的计划标记为未接受，并将其添加到计划历史记录中。优化程序行为取决于计划基准的内容：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>如果计划基准中存在固定计划，则优化程序将使用具有最低成本的固定计划。</p>
                           </li>
                           <li>
                              <p>如果计划基准中不存在固定计划，则优化程序将使用具有最低成本的基准计划。</p>
                           </li>
                           <li>
                              <p>如果计划基准中不存在可重现的计划，如果基准中的每个计划都引用了已删除的索引，则可能会发生这种情况，然后优化程序使用新生成的基于成本的计划。</p>
                           </li>
                        </ul>
                     </li>
                  </ul>
                  <div class="figure" id="GUID-67A76171-62CB-49A5-B5BD-CFFE26511E90__GUID-FFFD0C0C-A746-401F-A4F4-42E194C95745">
                     <p class="titleinfigure">图27-3 SQL计划选择的决策树</p><img src="img/tgsql_vm_003.png" alt="下面是图27-3的描述" title="下面是图27-3的描述" longdesc="img_text/tgsql_vm_003.html"><br><a href="img_text/tgsql_vm_003.html">“图27-3 SQL计划选择的决策树”的描述</a></div>
                  <!-- class="figure" -->
               </div>
               <div>
                  <div class="infoboxnotealso" id="GUID-67A76171-62CB-49A5-B5BD-CFFE26511E90__GUID-2341897B-8CE7-4E1A-9507-985B3F8F531C">
                     <p class="notep1">也可以看看：</p>
                     <p><span class="q">“ <a href="overview-of-sql-plan-management.html#GUID-B51FBAA9-EE95-4F19-AD4B-F5F4C2910688" title="固定计划是标记为首选的已接受计划，因此优化程序仅考虑基准中的固定计划。固定计划会影响优化程序的计划选择过程。">固定计划</a> ”</span></p>
                  </div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-F1C45056-F998-43E5-B362-83F88DA49E58" title="SQL计划管理是一种预防机制，使优化程序能够自动管理执行计划，确保数据库仅使用已知或已验证的计划。">SQL计划管理概述</a></p>
                     </div>
                  </div>
               </div>
               
            </div><a id="TGSQL626"></a><div class="props_rev_3"><a id="GUID-3AB2B2F2-A7CD-404C-A36D-8CB5AD5A78B4" name="GUID-3AB2B2F2-A7CD-404C-A36D-8CB5AD5A78B4"></a><h3 id="TGSQL-GUID-3AB2B2F2-A7CD-404C-A36D-8CB5AD5A78B4" class="sect3"><span class="enumeration_section">27.5</span>计划进化</h3>
               <div>
                  <p>通常，SQL <strong class="term">计划演变</strong>是优化程序验证新计划并将其添加到现有SQL计划基准的过程。
                  </p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-FD80224B-A2DD-4C9D-A35B-879A55BA6A45">计划演变的目的</a><br>通常，语句的SQL计划基准以一个已接受的计划开始。
                     </li>
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-E24924CE-81F3-41DF-8469-9BBA8C386E47">计划进化如何运作</a><br>计划演变涉及验证和添加计划。
                     </li>
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-55CF99F0-41E0-4160-8789-422689C74AD8">Plan Evolution的PL / SQL子程序</a><br><code class="codeph">DBMS_SPM</code>包提供了计划演变的过程和函数。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-F1C45056-F998-43E5-B362-83F88DA49E58" title="SQL计划管理是一种预防机制，使优化程序能够自动管理执行计划，确保数据库仅使用已知或已验证的计划。">SQL计划管理概述</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL94644"></a><div class="props_rev_3"><a id="GUID-FD80224B-A2DD-4C9D-A35B-879A55BA6A45" name="GUID-FD80224B-A2DD-4C9D-A35B-879A55BA6A45"></a><h4 id="TGSQL-GUID-FD80224B-A2DD-4C9D-A35B-879A55BA6A45" class="sect4"><span class="enumeration_section">27.5.1</span>计划演变的目的</h4>
                  <div>
                     <p>通常，语句的SQL计划基准以一个已接受的计划开始。</p>
                     <p>但是，某些SQL语句在不同条件下使用不同计划执行时表现良好。例如，具有绑定变量的SQL语句可能具有多个最佳计划，这些绑定变量的值导致不同的选择性。创建物化视图或索引或重新分区表可能会使当前计划比其他计划更昂贵。</p>
                     <p>如果从未将新计划添加到SQL计划基准中，则某些SQL语句的性能可能会降低。因此，有时需要将新接受的计划发展为SQL计划基准。计划演变通过在将新计划包含在SQL计划基准之前验证新计划的性能来防止性能回归。</p>
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-3AB2B2F2-A7CD-404C-A36D-8CB5AD5A78B4" title="通常，SQL计划演变是优化程序验证新计划并将其添加到现有SQL计划基准的过程。">计划演变</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
               <div class="sect3"><a id="GUID-E24924CE-81F3-41DF-8469-9BBA8C386E47" name="GUID-E24924CE-81F3-41DF-8469-9BBA8C386E47"></a><h4 id="TGSQL-GUID-E24924CE-81F3-41DF-8469-9BBA8C386E47" class="sect4"><span class="enumeration_section">27.5.2</span>计划进化如何运作</h4>
                  <div>
                     <p>计划演变涉及验证和添加计划。</p>
                     <p>具体而言，计划发展包括以下不同步骤：</p>
                     <ol>
                        <li>
                           <p>验证</p>
                           <p>优化程序确保未接受的计划至少与SQL计划基准中的已接受计划执行（称为<a href="glossary.html#GUID-B1FE5553-56FF-440B-B37A-D024CFA679A9"><span class="xrefglossterm">计划验证</span></a> ）。
                           </p>
                        </li>
                        <li>
                           <p>添加</p>
                           <p>在数据库证明未接受的计划与已接受的计划一致之后，数据库会将计划添加到基准。</p>
                        </li>
                     </ol>
                     <p>在计划演变的标准情况下，优化程序按顺序执行上述步骤，以便SQL计划管理无法使用新计划，直到优化程序验证相对于SQL计划基准的计划性能。但是，您可以将SQL计划管理配置为执行一个步骤而不执行另一个步骤。下图显示了计划演变的可能路径。</p>
                     <div class="figure" id="GUID-E24924CE-81F3-41DF-8469-9BBA8C386E47__GUID-D69F3046-5A51-47E4-BDD1-086E2AB4821F">
                        <p class="titleinfigure">图27-4计划演变</p><img src="img/tgsql_vm_023.png" alt="下面是图27-4的描述" title="下面是图27-4的描述" longdesc="img_text/tgsql_vm_023.html"><br><a href="img_text/tgsql_vm_023.html">“图27-4计划演变”的描述</a></div>
                     <!-- class="figure" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-3AB2B2F2-A7CD-404C-A36D-8CB5AD5A78B4" title="通常，SQL计划演变是优化程序验证新计划并将其添加到现有SQL计划基准的过程。">计划演变</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL94645"></a><div class="props_rev_3"><a id="GUID-55CF99F0-41E0-4160-8789-422689C74AD8" name="GUID-55CF99F0-41E0-4160-8789-422689C74AD8"></a><h4 id="TGSQL-GUID-55CF99F0-41E0-4160-8789-422689C74AD8" class="sect4"><span class="enumeration_section">27.5.3</span>计划进化的PL / SQL子程序</h4>
                  <div>
                     <p><code class="codeph">DBMS_SPM</code>包提供了计划演变的过程和函数。
                     </p>
                     <p>这些子程序使用任务基础结构。例如， <code class="codeph">CREATE_EVOLVE_TASK</code>创建一个演化任务，而<code class="codeph">EXECUTE_EVOLVE_TASK</code>执行它。所有任务演化子程序的名称都包含字符串<code class="codeph">EVOLVE_TASK</code> 。
                     </p>
                     <p>根据需要使用evolve过程，或将子程序配置为自动运行。自动维护任务<code class="codeph">SYS_AUTO_SPM_EVOLVE_TASK</code>每天在计划的维护窗口中执行。该任务自动执行以下操作：</p>
                     <ol>
                        <li>
                           <p>选择和排名未接受的计划以进行验证</p>
                        </li>
                        <li>
                           <p>如果满足性能阈值，则接受每个计划</p>
                        </li>
                     </ol>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-55CF99F0-41E0-4160-8789-422689C74AD8__GUID-846EE365-DA79-4BD8-A963-4B10107F382C">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="managing-sql-plan-baselines.html#GUID-A94CFA49-910A-4237-A7BB-39BFA94E227E" title="SPM Evolve Advisor是一个SQL顾问程序，可以发展最近添加到SQL计划基准的计划。顾问通过消除手动操作的要求简化了计划的发展。">管理SPM Evolve Advisor任务</a> ”</span></p>
                           </li>
                           <li>
                              <p><span class="q">“ <a href="managing-sql-plan-baselines.html#GUID-19E6FFB0-BC7A-4CDB-AE36-6D67C15C7332" title="您可以使用PL / SQL或Cloud Control手动发展未接受的计划，以确定它是否比计划基准中当前的任何计划表现更好。">手动制定SQL计划基准</a> ”</span></p>
                           </li>
                           <li>
                              <p><a href="../arpls/DBMS_SPM.html#ARPLS150" target="_blank"><span class="italic">Oracle Database PL / SQL包和类型参考，</span></a>以了解<code class="codeph">DBMS_SPM</code>包</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-3AB2B2F2-A7CD-404C-A36D-8CB5AD5A78B4" title="通常，SQL计划演变是优化程序验证新计划并将其添加到现有SQL计划基准的过程。">计划演变</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL630"></a><div class="props_rev_3"><a id="GUID-169AFEFC-6DB2-483B-90D3-877B0FD2AC67" name="GUID-169AFEFC-6DB2-483B-90D3-877B0FD2AC67"></a><h3 id="TGSQL-GUID-169AFEFC-6DB2-483B-90D3-877B0FD2AC67" class="sect3"><span class="enumeration_section">27.6</span> SQL计划管理的存储体系结构</h3>
               <div>
                  <p>SQL计划管理基础结构记录已解析语句的签名，以及已接受和未接受的计划。</p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-EA548FAC-B350-4F31-96E9-8541AA8AC267">SQL管理基础</a><br><span class="bold">SQL管理库（SMB）</span>是数据字典中的逻辑存储库。
                     </li>
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-AEF0CAF0-49A5-4EDB-9D91-6E033912593B">SQL语句日志</a><br>启用自动SQL计划捕获时， <strong class="term">SQL语句日志</strong>包含优化程序随时间评估的语句签名。
                     </li>
                     <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-BC65F4D4-1CEE-4014-8188-C849A0D9251A">SQL计划历史记录</a><br><strong class="term">SQL计划历史记录</strong>是捕获的SQL执行计划的集合。历史记录包含SQL计划基准和未接受的计划。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-F1C45056-F998-43E5-B362-83F88DA49E58" title="SQL计划管理是一种预防机制，使优化程序能够自动管理执行计划，确保数据库仅使用已知或已验证的计划。">SQL计划管理概述</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL631"></a><div class="props_rev_3"><a id="GUID-EA548FAC-B350-4F31-96E9-8541AA8AC267" name="GUID-EA548FAC-B350-4F31-96E9-8541AA8AC267"></a><h4 id="TGSQL-GUID-EA548FAC-B350-4F31-96E9-8541AA8AC267" class="sect4"><span class="enumeration_section">27.6.1</span> SQL管理库</h4>
                  <div>
                     <p><span class="bold">SQL管理库（SMB）</span>是数据字典中的逻辑存储库。
                     </p>
                     <p>SMB包含以下内容：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>SQL语句日志，仅包含SQL ID</p>
                        </li>
                        <li>
                           <p>SQL计划历史记录，包括SQL计划基准</p>
                        </li>
                        <li>
                           <p>SQL配置文件</p>
                        </li>
                        <li>
                           <p>SQL补丁</p>
                        </li>
                     </ul>
                     <p>SMB存储优化程序可用于维护或提高SQL性能的信息。</p>
                     <p>SMB驻留在<code class="codeph">SYSAUX</code>表空间中，并使用自动段空间管理。由于SMB完全位于<code class="codeph">SYSAUX</code>表空间内，因此当此表空间不可用时，数据库不使用SQL计划管理和SQL调整功能。
                     </p>
                     <div class="figure" id="GUID-EA548FAC-B350-4F31-96E9-8541AA8AC267__GUID-432F6017-93B1-4911-9548-4D4678FAD60F">
                        <p class="titleinfigure">图27-5 SMB体系结构</p><img src="img/tgsql_vm_002.png" alt="下面是图27-5的描述" title="下面是图27-5的描述" longdesc="img_text/tgsql_vm_002.html"><br><a href="img_text/tgsql_vm_002.html">“图27-5 SMB架构”的说明</a></div>
                     <!-- class="figure" -->
                     <div class="infoboxnote" id="GUID-EA548FAC-B350-4F31-96E9-8541AA8AC267__GUID-EF62AAA7-B016-4AEA-99CF-D51450C324E3">
                        <p class="notep1">注意：</p>
                        <p>将SMB与可插拔数据库一起使用时，数据可见性和权限要求可能会有所不同。有关可管理性功能如何在容器数据库（CDB）中工作的表，请参见“ <a href="../multi/administering-a-cdb-with-sql-plus.html#ADMIN13885" target="_blank"><span><cite>Oracle数据库管理员指南”</cite></span></a> 。
                        </p>
                     </div>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-EA548FAC-B350-4F31-96E9-8541AA8AC267__GUID-91DF20B2-AB42-4B8D-BF4D-1ACD2C081E9D">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../admin/creating-and-configuring-an-oracle-database.html#ADMIN00203" target="_blank"><span><cite>Oracle数据库管理员指南</cite></span></a> ，了解<code class="codeph">SYSAUX</code>表空间</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-169AFEFC-6DB2-483B-90D3-877B0FD2AC67" title="SQL计划管理基础结构记录已解析语句的签名，以及已接受和未接受的计划。">SQL计划管理的存储体系结构</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL633"></a><a id="TGSQL632"></a><div class="props_rev_3"><a id="GUID-AEF0CAF0-49A5-4EDB-9D91-6E033912593B" name="GUID-AEF0CAF0-49A5-4EDB-9D91-6E033912593B"></a><h4 id="TGSQL-GUID-AEF0CAF0-49A5-4EDB-9D91-6E033912593B" class="sect4"><span class="enumeration_section">27.6.2</span> SQL语句日志</h4>
                  <div>
                     <p>启用自动SQL计划捕获时， <strong class="term">SQL语句日志</strong>包含优化程序随时间评估的语句签名。
                     </p>
                     <p><a href="glossary.html#GUID-160EB64E-536F-4313-B7B0-191C2719CF1F"><span class="xrefglossterm">SQL签名</span></a>是使用SQL语句文本计算的数字哈希值，该语句已针对不区分大小写和空格进行了规范化。当优化器解析语句时，它会创建签名。
                     </p>
                     <p>在自动捕获期间，数据库将此签名与SQL语句日志（ <code class="codeph">SQLLOG$</code> ）匹配，以确定之前是否已观察到签名。如果没有，则数据库将签名添加到日志中。如果签名已在日志中，则数据库确认该语句是<a href="glossary.html#GUID-FB73DB1A-CF56-4A19-8AFD-E5C2E0C5BDDB"><span class="xrefglossterm">可重复的SQL语句</span></a> 。
                     </p>
                     <div class="infoboxnote" id="GUID-AEF0CAF0-49A5-4EDB-9D91-6E033912593B__GUID-CC01A03D-5249-44C0-A592-2BF6CDE288CF">
                        <p class="notep1">注意：</p>
                        <p>如果过滤器排除了语句，则其签名也会从日志中排除。</p>
                     </div>
                     <div class="example" id="GUID-AEF0CAF0-49A5-4EDB-9D91-6E033912593B__GUID-4999E3B0-1798-46F3-A509-F4CF74B5D63C">
                        <p class="titleinexample">示例27-1记录SQL语句</p>
                        <p>此示例说明了数据库如何跟踪语句日志中的语句，并自动为可重复语句创建基线。语句日志的初始查询显示没有跟踪的SQL语句。在查询了<code class="codeph">hr.jobs</code>的<code class="codeph">AD_PRES</code> ，日志显示了一个跟踪语句。
                        </p><pre class="pre codeblock"><code>SQL&gt; ALTER SYSTEM SET OPTIMIZER_CAPTURE_SQL_PLAN_BASELINES = true;系统改变了。SQL&gt; SELECT * FROM SQLLOG $;没有选择行SQL&gt; SELECT job_title FROM hr.jobs WHERE job_id ='AD_PRES'; JOB_TITLE ----------------------------------- President SQL&gt; SELECT * FROM SQLLOG $; SIGNATURE BATCH＃---------- ---------- 1.8096E + 19 1</code></pre><p>现在会话执行不同的<code class="codeph">jobs</code>查询。该日志显示两个跟踪语句：</p><pre class="pre codeblock"><code>SQL&gt; SELECT job_title FROM hr.jobs WHERE job_id ='PR_REP'; JOB_TITLE -----------------------------------公共关系代表SQL&gt; SELECT * FROM SQLLOG $; SIGNATURE BATCH＃---------- ---------- 1.7971E + 19 1 1.8096E + 19 1</code></pre><p><code class="codeph">DBA_SQL_PLAN_BASELINES</code>的查询显示两个语句都没有基线，因为这两个语句都不可重复：</p><pre class="pre codeblock"><code>SQL&gt; SELECT SQL_HANDLE，SQL_TEXT 2 FROM DBA_SQL_PLAN_BASELINES 3 WHERE SQL_TEXT LIKE'SELECT job_title％';没有选择任何行</code></pre><p>会话第二次执行<code class="codeph">job_id='PR_REP'</code>的查询。由于此语句现在是可重复的，并且由于启用了自动SQL计划捕获，因此数据库会为此语句创建计划基准。对<code class="codeph">job_id='AD_PRES'</code>的查询仅执行了一次，因此不存在计划基准。
                        </p><pre class="pre codeblock"><code>SQL&gt; SELECT job_title FROM hr.jobs WHERE job_id ='PR_REP'; JOB_TITLE -----------------------------------公共关系代表SQL&gt; SELECT SQL_HANDLE，SQL_TEXT 2 FROM DBA_SQL_PLAN_BASELINES 3 WHERE SQL_TEXT LIKE'SELECT job_title％'; SQL_HANDLE SQL_TEXT -------------------- -------------------- SQL_f9676a330f972dd5 SELECT job_title FRO M hr.jobs WHERE job_ id ='PR_REP'</code></pre></div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-AEF0CAF0-49A5-4EDB-9D91-6E033912593B__GUID-E2E86269-EB9F-4E8E-8525-C34D6ABD7A10">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="overview-of-sql-plan-management.html#GUID-5A1E6CF4-70E5-4C26-A67B-EFDBB93EC621" title="启用后，数据库会检查执行的SQL语句是否符合自动捕获的条件。">自动初始计划捕获</a> ”</span></p>
                           </li>
                           <li>
                              <p><a href="../refrn/DBA_SQL_PLAN_BASELINES.html#REFRN23714" target="_blank"><span class="italic">Oracle Database Reference</span></a>了解<code class="codeph">DBA_SQL_PLAN_BASELINES</code></p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-169AFEFC-6DB2-483B-90D3-877B0FD2AC67" title="SQL计划管理基础结构记录已解析语句的签名，以及已接受和未接受的计划。">SQL计划管理的存储体系结构</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL634"></a><div class="props_rev_3"><a id="GUID-BC65F4D4-1CEE-4014-8188-C849A0D9251A" name="GUID-BC65F4D4-1CEE-4014-8188-C849A0D9251A"></a><h4 id="TGSQL-GUID-BC65F4D4-1CEE-4014-8188-C849A0D9251A" class="sect4"><span class="enumeration_section">27.6.3</span> SQL计划历史记录</h4>
                  <div>
                     <p><strong class="term">SQL计划历史记录</strong>是捕获的SQL执行计划的集合。历史记录包含SQL计划基准和未接受的计划。
                     </p>
                     <p>在SQL计划管理中，数据库检测现有SQL计划基准的新SQL执行计划，并在历史记录中记录新计划，以便可以进化（验证）它们。Evolution由数据库自动启动或由DBA手动启动。</p>
                     <p>从<span>Oracle Database 12c开始</span> ，SMB将所有SQL语句的执行计划存储在SQL计划历史记录中。<code class="codeph">DBMS_XPLAN.DISPLAY_SQL_PLAN_BASELINE</code>函数从SMB获取并显示计划。对于在<span>Oracle Database 12c</span>之前创建的计划，该函数必须编译SQL语句并生成计划，因为SMB不存储它。
                     </p>
                     <p>本节包含以下主题：</p>
                  </div>
                  <div>
                     <ul class="ullinks">
                        <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-7ACCE857-4A76-4459-862D-50969C74D56B">启用计划</a><br>已<span class="bold">启用的计划</span>是可供优化程序使用的计划。
                        </li>
                        <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-AABE25C1-55BD-40F4-AB79-28B4373D545D">接受的计划</a><br><span class="bold">接受的计划</span>是SQL语句的SQL计划基准中的计划，因此可供优化程序使用。接受的计划包含一组提示，计划哈希值和其他与计划相关的信息。
                        </li>
                        <li class="ulchildlink"><a href="overview-of-sql-plan-management.html#GUID-B51FBAA9-EE95-4F19-AD4B-F5F4C2910688">固定计划</a><br><span class="bold">固定计划</span>是标记为首选的已接受计划，因此优化程序仅考虑基准中的固定计划。固定计划会影响优化程序的计划选择过程。
                        </li>
                     </ul>
                     <div class="infoboxnotealso" id="GUID-BC65F4D4-1CEE-4014-8188-C849A0D9251A__GUID-3178121F-8E7C-4B67-876B-6E444A163B38">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="managing-sql-plan-baselines.html#GUID-582BC3FB-2F52-4190-B807-16B79346B776" title="要查看存储在特定语句的SQL计划基准中的计划，请使用DBMS_XPLAN.DISPLAY_SQL_PLAN_BASELINE函数。此功能使用存储在计划历史记录中的计划信息来显示计划。">在SQL计划基准中显示计划</a> ”</span></p>
                           </li>
                           <li>
                              <p><a href="../arpls/DBMS_XPLAN.html#ARPLS70138" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">DBMS_XPLAN.DISPLAY_SQL_PLAN_BASELINE</code>函数</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-169AFEFC-6DB2-483B-90D3-877B0FD2AC67" title="SQL计划管理基础结构记录已解析语句的签名，以及已接受和未接受的计划。">SQL计划管理的存储体系结构</a></p>
                        </div>
                     </div>
                  </div>
                  <a id="TGSQL635"></a><div class="props_rev_3"><a id="GUID-7ACCE857-4A76-4459-862D-50969C74D56B" name="GUID-7ACCE857-4A76-4459-862D-50969C74D56B"></a><h5 id="TGSQL-GUID-7ACCE857-4A76-4459-862D-50969C74D56B" class="sect5"><span class="enumeration_section">27.6.3.1</span>启用计划</h5>
                     <div>
                        <p>已<span class="bold">启用的计划</span>是可供优化程序使用的计划。
                        </p>
                        <p>当计划加载并将<code class="codeph">enabled</code>参数设置为<code class="codeph">YES</code> （缺省值）时，数据库会自动将生成的SQL计划基准标记为已启用，即使它们未被接受也是如此。您可以手动将已启用的计划更改为已<a href="glossary.html#GUID-A8FEC167-D149-4AC8-9FD5-B2E698026021"><span class="xrefglossterm">禁用的计划</span></a> ，这意味着优化程序即使已被接受也无法再使用该计划。
                        </p>
                     </div>
                     <div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-BC65F4D4-1CEE-4014-8188-C849A0D9251A" title="SQL计划历史记录是捕获的SQL执行计划的集合。历史记录包含SQL计划基准和未接受的计划。">SQL计划历史记录</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div><a id="TGSQL637"></a><a id="TGSQL636"></a><div class="props_rev_3"><a id="GUID-AABE25C1-55BD-40F4-AB79-28B4373D545D" name="GUID-AABE25C1-55BD-40F4-AB79-28B4373D545D"></a><h5 id="TGSQL-GUID-AABE25C1-55BD-40F4-AB79-28B4373D545D" class="sect5"><span class="enumeration_section">27.6.3.2</span>接受的计划</h5>
                     <div>
                        <p><span class="bold">接受的计划</span>是SQL语句的SQL计划基准中的计划，因此可供优化程序使用。接受的计划包含一组提示，计划哈希值和其他与计划相关的信息。
                        </p>
                        <p>语句的SQL计划历史记录包含所有计划，包括已接受和未接受的计划。优化程序在计划基准中生成第一个接受的计划后，每个后续未<a href="glossary.html#GUID-C02667C0-BF55-4CCE-B347-71CE5C3B6F1B"><span class="xrefglossterm">接受的计划</span></a>都会添加到计划历史记录中，等待验证，但不在SQL计划基准中。
                        </p>
                     </div>
                     <div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-BC65F4D4-1CEE-4014-8188-C849A0D9251A" title="SQL计划历史记录是捕获的SQL执行计划的集合。历史记录包含SQL计划基准和未接受的计划。">SQL计划历史记录</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div><a id="TGSQL639"></a><a id="TGSQL638"></a><div class="props_rev_3"><a id="GUID-B51FBAA9-EE95-4F19-AD4B-F5F4C2910688" name="GUID-B51FBAA9-EE95-4F19-AD4B-F5F4C2910688"></a><h5 id="TGSQL-GUID-B51FBAA9-EE95-4F19-AD4B-F5F4C2910688" class="sect5"><span class="enumeration_section">27.6.3.3</span>固定计划</h5>
                     <div>
                        <p><span class="bold">固定计划</span>是标记为首选的已接受计划，因此优化程序仅考虑基准中的固定计划。固定计划会影响优化程序的计划选择过程。
                        </p>
                        <p>假设语句的SQL计划基准中存在三个计划。您希望优化器仅对其中两个计划给予优惠待遇。如下图所示，您将这两个计划标记为已修复，以便优化程序仅使用这两个计划中的最佳计划，而忽略其他计划。</p>
                        <div class="figure" id="GUID-B51FBAA9-EE95-4F19-AD4B-F5F4C2910688__CDEDDDAE">
                           <p class="titleinfigure">图27-6固定计划</p><img src="img/tgsql_vm_008.png" alt="下面是图27-6的描述" title="下面是图27-6的描述" longdesc="img_text/tgsql_vm_008.html"><br><a href="img_text/tgsql_vm_008.html">“图27-6固定计划”的说明</a></div>
                        <!-- class="figure" -->
                        <p>如果将新计划添加到包含至少一个已启用的固定计划的基准，则优化程序在您手动将它们声明为已修复之前无法使用新计划。</p>
                     </div>
                     <div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="overview-of-sql-plan-management.html#GUID-BC65F4D4-1CEE-4014-8188-C849A0D9251A" title="SQL计划历史记录是捕获的SQL执行计划的集合。历史记录包含SQL计划基准和未接受的计划。">SQL计划历史记录</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>