<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="These scenarios present different situations you might encounter while administering your Oracle Data Guard configuration. Each of them can be adapted to your specific environment."></meta>
      <meta name="description" content="These scenarios present different situations you might encounter while administering your Oracle Data Guard configuration. Each of them can be adapted to your specific environment."></meta>
      <title>Oracle Data Guard方案</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Concepts and Administration "></meta>
      <meta property="og:description" content="These scenarios present different situations you might encounter while administering your Oracle Data Guard configuration. Each of them can be adapted to your specific environment."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Concepts and Administration"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="data-guard-concepts-and-administration.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-02-12T10:50:21-08:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="1999, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96244-02"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html" title="Previous" type="text/html"></link>
      <link rel="next" href="oracle-data-guard-parameters-views.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Data Guard Concepts and Administration"></meta>
    <meta name="dcterms.isVersionOf" content="SBYDB"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="oracle-data-guard-parameters-views.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">概念和管理</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="oracle-data-guard-concepts.html" property="item" typeof="WebPage"><span property="name">概念和管理</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Oracle Data Guard方案</li>
            </ol>
            <a id="GUID-07C5867F-C55F-4B5B-804F-1800CE9985EF" name="GUID-07C5867F-C55F-4B5B-804F-1800CE9985EF"></a><a id="SBYDB5073"></a><a id="SBYDB00900"></a>
            
            <h2 id="SBYDB-GUID-07C5867F-C55F-4B5B-804F-1800CE9985EF" class="sect2"><span class="enumeration_chapter">15</span> Oracle Data Guard方案</h2>
         </header>
         <div class="ind">
            <div>
               <p>这些方案显示了在管理Oracle Data Guard配置时可能遇到的不同情况。每个都可以适应您的特定环境。</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-CBC9D920-C2D0-4342-ACEF-C16289D1774A" title="这些是在主数据库故障转移到另一个备用数据库之后逻辑备用数据库上所需的步骤。">故障转移后配置逻辑备用数据库</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="发生故障转移后，原始主数据库无法再参与Oracle Data Guard配置，直到在新配置中将其修复并建立为备用数据库。">使用闪回数据库将失败的主数据库转换为备用数据库</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-BAA5ED38-29A0-4E8D-8435-AA083D19C13E" title="如果备用数据库使用实时应用的Oracle Data Guard配置中的主数据库发生错误，则在备用数据库上应用相同的错误。如果启用了闪回数据库，则可以将主数据库和备用数据库还原为其错误前的状态。">发布Open Resetlogs语句后使用闪回数据库</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-BD9E85AB-D812-4659-9C85-26CDFF115A8A" title="某些SQL语句允许您指定NOLOGGING子句，以便在联机重做日志文件中不记录该操作。">在指定NOLOGGING条款后恢复</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-6FB574E5-2F3A-4C9E-A3F0-7C9154B0F540" title="创建备用数据库时，如果主数据库使用Oracle托管文件（OMF）或Oracle自动存储管理（Oracle ASM），则必须执行其他步骤。">创建使用OMF或Oracle ASM的备用数据库</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-8F4E7807-6013-480F-8780-088F5639732F" title="在Oracle Data Guard配置中进行介质恢复期间，可以使用物理备用数据库检测主数据库上的丢失写入数据损坏错误。">从主数据库上的丢失写入错误中恢复</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3" title="您可以使用PL / SQL过程DBMS_DBCOMP.DBCOMP来检测丢失的写入，还可以检测主数据库和物理备用数据库之间的不一致。">使用DBCOMP程序检测丢失的写入和其他不一致</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" title="要转换失败的主数据库，Oracle建议您在主数据库上启用闪回数据库功能，并根据需要执行以下过程之一。">使用RMAN备份将失败的主数据库转换为备用数据库</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-FCDB44CE-FBFE-43BB-88E3-74267B38FE70" title="Oracle Data Guard允许您更改主数据库的数据库字符集和国家字符集，而无需在配置中重新创建任何物理备用数据库。">在不重新创建物理备用数据库的情况下更改主要字符集</a></p>
                  </li>
                  <li>
                     <p><a href="examples-of-using-oracle-data-guard.html#GUID-8D948A24-A3B7-4E4F-917A-00B047CF3CAF" title="在主服务器上执行PDB PITR或PDB闪回后，您可以还原PDB或闪回备用服务器上的PDB以使备用服务器跟随主服务器。">主PDB上的PDB PITR或PDB闪回后待机所需的操作</a></p>
                  </li>
               </ul>
            </div><a id="SBYDB4885"></a><div class="props_rev_3"><a id="GUID-CBC9D920-C2D0-4342-ACEF-C16289D1774A" name="GUID-CBC9D920-C2D0-4342-ACEF-C16289D1774A"></a><h3 id="SBYDB-GUID-CBC9D920-C2D0-4342-ACEF-C16289D1774A" class="sect3"><span class="enumeration_section">15.1</span>故障切换后配置逻辑备用数据库</h3>
               <div>
                  <p>这些是在主数据库故障转移到另一个备用数据库之后逻辑备用数据库上所需的步骤。</p>
                  <p>发生故障转移后，逻辑备用数据库不能充当新主数据库的备用数据库，直到它从原始主数据库应用了最终重做。这类似于新主数据库在故障转移期间应用最终重做的方式。必须执行的步骤取决于新主数据库在故障转移之前是物理备用数据库还是逻辑备用数据库：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-C058F492-C55E-4EF4-929C-CA8AF206F349" title="这些步骤演示了如何配置逻辑备用数据库以支持在承担主要角色之前作为物理备用数据库的新主数据库。">当新主数据库以前是物理备用数据库时</a></p>
                     </li>
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-424FC856-08A5-4F68-9EEC-93F0EF575A3A" title="这些步骤演示了如何配置逻辑备用数据库以支持在承担主要角色之前作为逻辑备用数据库的新主数据库。">当新主数据库以前是逻辑备用数据库时</a></p>
                     </li>
                  </ul>
               </div><a id="SBYDB4886"></a><div class="props_rev_3"><a id="GUID-C058F492-C55E-4EF4-929C-CA8AF206F349" name="GUID-C058F492-C55E-4EF4-929C-CA8AF206F349"></a><h4 id="SBYDB-GUID-C058F492-C55E-4EF4-929C-CA8AF206F349" class="sect4"><span class="enumeration_section">15.1.1</span>当<span class="enumeration_section">新主</span>数据库以前是物理备用数据库时</h4>
                  <div>
                     <p>这些步骤演示了如何配置逻辑备用数据库以支持在承担主要角色之前作为物理备用数据库的新主数据库。</p>
                     <div class="section">
                        <p>在此方案中，SAT是逻辑备用数据库，NYC是主数据库。</p>
                        <ol>
                           <li>
                              <p>在SAT数据库上，发出以下语句以配置FAL_SERVER参数以启用日志文件的自动恢复。</p>
                              <p></p><pre class="pre codeblock"><code>SQL&gt; ALTER SYSTEM SET FAL_SERVER ='&lt;tns_name_to_new_primary&gt;'; SQL&gt; ALTER SYSTEM SET FAL_CLIENT ='&lt;tns_name_to_local_database&gt;';</code></pre></li>
                           <li>
                              <p>调用PREPARE_FOR_NEW_PRIMARY例程以验证逻辑备用数据库是否能够充当新主数据库的备用数据库。在此步骤中，将从本地数据库中删除存在数据偏差风险的日志文件的本地副本。然后，请求这些日志文件直接从新的主数据库重新存档。</p>
                              <p>在SAT数据库上，发出以下语句：</p><pre class="pre codeblock"><code>SQL&gt; EXECUTE DBMS_LOGSTDBY.PREPARE_FOR_NEW_PRIMARY（ - &gt; former_standby_type =&gt;'PHYSICAL' - &gt; dblink =&gt;'nyc_link'）;</code></pre><div class="infoboxnote" id="GUID-C058F492-C55E-4EF4-929C-CA8AF206F349__GUID-0690661F-5155-4D13-BB14-7DE18F7CAA9C">
                                 <p class="notep1">注意：</p>
                                 <p>如果返回<code class="codeph">ORA-16109</code>消息并且'LOGSTDBY：prepare_for_new_primary失败 - 应用太多，则需要闪回。警告写在alert.log中，执行以下步骤：</p>
                                 <ol type="a">
                                    <li>
                                       <p>按照警告中的说明将数据库闪回到SCN然后</p>
                                    </li>
                                    <li>
                                       <p>继续之前重复此步骤。</p>
                                    </li>
                                 </ol>
                                 <p>有关如何将逻辑备用数据库闪回到Apply SCN的示例，请参阅<a href="examples-of-using-oracle-data-guard.html#GUID-A6260CFC-7ABA-4478-9211-BC665077725B" title="这些步骤描述了如何使用闪回数据库和SQL应用程序恢复到已知应用的SCN。">将逻辑备用数据库闪回到特定</a>的应用SCN。</p>
                              </div>
                           </li>
                           <li>
                              <p>在SAT数据库上，发出以下语句以启动SQL Apply：</p>
                              <p></p><pre class="pre codeblock"><code>SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;</code></pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB4887"></a><div class="props_rev_3"><a id="GUID-424FC856-08A5-4F68-9EEC-93F0EF575A3A" name="GUID-424FC856-08A5-4F68-9EEC-93F0EF575A3A"></a><h4 id="SBYDB-GUID-424FC856-08A5-4F68-9EEC-93F0EF575A3A" class="sect4"><span class="enumeration_section">15.1.2</span>当<span class="enumeration_section">新主</span>数据库以前是逻辑备用数据库时</h4>
                  <div>
                     <p>这些步骤演示了如何配置逻辑备用数据库以支持在承担主要角色之前作为逻辑备用数据库的新主数据库。</p>
                     <div class="section">
                        <p>在此方案中，SAT是逻辑备用数据库，NYC是主数据库。</p>
                        <ol>
                           <li>
                              <p>确保新的主数据库已准备好支持逻辑备用数据库。在NYC数据库上，确保以下查询返回值<code class="codeph">NONE</code> 。否则，新的主数据库尚未完成启用逻辑备用数据库支持所需的工作。例如：</p><pre class="pre codeblock"><code>SQL&gt; SELECT PENDING_ROLE_CHANGE_TASKS FROM V $ DATABASE;</code></pre><p>在尝试恢复旧的主数据库之前，必须返回值<code class="codeph">NONE</code> 。
                              </p>
                           </li>
                           <li>
                              <p>在SAT数据库上，发出以下语句以配置FAL_SERVER参数以启用日志文件的自动恢复：</p>
                              <p></p><pre class="pre codeblock"><code>SQL&gt; ALTER SYSTEM SET FAL_SERVER ='&lt;tns_name_to_new_primary&gt;'; SQL&gt; ALTER SYSTEM SET FAL_CLIENT ='&lt;tns_name_to_local_database&gt;';</code></pre></li>
                           <li>
                              <p>调用<code class="codeph">PREPARE_FOR_NEW_PRIMARY</code>例程以验证逻辑备用数据库是否能够成为<code class="codeph">PREPARE_FOR_NEW_PRIMARY</code>数据库的备用数据库。在此步骤中，将从本地数据库中删除存在数据偏差风险的日志文件的本地副本。然后，请求这些日志文件直接从新的主数据库重新存档。
                              </p>
                              <p>在SAT数据库上，发出以下语句：</p><pre class="pre codeblock"><code>SQL&gt; EXECUTE DBMS_LOGSTDBY.PREPARE_FOR_NEW_PRIMARY（ - &gt; former_standby_type =&gt;'LOGICAL' - &gt; dblink =&gt;'nyc_link'）;</code></pre><div class="infoboxnote" id="GUID-424FC856-08A5-4F68-9EEC-93F0EF575A3A__GUID-B2DCBE47-118C-43B0-9F3A-F74D37E2E39F">
                                 <p class="notep1">注意：</p>
                                 <p>如果返回<code class="codeph">ORA-16109</code>消息并且<code class="codeph">LOGSTDBY: prepare_for_new_primary failure -- applied too far, flashback required</code>则会在alert.log文件中写入<code class="codeph">LOGSTDBY: prepare_for_new_primary failure -- applied too far, flashback required</code>警告，请执行以下步骤：</p>
                                 <ol type="a">
                                    <li>
                                       <p>按照警告中的说明将数据库闪回到SCN然后</p>
                                    </li>
                                    <li>
                                       <p>继续之前重复此步骤。</p>
                                    </li>
                                 </ol>
                                 <p>有关如何将逻辑备用数据库闪回到Apply SCN的示例，请参阅<a href="examples-of-using-oracle-data-guard.html#GUID-A6260CFC-7ABA-4478-9211-BC665077725B" title="这些步骤描述了如何使用闪回数据库和SQL应用程序恢复到已知应用的SCN。">将逻辑备用数据库闪回到特定</a>的应用SCN。</p>
                              </div>
                           </li>
                           <li>
                              <p>在SAT数据库上，发出以下语句以启动SQL Apply：</p><pre class="pre codeblock"><code>SQL&gt; ALTER DATABASE START LOGICAL STANDBY应用新的主要nyc_link;</code></pre><p>必须始终在未启用实时应用选项的情况下发出此语句。要在逻辑备用数据库上启用实时应用，请等待上述语句成功完成，然后发出以下语句：</p><pre class="pre codeblock"><code>SQL&gt; ALTER DATABASE STOP LOGICAL STANDBY APPLY; SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;</code></pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="SBYDB00910"></a><div class="props_rev_3"><a id="GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" name="GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB"></a><h3 id="SBYDB-GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" class="sect3"><span class="enumeration_section">15.2</span>使用闪回数据库将失败的主<span class="enumeration_section">节点</span>转换为备用数据库</h3>
               <div>
                  <p>发生故障转移后，原始主数据库无法再参与Oracle Data Guard配置，直到在新配置中将其修复并建立为备用数据库。</p>
                  <p>为此，您可以使用闪回数据库功能将发生故障的主数据库恢复到发生故障转移之前的某个时间点，然后将其转换为新配置中的物理或逻辑备用数据库。以下部分描述：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-C7C39BEC-A841-48D1-BE4B-9BB49C65B9C9" title="这些步骤将旧的主数据库作为物理备用数据库重新引入Oracle Data Guard配置。">将失败的主数据库闪回到物理备用数据库</a></p>
                     </li>
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-324EBFC6-5358-419A-AD4A-E457273E6560" title="这些步骤将旧的主数据库作为新的逻辑备用数据库重新引入Oracle Data Guard配置，而无需从新的主数据库正式实例化它。">将失败的主数据库闪回到逻辑备用数据库中</a> 
                        </p>
                        <div class="infoboxnote" id="GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB__GUID-66988666-621E-4102-805D-1A0A1695E456">
                           <p class="notep1">注意：</p>
                           <p>在故障转移之前，您必须已在原始主数据库上启用了闪回数据库。有关更多信息，请参见“ <a href="../bradv/using-flasback-database-restore-points.html#BRADV71000" target="_blank"><span class="italic">Oracle数据库备份和恢复用户指南”</span></a> 。
                           </p>
                        </div>
                     </li>
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-A6260CFC-7ABA-4478-9211-BC665077725B" title="这些步骤描述了如何使用闪回数据库和SQL应用程序恢复到已知应用的SCN。">将逻辑备用数据库闪回到特定的应用SCN</a></p>
                        <div class="infoboxnotealso" id="GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB__GUID-53149AF4-B728-4706-B16C-9205D8089915">
                           <p class="notep1">也可以看看：</p>
                           <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=DGBKR3438" target="_blank"><span class="italic">Oracle Data Guard Broker，</span></a>以获取有关将故障主数据库自动恢复为新备用数据库的信息（作为使用闪回数据库的替代方法）</p>
                        </div>
                     </li>
                  </ul>
               </div><a id="SBYDB4888"></a><div class="props_rev_3"><a id="GUID-C7C39BEC-A841-48D1-BE4B-9BB49C65B9C9" name="GUID-C7C39BEC-A841-48D1-BE4B-9BB49C65B9C9"></a><h4 id="SBYDB-GUID-C7C39BEC-A841-48D1-BE4B-9BB49C65B9C9" class="sect4"><span class="enumeration_section">15.2.1</span>将失败的主数据库闪回到物理备用数据库</h4>
                  <div>
                     <p>这些步骤将旧的主数据库作为物理备用数据库重新引入Oracle Data Guard配置。</p>
                     <div class="section">
                        <p>以下步骤假定已对物理备用数据库执行了故障转移，并且在故障转移时已在旧主数据库上启用了闪回数据库。</p>
                        <ol>
                           <li>
                              <p>在新的主数据库上，发出以下查询以确定旧备用数据库成为新主数据库的SCN：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT TO_CHAR（STANDBY_BECAME_PRIMARY_SCN）FROM V $ DATABASE;</pre></li>
                           <li>
                              <p>关闭旧的主数据库（如有必要），装入它，然后将其闪回到上一步中确定的<code class="codeph">STANDBY_BECAME_PRIMARY_SCN</code>的值。
                              </p><pre class="oac_no_warn" dir="ltr">SQL&gt; SHUTDOWN IMMEDIATE; SQL&gt; STARTUP MOUNT; SQL&gt; FLASHBACK DATABASE TO SCN <span class="variable" translate="no">standby_became_primary_scn</span> ;</pre></li>
                           <li>
                              <p>要将数据库转换为物理备用数据库，请在旧主数据库上发出以下语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE CONVERT TO PHYSICAL STANDBY;</pre></li>
                           <li>
                              <p>要开始将重做传输到新的物理备用数据库，请在新的主数据库上执行以下步骤：</p>
                              <ol type="a">
                                 <li>
                                    <p>发出以下查询以查看归档目标的当前状态：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DEST_ID，DEST_NAME，STATUS，PROTECTION_MODE，DESTINATION， - &gt; ERROR，SRL来自V $ ARCHIVE_DEST_STATUS;</pre><pre class="oac_no_warn" dir="ltr"></pre></li>
                                 <li>
                                    <p>如有必要，启用目的地：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_ <span class="variable" translate="no">n</span> = ENABLE;</pre></li>
                                 <li>
                                    <p>执行日志切换以确保备用数据库开始从新的主数据库接收重做数据，并验证它是否已成功发送。在新的主数据库上发出以下SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM SWITCH LOGFILE; SQL&gt; SELECT DEST_ID，DEST_NAME，STATUS，PROTECTION_MODE，DESTINATION， - &gt; ERROR，SRL来自V $ ARCHIVE_DEST_STATUS;</pre><p>在新的备用数据库上，您可能还需要更改<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>初始化参数，以便重做传输服务不会将重做数据传输到其他数据库。
                                    </p>
                                 </li>
                              </ol>
                           </li>
                           <li>
                              <p>在新的物理备用数据库上启动重做应用：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;</pre><p>每次遇到因角色转换而生成的重做记录时，重做应用都会自动停止，因此需要重新启动重做应用一次或多次，直到它应用到新主数据库成为主数据库的SCN之外。 。一旦故障主数据库恢复并以备用角色运行，您可以选择执行切换以将数据库转换为其原始（故障前）角色。有关详细信息，请参阅<span class="q">“ <a href="managing-oracle-data-guard-role-transitions.html#GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF" title="这些步骤描述了如何切换到物理备用数据库。">执行切换到物理备用数据库</a> ”</span> 。
                              </p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB4889"></a><div class="props_rev_3"><a id="GUID-324EBFC6-5358-419A-AD4A-E457273E6560" name="GUID-324EBFC6-5358-419A-AD4A-E457273E6560"></a><h4 id="SBYDB-GUID-324EBFC6-5358-419A-AD4A-E457273E6560" class="sect4"><span class="enumeration_section">15.2.2</span>将失败的主数据库闪回到逻辑备用数据库中</h4>
                  <div>
                     <p>这些步骤将旧的主数据库作为新的逻辑备用数据库重新引入Oracle Data Guard配置，而无需从新的主数据库正式实例化它。</p>
                     <div class="section">
                        <p>这些步骤假定Oracle Data Guard配置已完成涉及逻辑备用数据库的故障转移，并且已在旧主数据库上启用了闪回数据库。</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>确定闪回SCN和恢复SCN。闪回SCN是闪回故障主数据库的SCN。恢复SCN是恢复故障主数据库的SCN。在新主服务器上发出以下查询以识别这些SCN：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT merge_change＃AS FLASHBACK_SCN，processed_change＃AS RECOVERY_SCN  - &gt; FROM DBA_LOGSTDBY_HISTORY  - &gt; WHERE stream_sequence＃=（SELECT MAX（stream_sequence＃） -  1  - &gt; FROM DBA_LOGSTDBY_HISTORY）;</pre></div>
                        </li>
                        <li class="stepexpand"><span>将失败的主数据库闪回到上一步中标识的闪回SCN：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; FLASHBACK DATABASE TO SCN <span class="italic">flashback_scn</span> ;</pre></div>
                        </li>
                        <li class="stepexpand"><span>将发生故障的主数据库转换为物理备用数据库，并重新安装备用数据库以准备恢复：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE CONVERT TO PHYSICAL STANDBY;</pre></div>
                        </li>
                        <li class="stepexpand"><span>配置<code class="codeph">FAL_SERVER</code>参数以启用日志文件的自动恢复。在物理备用数据库上发出以下语句（主服务器失败）：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM SET FAL_SERVER ='&lt;tns_name_to_new_primary&gt;';</pre></div>
                        </li>
                        <li class="stepexpand"><span>从故障转移操作时或故障转移操作后，从故障主数据库中删除所有存档日志。如果故障主数据库与备用数据库隔离，则可能存在与当前主数据库不一致的不同存档日志。为确保永远不会应用这些不同的存档日志，必须从备份和快速恢复区域中删除它们。您可以使用以下RMAN命令从快速恢复区域中删除相关的存档日志：</span><div><pre class="oac_no_warn" dir="ltr">RMAN&gt;从SCN FLASHBACK_SCN删除FORCE ARCHIVELOG;</pre><p>删除后，这些不同的日志和后续事务永远无法恢复。</p>
                              <p></p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>恢复直到步骤1中确定的恢复SCN：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; RECOVER MANAGED STANDBY DATABASE UNTIL CHANGE <span class="italic">recovery_scn</span> ;</pre></div>
                        </li>
                        <li class="stepexpand"><span>启用数据库防护：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE GUARD ALL;</pre></div>
                        </li>
                        <li class="stepexpand"><span>激活物理备用数据库以成为主数据库：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE ACTIVATE STANDBY DATABASE;</pre></div>
                        </li>
                        <li class="stepexpand"><span>打开数据库：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN;</pre></div>
                        </li>
                        <li class="stepexpand"><span>创建指向新主数据库的数据库链接，然后启动SQL Apply：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; CREATE PUBLIC DATABASE LINK <span class="italic">mylink</span> - &gt; CONNECT TO <span class="italic">system</span> IDENTIFIED BY <span class="italic">password</span> - &gt; <span class="italic">USING'service_name_of_new_primary_database</span> '; SQL&gt; ALTER DATABASE START LOGICAL STANDBY应用新的主要<span class="italic">mylink</span> ;</pre><p>角色转换现在已经完成。</p>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div><a id="SBYDB4890"></a><div class="props_rev_3"><a id="GUID-A6260CFC-7ABA-4478-9211-BC665077725B" name="GUID-A6260CFC-7ABA-4478-9211-BC665077725B"></a><h4 id="SBYDB-GUID-A6260CFC-7ABA-4478-9211-BC665077725B" class="sect4"><span class="enumeration_section">15.2.3</span>将逻辑备用数据库闪回到特定的应用SCN</h4>
                  <div>
                     <div>备用数据库的一个好处是可以在备用数据库上执行闪回数据库，而不会影响主数据库服务。将数据库闪回到特定时间点是一项简单的任务，但是在逻辑备用数据库上，您可能希望闪回到提交已知事务之前的时间。在故障转移后使用新的主数据库配置逻辑备用数据库时可能会出现这种需求。<span>这些步骤描述了如何使用闪回数据库和SQL应用程序恢复到已知应用的SCN。</span></div>
                     <ol>
                        <li class="stepexpand"><span>在主服务器（APPLIED_SCN）上确定已知SCN后，发出以下查询以确定逻辑备用数据库中的相应SCN，以用于闪回操作：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DBMS_LOGSTDBY.MAP_PRIMARY_SCN（PRIMARY_SCN =&gt; APPLIED_SCN） - &gt; AS TARGET_SCN FROM DUAL;</pre></div>
                        </li>
                        <li class="stepexpand"><span>发出以下SQL语句以将逻辑备用数据库闪回到指定的SCN，并使用RESETLOGS选项打开逻辑备用数据库：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SHUTDOWN; SQL&gt; STARTUP MOUNT EXCLUSIVE; SQL&gt; FLASHBACK DATABASE TO SCN &lt;TARGET_SCN&gt;; SQL&gt; ALTER DATABASE OPEN RESETLOGS;</pre></div>
                        </li>
                        <li class="stepexpand"><span>发出以下查询以确认SQL Apply已应用小于或高达<code class="codeph">APPLIED_SCN</code> 。</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT APPLIED_SCN FROM V $ LOGSTDBY_PROGRESS;</pre></div>
                        </li>
                     </ol>
                  </div>
               </div>
            </div><a id="SBYDB4891"></a><div class="props_rev_3"><a id="GUID-BAA5ED38-29A0-4E8D-8435-AA083D19C13E" name="GUID-BAA5ED38-29A0-4E8D-8435-AA083D19C13E"></a><h3 id="SBYDB-GUID-BAA5ED38-29A0-4E8D-8435-AA083D19C13E" class="sect3"><span class="enumeration_section">15.3</span>发布Open Resetlogs语句后使用闪回数据库</h3>
               <div>
                  <p>如果备用数据库使用实时应用的Oracle Data Guard配置中的主数据库发生错误，则在备用数据库上应用相同的错误。如果启用了闪回数据库，则可以将主数据库和备用数据库还原为其错误前的状态。</p>
                  <p></p>
                  <p>为此，请在主数据库上发出<code class="codeph">FLASHBACK DATABASE</code>和<code class="codeph">OPEN RESETLOGS</code>语句，然后在重新启动应用服务之前在备用数据库上发出类似的<code class="codeph">FLASHBACK STANDBY DATABASE</code>语句。（如果未启用闪回数据库，则需要在主数据库上执行时间点恢复后重新创建备用数据库，如<a href="creating-oracle-data-guard-physical-standby.html#GUID-B511FB6E-E3E7-436D-94B5-071C37550170" title="您可以使用异步重做传输和实时应用（默认的Oracle Data Guard配置）以最高性能模式手动创建物理备用数据库。">创建物理备用数据库</a>和<a href="creating-oracle-data-guard-logical-standby.html#GUID-3666CA35-D993-44B6-8D70-A2B8B9EC8B2E" title="创建逻辑备用数据库涉及许多步骤，包括先决条件和创建后任务。">创建逻辑备用数据库中</a>所述。）
                  </p>
               </div><a id="SBYDB4892"></a><div class="props_rev_3"><a id="GUID-09129494-CD98-44B6-821F-A4C2CB5AEE08" name="GUID-09129494-CD98-44B6-821F-A4C2CB5AEE08"></a><h4 id="SBYDB-GUID-09129494-CD98-44B6-821F-A4C2CB5AEE08" class="sect4"><span class="enumeration_section">15.3.1</span>将物理备用数据库闪回到特定时间点</h4>
                  <div>
                     <p>这些步骤描述了在主数据库上发出<code class="codeph">OPEN RESETLOGS</code>语句后如何避免重新创建物理备用数据库。
                     </p>
                     <div class="section">
                        <p></p>
                        <p>使用Oracle Database Release 19c，如果备用数据库处于装载模式并且启用了闪回数据库，则可能不需要执行任何操作。在常见情况下，如果有足够的闪回数据可用，则备用数据库将自动闪回，以便备用数据库继续跟随主数据库。</p>
                        <p>如果备用数据库已打开且启用了闪回数据库，则可以将备用数据库置于装载模式，然后启动备用数据库恢复。MRP试图让备用数据库跟随主数据库，触发备用数据库的自动闪回。如果此操作成功（如警报日志中所报告），则需要按照打开Active Data Guard实例进行操作。</p>
                        <p>如果未触发自动闪回，或者自动闪回未导致主数据库之后的备用数据库，则可以执行本节中描述的步骤。</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>在RESETLOGS操作发生之前确定SCN。例如，在主数据库上，使用以下查询获取在主数据库上发生<code class="codeph">RESETLOGS</code>操作之前为2个SCN的系统更改号（SCN）的值：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT TO_CHAR（RESETLOGS_CHANGE＃ -  2）FROM V $ DATABASE;</pre></div>
                        </li>
                        <li class="stepexpand"><span>在备用数据库上，使用以下查询获取当前SCN：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT TO_CHAR（CURRENT_SCN）FROM V $ DATABASE;</pre></div>
                        </li>
                        <li class="stepexpand"><span>如果<code class="codeph">CURRENT_SCN</code>的值大于resetlogs_change＃ -  2的值，请发出以下语句以闪回备用数据库。</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; FLASHBACK STANDBY DATABASE到SCN resetlogs_change＃-2;</pre><ul style="list-style-type:disc">
                                 <li>
                                    <p>如果<code class="codeph">CURRENT_SCN</code>的值小于resetlogs_change＃ -  2的值，请跳至步骤4。
                                    </p>
                                 </li>
                                 <li>
                                    <p>如果备用数据库的SCN远远落后于主数据库的SCN，并且<code class="codeph">OPEN RESETLOGS</code>语句中的新重做分支已在备用数据库中注册，则应用服务可以继续通过<code class="codeph">OPEN RESETLOGS</code>语句而不停止。在这种情况下，不需要闪回数据库，因为应用服务在到达重做数据中的<code class="codeph">OPEN RESETLOGS</code>语句时不会停止。
                                    </p>
                                 </li>
                              </ul>
                           </div>
                        </li>
                        <li class="stepexpand"><span>要在物理备用数据库上启动Redo Apply，请发出以下语句：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;</pre><p>现在，备用数据库已准备好从主数据库接收和应用重做。</p>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div><a id="SBYDB4893"></a><div class="props_rev_3"><a id="GUID-A2191DBB-AA91-4C42-8F01-7B7E9529F465" name="GUID-A2191DBB-AA91-4C42-8F01-7B7E9529F465"></a><h4 id="SBYDB-GUID-A2191DBB-AA91-4C42-8F01-7B7E9529F465" class="sect4"><span class="enumeration_section">15.3.2</span>将逻辑备用数据库闪回到特定时间点</h4>
                  <div>
                     <p>这些步骤描述了在闪回主数据库并通过发出<code class="codeph">OPEN RESETLOGS</code>语句打开它之后如何避免重新创建逻辑备用数据库。
                     </p>
                     <div class="section">
                        <p></p>
                        <div class="infoboxnote" id="GUID-A2191DBB-AA91-4C42-8F01-7B7E9529F465__GUID-D3616975-2A5C-469E-8433-25CC18CEF600">
                           <p class="notep1">注意：</p>
                           <p>如果SQL Apply检测到主数据库中发生了resetlogs操作，则它会自动挖掘正确的重做分支，如果可以这样做而不必闪回逻辑备用数据库。否则，SQL Apply将停止并显示错误<code class="codeph">ORA-1346: LogMiner processed redo beyond specified reset log scn</code> 。在本节中，假设SQL Apply已经因此类错误而停止。
                           </p>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>在主数据库上，使用以下查询获取在主数据库上发生<code class="codeph">RESETLOGS</code>操作之前为2个SCN的系统更改编号（SCN）的值：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT TO_CHAR（RESETLOGS_CHANGE＃ -  2）AS FLASHBACK_SCN来自V $ DATABASE;</pre></div>
                        </li>
                        <li class="stepexpand"><span>确定逻辑备用数据库中闪回操作的目标SCN。</span><div>
                              <p>在此步骤中， <code class="codeph">PRIMARY_SCN</code>的<code class="codeph">FLASHBACK_SCN</code>值来自步骤1。
                              </p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DBMS_LOGSTDBY.MAP_PRIMARY_SCN（PRIMARY_SCN =&gt; FLASHBACK_SCN） - &gt; AS TARGET_SCN FROM DUAL;</pre></div>
                        </li>
                        <li class="stepexpand"><span>发出以下SQL语句以将逻辑备用数据库闪回到指定的SCN，并使用<code class="codeph">RESETLOGS</code>选项打开逻辑备用数据库：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SHUTDOWN; SQL&gt; STARTUP MOUNT EXCLUSIVE; SQL&gt; FLASHBACK DATABASE TO SCN &lt;TARGET_SCN&gt;; SQL&gt; ALTER DATABASE OPEN RESETLOGS;</pre></div>
                        </li>
                        <li class="stepexpand"><span>在启动SQL应用程序之前，确认已注册主要新分支的日志文件。在主数据库上发出以下查询：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT resetlogs_id FROM V $ DATABASE_INCARNATION WHERE status ='CURRENT';</pre><p>在备用数据库上发出以下查询：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT * FROM DBA_LOGSTDBY_LOG WHERE resetlogs_id = <span class="italic">resetlogs_id_at_primary</span> ;</pre><p>如果返回一行或多行，则确认已从主要新分支中注册了日志文件。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>启动SQL Apply：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;</pre></div>
                        </li>
                     </ol>
                  </div>
               </div>
            </div><a id="SBYDB00920"></a><div class="props_rev_3"><a id="GUID-BD9E85AB-D812-4659-9C85-26CDFF115A8A" name="GUID-BD9E85AB-D812-4659-9C85-26CDFF115A8A"></a><h3 id="SBYDB-GUID-BD9E85AB-D812-4659-9C85-26CDFF115A8A" class="sect3"><span class="enumeration_section">15.4</span>指定NOLOGGING条款后恢复</h3>
               <div>
                  <p>某些SQL语句允许您指定<code class="codeph">NOLOGGING</code>子句，以便在联机重做日志文件中不记录该操作。
                  </p>
                  <p>实际上，重做记录仍会写入联机重做日志文件，但没有与该记录关联的数据。这可能导致备用站点上的日志应用程序或数据访问错误，并且可能需要手动恢复才能恢复应用日志文件。根据您是具有逻辑备用还是物理备用，可以通过执行以下操作来避免这些错误：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>逻辑备用数据库 - 在<code class="codeph">CREATE DATABASE</code>或<code class="codeph">ALTER DATABASE</code>语句中指定<code class="codeph">FORCE LOGGING</code>子句。
                        </p>
                     </li>
                     <li>
                        <p>物理备用数据库 - 指定适合您计划使用Data Guard配置的方式的日志记录模式，如<a href="creating-oracle-data-guard-physical-standby.html#GUID-AE2B1237-57A1-4745-A04C-4246A831A963" title="作为准备备用数据库创建的主数据库的一部分，您必须启用适合您计划使用Data Guard配置的方式的日志记录模式。">启用适当的日志记录模式中所述</a> 。
                        </p>
                     </li>
                  </ul>
                  <p>您可以在<code class="codeph">V$DATABASE.FORCE_LOGGING</code>列（对于CDB）或<code class="codeph">DBA_PDBS.FORCE_LOGGING</code>列（对于PDB）中查看当前日志记录模式。
                  </p>
               </div><a id="SBYDB4894"></a><div class="props_rev_3"><a id="GUID-BB804A80-7F19-4087-BAFA-97552C1DAAEF" name="GUID-BB804A80-7F19-4087-BAFA-97552C1DAAEF"></a><h4 id="SBYDB-GUID-BB804A80-7F19-4087-BAFA-97552C1DAAEF" class="sect4"><span class="enumeration_section">15.4.1</span>逻辑备用数据库的恢复步骤</h4>
                  <div>
                     <div class="section"> 
                        <p>在逻辑备用数据库上，当SQL Apply遇到在未跳过的表上使用<code class="codeph">NOLOGGING</code>子句执行的操作的重做记录时，它会因以下错误而停止：</p><pre class="pre codeblock"><code>ORA-16211在归档重做日志中找不到支持的记录</code></pre><p>要在指定<code class="codeph">NOLOGGING</code>子句后进行恢复，请从主数据库重新创建一个或多个表，如在<a href="managing-oracle-data-guard-logical-standby-databases.html#GUID-DD88E3D6-D6DB-4175-BB59-F048B9A87BAA" title="通常，您使用DBMS_LOGSTDBY.INSTANTIATE_TABLE过程在不可恢复的操作后重新创建表。">逻辑备用数据库上添加或重新创建表中所述</a> 。
                        </p>
                        <div class="infoboxnote" id="GUID-BB804A80-7F19-4087-BAFA-97552C1DAAEF__GUID-E53772FF-F49B-4C21-B51B-93C133344020">
                           <p class="notep1">注意：</p>
                           <p>通常，不建议使用<code class="codeph">NOLOGGING</code>子句。因此，如果您事先知道将对主数据库中的某些表执行使用<code class="codeph">NOLOGGING</code>子句的操作，那么您可能希望阻止将与这些表关联的SQL语句应用于逻辑备用数据库。您可以使用<code class="codeph">DBMS_LOGSTDBY.SKIP</code>过程执行此操作。
                           </p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB4895"></a><div class="props_rev_3"><a id="GUID-DDCEF91D-3D6A-45EC-B0ED-8BEBC32FC18B" name="GUID-DDCEF91D-3D6A-45EC-B0ED-8BEBC32FC18B"></a><h4 id="SBYDB-GUID-DDCEF91D-3D6A-45EC-B0ED-8BEBC32FC18B" class="sect4"><span class="enumeration_section">15.4.2</span>物理备用数据库的恢复步骤</h4>
                  <div>
                     <div class="section">
                        <p>当重做应用于物理备用数据库时，数据文件的一部分被标记为不可恢复。当您故障转移到物理备用数据库，或打开备用数据库以进行只读访问，并尝试读取标记为<code class="codeph">UNRECOVERABLE</code>的块范围时，您会看到类似于以下内容的错误消息：</p><pre class="oac_no_warn" dir="ltr">ORA-01578：ORACLE数据块损坏（文件＃1，块＃2521）ORA-01110：数据文件1：'/ oracle / dbs / stdby / tbs_1.dbf'ORA-26040：使用NOLOGGING选项加载数据块</pre><p>当您使用<code class="codeph">STANDBY NOLOGGING FOR LOAD PERFORMANCE</code>模式时，在物理备用数据库上执行的查询仍然可以报告由于nologging操作而导致的损坏块。但是，当作为Active Data Guard配置的一部分在该备用服务器上运行托管恢复时，它会自动从主服务器提取替换块。（使用<code class="codeph">ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT</code>语句启动托管恢复。）托管恢复尝试在首次创建后立即获取所有此类块，并继续尝试修复它们直到成功为止。每当启动托管恢复时，它都会再次开始修复早期恢复会话中的所有未完成的块。此自动恢复仅适用于由启用<code class="codeph">STANDBY NOLOGGING FOR LOAD PERFORMANCE</code>模式生成的重做引起的损坏块。由于传统的非记录操作而损坏的块必须使用以下过程。这些步骤描述了一种恢复所有未记录块的简单方法。（有关其他方法的信息，请参阅后续部分，例如确定在不可恢复的操作之后是否需要备份，以及恢复物理备用数据库的某些部分。）
                        </p>
                        <ol>
                           <li>
                              <p>停止备用数据库的恢复：</p><pre class="pre codeblock"><code>SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;</code></pre></li>
                           <li>
                              <p>通过将RMAN连接到备用数据库来恢复未记录的块，并发出以下命令：</p><pre class="pre codeblock"><code>RMAN&gt;恢复数据库非无效块;</code></pre><p>如果仅在切换后发现存在不可恢复的块，则可以使用这两个相同的步骤，但主数据库必须刚刚挂载（未打开），并且RMAN必须连接到主数据库。</p>
                              <p>RMAN <code class="codeph">RECOVER</code>命令可能无法恢复所有未记录的块。可能发生这种情况的原因在执行RMAN命令的数据库的警报日志中详细说明。最常见的原因是最近在主数据库中修改了一个块，但尚未写入其相应的数据文件。这可能意味着发送到备用数据库的块太旧而无法替换备用数据库上的不可恢复块。要解决此问题，请在将块写入数据文件后再次发出<code class="codeph">RECOVER</code>命令。
                              </p>
                           </li>
                        </ol>
                        <p>以下是执行<code class="codeph">RECOVER</code>命令的警报日志条目示例，该条目使一些块无法恢复：</p><pre class="pre codeblock"><code>已启动文件7上的非记录块替换恢复（ospid 13005 rcvid 11319003446180375696）已完成的非记录块替换恢复文件7.已保留5个块替换块源数据库的统计信息（service = dg3tns）（由于收到错误12942而停止使用它）块请求5，块接收0。接受或拒绝原因替换块最后一个块----------------------------------------- --------------- ---------- ----------未收到：被发件人拒绝。错误的州或SCN 5 21</code></pre><p>在这种情况下，命令在备用数据库上运行，主数据库没有发送任何数据块，而是报告了以下Oracle错误：。</p><pre class="pre codeblock"><code>ORA-12942：源数据库化身不匹配</code></pre><p>检查警报日志会显示主服务器已执行<code class="codeph">FLASHBACK DATABASE</code>和<code class="codeph">OPEN RESETLOGS</code>命令，但备用<code class="codeph">FLASHBACK DATABASE</code>尚未闪回。这意味着备用数据库现在将位于重做的孤立分支上，因此主数据库无法提供已知为正确版本的数据块。
                        </p>
                        <div class="infoboxnote" id="GUID-DDCEF91D-3D6A-45EC-B0ED-8BEBC32FC18B__GUID-899F6B7B-3810-4060-9C51-0BA78F92C036">
                           <p class="notep1">注意：</p>当Data Guard配置具有多个备用数据库时，在备用数据库上运行的RMAN <code class="codeph">RECOVER</code>命令会尝试仅从主数据库获取数据块。当在主服务器上运行<code class="codeph">RECOVER</code>命令时，它尝试仅从其确定最有可能产生好块的一个备用数据库获取块，这通常意味着最接近与主服务器同步的备用数据库。
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB4896"></a><div class="props_rev_3"><a id="GUID-55881B7E-55C1-4342-94DA-A75739504980" name="GUID-55881B7E-55C1-4342-94DA-A75739504980"></a><h4 id="SBYDB-GUID-55881B7E-55C1-4342-94DA-A75739504980" class="sect4"><span class="enumeration_section">15.4.3</span>确定在不可恢复的操作后是否需要备份</h4>
                  <div>
                     <p>如果在主数据库上执行了不可恢复的操作，则需要确定是否需要新的备份操作。</p>
                     <div class="section">
                        <p>为此，请执行以下步骤：</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>查询主数据库上的<code class="codeph">V$DATAFILE</code>视图以确定<span class="bold">系统更改编号（SCN）</span>或Oracle数据库生成最新的无效重做数据的时间。</span></li>
                        <li class="stepexpand"><span>在主数据库上发出以下SQL语句，以确定是否需要执行另一个备份：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT UNRECOVERABLE_CHANGE＃， - &gt; TO_CHAR（UNRECOVERABLE_TIME，'mm-dd-yyyy hh：mi：ss'） - &gt; FROM V $ DATAFILE;</pre></div>
                        </li>
                        <li class="stepexpand"><span>如果上一步骤中的查询报告的数据文件不可恢复的时间比上次备份数据文件的时间更新，则对相关数据文件进行另一次备份。</span></li>
                     </ol>
                     <div class="section">
                        <p>有关<code class="codeph">V$DATAFILE</code>视图的更多信息，请参见<a href="../refrn/V-DATAFILE.html#REFRN30050" target="_blank"><span class="italic">Oracle数据库参考</span></a> 。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
               <div class="sect3"><a id="GUID-C342EF3D-EAB7-4B2D-A638-903345C6A3EC" name="GUID-C342EF3D-EAB7-4B2D-A638-903345C6A3EC"></a><h4 id="SBYDB-GUID-C342EF3D-EAB7-4B2D-A638-903345C6A3EC" class="sect4"><span class="enumeration_section">15.4.4</span>部分物理备用数据库的恢复步骤</h4>
                  <div>
                     <p>RMAN <code class="codeph">RECOVER ...NONLOGGED BLOCK</code>命令可用于恢复属于一组数据文件或一组表空间或仅一个可插拔数据库（PDB）以及多租户容器数据库（CDB）的块。
                     </p>
                     <p>如果可以接受在某些数据文件中保留未记录的块，则此功能可能很有用，例如，因为明确知道非记录块是由于将行加载到现在已被删除的对象中而创建的。</p>
                     <p>视图<code class="codeph">V$NONLOGGED_BLOCK</code>通常列出每个数据文件的已知无效块的范围，并且条目作为介质恢复的一部分进行维护。但是，有时信息不完整。通常，这是在从Oracle Database 12 <span class="italic">c</span>第1版（12.1）之前的版本升级之后或在还原数据文件的操作系统备份之后。下次运行介质恢复时，将删除过时条目，并记录任何新的无效块，但任何先前的无效块都没有<code class="codeph">V$NONLOGGED_BLOCK</code>条目。<code class="codeph">V$DATAFILE</code>视图中的<code class="codeph">FIRST_NONLOGGED_SCN</code>列仍可用于查看数据文件中至少有一个无效块，即使数据文件没有<code class="codeph">V$NONLOGGED_BLOCK</code>条目也是如此。
                     </p>
                     <p>RMAN命令<code class="codeph">VALIDATE ...NONLOGGED BLOCK</code>可用于将<code class="codeph">V$NONLOGGED_BLOCK</code>的条目恢复为与数据文件同步。它通过确定现有范围是否完整来执行此操作，如果不是，则会扫描必要的数据文件以识别任何无效的块，并确保它们被<code class="codeph">V$NONLOGGED_BLOCK</code>的条目捕获。有效<code class="codeph">VALIDATE ...NONLOGGED BLOCK</code>命令与<code class="codeph">RECOVER ...具有相同的选项<code class="codeph">RECOVER ...NONLOGGED BLOCK</code>命令仅用于验证一组数据文件或一组表空间或PDB以及CDB。</p>
                     <div class="infoboxnote" id="GUID-C342EF3D-EAB7-4B2D-A638-903345C6A3EC__GUID-555EF595-2ECF-46B4-B788-7474DDEB0B90">
                        <p class="notep1">注意：</p><code class="codeph">V$NONLOGGED_BLOCK</code>视图中的条目表示无效块的超集，并且可以包括一些接近无效块的正常块。例如，如果存在从块100开始并且在其中具有50个块的文件7的条目，那么这50个块中的任何一个，一些或全部都是无效的。运行<code class="codeph">VALIDATE</code>命令后，没有范围中没有无效块，范围的第一个和最后一个块也是无效块。但是，控制文件中可以保留的范围总数存在限制，因此有时可能需要合并同一文件的范围，从而导致常规块包含在范围内。
                     </div>
                     <p>如果仅验证或恢复脱机数据文件，则可以在运行RMAN命令时打开它们所属的数据库。</p>
                  </div>
               </div>
            </div><a id="SBYDB4897"></a><div class="props_rev_3"><a id="GUID-6FB574E5-2F3A-4C9E-A3F0-7C9154B0F540" name="GUID-6FB574E5-2F3A-4C9E-A3F0-7C9154B0F540"></a><h3 id="SBYDB-GUID-6FB574E5-2F3A-4C9E-A3F0-7C9154B0F540" class="sect3"><span class="enumeration_section">15.5</span>创建使用OMF或Oracle ASM的备用数据库</h3>
               <div>
                  <p>创建备用数据库时，如果主数据库使用Oracle托管文件（OMF）或Oracle自动存储管理（Oracle ASM），则必须执行其他步骤。</p>
                  <div class="section">
                     <p>本节中的讨论将详细介绍，假设您已经知道如何创建物理备用数据库，并且是RMAN，OMF和Oracle ASM功能的有经验的用户。</p>
                     <p>执行以下任务以准备备用数据库创建：</p>
                     <ol>
                        <li>
                           <p>在主数据库上启用强制日志记录。</p>
                        </li>
                        <li>
                           <p>在主数据库上启用存档。</p>
                        </li>
                        <li>
                           <p>在主数据库上设置所有必需的初始化参数。</p>
                        </li>
                        <li>
                           <p>为备用数据库创建初始化参数文件。</p>
                        </li>
                        <li>
                           <p>如果主数据库配置为使用OMF，则Oracle建议将备用数据库配置为使用OMF。为此，请将<code class="codeph">DB_CREATE_FILE_DEST</code>和<code class="codeph">DB_CREATE_ONLINE_LOG_DEST_</code> <span class="italic"><code class="codeph">n</code></span>初始化参数设置为适当的值。如果主数据库和备用数据库使用相同的磁盘组名称，则可以简化维护和将来的角色转换。
                           </p>
                           <div class="infoboxnote" id="GUID-6FB574E5-2F3A-4C9E-A3F0-7C9154B0F540__GUID-C66C9A8E-0ED7-451F-90BE-7DE0925F7DE4">
                              <p class="notep1">注意：</p>
                              <p>如果在备用数据库上设置了OMF参数，则该备用数据库上的新文件始终创建为OMF，无论它们是如何在主数据库上创建的。因此，如果在<code class="codeph">DB_FILE_NAME_CONVERT</code> <code class="codeph">DB_CREATE_FILE_DEST</code>上设置了<code class="codeph">DB_FILE_NAME_CONVERT</code>和<code class="codeph">DB_CREATE_FILE_DEST</code>参数，则<code class="codeph">DB_CREATE_FILE_DEST</code>参数优先。
                              </p>
                           </div>
                        </li>
                        <li>
                           <p>将<code class="codeph">STANDBY_FILE_MANAGEMENT</code>初始化参数设置为<code class="codeph">AUTO</code> 。</p>
                        </li>
                        <li>
                           <p>根据需要配置Oracle Net以允许连接到备用数据库。</p>
                        </li>
                        <li>
                           <p>在说明配置重做传输认证<a href="creating-oracle-data-guard-physical-standby.html#GUID-0DC30726-3471-4588-BFE0-9CA0736328E2" title="Oracle Data Guard使用Oracle Net会话在Oracle Data Guard配置的成员之间传输重做数据和控制消息。">配置重做传输认证</a> 。
                           </p>
                        </li>
                        <li>
                           <p>在不挂载控制文件的情况下启动备用数据库实例。</p>
                        </li>
                     </ol>
                     <p>执行以下任务以创建备用数据库：</p>
                     <ol>
                        <li>
                           <p>如果备用数据库将使用Oracle ASM，则创建Oracle ASM实例（如果备用数据库系统上尚不存在）。</p>
                        </li>
                        <li>
                           <p>使用RMAN <code class="codeph">BACKUP</code>命令创建一个备份集，其中包含主数据库的数据文件，归档日志文件和备用控制文件的副本。
                           </p>
                        </li>
                        <li>
                           <p>使用RMAN <code class="codeph">DUPLICATE FOR STANDBY</code>命令将备份集中的数据文件，归档重做日志文件和备用控制文件复制到备用数据库的存储区域。
                           </p>
                           <p><code class="codeph">DUPLICATE FOR STANDBY</code>命令在备用实例上执行实际数据移动。如果备份集位于磁带上，则必须配置介质管理器，以便备用实例可以读取备份集。如果备份集位于磁盘上，备用实例必须可以通过网络文件存储（NFS）使其主路径名可用，或者将它们复制到备用系统并使用RMAN <code class="codeph">CATALOG BACKUPPIECE</code>命令来<code class="codeph">CATALOG BACKUPPIECE</code>备份<code class="codeph">CATALOG BACKUPPIECE</code> 。在备份之前对其进行编目。
                           </p>
                        </li>
                     </ol>
                     <p>成功完成这些步骤后，请继续执行“ <a href="creating-oracle-data-guard-physical-standby.html#GUID-AAA6D97B-A345-4825-A320-B662BB16E2ED" title="创建物理备用数据库并设置重做传输服务后，您可能希望验证数据库修改是否已成功从主数据库传输到备用数据库。">验证物理备用数据库是否正常执行”中</a>的步骤，以验证物理备用数据库的配置。
                     </p>
                     <p>要创建一个逻辑备用数据库，继续用中描述的备用数据库创建过程<a href="creating-oracle-data-guard-logical-standby.html#GUID-3666CA35-D993-44B6-8D70-A2B8B9EC8B2E" title="创建逻辑备用数据库涉及许多步骤，包括先决条件和创建后任务。">创建一个逻辑备用数据库</a> ，但有以下修改：</p>
                  </div>
                  <!-- class="section" -->
                  <ol>
                     <li class="stepexpand"><span>对于逻辑备用数据库，设置<code class="codeph">DB_CREATE_FILE_DEST</code>参数不会强制创建OMF文件名。但是，如果在主数据库上设置了此参数，则还必须在备用数据库上设置该参数。</span></li>
                     <li class="stepexpand"><span>在主系统上创建逻辑备用控制文件后，请勿使用操作系统命令将此文件复制到备用系统。而是使用RMAN <code class="codeph">RESTORE CONTROLFILE</code>命令将逻辑备用控制文件的副本还原到备用系统。</span></li>
                     <li class="stepexpand"><span>如果主数据库使用OMF文件，请使用RMAN更新备用数据库控制文件以使用在备用数据库上创建的新OMF文件。要执行此操作，请仅连接到备用数据库，如以下示例所示：</span><div><pre class="oac_no_warn" dir="ltr">&gt; RMAN TARGET sys @ lstdby目标数据库密码： <span class="italic">密码</span> RMAN&gt; CATALOG START WITH'+ stby_diskgroup'; RMAN&gt; SWITCH DATABASE COPY;</pre></div>
                     </li>
                  </ol>
                  <div class="section">
                     <p>成功完成这些步骤后，请继续执行<a href="creating-oracle-data-guard-logical-standby.html#GUID-68777C01-83F6-4CCF-9BA2-547ED180138D" title="使用ALTER DATABASE SQL语句打开新创建的逻辑备用数据库。">打开逻辑备用数据库中</a>的步骤以启动，恢复和验证逻辑备用数据库。
                     </p>
                     <div class="infoboxnotealso" id="GUID-6FB574E5-2F3A-4C9E-A3F0-7C9154B0F540__GUID-B73E1555-4AE7-45CA-B5FA-6A4F1C9FD3BA">
                        <p class="notep1">也可以看看：</p>
                     </div>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="creating-oracle-data-guard-physical-standby.html#GUID-B511FB6E-E3E7-436D-94B5-071C37550170" title="您可以使用异步重做传输和实时应用（默认的Oracle Data Guard配置）以最高性能模式手动创建物理备用数据库。">创建物理备用数据库</a></p>
                        </li>
                        <li>
                           <p><a href="creating-oracle-data-guard-logical-standby.html#GUID-3666CA35-D993-44B6-8D70-A2B8B9EC8B2E" title="创建逻辑备用数据库涉及许多步骤，包括先决条件和创建后任务。">创建逻辑备用数据库</a></p>
                        </li>
                        <li>
                           <p><a href="creating-data-guard-standby-database-using-RMAN.html#GUID-82731D59-A20F-45DD-A235-267B3B0E38C5" title="这些主题描述了如何使用Oracle Recovery Manager创建备用数据库。">使用Recovery Manager创建备用数据库</a></p>
                        </li>
                        <li>
                           <p>有关OMF的信息，请参见<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=ADMIN003" target="_blank"><span class="italic">“Oracle数据库管理员指南”</span></a></p>
                        </li>
                        <li>
                           <p>有关Oracle ASM的详细信息，请参见<a href="../ostmg/asm-intro.html#OSTMG036" target="_blank"><span class="italic">“Oracle自动存储管理管理员指南”</span></a></p>
                        </li>
                        <li>
                           <p>有关RMAN的信息，请参见<a href="../bradv/getting-started-rman.html#BRADV89346" target="_blank"><span class="italic">“Oracle数据库备份和恢复用户指南”</span></a></p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="SBYDB00930"></a><div class="props_rev_3"><a id="GUID-8F4E7807-6013-480F-8780-088F5639732F" name="GUID-8F4E7807-6013-480F-8780-088F5639732F"></a><h3 id="SBYDB-GUID-8F4E7807-6013-480F-8780-088F5639732F" class="sect3"><span class="enumeration_section">15.6</span>从主数据库上的丢失写入错误中恢复</h3>
               <div>
                  <p>在Oracle Data Guard配置中进行介质恢复期间，可以使用物理备用数据库检测主数据库上的丢失写入数据损坏错误。</p>
                  <div class="section">
                     <p>这是通过将存储在主数据库上的重做日志中的块的SCN与物理备用数据库上的块的SCN进行比较来完成的。如果主数据库上的块的SCN低于备用数据库上的SCN，则主数据库上存在丢失写入错误。</p>
                     <p>在这种情况下，如果在主数据库和备用数据库都启用了丢失写入检测（使用<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=REFRN10268" target="_blank"><code class="codeph">DB_LOST_WRITE_PROTECT</code></a>初始化参数设置），则备用数据库的恢复尝试会导致<code class="codeph">ORA-752</code>错误。如果未启用丢失写入检测，则恢复尝试会导致<code class="codeph">ORA-600</code> <code class="codeph">[3020]</code>错误。但是，并非所有<code class="codeph">ORA-600</code> <code class="codeph">[3020]</code>错误都是由于主数据库丢失造成的。因此，在遵循本节中给出的准则之前，请与Oracle支持代表合作，以确定<code class="codeph">ORA-600</code> <code class="codeph">[3020]</code>错误的根本原因是否确实是在主数据库上发生的丢失写入。另请参阅<a href="http://support.oracle.com" target="_blank"><code class="codeph">http://support.oracle.com</code></a>的My Oracle Support说明1265884.1中的“在待机恢复期间解析ORA-752或ORA-600 [3020]”。</p>
                     <div class="infoboxnote" id="GUID-8F4E7807-6013-480F-8780-088F5639732F__GUID-BE3D28CD-A912-4D5E-B4A8-43DD627E4E3D">
                        <p class="notep1">注意：</p>
                        <p>因为只有当主节点将块读入高速缓存并且稍后将相应的重做与备用数据块上的块进行比较时才会检测到丢失写入错误，所以在主数据库和备用数据库上可能还有未检测到的过时块尚未检测到已被阅读和验证。这些过时的块不会影响当前数据库的操作，因为在读取这些块之前，备用数据库会验证已用于备用数据库上当前应用的重做的SCN以进行查询或更新的所有块。</p>
                     </div>
                     <p>在备用数据库上检测到主要丢失写入错误时，将在备用数据库的警报文件中打印与每个过时块类似的以下一个或多个块错误消息：</p><pre class="oac_no_warn" dir="ltr">2006年12月12日星期二19:09:48 STANDBY REDO应用程序检测到主要数据库丢失了26块的磁盘写入，文件7在SCN 389667之后或之后没有重做可以用于恢复。 。。。
</pre><p>然后，警报文件显示备用数据库上引发了<code class="codeph">ORA-00752</code>错误，并取消了托管恢复：</p><pre class="oac_no_warn" dir="ltr">Slave退出ORA-752异常文件中的错误/oracle/log/diag/rdbms/dgstwrite2/stwrite2/trace/stwrite2_pr00_23532.trc：ORA-00752：恢复检测到数据块丢失写入ORA-10567：重做不一致数据块（文件＃7，块＃26）ORA-10564：表空间TBS_2 ORA-01110：数据文件7：'/ oracle / dbs / btbs_21.f'ORA-10561：块类型'TRANSACTION MANAGED DATA BLOCK'，数据对象＃57503。。。
</pre><p>然后，在警报文件中打印的SCN上，备用数据库将恢复到一致状态，而不会由此错误导致其数据文件损坏：</p><pre class="oac_no_warn" dir="ltr">恢复中断！在更改389569处将恢复的数据文件恢复为一致状态</pre><p>最后一条消息可能会在警报文件中显着出现，并且可能具有比块错误消息更低的SCN。此外，主数据库可以在没有可见错误的情况下运行，即使其数据文件可能已经被破坏。</p>
                     <p>从此类错误中恢复的建议过程是故障转移到物理备用数据库，如以下步骤所述。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-8F4E7807-6013-480F-8780-088F5639732F__GUID-F119048D-05BF-4EB5-A15E-10B99381F092">在主节点上检测到丢失写入后故障转移到物理备用的步骤</p>
                     <ol>
                        <li>
                           <p>关闭主数据库。在块错误消息中打印的SCN处或之后的所有数据都将丢失。</p>
                        </li>
                        <li>
                           <p>在备用数据库上发出以下SQL语句以将其转换为主数据库：</p><pre class="pre codeblock"><code>SQL&gt; ALTER DATABASE ACTIVATE STANDBY DATABASE;数据库改变了2006年12月12日星期二19:15:23更改数据库激活备用数据库ALTER DATABASE激活[PHYSICAL] STANDBY DATABASE（stwrite2）RESETLOGS恢复不完整后UNTIL CHANGE 389569重置resetlogs激活ID 612657558（0x24846996）在线日志/oracle/dbs/bt_log1.f ：线程1组1先前被清除在线日志/oracle/dbs/bt_log2.f：线程1组2先前被清除待机成为主要SCN：389567 Tue Dec 12 19:15:23 2006将恢复目标化身设置为3转换待机安装到主要安装。ACTIVATE STANDBY：完成 - 作为主数据库挂载的数据库（stwrite2）已完成：alter database activate standby database</code></pre></li>
                        <li>
                           <p>备份新的主要。立即执行备份是必要的安全措施，因为如果没有完整的数据库备份副本，则无法恢复故障转移后所做的更改。由于故障转移，原始主数据库无法再参与Oracle Data Guard配置，所有其他备用数据库现在都可以从新的主数据库接收和应用重做数据。</p>
                        </li>
                        <li>
                           <p>打开新的主数据库。</p>
                        </li>
                        <li>
                           <p>可选步骤是将故障主数据库重新创建为物理备用数据库。您可以使用在步骤3中在新主服务器上执行的数据库备份来执行此操作。（在这种情况下，您无法使用闪回数据库或Oracle Data Guard代理重新实例化旧的主数据库。）请注意，使用从新主服务器获取的备份创建的物理备用数据库具有与旧备用数据库相同的数据文件。因此，新备用数据库不会检测到旧备用数据库在激活之前所检测到的任何未检测到的丢失写入，因为新备用数据库会比较相同的块。检测到在主数据库或备用数据库上发生的任何新丢失的写入。</p>
                        </li>
                     </ol>
                     <div class="infoboxnotealso" id="GUID-8F4E7807-6013-480F-8780-088F5639732F__GUID-41AAD1E5-3136-42B0-9410-F339D21EAEBE">
                        <p class="notep1">也可以看看：</p>
                        <p>有关启用丢失写入检测的详细信息，请参见<a href="../bradv/configuring-rman-client-advanced.html#BRADV89476" target="_blank"><span class="italic">“Oracle数据库备份和恢复用户指南”</span></a></p>
                     </div>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
            <div class="sect2"><a id="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3" name="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3"></a><h3 id="SBYDB-GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3" class="sect3"><span class="enumeration_section">15.7</span>使用DBCOMP程序检测丢失的写入和其他不一致</h3>
               <div>
                  <p>您可以使用PL / SQL过程<code class="codeph">DBMS_DBCOMP.DBCOMP</code>来检测丢失的写入，还可以检测主数据库和物理备用数据库之间的不一致。
                  </p>
                  <div class="section"><code class="codeph">DBMS_DBCOMP.DBCOMP</code>过程比较主数据库和物理备用数据库上的相同数据块。该程序可以随时执行。（不要求启用<code class="codeph">DB_LOST_WRITE_PROTECT</code>初始化参数。）
                     <p>您可以通过查询<code class="codeph">V$SESSION_LONGOPS</code>视图来监视正在进行的块比较操作的进度。
                     </p>
                     <div class="infoboxnote" id="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3__GUID-1BB21F67-337B-48B0-8381-21D01498C7B4">
                        <p class="notep1">注意：</p>逻辑备用数据库，远程同步实例和级联备用数据库不能是<code class="codeph">DBMS_DBCOMP.DBCOMP</code>过程的目标数据库。
                     </div>
                  </div>
                  <!-- class="section" -->
                  <div class="p"><code class="codeph">DBMS_DBCOMP.DBCOMP</code>过程假定有一个主数据库和一个或多个物理备用数据库。在块比较之前，应至少安装数据库。
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>在以下示例情况中，假设存在具有唯一名称<code class="codeph">dgmain</code>的主数据库，并且该物理备用数据库名为<code class="codeph">dgmainb</code> ， <code class="codeph">dgmainc</code> ， <code class="codeph">dgmaind</code>等。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="example" id="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3__GUID-8A2CA33C-6955-43AB-B9C7-F36A21E831E7">
                     <p class="titleinexample">示例15-1主服务器和所有备用服务器已安装或打开，并且从主服务器执行DBCOMP</p>
                     <p>在这种情况下，当从主数据库执行<code class="codeph">DBCOMP</code>过程时，将在主数据库和每个物理备用数据库之间逐块比较指定的数据文件。例如，假设您执行以下查询：</p><pre class="pre codeblock"><code>SQL&gt; exec sys.dbms_dbcomp.dbcomp（'1'，'BlockCompare'，：retval）;</code></pre><p>生成的输出文件是<code class="codeph">BlockCompare_dgmainb_1</code>和<code class="codeph">BlockCompare_dgmainc_d_1</code> 。
                     </p>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3__GUID-E66C45D6-7FDB-442F-BA1A-546F272C8535">
                     <p class="titleinexample">示例15-2主要和所有备用数据库已安装或打开，并且从备用数据库执行DBCOMP</p>
                     <p>在这种情况下，当从其中一个备用数据库（例如， <code class="codeph">dgmainb</code> ）执行<code class="codeph">DBCOMP</code>过程时，仅在主数据库和特定备用数据库之间比较指定的数据文件。不考虑其他备用数据库。例如，假设您执行以下查询：</p><pre class="pre codeblock"><code>SQL&gt; exec sys.dbms_dbcomp.dbcomp（'1'，'BlockCompare'，：retval）;</code></pre><p>生成的输出文件是<code class="codeph">BlockCompare_dgmain_1</code> 。
                     </p>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3__GUID-1B692FED-1FF2-43D5-868A-FF75307AF422">
                     <p class="titleinexample">示例15-3主服务器已挂载或已打开，但并非所有备用服务器都已挂载，并且DBCOMP已从主服务器执行</p>
                     <p>在这种情况下，当在主数据库上执行<code class="codeph">DBCOMP</code>过程时，将在主数据库与已安装或打开的物理备用数据库之间比较指定的数据文件。对于既未安装也未打开的备用数据库，不执行任何操作。
                     </p>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3__GUID-1CAF3913-A155-41F5-B801-98BC69EC9EAF">
                     <p class="titleinexample">示例15-4主服务器已安装或打开，但并非所有备用服务器都已安装，并且DBCOMP已从待机状态执行</p>
                     <p>在这种情况下，将在执行<code class="codeph">DBCOMP</code>过程的主数据库和备用数据库之间比较指定的数据文件。
                     </p>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3__GUID-0D5CDFBC-A91E-4266-B3CA-DDC9D9F03391">
                     <p class="titleinexample">示例15-5主服务器未安装，但多个备用数据库已安装或打开</p>
                     <p>由于主数据库既未安装也未打开，因此<code class="codeph">DBCOMP</code>过程无法找到要比较的适当的主数据库和物理备用数据库对。不返回<code class="codeph">ORA</code>错误消息，但在相应的输出文件中打印出类似于以下内容的消息： <code class="codeph">Remote database is not in the primary role</code> 。
                     </p>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-A2FA9BA2-07F9-492E-8113-3FE8521EB3E3__GUID-445042B3-54E6-41E4-8BED-30914286675D">
                     <p class="titleinexample">示例15-6主要装载或打开，但没有安装或打开备用装置</p>
                     <p>由于未找到任何适当的主数据库和物理备用数据库，因此会在相应的输出文件中打印出一条消息，但不会返回任何<code class="codeph">ORA</code>错误。
                     </p>
                  </div>
                  <!-- class="example" -->
               </div>
               <div>
                  <div class="relinfo">
                     <p><strong>相关话题</strong></p>
                     <ul>
                        <li><a href="../arpls/DBMS_DBCOMP.html#ARPLS-GUID-4A248C6E-F52E-4841-B26B-139DD33012B1" target="_blank"><span><cite>Oracle数据库PL / SQL包和类型参考</cite></span></a></li>
                     </ul>
                  </div>
               </div>
            </div><a id="SBYDB4898"></a><div class="props_rev_3"><a id="GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" name="GUID-B734C79F-A2BB-43A5-89D7-7733089FB577"></a><h3 id="SBYDB-GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" class="sect3"><span class="enumeration_section">15.8</span>使用RMAN备份将失败的主数据库转换为备用数据库</h3>
               <div>
                  <p>要转换失败的主数据库，Oracle建议您在主数据库上启用闪回数据库功能，并根据需要执行以下过程之一。</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-C7C39BEC-A841-48D1-BE4B-9BB49C65B9C9" title="这些步骤将旧的主数据库作为物理备用数据库重新引入Oracle Data Guard配置。">将失败的主数据库闪回到物理备用数据库</a></p>
                     </li>
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-324EBFC6-5358-419A-AD4A-E457273E6560" title="这些步骤将旧的主数据库作为新的逻辑备用数据库重新引入Oracle Data Guard配置，而无需从新的主数据库正式实例化它。">将失败的主数据库闪回到逻辑备用数据库中</a></p>
                     </li>
                  </ul>
                  <p>这些部分中的过程描述了将失败的主数据库转换为物理或逻辑备用数据库的最快方法。但是，如果未在故障主数据库上启用闪回数据库，您仍可以使用故障主数据库的本地备份将故障主数据库转换为物理备用数据库或逻辑备用数据库，如以下主题中所述：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-433907DE-DF34-4CE6-989F-8F32F983FD99" title="这些步骤描述了如何使用RMAN备份将发生故障的主数据库转换为物理备用数据库。">使用RMAN备份将失败的主节点转换为物理备用节点</a></p>
                     </li>
                     <li>
                        <p><a href="examples-of-using-oracle-data-guard.html#GUID-D93BA2CD-A50B-43A5-91C7-A719998057FC" title="这些步骤描述了如何使用RMAN备份将发生故障的主数据库转换为逻辑备用数据库。">使用RMAN备份将失败的主节点转换为逻辑备用节点</a></p>
                     </li>
                  </ul>
               </div><a id="SBYDB4899"></a><div class="props_rev_3"><a id="GUID-433907DE-DF34-4CE6-989F-8F32F983FD99" name="GUID-433907DE-DF34-4CE6-989F-8F32F983FD99"></a><h4 id="SBYDB-GUID-433907DE-DF34-4CE6-989F-8F32F983FD99" class="sect4"><span class="enumeration_section">15.8.1</span>使用RMAN备份将故障主<span class="enumeration_section">节点</span>转换为物理备用<span class="enumeration_section">节点</span></h4>
                  <div>
                     <p>这些步骤描述了如何使用RMAN备份将发生故障的主数据库转换为物理备用数据库。</p>
                     <div class="section">
                        <p>此过程要求将旧主数据库的<code class="codeph">COMPATIBLE</code>初始化参数设置为至少11.0.0。
                        </p>
                        <ol>
                           <li>
                              <p>在新的主数据库上，发出以下查询以确定旧备用数据库成为新主数据库的SCN：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT TO_CHAR（STANDBY_BECAME_PRIMARY_SCN）FROM V $ DATABASE;</pre></li>
                           <li>
                              <p>使用在旧主服务器到达备用服务器成为新主服务器（ <code class="codeph">standby_became_primary_scn)</code>的SCN之前执行的备份来还原数据库。然后，执行时间点恢复以将旧主节点恢复到该相同点。
                              </p>
                              <p>发出以下RMAN命令：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; RUN {SET UNTIL SCN &lt;standby_became_primary_scn + 1&gt;; RESTORE DATABASE;恢复数据库; }</pre><p>使用用户管理的恢复，您可以先手动还原数据库。通常，在故障转移之前几个小时进行的备份就足够了。然后，您可以使用以下命令恢复发生故障的主节点：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; RECOVER DATABASE使用BACKUP CONTROLFILE UNTIL CHANGE  - &gt; &lt;standby_became_primary_scn + 1&gt;;</pre><p>与使用闪回数据库的重新实例化不同，此过程会向<code class="codeph">standby_became_primary_scn</code>添加一个。对于数据文件，闪回到SCN相当于恢复到SCN加一。
                              </p>
                           </li>
                           <li>
                              <p>在旧的主数据库上执行以下步骤：</p>
                              <ol type="a">
                                 <li>
                                    <p>在旧的主数据库上发出以下语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE CONVERT TO PHYSICAL STANDBY;</pre></li>
                                 <li>
                                    <p>关闭并重新启动数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SHUTDOWN IMMEDIATE; SQL&gt; STARTUP MOUNT;</pre></li>
                              </ol>
                           </li>
                           <li>
                              <p>发出以下命令：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN READ ONLY;</pre><p>此步骤的目标是使用字典检查将控制文件与数据库同步。执行此命令后，请检查警报日志中是否有字典检查建议的任何操作。通常，如果旧主服务器在故障转移期间未添加或删除数据文件，则不需要用户操作。</p>
                           </li>
                           <li>
                              <p>如果您已购买Oracle Active Data Guard选件的许可证并希望以主动查询模式运行物理备用数据库，请跳过此步骤。否则，将备用数据库置于装入状态。</p>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SHUTDOWN IMMEDIATE; SQL&gt; STARTUP MOUNT;</pre></li>
                           <li>
                              <p>在创建新的备用数据库之前，新的主数据库可能已停止将重做发送到远程目标。要重新启动重做传输服务，请在新的主数据库上执行以下步骤：</p>
                              <ol type="a">
                                 <li>
                                    <p>发出以下查询以查看归档目标的当前状态：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DEST_ID，DEST_NAME，STATUS，PROTECTION_MODE，DESTINATION， - &gt; ERROR，SRL来自V $ ARCHIVE_DEST_STATUS;</pre><pre class="oac_no_warn" dir="ltr"></pre></li>
                                 <li>
                                    <p>如有必要，启用目的地：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_ <span class="variable" translate="no">n</span> = ENABLE;</pre></li>
                                 <li>
                                    <p>执行日志切换以确保备用数据库开始从新的主数据库接收重做数据，并验证它是否已成功发送。</p>
                                    <div class="infoboxnote" id="GUID-433907DE-DF34-4CE6-989F-8F32F983FD99__GUID-D6298422-A64D-451F-887B-595FF2F7BEAC">
                                       <p class="notep1">注意：</p>
                                       <p>这是一个重要的步骤，以便旧主服务器成为新主服务器之后的新备用服务器。如果未执行此步骤，则旧主数据库可能会恢复到不正确的数据库分支。解决问题的唯一方法是再次转换旧的主要。</p>
                                    </div>
                                    <p>在SQL提示符下，输入以下语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM SWITCH LOGFILE; SQL&gt; SELECT DEST_ID，DEST_NAME，STATUS，PROTECTION_MODE，DESTINATION， - &gt; ERROR，SRL来自V $ ARCHIVE_DEST_STATUS;</pre><p>在新的备用数据库上，您可能还需要更改<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>初始化参数，以便重做传输服务不会将重做数据传输到其他数据库。如果在一个服务器参数文件（SPFILE）中使用<code class="codeph">VALID_FOR</code>属性设置主数据库角色和备用数据库角色，则可以跳过此步骤。通过这样做，Oracle Data Guard配置在角色转换后正常运行。
                                    </p>
                                 </li>
                              </ol>
                           </li>
                           <li>
                              <p>在新的物理备用数据库上启动Redo Apply，如下所示：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;</pre><p>一旦故障主数据库恢复并以备用角色运行，您可以选择执行切换以将数据库转换为其原始（故障前）角色。有关详细信息，请参阅<span class="q">“ <a href="managing-oracle-data-guard-role-transitions.html#GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF" title="这些步骤描述了如何切换到物理备用数据库。">执行切换到物理备用数据库</a> ”</span> 。
                              </p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB4900"></a><div class="props_rev_3"><a id="GUID-D93BA2CD-A50B-43A5-91C7-A719998057FC" name="GUID-D93BA2CD-A50B-43A5-91C7-A719998057FC"></a><h4 id="SBYDB-GUID-D93BA2CD-A50B-43A5-91C7-A719998057FC" class="sect4"><span class="enumeration_section">15.8.2</span>使用RMAN备份将失败的主<span class="enumeration_section">节点</span>转换为逻辑备用节点</h4>
                  <div>
                     <p>这些步骤描述了如何使用RMAN备份将发生故障的主数据库转换为逻辑备用数据库。</p>
                     <div class="section">
                        <ol>
                           <li>
                              <p>在新的主数据库上，发出以下查询以确定要将故障主数据库恢复到的SCN：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT APPLIED_SCN RECOVERY_SCN FROM V $ LOGSTDBY_PROGRESS;</pre><p>同样在新的主数据库上，确定用于处理存档日志的SCN，如下所示：</p>
                              <ol type="a">
                                 <li>
                                    <p>确保已归档所有备用重做日志。发出以下查询，查找要返回的值<code class="codeph">NONE</code> 。根据数据库的大小和需要归档的日志数量，可能需要一些时间才能返回状态<code class="codeph">NONE</code> 。
                                    </p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT PENDING_ROLE_CHANGE_TASKS FROM V $ DATABASE;</pre></li>
                                 <li>
                                    <p>在返回<code class="codeph">NONE</code>状态后，运行以下查询以检索用于处理存档日志的SCN，作为此恢复的一部分：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT VALUE ARCHIVE_SCN来自SYSTEM.LOGSTDBY $ PARAMETERS  - &gt; WHERE NAME ='STANDBY_BECAME_PRIMARY_SCN';</pre></li>
                              </ol>
                           </li>
                           <li>
                              <p>从故障主数据库中删除在故障转移操作时或故障转移后创建的所有存档日志。如果故障主数据库与备用数据库隔离，则可能存在与当前主数据库不一致的不同存档日志。为确保永远不会应用这些不同的存档日志，必须从备份和快速恢复区域中删除它们。您可以使用以下RMAN命令从快速恢复区域中删除相关的存档日志：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt;从SCN ARCHIVE_SCN删除FORCE ARCHIVELOG;</pre><p>删除后，这些不同的日志和后续事务永远无法恢复。</p>
                              <p></p>
                           </li>
                           <li>
                              <p>在新的主数据库上，发出以下查询以确定在从备份恢复之前必须复制到故障主数据库的最小日志文件集：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT file_name FROM DBA_LOGSTDBY_LOG WHERE next_change＃&gt; ARCHIVE_SCN;</pre><p>检索所需的备用日志，将备份集复制到新备用数据库并将其还原到新的备用快速恢复区域。由于这些日志来自备用重做日志，因此它们不属于备用标准存档。RMAN实用程序能够使用部分文件名从正确的位置检索文件。</p>
                              <p>以下是RMAN <code class="codeph">BACKUP</code>命令的示例用法：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt;备份作为复制设备类型磁盘格式'/ tmp / test /％U'&gt; ARCHIVELOG LIKE'&lt;来自上面的部分文件名&gt;％';</pre><p>以下是RMAN <code class="codeph">RESTORE</code>命令的示例用法：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; CATALOG START WITH'/ tmp / test'; RMAN&gt;从序列中恢复存档33直到序列35;</pre></li>
                           <li>
                              <p>恢复所有原始主数据文件的备份并恢复到<code class="codeph">RECOVERY_SCN + 1</code> 。Oracle建议您利用当前控制文件。
                              </p>
                              <ol type="a">
                                 <li>
                                    <p>以受限模式启动数据库以保护其免受恶意事务的影响，直到在打开数据库后可以发出<code class="codeph">GUARD ALL</code>命令。
                                    </p>
                                 </li>
                                 <li>
                                    <p>使用备份还原失败的主数据库的数据文件。</p>
                                 </li>
                                 <li>
                                    <p>关闭闪回数据库（如果已启用）（ <code class="codeph">USING BACKUP CONTROLFILE</code>子句必需）。
                                    </p>
                                 </li>
                                 <li>
                                    <p>在SQL * Plus中对<code class="codeph">RECOVERY_SCN +1</code>执行时间点恢复。
                                    </p>
                                 </li>
                              </ol>
                              <p>无论是使用当前控制文件还是备份控制文件，都必须指定<code class="codeph">USING BACKUP CONTROLFILE</code>子句以允许您指向要还原的存档日志。否则，恢复过程可能会尝试访问联机重做日志，而不是步骤3中检索的日志。当系统提示您输入在步骤3中检索的序列时，请确保指定已还原的归档日志副本的文件名，如下所示：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; RECOVER DATABASE UNTIL CHANGE RECOVERY_SCN + 1使用BACKUP CONTROLFILE;</pre></li>
                           <li>
                              <p>使用RESETLOGS选项打开数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN RESETLOGS;</pre></li>
                           <li>
                              <p>启用Database Guard</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE GUARD ALL;</pre></li>
                           <li>
                              <p>创建指向新主数据库的数据库链接并启动SQL Apply：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; CREATE PUBLIC DATABASE LINK <span class="italic">myLink</span> - &gt;通过<span class="italic">密码</span>连接到系统 - &gt;使用' <span class="italic">新主数据库</span>的<span class="italic">服务名</span> ';</pre><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE START LOGICAL STANDBY应用新的主要<span class="italic">myLink</span> ;</pre><p>此时，您可以禁用受限会话（ <code class="codeph">ALTER SYSTEM DISABLE RESTRICTED SESSION</code> ），或者，如果您需要重新启动数据库以从步骤4c重新启用闪回，请让此重新启动关闭<code class="codeph">RESTRICTED SESSION</code> 。</p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="SBYDB5134"></a><div class="props_rev_3"><a id="GUID-FCDB44CE-FBFE-43BB-88E3-74267B38FE70" name="GUID-FCDB44CE-FBFE-43BB-88E3-74267B38FE70"></a><h3 id="SBYDB-GUID-FCDB44CE-FBFE-43BB-88E3-74267B38FE70" class="sect3"><span class="enumeration_section">15.9</span>在不重新创建物理备用数据库的情况下更改主要字符集</h3>
               <div>
                  <p>Oracle Data Guard允许您更改主数据库的数据库字符集和国家字符集，而无需在配置中重新创建任何物理备用数据库。</p>
                  <p>在执行主数据库的字符集转换时，您可以继续使用物理备用数据库，同时将中断降至最低。</p>
                  <p>字符集迁移过程包括准备步骤，例如扫描可能的问题和确定解决方法。在执行这些准备步骤期间，Oracle Data Guard配置可以保持不变，并且不需要额外的步骤来维护物理备用。在准备步骤完成之后，执行实际转换，其可能涉及系统数据（元数据）和用户数据的改变。必须在转换过程中运行Oracle Data Guard特有的几个过程。运行这些过程的步骤散布着由Database Migration Assistant for Unicode（DMU）或其他适当的字符集迁移工具执行的步骤。</p>
                  <p>有关此过程中涉及的步骤的详细说明，请参阅<a href="http://support.oracle.com" target="_blank"><code class="codeph">http://support.oracle.com</code></a> My Oracle Support说明1124165.1。</p>
               </div>
            </div><a id="SBYDB5448"></a><div class="props_rev_3"><a id="GUID-8D948A24-A3B7-4E4F-917A-00B047CF3CAF" name="GUID-8D948A24-A3B7-4E4F-917A-00B047CF3CAF"></a><h3 id="SBYDB-GUID-8D948A24-A3B7-4E4F-917A-00B047CF3CAF" class="sect3"><span class="enumeration_section">15.10</span>在主服务器上的PDB PITR或PDB闪回后待机所需的操作</h3>
               <div>
                  <p>在主服务器上执行PDB PITR或PDB闪回后，您可以还原PDB或闪回备用服务器上的PDB以使备用服务器跟随主服务器。</p>
                  <div class="section">
                     <p></p>
                     <p>使用Oracle Database Release 19c，如果备用数据库处于装载模式并且启用了闪回数据库，则可能不需要执行任何操作。在常见情况下，如果有足够的闪回数据，则备用数据库会自动闪回，以便备用数据库继续跟随主数据库。</p>
                     <p>在所有其他情况下，当在主服务器上执行PDB PITR或PDB闪回，并且第一次遇到操作开始的重做时，备用服务器上的MRP终止，错误<code class="codeph">ORA-39874</code> ，然后是补充错误<code class="codeph">ORA-39873</code> 。以下是警报日志中可能出现的消息示例：</p><pre class="oac_no_warn" dir="ltr">由于可插拔数据库打开resetlog标记，可插拔数据库PDB1的恢复已中止。要继续恢复，请将此PDB的所有数据文件恢复到低于1437261的检查点SCN或11/15/2012 16:38:49之前的时间戳，然后重新启动恢复MRP0：后台介质恢复已终止，错误为39874 ORA-39874：可插拔数据库PDB1恢复暂停ORA-39873：将所有数据文件恢复到低于1437261的检查点SCN。
</pre><p></p>
                     <p>使用Oracle Database Release 19c，如果备用数据库已打开且启用了闪回数据库，则可以将备用数据库置于装载模式并启动备用数据库恢复。MRP试图允许备用数据库跟随主数据库，触发备用数据库的自动闪回。如果成功，如警报日志中所报告的那样，您只需要跟进打开Active Data Guard实例。如果未触发自动闪回，或者自动闪回未导致主数据库之后的备用数据库，则可以执行本节中描述的手动步骤。</p>
                     <p>在备用数据库上的介质恢复可以继续进行之前，必须还原该PDB的所有数据文件。您可以通过两种方式执行此操作：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>如果在备用数据库上启用了闪回，则可以在备用数据库上使用PDB闪回，然后重新启动备用数据库管理恢复。请参阅下面的“启用闪回时执行恢复”。</p>
                        </li>
                        <li>
                           <p>如果在备用数据库上未启用闪回，则可以从在主数据库上恢复PDB的时间点之前的备份进行恢复。请参阅下面的“未启用闪回时执行恢复”。</p>
                        </li>
                     </ul>
                     <p>无论采用哪种方法，已经在主服务器上运行PDB PITR或闪回的PDB都无法在备用数据库上打开，直到它赶上备用数据库的其余部分。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-8D948A24-A3B7-4E4F-917A-00B047CF3CAF__GUID-0BC694A6-E1E8-417C-88EE-4C284A864EE3">启用闪回时执行恢复</p>
                     <p>如果在备用数据库上启用了闪回，则可以在备用数据库上闪回PDB，然后重新启动备用管理恢复。</p>
                     <ol>
                        <li>
                           <p>确定受影响的PDB和PITR SCN。</p>
                           <p>对于哪些恢复被叫停的PDB中的名称显示在<code class="codeph">ORA-39874</code>消息和PITR SCN在所示<code class="codeph">ORA-39873</code>消息。
                           </p>
                        </li>
                        <li>
                           <p>如果备用数据库仍处于打开状态，请将其关闭：</p><pre class="pre codeblock"><code>SQL&gt; ALTER DATABASE CLOSE;</code></pre></li>
                        <li>
                           <p>闪回备用数据库上的可插拔数据库：</p><pre class="pre codeblock"><code>SQL&gt; FLASHBACK PLUGGABLE DATABASE pdb1 TO SCN 1437260;</code></pre><p><code class="codeph">FLASHBACK PLUGGABLE DATABASE</code>命令的SCN是<code class="codeph">1437260</code> ，而不是<code class="codeph">1437261</code> ，如下例所示，因为<code class="codeph">TO SCN</code>和<code class="codeph">UNTIL SCN</code>具有不同的语义。
                           </p>
                        </li>
                        <li>
                           <p>在备用数据库上重启介质恢复：</p><pre class="pre codeblock"><code>SQL&gt; RECOVER MANAGED STANDBY DATABASE DISCONNECT;</code></pre></li>
                     </ol>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-8D948A24-A3B7-4E4F-917A-00B047CF3CAF__GUID-92326390-DCFC-482A-B254-03E7B9B56BC9">未启用闪回时执行恢复</p>
                  </div>
                  <!-- class="section" -->
                  <ol>
                     <li class="stepexpand"><span>确定受影响的PDB和PITR SCN。</span><div>
                           <p>对于哪些恢复被叫停的PDB中的名称显示在<code class="codeph">ORA-39874</code>消息和PITR SCN在所示<code class="codeph">ORA-39873</code>消息。
                           </p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>如果备用数据库仍处于打开状态，请将其关闭：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE CLOSE;</pre></div>
                     </li>
                     <li class="stepexpand"><span>恢复PDB数据文件：</span><div><pre class="oac_no_warn" dir="ltr">RMAN&gt; RESTORE PLUGGABLE DATABASE pdb1 UNTIL SCN 1437261;</pre><p><code class="codeph">UNTIL</code> <code class="codeph">SCN</code>语法允许RMAN自动选择要从中还原的合适备份。在备用数据库中恢复数据文件后，重新启动MRP以继续应用重做日志。
                           </p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>在备用数据库上重启介质恢复：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; RECOVER MANAGED STANDBY DATABASE DISCONNECT;</pre></div>
                     </li>
                  </ol>
                  <div class="section">
                     <div class="infoboxnotealso" id="GUID-8D948A24-A3B7-4E4F-917A-00B047CF3CAF__GUID-8119C250-5269-41DF-8163-BF40F3E3AD7C">
                        <p class="notep1">也可以看看：</p>
                        <p></p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>有关执行PDB的时间点<a href="../bradv/rman-performing-flashback-dbpitr.html#BRADV640" target="_blank"><span class="italic">恢复的</span></a>详细信息，请参见<a href="../bradv/rman-performing-flashback-dbpitr.html#BRADV640" target="_blank"><span class="italic">“Oracle数据库备份和恢复用户指南”</span></a></p>
                           </li>
                        </ul>
                     </div>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>