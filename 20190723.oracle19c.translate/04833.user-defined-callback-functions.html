<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="Oracle Call Interface can execute user-specific code in addition to OCI calls."></meta>
      <meta name="description" content="Oracle Call Interface can execute user-specific code in addition to OCI calls."></meta>
      <title>OCI中用户定义的回调函数</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Programmer&#39;s Guide"></meta>
      <meta property="og:description" content="Oracle Call Interface can execute user-specific code in addition to OCI calls."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Programmer&#39;s Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="oracle-call-interface-programmers-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-01-14T08:46:00-08:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="1996, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96204-01"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="notification-streams-advanced-queuing.html" title="Previous" type="text/html"></link>
      <link rel="next" href="performance-topics.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Oracle Call Interface Programmer&#39;s Guide"></meta>
    <meta name="dcterms.isVersionOf" content="LNOCI"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="notification-streams-advanced-queuing.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="performance-topics.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">程序员指南</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">OCI中用户定义的回调函数</li>
            </ol>
            <a id="GUID-215B52BB-6769-4A53-A2DC-EDB36AE031B7" name="GUID-215B52BB-6769-4A53-A2DC-EDB36AE031B7"></a>
            
            <h2 id="LNOCI-GUID-215B52BB-6769-4A53-A2DC-EDB36AE031B7" class="sect2">OCI中的<span class="enumeration_chapter">14个</span>用户定义的回调函数</h2>
         </header>
         <div class="ind">
            <div>
               <p>除OCI调用外，Oracle Call Interface还可以执行特定于用户的代码。</p>
               <p>您可以将此功能用于：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p>添加跟踪和性能测量代码，使用户能够调整其应用程序</p>
                  </li>
                  <li>
                     <p>为特定OCI调用执行预处理或后处理代码</p>
                  </li>
                  <li>
                     <p>通过使用Oracle数据库的本机OCI接口访问其他数据源，并指示OCI调用使用非Oracle数据源的用户回调</p>
                  </li>
               </ul>
               <p>OCI回调功能支持在执行OCI调用之前或之后调用用户代码。它还允许执行用户定义的代码，而不是执行OCI代码。</p>
               <p>可以动态注册用户回调代码，而无需修改应用程序的源代码。在<code class="codeph">OCIEnvCreate()</code>调用期间初始化环境句柄之后，通过加载最多五个用户创建的动态链接库来实现动态注册。这些用户创建的库（例如Windows上的动态链接库（DLL）或Solaris上的共享库）将透明地向应用程序注册所选OCI调用的用户回调。
               </p>
               <div class="section">
                  <p class="subhead1" id="GUID-215B52BB-6769-4A53-A2DC-EDB36AE031B7__GUID-44493DA1-4EFC-4A2D-9D53-E436791FB95B">样品申请</p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p>有关说明OCI用户回调功能的完整演示程序的列表，请参阅附录B.</p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <div class="p">本节包括以下主题：<ul style="list-style-type:disc">
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-37001800-DC08-4253-8958-4F51A734FCE0" title="应用程序可以使用OCIUserCallbackRegister（）函数注册用户回调库。">关于在OCI中注册用户回调</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-163FF0B1-BAA9-4300-BA7C-170AAF0960ED" title="提供有关使用外部过程的OCI回调的其他参考信息。">外部程序的OCI回调</a></p>
                        </li>
                     </ul>
                  </div>
                  <div class="infoboxnotealso" id="GUID-215B52BB-6769-4A53-A2DC-EDB36AE031B7__GUID-E2BF4536-82DD-444A-8328-29435C560919">
                     <p class="notep1">也可以看看：</p>
                     <p><a href="connect-authorize-and-initialize-functions.html#GUID-16BDA1F1-7DAF-41CA-9EE1-C9A4CB467244" title="创建并初始化OCI函数的环境句柄。">OCIEnvCreate（）</a></p>
                  </div>
               </div>
               <!-- class="section" -->
            </div>
            <div class="props_rev_3"><a id="GUID-37001800-DC08-4253-8958-4F51A734FCE0" name="GUID-37001800-DC08-4253-8958-4F51A734FCE0"></a><h3 id="LNOCI-GUID-37001800-DC08-4253-8958-4F51A734FCE0" class="sect3"><span class="enumeration_section">14.1</span>关于在OCI中注册用户回调</h3>
               <div>
                  <p>应用程序可以使用<code class="codeph">OCIUserCallbackRegister()</code>函数注册用户回调库。
                  </p>
                  <p>回调在环境句柄的上下文中注册。应用程序可以使用<code class="codeph">OCIUserCallbackGet()</code>函数检索有关使用句柄注册的回调的信息。
                  </p>
                  <p>用户定义的回调是针对OCI调用和环境句柄注册的子例程。它可以指定为条目回调，替换回调或退出回调。</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>如果是条目回调，则在程序进入OCI功能时调用它。</p>
                     </li>
                     <li>
                        <p>在条目回调之后执行替换回调。如果替换回调返回值<code class="codeph">OCI_CONTINUE</code> ，则执行后续替换回调或正常的OCI特定代码。如果替换回调返回<code class="codeph">OCI_CONTINUE</code>以外的任何内容，则后续替换回调和OCI代码不会执行。
                        </p>
                     </li>
                     <li>
                        <p>在替换回调返回<code class="codeph">OCI_CONTINUE</code>其他<code class="codeph">OCI_CONTINUE</code>或OCI函数成功执行之后，程序控制将转移到退出回调（如果已注册）。
                        </p>
                     </li>
                  </ul>
                  <p>如果替换或退出回调返回<code class="codeph">OCI_CONTINUE</code>以外的任何内容，则从关联的OCI调用返回回调的返回码。
                  </p>
                  <p>当无效句柄或无效上下文传递给它时，用户回调可以返回<code class="codeph">OCI_INVALID_HANDLE</code> 。
                  </p>
                  <div class="infoboxnote" id="GUID-37001800-DC08-4253-8958-4F51A734FCE0__GUID-BE2072F7-E5DD-464D-98FF-B94366948A29">
                     <p class="notep1">注意：</p>
                     <p>如果任何回调返回<code class="codeph">OCI_CONTINUE</code>以外的任何内容，则该返回代码将传递给后续回调。如果更换或退出回调函数返回以外的返回码<code class="codeph">OCI_CONTINUE</code> ，那么最终的（不<code class="codeph">OCI_CONTINUE</code> ）返回代码从OCI调用返回。
                     </p>
                  </div>
                  <div class="p">本节包括以下主题：<ul style="list-style-type:disc">
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-7CC81F1D-0EB3-464A-B87F-CF4F18BCBA7C" title="使用OCIUserCallbackRegister（）调用注册用户回调。">OCIUserCallbackRegister</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-7C13E29F-1300-47C4-96BE-142756FD6F61" title="有关用户回调函数的详细信息。">用户回调函数</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-4815D8E1-B24F-4ADF-98D0-934CFC4192F8" title="显示用户回调的控制流。">用户回调控制流程</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-151E2492-7F00-497F-B253-0F789E405BFB" title="如果回调是OCI代码的完全替换，那么它们通常在调用上下文中维护它们自己的错误信息，并使用它来返回OCIErrorGet（）调用的替换回调的bufp和errcodep参数中的错误信息。">用户回调OCIErrorGet（）</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-774331BE-507E-43B5-ABAC-F93A861C9F9C" title="如果条目回调想要向OCI调用的调用者返回错误，则它必须注册替换或退出回调。">条目回调中的错误</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-C1E8C023-F0D4-4C0A-8585-DA6CCA0DDF65" title="因为期望用户回调用于监视OCI行为或访问其他数据源，所以希望回调的注册是透明且非侵入地完成的。">动态回拨注册</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-C58991CA-395F-4DCC-9795-D688931DFFB5" title="ORA_OCI_UCBPKG变量可以包含以分号分隔的包名列表。包按照列表中指定的顺序加载。">关于加载多个包</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-46F2412A-F84C-4C2A-983A-BF0AAA36647F" title="包源必须提供两个功能。">包格式</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-9E6DD6F6-FF2A-49B6-8832-3651A4C7502E" title="用户回调可以在应用程序本身中静态注册，也可以在运行时在DLL中动态注册。">用户回调链接</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-63F27A12-2778-43A0-918F-35F310E0EAA6" title="由于Oracle数据库是访问的主要数据库软件，因此应用程序可以利用OCI接口通过使用用户回调来访问非Oracle数据。">关于通过OCI访问其他数据源</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-1E75F3F2-673D-4D80-B9C3-89119D47CCB9" title="详细说明了对回调函数的限制。">回调函数的限制</a></p>
                        </li>
                        <li>
                           <p><a href="user-defined-callback-functions.html#GUID-A817AC07-545A-4C3B-A155-027D1889CA38" title="显示使用OCI回调的示例。">OCI回调示例</a></p>
                        </li>
                     </ul>
                  </div>
                  <div class="infoboxnotealso" id="GUID-37001800-DC08-4253-8958-4F51A734FCE0__GUID-9FBD9D48-595E-494F-A553-D13E3AC2B6F2">
                     <p class="notep1">也可以看看：</p>
                     <p><a href="miscellaneous-functions.html#GUID-2249B3FF-5E24-40AE-B310-EA63DBF37263" title="确定为句柄注册的回调。">OCIUserCallbackGet（）</a>和<a href="miscellaneous-functions.html#GUID-A11D635A-806B-445E-BDCF-F145E86232CF" title="注册用户创建的回调函数。">OCIUserCallbackRegister（）</a></p>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-7CC81F1D-0EB3-464A-B87F-CF4F18BCBA7C" name="GUID-7CC81F1D-0EB3-464A-B87F-CF4F18BCBA7C"></a><h4 id="LNOCI-GUID-7CC81F1D-0EB3-464A-B87F-CF4F18BCBA7C" class="sect4"><span class="enumeration_section">14.1.1</span> OCIUserCallbackRegister</h4>
                  <div>
                     <p>使用OCIUserCallbackRegister（）调用注册用户回调。</p>
                     <p>目前， <code class="codeph">OCIUserCallbackRegister()</code>仅在环境句柄上注册。typedef <code class="codeph">OCIUserCallback</code>的用户回调函数与其OCI函数代码<span class="italic">fcode</span>标识的OCI调用的上下文一起注册。回调的类型，无论是输入，替换还是退出，都由<span class="italic">when</span>参数指定。
                     </p>
                     <p>例如，通过使用以下参数调用<code class="codeph">OCIUserCallbackRegister()</code>函数，针对<code class="codeph">OCIStmtPrepare2()</code>调用的环境句柄<code class="codeph">hndlp</code>注册<code class="codeph">stmtprep_entry_dyncbk_fn</code>条目回调函数及其上下文<code class="codeph">dynamic_context</code> 。
                     </p><pre class="oac_no_warn" dir="ltr">OCIUserCallbackRegister（hndlp，OCI_HTYPE_ENV，errh，stmtprep_entry_dyncbk_fn，dynamic_context，OCI_FNCODE_STMTPREPARE，OCI_UCBTYPE_ENTRY（OCIUcb *）NULL）;</pre><div class="infoboxnotealso" id="GUID-7CC81F1D-0EB3-464A-B87F-CF4F18BCBA7C__GUID-59A8DFDF-95BC-4149-B6A2-9651C72A08B2">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><a href="miscellaneous-functions.html#GUID-A11D635A-806B-445E-BDCF-F145E86232CF" title="注册用户创建的回调函数。">OCIUserCallbackRegister（）</a></p>
                           </li>
                           <li>
                              <p><a href="statement-functions.html#GUID-E6C1DC67-D464-4D2A-9F19-737423D31779" title="准备SQL或PL / SQL语句以便执行。">OCIStmtPrepare2（）</a></p>
                           </li>
                        </ul>
                        <p></p>
                     </div>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-7C13E29F-1300-47C4-96BE-142756FD6F61" name="GUID-7C13E29F-1300-47C4-96BE-142756FD6F61"></a><h4 id="LNOCI-GUID-7C13E29F-1300-47C4-96BE-142756FD6F61" class="sect4"><span class="enumeration_section">14.1.2</span>用户回调函数</h4>
                  <div>
                     <p>有关用户回调函数的详细信息。</p>
                     <p>用户回调函数必须使用以下语法：</p><pre class="oac_no_warn" dir="ltr">typedef sword（* OCIUserCallback）（void * ctxp，/ *用户回调的上下文* / void * hndlp，回调的/ *句柄，现在的* / ub4类型的env句柄，/ *此版本的OCI_HTYPE_ENV） * / ub4 fcode，/ * OCI调用的函数代码* / ub1何时，/ *回调类型，入口或出口* / sword returnCode，/ * OCI返回码* / ub4 * errnop，/ * Oracle错误号* / va_list arglist）; / * oci调用的参数* /</pre><p>除了<code class="codeph">OCIUserCallbackRegister()</code>调用中描述的参数之外，还使用返回码， <span class="italic">errnop</span>以及原型定义声明的原始OCI的所有参数调用回调。
                     </p>
                     <p>返回代码始终作为<code class="codeph">OCI_SUCCESS</code>传入，并且<code class="codeph">*errnop</code>始终作为0传递给第一个条目回调。需要注意的是<code class="codeph">*errnop</code>指的是内容<code class="codeph">errnop</code>因为<code class="codeph">errnop</code>是一个IN / OUT参数。
                     </p>
                     <p>如果回调不想更改OCI返回码，则它必须返回<code class="codeph">OCI_CONTINUE</code> ，并忽略<code class="codeph">*errnop</code>返回的值。但是，如果回调返回除<code class="codeph">OCI_CONTINUE</code>之外的任何返回码，则最后返回的返回码将成为该调用的返回码。此时， <code class="codeph">*errnop</code>返回的值在错误句柄中设置，或者在环境句柄中设置，如果由于缺少某些OCI调用（如<code class="codeph">OCIHandleAlloc()</code>的错误句柄而在环境句柄中返回错误信息。
                     </p>
                     <p>对于替换回调， <code class="codeph">returnCode</code>是前一个回调或OCI调用的非<code class="codeph">OCI_CONTINUE</code>返回码，而<code class="codeph">*errnop</code>是错误句柄中返回的错误号的值。这允许后续回调在需要时更改返回码或错误信息。
                     </p>
                     <p>替换回调的处理方式不同，如果它返回<code class="codeph">OCI_CONTINUE</code>以外的任何内容，则会绕过后续替换回调和OCI代码并处理跳转到退出回调。
                     </p>
                     <p>请注意，如果替换回调返回<code class="codeph">OCI_CONTINUE</code>以允许处理OCI代码，则忽略条目回调中的返回代码。
                     </p>
                     <p>OCI调用的所有原始参数都作为变量参数传递给回调，并且回调必须使用<span class="italic">va_arg</span>宏检索它们。回调演示程序提供了示例。
                     </p>
                     <p>可以注册空值以取消注册回调。也就是说，如果<code class="codeph">OCIUserCallbackRegister()</code>调用中的回调值（ <code class="codeph">OCIUserCallback()</code> ）为<code class="codeph">NULL</code> ，则取消注册用户回调。
                     </p>
                     <p>使用线程安全模式时，OCI程序在调用用户回调之前获取所有互斥锁。</p>
                     <div class="infoboxnotealso" id="GUID-7C13E29F-1300-47C4-96BE-142756FD6F61__GUID-C094DAA3-1F93-4BFA-A952-99B029BEFCA7">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><a href="oci-demo-programs.html#GUID-75E18629-0C54-4495-A747-AFB346034F26" title="列出示例程序，其中包含示例代码，用于演示OCI句柄的分配和使用。">OCI示范计划</a></p>
                           </li>
                           <li>
                              <p><a href="miscellaneous-functions.html#GUID-A11D635A-806B-445E-BDCF-F145E86232CF" title="注册用户创建的回调函数。">OCIUserCallbackRegister（）</a></p>
                           </li>
                           <li>
                              <p><a href="handle-and-descriptor-functions.html#GUID-C5BF55F7-A110-4CB5-9663-5056590F12B5" title="返回指向已分配和初始化句柄的指针。">OCIHandleAlloc（）</a></p>
                           </li>
                        </ul>
                     </div>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-4815D8E1-B24F-4ADF-98D0-934CFC4192F8" name="GUID-4815D8E1-B24F-4ADF-98D0-934CFC4192F8"></a><h4 id="LNOCI-GUID-4815D8E1-B24F-4ADF-98D0-934CFC4192F8" class="sect4"><span class="enumeration_section">14.1.3</span>用户回调控制流程</h4>
                  <div>
                     <p>显示用户回调的控制流。</p>
                     <p><a href="user-defined-callback-functions.html#GUID-4815D8E1-B24F-4ADF-98D0-934CFC4192F8__CACJAFAG">例14-1</a>显示了描述典型OCI调用的整体处理的伪代码。
                     </p>
                     <div class="example" id="GUID-4815D8E1-B24F-4ADF-98D0-934CFC4192F8__CACJAFAG">
                        <p class="titleinexample">例14-1描述典型OCI调用的整体处理的伪代码</p><pre class="oac_no_warn" dir="ltr">OCIXyzCall（）{获取句柄上的互斥; retCode = OCI_SUCCESS; errno = 0;对于所有ENTRY回调做{EntryretCode =（* entryCallback）（...，retcode，＆errno，...）; if（retCode！= OCI_CONTINUE）{在错误句柄或环境句柄中设置errno; retCode = EntryretCode;对于所有REPLACEMENT回调做{retCode =（* replacementCallback）（...，retcode，＆errno，...）; if（retCode！= OCI_CONTINUE）{在错误句柄或环境句柄中设置errno goto executeEXITCallback; retCode =返回XyzCall的代码; / *正常处理OCI调用* / errno =错误句柄或env句柄的错误号; executeExitCallback：对于所有EXIT回调，执行{exitRetCode =（* exitCallback）（...，retCode，＆errno，...）; if（exitRetCode！= OCI_CONTINUE）{在错误句柄或环境句柄中设置errno; retCode = exitRetCode;释放互斥; return retCode}</pre></div>
                     <!-- class="example" -->
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-151E2492-7F00-497F-B253-0F789E405BFB" name="GUID-151E2492-7F00-497F-B253-0F789E405BFB"></a><h4 id="LNOCI-GUID-151E2492-7F00-497F-B253-0F789E405BFB" class="sect4"><span class="enumeration_section">14.1.4</span> OCIErrorGet（）的用户回调</h4>
                  <div>
                     <p>如果回调是OCI代码的完全替换，那么它们通常在调用上下文中维护它们自己的错误信息，并使用它来返回<code class="codeph">OCIErrorGet()</code>调用的替换回调的<code class="codeph">bufp</code>和<code class="codeph">errcodep</code>参数中的错误信息。
                     </p>
                     <p></p>
                     <p>但是，如果回调要么部分覆盖OCI代码，要么仅进行其他后处理，那么它们可以使用退出回调来修改<code class="codeph">OCIErrorGet()</code>调用的错误文本和<code class="codeph">errcodep</code>参数，以及它们自己的错误消息和错误号。请注意，传入退出回调的<code class="codeph">*errnop</code>是错误或环境句柄中的错误号。
                     </p>
                     <div class="infoboxnotealso" id="GUID-151E2492-7F00-497F-B253-0F789E405BFB__GUID-01E109A7-B4FD-40E1-8E2A-26DCC2C9DF5C">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="miscellaneous-functions.html#GUID-4B99087C-74F6-498A-8310-D6645172390A" title="返回错误消息和Oracle数据库错误代码。">OCIErrorGet（）</a></p>
                     </div>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-774331BE-507E-43B5-ABAC-F93A861C9F9C" name="GUID-774331BE-507E-43B5-ABAC-F93A861C9F9C"></a><h4 id="LNOCI-GUID-774331BE-507E-43B5-ABAC-F93A861C9F9C" class="sect4"><span class="enumeration_section">14.1.5</span>条目回调中的错误</h4>
                  <div>
                     <p>如果条目回调想要向OCI调用的调用者返回错误，则它必须注册替换或退出回调。</p>
                     <p>这是因为如果执行OCI代码，则忽略条目回调中的错误代码。因此，条目回调必须通过其自己的上下文将错误传递给替换或退出回调。</p>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-C1E8C023-F0D4-4C0A-8585-DA6CCA0DDF65" name="GUID-C1E8C023-F0D4-4C0A-8585-DA6CCA0DDF65"></a><h4 id="LNOCI-GUID-C1E8C023-F0D4-4C0A-8585-DA6CCA0DDF65" class="sect4"><span class="enumeration_section">14.1.6</span>动态回叫注册</h4>
                  <div>
                     <p>因为期望用户回调用于监视OCI行为或访问其他数据源，所以希望回调的注册是透明且非侵入地完成的。</p>
                     <p>这是通过在OCI初始化时加载用户创建的动态链接库来实现的。这些动态链接库称为<span class="italic">包</span> 。用户创建的包注册所选OCI调用的用户回调。在运行时接收控件时，这些回调可以根据需要进一步注册或取消注册用户回调。
                     </p>
                     <p><code class="codeph">ociucb.mk</code>演示程序提供了makefile（Solaris上的<code class="codeph">ociucb.mk</code> ）来创建程序包。此程序包的确切命名和位置取决于操作系统。包的源代码必须提供在OCI初始化和环境创建时调用的特殊回调的代码。
                     </p>
                     <p>设置操作系统环境变量<code class="codeph">ORA_OCI_UCBPKG</code>控制程序包的加载。此变量以通用方式命名包。软件包必须位于<code class="codeph">$ORACLE_HOME/lib</code>目录中。
                     </p>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-C58991CA-395F-4DCC-9795-D688931DFFB5" name="GUID-C58991CA-395F-4DCC-9795-D688931DFFB5"></a><h4 id="LNOCI-GUID-C58991CA-395F-4DCC-9795-D688931DFFB5" class="sect4"><span class="enumeration_section">14.1.7</span>关于加载多个包</h4>
                  <div>
                     <p><code class="codeph">ORA_OCI_UCBPKG</code>变量可以包含以分号分隔的包名列表。包按照列表中指定的顺序加载。
                     </p>
                     <p>例如，在过去，包被指定为：</p><pre class="oac_no_warn" dir="ltr">setenv ORA_OCI_UCBPKG mypkg</pre><p>目前，您仍然可以像以前一样指定包，但另外可以将多个包指定为：</p><pre class="oac_no_warn" dir="ltr">setenv ORA_OCI_UCBPKG“mypkg; yourpkg; oraclepkg; sunpkg; msoftpkg”</pre><p>所有这些包都按顺序加载。也就是说， <code class="codeph">mypkg</code>加载<code class="codeph">msoftpkg</code> ，最后加载<code class="codeph">msoftpkg</code> 。
                     </p>
                     <p>最多可以指定五个包。</p>
                     <div class="infoboxnote" id="GUID-C58991CA-395F-4DCC-9795-D688931DFFB5__GUID-B774EC50-C033-4956-8EC3-93839484CF2B">
                        <p class="notep1">注意：</p>
                        <p>示例makefile <code class="codeph">ociucb.mk</code>在Solaris或Windows系统上的<code class="codeph">ociucb.dll</code>上创建<code class="codeph">ociucb.so.1.0</code> 。要加载<code class="codeph">ociucb</code>包，必须将环境变量<code class="codeph">ORA_OCI_UCBPKG</code>设置为<code class="codeph">ociucb</code> 。在Solaris上，如果包名以<code class="codeph">.so</code>结尾，则OCIEnvCreate（）或OCIEnvNlsCreate（）将失败。包名称必须以<code class="codeph">.so.1.0</code> 。
                        </p>
                        <p>有关创建动态链接库的更多详细信息，请阅读操作系统演示目录中提供的Makefile。有关用户定义的回调的更多信息，请参阅有关编译和链接应用程序的特定于操作系统的文档。</p>
                     </div>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-46F2412A-F84C-4C2A-983A-BF0AAA36647F" name="GUID-46F2412A-F84C-4C2A-983A-BF0AAA36647F"></a><h4 id="LNOCI-GUID-46F2412A-F84C-4C2A-983A-BF0AAA36647F" class="sect4"><span class="enumeration_section">14.1.8</span>包格式</h4>
                  <div>
                     <p>包源必须提供两个功能。</p>
                     <p>在过去，包必须指定<code class="codeph">OCIEnvCallback()</code>函数的源代码。但是， <code class="codeph">OCIEnvCallback()</code>函数已过时。相反，包源必须提供两个功能。第一个函数必须命名为后缀为<span class="italic">Init的</span> <span class="italic">packagename</span> 。例如，如果包名为<code class="codeph">foo</code> ，那么源文件（例如，但不一定是foo.c）必须包含一个<code class="codeph">fooInit()</code>函数，其调用<code class="codeph">OCISharedLibInit()</code>函数的方式完全如下：</p><pre class="oac_no_warn" dir="ltr">sword fooInit（metaCtx，libCtx，argfmt，argc，argv）void * metaCtx; / * metacontext * / void * libCtx; / *此包的上下文。* / ub4 argfmt; / *包参数格式* / sword argc; / * package arg count * / void * argv []; / * package arguments * / {return（OCISharedLibInit（metaCtx，libCtx，argfmt，argc，argv，fooEnvCallback））; }</pre><p>所述的最后一个参数<code class="codeph">OCISharedLibInit()</code>函数， <code class="codeph">fooEnvCallback()</code>在这种情况下，是所述第二函数的名称。它可以被命名为任何东西，但按照惯例，它被命名为<span class="italic">packagename，</span>后缀为<span class="italic">EnvCallback</span> 。
                     </p>
                     <p>此函数是<code class="codeph">OCIEnvCallback()</code>的替代品。目前，必须在此函数中注册所有动态用户回调。该函数必须是<code class="codeph">OCIEnvCallbackType</code>类型，其指定为：</p><pre class="oac_no_warn" dir="ltr">typedef sword（* OCIEnvCallbackType）（OCIEnv * env，ub4 mode，size_t xtramem_sz，void * usrmemp，OCIUcb * ucbDesc）;</pre><p>创建环境句柄时，最后会调用此回调函数。<code class="codeph">env</code>参数是新创建的环境句柄。
                     </p>
                     <p><code class="codeph">mode</code> <code class="codeph">xtramem_sz</code>和<code class="codeph">usrmempp</code>是传递给<code class="codeph">usrmempp</code> （）调用的参数。最后一个参数<code class="codeph">ucbDesc</code>是传递给包的描述符。该包使用此描述符来注册用户回调，如稍后所述。
                     </p>
                     <p><code class="codeph">demo</code>目录中提供了一个示例<code class="codeph">ociucb.c</code>文件。还在<code class="codeph">demo</code>目录中提供了makefile <code class="codeph">ociucb.mk</code> （在Solaris上）以创建包。请注意，在其他操作系统上可能会有所不同。<code class="codeph">demo</code>目录还包含说明这一点的完整用户回调演示程序（ <code class="codeph">cdemoucb.c, cdemoucbl.c</code> ）。
                     </p>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-9E6DD6F6-FF2A-49B6-8832-3651A4C7502E" name="GUID-9E6DD6F6-FF2A-49B6-8832-3651A4C7502E"></a><h4 id="LNOCI-GUID-9E6DD6F6-FF2A-49B6-8832-3651A4C7502E" class="sect4"><span class="enumeration_section">14.1.9</span>用户回调<span class="enumeration_section">链</span></h4>
                  <div>
                     <p>用户回调可以在应用程序本身中静态注册，也可以在运行时在DLL中动态注册。</p>
                     <p>需要一种机制来允许应用程序覆盖先前注册的回调，然后在新注册的回调中调用被覆盖的回调以保留动态注册所期望的行为。这可能导致用户回调的链接。</p>
                     <p><code class="codeph">OCIUserCallbackGet()</code>函数确定为OCI调用注册了哪个函数和上下文。
                     </p>
                     <div class="infoboxnotealso" id="GUID-9E6DD6F6-FF2A-49B6-8832-3651A4C7502E__GUID-DEF2F5EB-F20C-46CF-8D33-A087EE508ACF">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="miscellaneous-functions.html#GUID-2249B3FF-5E24-40AE-B310-EA63DBF37263" title="确定为句柄注册的回调。">OCIUserCallbackGet（）</a></p>
                     </div>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-63F27A12-2778-43A0-918F-35F310E0EAA6" name="GUID-63F27A12-2778-43A0-918F-35F310E0EAA6"></a><h4 id="LNOCI-GUID-63F27A12-2778-43A0-918F-35F310E0EAA6" class="sect4"><span class="enumeration_section">14.1.10</span>关于通过OCI访问其他数据源</h4>
                  <div>
                     <p>由于Oracle数据库是访问的主要数据库软件，因此应用程序可以利用OCI接口通过使用用户回调来访问非Oracle数据。</p>
                     <p>这允许用OCI编写的应用程序访问Oracle数据而不会造成任何性能损失。可以编写驱动程序来访问用户回调中的非Oracle数据。由于OCI提供了非常丰富的接口，因此通常可以直接将OCI调用映射到大多数数据源。此解决方案比为其他中间层（如ODBC）编写应用程序更好，这会对所有数据源造成性能损失。使用OCI不会对访问Oracle数据源造成任何惩罚，并且会对ODBC对非Oracle数据源造成相同的损失。</p>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-1E75F3F2-673D-4D80-B9C3-89119D47CCB9" name="GUID-1E75F3F2-673D-4D80-B9C3-89119D47CCB9"></a><h4 id="LNOCI-GUID-1E75F3F2-673D-4D80-B9C3-89119D47CCB9" class="sect4"><span class="enumeration_section">14.1.11</span>回调函数的限制</h4>
                  <div>
                     <p>详细说明了对回调函数的限制。</p>
                     <p>回调函数的使用有一些限制，包括<code class="codeph">OCIEnvCallback()</code> ：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>回调不能调用除<code class="codeph">OCIUserCallbackRegister()</code> ， <code class="codeph">OCIUserCallbackGet()</code> ， <code class="codeph">OCIHandleAlloc()</code>和<code class="codeph">OCIHandleFree()</code>之外的其他OCI函数。即使对于这些函数，如果在用户回调中调用它们，则不会调用它们上的回调以避免递归。例如，如果在<code class="codeph">OCIHandleFree()</code>的回调中调用<code class="codeph">OCILogoff()</code> ，则在执行<code class="codeph">OCILogoff()</code>的回调期间将禁用<code class="codeph">OCIHandleFree()</code>的回调。
                           </p>
                        </li>
                        <li>
                           <p>回调不能修改OCI数据结构，例如环境或错误句柄。</p>
                        </li>
                        <li>
                           <p>无法为<code class="codeph">OCIUserCallbackRegister()</code>调用本身或以下任何调用注册回调：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><code class="codeph">OCIUserCallbackGet（）</code></p>
                              </li>
                              <li>
                                 <p><code class="codeph">OCIEnvCreate（）</code></p>
                              </li>
                              <li>
                                 <p><code class="codeph">OCIInitialize()</code> （已弃用）</p>
                              </li>
                              <li>
                                 <p><code class="codeph">OCIEnvNlsCreate（）</code></p>
                              </li>
                           </ul>
                        </li>
                     </ul>
                     <div class="infoboxnotealso" id="GUID-1E75F3F2-673D-4D80-B9C3-89119D47CCB9__GUID-2DD7BBEA-6EFB-4406-852B-32A5D1B8A732">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><a href="miscellaneous-functions.html#GUID-A11D635A-806B-445E-BDCF-F145E86232CF" title="注册用户创建的回调函数。">OCIUserCallbackRegister（）</a></p>
                           </li>
                           <li>
                              <p><a href="miscellaneous-functions.html#GUID-2249B3FF-5E24-40AE-B310-EA63DBF37263" title="确定为句柄注册的回调。">OCIUserCallbackGet（）</a></p>
                           </li>
                           <li>
                              <p><a href="handle-and-descriptor-functions.html#GUID-C5BF55F7-A110-4CB5-9663-5056590F12B5" title="返回指向已分配和初始化句柄的指针。">OCIHandleAlloc（）</a></p>
                           </li>
                           <li>
                              <p><a href="handle-and-descriptor-functions.html#GUID-E87E9F91-D3DC-4F35-BE7C-F1EFBFEEBA0A" title="显式释放句柄">OCIHandleFree（）</a></p>
                           </li>
                           <li>
                              <p><a href="connect-authorize-and-initialize-functions.html#GUID-567DA731-ABC9-4348-B29C-7B2C6C1D7C36" title="释放使用OCILogon2（）或OCILogon（）检索的会话。">OCILogoff（）</a></p>
                           </li>
                           <li>
                              <p><a href="connect-authorize-and-initialize-functions.html#GUID-16BDA1F1-7DAF-41CA-9EE1-C9A4CB467244" title="创建并初始化OCI函数的环境句柄。">OCIEnvCreate（）</a></p>
                           </li>
                           <li>
                              <p><a href="deprecated-oci-functions.html#GUID-F50356A8-450D-4A96-8AB5-5726502766B2" title="在Oracle Database 11g第2版（11.2）之前的版本中不推荐使用此功能。">OCIInitialize（）</a></p>
                           </li>
                           <li>
                              <p><a href="connect-authorize-and-initialize-functions.html#GUID-0B6911A9-4B46-476C-BC5E-B87581666CD9" title="创建并初始化OCI函数的环境句柄。">OCIEnvNlsCreate（）</a></p>
                           </li>
                        </ul>
                     </div>
                  </div>
               </div>
               <div class="props_rev_3"><a id="GUID-A817AC07-545A-4C3B-A155-027D1889CA38" name="GUID-A817AC07-545A-4C3B-A155-027D1889CA38"></a><h4 id="LNOCI-GUID-A817AC07-545A-4C3B-A155-027D1889CA38" class="sect4"><span class="enumeration_section">14.1.12</span> OCI回调示例</h4>
                  <div>
                     <p>显示使用OCI回调的示例。</p>
                     <div class="section">
                        <p>假设有五个包，每个包注册<code class="codeph">OCIStmtPrepare2()</code>调用的入口，替换和退出回调。也就是说， <code class="codeph">ORA_OCI_UCBPKG</code>变量的设置如<a href="user-defined-callback-functions.html#GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACBICBD">例14-2</a>所示。
                        </p>
                        <p>在每个包<code class="codeph">pkgN</code> （其中N可以是1到5）中，指定了<code class="codeph">pkgNInit()</code>和<code class="codeph">PkgNEnvCallback()</code>函数，如<a href="user-defined-callback-functions.html#GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACJEBJF">例14-3</a>所示。
                        </p>
                        <p><a href="user-defined-callback-functions.html#GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACDFCCC">例14-4</a>显示了<code class="codeph">pkgNEnvCallback()</code>函数如何注册入口，替换和退出回调。
                        </p>
                        <p>最后， <a href="user-defined-callback-functions.html#GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACBJDFA">例14-5</a>显示了如何在应用程序的源代码中，用<code class="codeph">NULL</code> <span class="italic">ucbDesc</span>注册用户回调。
                        </p>
                        <p><a href="user-defined-callback-functions.html#GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACJHCID">例14-6</a>显示当执行<code class="codeph">OCIStmtPrepare2()</code>调用时， <code class="codeph">OCIStmtPrepare2()</code>以下顺序调用回调。
                        </p>
                        <div class="infoboxnote" id="GUID-A817AC07-545A-4C3B-A155-027D1889CA38__GUID-46C97747-CAC2-40EE-BA75-668C3483997F">
                           <p class="notep1">注意：</p>
                           <p>以与输入和替换回调相反的顺序调用退出回调。</p>
                        </div>
                        <p>入口和出口回调可以返回任何返回码，处理继续到下一个回调。但是，如果替换回调返回<code class="codeph">OCI_CONTINUE</code>以外的任何内容，则会绕过链中的下一个回调（或者如果它是最后一个替换回调的OCI代码）并且处理跳转到退出回调。例如，如果<code class="codeph">pkg3_replace_callback_fn()</code>返回<code class="codeph">OCI_SUCCESS</code> ，则会<code class="codeph">pkg4_replace_callback_fn()</code> ， <code class="codeph">pkg5_replace_callback_fn()</code>和<code class="codeph">OCIStmtPrepare2()</code>调用的OCI处理。相反， <code class="codeph">pkg5_exit_callback_fn()</code>执行<code class="codeph">pkg5_exit_callback_fn()</code> 。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="example" id="GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACBICBD">
                        <p class="titleinexample">示例14-2 ORA_OCI_UCBPKG变量的环境变量设置</p><pre class="oac_no_warn" dir="ltr">setenv ORA_OCI_UCBPKG“pkg1; pkg2; pkg3; pkg4; pkg5”</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACJEBJF">
                        <p class="titleinexample">示例14-3指定pkgNInit（）和PkgNEnvCallback（）函数</p><pre class="oac_no_warn" dir="ltr">pkgNInit（void * metaCtx，void * libCtx，ub4 argfmt，sword argc，void ** argv）{return OCISharedLibInit（metaCtx，libCtx，argfmt，argc，argv，pkgNEnvCallback）; }</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACDFCCC">
                        <p class="titleinexample">示例14-4使用pkgNEnvCallback（）注册Entry，Replacement和Exit回调</p><pre class="oac_no_warn" dir="ltr">pkgNEnvCallback（OCIEnv * env，ub4 mode，size_t xtramemsz，void * usrmemp，OCIUcb * ucbDesc）{OCIHandleAlloc（（void *）env，（void **）＆errh，OCI_HTYPE_ERROR，（size_t）0，（void **）NULL） ; OCIUserCallbackRegister（env，OCI_HTYPE_ENV，errh，pkgN_entry_callback_fn，pkgNctx，OCI_FNCODE_STMTPREPARE，OCI_UCBTYPE_ENTRY，ucbDesc）; OCIUserCallbackRegister（env，OCI_HTYPE_ENV，errh，pkgN_replace_callback_fn，pkgNctx，OCI_FNCODE_STMTPREPARE，OCI_UCBTYPE_REPLACE，ucbDesc）; OCIUserCallbackRegister（env，OCI_HTYPE_ENV，errh，pkgN_exit_callback_fn，pkgNctx，OCI_FNCODE_STMTPREPARE，OCI_UCBTYPE_EXIT，ucbDesc）;返回OCI_CONTINUE; }</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACBJDFA">
                        <p class="titleinexample">示例14-5使用NULL ucbDesc注册用户回调</p><pre class="oac_no_warn" dir="ltr">OCIUserCallbackRegister（env，OCI_HTYPE_ENV，errh，static_entry_callback_fn，pkgNctx，OCI_FNCODE_STMTPREPARE，OCI_UCBTYPE_ENTRY，（OCIUcb *）NULL）; OCIUserCallbackRegister（env，OCI_HTYPE_ENV，errh，static_replace_callback_fn，pkgNctx，OCI_FNCODE_STMTPREPARE，OCI_UCBTYPE_REPLACE，（OCIUcb *）NULL）; OCIUserCallbackRegister（env，OCI_HTYPE_ENV，errh，static_exit_callback_fn，pkgNctx，OCI_FNCODE_STMTPREPARE，OCI_UCBTYPE_EXIT，（OCIUcb *）NULL）;</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-A817AC07-545A-4C3B-A155-027D1889CA38__CACJHCID">
                        <p class="titleinexample">示例14-6使用OCIStmtPrepare（）调用按顺序调用回调</p><pre class="oac_no_warn" dir="ltr">static_entry_callback_fn（）pkg1_entry_callback_fn（）pkg2_entry_callback_fn（）pkg3_entry_callback_fn（）pkg4_entry_callback_fn（）pkg5_entry_callback_fn（）static_replace_callback_fn（）pkg1_replace_callback_fn（）pkg2_replace_callback_fn（）pkg3_replace_callback_fn（）pkg4_replace_callback_fn（）pkg5_replace_callback_fn（）OCI用于OCIStmtPrepare呼叫pkg5_exit_callback_fn（）pkg4_exit_callback_fn（）pkg3_exit_callback_fn）码（ pkg2_exit_callback_fn（）pkg1_exit_callback_fn（）static_exit_callback_fn（）</pre></div>
                     <!-- class="example" -->
                     <div class="section">
                        <div class="infoboxnotealso" id="GUID-A817AC07-545A-4C3B-A155-027D1889CA38__GUID-13D2CB18-469C-48D7-AC67-8CF186238E8C">
                           <p class="notep1">也可以看看：</p>
                           <p><a href="statement-functions.html#GUID-E6C1DC67-D464-4D2A-9F19-737423D31779" title="准备SQL或PL / SQL语句以便执行。">OCIStmtPrepare2（）</a></p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div>
            <div class="props_rev_3"><a id="GUID-163FF0B1-BAA9-4300-BA7C-170AAF0960ED" name="GUID-163FF0B1-BAA9-4300-BA7C-170AAF0960ED"></a><h3 id="LNOCI-GUID-163FF0B1-BAA9-4300-BA7C-170AAF0960ED" class="sect3"><span class="enumeration_section">14.2</span>来自外部程序的OCI回调</h3>
               <div>
                  <p>提供有关使用外部过程的OCI回调的其他参考信息。</p>
                  <p>有几个OCI函数可以用作外部过程的回调。</p>
                  <div class="infoboxnotealso" id="GUID-163FF0B1-BAA9-4300-BA7C-170AAF0960ED__GUID-A436EA79-8BC2-4328-B1B6-0B073041DD71">
                     <p class="notep1">也可以看看：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="oci-cartridge-functions.html#GUID-82822159-3CC2-47D6-BD6C-B75BB1B1BA49" title="本章介绍盒式磁带功能。">OCI Cartridge函数</a>用于可用作外部过程回调的函数列表</p>
                        </li>
                        <li>
                           <p><a href="../adfns/design_basics.html#ADFNS010" target="_blank"><span class="italic">Oracle数据库开发指南</span></a> ，了解有关编写可从PL / SQL代码调用的C子例程的信息，包括可以使用的OCI调用列表和一些示例代码</p>
                        </li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>