<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="Cursor sharing can improve database application performance by orders of magnitude."></meta>
      <meta name="description" content="Cursor sharing can improve database application performance by orders of magnitude."></meta>
      <title>通过游标共享提高实际性能</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="SQL Tuning Guide"></meta>
      <meta property="og:description" content="Cursor sharing can improve database application performance by orders of magnitude."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="SQL Tuning Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="sql-tuning-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-01-31T14:57:08-08:00"></meta>
      <meta name="dcterms.title" content="SQL Tuning Guide"></meta>
      <meta name="dcterms.dateCopyrighted" content="2013, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96095-03"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="influencing-the-optimizer.html" title="Previous" type="text/html"></link>
      <link rel="next" href="monitoring-and-tracing-sql.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="TGSQL"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="influencing-the-optimizer.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="monitoring-and-tracing-sql.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">SQL调优指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="optimizer-controls.html" property="item" typeof="WebPage"><span property="name">优化器控件</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">通过游标共享提高实际性能</li>
            </ol>
            <a id="GUID-971F4652-3950-4662-82DE-713DDEED317C" name="GUID-971F4652-3950-4662-82DE-713DDEED317C"></a><a id="TGSQL848"></a>
            
            <h2 id="TGSQL-GUID-971F4652-3950-4662-82DE-713DDEED317C" class="sect2"><span class="enumeration_chapter">20</span>通过游标共享提高实际性能</h2>
         </header>
         <div class="ind">
            <div>
               <p>游标共享可以将数据库应用程序性能提高几个数量级。</p>
               <p>本章包含以下主题：</p>
            </div>
            <div>
               <ul class="ullinks">
                  <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-1DEE6AD7-C30E-4ABB-9BFF-B5895A6E386B">游标共享概述</a><br>Oracle数据库可以共享游标，这些游标是指向共享池中私有SQL区域的指针。
                  </li>
                  <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-267E5860-A8D5-4E5F-AE60-16304E97E4EE">CURSOR_SHARING和绑定变量替换</a><br>本主题说明了<code class="codeph">CURSOR_SHARING</code>初始化参数是什么，以及如何将其设置为不同的值会影响Oracle数据库如何使用绑定变量。
                  </li>
                  <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-277432AA-CD1C-4A75-AB28-7358E63265B3">自适应游标共享</a><br><strong class="term">自适应游标共享</strong>功能允许包含绑定变量的单个语句使用多个执行计划。
                  </li>
                  <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-EA2FC76C-275B-49E1-B38C-BA39B3B3E864">光标共享的真实性能指南</a><br>Real-World Performance团队为如何优化Oracle数据库应用程序中的游标共享创建了指南。
                  </li>
               </ul>
               <div class="familylinks">
                  <div class="parentlink">
                     <p><strong>父主题：</strong> <a href="optimizer-controls.html#GUID-12325D58-595B-473A-A6C7-C6A4430894CA" title="您可以使用提示和初始化参数来影响优化程序的决策和行为。">优化程序控件</a></p>
                  </div>
               </div>
            </div>
            
            <div class="sect2"><a id="GUID-1DEE6AD7-C30E-4ABB-9BFF-B5895A6E386B" name="GUID-1DEE6AD7-C30E-4ABB-9BFF-B5895A6E386B"></a><h3 id="TGSQL-GUID-1DEE6AD7-C30E-4ABB-9BFF-B5895A6E386B" class="sect3"><span class="enumeration_section">20.1</span>游标共享概述</h3>
               <div>
                  <p>Oracle数据库可以共享游标，这些游标是指向共享池中私有SQL区域的指针。</p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-7A37EEAC-1B50-4744-B4BC-A3052313A7E4">关于游标</a><br><strong class="term">私有SQL区域</strong>包含有关已解析的SQL语句和其他特定于会话的信息以供处理的信息。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-5154DB60-EB3C-41EF-AF32-226FC54BDA75">关于游标和解析</a><br>如果应用程序发出语句，并且Oracle数据库无法重用游标，则必须构建应用程序代码的新可执行版本。此操作称为<strong class="term">硬解析</strong> 。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-B7ABA6CC-3E81-4990-BDE4-CF69181079B9">关于文字和绑定变量</a><br>绑定变量对于Oracle数据库应用程序中的游标共享至关重要。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-E04CF45D-CC70-4122-9BAC-EAB5B4D0E17A">关于共享游标的生命周期</a><br>当优化程序解析不是DDL的新SQL语句时，数据库会分配新的共享SQL区域。所需的内存量取决于语句的复杂性。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-971F4652-3950-4662-82DE-713DDEED317C" title="游标共享可以将数据库应用程序性能提高几个数量级。">通过游标共享提高实际性能</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-7A37EEAC-1B50-4744-B4BC-A3052313A7E4" name="GUID-7A37EEAC-1B50-4744-B4BC-A3052313A7E4"></a><h4 id="TGSQL-GUID-7A37EEAC-1B50-4744-B4BC-A3052313A7E4" class="sect4"><span class="enumeration_section">20.1.1</span>关于游标</h4>
                  <div>
                     <p><strong class="term">私有SQL区域</strong>包含有关已解析的SQL语句和其他特定于会话的信息以供处理的信息。
                     </p>
                     <p>当服务器进程执行SQL或PL / SQL代码时，该进程使用私有SQL区域来存储绑定变量值，查询执行状态信息和查询执行工作区。每次执行语句的私有SQL区域不共享，可能包含不同的值和数据。</p>
                     <p><a href="glossary.html#GUID-B29D6FB9-8D89-4124-A14F-E0FAEDAB2AA5"><span class="xrefglossterm">游标</span></a>是特定私有SQL区域的名称或句柄。游标包含特定于会话的状态信息，例如绑定变量值和结果集。
                     </p>
                     <p>如下图所示，您可以将游标视为客户端上的指针和服务器端的状态。由于游标与私有SQL区域紧密相关，因此这些术语有时可互换使用。</p>
                     <div class="figure" id="GUID-7A37EEAC-1B50-4744-B4BC-A3052313A7E4__GUID-32E3A1C4-201D-4E91-B19F-A704352DFC12">
                        <p class="titleinfigure">图20-1光标</p><img src="img/cncpt324.gif" alt="下面是图20-1的描述" title="下面是图20-1的描述" longdesc="img_text/cncpt324.html"><br><a href="img_text/cncpt324.html">“图20-1光标”的描述</a></div>
                     <!-- class="figure" -->
                     <p>本节包含以下主题：</p>
                  </div>
                  <div>
                     <ul class="ullinks">
                        <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-782D3329-0CC5-4312-B9B5-2A012A4AD7C8">私有和共享SQL区域</a><br>私有SQL区域中的游标指向库高速缓存中的<strong class="term">共享SQL区域</strong> 。
                        </li>
                        <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7">父母和儿童游标</a><br>每个已解析的SQL语句都有一个父游标和一个或多个子游标。
                        </li>
                     </ul>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-1DEE6AD7-C30E-4ABB-9BFF-B5895A6E386B" title="Oracle数据库可以共享游标，这些游标是指向共享池中私有SQL区域的指针。">游标共享概述</a></p>
                        </div>
                     </div>
                  </div>
                  <a id="TGSQL94739"></a><div class="props_rev_3"><a id="GUID-782D3329-0CC5-4312-B9B5-2A012A4AD7C8" name="GUID-782D3329-0CC5-4312-B9B5-2A012A4AD7C8"></a><h5 id="TGSQL-GUID-782D3329-0CC5-4312-B9B5-2A012A4AD7C8" class="sect5"><span class="enumeration_section">20.1.1.1</span>私有和共享SQL区域</h5>
                     <div>
                        <p>私有SQL区域中的游标指向库高速缓存中的<strong class="term">共享SQL区域</strong> 。
                        </p>
                        <p>与包含会话状态信息的私有SQL区域不同，共享SQL区域包含该语句的分析树和执行计划。例如， <code class="codeph">SELECT * FROM employees</code>的执行具有存储在一个共享SQL区域中的计划和分析树。<code class="codeph">SELECT * FROM departments</code>的执行在语法和语义上都有所不同，它有一个存储在单独的共享SQL区域中的计划和解析树。
                        </p>
                        <p>相同或不同会话中的多个私有SQL区域可以引用单个共享SQL区域，这种现象称为<strong class="term">游标共享</strong> 。例如，在一个会话中执行<code class="codeph">SELECT * FROM employees</code>以及在另一个会话中执行<code class="codeph">SELECT * FROM employees</code> （访问同一个表）可以使用相同的解析树和计划。由多个语句访问的共享SQL区域称为<a href="glossary.html#GUID-9DD889F6-A0BF-4E68-A53F-FC15371E9A09"><span class="xrefglossterm">共享游标</span></a> 。
                        </p>
                        <div class="figure" id="GUID-782D3329-0CC5-4312-B9B5-2A012A4AD7C8__GUID-DD8551AB-10C5-429A-8DDD-98ADC803D3E4">
                           <p class="titleinfigure">图20-2光标共享</p><img src="img/cncpt252.gif" alt="下面是图20-2的描述" title="下面是图20-2的描述" longdesc="img_text/cncpt252.html"><br><a href="img_text/cncpt252.html">“图20-2光标共享”的说明</a></div>
                        <!-- class="figure" -->
                        <p>Oracle Database使用以下步骤自动确定发出的SQL语句或PL / SQL块是否在文本上与当前库缓存中的另一个语句相同：</p>
                        <ol>
                           <li>
                              <p>该陈述的文本是经过哈希处理的。</p>
                           </li>
                           <li>
                              <p>数据库查找共享池中现有SQL语句的匹配哈希值。可以使用以下选项：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>不存在匹配的哈希值。</p>
                                    <p>在这种情况下，SQL语句当前不存在于共享池中，因此数据库执行硬解析。这结束了共享池检查。</p>
                                 </li>
                                 <li>
                                    <p>存在匹配的哈希值。</p>
                                    <p>在这种情况下，数据库继续进行下一步，即文本匹配。</p>
                                 </li>
                              </ul>
                           </li>
                           <li>
                              <p>数据库将匹配语句的文本与散列语句的文本进行比较，以确定它们是否相同。可以使用以下选项：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>文本匹配失败。</p>
                                    <p>在这种情况下，文本匹配过程停止，从而导致硬分析。</p>
                                 </li>
                                 <li>
                                    <p>文本匹配成功。</p>
                                    <p>在这种情况下，数据库继续执行下一步：确定SQL是否可以共享现有父光标。</p>
                                    <p>要进行文本匹配，SQL语句或PL / SQL块的文本必须是字符字符相同的，包括空格，大小写和注释。例如，以下语句不能使用相同的共享SQL区域：</p><pre class="pre codeblock"><code>SELECT * FROM员工; SELECT * FROM Employees; SELECT * FROM员工;</code></pre><p>通常，仅在文字中不同的SQL语句不能使用相同的共享SQL区域。例如，以下语句不会解析为相同的SQL区域：</p><pre class="pre codeblock"><code>SELECT count（1）FROM employees WHERE manager_id = 121; SELECT count（1）FROM employees WHERE manager_id = 247;</code></pre><p>此规则的唯一例外是当参数<code class="codeph">CURSOR_SHARING</code>已设置为<code class="codeph">FORCE</code> ，在这种情况下类似的语句可以共享SQL区域。
                                    </p>
                                 </li>
                              </ul>
                           </li>
                        </ol>
                     </div>
                     <div>
                        <div class="infoboxnotealso" id="GUID-782D3329-0CC5-4312-B9B5-2A012A4AD7C8__GUID-CEA14D38-B95B-4029-97DC-51F591CB6FA8">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7" title="每个已解析的SQL语句都有一个父游标和一个或多个子游标。">父母和儿童游标</a> ”</span></p>
                              </li>
                              <li>
                                 <p><span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346" title="最佳实践是编写可共享的SQL，并使用默认的EXACT进行CURSOR_SHARING。">不要使用CURSOR_SHARING = FORCE作为永久修复</a> ”</span>来了解使用<code class="codeph">CURSOR_SHARING</code>涉及的成本</p>
                              </li>
                              <li>
                                 <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/tgsql&amp;id=GUID-455358F8-D657-49A2-B32B-13A1DC53E7D2" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解有关<code class="codeph">CURSOR_SHARING</code>初始化参数的更多信息</p>
                              </li>
                           </ul>
                        </div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-7A37EEAC-1B50-4744-B4BC-A3052313A7E4" title="私有SQL区域包含有关已解析的SQL语句和其他特定于会话的信息以供处理的信息。">关于游标</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
                  <div class="sect4"><a id="GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7" name="GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7"></a><h5 id="TGSQL-GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7" class="sect5"><span class="enumeration_section">20.1.1.2</span>父母和儿童游标</h5>
                     <div>
                        <p>每个已解析的SQL语句都有一个父游标和一个或多个子游标。</p>
                        <p>父游标存储SQL语句的文本。如果两个语句的文本相同，则语句共享相同的父光标。但是，如果文本不同，则数据库会创建单独的父光标。</p>
                        <div class="example" id="GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7__GUID-638A7A3E-22FA-4572-80B3-0A52FC21A7A9">
                           <p class="titleinexample">例20-1父游标</p>
                           <p>在此示例中，前两个语句在语法上是不同的（字母“c”在第一个语句中是小写，在第二个语句中是大写），但在语义上是相同的。由于语法上的差异，这些语句具有不同的父游标。第三个语句在语法上与第一个语句（小写“c”）相同，但在语义上不同，因为它引用不同模式中的<code class="codeph">customers</code>表。由于语法标识，第三个语句可以与第一个语句共享父标度。
                           </p><pre class="pre codeblock"><code>SQL&gt; CONNECT oe @ inst1输入密码：*******已连接。SQL&gt; SELECT COUNT（*）FROM customers; COUNT（*）---------- 319 SQL&gt; SELECT COUNT（*）FROM Customers; COUNT（*）---------- 319 SQL&gt; CONNECT sh @ inst1输入密码：*******已连接。SQL&gt; SELECT COUNT（*）FROM customers; COUNT（*）---------- 155500</code></pre><p>以下<code class="codeph">V$SQL</code>查询表示两个父项。SQL ID为<code class="codeph">8h916vv2yw400</code>的语句（该语句的小写“c”版本）具有一个父光标和两个子游标：子0和子1。SQL ID为<code class="codeph">5rn2uxjtpz0wd</code>的语句（该语句的大写“c”版本）具有不同的父光标和仅一个子光标：child 0。
                           </p><pre class="pre codeblock"><code>SQL&gt; CONNECT SYSTEM @ inst1输入密码：*******已连接。SQL&gt; COL SQL_TEXT格式a30 SQL&gt; COL CHILD #FORMAT 99999 SQL&gt; COL EXEC格式9999 SQL&gt; COL模式格式a6 SQL&gt; SELECT SQL_ID，PARSING_SCHEMA_NAME AS SCHEMA，SQL_TEXT，2 CHILD_NUMBER作为孩子＃，执行来自V $ SQL 3 EXEC WHERE SQL_TEXT LIKE'％ustom％'和SQL_TEXT不像'％SQL_TEXT％'ORDER BY SQL_ID; SQL_ID SCHEMA SQL_TEXT CHILD #EXEC ------------- ------ ------------------------- ----- ------ ----- 5rn2uxjtpz0wd OE SELECT COUNT（*）FROM Customers 0 1 8h916vv2yw400 OE SELECT COUNT（*）FROM customers 0 1 8h916vv2yw400 SH SELECT COUNT（*）FROM customers 1 1</code></pre><p>本节包含以下主题：</p>
                        </div>
                        <!-- class="example" -->
                     </div>
                     <div>
                        <ul class="ullinks">
                           <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-9D5F5901-FCAC-41E0-B405-8F02840BB08B">父游标和V $ SQLAREA</a><br><code class="codeph">V$SQLAREA</code>视图为每个父光标包含一行。
                           </li>
                           <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-D8E8EC1C-76CF-44B2-AC41-5F720EBDB349">子游标和V $ SQL</a><br>每个父光标都有一个或多个子游标。
                           </li>
                           <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-5AC5DAC7-D5D0-4FF6-85E6-9A4C3B28C890">游标不匹配和V $ SQL_SHARED_CURSOR</a><br>如果父游标有多<code class="codeph">V$SQL_SHARED_CURSOR</code>游标，则<code class="codeph">V$SQL_SHARED_CURSOR</code>视图提供有关游标未共享的原因的信息。对于几种类型的不兼容性， <code class="codeph">TRANSLATION_MISMATCH</code>列表示与值<code class="codeph">Y</code>或<code class="codeph">N</code>不匹配。</li>
                        </ul>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-7A37EEAC-1B50-4744-B4BC-A3052313A7E4" title="私有SQL区域包含有关已解析的SQL语句和其他特定于会话的信息以供处理的信息。">关于游标</a></p>
                           </div>
                        </div>
                     </div>
                     
                     <div class="sect5"><a id="GUID-9D5F5901-FCAC-41E0-B405-8F02840BB08B" name="GUID-9D5F5901-FCAC-41E0-B405-8F02840BB08B"></a><h6 id="TGSQL-GUID-9D5F5901-FCAC-41E0-B405-8F02840BB08B" class="sect6"><span class="enumeration_section">20.1.1.2.1</span>父游标和V $ SQLAREA</h6>
                        <div>
                           <p><code class="codeph">V$SQLAREA</code>视图为每个父光标包含一行。
                           </p>
                           <div class="example" id="GUID-9D5F5901-FCAC-41E0-B405-8F02840BB08B__GUID-4BBFB7F8-171B-4C08-BB8C-347DCA041058">
                              <p>在以下示例中， <code class="codeph">V$SQLAREA</code>的查询显示了两个父游标，每个游标都标识有不同的<code class="codeph">SQL_ID</code> 。 <code class="codeph">VERSION_COUNT</code>表示子游标的数量。
                              </p><pre class="pre codeblock"><code>COL SQL_TEXT FORMAT a30 SELECT SQL_TEXT，SQL_ID，VERSION_COUNT，HASH_VALUE FROM V $ SQLAREA WHERE SQL_TEXT LIKE'％mployee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'; SQL_TEXT SQL_ID VERSION_COUNT HASH_VALUE ------------------------------ ------------- --- ---------- ---------- SELECT * FROM Employees 5bzhzpaa0wy9m 1 2483976499 SELECT * FROM employees 4959aapufrm1k 2 1961610290</code></pre><p>在前面的输出中， <code class="codeph">SELECT * FROM employees</code>的<code class="codeph">VERSION_COUNT</code>为<code class="codeph">2</code>表示多个子游标，这是必需的，因为该语句是针对两个不同的对象执行的。相反，语句<code class="codeph">SELECT * FROM Employees</code> （注意大写“E”）执行了一次，因此有一个父光标和一个子光标（ <code class="codeph">VERSION_COUNT</code>为<code class="codeph">1</code> ）。
                              </p>
                           </div>
                           <!-- class="example" -->
                        </div>
                        <div>
                           <div class="familylinks">
                              <div class="parentlink">
                                 <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7" title="每个已解析的SQL语句都有一个父游标和一个或多个子游标。">父级和子级游标</a></p>
                              </div>
                           </div>
                        </div>
                        
                     </div>
                     <div class="sect5"><a id="GUID-D8E8EC1C-76CF-44B2-AC41-5F720EBDB349" name="GUID-D8E8EC1C-76CF-44B2-AC41-5F720EBDB349"></a><h6 id="TGSQL-GUID-D8E8EC1C-76CF-44B2-AC41-5F720EBDB349" class="sect6"><span class="enumeration_section">20.1.1.2.2</span>子游标和V $ SQL</h6>
                        <div>
                           <p>每个父光标都有一个或多个子游标。</p>
                           <p><strong class="term">子游标</strong>包含执行计划，绑定变量，有关查询中引用的对象的元数据，优化器环境和其他信息。与父光标相反，子光标不存储SQL语句的文本。
                           </p>
                           <p>如果语句能够重用父游标，则数据库会检查该语句是否可以重用现有的子游标。数据库执行多项检查，包括以下内容：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>数据库将已发出语句中引用的对象与池中语句引用的对象进行比较，以确保它们全部相同。</p>
                                 <p>对SQL语句或PL / SQL块中的模式对象的引用必须解析为同一模式中的同一对象。例如，如果两个用户发出以下SQL语句，并且每个用户都有自己的<code class="codeph">employees</code>表，则以下语句不相同，因为该语句为每个用户引用了不同的<code class="codeph">employees</code>表：</p><pre class="pre codeblock"><code>SELECT * FROM员工;</code></pre><div class="infoboxnote" id="GUID-D8E8EC1C-76CF-44B2-AC41-5F720EBDB349__GUID-A5474EDF-A1AD-4EA6-9EC6-CA5316AA8F26">
                                    <p class="notep1">注意：</p>
                                    <p>数据库可以共享私有临时表的游标，但只能在同一会话中共享游标。数据库将会话标识符关联为游标上下文的一部分。在软解析期间，只有当前会话ID与游标上下文中的会话ID匹配时，数据库才能共享子游标。</p>
                                 </div>
                              </li>
                              <li>
                                 <p>数据库确定优化程序模式是否相同。</p>
                                 <p>例如，必须使用相同的<a href="glossary.html#GUID-B9EC4A43-179B-43D1-B63C-82300FC34596"><span class="xrefglossterm">优化器目标</span></a>优化SQL语句。
                                 </p>
                              </li>
                           </ul>
                           <div class="example" id="GUID-D8E8EC1C-76CF-44B2-AC41-5F720EBDB349__GUID-9C8CC0EA-0CC8-4A93-8588-7702FF789814">
                              <p class="titleinexample">例20-2多个子游标</p>
                              <p><code class="codeph">V$SQL</code>描述了当前驻留在库高速缓存中的语句。它为每个子游标包含一行，如以下示例所示：</p><pre class="pre codeblock"><code>SELECT SQL_TEXT，SQL_ID，USERNAME AS USR，CHILD_NUMBER AS CHILD＃，HASH_VALUE，PLAN_HASH_VALUE AS PLAN_HASHV FROM V $ SQL s，DBA_USERS d WHERE SQL_TEXT LIKE'％mployee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'AND d。USER_ID = s。PARSING_USER_ID; SQL_TEXT SQL_ID USR CHILD＃HASH_VALUE PLAN_HASHV ----------------------- ------------- --- ---- -  ---------- ---------- SELECT * FROM Employees 5bzhzpaa0wy9m HR 0 2483976499 1445457117 SELECT * FROM employees 4959aapufrm1k HR 0 1961610290 1445457117 SELECT * FROM employees 4959aapufrm1k SH 1 1961610290 1445457117</code></pre><p>在前面的结果中，底部两个语句的<code class="codeph">CHILD#</code>是不同的（ <code class="codeph">0</code>和<code class="codeph">1</code> ），即使<code class="codeph">SQL_ID</code>是相同的。这意味着语句具有相同的父光标，但具有不同的子光标。相反， <code class="codeph">SQL_ID</code>为<code class="codeph">5bzhzpaa0wy9m</code>的语句有一个父项和一个子项（ <code class="codeph">CHILD#</code>为<code class="codeph">0</code> ）。所有三个SQL语句都使用相同的执行计划，如<code class="codeph">PLAN_HASH_VALUE</code>列中的相同值<code class="codeph">PLAN_HASH_VALUE</code> 。
                              </p>
                           </div>
                           <!-- class="example" -->
                        </div>
                        <div>
                           <div class="relinfo">
                              <p><strong>相关话题</strong></p>
                              <ul>
                                 <li><a href="optimizer-statistics-concepts.html#GUID-C0F7F290-8430-442F-8E7D-0371834E9917" title="临时表分为全局，私有或游标持续时间。">临时表的类型</a></li>
                                 <li><a href="influencing-the-optimizer.html#GUID-2D3EEFD3-C4C6-4D2F-B24A-8DC0C1E1CBA1" title="优化器目标是优化器对资源使用的优先级。">选择优化程序目标</a></li>
                              </ul>
                           </div>
                           <div class="familylinks">
                              <div class="parentlink">
                                 <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7" title="每个已解析的SQL语句都有一个父游标和一个或多个子游标。">父级和子级游标</a></p>
                              </div>
                           </div>
                        </div>
                        
                     </div>
                     <div class="sect5"><a id="GUID-5AC5DAC7-D5D0-4FF6-85E6-9A4C3B28C890" name="GUID-5AC5DAC7-D5D0-4FF6-85E6-9A4C3B28C890"></a><h6 id="TGSQL-GUID-5AC5DAC7-D5D0-4FF6-85E6-9A4C3B28C890" class="sect6"><span class="enumeration_section">20.1.1.2.3</span>游标不匹配和V $ SQL_SHARED_CURSOR</h6>
                        <div>
                           <p>如果父游标有多<code class="codeph">V$SQL_SHARED_CURSOR</code>游标，则<code class="codeph">V$SQL_SHARED_CURSOR</code>视图提供有关游标未共享的原因的信息。对于几种类型的不兼容性， <code class="codeph">TRANSLATION_MISMATCH</code>列表示与值<code class="codeph">Y</code>或<code class="codeph">N</code>不匹配。</p>
                           <div class="example" id="GUID-5AC5DAC7-D5D0-4FF6-85E6-9A4C3B28C890__GUID-2F5BDA06-1E34-44B4-A7CF-A04ECD088936">
                              <p class="titleinexample">例20-3翻译不匹配</p>
                              <p>在此示例中， <code class="codeph">TRANSLATION_MISMATCH</code>列显示两个语句（ <code class="codeph">SELECT * FROM employees</code> ）引用了不同的对象，从而导致最后一个语句的<code class="codeph">TRANSLATION_MISMATCH</code>值为<code class="codeph">Y</code>由于无法共享，因此每个语句都有一个单独的子游标，如<code class="codeph">CHILD_NUMBER</code>为<code class="codeph">0</code>和<code class="codeph">1</code> 。
                              </p><pre class="pre codeblock"><code>SELECT S.SQL_TEXT，S.CHILD_NUMBER，s。CHILD_ADDRESS，C.TRANSLATION_MISMATCH来自V $ SQL S，V $ SQL_SHARED_CURSOR C WHERE SQL_TEXT LIKE'％employee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'AND S.CHILD_ADDRESS = C.CHILD_ADDRESS; SQL_TEXT CHILD_NUMBER CHILD_ADDRESS T ------------------------------ ------------ ---- ------------  -  SELECT * FROM employees 0 0000000081EE8690 N SELECT * FROM employees 1 0000000081F22508 Y</code></pre></div>
                           <!-- class="example" -->
                        </div>
                        <div>
                           <div class="familylinks">
                              <div class="parentlink">
                                 <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-8CC2E0D8-4C67-4795-93A8-9F563E7F27C7" title="每个已解析的SQL语句都有一个父游标和一个或多个子游标。">父级和子级游标</a></p>
                              </div>
                           </div>
                        </div>
                        
                     </div>
                  </div>
               </div>
               <div class="sect3"><a id="GUID-5154DB60-EB3C-41EF-AF32-226FC54BDA75" name="GUID-5154DB60-EB3C-41EF-AF32-226FC54BDA75"></a><h4 id="TGSQL-GUID-5154DB60-EB3C-41EF-AF32-226FC54BDA75" class="sect4"><span class="enumeration_section">20.1.2</span>关于游标和解析</h4>
                  <div>
                     <p>如果应用程序发出语句，并且Oracle数据库无法重用游标，则必须构建应用程序代码的新可执行版本。此操作称为<strong class="term">硬解析</strong> 。
                     </p>
                     <p><a href="glossary.html#GUID-BA91B10B-FBA3-4DF6-B59B-9AA57C683D33"><span class="xrefglossterm">软解析</span></a>是任何非硬解析的解析，并且在数据库可以重用现有代码时发生。一些软解析比其他解析更少资源。例如，如果该语句的父游标已存在，则Oracle数据库可以执行各种优化，然后将子游标存储在共享SQL区域中。但是，如果父游标不存在，则Oracle数据库还必须将父游标存储在共享SQL区域中，这会产生额外的内存开销。
                     </p>
                     <p>实际上，硬解析在运行之前会重新编译语句。在每次执行之前对SQL语句进行硬解析类似于在每次执行之前重新编译C程序。硬解析执行以下操作：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>检查SQL语句的语法</p>
                        </li>
                        <li>
                           <p>检查SQL语句的语义</p>
                        </li>
                        <li>
                           <p>检查发出语句的用户的访问权限</p>
                        </li>
                        <li>
                           <p>创建执行计划</p>
                        </li>
                        <li>
                           <p>多次访问库高速缓存和数据字典高速缓存以检查数据字典</p>
                        </li>
                     </ul>
                     <p>硬解析的一个特别资源密集的方面是多次访问库缓存和数据字典缓存以检查数据字典。当数据库访问这些区域时，它会在所需对象上使用称为<a href="glossary.html#GUID-B1C1EE03-1E9E-45F9-BD12-3B05654F7615"><span class="xrefglossterm">锁存器</span></a>的序列化设备，以便在检查期间它们的定义不会更改。Latch争用会增加语句执行时间并降低并发性。
                     </p>
                     <p>由于上述所有原因，硬解析的CPU和内存开销会产生严重的性能问题。这些问题在接受来自表单的用户输入，然后动态生成SQL语句的Web应用程序中尤为明显。Real-World Performance小组强烈建议尽可能减少硬解析。</p>
                     <div class="infoboxnote" id="GUID-5154DB60-EB3C-41EF-AF32-226FC54BDA75__RWP3CONNECTIONPOOLSANDHARDPARSING-7EE8CD10">
                        <p class="notep1">视频：</p>
                        <p>
                           </p><div class="video-box">
                              <div id="9268" class="video-container"></div>
                           </div>
                        
                     </div>
                     <div class="example" id="GUID-5154DB60-EB3C-41EF-AF32-226FC54BDA75__FINDINGPARSEINFORMATIONUSINGVSQL-7EE8A824">
                        <p class="titleinexample">示例20-4使用V $ SQL查找解析信息</p>
                        <p>您可以使用各种技术来监视硬解析和软解析。此示例查询会话统计信息以确定重复执行<code class="codeph">DBA_JOBS</code>查询是否会增加硬解析计数。该语句的第一次执行将硬解析计数增加到<code class="codeph">49</code> ，但第二次执行不会更改硬解析计数，这意味着Oracle数据库重用了应用程序代码。
                        </p><pre class="pre codeblock"><code>SQL&gt; ALTER SYSTEM FLUSH SHARED_POOL;系统改变了。SQL&gt; COL NAME FORMAT a18 SQL&gt; SELECT s。NAME，m。VAL $ 2来自V $ STATNAME s，V $ MYSTAT m 3 WHERE s。统计＃= m。统计＃4和s。NAME LIKE'％（hard％'; NAME VALUE ------------------ ---------- parse count（hard）48 SQL&gt; SELECT COUNT（ *）FROM DBA_JOBS; COUNT（*）---------- 0 SQL&gt; SELECT s。NAME，m。VAL $ 2来自V $ STATNAME s，V $ MYSTAT m 3 WHERE s。统计＃= m。统计＃4和s。NAME LIKE'％（hard％'; NAME VALUE ------------------ ---------- parse count（hard） <span class="bold">49</span> SQL&gt; SELECT COUNT（ *）FROM DBA_JOBS; COUNT（*）---------- 0 SQL&gt; SELECT s。NAME，m。VAL $ 2来自V $ STATNAME s，V $ MYSTAT m 3 WHERE s。统计＃= m。统计＃4和s。NAME LIKE'％（hard％'; NAME VALUE ------------------ ---------- parse count（hard）49</code></pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-5154DB60-EB3C-41EF-AF32-226FC54BDA75__FINDINGPARSEINFORMATIONUSINGTRACEFI-7EE8AD2E">
                        <p class="titleinexample">示例20-5使用跟踪文件查找解析信息</p>
                        <p>此示例使用SQL Trace和TKPROF实用程序来查找解析信息。使用管理员权限登录数据库，然后查询跟踪文件的目录位置（包括示例输出）：</p><pre class="pre codeblock"><code>SET LINESIZE 120 COLUMN value FORMAT A80 SELECT value FROM v $ diag_info WHERE name ='Default Trace File'; VALUE ------------------------------------------------- ------------------------------- / disk1 / oracle / log / diag / rdbms / orcl / orcl / trace / orcl_ora_23054。 TRC</code></pre><p>启用跟踪，使用<code class="codeph">TRACEFILE_IDENTIFIER</code>初始化参数为跟踪文件提供有意义的名称，然后查询<code class="codeph">hr.employees</code> ：</p><pre class="pre codeblock"><code>EXEC DBMS_MONITOR.SESSION_TRACE_ENABLE（等待=&gt; TRUE，绑定=&gt; TRUE）; ALTER SESSION SET TRACEFILE_IDENTIFIER =“emp_stmt”; SELECT * FROM hr.employees;出口;</code></pre><p>在默认跟踪文件目录中搜索您生成的跟踪文件：</p><pre class="pre codeblock"><code>％ls * emp_stmt.trc orcl_ora_17950_emp_stmt.trc</code></pre><p>使用TKPROF格式化跟踪文件，然后打开格式化文件：</p><pre class="pre codeblock"><code>％tkprof orcl_ora_17950_emp_stmt.trc emp.out; vi emp.out</code></pre><p>格式化的跟踪文件包含<code class="codeph">hr.employees</code>查询的解析信息。
                        </p><pre class="pre codeblock"><code>SQL ID：brmjpfs7dcnub Plan Hash：1445457117 SELECT * FROM hr.employees call count cpu elapsed disk query current rows ------- ------ -------- ------- --- ---------- ---------- ---------- ---------- Parse 1 0.07 0.08 0 0 0 0执行1 0.00 0.00 0 0 0 0获取9 0.00 0.00 3 12 0 107 ------- ------ -------- ----------  - -------- ---------- ---------- ----------总计11 0.07 0.08 3 12 0 107 <span class="bold">库缓存中未命中解析期间：1</span>优化器模式：ALL_ROWS解析用户ID：SYSTEM捕获的计划统计数据：1行（第1行）行（平均）行（最大）行源操作---------- ----- ----- ---------- ----------------------------------- ---------------- 107 107 107表访问全员工（cr = 12 pr = 3 pw = 0 time = 497 us starts = 1 cost = 2 size = 7383 card = 107）</code></pre><p>库高速缓存未命中表示硬解析。为第二次执行同一语句执行相同的步骤会产生以下跟踪输出，该输出显示没有库高速缓存未命中：</p><pre class="pre codeblock"><code>SQL ID：brmjpfs7dcnub Plan Hash：1445457117 SELECT * FROM hr.employees call count cpu elapsed disk query current rows ------- ------ -------- ------- --- ---------- ---------- ---------- ---------- Parse 1 0.00 0.00 0 0 0 0执行1 0.00 0.00 0 0 0 0获取9 0.00 0.00 3 12 0 107 ------- ------ -------- ----------  - -------- ---------- ---------- ----------总计11 0.00 0.00 3 12 0 107 <span class="bold">库缓存未命中解析期间：0</span>优化器模式：ALL_ROWS解析用户ID：SYSTEM捕获的计划统计数据：1行（第1行）行（平均）行（最大）行源操作---------- ----- ----- ---------- ----------------------------------- ---------------- 107 107 107表访问全员工（cr = 12 pr = 3 pw = 0 time = 961 us starts = 1 cost = 2 size = 7383 card = 107）</code></pre></div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-5154DB60-EB3C-41EF-AF32-226FC54BDA75__GUID-B29631D2-F84C-42DC-870B-27F90D6FDC3B">
                        <p class="notep1">也可以看看：</p>
                        <p><span class="q">“ <a href="sql-processing.html#GUID-BFF0B26C-0A5D-4F79-B01E-8E1C4064A6AD" title="在解析期间，数据库执行共享池检查以确定它是否可以跳过资源密集的语句处理步骤。">共享池检查</a> ”</span></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-1DEE6AD7-C30E-4ABB-9BFF-B5895A6E386B" title="Oracle数据库可以共享游标，这些游标是指向共享池中私有SQL区域的指针。">游标共享概述</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL849"></a><div class="props_rev_3"><a id="GUID-B7ABA6CC-3E81-4990-BDE4-CF69181079B9" name="GUID-B7ABA6CC-3E81-4990-BDE4-CF69181079B9"></a><h4 id="TGSQL-GUID-B7ABA6CC-3E81-4990-BDE4-CF69181079B9" class="sect4"><span class="enumeration_section">20.1.3</span>关于文字和绑定变量</h4>
                  <div>
                     <p>绑定变量对于Oracle数据库应用程序中的游标共享至关重要。</p>
                     <p>本节包含以下主题：</p>
                  </div>
                  <div>
                     <ul class="ullinks">
                        <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-015E6C8F-4C33-4680-9481-9F93DEDD844B">文字和游标</a><br>构造SQL语句时，某些Oracle应用程序使用文字而不是绑定变量。
                        </li>
                        <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-042A85BF-D96E-44AB-9312-4EB115CCE7B0">绑定变量和游标</a><br>您可以开发Oracle应用程序以使用绑定变量而不是文字。
                        </li>
                        <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-3550B486-A3D6-4FB2-99A9-4B90D4ADE421">绑定变量偷看</a><br>在<strong class="term">绑定变量</strong>查看（也称为<span class="italic">绑定</span>查看）中，优化程序在数据库执行语句的硬解析时查看绑定变量中的值。
                        </li>
                     </ul>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-1DEE6AD7-C30E-4ABB-9BFF-B5895A6E386B" title="Oracle数据库可以共享游标，这些游标是指向共享池中私有SQL区域的指针。">游标共享概述</a></p>
                        </div>
                     </div>
                  </div>
                  
                  <div class="sect4"><a id="GUID-015E6C8F-4C33-4680-9481-9F93DEDD844B" name="GUID-015E6C8F-4C33-4680-9481-9F93DEDD844B"></a><h5 id="TGSQL-GUID-015E6C8F-4C33-4680-9481-9F93DEDD844B" class="sect5"><span class="enumeration_section">20.1.3.1</span>文字和游标</h5>
                     <div>
                        <p>构造SQL语句时，某些Oracle应用程序使用文字而不是绑定变量。</p>
                        <p>例如，语句<code class="codeph">SELECT SUM(salary) FROM hr.employees WHERE employee_id &lt; 101</code>使用文字值<code class="codeph">101</code>作为员工ID。默认情况下，当类似语句不使用绑定变量时，Oracle数据库无法利用游标共享。因此，Oracle数据库会看到除了值<code class="codeph">102</code>或任何其他随机值之外的相同语句，作为一个全新的语句，需要进行硬解析。
                        </p>
                        <p>Real-World Performance组已确定使用文字的应用程序是性能，可伸缩性和安全性问题的常见原因。在现实世界中，在不考虑游标共享的情况下快速编写应用程序的情况并不少见。一个典型的例子是“屏幕抓取”应用程序，它将内容从Web表单中复制出来，然后连接字符串以动态构造SQL语句。</p>
                        <p>使用文字值导致的主要问题包括：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>连接最终用户输入的文字的应用程序容易受到SQL注入攻击。仅重写应用程序以使用绑定变量可消除此威胁。</p>
                           </li>
                           <li>
                              <p>如果每个语句都经过硬解析，则游标不会被共享，因此数据库必须占用更多内存来创建游标。</p>
                           </li>
                           <li>
                              <p>硬分析时，Oracle数据库必须锁存共享池和库高速缓存。随着硬解析数量的增加，等待锁存共享池的进程数也会增加。这种情况会降低并发性并增加争用。</p>
                           </li>
                        </ul>
                        <div class="infoboxnote" id="GUID-015E6C8F-4C33-4680-9481-9F93DEDD844B__ORACLEDATABASE12CRECOVERINGAPLUGGAB-6B61826C">
                           <p class="notep1">视频：</p>
                           <p>
                              </p><div class="video-box">
                                 <div id="9269" class="video-container"></div>
                              </div>
                           
                        </div>
                        <div class="example" id="GUID-015E6C8F-4C33-4680-9481-9F93DEDD844B__GUID-7FADDE5F-A0E4-4F29-B82A-414BCBCAE57A">
                           <p class="titleinexample">例20-6文字和光标共享</p>
                           <p>考虑执行以下语句的应用程序，这些语句仅在文字方面有所不同：</p><pre class="pre codeblock"><code>SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;101; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;120; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;165;</code></pre><p>以下<code class="codeph">V$SQLAREA</code>查询显示这三个语句需要三个不同的父游标。如<code class="codeph">VERSION_COUNT</code>所示，每个父光标都需要自己的子光标。
                           </p><pre class="pre codeblock"><code>COL SQL_TEXT FORMAT a30 SELECT SQL_TEXT，SQL_ID，VERSION_COUNT，HASH_VALUE FROM V $ SQLAREA WHERE SQL_TEXT LIKE'％mployee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'; SQL_TEXT SQL_ID VERSION_COUNT HASH_VALUE ------------------------------ ------------- --- ---------- ---------- SELECT SUM（薪水）FROM hr.emp b1tvfcc5qnczb 1 191509483 loyees WHERE employee_id &lt;165 SELECT SUM（薪水）FROM hr.emp cn5250y0nqpym 1 2169198547 loyees WHERE employee_id &lt;101 SELECT SUM（薪水）FROM hr.emp au8nag2vnfw67 1 3074912455 loyees WHERE employee_id &lt;120</code></pre></div>
                        <!-- class="example" -->
                     </div>
                     <div>
                        <div class="infoboxnotealso" id="GUID-015E6C8F-4C33-4680-9481-9F93DEDD844B__GUID-16EF4F90-4ACF-4267-B7FA-5E26CF423F2A">
                           <p class="notep1">也可以看看：</p>
                           <p><span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346" title="最佳实践是编写可共享的SQL，并使用默认的EXACT进行CURSOR_SHARING。">不要使用CURSOR_SHARING = FORCE作为永久修复</a> ”</span>来了解SQL注入</p>
                        </div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-B7ABA6CC-3E81-4990-BDE4-CF69181079B9" title="绑定变量对于Oracle数据库应用程序中的游标共享至关重要。">关于文字和绑定变量</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
                  <div class="sect4"><a id="GUID-042A85BF-D96E-44AB-9312-4EB115CCE7B0" name="GUID-042A85BF-D96E-44AB-9312-4EB115CCE7B0"></a><h5 id="TGSQL-GUID-042A85BF-D96E-44AB-9312-4EB115CCE7B0" class="sect5"><span class="enumeration_section">20.1.3.2</span>绑定变量和游标</h5>
                     <div>
                        <p>您可以开发Oracle应用程序以使用绑定变量而不是文字。</p>
                        <p><a href="glossary.html#GUID-CA223D31-C3CC-4037-9BAD-9AB69FDD4212"><span class="xrefglossterm">绑定变量</span></a>是查询中的占位符。例如，语句<code class="codeph">SELECT SUM(salary) FROM hr.employees WHERE employee_id &lt; :emp_id</code>使用绑定变量<code class="codeph">:emp_id</code>作为员工ID。</p>
                        <p>Real-World Performance小组发现使用绑定变量的应用程序性能更好，扩展性更好，更安全。使用绑定变量带来的主要好处包括：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>使用绑定变量的应用程序不容易受到与使用文字的应用程序相同的SQL注入攻击。</p>
                           </li>
                           <li>
                              <p>当相同的语句使用绑定变量时，Oracle数据库可以利用游标共享，并在不同的值绑定到同一语句时共享计划和其他信息。</p>
                           </li>
                           <li>
                              <p>Oracle数据库避免了锁存硬解析所需的共享池和库高速缓存的开销。</p>
                           </li>
                        </ul>
                        <div class="infoboxnote" id="GUID-042A85BF-D96E-44AB-9312-4EB115CCE7B0__ORACLEDATABASE12CRECOVERINGAPLUGGAB-6B61826C">
                           <p class="notep1">视频：</p>
                           <p>
                              </p><div class="video-box">
                                 <div id="9269" class="video-container"></div>
                              </div>
                           
                        </div>
                        <div class="example" id="GUID-042A85BF-D96E-44AB-9312-4EB115CCE7B0__GUID-19F02899-4D61-4F80-850A-4A71CA2273F2">
                           <p class="titleinexample">例20-7绑定变量和共享游标</p>
                           <p>下面的示例使用<code class="codeph">VARIABLE</code>在SQL命令* Plus来创建<code class="codeph">emp_id</code>绑定变量，然后执行使用三种不同的绑定值的查询（ <code class="codeph">101</code> ， <code class="codeph">120</code> ，和<code class="codeph">165</code> ）：</p><pre class="pre codeblock"><code>VARIABLE emp_id NUMBER EXEC：emp_id：= 101; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id; EXEC：emp_id：= 120; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id; EXEC：emp_id：= 165; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id;</code></pre><p>以下<code class="codeph">V$SQLAREA</code>查询显示了一个唯一的SQL语句：</p><pre class="pre codeblock"><code>COL SQL_TEXT FORMAT a34 SELECT SQL_TEXT，SQL_ID，VERSION_COUNT，HASH_VALUE FROM V $ SQLAREA WHERE SQL_TEXT LIKE'％mployee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'; SQL_TEXT SQL_ID VERSION_COUNT HASH_VALUE ---------------------------------- ------------ -  ------------- ---------- SELECT SUM（薪水）FROM hr.employe 4318cbskba8yh 1 615850960 es WHERE employee_id &lt;：emp_id</code></pre><p><code class="codeph">VERSION_COUNT</code>值为<code class="codeph">1</code>表示数据库重用了相同的子游标，而不是创建三个单独的子游标。使用绑定变量使这种重用成为可能。
                           </p>
                        </div>
                        <!-- class="example" -->
                     </div>
                     <div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-B7ABA6CC-3E81-4990-BDE4-CF69181079B9" title="绑定变量对于Oracle数据库应用程序中的游标共享至关重要。">关于文字和绑定变量</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div><a id="TGSQL94738"></a><a id="TGSQL95251"></a><div class="props_rev_3"><a id="GUID-3550B486-A3D6-4FB2-99A9-4B90D4ADE421" name="GUID-3550B486-A3D6-4FB2-99A9-4B90D4ADE421"></a><h5 id="TGSQL-GUID-3550B486-A3D6-4FB2-99A9-4B90D4ADE421" class="sect5"><span class="enumeration_section">20.1.3.3</span>绑定变量<span class="enumeration_section">偷看</span></h5>
                     <div>
                        <p>在<strong class="term">绑定变量</strong>查看（也称为<span class="italic">绑定</span>查看）中，优化程序在数据库执行语句的硬解析时查看绑定变量中的值。
                        </p>
                        <p>优化器在每次解析之前都不会查看绑定变量值。相反，优化程序仅在<span class="italic">首次</span>调用优化程序时查看，即在硬分析期间。
                        </p>
                        <p>当查询使用文字时，优化程序可以使用文字值来查找最佳计划。但是，当查询使用绑定变量时，优化程序必须选择最佳计划，而SQL文本中不存在文字。这项任务非常困难。通过在初始硬解析期间查看绑定值，优化器可以确定<code class="codeph">WHERE</code>子句条件的基数，就像使用了文字<span class="italic">一样</span> ，从而改进了计划。
                        </p>
                        <p>由于优化程序仅在硬解析期间查看绑定值，因此对于所有可能的绑定值，该计划可能不是最佳的。以下示例说明了这一原则。</p>
                        <div class="example" id="GUID-3550B486-A3D6-4FB2-99A9-4B90D4ADE421__GUID-FA3A4623-2191-44E3-B169-F456704A6F0D">
                           <p class="titleinexample">示例20-8文字导致不同的执行计划</p>
                           <p>假设执行下面的语句，执行使用不同的文字（三个不同的语句<code class="codeph">101</code> ， <code class="codeph">120</code> ，和<code class="codeph">165</code> ），然后显示每个执行计划：</p><pre class="pre codeblock"><code>SET LINESIZE 167 SET PAGESIZE 0 SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;101; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;120; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;165; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））;</code></pre><p>数据库很难解析所有三个不相同的语句。为清晰起见，已编辑的<code class="codeph">DISPLAY_CURSOR</code>输出显示优化程序为前两个语句选择了相同的索引范围扫描计划，但使用文字<code class="codeph">165</code>为语句选择了全表扫描计划：</p><pre class="pre codeblock"><code>SQL_ID cn5250y0nqpym，子编号0 ------------------------------------- SELECT SUM（salary）FROM hr .employees WHERE employee_id &lt;101计划哈希值：2410354593 --------------------------------------- ---------------------------------------------- | Id |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- ----------------------------------- | 0 |选择声明| | | | 2（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | 2 |通过INDEX ROWID BATCHED表的访问权限员工| 1 | 8 | 2（0）| 00:00:01 | | * 3 | INDEX RANGE SCAN | EMP_EMP_ID_PK | 1 | | 1（0）| 00:00:01 | -------------------------------------------------- -----------------------------------谓词信息（由操作ID标识）：------ --------------------------------------------- 3  -  access（“ EMPLOYEE_ID“&lt;101）SQL_ID au8nag2vnfw67，子编号0 ------------------------------------- SELECT SUM （薪水）FROM hr.employees WHERE employee_id &lt;120计划哈希值：2410354593 ---------------------------------- -------------------------------------------------- -  | Id |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- ----------------------------------- | 0 |选择声明| | | | 2（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | 2 |通过INDEX ROWID BATCHED表的访问权限员工| 20 | 160 | 2（0）| 00:00:01 | | * 3 | INDEX RANGE SCAN | EMP_EMP_ID_PK | 20 | | 1（0）| 00:00:01 | -------------------------------------------------- -----------------------------------谓词信息（由操作ID标识）：------ --------------------------------------------- 3  -  access（“ EMPLOYEE_ID“&lt;120）SQL_ID b1tvfcc5qnczb，子编号0 ------------------------------------- SELECT SUM （薪水）FROM hr.employees WHERE employee_id &lt;165计划哈希值：1756381138 ---------------------------------- --------------------------------------- | Id |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- ----------------------- | 0 |选择声明| | | | 2（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | * 2 |表访问完全|员工| 66 | 528 | 2（0）| 00:00:01 | -------------------------------------------------- -----------------------谓词信息（由操作ID标识）：------------------ --------------------------------- 2  - 过滤器（“EMPLOYEE_ID”&lt;165）</code></pre><p>前面的输出显示优化程序认为全表扫描比返回更多行的查询的索引扫描更有效。</p>
                        </div>
                        <!-- class="example" -->
                        <div class="example" id="GUID-3550B486-A3D6-4FB2-99A9-4B90D4ADE421__GUID-6FD916FD-09BD-4C78-B37E-6788C4B0911E">
                           <p class="titleinexample">例20-9绑定变量导致光标重用</p>
                           <p>此示例重写<a href="improving-rwp-cursor-sharing.html#GUID-3550B486-A3D6-4FB2-99A9-4B90D4ADE421__GUID-FA3A4623-2191-44E3-B169-F456704A6F0D">示例20-8中</a>执行的查询以使用绑定变量而不是文字。绑定相同的值（ <code class="codeph">101</code> ， <code class="codeph">120</code> ，和<code class="codeph">165</code> ），以绑定变量<code class="codeph">:emp_id</code> ，然后显示每个执行计划：</p><pre class="pre codeblock"><code>VAR emp_id NUMBER EXEC：emp_id：= 101; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））; EXEC：emp_id：= 120; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））; EXEC：emp_id：= 165; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））;</code></pre><p><code class="codeph">DISPLAY_CURSOR</code>输出显示优化器为所有三个语句选择了完全相同的计划：</p><pre class="pre codeblock"><code>SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id计划哈希值：2410354593 ------------------------------- -------------------------------------------------- ---- | Id |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- ----------------------------------- | 0 |选择声明| | | | 2（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | 2 |通过INDEX ROWID BATCHED表的访问权限员工| 1 | 8 | 2（0）| 00:00:01 | | * 3 | INDEX RANGE SCAN | EMP_EMP_ID_PK | 1 | | 1（0）| 00:00:01 | -------------------------------------------------- -----------------------------------谓词信息（由操作ID标识）：------ --------------------------------------------- 3  -  access（“ EMPLOYEE_ID“&lt;：EMP_ID）</code></pre><p>相反，当使用文字执行前面的语句时，优化程序在员工ID值为<code class="codeph">165</code>时选择了成本较低的全表扫描。这是自适应游标共享解决的问题。
                           </p>
                        </div>
                        <!-- class="example" -->
                     </div>
                     <div>
                        <div class="infoboxnotealso" id="GUID-3550B486-A3D6-4FB2-99A9-4B90D4ADE421__GUID-7FEE5005-AD37-4B53-9242-46BF2804A121">
                           <p class="notep1">也可以看看：</p>
                           <p> <span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" title="自适应游标共享功能允许包含绑定变量的单个语句使用多个执行计划。">自适应光标共享</a> ”</span></p>
                        </div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-B7ABA6CC-3E81-4990-BDE4-CF69181079B9" title="绑定变量对于Oracle数据库应用程序中的游标共享至关重要。">关于文字和绑定变量</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
               </div>
               <div class="sect3"><a id="GUID-E04CF45D-CC70-4122-9BAC-EAB5B4D0E17A" name="GUID-E04CF45D-CC70-4122-9BAC-EAB5B4D0E17A"></a><h4 id="TGSQL-GUID-E04CF45D-CC70-4122-9BAC-EAB5B4D0E17A" class="sect4"><span class="enumeration_section">20.1.4</span>关于共享游标的生命周期</h4>
                  <div>
                     <p>当优化程序解析不是DDL的新SQL语句时，数据库会分配新的共享SQL区域。所需的内存量取决于语句的复杂性。</p>
                     <p>即使此区域对应于长时间未使用的打开游标，数据库也可以从共享池中删除共享SQL区域。如果稍后使用打开的游标来运行其语句，则数据库将重新分析该语句并分配新的共享SQL区域。数据库不会删除其语句正在执行或其行尚未完全获取的游标。</p>
                     <p>由于对依赖模式对象或优化程序统计信息的更改，共享SQL区域可能变为无效。Oracle数据库使用两种技术来管理游标生命周期：失效和滚动失效。</p>
                     <p>本节包含以下主题：</p>
                  </div>
                  <div>
                     <ul class="ullinks">
                        <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-8D950FF9-EFC0-4264-B4A7-427891C21909">光标标记无效</a><br>当共享SQL区域标记为无效时，数据库可以将其从共享池中删除，以及一段时间未使用的有效游标。
                        </li>
                        <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588">游标标记滚动无效</a><br>当游标标记为滚动无效（ <code class="codeph">V$SQL.IS_ROLLING_INVALID</code>为<code class="codeph">Y</code> ）时，数据库会在较长时间内逐步执行硬解析。
                        </li>
                     </ul>
                     <div class="infoboxnotealso" id="GUID-E04CF45D-CC70-4122-9BAC-EAB5B4D0E17A__GUID-BB0424E6-AC10-485A-9BB7-F099820F3BA7">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../cncpt/memory-architecture.html#GUID-F41EF3AF-42D7-4445-A2DD-E800A5E54E3F" target="_blank"><span><cite>Oracle数据库概念，</cite></span></a>用于概述共享池中的内存分配</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-1DEE6AD7-C30E-4ABB-9BFF-B5895A6E386B" title="Oracle数据库可以共享游标，这些游标是指向共享池中私有SQL区域的指针。">游标共享概述</a></p>
                        </div>
                     </div>
                  </div>
                  
                  <div class="sect4"><a id="GUID-8D950FF9-EFC0-4264-B4A7-427891C21909" name="GUID-8D950FF9-EFC0-4264-B4A7-427891C21909"></a><h5 id="TGSQL-GUID-8D950FF9-EFC0-4264-B4A7-427891C21909" class="sect5"><span class="enumeration_section">20.1.4.1</span>标记无效的光标</h5>
                     <div>
                        <p>当共享SQL区域标记为无效时，数据库可以将其从共享池中删除，以及一段时间未使用的有效游标。</p>
                        <p>在某些情况下，数据库必须执行与共享池中的无效共享SQL区域关联的语句。在这种情况下，数据库在执行之前执行语句的硬解析。</p>
                        <p>满足以下条件时，数据库会立即将相关的共享SQL区域标记为无效：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>当<code class="codeph">NO_INVALIDATE</code>参数为<code class="codeph">FALSE</code>时， <code class="codeph">DBMS_STATS</code>收集表，表簇或索引的统计信息。</p>
                           </li>
                           <li>
                              <p>SQL语句引用模式对象，该模式对象稍后由使用立即游标失效的DDL语句修改（默认）。</p>
                              <p>您可以在语句上手动指定立即失效，例如<code class="codeph">ALTER TABLE ...IMMEDIATE VALIDATION</code>和<code class="codeph">ALTER INDEX ...IMMEDIATE VALIDATION</code> ，或在会话或系统级别将<code class="codeph">CURSOR_INVALIDATION</code>初始化参数设置为<code class="codeph">IMMEDIATE</code> 。
                              </p>
                              <div class="infoboxnote" id="GUID-8D950FF9-EFC0-4264-B4A7-427891C21909__GUID-515E1D5A-8CDD-461A-A4DA-3166A57B8458">
                                 <p class="notep1">注意：</p>
                                 <p>使用<code class="codeph">DEFERRED VALIDATION</code>子句的DDL语句将覆盖<code class="codeph">CURSOR_INVALIDATION</code>初始化参数的<code class="codeph">IMMEDIATE</code>设置。
                                 </p>
                              </div>
                           </li>
                        </ul>
                        <p>满足上述条件时，数据库会在下次执行时重新处理受影响的语句。</p>
                        <p>当数据库使游标无效时， <code class="codeph">V$SQL.INVALIDATIONS</code>值会增加（例如，从<code class="codeph">0</code>增加到<code class="codeph">1</code> ），并且<code class="codeph">V$SQL.OBJECT_STATUS</code>显示<code class="codeph">INVALID_UNAUTH</code> 。</p>
                        <div class="example" id="GUID-8D950FF9-EFC0-4264-B4A7-427891C21909__GUID-6236BE5D-98B5-43B5-BC5F-9A28546F878B">
                           <p class="titleinexample">示例20-10通过设置NO_INVALIDATE = FALSE强制光标失效</p>
                           <p>此示例以用户<code class="codeph">sh</code>身份登录，该用户已被授予管理员权限。该示例查询<code class="codeph">sales</code> ，然后使用<code class="codeph">NO_INVALIDATE=FALSE</code>收集此表的统计信息。之后， <code class="codeph">V$SQL.INVALIDATIONS</code>值从<code class="codeph">0</code>变为<code class="codeph">1</code> ，表示数据库将游标标记为无效。
                           </p><pre class="pre codeblock"><code>SQL&gt; SELECT COUNT（*）FROM sales; COUNT（*）---------- 918843 SQL&gt; SELECT PREV_SQL_ID SQL_ID FROM V $ SESSION WHERE SID = SYS_CONTEXT（'userenv'，'SID'）; SQL_ID ------------- 1y17j786c7jbh SQL&gt; SELECT CHILD_NUMBER，EXECUTIONS，2 PARSE_CALLS，INVALIDATIONS，OBJECT_STATUS 3 FROM V $ SQL WHERE SQL_ID ='1y17j786c7jbh'; CHILD_NUMBER EXECUTIONS PARSE_CALLS INVALIDATIONS OBJECT_STATUS ------------ ---------- ----------- ------------ -  ------------- 0 1 1 0 VALID SQL&gt; EXEC DBMS_STATS.GATHER_TABLE_STATS（null，'sales'，no_invalidate =&gt; FALSE）; PL / SQL过程成功完成。SQL&gt; SELECT CHILD_NUMBER，EXECUTIONS，2 PARSE_CALLS，INVALIDATIONS，OBJECT_STATUS 3 FROM V $ SQL WHERE SQL_ID ='1y17j786c7jbh'; CHILD_NUMBER EXECUTIONS PARSE_CALLS INVALIDATIONS OBJECT_STATUS ------------ ---------- ----------- ------------ -  -------------- 0 1 1 1 INVALID_UNAUTH</code></pre></div>
                        <!-- class="example" -->
                     </div>
                     <div>
                        <div class="infoboxnotealso" id="GUID-8D950FF9-EFC0-4264-B4A7-427891C21909__ORACLEDATABASESQLTUNINGGUIDETOLEARN-DEBC5660">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><span class="q">“ <a href="influencing-the-optimizer.html#GUID-C1C85DEA-3583-40FE-B5BB-6AC8F76FFE34" title="Oracle数据库提供初始化参数以影响优化器行为的各个方面，包括游标共享，自适应优化和优化器模式。">关于优化器初始化参数</a> ”</span></p>
                              </li>
                              <li>
                                 <p><a href="../sqlrf/ALTER-TABLE.html#SQLRF01001" target="_blank"><span><cite>Oracle数据库SQL语言参考</cite></span></a>以了解有关<code class="codeph">ALTER TABLE ...更多信息<code class="codeph">ALTER TABLE ...IMMEDIATE VALIDATION</code>和其他允许立即验证的DDL语句</p>
                              </li>
                              <li>
                                 <p><a href="../refrn/V-SQL.html#REFRN30246" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解有关<code class="codeph">V$SQL</code>和<code class="codeph">V$SQLAREA</code>动态视图的更多信息</p>
                              </li>
                              <li>
                                 <p><a href="../refrn/CURSOR_INVALIDATION.html#REFRN-GUID-6BAB61E7-FABA-41D3-B73A-EB828A6767E5" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解有关<code class="codeph">CURSOR_INVALIDATION</code>初始化参数的更多信息</p>
                              </li>
                           </ul>
                        </div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-E04CF45D-CC70-4122-9BAC-EAB5B4D0E17A" title="当优化程序解析不是DDL的新SQL语句时，数据库会分配新的共享SQL区域。所需的内存量取决于语句的复杂性。">关于共享游标的生命周期</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
                  <div class="sect4"><a id="GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588" name="GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588"></a><h5 id="TGSQL-GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588" class="sect5"><span class="enumeration_section">20.1.4.2</span>标记滚动无效的游标</h5>
                     <div>
                        <p>当游标标记为滚动无效（ <code class="codeph">V$SQL.IS_ROLLING_INVALID</code>为<code class="codeph">Y</code> ）时，数据库会在较长时间内逐步执行硬解析。
                        </p>
                        <div class="infoboxnote" id="GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588__GUID-D0B46ECA-71CA-449C-8878-AF2C1250763A">
                           <p class="notep1">注意：</p>
                           <p>当<code class="codeph">V$SQL.IS_ROLLING_REFRESH_INVALID</code>为<code class="codeph">Y</code> ，基础对象已更改，但不需要重新编译游标。数据库更新游标中的元数据。
                           </p>
                        </div>
                        <div class="section">
                           <p class="subhead3" id="GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588__GUID-0C183D1F-EF53-40EE-B471-8332C769D73A">滚动失效的目的</p>
                           <p>由于硬分析的急剧增加会严重降低性能，因此滚动失效（也称为<span class="italic">延迟失效）</span>对于同时使许多游标无效的工作负载非常有用。数据库为每个无效光标分配一个随机生成的时间段。同时失效的SQL区域通常具有不同的时间段。
                           </p>
                           <p>只有在时间段到期<span class="italic">后</span>访问游标的查询执行时才会发生硬解析。通过这种方式，数据库会随着时间的推移扩散硬分析的开销。
                           </p>
                           <div class="infoboxnote" id="GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588__GUID-5B8DB31C-6F8E-473C-BF07-EC553D69A0EA">
                              <p class="notep1">注意：</p>
                              <p>如果并行SQL语句被标记为滚动无效，则数据库在下次执行时执行硬解析，而不管时间段是否已过期。在Oracle Real Application Clusters（Oracle RAC）环境中，此技术可确保并行执行服务器和查询协调器的执行计划之间的一致性。</p>
                           </div>
                           <p>滚动失效的类比可能是逐渐更换破旧的办公家具。公司不是一次性更换所有家具，而是需要大量的财务支出，而是为每件工作分配不同的到期日期。在一年的过程中，一件产品一直待用，直到更换为止，此时会产生成本。</p>
                        </div>
                        <!-- class="section" -->
                        <div class="section">
                           <p class="subhead3" id="GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588__GUID-8F6F3DDE-B238-42E0-AF98-CC8EA3F56BD8">延期失效的规范</p>
                           <p>默认情况下，DDL指定访问对象的语句使用立即游标失效。例如，如果创建表或索引，则引用此表或索引的游标将立即使用失效。</p>
                           <p>如果DDL语句支持延迟游标失效，则可以使用<code class="codeph">ALTER TABLE ...等语句覆盖默认行为<code class="codeph">ALTER TABLE ...DEFERRED INVALIDATION</code> 。选项取决于DDL语句。例如，当指定了<code class="codeph">UNUSABLE</code>或<code class="codeph">REBUILD</code>选项时， <code class="codeph">ALTER INDEX</code>仅支持<code class="codeph">DEFERRED INVALIDATION</code> 。
                           </p>
                           <p>DDL的替代方法是在会话或系统级别将<code class="codeph">CURSOR_INVALIDATION</code>初始化参数设置为<code class="codeph">DEFERRED</code> 。使用<code class="codeph">IMMEDIATE INVALIDATION</code>子句的DDL语句将覆盖<code class="codeph">CURSOR_INVALIDATION</code>初始化参数的<code class="codeph">DEFERRED</code>设置。
                           </p>
                        </div>
                        <!-- class="section" -->
                        <div class="section">
                           <p class="subhead3" id="GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588__GUID-C2858E6D-0111-4CC7-AA42-6D97C07FAD14">滚动失效时发生</p>
                           <p>如果<code class="codeph">DEFERRED INVALIDATION</code>属性作为DDL或初始化参数设置的结果应用于对象，则访问该对象的语句可能会被延迟失效。在以下任一情况下，数据库将共享SQL区域标记为滚动无效：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>当<code class="codeph">NO_INVALIDATE</code>参数设置为<code class="codeph">DBMS_STATS.AUTO_INVALIDATE</code>时， <code class="codeph">DBMS_STATS</code>收集表，表群集或索引的统计信息。这是默认设置。
                                 </p>
                              </li>
                              <li>
                                 <p>在不阻止使用延迟失效的情况下，下列声明之一与<code class="codeph">DEFERRED INVALIDATION</code>一起发布：</p>
                                 <ul style="list-style-type:disc">
                                    <li>
                                       <p>分区表上的<a href="../sqlrf/ALTER-TABLE.html#GUID-552E7373-BF93-477D-9DA3-B2C9386F2877" target="_blank"><code class="codeph">ALTER TABLE</code></a></p>
                                    </li>
                                    <li>
                                       <p><a href="../sqlrf/ALTER-TABLE.html#GUID-552E7373-BF93-477D-9DA3-B2C9386F2877" target="_blank"><code class="codeph">ALTER TABLE ...平行</code></a></p>
                                    </li>
                                    <li>
                                       <p><a href="../sqlrf/ALTER-INDEX.html#GUID-D8F648E7-8C07-4C89-BB71-862512536558" target="_blank"><code class="codeph">改变指数......UNUSABLE</code></a></p>
                                    </li>
                                    <li>
                                       <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/tgsql&amp;id=GUID-D8F648E7-8C07-4C89-BB71-862512536558" target="_blank"><code class="codeph">改变指数......重建</code></a></p>
                                    </li>
                                    <li>
                                       <p><a href="../sqlrf/CREATE-INDEX.html#GUID-1F89BBC0-825F-4215-AF71-7588E31D8BFE" target="_blank"><code class="codeph">创建指数</code></a></p>
                                    </li>
                                    <li>
                                       <p><a href="../sqlrf/DROP-INDEX.html#GUID-F60F75DF-2866-4F93-BB7F-8FCE64BF67B6" target="_blank"><code class="codeph">DROP INDEX</code></a></p>
                                    </li>
                                    <li>
                                       <p>分区表上的<a href="../sqlrf/TRUNCATE-TABLE.html#GUID-B76E5846-75B5-4876-98EC-439E15E4D8A4" target="_blank"><code class="codeph">TRUNCATE TABLE</code></a></p>
                                    </li>
                                 </ul>
                                 <p>DDL语句的子集需要立即对DML（ <code class="codeph">INSERT</code> ， <code class="codeph">UPDATE</code> ， <code class="codeph">DELETE</code>或<code class="codeph">MERGE</code> ）进行游标失效，而不是<code class="codeph">SELECT</code>语句。与特定DDL语句和受影响游标相关的许多因素决定了Oracle数据库是否使用延迟失效。
                                 </p>
                              </li>
                           </ul>
                        </div>
                        <!-- class="section" -->
                     </div>
                     <div>
                        <div class="infoboxnotealso" id="GUID-0BCC0D7A-F1E9-4173-B123-F175BC236588__ORACLEDATABASESQLTUNINGGUIDETOLEARN-DEBC5660">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><span class="q">“ <a href="influencing-the-optimizer.html#GUID-C1C85DEA-3583-40FE-B5BB-6AC8F76FFE34" title="Oracle数据库提供初始化参数以影响优化器行为的各个方面，包括游标共享，自适应优化和优化器模式。">关于优化器初始化参数</a> ”</span></p>
                              </li>
                              <li>
                                 <p><a href="../sqlrf/ALTER-TABLE.html#SQLRF01001" target="_blank"><span><cite>Oracle数据库SQL语言参考</cite></span></a>以了解有关<code class="codeph">ALTER TABLE ...更多信息<code class="codeph">ALTER TABLE ...DEFERRED INVALIDATION</code>和其他允许延期失效的DDL声明</p>
                              </li>
                              <li>
                                 <p><a href="../refrn/V-SQL.html#REFRN30246" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解有关<code class="codeph">V$SQL</code>和<code class="codeph">V$SQLAREA</code>动态视图的更多信息</p>
                              </li>
                              <li>
                                 <p><a href="../refrn/CURSOR_INVALIDATION.html#REFRN-GUID-6BAB61E7-FABA-41D3-B73A-EB828A6767E5" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解有关<code class="codeph">CURSOR_INVALIDATION</code>初始化参数的更多信息</p>
                              </li>
                           </ul>
                        </div>
                        <div class="familylinks">
                           <div class="parentlink">
                              <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-E04CF45D-CC70-4122-9BAC-EAB5B4D0E17A" title="当优化程序解析不是DDL的新SQL语句时，数据库会分配新的共享SQL区域。所需的内存量取决于语句的复杂性。">关于共享游标的生命周期</a></p>
                           </div>
                        </div>
                     </div>
                     
                  </div>
               </div>
            </div><a id="TGSQL94748"></a><div class="props_rev_3"><a id="GUID-267E5860-A8D5-4E5F-AE60-16304E97E4EE" name="GUID-267E5860-A8D5-4E5F-AE60-16304E97E4EE"></a><h3 id="TGSQL-GUID-267E5860-A8D5-4E5F-AE60-16304E97E4EE" class="sect3"><span class="enumeration_section">20.2</span> CURSOR_SHARING和绑定变量替换</h3>
               <div>
                  <p>本主题说明了<code class="codeph">CURSOR_SHARING</code>初始化参数是什么，以及如何将其设置为不同的值会影响Oracle数据库如何使用绑定变量。
                  </p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-7A0CD3D1-1ECB-4DA4-813A-0D8D79C8B65D">CURSOR_SHARING初始化参数</a><br><code class="codeph">CURSOR_SHARING</code>初始化参数控制数据库如何使用绑定变量处理语句。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-250B8578-4407-4A10-B609-67C2276EBBBB">当CURSOR_SHARING = FORCE时解析行为</a><br>当SQL语句使用文字而不是绑定变量时，将<code class="codeph">CURSOR_SHARING</code>初始化参数设置为<code class="codeph">FORCE</code>可使数据库使用系统生成的绑定变量替换文字。使用此技术，数据库有时可以减少共享SQL区域中父游标的数量。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-971F4652-3950-4662-82DE-713DDEED317C" title="游标共享可以将数据库应用程序性能提高几个数量级。">通过游标共享提高实际性能</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-7A0CD3D1-1ECB-4DA4-813A-0D8D79C8B65D" name="GUID-7A0CD3D1-1ECB-4DA4-813A-0D8D79C8B65D"></a><h4 id="TGSQL-GUID-7A0CD3D1-1ECB-4DA4-813A-0D8D79C8B65D" class="sect4"><span class="enumeration_section">20.2.1</span> CURSOR_SHARING初始化参数</h4>
                  <div>
                     <p><code class="codeph">CURSOR_SHARING</code>初始化参数控制数据库如何使用绑定变量处理语句。
                     </p>
                     <div class="section">
                        <p>在<span>Oracle Database 12c中</span> ，该参数支持以下值：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">精确</code></p>
                              <p>这是默认值。数据库只允许文本相同的语句共享游标。数据库不会尝试使用系统生成的绑定变量替换文字值。在这种情况下，优化程序会根据文字值为每个语句生成计划。</p>
                           </li>
                           <li>
                              <p><code class="codeph">力</code></p>
                              <p>数据库用系统生成的绑定变量替换所有文字。对于在绑定变量替换文字后相同的语句，优化程序使用相同的计划。</p>
                           </li>
                        </ul>
                        <div class="infoboxnote" id="GUID-7A0CD3D1-1ECB-4DA4-813A-0D8D79C8B65D__GUID-0AA98E35-F14C-4578-911C-08B989FD2885">
                           <p class="notep1">注意：</p>
                           <p>不推荐使用<code class="codeph">CURSOR_SHARING</code>的<code class="codeph">SIMILAR</code>值。
                           </p>
                        </div>
                        <p>您可以在系统或会话级别设置<code class="codeph">CURSOR_SHARING</code> ，或在语句级别使用<code class="codeph">CURSOR_SHARING_EXACT</code>提示。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-7A0CD3D1-1ECB-4DA4-813A-0D8D79C8B65D__GUID-9CD5DA26-0477-4437-8155-9E5B890F6913">
                        <p class="notep1">也可以看看：</p>
                        <p><span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346" title="最佳实践是编写可共享的SQL，并使用默认的EXACT进行CURSOR_SHARING。">不要使用CURSOR_SHARING = FORCE作为永久修复</a> ”</span></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-267E5860-A8D5-4E5F-AE60-16304E97E4EE" title="本主题说明了CURSOR_SHARING初始化参数是什么，以及如何将其设置为不同的值会影响Oracle数据库如何使用绑定变量。">CURSOR_SHARING和绑定变量替换</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL94749"></a><div class="props_rev_3"><a id="GUID-250B8578-4407-4A10-B609-67C2276EBBBB" name="GUID-250B8578-4407-4A10-B609-67C2276EBBBB"></a><h4 id="TGSQL-GUID-250B8578-4407-4A10-B609-67C2276EBBBB" class="sect4"><span class="enumeration_section">20.2.2</span> CURSOR_SHARING = FORCE时的解析行为</h4>
                  <div>
                     <p>当SQL语句使用文字而不是绑定变量时，将<code class="codeph">CURSOR_SHARING</code>初始化参数设置为<code class="codeph">FORCE</code>可使数据库使用系统生成的绑定变量替换文字。使用此技术，数据库有时可以减少共享SQL区域中父游标的数量。
                     </p>
                     <div class="infoboxnote" id="GUID-250B8578-4407-4A10-B609-67C2276EBBBB__GUID-70C3427D-7F0A-4814-BF08-664009ED7865">
                        <p class="notep1">注意：</p>
                        <p>如果语句使用<code class="codeph">ORDER BY</code>子句，则数据库不会在子句中执行文字替换，因为将常量列号视为文字在语义上是不正确的。<code class="codeph">ORDER BY</code>子句中的列号会影响查询计划和执行，因此数据库不能共享具有不同列号的两个游标。
                        </p>
                     </div>
                     <p>当<code class="codeph">CURSOR_SHARING</code>设置为<code class="codeph">FORCE</code> ，数据库在解析期间执行以下步骤：</p>
                     <ol>
                        <li>
                           <p>将语句中的<span class="italic">所有</span>文字复制到PGA，并将其替换为系统生成的绑定变量</p>
                           <p>例如，应用程序可以处理以下语句：</p><pre class="pre codeblock"><code>SELECT SUBSTR（last_name，1,4），SUM（salary）FROM hr.employees WHERE employee_id &lt;101 GROUP BY last_name</code></pre><p>优化器替换文字，包括<code class="codeph">SUBSTR</code>函数中的文字，如下所示：</p><pre class="pre codeblock"><code>SELECT SUBSTR（last_name，：“SYS_B_0”，：“SYS_B_1”），SUM（薪水）FROM hr.employees WHERE employee_id &lt;：“SYS_B_2”GROUP BY last_name</code></pre></li>
                        <li>
                           <p>在共享池中搜索相同的语句（相同的SQL哈希值）</p>
                           <p>如果<span class="italic">没有</span>找到相同的语句，则数据库执行硬分析。否则，数据库继续下一步。
                           </p>
                        </li>
                        <li>
                           <p>执行语句的软解析</p>
                        </li>
                     </ol>
                     <p>由于前面的步骤表明，该设置<code class="codeph">CURSOR_SHARING</code>初始化参数<code class="codeph">FORCE</code> <span class="italic">不</span>降低解析数。相反，在某些情况下， <code class="codeph">FORCE</code>使数据库能够执行软解析而不是硬解析。此外， <code class="codeph">FORCE</code>不能防止SQL注入攻击，因为Oracle数据库会在任何注入已经发生后绑定值。
                     </p>
                     <div class="example" id="GUID-250B8578-4407-4A10-B609-67C2276EBBBB__GUID-2321405F-C9F1-45E1-AD89-667498594D02">
                        <p class="titleinexample">例20-11用系统绑定变量替换文字</p>
                        <p>此示例在会话级别将<code class="codeph">CURSOR_SHARING</code>设置为<code class="codeph">FORCE</code> ，执行包含文字的三个语句，并显示每个语句的计划：</p><pre class="pre codeblock"><code>ALTER SESSION SET CURSOR_SHARING = FORCE; SET LINESIZE 170 SET PAGESIZE 0 SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;101; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;120; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;165; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR（））;</code></pre><p>为便于阅读而编辑的以下<code class="codeph">DISPLAY_CURSOR</code>输出显示所有三个语句都使用相同的计划。优化器选择了计划，即索引范围扫描，因为它查看了绑定到系统绑定变量的<span class="italic">第一个</span>值（ <code class="codeph">101</code> ），并选择此计划作为所有值的最佳值。事实上，这个计划并不是所有价值观的最佳计划。当值为<code class="codeph">165</code> ，全表扫描更有效。
                        </p><pre class="pre codeblock"><code>SQL_ID cxx8n1cxr9khn，子编号0 ------------------------------------- SELECT SUM（salary）FROM hr .employees WHERE employee_id &lt;：“SYS_B_0”计划哈希值：2410354593 ------------------------------------ ------------------------------------------------- | Id |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- ----------------------------------- | 0 |选择声明| | | | 2（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | 2 |通过INDEX ROWID BATCHED表的访问权限员工| 1 | 8 | 2（0）| 00:00:01 | | * 3 | INDEX RANGE SCAN | EMP_EMP_ID_PK | 1 | | 1（0）| 00:00:01 | -------------------------------------------------- -----------------------------------谓词信息（由操作ID标识）：------ --------------------------------------------- 3  -  access（“ EMPLOYEE_ID“&lt;101）</code></pre><p>对<code class="codeph">V$SQLAREA</code>查询确认Oracle数据库已替换为带有系统绑定变量的文字<code class="codeph">:”SYS_B_0”</code> ，并为所有三个语句创建了一个父游标和一个子游标（ <code class="codeph">VERSION_COUNT=1</code> ），这意味着所有执行都共享相同的计划。
                        </p><pre class="pre codeblock"><code>COL SQL_TEXT FORMAT a36 SELECT SQL_TEXT，SQL_ID，VERSION_COUNT，HASH_VALUE FROM V $ SQLAREA WHERE SQL_TEXT LIKE'％mployee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'; SQL_TEXT SQL_ID VERSION_COUNT HASH_VALUE ------------------------------------ ---------- --- ------------- ---------- SELECT SUM（薪水）FROM hr.employees cxx8n1cxr9khn 1 997509652 WHERE employee_id &lt;：“SYS_B_0”</code></pre></div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-250B8578-4407-4A10-B609-67C2276EBBBB__GUID-C8938B20-ABD1-4FE3-B718-2D84BCB814D5">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-782D3329-0CC5-4312-B9B5-2A012A4AD7C8" title="私有SQL区域中的游标指向库高速缓存中的共享SQL区域。">私有和共享SQL区域</a> ”</span> ，了解有关执行的各种检查的更多详细信息</p>
                           </li>
                           <li>
                              <p><a href="../refrn/CURSOR_SHARING.html#REFRN10025" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">CURSOR_SHARING</code>初始化参数</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-267E5860-A8D5-4E5F-AE60-16304E97E4EE" title="本主题说明了CURSOR_SHARING初始化参数是什么，以及如何将其设置为不同的值会影响Oracle数据库如何使用绑定变量。">CURSOR_SHARING和绑定变量替换</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL94740"></a><div class="props_rev_3"><a id="GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" name="GUID-277432AA-CD1C-4A75-AB28-7358E63265B3"></a><h3 id="TGSQL-GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" class="sect3"><span class="enumeration_section">20.3</span>自适应游标共享</h3>
               <div>
                  <p><strong class="term">自适应游标共享</strong>功能允许包含绑定变量的单个语句使用多个执行计划。
                  </p>
                  <p>游标共享是“自适应的”，因为游标会调整其行为，因此数据库并不总是对每个执行或绑定变量值使用相同的计划。本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-42432DFE-D56A-4B9A-8FCF-94FB86012AFC">自适应游标共享的目的</a><br>使用绑定查看时，优化程序会在第一次调用游标时查看用户定义的绑定变量的值。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-25A179EF-CAE7-42A2-BF91-F1D4EDAACCEC">自适应游标共享的工作原理：示例</a><br>自适应游标共享监视使用绑定变量来确定新计划是否更有效的语句。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C">绑定敏感游标</a><br><span class="bold">绑定敏感游标</span>是一种游标，其最佳计划可能取决于绑定变量的值。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4">Bind-Aware Cursors</a><br><span class="bold">绑定感知游标</span>是绑定敏感游标，可以使用不同的绑定值的不同计划。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-59B4BED5-62FF-421F-92ED-7BB32F6E68F4">游标合并</a><br>如果优化程序为可识别绑定的游标创建计划，并且此计划与现有游标相同，则优化程序可以执行<strong class="term">游标合并</strong> 。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-A3B8972A-A74D-4353-960B-5E09D294031E">自适应游标共享视图</a><br>您可以使用<code class="codeph">V$</code>视图进行自适应游标共享，以查看选择性范围，游标信息（例如游标是绑定感知还是绑定敏感）以及执行统计信息。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-971F4652-3950-4662-82DE-713DDEED317C" title="游标共享可以将数据库应用程序性能提高几个数量级。">通过游标共享提高实际性能</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-42432DFE-D56A-4B9A-8FCF-94FB86012AFC" name="GUID-42432DFE-D56A-4B9A-8FCF-94FB86012AFC"></a><h4 id="TGSQL-GUID-42432DFE-D56A-4B9A-8FCF-94FB86012AFC" class="sect4"><span class="enumeration_section">20.3.1</span>自适应光标共享的目的</h4>
                  <div>
                     <p>使用绑定查看时，优化程序会在第一次调用游标时查看用户定义的绑定变量的值。</p>
                     <p>优化器确定任何<code class="codeph">WHERE</code>子句条件的基数，就像使用了文字而不是绑定变量一样。但是，如果<code class="codeph">WHERE</code>子句中的列具有倾斜数据，则此列上可能存在直方图。当优化程序查看用户定义的绑定变量的值并选择计划时，此计划可能不适用于所有值。
                     </p>
                     <p>在自适应游标共享中，数据库监视随时间访问的不同绑定值的数据，确保为特定绑定值选择最佳游标。例如，优化器可以为绑定值<code class="codeph">10</code>选择一个计划，为绑定值<code class="codeph">50</code>选择不同的计划。游标共享是“自适应的”，因为游标调整其行为，以便优化器不总是为每个执行或绑定变量值选择相同的计划。因此，优化器会自动检测语句的不同执行何时会从不同的执行计划中受益。
                     </p>
                     <div class="infoboxnote" id="GUID-42432DFE-D56A-4B9A-8FCF-94FB86012AFC__GUID-07DBCDAF-D36B-4C4E-B4E7-2A0BCEDB2D9E">
                        <p class="notep1">注意：</p>
                        <p>自适应游标共享独立于<code class="codeph">CURSOR_SHARING</code>初始化参数。自适应游标共享同样适用于包含用户定义和系统生成的绑定变量的语句。自适应游标共享不适用于仅包含文字的语句。
                        </p>
                     </div>
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" title="自适应游标共享功能允许包含绑定变量的单个语句使用多个执行计划。">自适应游标共享</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
               <div class="sect3"><a id="GUID-25A179EF-CAE7-42A2-BF91-F1D4EDAACCEC" name="GUID-25A179EF-CAE7-42A2-BF91-F1D4EDAACCEC"></a><h4 id="TGSQL-GUID-25A179EF-CAE7-42A2-BF91-F1D4EDAACCEC" class="sect4"><span class="enumeration_section">20.3.2</span>自适应游标共享的工作<span class="enumeration_section">原理</span> ：示例</h4>
                  <div>
                     <p>自适应游标共享监视使用绑定变量来确定新计划是否更有效的语句。</p>
                     <p>假设应用程序执行以下语句五次，每次绑定不同的值：</p><pre class="pre codeblock"><code>SELECT * FROM employees WHERE salary =：sal AND department_id =：dept</code></pre><p>在该示例中还假设直方图存在于谓词中的至少一个列上。数据库处理此语句如下：</p>
                     <ol>
                        <li>
                           <p>应用程序首次发出语句，这会导致硬分析。在解析期间，数据库执行以下任务：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>查看绑定变量以生成初始计划。</p>
                              </li>
                              <li>
                                 <p>将游标标记为绑定敏感。<a href="glossary.html#GUID-13913DD1-DD30-49DF-8041-B3C0F0DC7F7D"><span class="xrefglossterm">绑定敏感游标</span></a>是一种游标，其最佳计划可能取决于绑定变量的值。要确定不同的计划是否有益，数据库将监视使用不同绑定值的绑定敏感游标的行为。
                                 </p>
                              </li>
                              <li>
                                 <p>存储有关谓词的元数据，包括绑定值的基数（在此示例中，假设仅返回5行）。</p>
                              </li>
                              <li>
                                 <p>根据查看的值创建执行计划（在此示例中为索引访问）。</p>
                              </li>
                           </ul>
                        </li>
                        <li>
                           <p>数据库执行游标，在游标中存储绑定值和执行统计信息。</p>
                        </li>
                        <li>
                           <p>应用程序第二次发出语句，使用不同的绑定变量，使数据库执行软解析，并在库高速缓存中找到匹配的游标。</p>
                        </li>
                        <li>
                           <p>数据库执行游标。</p>
                        </li>
                        <li>
                           <p>数据库执行以下执行后任务：</p>
                           <ol type="a">
                              <li>
                                 <p>数据库将第二次执行的执行统计信息与第一次执行的统计信息进行比较。</p>
                              </li>
                              <li>
                                 <p>数据库观察所有先前执行的统计模式，然后决定是否将游标标记为可<a href="glossary.html#GUID-4266372A-4D7E-4738-92BA-868354F55786"><span class="xrefglossterm">识别绑定的游标</span></a> 。在此示例中，假设数据库确定游标是绑定感知的。
                                 </p>
                              </li>
                           </ol>
                        </li>
                        <li>
                           <p>应用程序第三次使用不同的绑定变量发出语句，这会导致软解析。因为游标是绑定感知的，所以数据库执行以下操作：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>确定新值的基数是否与存储的基数在同一范围内。在此示例中，基数类似：8行而不是5行。</p>
                              </li>
                              <li>
                                 <p>在现有子游标中重用执行计划。</p>
                              </li>
                           </ul>
                        </li>
                        <li>
                           <p>数据库执行游标。</p>
                        </li>
                        <li>
                           <p>应用程序第四次发出语句，使用不同的绑定变量，从而导致软解析。因为游标是绑定感知的，所以数据库执行以下操作：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>确定新值的基数是否与存储的基数在同一范围内。在这个例子中，基数是非常不同的：102行（在107行的表中）而不是5行。</p>
                              </li>
                              <li>
                                 <p>找不到匹配的子游标。</p>
                              </li>
                           </ul>
                        </li>
                        <li>
                           <p>数据库执行硬解析。因此，数据库执行以下操作：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>使用<span class="italic">第二个</span>执行计划创建一个新的子游标（在本例中为全表扫描）</p>
                              </li>
                              <li>
                                 <p>存储有关谓词的元数据，包括游标中绑定值的基数</p>
                              </li>
                           </ul>
                        </li>
                        <li>
                           <p>数据库执行新游标。</p>
                        </li>
                        <li>
                           <p>数据库将新绑定值和执行统计信息存储在新子游标中。</p>
                        </li>
                        <li>
                           <p>应用程序第五次使用不同的绑定变量发出语句，这会导致软解析。因为游标是绑定感知的，所以数据库执行以下操作：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>确定新值的基数是否与存储的基数在同一范围内。在此示例中，基数为20。</p>
                              </li>
                              <li>
                                 <p>找不到匹配的子游标。</p>
                              </li>
                           </ul>
                        </li>
                        <li>
                           <p>数据库执行硬解析。因此，数据库执行以下操作：</p>
                           <ol type="a">
                              <li>
                                 <p>使用<span class="italic">第三个</span>执行计划创建一个新的子游标（在此示例中为索引访问）</p>
                              </li>
                              <li>
                                 <p>确定此索引访问执行计划与用于首次执行语句的索引访问执行计划相同</p>
                              </li>
                              <li>
                                 <p>合并包含索引访问计划的两个子游标，其中包括将组合的基数统计信息存储到一个子游标中，并删除另一个子游标</p>
                              </li>
                           </ol>
                        </li>
                        <li>
                           <p>数据库使用索引访问执行计划执行游标。</p>
                        </li>
                     </ol>
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" title="自适应游标共享功能允许包含绑定变量的单个语句使用多个执行计划。">自适应游标共享</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL94742"></a><a id="TGSQL94741"></a><div class="props_rev_3"><a id="GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C" name="GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C"></a><h4 id="TGSQL-GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C" class="sect4"><span class="enumeration_section">20.3.3</span>绑定敏感游标</h4>
                  <div>
                     <p><span class="bold">绑定敏感游标</span>是一种游标，其最佳计划可能取决于绑定变量的值。
                     </p>
                     <p>数据库在计算基数时检查了绑定值，并认为查询“敏感”以根据不同的绑定值计划更改。数据库监视绑定敏感游标的行为，该游标使用不同的绑定值来确定不同的计划是否有益。</p>
                     <p>优化程序使用以下条件来确定游标是否是绑定敏感的：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>优化器已查看绑定值以生成基数估计值。</p>
                        </li>
                        <li>
                           <p>绑定用于相等或范围谓词。</p>
                        </li>
                     </ul>
                     <p>对于使用新绑定值执行查询的每次执行，数据库会记录新值的执行统计信息，并将它们与先前值的执行统计信息进行比较。如果执行统计信息差别很大，则数据库会将游标标记为可识别绑定。</p>
                     <div class="example" id="GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-AE386A44-DBE5-4B73-B866-37129E9C9070">
                        <p class="titleinexample">示例20-12具有重要数据偏斜的列</p>
                        <p>此示例假定<code class="codeph">hr.employees.department_id</code>列具有显着的数据倾斜。<code class="codeph">SYSTEM</code>执行以下设置代码，它将部门50中的100,000名员工添加到示例模式中的<code class="codeph">employees</code>表中，总共100,107行，然后收集表统计信息：</p><pre class="pre codeblock"><code>DELETE FROM hr.employees WHERE employee_id&gt; 999; ALTER TABLE hr.employees DISABLE NOVALIDATE CONSTRAINT emp_email_uk; DECLARE v_counter NUMBER（7）：= 1000;开始为i IN 1..100000 LOOP INSERT INTO hr.employees VALUES（v_counter，null，'Doe'，'Doe @ example.com'，null，'07 -JUN-02'，'AC_ACCOUNT'，null，null，空，50）; v_counter：= v_counter + 1;结束循环;结束; / COMMIT; EXEC DBMS_STATS.GATHER_TABLE_STATS（ownname =&gt;'hr'，tabname =&gt;'employees'）; ALTER SYSTEM FLUSH SHARED_POOL;</code></pre><p>以下查询显示了<code class="codeph">employees.department_id</code>列的直方图：</p><pre class="pre codeblock"><code>COL TABLE_NAME FORMAT a15 COL COLUMN_NAME FORMAT a20 COL HISTOGRAM FORMAT a9 SELECT TABLE_NAME，COLUMN_NAME，HISTOGRAM FROM DBA_TAB_COLS WHERE OWNER ='HR'且TABLE_NAME ='EMPLOYEES'且COLUMN_NAME ='DEPARTMENT_ID'; TABLE_NAME COLUMN_NAME HISTOGRAM --------------- -------------------- --------- EMPLOYEES DEPARTMENT_ID FREQUENCY</code></pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-F1AFAAFE-CCB3-4117-89F6-5E09A17377E7">
                        <p class="titleinexample">例20-13低基数查询</p>
                        <p>此示例继续<a href="improving-rwp-cursor-sharing.html#GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-AE386A44-DBE5-4B73-B866-37129E9C9070">示例20-12</a>中的<a href="improving-rwp-cursor-sharing.html#GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-AE386A44-DBE5-4B73-B866-37129E9C9070">示例</a> 。以下查询显示值<code class="codeph">10</code>对于<code class="codeph">department_id</code>列具有极低的基数，占据行的.00099％：</p><pre class="pre codeblock"><code>VARIABLE dept_id NUMBER EXEC：dept_id：= 10; SELECT COUNT（*），MAX（employee_id）FROM hr.employees WHERE department_id =：dept_id; COUNT（*）MAX（EMPLOYEE_ID）---------- ---------------- 1 200</code></pre><p>优化器选择<a href="glossary.html#GUID-15413560-9C69-4C7A-A16E-824D1DE7C5B3"><span class="xrefglossterm">索引范围扫描</span></a> ，如此低基数查询所期望的：</p><pre class="pre codeblock"><code>SQL&gt; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR）; PLAN_TABLE_OUTPUT ------------------------------------- SQL_ID a9upgaqqj7bn5，子号0 ------ -------------------------------选择COUNT（*），MAX（employee_id）FROM hr.employees WHERE department_id =：dept_id计划哈希值：1642965905 --------------------------------------------- ---------------------------------------- | ID |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- ----------------------------------- | 0 |选择声明| | | | 2（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | 2 |通过INDEX ROWID BATCHED表的访问权限员工| 1 | 8 | 2（0）| 00:00:01 | | * 3 | INDEX RANGE SCAN | EMP_DEPARTMENT_IX | 1 | | 1（0）| 00:00:01 | -------------------------------------------------- -----------------------------------谓词信息（由操作ID标识）：------ --------------------------------------------- 3  -  access（“ DEPARTMENT_ID“=：DEPT_ID）</code></pre><p>以下<code class="codeph">V$SQL</code>查询获取有关游标的信息：</p><pre class="pre codeblock"><code>COL BIND_AWARE格式a10 COL SQL_TEXT格式a22 COL CHILD＃格式99999 COL EXEC格式9999 COL BUFF_GETS格式999999999 COL BIND_SENS格式a9 COL SHARABLE格式a9选择SQL_TEXT，CHILD_NUMBER作为孩子＃，执行为EXEC，BUFFER_GETS为BUFF_GETS，IS_BIND_SENSITIVE为BIND_SENS，IS_BIND_AWARE AS BIND_AWARE，IS_SHAREABLE可以从V $ SQL WHERE SQLPHEXT LIKE'％mployee％'和SQL_TEXT不喜欢'％SQL_TEXT％'; SQL_TEXT CHILD #EXEC BUFF_GETS BIND_SENS BIND_AWARE SHARABLE ---------------------- ------ ----- --------- -  --------- ---------- -------- SELECT COUNT（*），MAX（e 0 1 196 YNY mployee_id）FROM hr.em ployees WHERE departme nt_id =：dept_id</code></pre><p>前面的输出显示了一个为低基数查询执行过一次的<a href="glossary.html#GUID-DD551B34-F6E3-4077-8C1D-500ACDC7380D"><span class="xrefglossterm">子游标</span></a> 。游标已标记为绑定敏感，因为优化程序认为最佳计划可能取决于绑定变量的值。
                        </p>
                        <p>当游标标记为绑定敏感时，Oracle数据库使用不同的绑定值监视游标的行为，以确定针对不同绑定值的不同计划是否更有效。数据库将此游标标记为绑定敏感，因为优化程序使用<code class="codeph">department_id</code>列上的直方图来计算谓词<code class="codeph">WHERE department_id = :dept_id</code> 。因为直方图的存在表明列是倾斜的，所以绑定变量的不同值可能需要不同的计划。
                        </p>
                     </div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-F47E3D3C-8287-4D04-8A3C-14868E1A143F">
                        <p class="titleinexample">例20-14高基数查询</p>
                        <p>此示例继续<a href="improving-rwp-cursor-sharing.html#GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-F1AFAAFE-CCB3-4117-89F6-5E09A17377E7">示例20-13</a>中的<a href="improving-rwp-cursor-sharing.html#GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-F1AFAAFE-CCB3-4117-89F6-5E09A17377E7">示例</a> 。以下代码使用值<code class="codeph">50</code>重新执行相同的查询，该值占99.9％的行：</p><pre class="pre codeblock"><code>EXEC：dept_id：= 50; SELECT COUNT（*），MAX（employee_id）FROM hr.employees WHERE department_id =：dept_id; COUNT（*）MAX（EMPLOYEE_ID）---------- ---------------- 100045 100999</code></pre><p>尽管使用全表扫描这样的非选择性查询会更有效，但优化器会选择用于<code class="codeph">department_id=10</code>的相同索引范围扫描。这是因为数据库假定可以共享游标中的现有计划：</p><pre class="pre codeblock"><code>SQL&gt; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR）; PLAN_TABLE_OUTPUT ------------------------------------- SQL_ID a9upgaqqj7bn5，子号0 ------ ------------------------------- SELECT COUNT（*），MAX（employee_id）FROM hr.employees WHERE department_id =：dept_id计划哈希值：1642965905 --------------------------------------------- ---------------------------------------- | ID |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- ----------------------------------- | 0 |选择声明| | | | 2（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | 2 |通过INDEX ROWID BATCHED表的访问权限员工| 1 | 8 | 2（0）| 00:00:01 | | * 3 | INDEX RANGE SCAN | EMP_DEPARTMENT_IX | 1 | | 1（0）| 00:00:01 | -------------------------------------------------- -----------------------------------谓词信息（由操作ID标识）：------ --------------------------------------------- 3  -  access（“ DEPARTMENT_ID“=：DEPT_ID）</code></pre><p>对<code class="codeph">V$SQL</code>查询显示子游标现在已执行两次：</p><pre class="pre codeblock"><code>选择SQL_TEXT，CHILD_NUMBER作为孩子＃，执行作为执行，BUFFER_GETS作为BUFF_GETS，IS_BIND_SENSITIVE作为BIND_SENS，IS_BIND_AWARE作为BIND_AWARE，IS_SHAREABLE可以从V $ SQL WHERE SQLERE SQLPHEXT LIKE'％mployee％'和SQL_TEXT不像'％SQL_TEXT％'; SQL_TEXT CHILD #EXEC BUFF_GETS BIND_SENS BIND_AWARE SHARABLE ---------------------- ------ ----- --------- -  --------- ---------- -------- SELECT COUNT（*），MAX（e 0 2 1329 YNY mployee_id）FROM hr.em ployees WHERE departme nt_id =：dept_id</code></pre><p>在此阶段，优化器尚未将游标标记为绑定感知。</p>
                     </div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-4672F5A8-B32C-4601-A4A9-F8563A913F5B">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../refrn/V-SQL.html#REFRN30246" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">V$SQL</code></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" title="自适应游标共享功能允许包含绑定变量的单个语句使用多个执行计划。">自适应游标共享</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL94744"></a><a id="TGSQL94743"></a><div class="props_rev_3"><a id="GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4" name="GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4"></a><h4 id="TGSQL-GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4" class="sect4"><span class="enumeration_section">20.3.4</span> Bind-Aware游标</h4>
                  <div>
                     <p><span class="bold">绑定感知游标</span>是绑定敏感游标，可以使用不同的绑定值的不同计划。
                     </p>
                     <p>在使游标成为绑定感知之后，优化程序会根据绑定值及其基数估计选择将来执行的计划。因此，“绑定感知”实质上意味着“当前绑定值的最佳计划”。</p>
                     <p>当执行带有绑定敏感游标的语句时，优化程序使用内部算法来确定是否将游标标记为可识别绑定。决定取决于游标是否为不同的绑定值产生显着不同的数据访问模式，导致性能成本与预期不同。</p>
                     <p>如果数据库标记游标可识别绑定，则<span class="italic">下次</span>游标执行数据库时会执行以下操作：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>根据绑定值生成新计划</p>
                        </li>
                        <li>
                           <p>将为语句生成的原始游标标记为不可共享（ <code class="codeph">V$SQL.IS_SHAREABLE</code>为<code class="codeph">N</code> ）。原始游标不再可用，并且有资格从库高速缓存中老化</p>
                        </li>
                     </ul>
                     <p>当同一查询使用不同的绑定值重复执行时，数据库会将新绑定值添加到SQL语句的“签名”（包括优化程序环境，NLS设置等），并对值进行分类。数据库检查绑定值，并考虑当前绑定值是否导致显着不同的数据量，或现有计划是否足够。数据库<span class="italic">并不</span>需要创建一个新的计划，每一个新的价值。
                     </p>
                     <p>考虑一种情况，其中您执行具有12个不同绑定值的语句（执行每个不同的值两次），这会导致数据库触发5次硬解析，并创建2个额外计划。因为数据库执行5次硬分析，所以它会创建5个新的子游标，即使某些游标与现有游标具有相同的执行计划。数据库将多余的游标标记为不可用，这意味着这些游标最终会从库高速缓存中老化。</p>
                     <p>在初始硬解析期间，优化器实质上是映射绑定值和适当的执行计划之间的关系。在此初始阶段之后，数据库最终达到稳定状态。使用新的绑定值执行会导致在缓存中选择最佳子游标，而无需进行硬解析。因此，解析的数量<span class="italic">不会</span>随着不同绑定值的数量<span class="italic">而</span>扩展。
                     </p>
                     <div class="example" id="GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4__GUID-C0792D56-FF53-405A-8747-162EDF3A6B2E">
                        <p class="titleinexample">例20-15 Bind-Aware游标</p>
                        <p>此示例继续<span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C" title="绑定敏感游标是一个游标，其最佳计划可能取决于绑定变量的值。">Bind-Sensitive Cursors</a> ”中</span>的示例。以下代码发出第二个查询<code class="codeph">employees</code> ，其绑定变量设置为<code class="codeph">50</code> ：</p><pre class="pre codeblock"><code>EXEC：dept_id：= 50; SELECT COUNT（*），MAX（employee_id）FROM hr.employees WHERE department_id =：dept_id; COUNT（*）MAX（EMPLOYEE_ID）---------- ---------------- 100045 100999</code></pre><p>在前两次执行期间，数据库正在监视查询的行为，并确定不同的绑定值导致查询在基数方面显着不同。基于此差异，数据库会调整其行为，以便不会始终为此查询共享相同的计划。因此，优化器根据当前绑定值生成新计划，该计划为<code class="codeph">50</code> ：</p><pre class="pre codeblock"><code>SQL&gt; SELECT * FROM TABLE（DBMS_XPLAN.DISPLAY_CURSOR）; PLAN_TABLE_OUTPUT ------------------------------------- SQL_ID a9upgaqqj7bn5，童号1 ------ ------------------------------- SELECT COUNT（*），MAX（employee_id）FROM hr.employees WHERE department_id =：dept_id计划哈希值：1756381138 --------------------------------------------- -------------------------------- | Id |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- --------------------------- | 0 |选择声明| | | | 254（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | * 2 |表访问完全|员工| 100K | 781K | 254（15）| 00:00:01 | -------------------------------------------------- ---------------------------谓词信息（由操作ID标识）：-------------- ------------------------------------- 2  -  filter（“DEPARTMENT_ID”=：DEPT_ID）</code></pre><p>以下<code class="codeph">V$SQL</code>查询获取有关游标的信息：</p><pre class="pre codeblock"><code>选择SQL_TEXT，CHILD_NUMBER作为孩子＃，执行作为执行，BUFFER_GETS作为BUFF_GETS，IS_BIND_SENSITIVE作为BIND_SENS，IS_BIND_AWARE作为BIND_AWARE，IS_SHAREABLE从V $ SQL WHARE分享SQL_TEXT LIKE'％mployee％'和SQL_TEXT不像'％SQL_TEXT％'; SQL_TEXT CHILD #EXEC BUFF_GETS BIND_SENS BIND_AWARE SHAREABLE ---------------------- ------ ----- --------- -  --------- ---------- --------- SELECT COUNT（*），MAX（e 0 2 1329 YNN mployee_id）FROM hr.em ployees WHERE departme nt_id =：dept_id SELECT COUNT（*），MAX（e 1 1 800 YYY mployee_id）FROM hr.em ployees WHERE departme nt_id =：dept_id</code></pre><p>前面的输出显示数据库创建了一个额外的子游标（ <code class="codeph">CHILD#</code> of <code class="codeph">1</code> ）。光标<code class="codeph">0</code>现在标记为不可共享。光标<code class="codeph">1</code>显示多个缓冲区低于游标<code class="codeph">0</code> ，并标记为绑定敏感和绑定感知。绑定感知游标可以对不同的绑定值使用不同的计划，具体取决于包含绑定变量的谓词的选择性。
                        </p>
                     </div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4__GUID-4CFDCC42-4003-4B01-94CC-9A6F7F604463">
                        <p class="titleinexample">例20-16 Bind-Aware游标：选择最佳计划</p>
                        <p>此示例继续<span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4__GUID-C0792D56-FF53-405A-8747-162EDF3A6B2E">示例20-15</a> ”</span>中的<span class="q"><a href="improving-rwp-cursor-sharing.html#GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4__GUID-C0792D56-FF53-405A-8747-162EDF3A6B2E">示例</a></span> 。以下代码执行具有值<code class="codeph">10</code>的相同<code class="codeph">employees</code>查询，该查询具有极低的基数（仅一行）：</p><pre class="pre codeblock"><code>EXEC：dept_id：= 10; SELECT COUNT（*），MAX（employee_id）FROM hr.employees WHERE department_id =：dept_id; COUNT（*）MAX（EMPLOYEE_ID）---------- ---------------- 1 200</code></pre><p>以下输出显示优化程序根据当前绑定值<code class="codeph">10</code>的低基数估计选择了最佳计划，即索引扫描：</p><pre class="pre codeblock"><code>SQL&gt; SELECT * from TABLE（DBMS_XPLAN.DISPLAY_CURSOR）; PLAN_TABLE_OUTPUT ------------------------------------- SQL_ID a9upgaqqj7bn5，child number 2 ------ -------------------------------选择COUNT（*），MAX（employee_id）FROM hr.employees WHERE department_id =：dept_id计划哈希值：1642965905 --------------------------------------------- ---------------------------------------- | ID |操作|名称|行|字节|成本（％CPU）|时间| -------------------------------------------------- ----------------------------------- | 0 |选择声明| | | | 2（100）| | | 1 | SORT AGGREGATE | | 1 | 8 | | | | 2 |通过INDEX ROWID BATCHED表的访问权限员工| 1 | 8 | 2（0）| 00:00:01 | | * 3 | INDEX RANGE SCAN | EMP_DEPARTMENT_IX | 1 | | 1（0）| 00:00:01 | -------------------------------------------------- -----------------------------------谓词信息（由操作ID标识）：------ --------------------------------------------- 3  -  access（“ DEPARTMENT_ID“=：DEPT_ID）</code></pre><p><code class="codeph">V$SQL</code>输出现在显示存在三个子游标：</p><pre class="pre codeblock"><code>选择SQL_TEXT，CHILD_NUMBER作为孩子＃，执行作为执行，BUFFER_GETS作为BUFF_GETS，IS_BIND_SENSITIVE作为BIND_SENS，IS_BIND_AWARE作为BIND_AWARE，IS_SHAREABLE从V $ SQL WHARE分享SQL_TEXT LIKE'％mployee％'和SQL_TEXT不像'％SQL_TEXT％'; SQL_TEXT CHILD #EXEC BUFF_GETS BIND_SENS BIND_AWARE SHAREABLE ---------------------- ------ ----- --------- -  --------- ---------- --------- SELECT COUNT（*），MAX（e 0 2 1329 YNN mployee_id）FROM hr.em ployees WHERE departme nt_id =：dept_id SELECT COUNT（*），MAX（e 1 1 800 YYY mployee_id）FROM hr.em ployees WHERE departme nt_id =：dept_id SELECT COUNT（*），MAX（e 2 1 3 YYY mployee_id）FROM hr.em ployees WHERE departme nt_id =：dept_id</code></pre><p>当光标切换到绑定感知模式时，数据库丢弃原始光标（ <code class="codeph">CHILD#</code> of <code class="codeph">0</code> ）。这是一次性开销。数据库将游标<code class="codeph">0</code>标记为不可共享（ <code class="codeph">SHAREABLE</code>为<code class="codeph">N</code> ），这意味着此游标不可用，并且将成为第一个从游标缓存中老化的游标。
                        </p>
                     </div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-FD923B79-F1A8-401A-8C61-FD00B41A70F4__GUID-D25AC2B6-21FE-4939-9AAC-C30CA021210B">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../refrn/V-SQL.html#REFRN30246" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">V$SQL</code></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" title="自适应游标共享功能允许包含绑定变量的单个语句使用多个执行计划。">自适应游标共享</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL94745"></a><div class="props_rev_3"><a id="GUID-59B4BED5-62FF-421F-92ED-7BB32F6E68F4" name="GUID-59B4BED5-62FF-421F-92ED-7BB32F6E68F4"></a><h4 id="TGSQL-GUID-59B4BED5-62FF-421F-92ED-7BB32F6E68F4" class="sect4"><span class="enumeration_section">20.3.5</span>游标合并</h4>
                  <div>
                     <p>如果优化程序为可识别绑定的游标创建计划，并且此计划与现有游标相同，则优化程序可以执行<strong class="term">游标合并</strong> 。
                     </p>
                     <p>在这种情况下，数据库合并游标以节省库高速缓存中的空间。数据库增加了游标的选择范围，以包括新绑定值的选择性。</p>
                     <p>当查询使用新的绑定变量时，优化器会尝试根据绑定值的选择性相似性来查找它认为合适的游标。如果数据库找不到这样的游标，则会创建一个新游标。如果新游标的计划与现有游标之一相同，则数据库会合并两个游标以节省库高速缓存中的空间。合并导致数据库将一个游标标记为不可共享。如果库高速缓存处于空间压力下，则数据库首先使非可共享游标老化。</p>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-59B4BED5-62FF-421F-92ED-7BB32F6E68F4__GUID-B1002D1E-AB42-4329-8D0F-70E7C750A9AA">
                        <p class="notep1">也可以看看：</p>
                        <p> <span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-BC20D195-C80F-492A-B2D9-0BE2AFF6968C__GUID-AE386A44-DBE5-4B73-B866-37129E9C9070">例20-12</a> ”</span></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" title="自适应游标共享功能允许包含绑定变量的单个语句使用多个执行计划。">自适应游标共享</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL94746"></a><div class="props_rev_3"><a id="GUID-A3B8972A-A74D-4353-960B-5E09D294031E" name="GUID-A3B8972A-A74D-4353-960B-5E09D294031E"></a><h4 id="TGSQL-GUID-A3B8972A-A74D-4353-960B-5E09D294031E" class="sect4"><span class="enumeration_section">20.3.6</span>自适应游标共享视图</h4>
                  <div>
                     <p>您可以使用<code class="codeph">V$</code>视图进行自适应游标共享，以查看选择性范围，游标信息（例如游标是绑定感知还是绑定敏感）以及执行统计信息。
                     </p>
                     <div class="section">
                        <p>具体来说，使用以下视图：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">V$SQL</code>显示游标是绑定敏感还是绑定感知。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">V$SQL_CS_HISTOGRAM</code>显示了三桶执行历史直方图中执行计数的分布。
                              </p>
                           </li>
                           <li>
                              <p>如果使用选择性来检查游标共享，则<code class="codeph">V$SQL_CS_SELECTIVITY</code>显示为包含绑定变量的每个谓词存储的选择性范围。它包含谓词的文本，以及选择性范围的低值和高值。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">V$SQL_CS_STATISTICS</code>总结了优化程序用于确定是否标记游标绑定感知的信息。对于执行示例，数据库会跟踪已处理的行，缓冲区获取和CPU时间。当使用绑定集构建游标时， <code class="codeph">PEEKED</code>列显示<code class="codeph">YES</code> ;否则，该值为<code class="codeph">NO</code> 。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-A3B8972A-A74D-4353-960B-5E09D294031E__GUID-AA5603B4-437D-48AC-9446-F461DDC1A5EF">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../refrn/V-SQL.html#REFRN30246" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">V$SQL</code>及其相关视图</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-277432AA-CD1C-4A75-AB28-7358E63265B3" title="自适应游标共享功能允许包含绑定变量的单个语句使用多个执行计划。">自适应游标共享</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
            <div class="sect2"><a id="GUID-EA2FC76C-275B-49E1-B38C-BA39B3B3E864" name="GUID-EA2FC76C-275B-49E1-B38C-BA39B3B3E864"></a><h3 id="TGSQL-GUID-EA2FC76C-275B-49E1-B38C-BA39B3B3E864" class="sect3"><span class="enumeration_section">20.4</span>游标共享的真实性能指南</h3>
               <div>
                  <p>Real-World Performance团队为如何优化Oracle数据库应用程序中的游标共享创建了指南。</p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-3C4E8893-02F2-40C3-A485-4BE066A67921">开发具有绑定变量的应用程序以实现安全性和性能</a><br>Real-World Performance组强烈建议所有企业应用程序使用绑定变量。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346">不要使用CURSOR_SHARING = FORCE作为永久修复</a><br>最佳实践是编写可共享的SQL，并使用默认的<code class="codeph">EXACT</code>进行<code class="codeph">CURSOR_SHARING</code> 。</li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-6C3AFFA0-21DD-41BC-8DEE-5FC9A58B0954">建立编码约定以增加游标重用</a><br>默认情况下，两个SQL语句的文本中的任何变体都会阻止数据库共享游标，包括绑定变量的名称。此外，绑定变量大小的更改可能导致游标不匹配。因此，在应用程序代码中使用绑定变量不足以<span class="italic">保证</span>游标共享。
                     </li>
                     <li class="ulchildlink"><a href="improving-rwp-cursor-sharing.html#GUID-DFFA6889-AF72-47F8-BC28-5BC05FEE8553">最小化优化程序环境的会话级更改</a><br>最佳做法是阻止应用程序的用户更改其各个会话的优化方法和目标。对优化程序环境的任何更改都可能阻止共享游标的其他相同语句。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-971F4652-3950-4662-82DE-713DDEED317C" title="游标共享可以将数据库应用程序性能提高几个数量级。">通过游标共享提高实际性能</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-3C4E8893-02F2-40C3-A485-4BE066A67921" name="GUID-3C4E8893-02F2-40C3-A485-4BE066A67921"></a><h4 id="TGSQL-GUID-3C4E8893-02F2-40C3-A485-4BE066A67921" class="sect4"><span class="enumeration_section">20.4.1</span>开发具有绑定变量的应用程序以确保安全性和性能</h4>
                  <div>
                     <p>Real-World Performance组强烈建议所有企业应用程序使用绑定变量。</p>
                     <div class="section">Oracle数据库应用程序旨在使用绑定变量编写。避免导致大量用户发布动态非共享SQL语句的应用程序设计。
                        <p>每当Oracle数据库无法找到库高速缓存中的语句匹配时，它必须执行硬解析。尽管使用文字开发应用程序存在危险，但并非所有实际应用程序都使用绑定变量。开发人员有时会发现编写使用文字的程序更快更容易。但是，开发时间的缩短不会导致部署后更好的性能和安全性。</p>
                        <div class="infoboxnote" id="GUID-3C4E8893-02F2-40C3-A485-4BE066A67921__SEERWP3CONNECTIONPOOLSANDHARDPARSIN-7CDE75E1">
                           <p class="notep1">视频：</p>
                           <p>
                              </p><div class="video-box">
                                 <div id="9268" class="video-container"></div>
                              </div>
                           
                        </div>
                        <p>使用绑定变量的主要好处如下：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>资源效率</p>
                              <p>在每次执行之前编译程序不会有效地使用资源，但这实际上是Oracle数据库在执行硬解析时所执行的操作。数据库服务器必须花费大量CPU和内存来创建游标，生成和评估执行计划等。通过使数据库共享游标，软解析消耗的资源更少。如果应用程序使用文字而不是绑定变量，但每天只执行少量查询，那么DBA可能不会将额外开销视为性能问题。但是，如果应用程序每秒执行数百或数千个查询，则额外的资源开销很容易将性能降低到不可接受的水平。使用绑定变量使数据库只能执行一次硬解析，无论语句执行多少次。</p>
                           </li>
                           <li>
                              <p>可扩展性</p>
                              <p>当数据库执行硬解析时，数据库会花费更多时间在共享池和库高速缓存中获取和保持锁存器。锁存器是低级串行化器件。数据库锁存共享内存中结构的时间越长越频繁，这些锁存器的队列就越长。当多个语句共享相同的执行计划时，锁存器的请求和锁存器的持续时间会下降。此行为可提高可伸缩性。</p>
                           </li>
                           <li>
                              <p>吞吐量和响应时间</p>
                              <p>当数据库避免不断地重新分析和创建游标时，更多的时间花在用户空间上。Real-World Performance小组发现，改变文字以使用绑定通常会导致吞吐量和用户响应时间的数量级改进。</p>
                              <div class="infoboxnote" id="GUID-3C4E8893-02F2-40C3-A485-4BE066A67921__SEERWP4BINDVARIABLESANDSOFTPARSINGF-7CDE8F66">
                                 <p class="notep1">视频：</p>
                                 <p>
                                    </p><div class="video-box">
                                       <div id="9269" class="video-container"></div>
                                    </div>
                                 
                              </div>
                           </li>
                           <li>
                              <p>安全</p>
                              <p>防止SQL注入攻击的唯一方法是使用绑定变量。恶意用户可以通过“注入”代码到应用程序来利用连接字符串的应用程序。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-3C4E8893-02F2-40C3-A485-4BE066A67921__FORANEXAMPLEOFANAPPLICATIONTHATFIXE-7D417FD0">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../lnpls/dynamic-sql.html#LNPLS647" target="_blank"><span><cite>Oracle Database PL / SQL语言参考，</cite></span></a>用于修复由文字创建的安全漏洞的应用程序示例</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-EA2FC76C-275B-49E1-B38C-BA39B3B3E864" title="Real-World Performance团队为如何优化Oracle数据库应用程序中的游标共享创建了指南。">游标共享的实际性能指南</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL94750"></a><div class="props_rev_3"><a id="GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346" name="GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346"></a><h4 id="TGSQL-GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346" class="sect4"><span class="enumeration_section">20.4.2</span>不要将CURSOR_SHARING = FORCE用作永久修复</h4>
                  <div>
                     <p>最佳实践是编写可共享的SQL，并使用默认的<code class="codeph">EXACT</code>进行<code class="codeph">CURSOR_SHARING</code> 。</p>
                     <div class="section">但是，对于具有许多类似语句的应用程序，将<code class="codeph">CURSOR_SHARING</code>设置为<code class="codeph">FORCE</code>有时可以显着改善游标共享。使用系统生成的绑定值替换文字可以减少内存使用，减少分析并减少锁存器争用。但是， <code class="codeph">FORCE</code>并不意味着永久性的开发解决方案。
                        <p>作为一般准则，Real-World Performance组建议<span class="italic">不要</span>在极少数情况下将<code class="codeph">CURSOR_SHARING</code>设置为<code class="codeph">FORCE</code>异常，然后仅在满足以下所有条件时：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>共享池中的语句仅在文字值上有所不同。</p>
                           </li>
                           <li>
                              <p>响应时间不是最理想的，因为库缓存未命中数量非常多。</p>
                           </li>
                           <li>
                              <p>您现有的代码存在严重的安全性和可伸缩性错误 - 缺少绑定变量 - 您需要<span class="italic">临时</span>的创可贴才能修复源代码。
                              </p>
                           </li>
                           <li>
                              <p>您可以在会话级别而不是在实例级别设置此初始化参数。</p>
                           </li>
                        </ul>
                        <p>将<code class="codeph">CURSOR_SHARING</code>设置为<code class="codeph">FORCE</code>具有以下缺点：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>它表示应用程序不使用用户定义的绑定变量，这意味着它对SQL注入是开放的。设置<code class="codeph">CURSOR_SHARING</code>到<code class="codeph">FORCE</code> <span class="italic">不能</span>修复SQL注入漏洞或使任何代码更安全。只有在已经注入任何恶意SQL文本之后，数据库才会绑定值。
                              </p>
                              <div class="p">
                                 <div class="infoboxnote" id="GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346__ORACLEDATABASE12CRECOVERINGAPLUGGAB-6B61826C">
                                    <p class="notep1">视频：</p>
                                    <p>
                                       </p><div class="video-box">
                                          <div id="9269" class="video-container"></div>
                                       </div>
                                    
                                 </div>
                              </div>
                           </li>
                           <li>
                              <p>数据库必须在软解析期间执行额外的工作，以在共享池中查找类似的语句。</p>
                           </li>
                           <li>
                              <p>数据库删除每个文字，这意味着它可以删除有用的信息。例如，数据库删除<code class="codeph">SUBSTR</code>和<code class="codeph">TO_DATE</code>函数中的文字值。使用系统生成的绑定变量（文字更优化）会对执行计划产生负面影响。
                              </p>
                           </li>
                           <li>
                              <p>在<code class="codeph">SELECT</code>语句中包含文字的任何选定表达式的最大长度（由<code class="codeph">DESCRIBE</code>返回）都会增加。但是，返回的数据的实际长度不会改变。
                              </p>
                           </li>
                           <li>
                              <p>不支持星形转换。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-7FF4E133-06A7-401E-9BFC-3B0B9C902346__GUID-833ECB56-AA3D-4E07-A1AB-87888C9D761A">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="improving-rwp-cursor-sharing.html#GUID-267E5860-A8D5-4E5F-AE60-16304E97E4EE" title="本主题说明了CURSOR_SHARING初始化参数是什么，以及如何将其设置为不同的值会影响Oracle数据库如何使用绑定变量。">CURSOR_SHARING和Bind Variable Substitution</a> ”</span></p>
                           </li>
                           <li>
                              <p><a href="../refrn/CURSOR_SHARING.html#REFRN10025" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">CURSOR_SHARING</code>初始化参数</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-EA2FC76C-275B-49E1-B38C-BA39B3B3E864" title="Real-World Performance团队为如何优化Oracle数据库应用程序中的游标共享创建了指南。">游标共享的实际性能指南</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
               <div class="sect3"><a id="GUID-6C3AFFA0-21DD-41BC-8DEE-5FC9A58B0954" name="GUID-6C3AFFA0-21DD-41BC-8DEE-5FC9A58B0954"></a><h4 id="TGSQL-GUID-6C3AFFA0-21DD-41BC-8DEE-5FC9A58B0954" class="sect4"><span class="enumeration_section">20.4.3</span>建立编码约定以增加光标重用</h4>
                  <div>
                     <p>默认情况下，两个SQL语句的文本中的任何变体都会阻止数据库共享游标，包括绑定变量的名称。此外，绑定变量大小的更改可能导致游标不匹配。因此，在应用程序代码中使用绑定变量不足以<span class="italic">保证</span>游标共享。
                     </p>
                     <div class="section">
                        <p class="subhead3" id="GUID-6C3AFFA0-21DD-41BC-8DEE-5FC9A58B0954__GUID-0E3271DB-A52F-41E5-80B5-073F48386605"></p>
                        <p>Real-World Performance组建议您标准化SQL语句和PL / SQL块的间距和大小写约定。还为绑定变量的命名和定义建立约定。如果数据库未按预期共享游标，请通过查询<code class="codeph">V$SQL_SHARED_CURSOR</code>开始诊断。</p>
                     </div>
                     <!-- class="section" -->
                     <div class="example" id="GUID-6C3AFFA0-21DD-41BC-8DEE-5FC9A58B0954__GUID-3DEA82EF-D06F-4872-9A1F-E7342DFC4DB0">
                        <p class="titleinexample">示例20-17 SQL文本中的变体</p>
                        <p>在此示例中，使用绑定变量的应用程序使用相同的绑定变量值执行7个语句，但语句在文本上不相同：</p><pre class="pre codeblock"><code>VARIABLE emp_id NUMBER EXEC：emp_id：= 101; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：EMP_ID; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：Emp_Id; SELECT SUM（薪水）FROM hr.employees WHERE employee_id &lt;：emp_id;从hr.employees中选择sum（salary），其中employee_id &lt;：emp_id;选择总和（工资）来自hr.employees，其中employee_id &lt;：emp_id;选择总和（工资）来自hr.employees，其中employee_id &lt;：emp_id;</code></pre><p>对<code class="codeph">V$SQLAREA</code>查询显示没有发生游标共享：</p><pre class="pre codeblock"><code>COL SQL_TEXT FORMAT a35 SELECT SQL_TEXT，SQL_ID，VERSION_COUNT，HASH_VALUE FROM V $ SQLAREA WHERE SQL_TEXT LIKE'％mployee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'; SQL_TEXT SQL_ID VERSION_COUNT HASH_VALUE ----------------------------------- ----------- -  ------------- ---------- SELECT SUM（薪水）FROM hr.employee bkrfu3ggu5315 1 3751971877 s WHERE employee_id &lt;：EMP_ID SELECT SUM（薪水）FROM hr .employee 70mdtwh7xj9gv 1 265856507 s WHERE employee_id &lt;：Emp_Id选择金额（工资）来自hr.employee 18tt4ny9u5wkt 1 2476929625 s其中employee_id &lt;：emp_id SELECT SUM（工资）FROM hr.employe b6b21tbyaf8aq 1 4238811478 es WHERE employee_id &lt;：emp_id SELECT SUM（薪水）FROM hr.employee 4318cbskba8yh 1 615850960 s WHERE employee_id &lt;：emp_id从hr.employee选择总和（工资）633zpx3xm71kj 1 4214457937 s其中employee_id &lt;：emp_id选择总和（工资）来自hr.employee 1mqbbbnsrrw08 1 830205960 s其中employee_id &lt;： emp_id选择了7行。
</code></pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-6C3AFFA0-21DD-41BC-8DEE-5FC9A58B0954__GUID-8C2B8622-0CF8-4A0A-A706-391B750A4B95">
                        <p class="titleinexample">例20-18绑定长度不匹配</p>
                        <p>以下代码定义了具有不同长度的绑定变量，然后使用相同的绑定值执行文本相同的语句：</p><pre class="pre codeblock"><code>VARIABLE lname VARCHAR2（20）EXEC：lname：='Taylor'; SELECT SUM（薪水）FROM hr.employees WHERE last_name =：lname; VARIABLE lname VARCHAR2（100）EXEC：lname：='Taylor'; SELECT SUM（薪水）FROM hr.employees WHERE last_name =：lname;</code></pre><p>以下查询显示数据库未共享游标：</p><pre class="pre codeblock"><code>COL SQL_TEXT FORMAT a35 SELECT SQL_TEXT，SQL_ID，VERSION_COUNT，HASH_VALUE FROM V $ SQLAREA WHERE SQL_TEXT LIKE'％mployee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'; SQL_TEXT SQL_ID VERSION_COUNT HASH_VALUE ----------------------------------- ----------- -  ------------- ---------- SELECT SUM（salary）FROM hr.employee buh8j4557r0h1 2 1249608193 s WHERE last_name =：lname</code></pre><p>原因是由于绑定长度：</p><pre class="pre codeblock"><code>COL BIND_LENGTH_UPGRADEABLE格式a15选择。SQL_TEXT，s。CHILD_NUMBER，c。BIND_LENGTH_UPGRADEABLE来自V $ SQL s，V $ SQL_SHARED_CURSOR c WHERE SQL_TEXT LIKE'％employee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'AND s。CHILD_ADDRESS = c。CHILD_ADDRESS; SQL_TEXT CHILD_NUMBER BIND_LENGTH_UPG ----------------------------------- ------------ --------------- SELECT SUM（salary）FROM hr.employee 0 N s WHERE last_name =：lname SELECT SUM（salary）FROM hr.employee 1 Y s WHERE last_name =：lname</code></pre></div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-EA2FC76C-275B-49E1-B38C-BA39B3B3E864" title="Real-World Performance团队为如何优化Oracle数据库应用程序中的游标共享创建了指南。">游标共享的实际性能指南</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL94747"></a><div class="props_rev_3"><a id="GUID-DFFA6889-AF72-47F8-BC28-5BC05FEE8553" name="GUID-DFFA6889-AF72-47F8-BC28-5BC05FEE8553"></a><h4 id="TGSQL-GUID-DFFA6889-AF72-47F8-BC28-5BC05FEE8553" class="sect4"><span class="enumeration_section">20.4.4</span>最小化优化器环境的会话级更改</h4>
                  <div>
                     <p>最佳做法是阻止应用程序的用户更改其各个会话的优化方法和目标。对优化程序环境的任何更改都可能阻止共享游标的其他相同语句。</p>
                     <div class="example" id="GUID-DFFA6889-AF72-47F8-BC28-5BC05FEE8553__GUID-A866629E-AC61-44B7-9110-5C0A18607632">
                        <p class="titleinexample">例20-19环境不匹配</p>
                        <p>此示例显示了两个文本相同的语句，但它们不共享游标：</p><pre class="pre codeblock"><code>VARIABLE emp_id NUMBER EXEC：emp_id：= 110; ALTER SESSION SET OPTIMIZER_MODE = FIRST_ROWS; SELECT salary FROM hr.employees WHERE employee_id &lt;：emp_id; ALTER SESSION SET OPTIMIZER_MODE = ALL_ROWS; SELECT salary FROM hr.employees WHERE employee_id &lt;：emp_id;</code></pre><p>查询<code class="codeph">V$SQL_SHARED_CURSOR</code>显示优化器模式不匹配：</p><pre class="pre codeblock"><code>SELECT S.SQL_TEXT，S.CHILD_NUMBER，s。CHILD_ADDRESS，C.OPTIMIZER_MODE_MISMATCH FROM V $ SQL S，V $ SQL_SHARED_CURSOR C WHERE SQL_TEXT LIKE'％employee％'AND SQL_TEXT NOT LIKE'％SQL_TEXT％'AND S.CHILD_ADDRESS = C.CHILD_ADDRESS; SQL_TEXT CHILD_NUMBER CHILD_ADDRESS O ----------------------------------- ----------- -  ----------------  -  SELECT salary FROM hr.employees WHE 0 0000000080293040 N RE employee_id &lt;：emp_id SELECT salary FROM hr.employees WHE 1 000000008644E888 Y RE employee_id &lt;：emp_id</code></pre></div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="improving-rwp-cursor-sharing.html#GUID-EA2FC76C-275B-49E1-B38C-BA39B3B3E864" title="Real-World Performance团队为如何优化Oracle数据库应用程序中的游标共享创建了指南。">游标共享的实际性能指南</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
         </div>
      </article>
   </body>
</html>