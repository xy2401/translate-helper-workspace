<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="The Rolling Upgrade Using Oracle Active Data Guard feature provides a streamlined method of performing rolling upgrades."></meta>
      <meta name="description" content="The Rolling Upgrade Using Oracle Active Data Guard feature provides a streamlined method of performing rolling upgrades."></meta>
      <title>使用DBMS_ROLLING执行滚动升级</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Concepts and Administration "></meta>
      <meta property="og:description" content="The Rolling Upgrade Using Oracle Active Data Guard feature provides a streamlined method of performing rolling upgrades."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Concepts and Administration"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="data-guard-concepts-and-administration.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-02-12T10:50:21-08:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="1999, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96244-02"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="using-sql-apply-to-perform-rolling-upgrade.html" title="Previous" type="text/html"></link>
      <link rel="next" href="examples-of-using-oracle-data-guard.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Data Guard Concepts and Administration"></meta>
    <meta name="dcterms.isVersionOf" content="SBYDB"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="using-sql-apply-to-perform-rolling-upgrade.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="examples-of-using-oracle-data-guard.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">概念和管理</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="oracle-data-guard-concepts.html" property="item" typeof="WebPage"><span property="name">概念和管理</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">使用DBMS_ROLLING执行滚动升级</li>
            </ol>
            <a id="GUID-70C09F5B-90BE-4C8C-96A5-45A52E05D380" name="GUID-70C09F5B-90BE-4C8C-96A5-45A52E05D380"></a><a id="SBYDB5214"></a>
            
            <h2 id="SBYDB-GUID-70C09F5B-90BE-4C8C-96A5-45A52E05D380" class="sect2"><span class="enumeration_chapter">14</span>使用DBMS_ROLLING执行滚动升级</h2>
         </header>
         <div class="ind">
            <div>
               <p>滚动升级使用Oracle Active Data Guard功能提供了一种简化的滚动升级方法。</p>
               <p>它使用<code class="codeph">DBMS_ROLLING</code> PL / SQL包实现，该包使您能够以滚动方式升级Oracle Data Guard配置中的数据库软件。使用Oracle Active Data Guard功能进行滚动升级需要Oracle Active Data Guard选件的许可证。
               </p>
               <p>您可以使用此功能从Oracle Database 12 <span class="italic">c</span>的第一个补丁集开始执行数据库版本升级。您不能使用它从早于第一个Oracle Database 12 <span class="italic">c</span>补丁集的任何版本升级。这意味着从Oracle数据库<span class="italic">11克</span>升级到Oracle Database12 <span class="italic">c</span>当<span class="italic">，</span>或从最初的Oracle数据库12 <span class="italic">c</span>释放升级到Oracle数据库<span class="italic">12c</span>的第一补丁集时必须仍然被用于手动临时逻辑备用的升级步骤。
               </p>
               <p><code class="codeph">DBMS_ROLLING</code>包执行Oracle Data Guard切换以最小化主数据库服务的停机时间。在使用<code class="codeph">DBMS_ROLLING</code>之前，必须正确配置Oracle Data Guard环境以适应切换。设置要求因Oracle Data Guard代理在执行<code class="codeph">DBMS_ROLLING</code>期间是否处于活动状态而<code class="codeph">DBMS_ROLLING</code> ：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p>如果代理在<code class="codeph">DBMS_ROLLING</code>期间将处于活动状态，请参阅<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=DGBKR-GUID-AC6A6D2B-1112-422B-8A41-02FAC40E2078" target="_blank"><span><cite>Oracle Data Guard Broker</cite></span></a>以获取有关为切换设置<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=DGBKR-GUID-AC6A6D2B-1112-422B-8A41-02FAC40E2078" target="_blank"><span><cite>代理</cite></span></a>的信息。
                     </p>
                  </li>
                  <li>
                     <p>如果代理在<code class="codeph">DBMS_ROLLING</code>期间不会处于活动状态，则请参阅<a href="managing-oracle-data-guard-role-transitions.html#GUID-CE785178-FD22-4A81-9248-DF5ED8E91635" title="角色转换步骤因您执行切换还是故障转移而异。">涉及逻辑备用数据库的角色转换</a> 。缺少Oracle Data Guard代理意味着必须在目标主数据库上正确配置<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="variable" translate="no">n</span>参数，以便在切换后重新开始重做。
                     </p>
                  </li>
               </ul>
               <p>此外，您可以立即将此功能用于从Oracle Database 12 <span class="italic">c</span>第1版（12.1）开始的其他数据库维护任务。执行维护的数据库必须至少在Oracle 12.1上运行。此类维护任务包括：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p>将分区添加到非分区表</p>
                  </li>
                  <li>
                     <p>将BasicFiles LOB更改为SecureFiles LOB</p>
                  </li>
                  <li>
                     <p>将存储为<code class="codeph">CLOB</code> <code class="codeph">XMLType</code>更改为存储为二进制XML的<code class="codeph">XMLtype</code></p>
                  </li>
                  <li>
                     <p>将表更改为OLTP压缩</p>
                  </li>
               </ul>
               <p>请参阅以下主题：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-647FF758-5B53-44AE-BB80-B6FA506F09C7" title="要以滚动方式升级Oracle Data Guard配置中的数据库软件，首先要将物理备用数据库指定为未来的主数据库。">滚动升级新概念</a></p>
                  </li>
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-BC4E1CA8-4431-4FC0-8437-106C934E88EA" title="在多租户容器数据库（CDB）上使用DBMS_ROLLING执行滚动升级的步骤与非CDB环境没有区别，但还有其他要求和注意事项。">DBMS_ROLLING升级和CDB</a></p>
                  </li>
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-D42FC23B-C6F4-44D1-A46A-202AB845BB80" title="使用DBMS_ROLLING PL / SQL包进行滚动升级过程分为三个阶段：规范，编译和执行。">使用DBMS_ROLLING概述</a></p>
                  </li>
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE" title="规划滚动升级对于成功升级体验至关重要。在规划阶段，您可以指定各种升级参数并构建升级计划。">规划滚动升级</a></p>
                  </li>
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6" title="按照以下步骤使用DBMS_ROLLING PL / SQL包执行滚动升级。">执行滚动升级</a></p>
                  </li>
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-A1348F5A-AFBC-4090-822F-23DF87CE7D3C" title="您可以查询几个视图，以获取有关滚动升级所涉及的数据库的信息。">监控滚动升级</a></p>
                  </li>
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-5B34621B-FABE-4C50-A2C0-ED249844934D" title="要回滚滚动升级过程，可以调用DBMS_ROLLING.ROLLBACK_PLAN过程。">回滚滚动升级</a></p>
                  </li>
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-1019E58C-1370-48A6-BC67-FA42074C0351" title="如果出现滚动升级的情况，并且您需要在转存完成之前在Oracle Data Guard配置中执行故障转移，则只能在这些情况下执行此操作。">处理滚动升级期间发生的角色更改</a></p>
                  </li>
                  <li>
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9" title="这些示例显示了各种滚动升级方案。">滚动升级的例子</a></p>
                  </li>
               </ul>
            </div><a id="SBYDB5406"></a><a id="SBYDB5431"></a><div class="props_rev_3"><a id="GUID-647FF758-5B53-44AE-BB80-B6FA506F09C7" name="GUID-647FF758-5B53-44AE-BB80-B6FA506F09C7"></a><h3 id="SBYDB-GUID-647FF758-5B53-44AE-BB80-B6FA506F09C7" class="sect3"><span class="enumeration_section">14.1</span>滚动升级新概念</h3>
               <div>
                  <p>要以滚动方式升级Oracle Data Guard配置中的数据库软件，首先要将物理备用数据库指定为未来的主数据库。</p>
                  <p>从概念上讲，滚动升级过程将Oracle Data Guard配置分为两组：前导组（LG）和尾随组（TG）。</p>
                  <p>领先组中的数据库首先升级;因此成为领导小组的名称。前导组包含指定的未来主数据库，以及可以配置以保护指定的未来主数据库的物理备用数据库。将来的主数据库首先转换为逻辑备用数据库，然后在其上安装新的数据库软件并运行升级过程。领先组中的其他备用数据库也必须在此时升级其软件。</p>
                  <p>尾随组包含原始主数据库和备用数据库，这些数据库在滚动升级过程中保护原始主数据库。虽然领先组中的数据库正在进行升级过程，但用户应用程序仍可以连接到原始主数据库并进行更改。尾随组数据库继续运行旧数据库软件，直到领导组中的所有数据库都已升级，并且未来主数据库通过应用在升级窗口期间在原始主数据库中生成的更改来赶上原始主数据库。此时，进行切换以将主角色转移到指定的未来主数据库，并将用户应用程序切换到新的主数据库。然后，在作为尾随组的一部分的数据库上安装新软件，并将它们恢复为配置，作为新主数据库的备用。</p>
                  <p>各组中的备用证称为领导小组备用（LGS）和尾随小组备用（TGS）。除指定的未来小学外，领导小组中的所有其他备用小组只能是实际备用小组。尾随组可以包含物理和逻辑备用数据库;在需要区分备用类型的情况下，它们被称为尾随组物理（TGP）和尾随组逻辑（TGL）。指定的未来主要也称为领导组主（LGM），原始主数据库称为尾随组主（TGM）。</p>
                  <p><code class="codeph">DBMS_ROLLING</code>包增加了滚动升级过程的稳健性，如下所示：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>它可以在滚动升级过程中处理故障。原始主数据库或TGM数据库可能会失败。您可以对尾随组中的任何其他物理备用数据库启动常规故障转移操作，然后将新主数据库指定为TGM。</p>
                     </li>
                     <li>
                        <p>它允许在滚动升级过程中对LGM（指定的未来主数据库）进行数据保护。您可以为LGM数据库设置物理备用数据库，从而在升级过程中保护它，并在升级后实现零数据丢失。LGM成功升级后，可以通过故障转移到任何物理备用数据库来解决LGM故障。然后，您可以指定故障转移目标数据库以接管LGM的角色。</p>
                     </li>
                  </ul>
                  <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-647FF758-5B53-44AE-BB80-B6FA506F09C7__CJAFAAHA" title="此表描述了Trailing Group Physical备用数据库和Leading Group Physical备用数据库之间的区别。有4列和2行，不包括标题行。">表14-1</a>比较了切换操作前后TGP备用数据库与LGP备用数据库的特性。
                  </p>
                  <div class="tblformalwide" id="GUID-647FF758-5B53-44AE-BB80-B6FA506F09C7__CJAFAAHA">
                     <p class="titleintable">表14-1尾随组物理（TGP）与领先组物理（LGP）</p>
                     <table cellpadding="4" cellspacing="0" class="FormalWide" title="尾随团体物理（TGP）与领先团体物理（LGP）" width="100%" border="1" summary="This table describes the difference between Trailing Group Physical standbys and Leading Group Physical standbys. There are 4 columns and two rows, excluding the header row." frame="hsides" rules="rows">
                        <thead>
                           <tr align="left" valign="top">
                              <th align="left" valign="bottom" width="25%" id="d36675e367">待机类型</th>
                              <th align="left" valign="bottom" width="23%" id="d36675e370">切换前</th>
                              <th align="left" valign="bottom" width="23%" id="d36675e373">切换后</th>
                              <th align="left" valign="bottom" width="29%" id="d36675e376">笔记</th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="25%" id="d36675e381" headers="d36675e367 ">
                                 <p>尾随组物理（TGP）</p>
                              </td>
                              <td align="left" valign="top" width="23%" headers="d36675e381 d36675e370 ">
                                 <p>应用滞后率低</p>
                                 <p>降低数据丢失风险</p>
                              </td>
                              <td align="left" valign="top" width="23%" headers="d36675e381 d36675e373 ">
                                 <p>高应用滞后</p>
                                 <p>更高的数据丢失风险</p>
                              </td>
                              <td align="left" valign="top" width="29%" headers="d36675e381 d36675e376 ">
                                 <p>可以故障转移到主要角色</p>
                                 <p>必须像原始主要一样闪回</p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="25%" id="d36675e400" headers="d36675e367 ">
                                 <p>领导小组物理（LGP）</p>
                              </td>
                              <td align="left" valign="top" width="23%" headers="d36675e400 d36675e370 ">
                                 <p>高应用滞后</p>
                                 <p>更高的数据丢失风险</p>
                              </td>
                              <td align="left" valign="top" width="23%" headers="d36675e400 d36675e373 ">
                                 <p>应用滞后率低</p>
                                 <p>降低数据丢失风险</p>
                              </td>
                              <td align="left" valign="top" width="29%" headers="d36675e400 d36675e376 ">
                                 <p>可以故障转移到临时逻辑备用角色</p>
                                 <p>不必像原来的主要闪回一样</p>
                              </td>
                           </tr>
                        </tbody>
                     </table>
                  </div>
                  <!-- class="inftblhruleinformal" -->
                  <div class="infoboxnotealso" id="GUID-647FF758-5B53-44AE-BB80-B6FA506F09C7__GUID-83F26596-3D2D-4304-93D7-2F74735BCBEF">
                     <p class="notep1">也可以看看：</p>
                     <p></p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=ARPLS73534" target="_blank"><span class="italic">Oracle Database PL / SQL包和类型参考</span></a> ，以获取<code class="codeph">DBMS_ROLLING</code> PL / SQL包的描述</p>
                        </li>
                        <li>
                           <p><a href="data-type-ddl-support-on-logical-standby-databases.html#GUID-13DDE926-B175-488D-9037-F707A4D2256D" title="在执行滚动升级之前，请确定所涉及的任何表是否包含逻辑备用数据库上不支持的数据类型。">滚动升级期间不支持的表</a>有关如何确定升级中涉及的任何表是否包含使用<code class="codeph">DBMS_ROLLING</code> PL / SQL程序包执行升级时不支持的数据类型的信息</p>
                        </li>
                        <li>
                           <p><a href="data-type-ddl-support-on-logical-standby-databases.html#GUID-F54904C7-F666-4CC3-B1CB-493525476D2F" title="某些软件包的复制仅在使用DBMS_ROLLING软件包执行的滚动升级的上下文中可用。">仅在DBMS_ROLLING上下文中可用的附加PL / SQL程序包支持升级，</a>以获取仅在<code class="codeph">DBMS_ROLLING</code>升级的上下文中支持的PL / SQL程序包的信息</p>
                        </li>
                     </ul>
                  </div>
               </div>
               <div class="sect3"><a id="GUID-5DDF9197-33A4-4279-8058-46B3B8C0FAE4" name="GUID-5DDF9197-33A4-4279-8058-46B3B8C0FAE4"></a><h4 id="SBYDB-GUID-5DDF9197-33A4-4279-8058-46B3B8C0FAE4" class="sect4"><span class="enumeration_section">14.1.1</span> Data Guard Broker支持DBMS_ROLLING升级</h4>
                  <div>
                     <p>从Oracle Database 12 <span class="italic">c</span>第2版（12.2.0.1）开始，Data Guard代理可以在<code class="codeph">DBMS_ROLLING</code>滚动升级期间保持打开状态;不再需要禁用它。
                     </p>
                     <p>有关Data Guard代理对<code class="codeph">DBMS_ROLLING</code>升级的支持，请记住以下<code class="codeph">DBMS_ROLLING</code> ：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>如果在调用时启用了代理，则在执行<code class="codeph">DBMS_ROLLING.BUILD_PLAN</code>过程期间默认启用代理支持。启用代理支持后，代理会根据需要从原始主数据库以及滚动升级目标设置重做传输目标。
                           </p>
                        </li>
                        <li>
                           <p>在开始<code class="codeph">DBMS_ROLLING</code>升级之前，必须禁用快速启动故障转移功能。
                           </p>
                        </li>
                        <li>
                           <p>任何在滚动升级过程中启用快速启动故障转移的尝试都将被拒绝。</p>
                        </li>
                        <li>
                           <p>正在进行滚动升级时，只允许对保护当前主数据库的备用数据库进行角色更改。代理在<code class="codeph">SHOW CONFIGURATION</code>命令期间将滚动升级目标的角色报告为<code class="codeph">Transient Logical Standby</code> ，并将配置状态报告为<code class="codeph">ROLLING DATABASE MAINTENANCE IS IN PROGRESS</code> 。如果存在保护原始主目标和升级目标的备用数据库，则在从当前主节点和升级目标（在它接管为主数据库之前）发出<code class="codeph">SHOW CONFIGURATION</code>命令时，将反映此拓扑。
                           </p>
                        </li>
                        <li>
                           <p>代理阻止角色更改为不保护当前主节点的备用节点。这样可以确保在切换阶段之前允许对尾随组备用的角色更改，并且在切换阶段之后，角色更改仅允许进入领导组备用。</p>
                        </li>
                        <li>
                           <p>在升级过程开始期间，如果升级目标是Oracle RAC数据库，则代理会自动将目标备用数据库减少到一个实例，并允许升级继续。如果没有代理，如果发现目标有多个实例正在运行，则会拒绝升级的开始。</p>
                        </li>
                        <li>
                           <p>代理在滚动升级过程中适当地通知Oracle Clusterware和全局数据服务。</p>
                        </li>
                        <li>
                           <p>尽管通常使用代理执行角色转换，但仍应使用<code class="codeph">DBMS_ROLLING.SWITCHOVER</code>过程继续执行滚动升级中的切换步骤。
                           </p>
                        </li>
                        <li>
                           <p>有关使用PL / SQL包<code class="codeph">DBMS_ROLLING</code>完成滚动升级状态的信息显示在代理命令<code class="codeph">SHOW CONFIGURATION</code>和<code class="codeph">SHOW DATABASE</code>的输出中。</p>
                           <p><code class="codeph">SHOW CONFIGURATION</code>命令将Transient逻辑备用数据库显示为升级目标的角色，并将<code class="codeph">ROLLING DATABASE MAINTENANCE IN PROGRESS</code>为配置状态。此输出的示例如下：</p><pre class="pre codeblock"><code>配置 -  DRSolution保护模式：MaxPerformance成员：North_Sales  - 主数据库South_Sales  - 瞬态逻辑备用数据库快速启动故障转移：禁用配置状态：正在进行的滚动数据库维护</code></pre><p><code class="codeph">SHOW DATABASE</code>命令显示<code class="codeph">WARNING</code>其中包含升级目标和尾随或前导备用<code class="codeph">SHOW DATABASE</code>的相应<code class="codeph">ORA</code>错误，具体取决于当前的滚动升级进度。此输出的示例如下：</p><pre class="pre codeblock"><code>数据库 -  South_Sales角色：物理备用数据库预期状态：APPLY-ON传输延迟：***应用滞后：***平均应用率：***实时查询：关闭实例：南数据库警告： ORA-16866：数据库转换为临时逻辑备用数据库，用于滚动数据库维护数据库状态：警告</code></pre></li>
                     </ul>
                     <div class="infoboxnotealso" id="GUID-5DDF9197-33A4-4279-8058-46B3B8C0FAE4__GUID-F6B759E1-5CC1-4C99-847C-4A47F6539563">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><a href="../arpls/DBMS_ROLLING.html#ARPLS-GUID-097F1B39-E623-43B5-BA30-DF377BFE05CF" target="_blank">DBMS_ROLLING</a></p>
                           </li>
                           <li>
                              <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=DGBKR-GUID-1A5D2697-D931-4A48-B54C-CAE223B37733" target="_blank">显示配置</a></p>
                           </li>
                           <li>
                              <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=DGBKR-GUID-9293F2C8-A7D2-442E-B147-A05A54DDE20E" target="_blank">显示数据库</a></p>
                           </li>
                        </ul>
                     </div>
                  </div>
               </div>
            </div>
            <div class="sect2"><a id="GUID-BC4E1CA8-4431-4FC0-8437-106C934E88EA" name="GUID-BC4E1CA8-4431-4FC0-8437-106C934E88EA"></a><h3 id="SBYDB-GUID-BC4E1CA8-4431-4FC0-8437-106C934E88EA" class="sect3"><span class="enumeration_section">14.2</span> DBMS_ROLLING升级和CDB</h3>
               <div>
                  <p>在多租户容器数据库（CDB）上使用<code class="codeph">DBMS_ROLLING</code>执行滚动升级的步骤与非CDB环境没有区别，但还有其他要求和注意事项。
                  </p>
                  <div class="section">
                     <p class="subhead2" id="GUID-BC4E1CA8-4431-4FC0-8437-106C934E88EA__GUID-D7110B13-4AD6-4485-8C57-8A10D1DEAB59">特定于DBMS_ROLLING CDB上的升级</p>
                     <p>使用<code class="codeph">DBMS_ROLLING</code>在CDB上执行滚动升级时的其他要求如下。
                     </p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><code class="codeph">LOG_ARCHIVE_DEST_n</code>参数中引用的TNS服务必须是解析为目标数据库的根容器的服务。协助<code class="codeph">DBMS_ROLLING</code>的进程执行许多只能从根容器执行的操作。
                           </p>
                        </li>
                        <li>
                           <p>在调用<code class="codeph">DBMS_ROLLING.SWITCHOVER</code>之前，必须插入并打开瞬态逻辑备用数据库上的所有容器数据库。这消除了逻辑备用应用引擎停止的可能性，因为它不能应用于给定的PDB。</p>
                        </li>
                     </ul>
                     <p>有关使用<code class="codeph">DBMS_ROLLING</code>滚动升级的示例，请参见<a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAFHDDH">示例14-5</a> 。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-BC4E1CA8-4431-4FC0-8437-106C934E88EA__GUID-681E40B4-CFCD-4BF1-A716-41EDD73E71E4">DBMS_ROLLING在CDB上升级的其他注意事项</p>
                     <p>正在进行<code class="codeph">DBMS_ROLLING</code>升级时，不支持安装，升级或修补安装在应用程序容器中的应用程序。
                     </p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>如果在执行<code class="codeph">DBMS_ROLLING</code>升级时执行DDL以启动应用程序容器的安装，升级或修补，则会返回错误。（ <code class="codeph">DBMS_ROLLING</code>升级继续。）
                           </p>
                        </li>
                        <li>
                           <p>如果正在升级到应用程序容器，则尝试启动<code class="codeph">DBMS_ROLLING</code>升级会导致错误。（应用程序容器升级继续。）
                           </p>
                        </li>
                        <li>
                           <p>如果执行<code class="codeph">DBMS_ROLLING</code>升级并且数据库兼容性设置为12.2或更高，则支持复制应用程序容器。除<code class="codeph">DBMS_ROLLING</code>升级外，逻辑备用数据库不提供对应用程序容器的任何支持;跳过此类容器，并将一条消息写入警报日志，指示正在跳过应用程序容器。
                           </p>
                        </li>
                        <li>
                           <p>使用<code class="codeph">DBMS_ROLLING</code>升级的CDB可以包含具有不同字符集的可插拔数据库（PDB）。
                           </p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="SBYDB5432"></a><div class="props_rev_3"><a id="GUID-D42FC23B-C6F4-44D1-A46A-202AB845BB80" name="GUID-D42FC23B-C6F4-44D1-A46A-202AB845BB80"></a><h3 id="SBYDB-GUID-D42FC23B-C6F4-44D1-A46A-202AB845BB80" class="sect3"><span class="enumeration_section">14.3</span>使用DBMS_ROLLING概述</h3>
               <div>
                  <p>使用<code class="codeph">DBMS_ROLLING</code> PL / SQL包进行滚动升级过程分为三个阶段：规范，编译和执行。
                  </p>
                  <p></p>
                  <ol>
                     <li>
                        <p><span class="bold">规范</span> ：首先指定您希望如何实现滚动升级过程。您必须指定未来的主数据库。此行为在概念上创建了前导组和尾随组。此时，领导组仅包含LGM。您可以选择指定其他备用数据库来保护LGM。</p>
                        <p>在规范阶段使用以下过程：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">DBMS_ROLLING.INIT_PLAN</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">DBMS_ROLLING.SET_PARAMETER</code></p>
                           </li>
                        </ul>
                     </li>
                     <li>
                        <p><span class="bold">编译</span> ：这是通过调用<code class="codeph">DBMS_ROLLING.BUILD_PLAN</code>过程启动的。<code class="codeph">BUILD_PLAN</code>过程与参与滚动升级的所有数据库通信，并组装滚动升级计划。还调用<code class="codeph">BUILD_PLAN</code>过程来更改现有的滚动升级计划。更改<code class="codeph">DBMS_ROLLING</code>参数后以及由于故障转移而更改拓扑后，必须进行更改。在执行<code class="codeph">BUILD_PLAN</code>过程期间，必须可以访问所有参与的数据库，因为需要大量验证才能确保滚动升级成功。
                        </p>
                     </li>
                     <li>
                        <p><span class="bold">执行</span> ：滚动升级的执行有五个阶段。
                        </p>
                        <p><span class="bold">阶段1：</span> <code class="codeph">DBMS_ROLLING.START_PLAN</code>过程开始执行滚动升级。这会将LGM数据库转换为逻辑备用数据库，并在LGM启动SQL Apply进程。</p>
                        <p><span class="bold">阶段2：</span>您在属于领导组的数据库中升级数据库软件。您还可以在LGM上运行升级脚本。完成此操作后，您必须在LGM数据库中重新启动SQL Apply进程。（有关升级脚本的信息，请参阅“ <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=UPGRD-GUID-99E10023-B2E5-4B35-BD01-E21D5B912D50" target="_blank"><span class="italic">Oracle数据库升级指南”</span></a> 。）在此阶段，通过使用更高版本的二进制文件重新安装它们，也可以解决领先的群组物理备用问题。通过从LGM恢复重做来升级这些数据库。</p>
                        <p><span class="bold">阶段3：</span>应用延迟达到给定阈值（默认设置为10分钟，但可以在规范阶段配置）后， <code class="codeph">DBMS_ROLLING.SWITCHOVER</code>过程继续进行切换操作。切换完成后，LGM将成为主数据库。
                        </p>
                        <p><span class="bold">阶段4：</span> LGM现在是运行新数据库软件的主数据库，领先组中的数据库正在保护它。安装了TGM，尾随组中的数据库仍在运行旧版本的数据库软件。您必须通过升级数据库软件并在较高版本的二进制文件上重新安装数据库来准备TGM和TGS数据库以进行升级。（有关升级脚本的信息，请参阅“ <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=UPGRD-GUID-99E10023-B2E5-4B35-BD01-E21D5B912D50" target="_blank"><span class="italic">Oracle数据库升级指南”</span></a> 。）
                        </p>
                        <p><span class="bold">阶段5：</span>在当前主数据库（最初是LGM）上执行<code class="codeph">DBMS_ROLLING.FINISH_PLAN</code>过程。它会恢复尾随组中的所有数据库，以成为当前主数据库的备用数据库，并重新启动应用程序进程。<code class="codeph">FINISH_PLAN</code>过程等待尾随组中的所有数据库升级到新版本（尽管尾随组数据库的数据库软件已在第4阶段中更改，即尾随组数据库的数据字典，除了任何逻辑备用数据库尾随组，基于LGM数据库升级期间生成的重做的媒体恢复进行更新。
                        </p>
                     </li>
                  </ol>
                  <p>成功执行滚动升级后，可以通过调用<code class="codeph">DBMS_ROLLING.DESTROY_PLAN</code>过程来删除滚动升级规范。
                  </p>
               </div>
            </div><a id="SBYDB5222"></a><a id="SBYDB5223"></a><a id="SBYDB5224"></a><a id="SBYDB5225"></a><a id="SBYDB5216"></a><div class="props_rev_3"><a id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE" name="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE"></a><h3 id="SBYDB-GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE" class="sect3"><span class="enumeration_section">14.4</span>规划滚动升级</h3>
               <div>
                  <p>规划滚动升级对于成功升级体验至关重要。在规划阶段，您可以指定各种升级参数并构建升级计划。</p>
                  <div class="section">
                     <p>参数和升级计划会预测环境特有的所有操作详细信息。升级计划执行特定于站点的验证，以提醒您可能会破坏滚动升级的配置和资源问题。</p>
                     <p>定义升级参数和构建升级计划所需的任务如下：</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <ul style="list-style-type:disc">
                        <li>
                           <p>初始化升级参数</p>
                        </li>
                        <li>
                           <p>查看当前的升级参数值</p>
                        </li>
                        <li>
                           <p>根据需要修改升级参数值</p>
                        </li>
                        <li>
                           <p>制定升级计划</p>
                        </li>
                        <li>
                           <p>查看当前的升级计划</p>
                        </li>
                        <li>
                           <p>必要时修改升级计划</p>
                        </li>
                     </ul>
                     <p>本节的其余部分将详细介绍每个步骤。必须按照提供的顺序执行。</p>
                  </div>
                  <!-- class="section" -->
                  <ol>
                     <li class="stepexpand"><span>必须先将计划参数初始化为系统生成的默认值，然后才能对其进行自定义。要初始化计划参数，请调用<code class="codeph">DBMS_ROLLING.INIT_PLAN</code>过程。此过程标识未来主数据库（前导组主服务器或LGM）的<code class="codeph">DB_UNIQUE_NAME</code> 。作为<code class="codeph">START_PLAN</code>过程调用的一部分，LGM将转换为逻辑备用数据库。以下是对<code class="codeph">INIT_PLAN</code>过程的示例调用，其中<code class="codeph">boston</code>被标识为未来的主数据库：</span><div><pre class="oac_no_warn" dir="ltr">DBMS_ROLLING.INIT_PLAN（future_primary =&gt; '波士顿'）;</pre><p><code class="codeph">INIT_PLAN</code>过程返回一组初始的系统生成的计划参数。它将<code class="codeph">DG_CONFIG</code> init.ora参数中指定的每个物理和逻辑备用数据库添加为滚动升级的参与者。其他数据库（例如服务GoldenGate下游部署或快照备用数据库的下游数据库）将自动排除。
                           </p>
                           <p>缺省情况下，未来主数据库以外的备用数据库配置为保护主数据库，并配置为滚动升级中的必需参与者。</p>
                           <p>一旦定义了与数据库相关的参数， <code class="codeph">INIT_PLAN</code>过程就会定义具有系统提供的默认值的操作参数。在大多数情况下，计划参数已准备好进行计划验证，但为确保满足您的需求，请务必查看每个参数。
                           </p>
                           <p>计划参数将保留在数据库中，直到您调用<code class="codeph">DESTROY_PLAN</code>过程以删除与滚动升级相关的所有状态。
                           </p>
                        </div>
                     </li>
                     <li class="stepexpand"><span><code class="codeph">INIT_PLAN</code>过程完成后，您可以查询<code class="codeph">DBA_ROLLING_PARAMETERS</code>视图以查看计划参数及其当前值。计划参数在全局或本地范围内。全局参数是整个滚动升级的属性，并且独立于数据库参与者。全局参数在<code class="codeph">SCOPE</code>列中具有<code class="codeph">NULL</code>值。本地参数在<code class="codeph">SCOPE</code>列中具有特定的数据库名称，并与它们相关联。以下是示例查询：</span><div><pre class="pre codeblock"><code>SQL&gt;按范围，名称从dba_rolling_parameters顺序选择范围，名称，curval; SCOPE NAME CURVAL -------------- ------------------------ --------- ---------------------西雅图参与完整的西雅图会员没有波士顿参与全波士顿会员跟踪奥克兰参与完整的奥克兰会员跟踪亚特兰大参与完整亚特兰大会员领导ACTIVE_SESSIONS_TIMEOUT 3600 ACTIVE_SESSIONS_WAIT 0 BACKUP_CONTROLFILE rolling_change_backup.f DGBROKER 0 DICTIONARY_LOAD_TIMEOUT 3600 DICTIONARY_LOAD_WAIT 0 DICTIONARY_PLS_WAIT_INIT 300 DICTIONARY_PLS_WAIT_TIMEOUT 3600 EVENT_RECORDS 10000 FAILOVER 0 GRP_PREFIX DBMSRU_ IGNORE_BUILD_WARNINGS 0 IGNORE_LAST_ERROR 0 LAD_ENABLED_TIMEOUT 600 LOG_LEVEL INFO READY_LGM_LAG_TIME 600 READY_LGM_LAG_TIMEOUT 60 READY_LGM_LAG_WAIT 0 SWITCH_LGM_LAG_TIME 600 SWITCH_LGM_LAG_TIMEOUT 60 SWITCH_LGM_LAG_WAIT 1 SWITCH_LGS_LAG_TIME 60 SWITCH_LGS_LAG_TIMEOUT 60 SWITCH_LGS_LAG_WAIT 0 UPDATED_LGS_TIMEOUT 10800 UPDATED_LGS_WAIT 1 UPDATED_TGS_TIMEOUT 10800 UPDATED_TGS_WAIT选择了35行。</code></pre><p>在样本输出中，数据库<code class="codeph">atlanta</code> ， <code class="codeph">boston</code> ， <code class="codeph">oakland</code>和<code class="codeph">seattle</code>都是通过<code class="codeph">DG_CONFIG</code>发现的，并在当前计划中分配了参数。
                           </p>
                           <div class="infoboxnotealso" id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE__GUID-02D62122-F280-46AC-B0EF-1462BC58B288">
                              <p class="notep1">也可以看看：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>有关<code class="codeph">DBA_ROLLING_PARAMETERS</code>视图的更多信息，请<code class="codeph">DBA_ROLLING_PARAMETERS</code> <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=REFRN23889" target="_blank"><span class="italic">Oracle数据库参考</span></a></p>
                                 </li>
                              </ul>
                           </div>
                        </div>
                     </li>
                     <li class="stepexpand"><span>要修改任何现有的滚动升级参数，请使用<code class="codeph">DBMS_ROLLING.SET_PARAMETER</code> PL / SQL过程。以下是使用<code class="codeph">SET_PARAMETER</code>过程的示例：</span><div><pre class="oac_no_warn" dir="ltr">DBMS_ROLLING.SET_PARAMETER（范围IN VARCHAR2，名称IN VARCHAR2，值IN VARCHAR2）;</pre><p>范围标识本地参数的<code class="codeph">DB_UNIQUE_NAME</code>值或全局参数的<code class="codeph">NULL</code> 。没有必要为不是特定于数据库的参数提供<code class="codeph">NULL</code>范围。
                           </p>
                           <p>名称是要修改的参数的名称。</p>
                           <p>该值标识指定参数的值。值NULL将参数恢复为系统提供的默认值（如果存在）。</p>
                           <div class="infoboxnotealso" id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE__GUID-F4EF7787-5C33-4E59-9750-17609C87C212">
                              <p class="notep1">也可以看看：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=ARPLS74605" target="_blank"><span class="italic">Oracle Database PL / SQL包和类型参考</span></a> ，以获取所有可用滚动升级参数的完整列表</p>
                                 </li>
                              </ul>
                           </div>
                           <p>以下示例说明了一些滚动升级参数的示例用法。</p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>指定所有必需参数后，您将构建升级计划。升级计划是一组自定义生成的指令，可通过滚动升级指导您的Oracle Data Guard配置。（生成的计划根据配置是否由Data Guard代理管理而有所不同。）</span><div>
                           <p>要构建升级计划，请使用<code class="codeph">DBA_ROLLING.BUILD_PLAN</code> PL / SQL过程。此过程要求配置完全如计划参数所述，所有实例均已启动并可通过网络访问。
                           </p>
                           <p>该过程调用如下：</p><pre class="oac_no_warn" dir="ltr">DBMS_ROLLING.BUILD_PLAN;</pre><p>没有要指定的参数，因为该过程从<code class="codeph">DBA_ROLLING_PARAMETERS</code>视图获取其所有输入。该过程验证计划参数并执行特定于站点的资源验证，例如日志传输和闪回恢复区域设置。通常，不符合最佳实践值标准的配置设置将被视为警告并记录在<code class="codeph">DBA_ROLLING_EVENTS</code>视图中。默认情况下， <code class="codeph">IGNORE_BUILD_WARNINGS</code>参数设置为<code class="codeph">1</code> ，这意味着警告不会阻止升级计划达到可用状态。您可以将此参数设置为<code class="codeph">0</code>以便在构建计划时更严格地执行规则。
                           </p>
                           <div class="infoboxnote" id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE__GUID-010705B4-E3C8-4152-92ED-0EB9395C15C1">
                              <p class="notep1">注意：</p>
                              <p>计划生成期间执行的验证特定于滚动升级。它们不能替代运行升级前信息工具以评估升级准备情况的建议做法。</p>
                           </div>
                           <p>生成计划后，继续执行以下步骤以查看计划，诊断任何问题，并在必要时进行修改。</p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>成功返回<code class="codeph">BUILD_PLAN</code>过程后，可在<code class="codeph">DBA_ROLLING_PLAN</code>视图中查看完整的升级计划。视图中的每条记录都标识了一个计划执行的特定指令。</span><div>
                           <p>以下输出是滚动升级计划如何显示的示例：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT instid，target，phase，description FROM DBA_ROLLING_PLAN; INSTID TARGET阶段描述------ ------------ ------- --------------------- -------------------------------- 1个西雅图START验证数据库是主要的2个西雅图开始验证MAXIMUM PROTECTION被禁用3个波士顿START验证数据库是物理备用4波士顿START验证物理备用已挂载5 oakland START验证数据库是否为物理备用6启动验证物理备用已安装7 atlanta START验证数据库是否为物理备用8 atlanta START验证物理备用已挂载9西雅图START验证服务器参数文件是否存在且可修改10波士顿START验证服务器参数文件是否存在且可修改11 oakland START验证服务器参数文件是否存在且可修改12 atlanta START验证服务器参数文件是否存在且可修改13西雅图START验证Data Guard Broker配置已禁用14波士顿START验证Data Guard Broker配置已禁用15 oakland START验证Data Guard Broker配置i已禁用16 atlanta START验证Data Guard Broker配置已禁用17西雅图START启用验证闪回数据库已启用18西雅图START确认可用的闪回还原点19波士顿START验证闪回数据库已启用20波士顿START验证可用的闪回还原点21 oakland START验证闪回数据库已启用22 oakland START验证可用的闪回恢复点23 atlanta START验证闪回数据库是否已启用24 atlanta START验证可用的闪回恢复点25波士顿START扫描LAD是否存在atlanta目的地26波士顿START测试是否可以使用配置的TNS服务27波士顿到达亚特兰大START停止介质恢复28 oakland START停止介质恢复29 atlanta START停止介质恢复30波士顿START保证还原点DBMSRU_INITIAL 31波士顿START创建保证还原点DBMSRU_INITIAL 32 oakland START保证还原点DBMSRU_INITIAL 33 oakland START创建保证休息矿点DBMSRU_INITIAL 34 atlanta START保证恢复点DBMSRU_INITIAL 35 atlanta START创建保证恢复点DBMSRU_INITIAL 36西雅图START保证恢复点DBMSRU_INITIAL 37西雅图START创建保证恢复点DBMSRU_INITIAL INSTID目标阶段描述------ ----- ------- ------- ------------------------------------ ---------------------- 38波士顿START开始媒体恢复39波士顿START确认介质恢复正在运行40 oakland START启动介质恢复41 oakland START验证介质恢复是否正在运行42 atlanta START启动介质恢复43 atlanta START验证介质恢复正在运行44西雅图START确认已指定user_dump_dest 45西雅图START备份控制文件到rolling_change_backup.f 46 boston START验证user_dump_dest已指定47 boston START备份控制文件到rolling_change_backup.f 48 oakland START验证user_dump_dest已指定49 oakland START备份控制文件到ro lling_change_backup.f 50 atlanta START验证user_dump_dest已被指定51 atlanta START备份控制文件到rolling_change_backup.f 52 seattle START获取主数据库的当前重做分支53波士顿START等待主要重做分支上的恢复处于活动状态54波士顿START停止媒体恢复55西雅图START执行dbms_logstdby.build 56波士顿START转换为瞬态逻辑备用57波士顿START打开数据库58波士顿START配置逻辑备用参数59波士顿START启动逻辑备用应用60波士顿START获取瞬态逻辑备用的重做分支61波士顿START获取暂时逻辑重做分支的重置scn atlanta START停止介质恢复63 atlanta START闪回数据库64 seattle START禁用日志文件存档到atlanta 65 boston START启用日志文件存档到atlanta 66 boston START等待日志归档目的地到atlanta达到有效state 67 atlanta START等到瞬态逻辑重做分支出现注册68亚特兰大START开始媒体恢复69亚特兰大START等到v $ dataguard_stats已初始化70 atlanta START等待直到恢复已开始在瞬态重做分支71西雅图START登录预切换指令到事件表72波士顿START记录开始用户升级波士顿73波士顿SWITCH验证数据库处于OPENRW模式74波士顿SWITCH完成用户升级波士顿INSTID目标阶段描述------ ------------ ------ -  ------------------------------------------------- -------- 75波士顿SWITCH扫描LADs是否存在西雅图目的地76波士顿SWITCH扫描LAD是否存在奥克兰目的地77波士顿SWITCH扫描LAD是否存在亚特兰大目的地78波士顿SWITCH测试是否可以使用配置的TNS服务访问西雅图79波士顿开关测试是否使用配置的TNS服务可以到达奥克兰80波士顿开关测试是否使用配置的TNS服务可以到达亚特兰大81西雅图SWITCH启用日志文件存档波士顿82波士顿SWITCH启用日志文件存档到亚特兰大83波士顿SWITCH启动逻辑待机应用84 atlanta SWITCH启动媒体恢复85 atlanta SWITCH等到升级重做完全恢复86波士顿SWITCH等到应用延迟低于600秒87西雅图SWITCH将事后切换指令发送到事件表88西雅图SWITCH切换数据库到逻辑备用数据库89波士顿SWITCH等待直到重做结束已应用90 oakland SWITCH等待直到重做结束已应用91 seattle SWITCH禁用日志文件归档到奥克兰92波士顿SWITCH切换数据库到主要93奥克兰SWITCH停止媒体恢复94西雅图SWITCH同步计划与新的主要95西雅图FINISH验证只有一个实例是活动96西雅图FINISH验证数据库已安装97西雅图FINISH闪回数据库98西雅图FINISH转换成物理备用99奥克兰FINISH验证数据库已安装100奥克兰FINISH闪回数据库101波士顿FINI SH验证数据库是否打开102波士顿FINISH保存新主要的DBID 103波士顿FINISH保存logminer会话start scn 104 seattle FINISH等到瞬态逻辑重做分支已注册105 oakland FINISH等到瞬态逻辑重做分支已注册106西雅图FINISH开始媒体恢复107奥克兰FINISH开始媒体恢复108西雅图FINISH等待瞬态分支上的应用/恢复开始109奥克兰完成等待瞬态分支上的应用/恢复已开始110西雅图FINISH等待升级重做已完全恢复INSTID目标阶段描述------ ------------ ------- ---------------------- -------------------------- 111 oakland FINISH等到升级重做完全恢复112西雅图FINISH掉落保证恢复点DBMSRU_INITIAL 113波士顿FINISH掉落保证恢复点DBMSRU_INITIAL 114 oakland FINISH降落保证还原点DBMSRU_INITIAL 115 atlanta FINISH Drop guaran teed还原点DBMSRU_INITIAL选择了115行。SQL&gt;</pre><p>此视图中的列显示以下信息：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><code class="codeph">INSTID</code> - 指令ID，它是指令的执行顺序。说明通常以组的形式执行。
                                 </p>
                              </li>
                              <li>
                                 <p><code class="codeph">PHASE</code> - 升级计划中的每条指令都与特定阶段相关联。阶段是指令的逻辑分组，由<code class="codeph">DBMS_ROLLING</code> PL / SQL包中的过程执行。调用<code class="codeph">DBMS_ROLLING</code>过程时，将执行该阶段的升级计划中的所有相关指令。可能的阶段如下：</p>
                                 <ul style="list-style-type:disc">
                                    <li>
                                       <p><code class="codeph">START</code> ：包含与设置相关的活动，例如获取还原点，实例化瞬态逻辑备用数据库以及配置LGS数据库。调用<code class="codeph">DBMS_ROLLING.START_PLAN</code>过程时，将启动此阶段中的活动。请参阅<span class="q">“ <a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6" title="按照以下步骤使用DBMS_ROLLING PL / SQL包执行滚动升级。">执行滚动升级</a> ”中的</span>步骤1。
                                       </p>
                                    </li>
                                    <li>
                                       <p><code class="codeph">SWITCH</code> ：包含与将瞬态逻辑备用数据库切换到新主数据库相关的活动。当您调用<code class="codeph">DBMS_ROLLING.SWITCHOVER</code>过程时，将启动此阶段中的活动。请参阅<span class="q">“ <a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6" title="按照以下步骤使用DBMS_ROLLING PL / SQL包执行滚动升级。">执行滚动升级</a> ”中的</span>步骤3</p>
                                    </li>
                                    <li>
                                       <p><code class="codeph">FINISH</code> ：包含与配置备用数据库以恢复升级重做相关的活动。当您调用<code class="codeph">DBMS_ROLLING.FINISH_PLAN</code>过程时，将启动此阶段中的活动。请参阅<span class="q">“ <a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6" title="按照以下步骤使用DBMS_ROLLING PL / SQL包执行滚动升级。">执行滚动升级</a> ”中的</span>步骤5。
                                       </p>
                                    </li>
                                 </ul>
                              </li>
                              <li>
                                 <p><code class="codeph">EXEC_STATUS</code> - 指令的总体状态。
                                 </p>
                              </li>
                              <li>
                                 <p><code class="codeph">PROGRESS</code> - 指令执行的进度。值<code class="codeph">REQUESTING</code>表示正在将指令发送到目标数据库以供执行。<code class="codeph">EXECUTING</code>值表示指令正在被执行。<code class="codeph">REPLYING</code>的值表示正在返回完成信息。
                                 </p>
                              </li>
                              <li>
                                 <p><code class="codeph">DESCRIPTION</code> - 计划执行的特定操作。
                                 </p>
                              </li>
                              <li>
                                 <p><code class="codeph">TARGET</code> - 执行给定指令的站点。
                                 </p>
                              </li>
                              <li>
                                 <p><code class="codeph">EXEC_INFO</code> - 与指令相关的其他上下文信息。
                                 </p>
                              </li>
                           </ul>
                           <div class="infoboxnotealso" id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE__GUID-E78DC6AB-57E7-4525-8F7A-DCA6991A14E0">
                              <p class="notep1">也可以看看：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>有关<code class="codeph">DBA_ROLLING_PLAN</code>视图的详细信息，请<code class="codeph">DBA_ROLLING_PLAN</code> <a href="../refrn/DBA_ROLLING_PLAN.html#REFRN23890" target="_blank"><span class="italic">Oracle数据库参考</span></a></p>
                                 </li>
                              </ul>
                           </div>
                        </div>
                     </li>
                     <li class="stepexpand"><span>在对滚动升级或数据库配置进行任何更改后，需要修改升级计划。配置更改可能包括以下任何内容：</span><div>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>init.ora参数文件在参与滚动升级的任何数据库中发生更改</p>
                              </li>
                              <li>
                                 <p>故障转移事件导致数据库角色更改</p>
                              </li>
                              <li>
                                 <p>滚动升级参数更改</p>
                              </li>
                           </ul>
                           <p>要修改活动升级计划，请再次调用<code class="codeph">BUILD_PLAN</code>过程。在某些情况下，如果无法接受给定的更改， <code class="codeph">BUILD_PLAN</code>过程可能会引发错误。例如，如果已经发生切换，则设置<code class="codeph">ACTIVE_SESSIONS_WAIT</code>参数无效。
                           </p>
                           <p>建议您调用<code class="codeph">BUILD_PLAN</code>过程来处理一组参数更改，而不是单独处理参数。
                           </p>
                        </div>
                     </li>
                  </ol>
                  <div class="example" id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE__GUID-EB36DF19-3847-4FB0-B963-49ADCCBF73BC">
                     <p class="titleinexample">示例14-1设置切换以强制应用延迟要求</p>
                     <p>以下示例演示如何配置计划以等待应用延迟降至60秒以下，然后切换到将来的主要：</p><pre class="oac_no_warn" dir="ltr">DBMS_ROLLING.SET_PARAMETER（'SWITCH_LGM_LAG_WAIT'，'1'）; DBMS_ROLLING.SET_PARAMETER（'SWITCH_LGM_LAG_TIME'，'60'）;</pre></div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE__GUID-1A958C1B-1109-4A3C-8E52-E5B891761274">
                     <p class="titleinexample">示例14-2将日志记录重置为其默认值</p>
                     <p>以下示例演示如何将<code class="codeph">LOG_LEVEL</code>全局参数重置为其默认值。
                     </p><pre class="oac_no_warn" dir="ltr">DBMS_ROLLING.SET_PARAMETER（name =&gt;'LOG_LEVEL'，value =&gt; NULL）;</pre></div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE__GUID-65A16C53-05A8-4B54-B177-56AB5DB90545">
                     <p class="titleinexample">示例14-3将数据库指定为可选参与者</p>
                     <p>以下示例演示如何设置数据库<code class="codeph">atlanta</code>的<code class="codeph">INVOLVEMENT</code>本地参数，以指示数据库中遇到的错误不应妨碍整体滚动升级。
                     </p><pre class="oac_no_warn" dir="ltr">DBMS_ROLLING.SET_PARAMETER（scope =&gt;'atlanta'，name =&gt;'involvement'，value =&gt;'optional'）;</pre></div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE__GUID-B3C2737F-A5E2-4B78-9CDA-C7FF7D401FF6">
                     <p class="titleinexample">示例14-4设置数据库以保护瞬态逻辑备用</p>
                     <p>以下示例演示如何设置数据库<code class="codeph">atlanta</code>的<code class="codeph">MEMBER</code>本地参数，以指示它应在滚动升级期间保护瞬态逻辑备用数据库。
                     </p><pre class="oac_no_warn" dir="ltr">DBMS_ROLLING.SET_PARAMETER（scope =&gt;'atlanta'，name =&gt;'member'，value =&gt;'leading'）;</pre></div>
                  <!-- class="example" -->
               </div>
            </div><a id="SBYDB5231"></a><a id="SBYDB5230"></a><div class="props_rev_3"><a id="GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6" name="GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6"></a><h3 id="SBYDB-GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6" class="sect3"><span class="enumeration_section">14.5</span>执行滚动升级</h3>
               <div>
                  <p>按照以下步骤使用<code class="codeph">DBMS_ROLLING</code> PL / SQL包执行滚动升级。
                  </p>
                  <div class="section">
                     <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6__CJAJCACI" title="此3列表列出了执行滚动升级的步骤。第1列是步骤编号。第2列是步骤说明。第3列是阶段。">表14-2</a>提供了这些步骤的摘要。这些步骤假定您首先成功构建了升级计划，如<span class="q">“ <a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-CD45406F-0A0F-4C9E-95FF-42C908BE62BE" title="规划滚动升级对于成功升级体验至关重要。在规划阶段，您可以指定各种升级参数并构建升级计划。">规划滚动升级</a> ”中所述</span> 。
                     </p>
                     <div class="tblformal" id="GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6__CJAJCACI">
                        <p class="titleintable">表14-2使用DBMS_ROLLING执行滚动升级的步骤</p>
                        <table cellpadding="4" cellspacing="0" class="Formal" title="使用DBMS_ROLLING执行滚动升级的步骤" width="100%" border="1" summary="This 3 column table lists the steps to perform rolling upgrade. Column 1 is the step number. Column 2 is a step description. Column 3 is the phase. " frame="hsides" rules="rows">
                           <thead>
                              <tr align="left" valign="top">
                                 <th align="left" valign="bottom" width="9%" id="d36675e1532">步</th>
                                 <th align="left" valign="bottom" width="72%" id="d36675e1535">描述</th>
                                 <th align="left" valign="bottom" width="19%" id="d36675e1538">相</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="9%" id="d36675e1543" headers="d36675e1532 ">
                                    <p>步骤1</p>
                                 </td>
                                 <td align="left" valign="top" width="72%" headers="d36675e1543 d36675e1535 ">
                                    <p>调用<code class="codeph">DBMS_ROLLING.START_PLAN</code>过程以配置指定用于保护未来主数据库的未来主要和物理备用数据库。
                                    </p>
                                 </td>
                                 <td align="left" valign="top" width="19%" headers="d36675e1543 d36675e1538 ">
                                    <p>开始</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="9%" id="d36675e1556" headers="d36675e1532 ">
                                    <p>第2步</p>
                                 </td>
                                 <td align="left" valign="top" width="72%" headers="d36675e1556 d36675e1535 ">
                                    <p>在未来的主数据库和备用数据库上备份Oracle数据库软件。</p>
                                 </td>
                                 <td align="left" valign="top" width="19%" headers="d36675e1556 d36675e1538 ">
                                    <p>开关待定</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="9%" id="d36675e1566" headers="d36675e1532 ">
                                    <p>第3步</p>
                                 </td>
                                 <td align="left" valign="top" width="72%" headers="d36675e1566 d36675e1535 ">
                                    <p>调用<code class="codeph">DBMS_ROLLING.SWITCHOVER</code>过程以在当前和未来主数据库之间切换角色。
                                    </p>
                                 </td>
                                 <td align="left" valign="top" width="19%" headers="d36675e1566 d36675e1538 ">
                                    <p>开关</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="9%" id="d36675e1579" headers="d36675e1532 ">
                                    <p>第4步</p>
                                 </td>
                                 <td align="left" valign="top" width="72%" headers="d36675e1579 d36675e1535 ">
                                    <p>在较高版本的Oracle数据库上手动重新启动以前的主数据库和剩余的备用数据库。</p>
                                 </td>
                                 <td align="left" valign="top" width="19%" headers="d36675e1579 d36675e1538 ">
                                    <p>完成待定</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="9%" id="d36675e1589" headers="d36675e1532 ">
                                    <p>第5步</p>
                                 </td>
                                 <td align="left" valign="top" width="72%" headers="d36675e1589 d36675e1535 ">
                                    <p>调用<code class="codeph">DBMS_ROLLING.FINISH_PLAN</code>过程将前一主数据库转换为物理备用数据库，并配置剩余的备用数据库以恢复升级重做。
                                    </p>
                                 </td>
                                 <td align="left" valign="top" width="19%" headers="d36675e1589 d36675e1538 ">
                                    <p>完</p>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                     <!-- class="inftblhruleinformal" -->
                     <p>每个步骤中发生的活动属于滚动升级的特定阶段，如<a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-5652ED69-A95F-454A-9208-E2483B9A9BA6__CJAJCACI" title="此3列表列出了执行滚动升级的步骤。第1列是步骤编号。第2列是步骤说明。第3列是阶段。">表14-2</a>中的PHASE列所示。滚动升级操作在任何给定时间都处于单一阶段。滚动升级的当前阶段在<code class="codeph">DBA_ROLLING_STATUS</code>视图的<code class="codeph">PHASE</code>列中报告。
                     </p>
                     <p>本节的其余部分将详细介绍每个升级步骤。</p>
                     <ol>
                        <li>
                           <p>调用<code class="codeph">DBMS_ROLLING.START_PLAN</code>过程以配置指定用于保护未来主数据库的未来主要和物理备用数据库。
                           </p>
                           <p><code class="codeph">DBMS_ROLLING.START_PLAN</code>过程是滚动升级的正式开始。<code class="codeph">START_PLAN</code>过程的目标是配置临时逻辑备用数据库和已指定用于保护它的任何物理备用数据库。调用时， <code class="codeph">START_PLAN</code>过程将执行升级计划中的所有指令，其<code class="codeph">PHASE</code>值为<code class="codeph">START_PLAN</code> 。执行的指令类型包括：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>将每个数据库的控制文件备份到跟踪文件</p>
                              </li>
                              <li>
                                 <p>创建闪回数据库保证还原点</p>
                              </li>
                              <li>
                                 <p>在主数据库中构建LogMiner字典</p>
                              </li>
                              <li>
                                 <p>将指定的物理备用数据库恢复为临时逻辑备用数据库</p>
                              </li>
                              <li>
                                 <p>将LogMiner字典加载到逻辑备用数据库中</p>
                              </li>
                              <li>
                                 <p>使用临时逻辑备用数据库配置LGS数据库</p>
                              </li>
                           </ul>
                           <p>按如下方式调用<code class="codeph">START_PLAN</code>过程（不需要参数）：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.START_PLAN;</pre></li>
                        <li>
                           <p>在未来的主数据库和备用数据库上备份Oracle数据库软件。</p>
                           <p><code class="codeph">START_PLAN</code>过程完成后，您必须在将来的主数据库和备用数据库上手动升级Oracle数据库软件，以保护未来的主数据库。这涉及以下步骤：</p>
                           <ol type="a">
                              <li>
                                 <p>升级瞬态逻辑（LGM）和领导组备用（LGS）的Oracle数据库软件。</p>
                              </li>
                              <li>
                                 <p>在LGS数据库上启动介质恢复。</p>
                              </li>
                              <li>
                                 <p>手动或使用数据库升级助手（DBUA）升级临时逻辑备用数据库。</p>
                              </li>
                              <li>
                                 <p>在读/写模式下重新打开瞬态逻辑备用。</p>
                              </li>
                           </ol>
                           <p>瞬态逻辑备用数据库和LGS数据库是一个功能组。在升级瞬态逻辑备用数据库之前，必须在主动运行介质恢复的较高版本上重新启动LGS数据库。如果未首先配置LGS数据库，则不会保护瞬态逻辑的升级。在此步骤结束时，瞬态逻辑的升级完成，并且所有LGS数据库上都运行介质恢复。</p>
                           <p>建议您在执行切换之前等待所有LGS数据库完全升级。当<code class="codeph">DBA_ROLLING_DATABASES</code>视图中的关联记录在<code class="codeph">UPDATED</code>列中报告值为<code class="codeph">YES</code>时，LGS数据库将完全升级。
                           </p>
                        </li>
                        <li>
                           <p>调用<code class="codeph">DBMS_ROLLING.SWITCHOVER</code>过程以在当前和未来主数据库之间切换角色。
                           </p>
                           <p><code class="codeph">SWITCHOVER</code>过程在当前和未来的主数据库之间切换角色。当应用延迟最小时，该过程将切换发生，从而最小化主服务的中断时间。<code class="codeph">SWITCHOVER</code>过程执行升级计划中的所有指令，其<code class="codeph">PHASE</code>值为<code class="codeph">SWITCHOVER</code> 。执行的指令类型包括：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>等待当前处于暂态逻辑备用状态的领导组主（LGM）的应用延迟低于阈值</p>
                              </li>
                              <li>
                                 <p>等待LGS数据库的应用延迟低于阈值</p>
                              </li>
                              <li>
                                 <p>将主服务器切换到逻辑备用服务器角色</p>
                              </li>
                              <li>
                                 <p>将当前为逻辑备用的Leading Group Master（LGM）切换为主要角色</p>
                              </li>
                              <li>
                                 <p>在领导组主服务器（LGM）成为新主服务器之后启用日志存档目标</p>
                              </li>
                           </ul>
                           <p>按如下方式调用<code class="codeph">SWITCHOVER</code>过程（不需要参数）：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SWITCHOVER;</pre><p>如果在切换到主角色到备用角色之后但在瞬态逻辑可以成功转换为主角色之前发生切换错误，则继续执行前主站点上的<code class="codeph">SWITCHOVER</code>过程，直到成功完成。
                           </p>
                        </li>
                        <li>
                           <p>此时，您必须手动重新启动并在较高版本的Oracle数据库上装载以前的主数据库和剩余备用数据库。挂载备用数据库尤其重要，因为<code class="codeph">DBMS_ROLLING</code>包需要与备用数据库通信才能继续滚动升级。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">FINISH_PLAN</code>过程的总体目标是将以前的主要和TGP备用数据库配置为通过升级重做进行恢复的物理备用数据库。调用时， <code class="codeph">FINISH_PLAN</code>过程将执行升级计划中的所有指令，其<code class="codeph">PHASE</code>值为<code class="codeph">FINISH</code> 。执行的指令类型包括：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>前主要和TGP备用的闪回</p>
                              </li>
                              <li>
                                 <p>将前主数据库转换为物理备用数据库</p>
                              </li>
                              <li>
                                 <p>在新的重做分支上启动介质恢复</p>
                              </li>
                           </ul>
                           <p>按如下方式调用<code class="codeph">FINISH_PLAN</code>过程（不需要参数）：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.FINISH_PLAN;</pre></li>
                     </ol>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="SBYDB5237"></a><div class="props_rev_3"><a id="GUID-A1348F5A-AFBC-4090-822F-23DF87CE7D3C" name="GUID-A1348F5A-AFBC-4090-822F-23DF87CE7D3C"></a><h3 id="SBYDB-GUID-A1348F5A-AFBC-4090-822F-23DF87CE7D3C" class="sect3"><span class="enumeration_section">14.6</span>监控滚动升级</h3>
               <div>
                  <p>您可以查询几个视图，以获取有关滚动升级所涉及的数据库的信息。</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><code class="codeph">DBA_ROLLING_STATUS</code></p>
                        <p>提供有关升级总体状态的信息。</p>
                     </li>
                     <li>
                        <p><code class="codeph">DBA_ROLLING_DATABASES</code></p>
                        <p>提供有关滚动升级中涉及的每个数据库的角色，保护和恢复状态的信息。</p>
                     </li>
                     <li>
                        <p><code class="codeph">DBA_ROLLING_STATISTICS</code></p>
                        <p>提供统计信息，例如开始和结束时间，服务脱机的时间等。</p>
                     </li>
                  </ul>
                  <div class="infoboxnotealso" id="GUID-A1348F5A-AFBC-4090-822F-23DF87CE7D3C__GUID-408EC045-7E42-4C98-A440-84EE640E038F">
                     <p class="notep1">也可以看看：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="../refrn/about-static-data-dictionary-views.html#REFRN002" target="_blank"><span class="italic">Oracle Database Reference，</span></a>用于描述这些视图</p>
                        </li>
                     </ul>
                  </div>
               </div>
            </div><a id="SBYDB5238"></a><div class="props_rev_3"><a id="GUID-5B34621B-FABE-4C50-A2C0-ED249844934D" name="GUID-5B34621B-FABE-4C50-A2C0-ED249844934D"></a><h3 id="SBYDB-GUID-5B34621B-FABE-4C50-A2C0-ED249844934D" class="sect3"><span class="enumeration_section">14.7</span>回滚滚动升级</h3>
               <div>
                  <p>要回滚滚动升级过程，可以调用<code class="codeph">DBMS_ROLLING.ROLLBACK_PLAN</code>过程。
                  </p>
                  <div class="section">
                     <p>该过程调用如下：</p><pre class="oac_no_warn" dir="ltr">DBMS_ROLLING.ROLLBACK_PLAN;</pre><p><code class="codeph">ROLLBACK_PLAN</code>过程具有以下要求：</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <ul style="list-style-type:disc">
                        <li>
                           <p>只有先前未调用<code class="codeph">DBMS_ROLLING.SWITCHOVER</code>过程时，才能调用<code class="codeph">ROLLBACK_PLAN</code>过程。
                           </p>
                        </li>
                        <li>
                           <p>在使用<code class="codeph">ROLLBACK_PLAN</code>过程之前，必须将临时逻辑备用数据库设置回挂载状态，因为闪回数据库即将发生。
                           </p>
                        </li>
                        <li>
                           <p>如果Oracle数据库软件已升级，则必须在旧版本上重新启动生成的物理备用数据库，然后启动介质恢复。</p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="SBYDB5239"></a><div class="props_rev_3"><a id="GUID-1019E58C-1370-48A6-BC67-FA42074C0351" name="GUID-1019E58C-1370-48A6-BC67-FA42074C0351"></a><h3 id="SBYDB-GUID-1019E58C-1370-48A6-BC67-FA42074C0351" class="sect3"><span class="enumeration_section">14.8</span>处理滚动升级期间发生的角色更改</h3>
               <div>
                  <p>如果出现滚动升级的情况，并且您需要在转存完成之前在Oracle Data Guard配置中执行故障转移，则只能在这些情况下执行此操作。</p>
                  <p></p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><code class="codeph">DBMS_ROLLING</code>过程正在进行时未执行故障转移。
                        </p>
                     </li>
                     <li>
                        <p>故障转移是在主数据库和物理备用数据库之间进行的，并且是无数据丢失的故障转移。</p>
                     </li>
                     <li>
                        <p>故障转移是在临时逻辑备用数据库和临时逻辑备用数据库的物理备用数据库之间进行的。</p>
                     </li>
                  </ul>
                  <p>角色更改是一个重大事件，它不可避免地使升级计划中的指令无效，升级计划是针对不同的配置而定制的。要恢复滚动升级，必须创建新计划。您必须设置<code class="codeph">FAILOVER</code>参数以指示配置已更改。在下次调用<code class="codeph">BUILD_PLAN</code>过程时检测此参数，并相应地修改现有计划。
                  </p>
                  <p>修改后的计划构建完成后，您可以恢复滚动升级。</p>
               </div>
            </div><a id="SBYDB5241"></a><a id="SBYDB5242"></a><a id="SBYDB5243"></a><a id="SBYDB5244"></a><a id="SBYDB5245"></a><a id="SBYDB5246"></a><a id="SBYDB5248"></a><a id="SBYDB5249"></a><a id="SBYDB5240"></a><div class="props_rev_3"><a id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9" name="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9"></a><h3 id="SBYDB-GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9" class="sect3"><span class="enumeration_section">14.9</span>滚动升级的例子</h3>
               <div>
                  <p>这些示例显示了各种滚动升级方案。</p>
                  <p>在所有方案中的某些时刻，使用相同的基本滚动升级步骤。这些步骤如<a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAFHDDH">例14-5</a>所示。其余的示例在适当的情况下返回到此示例，而不是重复相同的步骤。
                  </p>
                  <p>本节中的一些示例指示您恢复滚动升级，这意味着您应该从上次停止的地方继续。恢复滚动升级涉及识别滚动升级的当前阶段并重新执行与阶段相关的PL / SQL过程或与阶段相关的活动。滚动升级的当前阶段显示在<code class="codeph">DBA_ROLLING_STATUS</code>视图的<code class="codeph">PHASE</code>列中。
                  </p>
                  <div class="infoboxnote" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__GUID-F3429155-7A78-4212-AE2D-2A53FDF36403">
                     <p class="notep1">注意：</p>
                     <p>本节中提供的方案仅用于假设示例。您可以使用滚动升级使用Oracle Active Data Guard功能从第一个Oracle Database 12 <span class="italic">c</span>补丁集开始执行数据库升级。
                     </p>
                  </div>
                  <div class="example" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAFHDDH">
                     <p class="titleinexample">示例14-5基本滚动升级步骤</p>
                     <ol>
                        <li>
                           <p>开始滚动升级：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.START_PLAN;</pre></li>
                        <li>
                           <p>升级瞬态逻辑备用数据库及其保护备用数据库。</p>
                           <ol type="a">
                              <li>
                                 <p>使用更高的Oracle数据库软件版本安装LGP备用数据库。</p>
                              </li>
                              <li>
                                 <p>在Leading Group Physicals（LGP）上启动媒体恢复。</p>
                              </li>
                              <li>
                                 <p>使用更高的Oracle数据库软件版本在升级模式下打开Leading Group Master（LGM），它是瞬态逻辑备用数据库。</p>
                              </li>
                              <li>
                                 <p>升级领先组主服务器（LGM），它是临时逻辑备用数据库，可手动或使用数据库升级助手（DBUA）。</p>
                              </li>
                              <li>
                                 <p>在读/写模式下重新启动Leading Group Master（LGM），它是瞬态逻辑备用。</p>
                              </li>
                           </ol>
                        </li>
                        <li>
                           <p>切换到领导组长（LGM）：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SWITCHOVER;</pre></li>
                        <li>
                           <p>重新启动尾随组中的数据库。这包括原始主数据库及其在尾随组（TGP）中的所有保护备用数据库。</p>
                           <ol type="a">
                              <li>
                                 <p>使用较高的Oracle数据库版本挂载前一个主数据库。</p>
                              </li>
                              <li>
                                 <p>使用更高的Oracle数据库版本安装以前主服务器的物理备用数据库。</p>
                              </li>
                           </ol>
                        </li>
                        <li>
                           <p>完成滚动升级：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.FINISH_PLAN;</pre></li>
                     </ol>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAEIFEB">
                     <p class="titleinexample">示例14-6两个数据库之间的滚动升级</p>
                     <p>以下示例演示了对包含主数据库和物理备用数据库的双站点配置的滚动升级。在这个例子中， <code class="codeph">seattle</code>是当前的主要，而<code class="codeph">boston</code>是未来的主要。<code class="codeph">seattle</code>数据库自动被选为尾随组主（TGM）并参与该操作。默认情况下，不需要为<code class="codeph">seattle</code>设置任何内容。
                     </p>
                     <ol>
                        <li>
                           <p>初始化升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.INIT_PLAN（future_primary =&gt;'boston'）;</pre></li>
                        <li>
                           <p>制定升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.BUILD_PLAN;</pre></li>
                        <li>
                           <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAFHDDH">按例14-5中</a>所述执行滚动升级。
                           </p>
                        </li>
                     </ol>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJADBHHG">
                     <p class="titleinexample">示例14-7三个数据库之间的滚动升级</p>
                     <p>以下示例演示了对包含主数据库和两个物理备用数据库的三站点配置的滚动升级。在这个例子中， <code class="codeph">seattle</code>是主要的， <code class="codeph">boston</code>是未来的主要， <code class="codeph">oakland</code>是<code class="codeph">seattle</code>的物理待命。
                     </p>
                     <ol>
                        <li>
                           <p>初始化升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.INIT_PLAN（future_primary =&gt;'boston'）;</pre></li>
                        <li>
                           <p>制定升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.BUILD_PLAN;</pre></li>
                        <li>
                           <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAFHDDH">按例14-5中</a>所述执行滚动升级。
                           </p>
                        </li>
                     </ol>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJABJIEI">
                     <p class="titleinexample">示例14-8四个数据库之间的滚动升级</p>
                     <p>以下示例演示了对包含主数据库和三个物理备用数据库的四站点配置的滚动升级。在这个例子中， <code class="codeph">seattle</code>是主要的数据库， <code class="codeph">boston</code>是未来的主要数据库， <code class="codeph">oakland</code>是<code class="codeph">seattle</code>的物理待命， <code class="codeph">atlanta</code>是<code class="codeph">boston</code>的物理待命。
                     </p>
                     <ol>
                        <li>
                           <p>初始化升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.INIT_PLAN（future_primary =&gt;'boston'）;</pre></li>
                        <li>
                           <p>将<code class="codeph">atlanta</code>配置为领导组中的备用数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（scope =&gt;'atlanta'，name =&gt;'member'，value =&gt;'leading'）;</pre></li>
                        <li>
                           <p>制定升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.BUILD_PLAN;</pre></li>
                        <li>
                           <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAFHDDH">按例14-5中</a>所述执行滚动升级。
                           </p>
                        </li>
                     </ol>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAJFJDE">
                     <p class="titleinexample">示例14-9 Reader Farm上的滚动升级</p>
                     <p>以下示例演示了由一个主数据库和九个物理备用数据库组成的阅读器服务器场配置的滚动升级。在此示例中，八个物理备用数据库分为两组，每组四个，以便在切换之前和之后作为Oracle Active Data Guard备用数据库提供物理备用数据库。在这个例子中， <code class="codeph">seattle</code>是主要的， <code class="codeph">boston</code>是未来的主要，数据库<code class="codeph">rf[ad]</code>是<code class="codeph">seattle</code>实际备用数据库，数据库<code class="codeph">rf[eh]</code>是<code class="codeph">boston</code>实际备用数据库。已配置滚动升级，以便切换到新主服务器等待，直到未来主数据库的读取器服务器组之间的应用延迟小于60秒。
                     </p>
                     <ol>
                        <li>
                           <p>初始化升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.INIT_PLAN（future_primary =&gt;'boston'）;</pre></li>
                        <li>
                           <p>配置读取器场组以保护未来的主要组：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（scope =&gt;'rfe'，name =&gt;'member'，value =&gt;'leading'）;</pre><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（scope =&gt;'rff'，name =&gt;'member'，value =&gt;'leading'）;</pre><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（scope =&gt;'rfg'，name =&gt;'member'，value =&gt;'leading'）;</pre><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（scope =&gt;'rfh'，name =&gt;'member'，value =&gt;'leading'）;</pre></li>
                        <li>
                           <p>在未来的主要读者服务器场上设置最大允许应用延迟60秒：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（name =&gt;'SWITCH_LGS_LAG_WAIT'，value =&gt;'1'）;</pre></li>
                        <li>
                           <p>制定升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.BUILD_PLAN;</pre></li>
                        <li>
                           <p><a href="using-DBMS_ROLLING-to-perform-rolling-upgrade.html#GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAFHDDH">按例14-5中</a>所述执行滚动升级。
                           </p>
                        </li>
                     </ol>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAHAJDD">
                     <p class="titleinexample">示例14-10应用程序测试的滚动升级</p>
                     <p>以下示例演示如何在四站点配置上使用滚动升级来配置临时逻辑备用数据库和瞬态逻辑备用数据库的物理数据库，以验证更高版本数据库上的应用程序。主要数据库是<code class="codeph">seattle</code> ， <code class="codeph">boston</code>是未来的主要数据库， <code class="codeph">oakland</code>是<code class="codeph">seattle</code>的物理待命， <code class="codeph">atlanta</code>是<code class="codeph">boston</code>物理待命。所以在这个例子中， <code class="codeph">seattle</code>和<code class="codeph">oakland</code>组成了尾随组，而<code class="codeph">boston</code>和<code class="codeph">atlanta</code>组成了领先组。在测试结束时， <code class="codeph">boston</code>和<code class="codeph">atlanta</code>恢复到原来的物理待命角色，以恢复对<code class="codeph">seattle</code>保护。
                     </p>
                     <ol>
                        <li>
                           <p>初始化升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.INIT_PLAN（future_primary =&gt;'boston'）;</pre></li>
                        <li>
                           <p>配置<code class="codeph">atlanta</code>以保护未来的主要：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（scope =&gt;'atlanta'，name =&gt;'member'，value =&gt;'leading'）;</pre></li>
                        <li>
                           <p>制定升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.BUILD_PLAN;</pre></li>
                        <li>
                           <p>开始滚动升级：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.START_PLAN;</pre></li>
                        <li>
                           <p>升级<code class="codeph">boston</code>和<code class="codeph">atlanta</code> ：</p>
                           <ol type="a">
                              <li>
                                 <p>使用更高的数据库版本安装<code class="codeph">atlanta</code> 。
                                 </p>
                              </li>
                              <li>
                                 <p>在<code class="codeph">atlanta</code>开始恢复媒体。
                                 </p>
                              </li>
                              <li>
                                 <p>使用更高的数据库版本在升级模式下打开<code class="codeph">boston</code> 。
                                 </p>
                              </li>
                              <li>
                                 <p>手动或使用数据库升级助手（DBUA）升级数据库<code class="codeph">boston</code> 。
                                 </p>
                              </li>
                              <li>
                                 <p>以读/写模式重新启动<code class="codeph">boston</code> 。
                                 </p>
                              </li>
                           </ol>
                        </li>
                        <li>
                           <p>必要时测试应用程序。</p>
                        </li>
                        <li>
                           <p>回滚配置：</p>
                           <ol type="a">
                              <li>
                                 <p>以挂载模式重启<code class="codeph">boston</code></p>
                              </li>
                              <li>
                                 <p>回滚升级：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.ROLLBACK_PLAN;</pre></li>
                           </ol>
                        </li>
                        <li>
                           <p>使用旧版数据库版本在<code class="codeph">boston</code>和<code class="codeph">atlanta</code>上启动媒体恢复：</p>
                           <ol type="a">
                              <li>
                                 <p>使用较低的数据库版本安装<code class="codeph">boston</code>和<code class="codeph">atlanta</code> 。
                                 </p>
                              </li>
                              <li>
                                 <p>在<code class="codeph">boston</code>和<code class="codeph">atlanta</code>开始恢复媒体。
                                 </p>
                              </li>
                           </ol>
                        </li>
                     </ol>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAEDBEF">
                     <p class="titleinexample">示例14-11故障转移到新主节点后恢复滚动升级</p>
                     <p>以下示例演示了物理备机到主要角色的无数据丢失故障转移，然后是在三站点配置上重新配置滚动升级计划。在这个例子中， <code class="codeph">seattle</code>是主要的， <code class="codeph">boston</code>是未来的主要， <code class="codeph">oakland</code>是<code class="codeph">seattle</code>的物理待命。数据库<code class="codeph">oakland</code>失败了成为新的主要。（尾随组是（ <code class="codeph">seattle</code> ， <code class="codeph">oakland</code> ），领导小组是<code class="codeph">boston</code> 。）
                     </p>
                     <p></p>
                     <ol>
                        <li>
                           <p>恢复<code class="codeph">oakland</code>剩余重做，并故障转移到新的主要角色：</p><pre class="pre codeblock"><code>SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL; SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY FINISH; SQL&gt; ALTER DATABASE FAILOVER TO OAKLAND; SQL&gt; ALTER DATABASE OPEN;</code></pre></li>
                        <li>
                           <p>根据需要在<code class="codeph">oakland</code>上配置日志归档目标：</p><pre class="pre codeblock"><code>SQL&gt; ALTER SYSTEM SET LOG_ARCHIVE_DEST_2 ='service =“boston”reopen = 5 2 LGWR ASYNC NET_TIMEOUT = 180 valid_for =（ONLINE_LOGFILE，PRIMARY_ROLE）3 DB_UNIQUE_NAME =“oakland”';</code></pre><pre class="pre codeblock"><code>SQL&gt; ALTER SYSTEM ARCHIVE LOG CURRENT;</code></pre></li>
                        <li>
                           <p>设置一个参数以指示发生故障转移：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（name =&gt;'failover'，value =&gt;'1'）;</pre></li>
                        <li>
                           <p>修改升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.BUILD_PLAN;</pre></li>
                        <li>
                           <p>恢复滚动升级。</p>
                        </li>
                     </ol>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-3D3BDB04-0981-4E3A-88FD-B1C0B9BDD0E9__CJAHBCBH">
                     <p class="titleinexample">示例14-12故障转移到新的瞬态逻辑后恢复滚动升级</p>
                     <p>以下示例演示了物理备用数据库故障转移到临时逻辑角色，然后在五站点配置上重新配置滚动升级计划。在这个例子中， <code class="codeph">seattle</code>是主， <code class="codeph">boston</code>是未来伯， <code class="codeph">oakland</code>是物理备用<code class="codeph">seattle</code> ，和<code class="codeph">atlanta</code>和<code class="codeph">miami</code>是物理备用<code class="codeph">boston</code> 。数据库<code class="codeph">atlanta</code>故障转移成为新的瞬态逻辑备用数据库。
                     </p>
                     <ol>
                        <li>
                           <p>回收残留在重做<code class="codeph">atlanta</code>和故障转移到新的临时逻辑的作用：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY FINISH; SQL&gt; ALTER DATABASE ACTIVATE STANDBY DATABASE; SQL&gt; ALTER DATABASE OPEN;</pre></li>
                        <li>
                           <p>根据需要在<code class="codeph">atlanta</code>上配置日志归档目标：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; alter system set log_archive_dest_2 ='service =“seattle”reopen = 5 2 LGWR ASYNC NET_TIMEOUT = 180 valid_for =（ONLINE_LOGFILE，PRIMARY_ROLE）3 DB_UNIQUE_NAME =“atlanta”'; SQL&gt; alter system set log_archive_dest_3 ='service =“oakland”reopen = 5 2 LGWR ASYNC NET_TIMEOUT = 180 valid_for =（ONLINE_LOGFILE，PRIMARY_ROLE）3 DB_UNIQUE_NAME =“atlanta”'; SQL&gt; alter system set log_archive_dest_4 ='service =“miami”reopen = 5 2 LGWR ASYNC NET_TIMEOUT = 180 valid_for =（ONLINE_LOGFILE，ALL_ROLES）3 DB_UNIQUE_NAME =“atlanta”';</pre></li>
                        <li>
                           <p>将<code class="codeph">atlanta</code>指定为新的临时逻辑备用数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.SET_PARAMETER（name =&gt;'failover'，value =&gt;'1'）;</pre></li>
                        <li>
                           <p>修改升级计划：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_ROLLING.BUILD_PLAN;</pre></li>
                        <li>
                           <p>恢复滚动升级。</p>
                        </li>
                     </ol>
                  </div>
                  <!-- class="example" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>