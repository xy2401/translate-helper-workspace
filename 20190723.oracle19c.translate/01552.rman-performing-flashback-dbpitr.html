<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <title>执行闪回和数据库时间点恢复</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Backup and Recovery User&#39;s Guide"></meta>
      <meta property="og:description" content=""></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Backup and Recovery User&#39;s Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="database-backup-and-recovery-users-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-01-09T05:20:45-08:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="2003, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96241-01"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="rman-complete-database-recovery.html" title="Previous" type="text/html"></link>
      <link rel="next" href="rman-block-media-recovery.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Database Backup and Recovery User&#39;s Guide"></meta>
    <meta name="dcterms.isVersionOf" content="BRADV"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="rman-complete-database-recovery.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="rman-block-media-recovery.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">备份和恢复用户指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="part-diagnosing-responding-failures.html" property="item" typeof="WebPage"><span property="name">诊断和应对失败</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">执行闪回和数据库时间点恢复</li>
            </ol>
            <a id="GUID-5463669A-DC89-4FF4-ACCE-136A72DF687B" name="GUID-5463669A-DC89-4FF4-ACCE-136A72DF687B"></a><a id="BRADV80055"></a>
            
            <h2 id="BRADV-GUID-5463669A-DC89-4FF4-ACCE-136A72DF687B" class="sect2"><span class="enumeration_chapter">18</span>执行闪回和数据库时间点恢复</h2>
         </header>
         <div class="ind">
            <div>
               <p>本章介绍如何调查不需要的数据库更改，并根据Oracle闪回技术和数据库备份选择并执行适当的恢复策略。它包含以下主题：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="rman-performing-flashback-dbpitr.html#GUID-94B90ECF-69C9-40D4-A318-DC4AE9776557" title="此概述描述了Oracle闪回技术和数据库时间点恢复的目的和基本概念。">Oracle闪回技术和数据库时间点恢复概述</a></p>
                  </li>
                  <li>
                     <p><a href="rman-performing-flashback-dbpitr.html#GUID-FF315DFC-ABBC-410D-ABDB-75FA89D43255" title="闪回表使用撤消表空间中的信息而不是还原的备份来检索表。发生闪回表操作时，将删除新行并重新插入旧行。在执行表的闪回时，数据库的其余部分仍然可用。">使用闪回表重绕表</a></p>
                  </li>
                  <li>
                     <p><a href="rman-performing-flashback-dbpitr.html#GUID-55EA5EB0-89E2-4561-A9D0-01A6242A2A87" title="您可以使用FLASHBACK TABLE从回收站中检索对象...在DROP声明之前。">使用闪回删除重绕DROP TABLE操作</a></p>
                  </li>
                  <li>
                     <p><a href="rman-performing-flashback-dbpitr.html#GUID-953FA30D-BED2-4DBA-8361-9DA1B8FF073F" title="闪回数据库通过将数据库返回到先前某个时间点的状态来反转不需要的更改。">使用闪回数据库重绕数据库</a></p>
                  </li>
                  <li>
                     <p><a href="rman-performing-flashback-dbpitr.html#GUID-7D3EE2F7-77A2-4264-8875-CC0AEC64ABE0" title="RMAN DBPITR在目标恢复时间之前从备份还原数据库，然后使用增量备份和重做将数据库前滚到目标时间。您可以恢复到SCN，时间，日志序列号或还原点。Oracle建议您在重要时间创建还原点，以便在必要时使时间点恢复更易于管理。">执行数据库时间点恢复</a></p>
                  </li>
                  <li>
                     <p><a href="rman-performing-flashback-dbpitr.html#GUID-F9C8CB5E-5954-4114-99D0-D121BA616058" title="本节介绍基本闪回数据库和DBPITR方案的变体。">闪回和数据库时间点恢复方案</a></p>
                  </li>
               </ul>
            </div><a id="BRADV89737"></a><div class="props_rev_3"><a id="GUID-94B90ECF-69C9-40D4-A318-DC4AE9776557" name="GUID-94B90ECF-69C9-40D4-A318-DC4AE9776557"></a><h3 id="BRADV-GUID-94B90ECF-69C9-40D4-A318-DC4AE9776557" class="sect3"><span class="enumeration_section">18.1</span> Oracle闪回技术和数据库时间点恢复概述</h3>
               <p>此概述描述了Oracle闪回技术和数据库时间点恢复的目的和基本概念。</p><a id="BRADV89738"></a><div class="props_rev_3"><a id="GUID-D8DA9312-0556-4B1A-835C-0A8FF789E1A9" name="GUID-D8DA9312-0556-4B1A-835C-0A8FF789E1A9"></a><h4 id="BRADV-GUID-D8DA9312-0556-4B1A-835C-0A8FF789E1A9" class="sect4"><span class="enumeration_section">18.1.1</span>闪回和数据库时间点恢复的目的</h4>
                  <div>
                     <p>某些情况适合使用时间点恢复或闪回功能，以便在之前的某个时间点将数据库或数据库对象返回到其状态。</p>
                     <p>一些典型情况包括：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>用户错误或损坏会删除所需的数据或引入损坏的数据。例如，用户或DBA可能会错误地删除或更新一个或多个表的内容，删除更新到应用程序期间仍需要的数据库对象，或运行中途失败的大批量更新。</p>
                        </li>
                        <li>
                           <p>数据库升级失败或升级脚本出错。</p>
                        </li>
                        <li>
                           <p>介质故障后的完整数据库恢复无法成功，因为您没有所有需要的重做日志或增量备份。</p>
                        </li>
                     </ul>
                  </div>
               </div><a id="BRADV89739"></a><div class="props_rev_3"><a id="GUID-15D5CF76-8622-4117-8954-3D872A0B0A86" name="GUID-15D5CF76-8622-4117-8954-3D872A0B0A86"></a><h4 id="BRADV-GUID-15D5CF76-8622-4117-8954-3D872A0B0A86" class="sect4"><span class="enumeration_section">18.1.2</span>时间点恢复和闪回功能的基本概念</h4>
                  <div>
                     <p>数据库时间点恢复（DBPITR）和闪回功能使您可以将数据库恢复到先前的某个时间点。</p>
                     <p>DBPITR是不需要的数据库更改的最基本的解决方案。它有时被称为<a href="glossary.html#GUID-2D291374-0883-4A17-8A8E-0A4E2C8CC790"><span class="xrefglossterm">不完全恢复，</span></a>因为它不使用所有可用的重做或完全恢复对数据库的所有更改。在这种情况下，您将还原整个数据库备份，然后应用重做日志或增量备份，以便在不需要的更改之前重新创建所有更改。
                     </p>
                     <p>如果不需要的数据库更改很多但仅限于特定的表空间，那么您可以使用<a href="glossary.html#GUID-8A257409-B3DC-41FD-A2AF-D47560FF9F18"><span class="xrefglossterm">表空间时间点恢复（TSPITR）</span></a>将这些表空间返回到较早的<a href="glossary.html#GUID-BBD8C5A5-1CB0-4BF6-9614-81DD64ABE59E"><span class="xrefglossterm">系统更改号（SCN），</span></a>同时不受影响的表空间仍然可用。
                     </p>
                     <p>如果不需要的数据库更改仅限于特定的表或表分区，则可以使用以前创建的RMAN备份将这些对象仅返回到发生不需要的更改之前的某个时间点。</p>
                     <p>Oracle数据库还提供了一组统称为闪回技术的功能，支持查看过去的数据状态，及时来回绕线和倒回数据，而无需从备份中恢复数据库。根据对数据库的更改，闪回技术通常可以更快地逆转不需要的更改，同时减少对数据库可用性的影响。</p>
                     <div class="infoboxnotealso" id="GUID-15D5CF76-8622-4117-8954-3D872A0B0A86__GUID-5A5BAD2A-4D5E-436B-9D51-C86D250D2F65">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><a href="performing-rman-tspitr.html#GUID-CAACDB53-7C3A-45B4-8249-C5D855D47571" title="要有效地使用RMAN表空间时间点恢复（TSPITR），了解它可以解决的问题类型，组件，RMAN在TSPITR期间所执行的操作以及对何时以及如何进行的各种限制和限制很有帮助。跑。本节介绍运行RMAN的基本概念，准备任务和运行模式TSPITR。恢复管理器（RMAN）TSPITR可以将数据库中的一个或多个表空间快速恢复到较早的时间，而不会影响数据库中的其余表空间和对象。了解RMAN TSPITR的概念，例如使用的术语和模式。本节定义了RMAN TSPITR使用的一些常见实体。有几种运行RMAN TSPITR的模式。各种操作模式之间的差异对应于您的环境中需要多少自动化与自定义。在执行完全自动化的RMAN TSPITR（默认）之前，从恢复集，辅助目标和目标时间中选择表空间。由于某些限制和限制，TSPITR无法解决某些数据库问题。在执行TSPITR时需要考虑一些限制。在TSPITR期间不使用恢复目录时要注意某些预防措施。准备执行TSPITR时必须完成某些步骤。为您选择正确的目标时间或SCN非常重要。 TSPITR。请注意，在TSPITR之后将表空间联机后，您不能在使表空间联机的时间之前使用任何备份。最初，恢复集包括要恢复的表空间的数据文件。但是，如果表空间中的对象需要与其他表空间中的对象建立关系（例如约束），则必须先考虑这些关系才能执行TSPITRRMAN TSPITR要求正在恢复的表空间是自包含的，并且没有SYS拥有的对象驻留在表空间中。在表空间上执行RMAN TSPITR时，在目标恢复时间之后创建的对象将丢失。您可以通过在TSPITR之前使用数据泵导出实用程序导出这些对象并在之后使用数据泵导入重新导入这些对象来保留这些对象。在默认模式下，RMAN在目标数据库上尽可能多地使用TSPITR的配置。您可以自定义RMAN TSPITR的某些方面，同时仍然主要执行完全自动化的RMAN TSPITR的过程。您可能不希望恢复集数据文件在其原始位置恢复和恢复。SET NEWNAME命令可用于指定新目标。为恢复集指定新目标时，RMAN不会删除表空间的原始数据文件。与通常存储在其原始位置的恢复集数据文件不同，辅助集数据文件不得覆盖目标数据库中的相应原始文件。如果未指定与其原始位置不同的辅助集文件位置，则TSPITR将失败。当RMAN尝试覆盖原始数据库中的相应文件并发现正在使用的文件时，会发生故障。辅助集数据文件可以在目标中具有Oracle管理文件（OMF），并且可以使用自动存储管理（ASM）或非ASM存储。当设置了DB_FILE_NAME_CONVERT初始化参数且OMF文件位于ASM或非ASM存储中时，TSPITR以不同方式执行名称转换。您可以使用辅助数据库的DB_FILE_NAME_CONVERT和LOG_FILE_NAME_CONVERT初始化参数来指定磁盘组的转换。RMAN使用该模式转换ASM磁盘组名称，并在转换后的磁盘组中生成有效的OMF文件名。有多种方法可用于重命名辅助数据库的OMF（非ASM）文件名。要为辅助集数据文件指定新名称，可以将RECOVER TABLESPACE包含在RUN命令中，并使用RUN块中的SET NEWNAME命令重命名该文件。如果您不想为所有辅助集数据文件使用辅助目标，但又不想单独命名每个文件，则可以在辅助数据库使用的初始化参数文件中包含DB_FILE_NAME_CONVERT初始化参数。临时文件被视为数据库辅助集的一部分。在实例化辅助数据库时，RMAN将重新创建目标数据库的临时表空间，并使用辅助数据文件名的常规规则生成其名称。通过重定向RMAN以使用恢复集和辅助集数据文件的现有映像副本，可以增强TSPITR性能。在这种情况下，RMAN不需要从备份还原数据文件。使用SET NEWNAME命令可以在使用映像副本执行TSPITR时指定映像副本的位置。CONFIGURE AUXNAME命令为辅助集数据文件映像副本设置持久备用位置，而SET NEWNAME命令为RUN命令的持续时间设置备用位置。使用映像副本执行TSPITR时，此过程使用CONFIGURE AUXNAME。自动辅助数据库使用一组默认初始化参数。如果需要，您可以添加其他参数。如果使用初始化参数文件，则可以使用CONTROL_FILES初始化参数为辅助数据库的控制文件指定自己的位置要在辅助数据库上恢复它们后对辅助和恢复集执行恢复，RMAN可能需要还原存档日志。使用辅助目标时，存档日志将还原到该位置。如果在辅助数据库参数文件中指定LOG_FILE_NAME_CONVERT初始化参数，并且参数成功转换目标的联机重做日志的名称，则此参数将确定联机重做日志位置。虽然Oracle建议您让RMAN管理辅助数据库的所有方面，但有时您可能必须创建和管理自己的辅助数据库。如果选择此模式，则负责设置，启动，停止和清理TSPITR中使用的辅助数据库。创建适合用作辅助数据库的Oracle实例需要执行一组步骤。有多种方法可以为辅助数据库创建密码文件。使用文本编辑器为目标数据库主机上的辅助数据库创建初始化参数文件。辅助数据库必须具有有效的网络服务名称。在继续之前，请使用SQL * Plus确保您可以与辅助数据库建立SYSBACKUP或SYSDBA连接。使用您自己的辅助实例执行TSPITR时，请记住某些准则。可以覆盖使用自己的辅助数据库进行TSPITR时通道的默认行为。您可能希望使用SET NEWNAME命令来引用辅助集文件的现有映像副本以提高TSPITR性能，或者为TSPITR之后的恢复集文件分配新名称。如有必要，请计划这些命令，并将它们添加到为TSPITR运行的命令序列中。完成先决条件，然后按照本节中的步骤使用您自己的辅助数据库执行TSPITR。在开始RMAN TSPITR之前，必须启动辅助数据库。由于辅助数据库还没有控制文件，因此只能以NOMOUNT模式启动实例。启动RMAN并连接到目标数据库和手动创建的辅助数据库。使用RECOVER TABLESPACE命令使用您自己的辅助实例执行TSPITR。此过程使用RECOVER TABLESPACE ...UNTIL命令执行TSPITR。各种问题都可能导致RMAN TSPITR失败。必须确定并修复问题。目标数据库中的文件，SET NEWNAME或CONFIGURE AUXNAME命令分配的文件名以及DB_FILE_NAME_CONVERT参数的效果生成的文件名之间可能会发生名称冲突。在TSPITR期间，RMAN需要有关哪些表空间在TSPITR目标时间具有还原段的信息。如果使用此信息，通常可在恢复目录中使用此信息。如果您正在管理自己的辅助数据库并且TSPITR失败，请不要尝试在不解决错误的情况下重新运行TSPITR。">执行RMAN表空间时间点恢复（TSPITR）</a></p>
                           </li>
                           <li>
                              <p><a href="rman-recovering-tables-partitions.html#GUID-87B7F772-335F-4179-81C9-91678D026D01" title="RMAN RECOVER命令使您可以从RMAN备份恢复表和表分区。RMAN使您可以将一个或多个表或表分区恢复到指定的时间点，而不会影响其余的数据库对象。您可以使用以前创建的RMAN备份将表和表分区恢复到指定的时间点。要恢复表或表分区，需要完全备份undo，SYSTEM，SYSAUX以及包含表或表分区的表空间。RMAN使用RECOVER命令将表或表分区恢复到指定的时间点。RMAN执行一系列步骤，同时自动执行从RMAN备份恢复表或表分区的过程。RMAN创建一个辅助数据库，它在恢复指定的表或表分区的过程中使用它。有多种技术可用于指定辅助数据库文件的位置。在将表或表分区恢复到辅助数据库上的指定时间点之后，RMAN会创建一个包含已恢复对象的数据泵导出转储文件。您可以指定此转储文件的名称和位置，也可以允许RMAN使用默认名称和位置。默认情况下，RMAN将存储在导出转储文件中的已恢复表或表分区导入目标数据库。但是，您可以使用RESTORE命令的NOTABLEIMPORT子句选择不导入已恢复的表或表分区。使用REMAP TABLE子句重命名目标数据库中已恢复的表或表分区。将表或表分区恢复到不同的模式使您可以避免可能由源模式中已存在的约束，索引或触发器名称引起的名称冲突。使用RECOVER命令从RMAN备份恢复表和表分区受到某些限制。在准备恢复表或表分区之前，必须执行一些初步任务。从RMAN备份恢复表或表分区之前，必须满足某些先决条件。确定要恢复表或表分区的确切时间点非常重要。有多种方法可以指定必须恢复对象的时间点。使用RESTORE和RECOVER命令恢复表或表分区。RMAN使您可以使用RECOVER命令将可插拔数据库（PDB）中的一个或多个表或表分区恢复到指定的时间点，而不会影响PDB中的其他对象。本节包含的示例涵盖了恢复表和表分区的多种方案。此示例将多个表恢复到使用SYSDATE表示的指定时间点。此示例使用RMAN备份来恢复多个表分区。此示例将多个表恢复为与源架构不同的新架构。">恢复表和表分区</a></p>
                           </li>
                        </ul>
                     </div>
                  </div><a id="BRADV89740"></a><div class="props_rev_3"><a id="GUID-0B058026-43E6-4D39-A67A-B7289636B57F" name="GUID-0B058026-43E6-4D39-A67A-B7289636B57F"></a><h5 id="BRADV-GUID-0B058026-43E6-4D39-A67A-B7289636B57F" class="sect5"><span class="enumeration_section">18.1.2.1</span>非CDB数据库时间点恢复的基本概念</h5>
                     <div>
                        <p>DBPITR在物理级别工作，以在过去的目标时间将数据文件返回到其状态。</p>
                        <p>在RMAN DBPITR操作中，您可以指定目标SCN，日志序列，还原点或时间。RMAN从在目标时间之前创建的备份还原数据库，然后应用增量备份和日志以重新创建数据文件备份时间和恢复结束点之间的所有更改。当结束点被指定为SCN时，数据库应用重做日志并在每个重做线程或指定的SCN之后停止，以先发生者为准。当结束点被指定为时间时，数据库在内部确定指定时间的合适SCN，然后恢复到此SCN。</p>
                        <p>如果您的备份策略设计合理且数据库在<code class="codeph">ARCHIVELOG</code>模式下运行，则几乎在所有情况下都可以选择DBPITR。与<span class="q">“ <a href="user-managed-flashback-dbpitr.html#GUID-2BF2BE5E-3D1B-4F0C-9F10-25D5342F6DB3" title="不完全恢复也称为数据库时间点恢复。">执行不完整数据库恢复</a> ”中</span>描述的用户管理的DBPITR相比，RMAN简化了DBPITR。给定目标SCN，数据文件从备份恢复并有效恢复，而无需用户干预。然而，RMAN DBPITR具有以下缺点：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>您不能将所选对象返回到其早期状态，只返回整个数据库。</p>
                           </li>
                           <li>
                              <p>在DBPITR期间，您的整个数据库都不可用。</p>
                           </li>
                           <li>
                              <p>DBPITR可能非常耗时，因为RMAN必须还原所有数据文件。此外，RMAN可能需要还原重做日志和增量备份以恢复数据文件。如果备份在磁带上，则此过程可能需要更长时间。</p>
                           </li>
                        </ul>
                     </div>
                  </div><a id="BRADV758"></a><div class="props_rev_3"><a id="GUID-35D290AC-CC01-4984-93D6-AE41A3D0D3B6" name="GUID-35D290AC-CC01-4984-93D6-AE41A3D0D3B6"></a><h5 id="BRADV-GUID-35D290AC-CC01-4984-93D6-AE41A3D0D3B6" class="sect5"><span class="enumeration_section">18.1.2.2</span> PDB的时间点恢复的基本概念</h5>
                     <div>
                        <p>RMAN为一个或多个PDB的时间点恢复提供支持。要恢复PDB，必须以具有<code class="codeph">SYSDBA</code>或<code class="codeph">SYSBACKUP</code>权限的用户身份连接到root。恢复后，PDB的旧备份仍然有效，并且可以在发生介质故障时使用。
                        </p>
                        <p>执行PDB的PITR时，此PDB的所有数据文件都会就地恢复。但是，要将PDB恢复到指定的目标时间，RMAN还需要在目标时间存在的<code class="codeph">UNDO</code>表空间。使用共享撤消时， <code class="codeph">UNDO</code>表空间由所有PDB共享，因此无法就地恢复。RMAN将根中的<code class="codeph">UNDO</code> ， <code class="codeph">SYSTEM</code>和<code class="codeph">SYSAUX</code>表空间还原到辅助数据库，然后使用撤消信息将PDB恢复到目标时间。
                        </p>
                        <p>如果配置了快速恢复区域，Oracle数据库会将其用作辅助目标。如果未配置快速恢复区域，则必须使用<code class="codeph">AUXILIARY DESTINATION</code>子句指定用于辅助数据库文件的位置。确保快速恢复区域中有足够的空间来还原根表空间和撤消表空间。如果快速恢复区域没有所需空间，请通过指定<code class="codeph">AUXILIARY DESTINATION</code>子句使用备用位置。
                        </p>
                        <p>在Data Guard环境中，要使备用数据库遵循将PDB还原到特定时间点的主数据库，您可能需要闪回整个备用数据库，还原PDB或闪回PDB。</p>
                        <div class="infoboxnotealso" id="GUID-35D290AC-CC01-4984-93D6-AE41A3D0D3B6__GUID-3169C2EE-CF00-4747-99D5-83EE9CDC1C38">
                           <p class="notep1">也可以看看：</p>
                           <p><a href="rman-performing-flashback-dbpitr.html#GUID-031D9695-A9D2-4381-A840-39BD3CC19946" title="使用RECOVER命令执行容器数据库（CDB）和可插拔数据库（PDB）的时间点恢复（PITR）。PDB的PITR只能使用RMAN执行。">执行CDB和PDB的时间点恢复</a></p>
                        </div>
                     </div>
                  </div><a id="BRADV8702"></a><div class="props_rev_3"><a id="GUID-F2DE2466-1C9C-4FA7-8930-CD5D6DB62928" name="GUID-F2DE2466-1C9C-4FA7-8930-CD5D6DB62928"></a><h5 id="BRADV-GUID-F2DE2466-1C9C-4FA7-8930-CD5D6DB62928" class="sect5"><span class="enumeration_section">18.1.2.3</span>闪回技术的基本概念</h5>
                     <p>在大多数可用的情况下，Oracle数据库的闪回功能比介质恢复更有效。您可以使用它们来调查数据库的过去状态。</p><a id="BRADV89741"></a><div class="props_rev_3"><a id="GUID-3F4DF6A3-137F-4487-B267-0F14E4B7657E" name="GUID-3F4DF6A3-137F-4487-B267-0F14E4B7657E"></a><h6 id="BRADV-GUID-3F4DF6A3-137F-4487-B267-0F14E4B7657E" class="sect6"><span class="enumeration_section">18.1.2.3.1</span>关于物理闪回功能在备份和恢复中很有用</h6>
                        <div>
                           <p>Oracle闪回数据库是DBPITR最有效的替代方案。</p>
                           <p>与其他闪回功能不同，它在物理级别运行，并在以后将当前数据文件还原为其内容。结果就像DBPITR的结果，包括<code class="codeph">OPEN RESETLOGS</code> ，但闪回数据库通常更快，因为它不需要您恢复数据文件，并且与媒体恢复相比仅需要有限的重做应用。
                           </p>
                           <p>闪回数据库需要<a href="glossary.html#GUID-6E3CDD76-A573-4E5C-B12D-59C232C96C19"><span class="xrefglossterm">快速恢复区域</span></a> 。要为闪回数据库启用日志记录，必须设置<a href="../refrn/DB_FLASHBACK_RETENTION_TARGET.html#REFRN10233" target="_blank"><code class="codeph">DB_FLASHBACK_RETENTION_TARGET</code></a>初始化参数并发出<code class="codeph">ALTER DATABASE FLASHBACK ON</code>语句。
                           </p>
                           <p>在正常操作期间，数据库会定期将数据文件块的旧映像写入<a href="glossary.html#GUID-725ED3D7-5077-4F16-85AA-CDAD5BFCE554"><span class="xrefglossterm">闪回日志</span></a> 。闪回日志按顺序写入，通常是批量写入。在某些方面，闪回日志记录就像一个连续备份。数据库会自动创建，删除和调整恢复区域中的闪回日志。闪回日志未归档。您只需要知道闪回日志以监视性能并确定恢复区域的磁盘空间分配。
                           </p>
                           <p>执行闪回数据库操作时，数据库使用闪回日志访问过去版本的数据块，并使用归档重做日志中的某些数据。因此，您无法<span class="italic">在</span>发现故障<span class="italic">后</span>启用闪回数据库，然后使用闪回数据库来回退此故障。您可以使用保证还原点的相关功能在固定时间点保护数据库的内容，例如在数据库发生危险更改之前。
                           </p>
                           <p></p>
                           <p>如果在需要少量重做应用期间遇到任何不可恢复的操作，则将导致逻辑损坏的数据块。访问此类块时，这可能导致Oracle错误。</p>
                           <div class="infoboxnotealso" id="GUID-3F4DF6A3-137F-4487-B267-0F14E4B7657E__GUID-C2E2A17F-F3B5-4715-A544-62A0018C3110">
                              <p class="notep1">也可以看看：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p><a href="rman-performing-flashback-dbpitr.html#GUID-953FA30D-BED2-4DBA-8361-9DA1B8FF073F" title="闪回数据库通过将数据库返回到先前某个时间点的状态来反转不需要的更改。">使用闪回数据库重绕数据库</a></p>
                                 </li>
                                 <li>
                                    <p><a href="configuring-rman-client-basic.html#GUID-302339EC-EE0F-45FB-9862-BB2BA138AA13" title="快速恢复区域功能使您可以设置磁盘区域，数据库可以在该区域中创建和管理与备份和恢复相关的各种文件。强烈建议使用快速恢复区域。考虑将快速恢复区域配置为实施备份策略的第一步。">配置快速恢复区</a></p>
                                 </li>
                                 <li>
                                    <p><a href="../admin/repairing-corrupted-data.html#ADMIN-GUID-21282FF3-1E98-478E-8111-0A7CAFCFCD97" target="_blank"><span><cite>Oracle数据库管理员指南</cite></span></a></p>
                                 </li>
                              </ul>
                           </div>
                        </div>
                     </div><a id="BRADV89742"></a><div class="props_rev_3"><a id="GUID-8FA281D7-9297-4445-985F-4EC4F951CA39" name="GUID-8FA281D7-9297-4445-985F-4EC4F951CA39"></a><h6 id="BRADV-GUID-8FA281D7-9297-4445-985F-4EC4F951CA39" class="sect6"><span class="enumeration_section">18.1.2.3.2</span>关于在备份和恢复中有用的逻辑闪回功能</h6>
                        <div>
                           <p>逻辑闪回功能用于将表及其内容恢复到过去的时间。</p>
                           <p>逻辑特征如下：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>闪回表</p>
                                 <p>您可以将表或一组表恢复到指定的早期时间点，而无需使数据库的任何部分脱机。在许多情况下，闪回表消除了执行更复杂的时间点恢复操作的需要。闪回表在自动维护关联属性（如当前索引，触发器和约束）的同时还原表，而不需要您查找和还原特定于应用程序的属性。</p>
                              </li>
                              <li>
                                 <p>闪回掉落</p>
                                 <p>您可以反转<code class="codeph">DROP TABLE</code>语句的效果。
                                 </p>
                              </li>
                           </ul>
                           <p>除Flashback Drop之外的所有逻辑闪回功能都依赖于<strong class="term">撤消数据</strong> 。主要用于为SQL查询和回滚事务提供读取一致性，撤消记录包含重建过去存在的数据所需的信息，并检查自上次以来的更改记录。
                           </p>
                           <p>Flashback Drop依赖于称为<a href="glossary.html#GUID-6D99D402-0A6E-4718-98E9-19528F3012B2"><span class="xrefglossterm">回收站</span></a>的机制，数据库使用该机制来管理已删除的数据库对象，直到新数据需要它们占用的空间。没有固定数量的空间分配给回收站，并且无法保证丢弃的对象在回收站中保留多长时间。根据系统活动，丢弃的对象可能会在回收站中保留数秒或数月。
                           </p>
                           <div class="infoboxnotealso" id="GUID-8FA281D7-9297-4445-985F-4EC4F951CA39__GUID-D5746CEC-3E83-4D44-A4B8-4CEC4FDC35F2">
                              <p class="notep1">也可以看看：</p>
                              <p> </p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p><a href="rman-performing-flashback-dbpitr.html#GUID-FF315DFC-ABBC-410D-ABDB-75FA89D43255" title="闪回表使用撤消表空间中的信息而不是还原的备份来检索表。发生闪回表操作时，将删除新行并重新插入旧行。在执行表的闪回时，数据库的其余部分仍然可用。">使用闪回表重绕表</a></p>
                                 </li>
                                 <li>
                                    <p><a href="rman-performing-flashback-dbpitr.html#GUID-55EA5EB0-89E2-4561-A9D0-01A6242A2A87" title="您可以使用FLASHBACK TABLE从回收站中检索对象...在DROP声明之前。">使用闪回删除重绕DROP TABLE操作</a></p>
                                 </li>
                                 <li>
                                    <p>有关撤消数据和自动撤消管理的详细信息，请参见<a href="../admin/managing-undo.html#ADMIN013" target="_blank"><span><cite>“Oracle数据库管理员指南”</cite></span></a></p>
                                 </li>
                              </ul>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="sect3"><a id="GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75" name="GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75"></a><h4 id="BRADV-GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75" class="sect4"><span class="enumeration_section">18.1.3</span>为CDB和PDB执行闪回数据库的基本概念</h4>
                  <div>
                     <p>您可以对整个多租户容器数据库（CDB）或特定可插拔数据库（PDB）执行闪回数据库操作。</p>
                     <p>整个CDB的闪回数据库使您可以将整个CDB（包括其所有PDB）倒回到以前的某个时间点。特定PDB的闪回数据库使您可以撤消由该PDB中的逻辑数据损坏或用户错误导致的不必要的更改。当您为特定PDB执行闪回数据库操作时，其他PDB可以打开并运行。</p>
                     <p>您可以在单个PDB上执行多个闪回数据库操作。但是，您只能在PDB上对其祖先的一个版本执行闪回操作。PDB必须始终保持与整个数据库化身兼容的过去化身。</p>
                     <p>要为PDB执行闪回数据库操作，可以使用PDB还原点， <a href="glossary.html#GUID-6BFC6E77-175D-4055-8198-6091D47AD8F6"><span class="xrefglossterm">CDB还原点</span></a> ，SCN或时间表达式指定所需的目标时间点。PDB到CDB还原点的闪回操作相当于PDB上的闪回操作到CDB化身上的还原点SCN。通常，对于PDB，对<a href="glossary.html#GUID-7C3A47D4-B9C5-40D3-89D0-8BD77281AAB1"><span class="xrefglossterm">PDB还原点</span></a>的闪回操作比对CDB还原点的闪回操作更准确。这是因为PDB还原点表示创建它的时间点的PDB子化身。
                     </p>
                     <p></p>
                     <p>在主数据库上执行相同操作后，还可以对物理备用数据库上的PDB执行闪回数据库操作。</p>
                     <p>即使在该PDB上执行闪回数据库操作后，PDB的备份仍然有效。如果介质发生故障，您可以通过还原这些PDB备份来从故障中恢复。这种类型的PDB恢复可以通过数据库重置日志和PDB重置日志进行恢复。</p>
                     <div class="infoboxnote" id="GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75__GUID-CBAD26EF-4569-4BA5-A871-B91EE1539687">
                        <p class="notep1">注意：</p>
                        <p>您不能仅在根目录上执行闪回操作，必须在整个CDB上执行闪回操作。</p>
                     </div>
                     <div class="infoboxnote" id="GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75__GUID-0A768208-8D82-4F9C-B7B6-3FEA705F9F69">
                        <p class="notep1">注意：</p>
                        <p>要对应用程序容器执行闪回操作，必须对应用程序根目录以及属于应用程序容器的所有单个应用程序PDB执行闪回操作。在应用程序根目录上执行闪回操作仅将应用程序根目录还原到指定的时间点。</p>
                     </div>
                     <div class="infoboxnotealso" id="GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75__GUID-3028156A-8C67-4C69-B915-FDD812484308">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><a href="rman-performing-flashback-dbpitr.html#GUID-8466CA3C-652A-4AAB-88EB-8815575D6266" title="您可以使用FLASHBACK DATABASE命令为整个多租户容器数据库（CDB）执行闪回数据库操作。">为整个CDB执行闪回数据库操作</a></p>
                           </li>
                           <li>
                              <p><a href="rman-performing-flashback-dbpitr.html#GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394" title="您可以使用FLASHBACK DATABASE命令对多租户容器数据库（CDB）中的单个可插拔数据库（PDB）执行闪回数据库操作。">为PDB执行闪回数据库操作</a></p>
                           </li>
                           <li>
                              <p><a href="user-managed-flashback-dbpitr.html#GUID-2E5F3F62-17ED-472A-ABBD-FAAF107C6852" title="您可以使用SQL * Plus在非CDB，多租户容器数据库（CDB）和可插拔数据库（PDB）上执行闪回数据库操作。Oracle闪回数据库将整个数据库或整个PDB返回到先前的状态，而无需从备份中还原文件。">使用SQL * Plus执行闪回数据库</a></p>
                           </li>
                        </ul>
                     </div>
                  </div>
                  <div class="sect4"><a id="GUID-FA670699-C8AD-459A-9ED7-8B10F5196BCC" name="GUID-FA670699-C8AD-459A-9ED7-8B10F5196BCC"></a><h5 id="BRADV-GUID-FA670699-C8AD-459A-9ED7-8B10F5196BCC" class="sect5"><span class="enumeration_section">18.1.3.1</span>关于闪回数据库和PDB的PITR</h5>
                     <div>
                        <p></p>
                        <p>对于使用本地撤消的可插拔数据库（PDB），数据库时间点恢复（PITR）和闪回操作彼此独立。</p>
                        <p>对于使用共享撤消的<a href="glossary.html#GUID-993BFB3F-3305-481C-999D-26132095DEC9"><span class="xrefglossterm">PDB</span></a> ，数据库时间点恢复和闪回操作独立于以下警告：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>如果对PDB执行闪回操作或将PDB恢复到特定时间点，Oracle数据库可能会在PDB resetlogs操作期间应用撤消数据，以撤消在该时间点未提交的事务。如果随后将整个<a href="glossary.html#GUID-3E156A59-F6CC-4A2A-9749-DB7D1CE25F13"><span class="xrefglossterm">多租户容器数据库（CDB）</span></a>恢复到PDB resetlogs操作中间的某个时间点，则会收到一条警告，指出某些PDB可能无法打开。对于此类PDB，您需要执行以下互斥操作之一：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>恢复整个CDB或对整个CDB执行闪回操作到不同的SCN</p>
                                 </li>
                                 <li>
                                    <p>恢复所有受影响的PDB或对所有受影响的PDB执行闪回数据库操作到不同的SCN</p>
                                 </li>
                              </ul>
                           </li>
                        </ul>
                        <div class="infoboxnotealso" id="GUID-FA670699-C8AD-459A-9ED7-8B10F5196BCC__GUID-9D8C7C05-BF18-4952-86E7-E540AE50DDED">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75" title="您可以对整个多租户容器数据库（CDB）或特定可插拔数据库（PDB）执行闪回数据库操作。">为CDB和PDB执行闪回数据库的基本概念</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-66B1A12D-1C92-43B5-A204-AA8A6D177ABD" title="多租户容器数据库（CDB）可以使用共享撤消或本地撤消。RMAN用于执行闪回数据库操作的技术取决于CDB的撤消配置类型。">关于PDB的撤消和闪回数据库操作</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-50F6CEE3-3B1B-44B0-9AF4-08E1ABC137B7" title="RMAN提供了管理PDB中数据块的重做损坏的方法。">关于在CDB中管理重做腐败</a></p>
                              </li>
                           </ul>
                        </div>
                     </div>
                  </div>
                  <div class="sect4"><a id="GUID-66B1A12D-1C92-43B5-A204-AA8A6D177ABD" name="GUID-66B1A12D-1C92-43B5-A204-AA8A6D177ABD"></a><h5 id="BRADV-GUID-66B1A12D-1C92-43B5-A204-AA8A6D177ABD" class="sect5"><span class="enumeration_section">18.1.3.2</span>关于PDB的撤消和闪回数据库操作</h5>
                     <div>
                        <p>多租户容器数据库（CDB）可以使用共享撤消或本地撤消。RMAN用于执行闪回数据库操作的技术取决于CDB的撤消配置类型。</p>
                        <p>当CDB使用本地撤消时，在<a href="glossary.html#GUID-D4239448-A344-41EF-9566-0B7716FEAE72"><span class="xrefglossterm">可插拔数据库（PDB）</span></a>上执行闪回数据库操作是直截了当的，因为只需要修改与该PDB相关的数据文件。
                        </p>
                        <p>对于使用共享撤销的CDB，由于所有PDB共享一组表空间，因此可以在撤消表空间内甚至在各个数据块内混合多个PDB的撤消数据。因此，为了对PDB执行闪回数据库操作，RMAN会自动使用辅助实例来还原根中的共享还原表空间和某些表空间，然后将数据恢复到所需的时间点。此过程可能涉及为相对少量的数据恢复备份。在PDB上执行闪回数据库操作到干净的PDB还原点时，不需要辅助实例或还原备份。</p>
                        <p>默认情况下，辅助实例在快速恢复区域中创建。您可以使用<code class="codeph">FLASHBACK DATABASE</code>命令中的<code class="codeph">AUXILIARY DESTINATION</code>子句指定辅助实例的备用位置。
                        </p>
                        <div class="infoboxnotealso" id="GUID-66B1A12D-1C92-43B5-A204-AA8A6D177ABD__GUID-7636783C-D29A-426F-B1AA-EF61DDF4B025">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75" title="您可以对整个多租户容器数据库（CDB）或特定可插拔数据库（PDB）执行闪回数据库操作。">为CDB和PDB执行闪回数据库的基本概念</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-FA670699-C8AD-459A-9ED7-8B10F5196BCC">关于用于PDB的闪回数据库和PITR</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-50F6CEE3-3B1B-44B0-9AF4-08E1ABC137B7" title="RMAN提供了管理PDB中数据块的重做损坏的方法。">关于在CDB中管理重做腐败</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-8466CA3C-652A-4AAB-88EB-8815575D6266" title="您可以使用FLASHBACK DATABASE命令为整个多租户容器数据库（CDB）执行闪回数据库操作。">为整个CDB执行闪回数据库操作</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394" title="您可以使用FLASHBACK DATABASE命令对多租户容器数据库（CDB）中的单个可插拔数据库（PDB）执行闪回数据库操作。">为PDB执行闪回数据库操作</a></p>
                              </li>
                           </ul>
                        </div>
                     </div>
                  </div>
                  <div class="sect4"><a id="GUID-50F6CEE3-3B1B-44B0-9AF4-08E1ABC137B7" name="GUID-50F6CEE3-3B1B-44B0-9AF4-08E1ABC137B7"></a><h5 id="BRADV-GUID-50F6CEE3-3B1B-44B0-9AF4-08E1ABC137B7" class="sect5"><span class="enumeration_section">18.1.3.3</span>关于管理CDB中的重做损坏</h5>
                     <div>
                        <p>RMAN提供了管理PDB中数据块的重做损坏的方法。</p>
                        <p>在极少数情况下， <a href="glossary.html#GUID-3E156A59-F6CC-4A2A-9749-DB7D1CE25F13"><span class="xrefglossterm">多租户容器数据库（CDB）中</span></a>的重做日志可能已损坏。在这种情况下，如果受影响的数据块仅驻留在一个可插拔数据库（PDB）中，则可以执行以下操作之一：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>在PDB上执行闪回操作到损坏之前的某个时间点，然后使用<code class="codeph">RESETLOGS</code>打开PDB</p>
                           </li>
                           <li>
                              <p>执行PDB的时间点恢复到损坏之前的某个时间点，然后使用<code class="codeph">RESETLOGS</code>打开PDB</p>
                           </li>
                        </ul>
                        <p>在主数据库上执行其中一个步骤后，如果您执行在PDB上PITR或闪回之后启用备用数据库跟随主数据库所需的步骤，则此主数据库的任何备用数据库也可以跳过损坏的重做。</p>
                        <div class="infoboxnotealso" id="GUID-50F6CEE3-3B1B-44B0-9AF4-08E1ABC137B7__GUID-95B86396-0E20-420A-8744-FF911CB7EF3C">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75" title="您可以对整个多租户容器数据库（CDB）或特定可插拔数据库（PDB）执行闪回数据库操作。">为CDB和PDB执行闪回数据库的基本概念</a></p>
                              </li>
                              <li>
                                 <p><a href="../sbydb/examples-of-using-oracle-data-guard.html#SBYDB-GUID-8D948A24-A3B7-4E4F-917A-00B047CF3CAF" target="_blank"><span><cite>Oracle Data Guard概念和管理，</cite></span></a>了解如何使备用数据库跟随主数据库</p>
                              </li>
                           </ul>
                        </div>
                     </div>
                  </div>
               </div>
            </div><a id="BRADV81517"></a><div class="props_rev_3"><a id="GUID-FF315DFC-ABBC-410D-ABDB-75FA89D43255" name="GUID-FF315DFC-ABBC-410D-ABDB-75FA89D43255"></a><h3 id="BRADV-GUID-FF315DFC-ABBC-410D-ABDB-75FA89D43255" class="sect3"><span class="enumeration_section">18.2</span>使用闪回表重绕表</h3>
               <div>
                  <p>闪回表使用撤消表空间中的信息而不是还原的备份来检索表。发生闪回表操作时，将删除新行并重新插入旧行。在执行表的闪回时，数据库的其余部分仍然可用。</p>
                  <p><span class="bold">要将表回滚到上一个时间点：</span></p>
                  <ol>
                     <li>
                        <p>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-AA471072-D35C-410E-8C68-14E0DF8FB5D1" title="To perform a Flashback Table operation, the table must be eligible to be flashed back and the user performing the operation must have the required privileges.">闪回表</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-AA471072-D35C-410E-8C68-14E0DF8FB5D1" title="要执行闪回表操作，该表必须有资格闪回，并且执行操作的用户必须具有所需的权限。">先决条件</a></span> 。
                        </p>
                     </li>
                     <li>
                        <p>在表上执行闪回表操作，如<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-A7D05B55-F5EA-46BC-A025-09F423349BAF" title="要在一个或多个表上使用闪回表功能，请使用带有目标时间或SCN的FLASHBACK TABLE SQL语句。">执行闪回表操作</a> ”中所述</span> 。
                        </p>
                     </li>
                  </ol>
                  <div class="infoboxnotealso" id="GUID-FF315DFC-ABBC-410D-ABDB-75FA89D43255__GUID-961184FB-C9A8-41AE-B78C-3BDAB99BFAD0">
                     <p class="notep1">也可以看看：</p>
                     <p><a href="../admin/managing-undo.html#ADMIN013" target="_blank"><span><cite>“Oracle数据库管理员指南”</cite></span></a> ，了解有关自动撤消管理的更多信息</p>
                  </div>
               </div><a id="BRADV89743"></a><div class="props_rev_3"><a id="GUID-AA471072-D35C-410E-8C68-14E0DF8FB5D1" name="GUID-AA471072-D35C-410E-8C68-14E0DF8FB5D1"></a><h4 id="BRADV-GUID-AA471072-D35C-410E-8C68-14E0DF8FB5D1" class="sect4"><span class="enumeration_section">18.2.1</span>闪回表的先决条件</h4>
                  <div>
                     <p>要执行闪回表操作，该表必须有资格闪回，并且执行操作的用户必须具有所需的权限。</p>
                     <p>您必须具有以下权限才能使用闪回表功能：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>您必须已被授予<code class="codeph">FLASHBACK ANY TABLE</code>系统特权，或者您必须具有该表的<code class="codeph">FLASHBACK</code>对象特权。
                           </p>
                        </li>
                        <li>
                           <p>您必须具有表上的<code class="codeph">READ</code>或<code class="codeph">SELECT</code> ， <code class="codeph">INSERT</code> ， <code class="codeph">DELETE</code>和<code class="codeph">ALTER</code>权限。
                           </p>
                        </li>
                        <li>
                           <p>要将表闪回到还原点，必须具有<code class="codeph">SELECT ANY DICTIONARY</code>或<code class="codeph">FLASHBACK ANY TABLE</code>系统特权或<code class="codeph">SELECT_CATALOG_ROLE</code>角色。
                           </p>
                        </li>
                     </ul>
                     <p>对于有资格闪回的对象，必须满足以下先决条件：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>该对象<span class="bold">不得</span>包含以下类别：作为集群一部分的表，物化视图，高级队列（AQ）表，静态数据字典表，系统表，远程表，对象表，嵌套表或单个表分区或子分区。
                           </p>
                        </li>
                        <li>
                           <p>必须在当前时间和目标闪回时间之间不要更改表的结构。</p>
                           <p>以下数据定义语言（DDL）操作更改表的结构：升级，移动或截断表;向表中添加约束，向集群添加表;修改或删除列;添加，删除，合并，拆分，合并或截断分区或子分区（添加范围分区除外）。</p>
                        </li>
                        <li>
                           <p>必须在表上启用行移动，这表示在闪回发生后rowid会发生变化。</p>
                           <p>存在此限制是因为如果应用程序存储闪回之前的rowid，则无法保证rowid在闪回之后对应于相同的行。如果您的应用程序依赖于rowid，则您无法使用闪回表。</p>
                        </li>
                        <li>
                           <p><a href="glossary.html#GUID-675711E4-849C-4D86-993A-D5AA94444D3A"><span class="xrefglossterm">undo表空间中</span></a>的undo数据必须及时延伸到足以满足闪回目标时间或SCN的时间。</p>
                           <p>您可以执行闪回表的点由<a href="glossary.html#GUID-C297DDAF-1A4D-40DA-B89C-46A31D5271E9"><span class="xrefglossterm">撤消保留期</span></a>决定，该<a href="glossary.html#GUID-C297DDAF-1A4D-40DA-B89C-46A31D5271E9"><span class="xrefglossterm">保留期</span></a>是撤销数据在回收之前<a href="glossary.html#GUID-C297DDAF-1A4D-40DA-B89C-46A31D5271E9"><span class="xrefglossterm">保留</span></a>的最短时间，以及表空间特征。撤消数据包含有关数据块更改之前的信息。闪回操作使用undo重新创建原始数据。
                           </p>
                           <p>为确保为闪回表操作保留撤消信息，Oracle建议将撤消表空间的<code class="codeph">UNDO_RETENTION</code>参数设置为86400秒（24小时）或更长时间。
                           </p>
                        </li>
                     </ul>
                     <div class="infoboxnote" id="GUID-AA471072-D35C-410E-8C68-14E0DF8FB5D1__GUID-203F9373-627B-40EC-9445-48D5342A92A4">
                        <p class="notep1">注意：</p>
                        <p><code class="codeph">FLASHBACK</code> <code class="codeph">TABLE</code> <code class="codeph">...</code> <code class="codeph">TO</code> <code class="codeph">BEFORE</code> <code class="codeph">DROP</code>是一款采用了闪回删除功能的，不是闪回表，因此不受这些先决条件。有关详细信息，请参阅<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-55EA5EB0-89E2-4561-A9D0-01A6242A2A87" title="您可以使用FLASHBACK TABLE从回收站中检索对象...在DROP声明之前。">使用闪回删除重绕DROP TABLE操作</a> ”</span> 。
                        </p>
                     </div>
                  </div>
               </div><a id="BRADV341"></a><a id="BRADV89744"></a><div class="props_rev_3"><a id="GUID-A7D05B55-F5EA-46BC-A025-09F423349BAF" name="GUID-A7D05B55-F5EA-46BC-A025-09F423349BAF"></a><h4 id="BRADV-GUID-A7D05B55-F5EA-46BC-A025-09F423349BAF" class="sect4"><span class="enumeration_section">18.2.2</span>执行闪回表操作</h4>
                  <div>
                     <p>要在一个或多个表上使用闪回表功能，请使用带有目标时间或SCN的<code class="codeph">FLASHBACK TABLE</code> SQL语句。</p>
                     <div class="section">
                        <p>假设您希望在用户进行一些不正确的更新后执行<code class="codeph">hr.temp_employees</code>表的闪回。使用以下步骤：</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-AA471072-D35C-410E-8C68-14E0DF8FB5D1" title="To perform a Flashback Table operation, the table must be eligible to be flashed back and the user performing the operation must have the required privileges.">闪回表</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-AA471072-D35C-410E-8C68-14E0DF8FB5D1" title="要执行闪回表操作，该表必须有资格闪回，并且执行操作的用户必须具有所需的权限。">先决条件</a></span> 。</span></li>
                        <li class="stepexpand"><span>将SQL * Plus连接到目标数据库并标识当前的SCN。</span><div>
                              <p>您无法回滚<code class="codeph">FLASHBACK TABLE</code>语句，但可以发出另一个<code class="codeph">FLASHBACK TABLE</code>语句并指定当前时间之前的时间。因此，建议记录当前的SCN。您可以通过查询<code class="codeph">V$DATABASE</code>来获取它，如下所示：</p><pre class="oac_no_warn" dir="ltr">从V $ DATABASE中选择CURRENT_SCN;</pre></div>
                        </li>
                        <li class="stepexpand"><span>标识要将表返回的时间，SCN或还原点。</span><div>
                              <p>如果已创建还原点，则可以通过执行以下查询列出可用的还原点：</p><pre class="oac_no_warn" dir="ltr">SELECT NAME，SCN，TIME from V $ RESTORE_POINT;</pre></div>
                        </li>
                        <li class="stepexpand"><span>确保存在足够的撤消数据以将表回滚到指定目标。</span><div>
                              <p>如果设置了<code class="codeph">UNDO_RETENTION</code>初始化参数，并且启用了撤消保留保证，则可以使用以下查询来确定撤消数据的保留时间：</p><pre class="oac_no_warn" dir="ltr">SELECT NAME，VALUE / 60 MINUTES_RETAINED from V $ PARAMETER WHERE NAME ='undo_retention';</pre></div>
                        </li>
                        <li class="stepexpand"><span>确保为使用闪回表重写的所有对象启用了行移动。</span><div>
                              <p>您可以使用以下SQL语句为表启用行移动：</p><pre class="oac_no_warn" dir="ltr">ALTER TABLE <code class="codeph">hr.temp_employees</code> ENABLE ROW MOVEMENT;</pre></div>
                        </li>
                        <li class="stepexpand"><span>确定要闪回的表是否依赖于其他表。如果存在依赖关系，则决定是否也闪回这些表。</span><div>
                              <p>您可以发出以下SQL查询以确定依赖关系，其中<span class="italic">schema_name</span>是要闪回的表的架构， <span class="italic">table_name</span>是表的名称：</p><pre class="oac_no_warn" dir="ltr">SELECT other.owner，other.table_name FROM sys.all_constraints this，sys.all_constraints other WHERE this.owner = <span class="italic">schema_name</span> AND this.table_name = <span class="italic">table_name</span> AND this.r_owner = other.owner AND this.r_constraint_name = other.constraint_name AND this.constraint_type = 'R';</pre></div>
                        </li>
                        <li class="stepexpand" id="GUID-A7D05B55-F5EA-46BC-A025-09F423349BAF__CHDHCAGI"><span>为要闪回的对象执行<code class="codeph">FLASHBACK TABLE</code>语句。</span><div>
                              <p>以下SQL语句将<code class="codeph">hr.temp_employees</code>表返回到名为<code class="codeph">temp_employees_update</code> ：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE hr.temp_employees要恢复POINT temp_employees_update;</pre><p>当数据库处于SCN指定的时间时，以下SQL语句将<code class="codeph">hr.temp_employees</code>表倒<code class="codeph">hr.temp_employees</code>其状态：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE hr.temp_employees TO SCN 123456;</pre><p>如以下示例所示，您还可以使用<code class="codeph">TO_TIMESTAMP</code>指定目标时间点：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE hr.temp_employees TO TIMESTAMP TO_TIMESTAMP（'2013-10-17 09:30:00'，'YYYY-MM-DD HH：MI：SS'）;</pre><div class="infoboxnote" id="GUID-A7D05B55-F5EA-46BC-A025-09F423349BAF__GUID-4A748F8A-A374-45BE-852B-18EE762998F8">
                                 <p class="notep1">注意：</p>
                                 <p>时间戳到SCN的映射并不总是准确的。当您使用<code class="codeph">FLASHBACK</code> <code class="codeph">TABLE</code>语句使用时间戳时，表闪回的时间最多可以为<code class="codeph">TO_TIMESTAMP</code>指定的时间大约3秒。如果需要确切的时间点，则使用SCN而不是时间。
                                 </p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>（可选）查询表以检查数据。</span></li>
                     </ol>
                     <div class="section">
                        <div class="infoboxnotealso" id="GUID-A7D05B55-F5EA-46BC-A025-09F423349BAF__GUID-919EDDE7-195F-46D0-84CE-4D3DA06E31E3">
                           <p class="notep1">也可以看看：</p><a href="rman-performing-flashback-dbpitr.html#GUID-3F9961EC-EF49-4E19-BAFD-3A11EDDE53C8" title="默认情况下，数据库在执行FLASHBACK TABLE操作之前禁用受影响的表上的触发器。在操作之后，数据库将触发器返回到操作之前的状态（启用或禁用）。">在闪回表期间保持触发器启用</a></div>
                     </div>
                     <!-- class="section" -->
                  </div><a id="BRADV89745"></a><div class="props_rev_3"><a id="GUID-3F9961EC-EF49-4E19-BAFD-3A11EDDE53C8" name="GUID-3F9961EC-EF49-4E19-BAFD-3A11EDDE53C8"></a><h5 id="BRADV-GUID-3F9961EC-EF49-4E19-BAFD-3A11EDDE53C8" class="sect5"><span class="enumeration_section">18.2.2.1</span>在闪回表期间保持触发器启用</h5>
                     <div>
                        <p>默认情况下，数据库在执行<code class="codeph">FLASHBACK TABLE</code>操作之前禁用受影响的表上的触发器。在操作之后，数据库将触发器返回到操作之前的状态（启用或禁用）。
                        </p>
                        <div class="section">
                           <p>要在表的闪回期间保持启用触发器，请在<code class="codeph">FLASHBACK TABLE</code>语句中添加<code class="codeph">ENABLE TRIGGERS</code>子句。
                           </p>
                           <p>例如，假设在17:00，HR管理员发现<code class="codeph">hr.temp_employees</code>表中缺少员工。该员工在最后一次运行报告的14:00时被包含在表中。因此，有人在14:00到17:00之间意外删除了该员工的记录。HR管理员使用闪回表将表恢复到14:00的状态，通过使用以下示例中的SQL语句，尊重<code class="codeph">hr.temp_employees</code>表上设置的任何触发器：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE hr.temp_employees TO TIMESTAMP TO_TIMESTAMP（'2013-03-03 14:00:00'，'YYYY-MM-DD HH：MI：SS'）ENABLE TRIGGERS;</pre><div class="infoboxnotealso" id="GUID-3F9961EC-EF49-4E19-BAFD-3A11EDDE53C8__GUID-5C47F87D-FBB4-4080-9D69-9AA1BD8E3B55">
                              <p class="notep1">也可以看看：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p><a href="../admin/managing-tables.html#ADMIN01512" target="_blank"><span><cite>Oracle数据库管理员指南</cite></span></a> ，了解如何使用闪回表功能恢复表</p>
                                 </li>
                                 <li>
                                    <p>用于简单闪回表方案的<a href="../sqlrf/FLASHBACK-TABLE.html#SQLRF01802" target="_blank"><span><cite>Oracle数据库SQL语言参考</cite></span></a></p>
                                 </li>
                              </ul>
                           </div>
                        </div>
                        <!-- class="section" -->
                     </div>
                  </div>
               </div>
            </div><a id="BRADV81511"></a><div class="props_rev_3"><a id="GUID-55EA5EB0-89E2-4561-A9D0-01A6242A2A87" name="GUID-55EA5EB0-89E2-4561-A9D0-01A6242A2A87"></a><h3 id="BRADV-GUID-55EA5EB0-89E2-4561-A9D0-01A6242A2A87" class="sect3"><span class="enumeration_section">18.3</span>使用闪回删除重绕DROP TABLE操作</h3>
               <div>
                  <p>您可以使用<code class="codeph">FLASHBACK TABLE ...从回收站中检索对象<code class="codeph">FLASHBACK TABLE ...TO BEFORE DROP</code>声明TO BEFORE DROP</code> 。
                  </p>
                  <p>本节包含以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-D953DEDB-4C98-4BA9-B5FE-CCBA68679C3F" title="Flashback Drop可以反转DROP TABLE操作的效果。闪回丢弃比在这种情况下可以使用的其他恢复机制（如时间点恢复）更快，并且不会导致停机或丢失最近的事务。">关于Flashback Drop</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-F5B66BE0-4941-4513-821B-74F7ACB6489E" title="在执行闪回删除操作之前，必须满足先决条件。">Flashback Drop的先决条件</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-6AED5A17-B29C-4F92-80C0-49F06A62DE4F" title="使用FLASHBACK TABLE ...在DROP语句之前要从回收站中恢复对象。您可以指定回收站中表的名称或原始表名。">执行闪回删除操作</a></p>
                     </li>
                  </ul>
               </div><a id="BRADV89746"></a><div class="props_rev_3"><a id="GUID-D953DEDB-4C98-4BA9-B5FE-CCBA68679C3F" name="GUID-D953DEDB-4C98-4BA9-B5FE-CCBA68679C3F"></a><h4 id="BRADV-GUID-D953DEDB-4C98-4BA9-B5FE-CCBA68679C3F" class="sect4"><span class="enumeration_section">18.3.1</span>关于Flashback Drop</h4>
                  <div>
                     <p>Flashback Drop可以反转<code class="codeph">DROP TABLE</code>操作的效果。闪回丢弃比在这种情况下可以使用的其他恢复机制（如时间点恢复）更快，并且不会导致停机或丢失最近的事务。
                     </p>
                     <p>删除表时，数据库不会立即删除与表关联的空间。而是重命名该表，并将其与任何关联的对象一起放置在回收站中。系统生成的回收站对象名称是唯一的。您可以查询回收站中的对象，就像查询其他对象一样。</p>
                     <p>闪回操作从回收站中检索表。检索已删除的表时，可以指定表的原始用户指定名称或系统生成的名称。</p>
                     <p>删除表时，表及其所有依赖对象一起进入回收站。同样，当您执行Flashback Drop时，通常会一起检索所有对象。从回收站还原表时，索引等依赖对象不会返回其原始名称;他们保留了系统生成的回收站名称。Oracle数据库检索表中定义的所有索引（位图连接索引除外），以及在表上定义的所有触发器和约束，但引用其他表的引用完整性约束除外。</p>
                     <p>由于空间压力，某些依赖对象（如索引）可能已被回收。在这种情况下，回收的依赖对象不能从回收站中检索。</p>
                  </div>
               </div><a id="BRADV89747"></a><div class="props_rev_3"><a id="GUID-F5B66BE0-4941-4513-821B-74F7ACB6489E" name="GUID-F5B66BE0-4941-4513-821B-74F7ACB6489E"></a><h4 id="BRADV-GUID-F5B66BE0-4941-4513-821B-74F7ACB6489E" class="sect4"><span class="enumeration_section">18.3.2</span>闪回删除的先决条件</h4>
                  <div>
                     <p>在执行闪回删除操作之前，必须满足先决条件。</p>
                     <p>与闪回删除和回收站相关的操作所需的用户权限如下：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><code class="codeph">下降</code></p>
                           <p>对对象具有<code class="codeph">DROP</code>权限的任何用户都可以删除该对象，将其放在回收站中。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">闪回表......在下降之前</code></p>
                           <p>此语句的权限与<code class="codeph">DROP</code>的权限相关联。也就是说，任何可以删除对象的用户都可以执行闪回删除以从回收站中检索已删除的对象。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">清除</code></p>
                           <p>清除回收站的权限与<code class="codeph">DROP</code>权限相关联。具有<code class="codeph">DROP</code> <code class="codeph">TABLE</code> ， <code class="codeph">DROP</code> <code class="codeph">ANY</code> <code class="codeph">TABLE</code>或<code class="codeph">PURGE</code> <code class="codeph">DBA_RECYCLE_BIN</code>权限的任何用户都可以从回收站中清除对象。
                           </p>
                        </li>
                        <li>
                           <p>对回收站中的对象进行<code class="codeph">READ</code>或<code class="codeph">SELECT</code>和<code class="codeph">FLASHBACK</code></p>
                           <p>用户必须对回收站中的对象具有<code class="codeph">READ</code>或<code class="codeph">SELECT</code>和<code class="codeph">FLASHBACK</code>权限才能查询回收站中的对象。谁的任何用户<code class="codeph">READ</code>或<code class="codeph">SELECT</code>权限在对象它已被删除之前继续拥有<code class="codeph">READ</code>或<code class="codeph">SELECT</code>特权在回收站中的对象。用户必须具有<code class="codeph">FLASHBACK</code>权限才能查询回收站中的任何对象，因为这些对象来自数据库的过去状态。
                           </p>
                        </li>
                     </ul>
                     <p>对象必须满足以下先决条件才有资格从回收站中检索：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>回收站仅适用于非系统的本地管理表空间。如果表位于非系统本地管理的表空间中，但其一个或多个依赖段（对象）位于字典管理的表空间中，则这些对象受回收站保护。</p>
                        </li>
                        <li>
                           <p>具有通过它们定义的细粒度审计（FGA）和虚拟专用数据库（VPD）策略的表不受回收站保护。</p>
                        </li>
                        <li>
                           <p>分区索引组织表不受回收站保护。</p>
                        </li>
                        <li>
                           <p>在空间回收操作期间，用户或Oracle数据库不得清除该表。</p>
                        </li>
                     </ul>
                  </div>
               </div><a id="BRADV342"></a><a id="BRADV89748"></a><div class="props_rev_3"><a id="GUID-6AED5A17-B29C-4F92-80C0-49F06A62DE4F" name="GUID-6AED5A17-B29C-4F92-80C0-49F06A62DE4F"></a><h4 id="BRADV-GUID-6AED5A17-B29C-4F92-80C0-49F06A62DE4F" class="sect4"><span class="enumeration_section">18.3.3</span>执行闪回删除操作</h4>
                  <div>
                     <p>使用<code class="codeph">FLASHBACK TABLE ...TO BEFORE DROP</code>语句TO BEFORE DROP</code>要从回收站中恢复对象。您可以指定回收站中表的名称或原始表名。
                     </p>
                     <div class="section">
                        <p>本节假设您删除了错误的表。很多时候，系统会要求您删除测试数据库中的表，但在这种情况下，您会意外地连接到生产数据库并删除<code class="codeph">hr.employee_demo</code> 。您决定使用<code class="codeph">FLASHBACK TABLE</code>来检索已删除的对象。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-6AED5A17-B29C-4F92-80C0-49F06A62DE4F__GUID-91AF9D54-7139-4D29-A47F-2B0CEE6F1954">要检索已删除的表：</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-F5B66BE0-4941-4513-821B-74F7ACB6489E" title="Prerequisites must be met before you perform a Flashback Drop operation.">闪回删除</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-F5B66BE0-4941-4513-821B-74F7ACB6489E" title="在执行闪回删除操作之前，必须满足先决条件。">先决条件</a></span> 。</span></li>
                        <li class="stepexpand"><span>将SQL * Plus连接到目标数据库，并在回收站中获取已删除表的名称。</span><div>
                              <p>您可以使用SQL * Plus命令<code class="codeph">SHOW RECYCLEBIN</code> ，如下所示：</p><pre class="oac_no_warn" dir="ltr">SHOW RECYCLEBIN; ORIGINAL NAME RECYCLEBIN NAME TYPE DROP TIME ---------------- --------------------------- ------ ------------ ------------- EMPLOYEE_DEMO BIN $ gk3lsj / 3akk5hg3j2lkl5j3d == $ 0 TABLE 2013-04-11：17：08 ：54</pre><p><code class="codeph">ORIGINAL NAME</code>列显示对象的原始名称，而<code class="codeph">RECYCLEBIN NAME</code>列显示bin中存在的对象的名称。
                              </p>
                              <p>或者，您可以查询<code class="codeph">USER_RECYCLEBIN</code>或<code class="codeph">DBA_RECYCLEBIN</code>以获取表名。以下示例查询<code class="codeph">RECYCLEBIN</code>视图以确定已删除对象的原始名称：</p><pre class="oac_no_warn" dir="ltr">SELECT object_name AS recycle_name，original_name，type FROM recyclebin; RECYCLE_NAME ORIGINAL_NAME TYPE -------------------------------- --------------- ------ ---------- BIN $ gk3lsj / 3akk5hg3j2lkl5j3d == $ 0 EMPLOYEE_DEMO TABLE BIN $ JKS983293M1dsab4gsz / I249 == $ 0 I_EMP_DEMO INDEX</pre><p>如果计划手动还原从属对象的原始名称，请确保在还原表之前记下每个依赖对象的系统生成的回收站名称。</p>
                              <div class="infoboxnote" id="GUID-6AED5A17-B29C-4F92-80C0-49F06A62DE4F__GUID-0D3C2A73-76B9-410C-8654-0055FA9D0511">
                                 <p class="notep1">注意：</p>
                                 <p>对象视图（如<code class="codeph">DBA_TABLES</code>不显示回收站对象。
                                 </p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>（可选）查询回收站中的表。</span><div>
                              <p>您必须在查询中使用对象的回收站名称，而不是对象的原始名称。以下示例使用回收站名称<code class="codeph">BIN$gk3lsj/3akk5hg3j2lkl5j3d==$0</code>查询该表：</p><pre class="oac_no_warn" dir="ltr">SELECT * FROM“BIN $ gk3lsj / 3akk5hg3j2lkl5j3d == $ 0”;</pre><p>由于回收站名称中的特殊字符，因此需要引号。</p>
                              <div class="infoboxnote" id="GUID-6AED5A17-B29C-4F92-80C0-49F06A62DE4F__GUID-F65AC0E0-BB55-49FA-B1DA-4BACCA92084C">
                                 <p class="notep1">注意：</p>
                                 <p>如果您具有必要的权限，则还可以对回收站中的表使用闪回查询，但只能使用回收站名称而不是原始表名称。您不能对回收站中的对象使用数据操作语言（DML）或DDL语句。</p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>检索已删除的表。</span><div>
                              <p>使用<code class="codeph">FLASHBACK TABLE ...TO BEFORE DROP</code>声明TO BEFORE DROP</code> 。以下示例恢复<code class="codeph">BIN$gk3lsj/3akk5hg3j2lkl5j3d==$0</code>表，将其名称更改回<code class="codeph">hr.employee_demo</code> ，并从回收站中清除其条目：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE“BIN $ gk3lsj / 3akk5hg3j2lkl5j3d == $ 0”在DROP之前;</pre><p>表名用引号括起来，因为回收站对象名中可能出现特殊字符。</p>
                              <p>或者，您可以使用表的原始名称：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE HR.EMPLOYEE_DEMO要在DROP之前;</pre><p>您还可以通过指定<code class="codeph">RENAME TO</code>子句为恢复的表分配新名称。例如：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE“BIN $ gk3lsj / 3akk5hg3j2lkl5j3d == $ 0”在DROP重命名为hr.emp_demo之前;</pre></div>
                        </li>
                        <li class="stepexpand"><span>（可选）验证所有从属对象是否保留其系统生成的回收站名称。</span><div>
                              <p>以下查询确定检索到的<code class="codeph">hr.employee_demo</code>表的索引名称：</p><pre class="oac_no_warn" dir="ltr">SELECT INDEX_NAME FROM USER_INDEXES WHERE TABLE_NAME ='EMPLOYEE_DEMO'; INDEX_NAME ------------------------------ BIN $ JKS983293M1dsab4gsz / I249 == $ 0</pre></div>
                        </li>
                        <li class="stepexpand"><span>（可选）将检索到的索引重命名为其原始名称。</span><div>
                              <p>以下语句将索引重命名为其原始名称<code class="codeph">i_emp_demo</code> ：</p><pre class="oac_no_warn" dir="ltr">ALTER INDEX“BIN $ JKS983293M1dsab4gsz / I249 == $ 0”重播给I_EMP_DEMO;</pre></div>
                        </li>
                        <li class="stepexpand"><span>如果检索到的表在放入回收站之前具有引用约束，则重新创建它们。</span><div>
                              <p>必须手动执行此步骤，因为回收站不会保留对表的引用约束。</p>
                           </div>
                        </li>
                     </ol>
                     <div class="section">
                        <div class="infoboxnotealso" id="GUID-6AED5A17-B29C-4F92-80C0-49F06A62DE4F__GUID-FA2CD6BF-F83C-4CEC-80E6-57FCEA964621">
                           <p class="notep1">也可以看看：</p>
                           <p><a href="rman-performing-flashback-dbpitr.html#GUID-C4927875-8F00-4AC7-8DDE-A56C3EEFE8AE" title="您可以使用相同的原始名称创建，然后删除多个对象。所有丢弃的对象都存储在回收站中。">当多个对象共享相同的原始名称时，使用闪回删除对象</a></p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div><a id="BRADV343"></a><a id="BRADV344"></a><a id="BRADV89749"></a><div class="props_rev_3"><a id="GUID-C4927875-8F00-4AC7-8DDE-A56C3EEFE8AE" name="GUID-C4927875-8F00-4AC7-8DDE-A56C3EEFE8AE"></a><h5 id="BRADV-GUID-C4927875-8F00-4AC7-8DDE-A56C3EEFE8AE" class="sect5"><span class="enumeration_section">18.3.3.1</span>当多个对象共享同一原始名称时，使用闪回删除对象</h5>
                     <div>
                        <p>您可以使用相同的原始名称创建，然后删除多个对象。所有丢弃的对象都存储在回收站中。</p>
                        <div class="section">
                           <p>例如，请考虑以下示例中的SQL语句：</p>
                        </div>
                        <!-- class="section" -->
                        <div class="example" id="GUID-C4927875-8F00-4AC7-8DDE-A56C3EEFE8AE__CHDHFEHA">
                           <p class="titleinexample">示例18-1删除具有相同名称的多个对象</p><pre class="oac_no_warn" dir="ltr">CREATE TABLE temp_employees（ <span class="italic">... columns</span> ）; ＃temp_employees版本1 DROP TABLE temp_employees; CREATE TABLE temp_employees（ <span class="italic">... columns</span> ）; #temp_employees版本2 DROP TABLE temp_employees; CREATE TABLE temp_employees（ <span class="italic">... columns</span> ）; ＃temp_employees版本3 DROP TABLE temp_employees;</pre><p>每个表<code class="codeph">temp_employees</code>在删除时都会在回收站中分配一个唯一的名称。你可以使用<code class="codeph">FLASHBACK TABLE ...使用表的原始名称TO BEFORE DROP</code>语句，如下例所示：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE temp_employees在DROP之前;</pre><p>具有此原始名称的最近删除的表将从其原始名称的回收站中检索。</p>
                           <p>以下示例显示了从前一个示例中的所有三个已删除的<code class="codeph">temp_employees</code>表的回收站中检索，每个表都分配了一个新名称。
                           </p>
                        </div>
                        <!-- class="example" -->
                        <div class="example" id="GUID-C4927875-8F00-4AC7-8DDE-A56C3EEFE8AE__CHDHFEBA">
                           <p class="titleinexample">示例18-2重命名丢弃的表</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE temp_employees在DROP重命名为temp_employees_VERSION_3之前; FLASHBACK TABLE temp_employees在DROP重命名为temp_employees_VERSION_2之前; FLASHBACK TABLE temp_employees在DROP重命名为temp_employees_VERSION_1之前;</pre><p>因为<code class="codeph">FLASHBACK</code> <code class="codeph">TABLE</code>的原始名称是指具有此名称的最近删除的表，所以删除的最后一个表是第一个检索到的表。
                           </p>
                           <p>通过使用表的唯一回收站名称，您还可以从回收站中检索任何表，而不管原始名称之间是否存在任何冲突。例如，假设您按如下方式查询回收站（包括示例输出）：</p><pre class="oac_no_warn" dir="ltr">SELECT object_name，original_name，createtime FROM recyclebin; OBJECT_NAME ORIGINAL_NAME CREATETIME ------------------------------ ---------------  - ----------------- BIN $ yrMKlZaLMhfgNAgAIMenRA == $ 0 TEMP_EMPLOYEES 2013-02-05：21：05：52 BIN $ yrMKlZaVMhfgNAgAIMenRA == $ 0 TEMP_EMPLOYEES 2013-02-05：21： 25:13 BIN $ yrMKlZaQMhfgNAgAIMenRA == $ 0 TEMP_EMPLOYEES 2013-02-05：22：05：53</pre><p>您可以使用以下命令检索中间表：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK TABLE BIN $ yrMKlZaVMhfgNAgAIMenRA == $ 0到DROP之前;</pre></div>
                        <!-- class="example" -->
                        <div class="section">
                           <div class="infoboxnotealso" id="GUID-C4927875-8F00-4AC7-8DDE-A56C3EEFE8AE__GUID-2A284595-F74F-4908-80B5-F074EB8268DB">
                              <p class="notep1">也可以看看：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p><a href="../admin/managing-tables.html#ADMIN01511" target="_blank"><span><cite>Oracle数据库管理员指南</cite></span></a> ，了解如何使用闪回删除和管理回收站</p>
                                 </li>
                                 <li>
                                    <p>有关<code class="codeph">FLASHBACK TABLE</code>语句的信息，请<a href="../sqlrf/FLASHBACK-TABLE.html#SQLRF01802" target="_blank"><span><cite>参见Oracle数据库SQL语言参考</cite></span></a></p>
                                 </li>
                              </ul>
                           </div>
                        </div>
                        <!-- class="section" -->
                     </div>
                  </div>
               </div>
            </div><a id="BRADV81330"></a><div class="props_rev_3"><a id="GUID-953FA30D-BED2-4DBA-8361-9DA1B8FF073F" name="GUID-953FA30D-BED2-4DBA-8361-9DA1B8FF073F"></a><h3 id="BRADV-GUID-953FA30D-BED2-4DBA-8361-9DA1B8FF073F" class="sect3"><span class="enumeration_section">18.4</span>使用闪回数据库重绕数据库</h3>
               <div>
                  <p>闪回数据库通过将数据库返回到先前某个时间点的状态来反转不需要的更改。</p>
                  <p>本节包含以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82" title="闪回数据库通过撤消对运行命令时存在的数据文件的更改来工作。必须满足先决条件才能执行闪回数据库操作。">闪回数据库的先决条件</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8" title="闪回数据库操作使用FLASHBACK DATABASE命令将数据库回滚到过去的某个时间点。">执行闪回数据库操作</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-8466CA3C-652A-4AAB-88EB-8815575D6266" title="您可以使用FLASHBACK DATABASE命令为整个多租户容器数据库（CDB）执行闪回数据库操作。">为整个CDB执行闪回数据库操作</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394" title="您可以使用FLASHBACK DATABASE命令对多租户容器数据库（CDB）中的单个可插拔数据库（PDB）执行闪回数据库操作。">为PDB执行闪回数据库操作</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-93BF7DBC-2520-4C7D-B059-663F963B68DA" title="数据字典视图包含用于监视闪回数据库的信息。">监控闪回数据库</a></p>
                     </li>
                  </ul>
               </div><a id="BRADV89751"></a><div class="props_rev_3"><a id="GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82" name="GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82"></a><h4 id="BRADV-GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82" class="sect4"><span class="enumeration_section">18.4.1</span>闪回数据库的先决条件</h4>
                  <div>
                     <p>闪回数据库通过撤消对运行命令时存在的数据文件的更改来工作。必须满足先决条件才能执行闪回数据库操作。</p>
                     <p>要使用<code class="codeph">FLASHBACK DATABASE</code>命令将数据库内容返回到闪回窗口内的时间点，必须先为数据库配置闪回日志记录。要将数据库返回到保证还原点，您必须先前已定义了保证还原点。
                     </p>
                     <p>请注意以下重要先决条件：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>当前数据文件没有丢失或损坏。您只能使用<code class="codeph">FLASHBACK DATABASE</code>来回滚对Oracle数据库生成的数据文件的更改，而不是修复介质故障。
                           </p>
                        </li>
                        <li>
                           <p>您不是试图从意外删除数据文件，撤消收缩数据文件操作或撤消对数据库名称的更改中恢复。</p>
                        </li>
                        <li>
                           <p>您没有尝试使用<code class="codeph">FLASHBACK DATABASE</code>返回到恢复或重新创建控制文件之前的某个时间点。如果从备份还原或重新创建数据库控制文件，则会丢弃所有累积的闪回日志信息。
                           </p>
                        </li>
                        <li>
                           <p>您没有尝试使用<code class="codeph">FLASHBACK DATABASE</code>撤消兼容性更改。
                           </p>
                        </li>
                     </ul>
                     <div class="infoboxnotealso" id="GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82__GUID-880F43E7-D0BE-4E33-9F13-9E50CEF4426A">
                        <p class="notep1">也可以看看：</p>
                        <div class="p"> 
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><span class="q">“ <a href="using-flasback-database-restore-points.html#GUID-FAA04D1F-36E2-4B20-954F-845E42386775" title="Oracle闪回数据库和还原点是相关的数据保护功能，使您能够及时回溯数据，以纠正在指定时间窗口内由逻辑数据损坏或用户错误导致的任何问题。">闪回数据库，还原点和保证还原点概述</a> ”</span></p>
                              </li>
                              <li>
                                 <p><span class="q">“ <a href="using-flasback-database-restore-points.html#GUID-2C846D84-EDCC-4FAA-9F6A-05CD0C6C7C09" title="您可以创建，监视和删除正常和保证还原点。">使用正常和保证还原点</a> ”</span></p>
                              </li>
                              <li>
                                 <p>有关<code class="codeph">FLASHBACK DATABASE</code>的命令先决条件和使用说明的完整列表，请<a href="../rcmrf/FLASHBACK-DATABASE.html#RCMRF194" target="_blank"><span><cite>参见Oracle数据库备份和恢复参考</cite></span></a></p>
                              </li>
                           </ul>
                        </div>
                     </div>
                  </div>
               </div><a id="BRADV345"></a><a id="BRADV89752"></a><div class="props_rev_3"><a id="GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8" name="GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8"></a><h4 id="BRADV-GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8" class="sect4"><span class="enumeration_section">18.4.2</span>执行闪回数据库操作</h4>
                  <div>
                     <p>闪回数据库操作使用<code class="codeph">FLASHBACK DATABASE</code>命令将数据库回滚到过去的某个时间点。
                     </p>
                     <div class="section">
                        <p>本主题介绍了执行数据库闪回的基本技术，使用时间表达式，正常或保证还原点的名称或SCN指定所需的目标时间点。它做出以下假设：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>您正在将数据库倒回到当前数据库<a href="glossary.html#GUID-4CCAB7DD-FEA7-4237-AF2C-304BA3BD52B1"><span class="xrefglossterm">化身的</span></a>某个时间点。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">FLASHBACK DATABASE</code>命令中使用的SCN是指数据库化身的<a href="glossary.html#GUID-9FA6E4CA-C9C0-47E8-8FDF-2C2A313F8944"><span class="xrefglossterm">直接祖先路径</span></a>中的SCN。如果在先前使用<code class="codeph">RESETLOGS</code>选项打开数据库之后没有放弃，则此路径中的化身就在此路径中。
                              </p>
                           </li>
                        </ul>
                        <p><span class="bold">要执行闪回数据库操作：</span></p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82" title="Flashback Database works by undoing changes to the data files that exist at the moment that you run the command. Prerequisites must be met to perform a Flashback Database operation.">闪回数据库</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82" title="闪回数据库通过撤消对运行命令时存在的数据文件的更改来工作。必须满足先决条件才能执行闪回数据库操作。">先决条件</a></span> 。</span></li>
                        <li class="stepexpand"><span>将SQL * Plus连接到目标数据库，并确定<code class="codeph">FLASHBACK DATABASE</code>命令所需的SCN，还原点或时间点。</span><div>
                              <p>在闪回数据库窗口中获取最早的SCN，如下所示：</p><pre class="oac_no_warn" dir="ltr">SELECT OLDEST_FLASHBACK_SCN，OLDEST_FLASHBACK_TIME FROM V $ FLASHBACK_DATABASE_LOG;</pre><p>使用闪回数据库可以访问的最新SCN是数据库的当前SCN。以下查询返回当前SCN：</p><pre class="oac_no_warn" dir="ltr">从V $ DATABASE中选择CURRENT_SCN;</pre><p>您可以按如下方式查询可用的保证还原点（包括样本输出）：</p><pre class="oac_no_warn" dir="ltr">SELECT NAME，SCN，TIME，DATABASE_INCARNATION＃，GUARANTEE_FLASHBACK_DATABASE FROM V $ RESTORE_POINT WHERE GUARANTEE_FLASHBACK_DATABASE ='YES';名称SCN TIME DATABASE_INCARNATION #GUA --------------- ---------- ------------------- -  --------------------- --- BEFORE_CHANGES 5753126 04-MAR-12 12.39.45 AM 2是</pre><div class="infoboxnote" id="GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__GUID-53270E0A-7FA0-4E47-B7F1-C623688E40C6">
                                 <p class="notep1">注意：</p>
                                 <p>如果闪回窗口没有足够长的时间延伸到过去以达到所需的目标时间，并且如果在所需的时间没有保证的恢复点，那么通过使用数据库时间点恢复可以获得类似的结果，如<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-7D3EE2F7-77A2-4264-8875-CC0AEC64ABE0" title="RMAN DBPITR在目标恢复时间之前从备份还原数据库，然后使用增量备份和重做将数据库前滚到目标时间。您可以恢复到SCN，时间，日志序列号或还原点。Oracle建议您在重要时间创建还原点，以便在必要时使时间点恢复更易于管理。">执行数据库时间点恢复</a> ”中所述</span> 。
                                 </p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>一致地关闭数据库，确保它没有被任何实例打开，然后安装它：</span><div><pre class="oac_no_warn" dir="ltr">立即关闭;启动安装;</pre></div>
                        </li>
                        <li class="stepexpand"><span>在此过程的步骤2中重复该查询。</span><div>
                              <p>关闭数据库时会生成一些闪回日志记录数据。如果由于快速恢复区域中的空间压力而删除了闪回日志，则可能无法访问目标SCN。</p>
                              <div class="infoboxnote" id="GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__GUID-E7475A65-085D-4DA5-AC8C-FB3054E15F49">
                                 <p class="notep1">注意：</p>
                                 <p>如果在目标SCN位于闪回窗口之外时运行<code class="codeph">FLASHBACK</code> <code class="codeph">DATABASE</code> ，则<code class="codeph">FLASHBACK</code> <code class="codeph">DATABASE</code>因<code class="codeph">ORA-38729</code>错误而失败。在这种情况下，您的数据库不会更改。
                                 </p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>启动RMAN并连接到目标数据库，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。</span></li>
                        <li class="stepexpand"><span>运行<code class="codeph">SHOW</code>命令以查看预配置了哪些通道。</span><div>
                              <p>在闪回操作期间，RMAN可能需要从备份还原存档的重做日志。输入以下命令以查看是否已配置通道（包括样本输出）：</p><pre class="oac_no_warn" dir="ltr">显示所有; db_unique_name PROD1的数据库的RMAN配置参数是：。。。配置默认设备类型磁盘; #default CONFIGURE DEVICE TYPE DISK PARALLELISM 1 BACKUP TYPE TO BACKUPSET; #default CONFIGURE DEVICE TYPE SBT_TAPE PARALLELISM 1 BACKUP TYPE TO BACKUPSET; #default CONFIGURE CHANNEL DEVICE TYPE'SBT_TAPE'PARMS“SBT_LIBRARY = / usr / local / oracle / backup / lib / libobk.so”;</pre><p>如果配置了必要的设备和通道，则无需执行任何操作。否则，使用<code class="codeph">CONFIGURE</code>命令配置自动通道，或在<code class="codeph">RUN</code>块中包含<code class="codeph">ALLOCATE CHANNEL</code>命令。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>运行RMAN <code class="codeph">FLASHBACK DATABASE</code>命令。</span><div>
                              <p>您可以使用以下示例中显示的命令形式指定目标时间：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK DATABASE TO SCN 46963; FLASHBACK DATABASE恢复点之前的数据; FLASHBACK DATABASE TO TIME“TO_DATE（'09 / 20/12'，'MM / DD / YY'）”;</pre><p><code class="codeph">FLASHBACK DATABASE</code>命令完成后，数据库将保持挂载并恢复到指定的目标时间。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>在SQL * Plus中以只读方式打开数据库并运行一些查询以验证数据库内容。</span><div>
                              <p>以如下方式打开数据库只读：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN READ ONLY;</pre><p>如果您对数据库的状态感到满意，则使用步骤<a href="rman-performing-flashback-dbpitr.html#GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__CHDGDJAC">9</a>结束该过程。如果你<span class="italic">不满意</span>数据库的状态，跳到步骤<a href="rman-performing-flashback-dbpitr.html#GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__CHDHCDBD">10</a> 。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand" id="GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__CHDGDJAC"><span>如果您对结果感到满意，请执行以下互斥操作之一：</span><div>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>通过使用<code class="codeph">RESETLOGS</code>选项打开数据库，使数据库可用于更新。如果数据库当前是以只读方式打开的，则在SQL * Plus中执行以下命令：</p><pre class="oac_no_warn" dir="ltr">SHUTDOWN立即启动安装ALAT DATABASE OPEN RESETLOGS;</pre><div class="infoboxnote" id="GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__GUID-FF820FDC-E2BB-4A02-A447-7B5FD1D6CE59">
                                       <p class="notep1">注意：</p>
                                       <p>执行此<code class="codeph">OPEN</code> <code class="codeph">RESETLOGS</code>操作后，将放弃在<code class="codeph">FLASHBACK DATABASE</code>的目标SCN之后对数据库的所有更改。不过，您可以使用<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-CECE183D-C000-485A-99DA-371768A79011" title="You can use Flashback Database to rewind a database to an abandoned database incarnation.">将数据库重新转换为废弃的化身分支中的SCN</a> ”中</span>的技术， <span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-CECE183D-C000-485A-99DA-371768A79011" title="您可以使用闪回数据库将数据库回滚到废弃的数据库化身。">将数据库</a></span>返回到该范围的SCN，同时它们仍保留在闪回窗口中。
                                       </p>
                                    </div>
                                 </li>
                                 <li>
                                    <p>使用Oracle Data Pump Export对状态已损坏的对象进行逻辑备份。然后，使用RMAN将数据库恢复到当前时间：</p><pre class="oac_no_warn" dir="ltr">恢复数据库;</pre><p>此步骤通过将重做日志中的所有更改重新应用到数据库，将其返回到最新的SCN，从而撤消闪回数据库的影响。</p>
                                    <p>重新打开数据库读/写后，可以使用数据泵导入实用程序导入导出的对象。请参阅<a href="../sutil/oracle-data-pump-overview.html#SUTIL100" target="_blank"><span><cite>Oracle数据库实用程序</cite></span></a>以了解如何使用Data Pump。
                                    </p>
                                 </li>
                              </ul>
                           </div>
                        </li>
                        <li class="stepexpand" id="GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__CHDHCDBD"><span>如果您发现闪回使用了错误的还原点，时间或SCN，则装入数据库并执行以下互斥选项之一：</span><div>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果您选择的目标时间过去不够远，则使用另一个<code class="codeph">FLASHBACK DATABASE</code>命令进一步回溯数据库：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK DATABASE TO SCN 42963; #earlier比当前的SCN</pre></li>
                              </ul>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果您选择过去太远的目标SCN，则使用<code class="codeph">RECOVER DATABASE UNTIL</code>将数据库及时转发到所需的SCN：</p><pre class="oac_no_warn" dir="ltr">RECOVER DATABASE UNTIL SCN 56963; #later比当前的SCN</pre></li>
                              </ul>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果要完全撤消<code class="codeph">FLASHBACK DATABASE</code>命令的影响，则可以使用不带<code class="codeph">UNTIL</code>子句或<code class="codeph">SET UNTIL</code>命令的<code class="codeph">RECOVER DATABASE</code>命令执行数据库的完全恢复：</p><pre class="oac_no_warn" dir="ltr">恢复数据库;</pre><p><code class="codeph">RECOVER DATABASE</code>命令重新应用对数据库的所有更改，并将其返回到最新的SCN。</p>
                                 </li>
                              </ul>
                              <div class="infoboxnotealso" id="GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__GUID-B83615BC-8DB6-4622-A4EB-B91241B6E324">
                                 <p class="notep1">也可以看看：</p>
                                 <ul style="list-style-type:disc">
                                    <li>
                                       <p><span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-7E39909E-E2D5-4D08-ADD8-0D5FEF028489" title="Flashback Database can be used to undo an OPEN RESETLOGS operation.">使用闪回数据库</a></span>重新<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-7E39909E-E2D5-4D08-ADD8-0D5FEF028489" title="闪回数据库可用于撤消OPEN RESETLOGS操作。">打开RESETLOGS操作</a> ”</span>将数据库返回到最近的<code class="codeph">OPEN RESETLOGS</code>操作之前的时间点</p>
                                    </li>
                                    <li>
                                       <p><span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-CECE183D-C000-485A-99DA-371768A79011" title="您可以使用闪回数据库将数据库回滚到废弃的数据库化身。">将数据库复制到废弃的化身分支中的SCN</a> ”</span>以检索废弃化身的变化</p>
                                    </li>
                                 </ul>
                              </div>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div>
               <div class="sect3"><a id="GUID-8466CA3C-652A-4AAB-88EB-8815575D6266" name="GUID-8466CA3C-652A-4AAB-88EB-8815575D6266"></a><h4 id="BRADV-GUID-8466CA3C-652A-4AAB-88EB-8815575D6266" class="sect4"><span class="enumeration_section">18.4.3</span>对整个CDB执行闪回数据库操作</h4>
                  <div>
                     <p>您可以使用<code class="codeph">FLASHBACK DATABASE</code>命令为整个多租户容器数据库（CDB）执行闪回数据库操作。
                     </p>
                     <div class="section">
                        <p>当<code class="codeph">COMPATIBLE</code>初始化参数设置为12.1.0时，在极少数情况下，跨PDB（可插拔数据库）时间点恢复（PITR）或PDB闪回在CDB上执行闪回数据库操作可能会导致以下错误：</p>
                        <p> <code class="codeph">ORA-39866：可插入数据库&lt;PDB_name&gt;的数据文件必须脱机才能在特殊的12.1 PDB重置日志中闪回</code></p>
                        <p>要解决此错误并在PDB PITR或PDB闪回的CDB上执行闪回操作，请使用“在<span class="italic">Oracle数据库备份和恢复用户指南12c中</span>使用DBPITR恢复PDB时在CDB上执行闪回数据库操作”中描述的步骤<span class="italic">第1版（12.1）</span> 。
                        </p>
                        <p>对CDB执行闪回数据库操作的步骤与用于非CDB的步骤类似，本主题中描述了不同之处。</p>
                        <p><span class="bold">要为整个CDB执行闪回数据库操作：</span></p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82" title="Flashback Database works by undoing changes to the data files that exist at the moment that you run the command. Prerequisites must be met to perform a Flashback Database operation.">闪回数据库</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-6520BA73-8BFF-4D79-9970-589A2FDA0C82" title="闪回数据库通过撤消对运行命令时存在的数据文件的更改来工作。必须满足先决条件才能执行闪回数据库操作。">先决条件</a></span> 。</span></li>
                        <li class="stepexpand"><span>将SQL * Plus连接到目标CDB，并确定<code class="codeph">FLASHBACK DATABASE</code>命令所需的SCN，还原点或时间点。</span><div>
                              <p>在闪回数据库窗口中获取最早的SCN，如下所示：</p><pre class="oac_no_warn" dir="ltr">SELECT OLDEST_FLASHBACK_SCN，OLDEST_FLASHBACK_TIME FROM V $ FLASHBACK_DATABASE_LOG;</pre><p>使用闪回数据库可以访问的最新SCN是数据库的当前SCN。以下查询返回当前SCN：</p><pre class="oac_no_warn" dir="ltr">从V $ DATABASE中选择CURRENT_SCN;</pre><p>您可以按如下方式查询可用的保证还原点（包括样本输出）：</p><pre class="oac_no_warn" dir="ltr">SELECT NAME，SCN，TIME，DATABASE_INCARNATION＃，GUARANTEE_FLASHBACK_DATABASE FROM V $ RESTORE_POINT WHERE GUARANTEE_FLASHBACK_DATABASE ='YES';名称SCN TIME DATABASE_INCARNATION #GUA --------------- ---------- ------------------- -  --------------------- --- BEFORE_CHANGES 5753126 04-MAR-12 12.39.45 AM 2是</pre><div class="infoboxnote" id="GUID-8466CA3C-652A-4AAB-88EB-8815575D6266__GUID-764B6D6C-710F-45CE-89E4-A834AF142E23">
                                 <p class="notep1">注意：</p>
                                 <p>如果闪回窗口没有足够长的时间延伸到过去以达到所需的目标时间，并且如果在所需的时间没有保证的恢复点，那么通过使用数据库时间点恢复可以获得类似的结果，如<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-7572C8E9-05B8-4BCC-823F-BD6763C51B11" title="使用RESTORE和RECOVER命令为整个CDB执行时间点恢复。">执行整个CDB的时间点恢复</a> ”中所述</span> 。
                                 </p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>一致地关闭数据库，确保它没有被任何实例打开，然后安装它：</span><div><pre class="oac_no_warn" dir="ltr">立即关闭;启动安装;</pre></div>
                        </li>
                        <li class="stepexpand"><span>在此过程的步骤2中重复该查询。</span><div>
                              <p>关闭数据库时会生成一些闪回日志记录数据。如果由于快速恢复区域中的空间压力而删除了闪回日志，则可能无法访问目标SCN。</p>
                              <div class="infoboxnote" id="GUID-8466CA3C-652A-4AAB-88EB-8815575D6266__IFYOURUNFLASHBACKDATABASEWHENYOURTA-BFA04DC4">
                                 <p class="notep1">注意：</p>
                                 <p>如果在目标SCN位于闪回窗口之外时运行<code class="codeph">FLASHBACK DATABASE</code> ，则<code class="codeph">FLASHBACK DATABASE</code>因<code class="codeph">ORA-38729</code>错误而失败。在这种情况下，您的数据库不会更改。
                                 </p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>使用<code class="codeph">SYSDBA</code>或<code class="codeph">SYSBACKUP</code>权限以普通用户身份连接到root，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。</span></li>
                        <li class="stepexpand"><span>要查看预配置了哪些通道，请运行<code class="codeph">SHOW</code>命令。</span><div>
                              <p>在闪回操作期间，RMAN可能需要从备份还原存档的重做日志。要查看通道是否已配置，请输入以下命令（包括示例输出）：</p><pre class="oac_no_warn" dir="ltr">显示所有;</pre><p>如果配置了必要的设备和通道，则无需执行任何操作。否则，使用<code class="codeph">CONFIGURE</code>命令配置自动通道，或在<code class="codeph">RUN</code>块中包含<code class="codeph">ALLOCATE CHANNEL</code>命令。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>运行<code class="codeph">FLASHBACK DATABASE</code>命令以对整个CDB执行闪回操作到指定的时间点。</span><div>
                              <p>您可以使用SCN，时间表达式或<a href="glossary.html#GUID-6BFC6E77-175D-4055-8198-6091D47AD8F6"><span class="xrefglossterm">CDB还原点</span></a>指定目标时间。
                              </p>
                              <p>以下示例为整个CDB执行闪回数据库操作：</p><pre class="pre codeblock"><code>FLASHBACK DATABASE TO SCN 345588; FLASHBACK DATABASE恢复点cdb_before_upgrade;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>在SQL * Plus中以只读方式打开CDB并运行一些查询以验证数据库内容。</span><div>
                              <p>以下列方式打开CDB只读：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN READ ONLY;</pre><p>如果您对数据库的状态感到满意，则使用步骤<a href="rman-performing-flashback-dbpitr.html#GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__CHDGDJAC">9</a>结束该过程。如果你<span class="italic">不满意</span>数据库的状态，跳到步骤<a href="rman-performing-flashback-dbpitr.html#GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8__CHDHCDBD">10</a> 。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand" id="GUID-8466CA3C-652A-4AAB-88EB-8815575D6266__CHDGDJAC"><span>如果您对结果感到满意，请执行以下互斥操作之一：</span><div>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>通过使用<code class="codeph">RESETLOGS</code>选项打开数据库，使数据库可用于更新。如果数据库是以只读方式打开的，则在SQL * Plus中执行以下命令：</p><pre class="oac_no_warn" dir="ltr">SHUTDOWN立即启动安装ALAT DATABASE OPEN RESETLOGS;</pre><div class="infoboxnote" id="GUID-8466CA3C-652A-4AAB-88EB-8815575D6266__GUID-FF820FDC-E2BB-4A02-A447-7B5FD1D6CE59">
                                       <p class="notep1">注意：</p>
                                       <p>执行此<code class="codeph">OPEN RESETLOGS</code>操作后，将放弃在<code class="codeph">FLASHBACK DATABASE</code>的目标SCN之后对数据库的所有更改。不过，您可以使用<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-CECE183D-C000-485A-99DA-371768A79011" title="You can use Flashback Database to rewind a database to an abandoned database incarnation.">将数据库重新转换为废弃的化身分支中的SCN</a> ”中</span>的技术， <span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-CECE183D-C000-485A-99DA-371768A79011" title="您可以使用闪回数据库将数据库回滚到废弃的数据库化身。">将数据库</a></span>返回到该范围的SCN，同时它们仍保留在闪回窗口中。
                                       </p>
                                    </div>
                                 </li>
                                 <li>
                                    <p>使用Oracle Data Pump Export对状态已损坏的对象进行逻辑备份。然后，使用RMAN将数据库恢复到当前时间：</p><pre class="oac_no_warn" dir="ltr">恢复数据库;</pre><p>此步骤通过将重做日志中的所有更改重新应用到数据库，将其返回到最新的SCN，从而撤消闪回数据库的影响。</p>
                                    <p>重新打开数据库读/写后，可以使用数据泵导入实用程序导入导出的对象。请参阅<a href="../sutil/oracle-data-pump-overview.html#SUTIL100" target="_blank"><span class="italic">Oracle数据库实用程序</span></a>以了解如何使用Data Pump。
                                    </p>
                                 </li>
                              </ul>
                           </div>
                        </li>
                        <li class="stepexpand" id="GUID-8466CA3C-652A-4AAB-88EB-8815575D6266__CHDHCDBD"><span>如果您发现闪回使用了错误的还原点，时间或SCN，则装入数据库并执行以下互斥选项之一：</span><div>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果您选择的目标时间过去不够远，则使用另一个<code class="codeph">FLASHBACK DATABASE</code>命令进一步回溯数据库：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK DATABASE TO SCN 42963; #earlier比当前的SCN</pre></li>
                              </ul>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果您选择过去太远的目标SCN，则使用<code class="codeph">RECOVER DATABASE UNTIL</code>将数据库及时转发到所需的SCN：</p><pre class="oac_no_warn" dir="ltr">RECOVER DATABASE UNTIL SCN 56963; #later比当前的SCN</pre></li>
                              </ul>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果要完全撤消<code class="codeph">FLASHBACK DATABASE</code>命令的影响，则可以使用不带<code class="codeph">UNTIL</code>子句或<code class="codeph">SET UNTIL</code>命令的<code class="codeph">RECOVER DATABASE</code>命令执行数据库的完全恢复：</p><pre class="oac_no_warn" dir="ltr">恢复数据库;</pre><p><code class="codeph">RECOVER DATABASE</code>命令重新应用对数据库的所有更改，并将其返回到最新的SCN。</p>
                                 </li>
                              </ul>
                           </div>
                        </li>
                        <li class="stepexpand"><span>由于在打开CDB时<a href="glossary.html#GUID-993BFB3F-3305-481C-999D-26132095DEC9"><span class="xrefglossterm">PDB</span></a>不会自动打开，因此请打开PDB。</span><div>
                              <p>以下命令连接到根时会打开所有PDB：</p><pre class="pre codeblock"><code>ALTER PLUGGABLE DATABASE ALL OPEN;</code></pre><p>如果您只想打开一些PDB，则可以单独打开每个PDB。连接到root时，以下命令将打开PDB <code class="codeph">my_pdb</code> 。
                              </p><pre class="pre codeblock"><code>ALTER PLUGGABLE DATABASE my_pdb OPEN;</code></pre></div>
                        </li>
                     </ol>
                     <div class="section">
                        <div class="infoboxnotealso" id="GUID-8466CA3C-652A-4AAB-88EB-8815575D6266__GUID-4842C396-C523-4D93-85C5-4BAA31B7EB4A">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><a href="using-flasback-database-restore-points.html#GUID-434CD26D-D3DC-454B-A598-70F64D7C01EB" title="CDB还原点充当SCN的别名或多租户容器数据库（CDB）中的时间点。它可以是正常的还原点或保证还原点。">关于CDB还原点</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-50F6CEE3-3B1B-44B0-9AF4-08E1ABC137B7" title="RMAN提供了管理PDB中数据块的重做损坏的方法。">关于在CDB中管理重做腐败</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394" title="您可以使用FLASHBACK DATABASE命令对多租户容器数据库（CDB）中的单个可插拔数据库（PDB）执行闪回数据库操作。">为PDB执行闪回数据库操作</a></p>
                              </li>
                           </ul>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
               <div class="sect3"><a id="GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394" name="GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394"></a><h4 id="BRADV-GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394" class="sect4"><span class="enumeration_section">18.4.4</span>为PDB执行闪回数据库操作</h4>
                  <div>
                     <p>您可以使用<code class="codeph">FLASHBACK DATABASE</code>命令对多租户容器数据库（CDB）中的单个可插拔数据库（PDB）执行闪回数据库操作。
                     </p>
                     <div class="section">在特定<a href="glossary.html#GUID-993BFB3F-3305-481C-999D-26132095DEC9"><span class="xrefglossterm">PDB</span></a>上执行闪回数据库操作仅修改与该PDB相关的数据文件。 <a href="glossary.html#GUID-3D253996-C2C0-449A-AFA2-85A9DA323FD3"><span class="xrefglossterm">CDB</span></a>中的其他PDB不受影响，可供使用。
                     </div>
                     <!-- class="section" -->
                     <div class="section">使用还原点时，可以对<a href="glossary.html#GUID-6BFC6E77-175D-4055-8198-6091D47AD8F6"><span class="xrefglossterm">CDB还原点</span></a> ， <a href="glossary.html#GUID-7C3A47D4-B9C5-40D3-89D0-8BD77281AAB1"><span class="xrefglossterm">PDB还原点</span></a> ，PDB清除还原点或PDB保证还原点执行闪回数据库操作。
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394__GUID-2D8140FA-C59E-4E98-901B-824470F3F1C9">要为PDB执行闪回数据库操作：</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>使用<code class="codeph">SYSDBA</code>或<code class="codeph">SYSBACKUP</code>权限以普通用户身份连接到root用户。</span><div>
                              <p>请参阅<a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> 。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>确保CDB已打开。</span><div>
                              <p>以下命令连接到根时，显示CDB打开的模式。</p><pre class="pre codeblock"><code>从V $ DATABASE中选择open_mode;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>确定闪回数据库命令所需的SCN，还原点或时间点。</span><div>查询<code class="codeph">V$RESTORE_POINT</code>视图以获取PDB还原点列表。<code class="codeph">V$FLASHBACK_DATABASE_LOG</code>显示可以执行闪回操作的最旧SCN。
                           </div>
                        </li>
                        <li class="stepexpand"><span>确保关闭必须执行闪回数据库操作的PDB。其他PDB可以是开放的和可操作的。</span><div>
                              <p>连接到根时，以下<code class="codeph">ALTER PLUGGABLE DATABASE</code>命令将关闭PDB <code class="codeph">my_pdb</code> 。
                              </p><pre class="pre codeblock"><code>ALTER PLUGGABLE DATABASE my_pdb CLOSE;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>对指定的PDB执行闪回数据库操作到所需的时间点。</span><div>
                              <p>以下是PDB闪回数据库操作的一些示例。</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>对于使用本地撤消的PDB：</p><pre class="pre codeblock"><code>FLASHBACK PLUGGABLE DATABASE my_pdb TO SCN 24368;</code></pre><pre class="pre codeblock"><code>FLASHBACK PLUGGABLE DATABASE my_pdb TO RESTORE POINT guar_rp;</code></pre><pre class="pre codeblock"><code>FLASHBACK PLUGGABLE DATABASE my_pdb TO CLEAN RESTORE POINT clean_rp;</code></pre></li>
                                 <li>
                                    <p>对于使用共享撤消的PDB，您可以选择包括<code class="codeph">AUXILIARY DESTINATION</code>子句，以指定存储作为闪回数据库操作的一部分而恢复的数据文件的辅助实例的位置。如果省略此子句，则会在快速恢复区域中创建辅助实例。
                                    </p><pre class="pre codeblock"><code>FLASHBACK PLUGGABLE DATABASE my_pdb TO SCN 24368 AUXILIARY DESTINATION'+ data';</code></pre><pre class="pre codeblock"><code>FLASHBACK PLUGGABLE DATABASE my_pdb to RESTORE POINT before_appl_changes AUXILIARY DESTINATION'/ temp / aux_dest';</code></pre><pre class="pre codeblock"><code>FLASHBACK PLUGGABLE DATABASE my_pdb TO TIME“TO_DATE（'03 / 20/15'，'MM / DD / YY'）”;</code></pre></li>
                              </ul>
                           </div>
                        </li>
                        <li class="stepexpand"><span>使用<code class="codeph">RESETLOGS</code>打开PDB。</span><div>
                              <p>以下命令使用<code class="codeph">RESETLOGS</code>打开名为<code class="codeph">my_pdb</code>的PDB：</p><pre class="pre codeblock"><code>ALTER PLUGGABLE DATABASE my_pdb OPEN RESETLOGS;</code></pre></div>
                        </li>
                     </ol>
                     <div class="section">
                        <p></p>
                        <div class="infoboxnote" id="GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394__GUID-6064FA25-8BE6-46F4-B162-AE351B9ADC1E">
                           <p class="notep1">注意：</p>
                           <p>代理PDB不支持闪回操作。</p>
                        </div>
                        <div class="infoboxnote" id="GUID-C1215E86-9A7B-4EC9-9777-2A18BD627394__GUID-7C17AD02-823F-4607-A2A3-A6C7F84B6213">
                           <p class="notep1">注意：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><a href="using-flasback-database-restore-points.html#GUID-34C48821-B29D-4A2E-94DE-CD97CFA7784E" title="您可以在可插拔数据库（PDB）中创建正常和保证还原点。PDB还原点只能由定义它们的PDB访问。">关于PDB中的还原点</a></p>
                              </li>
                              <li>
                                 <p><a href="using-flasback-database-restore-points.html#GUID-1A583D44-66CB-4D21-B170-2A07CFF6EE65" title="您可以使用V $ RESTORE_POINT控制文件视图来获取有关所有当前定义的还原点（正常和保证）的信息，包括CDB还原点和PDB还原点。">使用V $ RESTORE_POINT视图列出还原点</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-66B1A12D-1C92-43B5-A204-AA8A6D177ABD" title="多租户容器数据库（CDB）可以使用共享撤消或本地撤消。RMAN用于执行闪回数据库操作的技术取决于CDB的撤消配置类型。">关于PDB的撤消和闪回数据库操作</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-A2146E48-16FC-40CC-B25D-902DEB93CB75" title="您可以对整个多租户容器数据库（CDB）或特定可插拔数据库（PDB）执行闪回数据库操作。">为CDB和PDB执行闪回数据库的基本概念</a></p>
                              </li>
                              <li>
                                 <p><a href="rman-performing-flashback-dbpitr.html#GUID-8466CA3C-652A-4AAB-88EB-8815575D6266" title="您可以使用FLASHBACK DATABASE命令为整个多租户容器数据库（CDB）执行闪回数据库操作。">为整个CDB执行闪回数据库操作</a></p>
                              </li>
                           </ul>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="BRADV604"></a><a id="BRADV603"></a><div class="props_rev_3"><a id="GUID-93BF7DBC-2520-4C7D-B059-663F963B68DA" name="GUID-93BF7DBC-2520-4C7D-B059-663F963B68DA"></a><h4 id="BRADV-GUID-93BF7DBC-2520-4C7D-B059-663F963B68DA" class="sect4"><span class="enumeration_section">18.4.5</span>监控闪回数据库</h4>
                  <div>
                     <p>数据字典视图包含用于监视闪回数据库的信息。</p>
                     <div class="section">
                        <p>使用闪回数据库将数据库回滚到过去的目标时间时，闪回数据库会确定在目标时间之后更改了哪些块，并从闪回日志中还原它们。这称为<span class="bold">恢复阶段</span> 。完成此阶段后，闪回数据库将使用重做日志重新应用在将这些块写入闪回日志后所做的更改。这称为<span class="bold">恢复阶段</span> 。
                        </p>
                        <p>可以通过查询<code class="codeph">V$SESSION_LONGOPS</code>视图来监视恢复阶段期间闪回数据库的进度。<code class="codeph">opname</code>是<code class="codeph">Flashback Database</code> 。在<code class="codeph">TOTALWORK</code>列下，是必须读取的闪回日志的兆字节数。以下示例中的<code class="codeph">SOFAR</code>列列出了当前读取的兆字节数。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="example" id="GUID-93BF7DBC-2520-4C7D-B059-663F963B68DA__CHDBEJEJ">
                        <p class="titleinexample">示例18-3跟踪闪回数据库进度 - 还原阶段</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT sofar，totalwork，units FROM v $ session_longops WHERE opname ='Flashback Database'; SOFAR TOTALWORK UNITS ----- ---------- -------------------------------- 17 60兆字节</pre><p>可以通过查询视图<code class="codeph">V$RECOVERY_PROGRESS</code>来监视恢复阶段闪回数据库的进度。</p>
                        <div class="infoboxnotealso" id="GUID-93BF7DBC-2520-4C7D-B059-663F963B68DA__GUID-63FBF987-0E46-457E-81D1-01B5CE01523C">
                           <p class="notep1">也可以看看：</p>
                           <p>有关视图<code class="codeph">V$RECOVERY_PROGRESS</code>信息，请参阅<a href="../refrn/V-RECOVERY_PROGRESS.html#REFRN30199" target="_blank"><span><cite>Oracle数据库参考</cite></span></a></p>
                        </div>
                     </div>
                     <!-- class="example" -->
                  </div>
               </div>
            </div><a id="BRADV84152"></a><div class="props_rev_3"><a id="GUID-7D3EE2F7-77A2-4264-8875-CC0AEC64ABE0" name="GUID-7D3EE2F7-77A2-4264-8875-CC0AEC64ABE0"></a><h3 id="BRADV-GUID-7D3EE2F7-77A2-4264-8875-CC0AEC64ABE0" class="sect3"><span class="enumeration_section">18.5</span>执行数据库时间点恢复</h3>
               <div>
                  <p>RMAN DBPITR在目标恢复时间之前从备份还原数据库，然后使用增量备份和重做将数据库前滚到目标时间。您可以恢复到SCN，时间，日志序列号或还原点。Oracle建议您在重要时间创建还原点，以便在必要时使时间点恢复更易于管理。</p>
                  <p>Oracle建议您尽可能执行闪回数据库而不是数据库时间点恢复。当闪回技术无法用于撤消最近的更改时，使用备份进行介质恢复是最后一种选择。</p>
                  <p>本节包含以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="必须满足某些先决条件才能执行数据库时间点恢复（DBPITR）。">数据库时间点恢复的先决条件</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-5B964EB6-B498-4A0D-B480-5C6E0BACFA5D" title="使用RESTORE和RECOVER命令执行DBPITR。">执行数据库时间点恢复</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-031D9695-A9D2-4381-A840-39BD3CC19946" title="使用RECOVER命令执行容器数据库（CDB）和可插拔数据库（PDB）的时间点恢复（PITR）。PDB的PITR只能使用RMAN执行。">执行CDB和PDB的时间点恢复</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-1414BF57-1CBF-4BE6-A4C1-2521B3CF8B5F" title="使用RESTORE和RECOVER命令执行应用程序PDB的时间点恢复。">执行应用程序PDB的时间点恢复</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-AB0D518A-4959-4714-AD88-01518969A939" title="执行稀疏数据库的时间点恢复与执行普通数据库的时间点恢复类似。">执行稀疏数据库的时间点恢复</a></p>
                     </li>
                  </ul>
               </div><a id="BRADV89753"></a><div class="props_rev_3"><a id="GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" name="GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6"></a><h4 id="BRADV-GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" class="sect4"><span class="enumeration_section">18.5.1</span>数据库时间点恢复的先决条件</h4>
                  <div>
                     <p>必须满足某些先决条件才能执行数据库时间点恢复（DBPITR）。</p>
                     <p>这包括以下内容：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>您的数据库必须以<code class="codeph">ARCHIVELOG</code>模式运行。
                           </p>
                        </li>
                        <li>
                           <p>您必须在目标SCN之前备份所有数据文件，以备份SCN和目标SCN之间的DBPITR和归档日志。</p>
                        </li>
                        <li>
                           <p>如果使用透明加密创建备份，并且使用了基于密码的软件密钥库，则必须在执行还原操作之前提供密钥库密码。使用带有<code class="codeph">DECRYPTION WALLET OPEN IDENTIFIED BY</code>选项的<code class="codeph">SET</code>命令指定必须用于打开基于密码的密钥库的密码。请注意，使用自动登录软件密钥库时不需要此命令。
                           </p>
                        </li>
                        <li>
                           <p>如果使用密码模式加密创建备份，则必须在运行<code class="codeph">RESTORE</code>和<code class="codeph">RECOVER</code>命令之前提供用于解密备份的密码。使用<code class="codeph">SET DECRYPTION IDENTIFIED BY</code>命令指定用于解密备份的密码。
                           </p>
                        </li>
                     </ul>
                     <div class="infoboxnotealso" id="GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6__GUID-FF696C48-2F94-4061-8918-1EAD3774C116">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">SET</code> <a href="../rcmrf/SET.html#RCMRF153" target="_blank"><span><cite>Oracle数据库备份和恢复参考”</cite></span></a>中的<code class="codeph">SET</code>命令，了解此命令的语法和用法</p>
                           </li>
                           <li>
                              <p>有关命令先决条件和使用说明的完整说明，请<code class="codeph">RECOVER</code> <a href="../rcmrf/RECOVER.html#RCMRF140" target="_blank"><span><cite>Oracle数据库备份和恢复参考</cite></span></a>中的<code class="codeph">RECOVER</code>命令</p>
                           </li>
                        </ul>
                     </div>
                  </div>
               </div><a id="BRADV346"></a><a id="BRADV89754"></a><div class="props_rev_3"><a id="GUID-5B964EB6-B498-4A0D-B480-5C6E0BACFA5D" name="GUID-5B964EB6-B498-4A0D-B480-5C6E0BACFA5D"></a><h4 id="BRADV-GUID-5B964EB6-B498-4A0D-B480-5C6E0BACFA5D" class="sect4"><span class="enumeration_section">18.5.2</span>执行数据库时间点恢复</h4>
                  <div>
                     <p>使用<code class="codeph">RESTORE</code>和<code class="codeph">RECOVER</code>命令执行DBPITR。</p>
                     <div class="section">
                        <p>执行DBPITR时，可以通过使用<code class="codeph">SET UNTIL</code>命令在过程开始时设置目标时间来避免错误，而不是单独在<code class="codeph">RESTORE</code>和<code class="codeph">RECOVER</code>命令上指定<code class="codeph">UNTIL</code>子句。这可确保从备份恢复的数据文件具有足够早的时间戳，以便在后续的<code class="codeph">RECOVER</code>操作中使用。
                        </p>
                        <p>本节做出以下假设：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>您正在当前数据库中执行DBPITR。如果您的目标时间不在当前版本中，请参阅<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-F1818201-98E5-4B70-BDFE-A61AB84397E6" title="要将DPITR执行到非当前数据库化身，必须显式执行RESET DATABASE以将数据库重置为目标SCN上当前的化身。您还必须从包含目标SCN的数据库化身中还原控制文件。">将数据库恢复为祖先化身</a> ”</span>以获取有关DBPITR到祖先化身的更多信息。
                              </p>
                           </li>
                           <li>
                              <p>控制文件是最新的。如果必须还原备份控制文件，请参阅<span class="q">“ <a href="rman-recovery-advanced.html#GUID-77C2B092-4BEB-4BAC-91F9-7368EA16A2B6" title="当所有当前控制文件都丢失时，您必须还原备份控制文件。">使用备份控制文件执行恢复</a> ”</span> 。
                              </p>
                           </li>
                           <li>
                              <p>您的数据库正在使用当前服务器参数文件。如果必须还原备份服务器参数文件，请参阅<span class="q">“ <a href="rman-recovery-advanced.html#GUID-2B93E1AF-5ED1-4FAE-91BB-63362CADF7AD" title="RMAN可以将丢失的服务器参数文件还原到其默认位置或您选择的位置。与丢失控制文件不同，丢失服务器参数文件不会导致实例立即停止。实例可能会继续运行，但您必须将其关闭并在还原服务器参数文件后重新启动它。">还原服务器参数文件</a> ”</span> 。
                              </p>
                           </li>
                        </ul>
                        <p><span class="bold">要执行DBPITR：</span></p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <ol>
                           <li>
                              <p>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="Certain prerequisites must be met to perform database point-in-time recovery (DBPITR).">数据库时间点恢复</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="必须满足某些先决条件才能执行数据库时间点恢复（DBPITR）。">先决条件</a></span> 。
                              </p>
                           </li>
                           <li>
                              <p>确定结束恢复的时间，SCN，还原点或日志序列。</p>
                              <p>您可以使用闪回查询功能来帮助您确定何时发生逻辑损坏。如果为表启用了<a href="glossary.html#GUID-2298E7F2-79F8-451F-B180-8A58300E29CB"><span class="xrefglossterm">闪回数据存档</span></a> ，则可以查询过去存在的数据。
                              </p>
                              <p>您还可以使用警报日志来尝试确定必须从中恢复的事件的时间。</p>
                              <p>或者，您可以使用SQL查询来确定包含目标SCN的日志序列号，然后通过此日志进行恢复。例如，运行以下查询以列出当前数据库中的日志（包括示例输出）：</p><pre class="oac_no_warn" dir="ltr">SELECT RECID，STAMP，THREAD＃，SEQUENCE＃，FIRST_CHANGE＃FIRST_TIME，NEXT_CHANGE＃FROM V $ ARCHIVED_LOG WHERE RESETLOGS_CHANGE＃=（SELECT RESETLOGS_CHANGE＃FROM V $ DATABASE_INCARNATION WHERE STATUS ='CURRENT'）; RECID STAMP THREAD＃SEQUENCE＃FIRST_CHAN FIRST_TIM NEXT_CHANG ---------- ---------- ---------- ----------- --------- --------- ---------- 1 344890611 1 1 20037 24-SEP-13 20043 2 344890615 1 2 20043 24-SEP-13 20045 3 344890618 1 3 20045 24-SEP-13 20046</pre><p>例如，如果您发现用户在上午9:02意外删除了表空间，那么您可以在发生丢弃之前恢复到上午9点。在此时间之后，您将丢失对数据库所做的所有更改。</p>
                           </li>
                           <li>
                              <p>如果使用目标时间表达式而不是目标SCN，请在调用RMAN之前确保时间格式环境变量是合适的。</p>
                              <p>以下是全球化支持设置示例：</p><pre class="oac_no_warn" dir="ltr">NLS_LANG = american_america.us7ascii NLS_DATE_FORMAT =“Mon DD YYYY HH24：MI：SS”</pre></li>
                           <li>
                              <p>将RMAN连接到目标数据库，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。如果适用，请连接到恢复目录。
                              </p>
                           </li>
                           <li>
                              <p>使用以下命令将数据库置于已装入状态：</p><pre class="oac_no_warn" dir="ltr">立即关闭;启动安装;</pre></li>
                           <li>
                              <p>在<code class="codeph">RUN</code>块中执行以下操作：</p>
                              <ol type="a">
                                 <li>
                                    <p>对于DBPITR，使用<code class="codeph">SET UNTIL</code>指定目标时间，SCN或日志序列号，或使用<code class="codeph">SET TO</code>指定还原点。如果指定时间，则使用<code class="codeph">NLS_LANG</code>和<code class="codeph">NLS_DATE_FORMAT</code>环境变量中指定的日期格式。
                                    </p>
                                 </li>
                                 <li>
                                    <p>如果未配置自动通道，则根据需要手动分配磁盘和磁带通道。</p>
                                 </li>
                                 <li>
                                    <p>还原并恢复数据库。</p>
                                 </li>
                              </ol>
                              <p>以下示例在目标数据库上执行DBPITR，直到SCN 1000：</p><pre class="oac_no_warn" dir="ltr">RUN {SET UNTIL SCN 1000; RESTORE DATABASE;恢复数据库; }</pre><p>如以下示例所示，您还可以使用时间表达式，还原点或日志序列号来指定<code class="codeph">SET UNTIL</code>时间：</p><pre class="oac_no_warn" dir="ltr">SET UNTIL TIME'Nov 15 2013 09:00:00'; SET UNTIL SEQUENCE 9923;设置为恢复点before_update;</pre><p>如果操作完成且没有错误，则DBPITR已成功完成。</p>
                           </li>
                           <li id="GUID-5B964EB6-B498-4A0D-B480-5C6E0BACFA5D__CHDDBIJB">
                              <p>执行以下任一互斥操作：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>打开数据库进行读/写，放弃目标SCN之后的所有更改。在这种情况下，您必须关闭数据库，装入它，然后执行以下命令：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre><p>如果数据文件脱机， <code class="codeph">OPEN RESETLOGS</code>操作将失败，除非数据文件正常脱机或为只读。您可以在<code class="codeph">RESETLOGS</code>之后将文件以只读或脱机正常表空间的形式联机，因为它们不需要任何重做。
                                    </p>
                                 </li>
                                 <li>
                                    <p>使用Data Pump Export从数据库导出一个或多个对象。然后，您可以将数据库恢复到当前时间点并重新导入导出的对象，从而将这些对象返回到不需要的更改之前的状态，而不会放弃所有其他更改。</p>
                                 </li>
                              </ul>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="BRADV804"></a><a id="BRADV640"></a><div class="props_rev_3"><a id="GUID-031D9695-A9D2-4381-A840-39BD3CC19946" name="GUID-031D9695-A9D2-4381-A840-39BD3CC19946"></a><h4 id="BRADV-GUID-031D9695-A9D2-4381-A840-39BD3CC19946" class="sect4"><span class="enumeration_section">18.5.3</span>执行CDB和PDB的时间点恢复</h4>
                  <div>
                     <p>使用<code class="codeph">RECOVER</code>命令执行容器数据库（CDB）和可插拔数据库（PDB）的时间点恢复（PITR）。PDB的PITR只能使用RMAN执行。</p>
                     <p></p>
                     <p>本章中包含的有关PITR的一般信息适用于本节及其小节中描述的差异的CDB。</p>
                     <div class="infoboxnote" id="GUID-031D9695-A9D2-4381-A840-39BD3CC19946__GUID-6775DBC1-2D35-436E-8195-B20E7FAC6A0D">
                        <p class="notep1">注意：</p>
                        <p>如果您没有使用恢复目录，建议您打开控制文件自动备份。否则，当RMAN需要撤消数据文件添加或删除时，PDB的PITR可能无法有效工作。</p>
                     </div>
                     <div class="infoboxnotealso" id="GUID-031D9695-A9D2-4381-A840-39BD3CC19946__GUID-D252EB85-844A-4B5E-A7CD-E945DD15C90B">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><a href="rman-performing-flashback-dbpitr.html#GUID-35D290AC-CC01-4984-93D6-AE41A3D0D3B6" title="RMAN为一个或多个PDB的时间点恢复提供支持。要恢复PDB，必须以具有SYSDBA或SYSBACKUP权限的用户身份连接到root。恢复后，PDB的旧备份仍然有效，并且可以在发生介质故障时使用。">PDB时间点恢复的基本概念</a></p>
                           </li>
                           <li>
                              <p><a href="rman-performing-flashback-dbpitr.html#GUID-7572C8E9-05B8-4BCC-823F-BD6763C51B11" title="使用RESTORE和RECOVER命令为整个CDB执行时间点恢复。">执行整个CDB的时间点恢复</a></p>
                           </li>
                           <li>
                              <p><a href="rman-performing-flashback-dbpitr.html#GUID-26CD7EC8-12AC-4073-BB8D-A68502112E48" title="将一个或多个PDB恢复到指定的时间点时，CDB中的其余PDB不会受到影响，并且可以打开并运行。">执行PDB的时间点恢复</a></p>
                           </li>
                        </ul>
                     </div>
                  </div><a id="BRADV806"></a><a id="BRADV805"></a><div class="props_rev_3"><a id="GUID-7572C8E9-05B8-4BCC-823F-BD6763C51B11" name="GUID-7572C8E9-05B8-4BCC-823F-BD6763C51B11"></a><h5 id="BRADV-GUID-7572C8E9-05B8-4BCC-823F-BD6763C51B11" class="sect5"><span class="enumeration_section">18.5.3.1</span>执行整个CDB的时间点恢复</h5>
                     <div>
                        <p>使用<code class="codeph">RESTORE</code>和<code class="codeph">RECOVER</code>命令为整个CDB执行时间点恢复。</p>
                        <div class="section">
                           <p><span class="bold">要执行整个CDB的时间点恢复：</span></p>
                        </div>
                        <!-- class="section" -->
                        <ol>
                           <li class="stepexpand"><span>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="Certain prerequisites must be met to perform database point-in-time recovery (DBPITR).">数据库时间点恢复</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="必须满足某些先决条件才能执行数据库时间点恢复（DBPITR）。">先决条件</a></span> 。</span></li>
                           <li class="stepexpand"><span>确定结束恢复的时间，SCN，还原点或日志序列。</span><div>
                                 <p>您可以使用闪回查询功能来帮助您确定何时发生逻辑损坏。如果为表启用了<a href="glossary.html#GUID-2298E7F2-79F8-451F-B180-8A58300E29CB"><span class="xrefglossterm">闪回数据存档</span></a> ，则可以查询过去存在的数据。
                                 </p>
                                 <p>您还可以使用警报日志来尝试确定必须从中恢复的事件的时间。</p>
                                 <p>或者，您可以使用SQL查询来确定包含目标SCN的日志序列号，然后通过此日志进行恢复。例如，运行以下查询以列出当前数据库中的日志（包括示例输出）：</p><pre class="oac_no_warn" dir="ltr">SELECT RECID，STAMP，THREAD＃，SEQUENCE＃，FIRST_CHANGE＃FIRST_TIME，NEXT_CHANGE＃FROM V $ ARCHIVED_LOG WHERE RESETLOGS_CHANGE＃=（SELECT RESETLOGS_CHANGE＃FROM V $ DATABASE_INCARNATION WHERE STATUS ='CURRENT'）; RECID STAMP THREAD＃SEQUENCE＃FIRST_CHAN FIRST_TIM NEXT_CHANG ---------- ---------- ---------- ----------- --------- --------- ---------- 1 344890611 1 1 20037 24-SEP-13 20043 2 344890615 1 2 20043 24-SEP-13 20045 3 344890618 1 3 20045 24-SEP-13 20046</pre><p>例如，如果您发现用户在上午9:02意外删除了表空间，那么您可以在发生丢弃之前恢复到上午9点。在此时间之后，您将丢失对数据库所做的所有更改。</p>
                              </div>
                           </li>
                           <li class="stepexpand"><span>如果使用目标时间表达式而不是目标SCN，请在调用RMAN之前确保时间格式环境变量是合适的。</span><div>
                                 <p>以下是全球化支持设置示例：</p><pre class="oac_no_warn" dir="ltr">NLS_LANG = american_america.us7ascii NLS_DATE_FORMAT =“Mon DD YYYY HH24：MI：SS”</pre></div>
                           </li>
                           <li class="stepexpand"><span>使用<code class="codeph">SYSBACKUP</code>或<code class="codeph">SYSDBA</code>权限将RMAN作为公共用户连接到根，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-43239E2D-0AFD-455D-89AB-87EDBC0E497D" title="有几种方法可以将目标连接到根目录。">将目标连接到根目录</a> ”中所述</span> 。如果适用，请连接到恢复目录。</span></li>
                           <li class="stepexpand"><span>将CDB置于已安装状态。</span><div><pre class="oac_no_warn" dir="ltr">立即关闭;启动安装;</pre></div>
                           </li>
                           <li class="stepexpand"><span>在<code class="codeph">RUN</code>块中执行以下操作：</span><ol type="a">
                                 <li><span>对于DBPITR，使用<code class="codeph">SET</code> <code class="codeph">UNTIL</code>指定目标时间，SCN或日志序列号，或使用<code class="codeph">SET</code> <code class="codeph">TO</code>指定还原点。如果指定时间，则使用<code class="codeph">NLS_LANG</code>和<code class="codeph">NLS_DATE_FORMAT</code>环境变量中指定的日期格式。</span></li>
                                 <li><span>如果未配置自动通道，则根据需要手动分配磁盘和磁带通道。</span></li>
                                 <li><span>恢复并恢复CDB。</span></li>
                              </ol>
                              <div>
                                 <p>以下示例在目标CDB上执行DBPITR，直到SCN 1000：</p><pre class="oac_no_warn" dir="ltr">RUN {SET UNTIL SCN 1000; RESTORE DATABASE;恢复数据库; }</pre><p>如以下示例所示，您还可以使用时间表达式，还原点或日志序列号来指定<code class="codeph">SET</code> <code class="codeph">UNTIL</code>时间：</p><pre class="oac_no_warn" dir="ltr">SET UNTIL TIME'Nov 15 2013 09:00:00'; SET UNTIL SEQUENCE 9923;设置为恢复点before_update;</pre><p>如果操作完成且没有错误，则DBPITR已成功完成。</p>
                              </div>
                           </li>
                           <li class="stepexpand"><span>执行以下任一互斥操作：</span><div>
                                 <ul style="list-style-type:disc">
                                    <li>
                                       <p>打开您的CDB进行读/写，放弃目标SCN之后的所有更改。在这种情况下，您必须关闭CDB，装入它，然后执行以下命令：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre><p>如果数据文件脱机， <code class="codeph">OPEN RESETLOGS</code>操作将失败，除非数据文件正常脱机或为只读。您可以在<code class="codeph">RESETLOGS</code>之后将文件以只读或脱机正常表空间的形式联机，因为它们不需要任何重做。
                                       </p>
                                    </li>
                                    <li>
                                       <p>使用Data Pump Export从CDB导出一个或多个对象。然后，您可以将CDB恢复到当前时间点并重新导入导出的对象，从而将这些对象返回到不需要的更改之前的状态，而不会放弃所有其他更改。</p>
                                    </li>
                                 </ul>
                              </div>
                           </li>
                           <li class="stepexpand"><span>打开所有PDB。</span><div>
                                 <p>打开CDB时不打开PDB。连接到<a href="glossary.html#GUID-EA3DB8F4-F68E-4FC5-A599-32A4886FFF8A"><span class="xrefglossterm">根目录时</span></a> ，以下命令将打开所有PDB。
                                 </p><pre class="oac_no_warn" dir="ltr">ALTER PLUGGABLE DATABASE ALL OPEN;</pre><p>您可以单独打开每个PDB。</p>
                              </div>
                           </li>
                        </ol>
                     </div>
                  </div><a id="BRADV644"></a><a id="BRADV807"></a><div class="props_rev_3"><a id="GUID-26CD7EC8-12AC-4073-BB8D-A68502112E48" name="GUID-26CD7EC8-12AC-4073-BB8D-A68502112E48"></a><h5 id="BRADV-GUID-26CD7EC8-12AC-4073-BB8D-A68502112E48" class="sect5"><span class="enumeration_section">18.5.3.2</span>执行PDB的时间点恢复</h5>
                     <div>
                        <p>将一个或多个PDB恢复到指定的时间点时，CDB中的其余PDB不会受到影响，并且可以打开并运行。</p>
                        <div class="section">
                           <p>在使用共享撤消的CDB中的一个或多个PDB上执行DBPITR时，需要备份根和包含PDB的CDB的CDB种子（ <code class="codeph">PDB$SEED</code> ）。
                           </p>
                           <p>从Oracle Database 12 <span class="italic">c</span>第2版（12.2）开始，如果<code class="codeph">COMPATIBLE</code>初始化参数设置为12.2.0或更高，则可以跨PDB闪回操作或PDB PITR为CDB执行闪回数据库。</p>
                           <p><span class="bold">要在PDB上执行DBPITR：</span></p>
                        </div>
                        <!-- class="section" -->
                        <ol>
                           <li class="stepexpand"><span>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="Certain prerequisites must be met to perform database point-in-time recovery (DBPITR).">数据库时间点恢复</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="必须满足某些先决条件才能执行数据库时间点恢复（DBPITR）。">先决条件</a></span> 。</span></li>
                           <li class="stepexpand"><span>确定结束恢复的时间，SCN，还原点或日志序列。</span><div>使用闪回查询或警报日志来确定何时发生logicla损坏。或者，使用SQL查询来确定包含目标SCN的日志序列号，然后通过此日志进行恢复。</div>
                           </li>
                           <li class="stepexpand"><span>如果使用目标时间表达式而不是目标SCN，请在调用RMAN之前确保时间格式环境变量是合适的。</span><div>
                                 <p>以下是全球化支持设置示例：</p><pre class="oac_no_warn" dir="ltr">NLS_LANG = american_america.us7ascii NLS_DATE_FORMAT =“Mon DD YYYY HH24：MI：SS”</pre></div>
                           </li>
                           <li class="stepexpand"><span>将RMAN作为具有<code class="codeph">SYSDBA</code>或<code class="codeph">SYSBACKUP</code>权限的公共用户连接到根，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-B397ADD8-D9CF-4DDA-B6AC-8C5FF04447AD" title="您可以将RMAN客户端连接到多租户容器数据库（CDB）和可插拔数据库（PDB）。">使RMAN连接到CDB</a> ”中所述</span> 。如果适用，请连接到恢复目录。</span></li>
                           <li class="stepexpand"><span>关闭正在恢复的PDB。其他PDB和CDB可以保持开放。</span><div><pre class="oac_no_warn" dir="ltr">ALTER PLUGGABLE DATABASE pdb1 CLOSE;</pre></div>
                           </li>
                           <li class="stepexpand"><span>在<code class="codeph">RUN</code>块中执行以下操作：</span><ol type="a">
                                 <li><span>对于DBPITR，使用<code class="codeph">SET</code> <code class="codeph">UNTIL</code>指定目标时间，SCN或日志序列号，或使用<code class="codeph">SET</code> <code class="codeph">TO</code>指定还原点。如果指定时间，则使用<code class="codeph">NLS_LANG</code>和<code class="codeph">NLS_DATE_FORMAT</code>环境变量中指定的日期格式。</span></li>
                                 <li><span>如果未配置自动通道，则根据需要手动分配磁盘和磁带通道。</span></li>
                                 <li><span>恢复并恢复CDB。</span></li>
                              </ol>
                              <div>
                                 <p>以下示例在PDB <code class="codeph">my_pdb</code>上执行DBPITR，直到SCN 1000：</p><pre class="oac_no_warn" dir="ltr">RUN {SET UNTIL SCN 1000; RESTORE PLUGGABLE DATABASE my_pdb; RECOVER PLUGGABLE DATABASE my_pdb; }</pre><p>如果操作完成且没有错误，则DBPITR已成功完成。</p>
                              </div>
                           </li>
                           <li class="stepexpand"><span>打开PDB，放弃目标SCN之后的所有更改。</span><div>
                                 <p>以下示例打开名为<code class="codeph">my_pdb</code>的PDB。
                                 </p><pre class="oac_no_warn" dir="ltr">ALTER PLUGGABLE DATABASE my_pdb OPEN RESETLOGS;</pre></div>
                           </li>
                        </ol>
                        <div class="example" id="GUID-26CD7EC8-12AC-4073-BB8D-A68502112E48__GUID-1B85A9D7-662E-4936-B45C-93C454BD7D70">
                           <p class="titleinexample">示例18-4将PDB恢复到指定的时间点</p>
                           <p>此示例将名为<code class="codeph">PDB5</code>的PDB恢复到SCN 1066，然后将其打开以进行读/写访问。使用<code class="codeph">SYSDBA</code>或<code class="codeph">SYSBACKUP</code>权限以普通用户身份连接到root，并输入以下命令：</p><pre class="oac_no_warn" dir="ltr">ALTER PLUGGABLE DATABASE pdb5 CLOSE;运行{SET UNTIL SCN 1066; RESTORE PLUGGABLE DATABASE pdb5; RECOVER PLUGGABLE DATABASE pdb5; ALTER PLUGGABLE DATABASE pdb5 OPEN RESETLOGS;</pre><p>此示例假定正在使用<a href="glossary.html#GUID-6E3CDD76-A573-4E5C-B12D-59C232C96C19"><span class="xrefglossterm">快速恢复区域</span></a> 。如果不使用快速恢复区域，则必须使用<code class="codeph">AUXILIARY DESTINATION</code>子句指定辅助集文件的临时位置。
                           </p>
                           <p>使用<code class="codeph">RESETLOGS</code>打开PDB会创建一个新的PDB版本。您可以在<code class="codeph">V$PDB_INCARNATION</code>视图中查询化身编号。
                           </p>
                           <div class="infoboxnotealso" id="GUID-26CD7EC8-12AC-4073-BB8D-A68502112E48__GUID-C028DC0C-B9DA-401E-BC3E-749D08534F57">
                              <p class="notep1">也可以看看：</p>
                              <p><span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-35D290AC-CC01-4984-93D6-AE41A3D0D3B6" title="RMAN为一个或多个PDB的时间点恢复提供支持。要恢复PDB，必须以具有SYSDBA或SYSBACKUP权限的用户身份连接到root。恢复后，PDB的旧备份仍然有效，并且可以在发生介质故障时使用。">PDB的时间点恢复的基本概念</a> ”，</span>用于获取有关PDB时间点恢复期间快速恢复区域使用的信息</p>
                           </div>
                        </div>
                        <!-- class="example" -->
                     </div>
                  </div>
               </div>
               <div class="sect3"><a id="GUID-1414BF57-1CBF-4BE6-A4C1-2521B3CF8B5F" name="GUID-1414BF57-1CBF-4BE6-A4C1-2521B3CF8B5F"></a><h4 id="BRADV-GUID-1414BF57-1CBF-4BE6-A4C1-2521B3CF8B5F" class="sect4"><span class="enumeration_section">18.5.4</span>执行应用程序PDB的时间点恢复</h4>
                  <div>
                     <p>使用<code class="codeph">RESTORE</code>和<code class="codeph">RECOVER</code>命令执行应用程序PDB的时间点恢复。</p>
                     <div class="p">
                        <p></p>
                     </div>
                     <!-- class="section" -->
                     <div class="p">CDB的<code class="codeph">COMPATIBLE</code>参数必须设置为12.2或更高。
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p><span class="bold">要执行应用程序PDB的时间点恢复：</span></p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>确保满足时间点恢复的先决条件。</span></li>
                        <li class="stepexpand"><span>启动RMAN并以具有<code class="codeph">SYSDBA</code>或<code class="codeph">SYSBACKUP</code>权限的应用程序通用用户身份连接到<a href="glossary.html#GUID-CC9EB948-16BC-4AB6-A05E-08EEAFCDD05F"><span class="xrefglossterm">应用程序根目录</span></a> 。</span><div>应用程序根目录有自己的服务名称，您可以使用与连接到PDB相同的方式连接到应用程序根目录。</div>
                        </li>
                        <li class="stepexpand"><span>确定结束恢复的时间，SCN，还原点或日志序列。</span></li>
                        <li class="stepexpand"><span>关闭必须恢复的<a href="glossary.html#GUID-6E2F65AE-C36C-446D-84D7-4F709C7DEBCE"><span class="xrefglossterm">应用程序PDB</span></a> 。</span><div>
                              <p>以下命令关闭名为<code class="codeph">hr_appcont_pdb1</code>的应用程序PDB。
                              </p><pre class="pre codeblock"><code>ALTER PLUGGABLE DATABASE hr_appcont_pdb1关闭;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>在<code class="codeph">RUN</code>块中执行以下操作：</span><ol type="a">
                              <li><span>使用<code class="codeph">SET UNTIL</code>指定目标时间，SCN或日志序列号，或使用<code class="codeph">SET TO</code>指定还原点。如果指定时间，则使用<code class="codeph">NLS_LANG</code>和<code class="codeph">NLS_DATE_FORMAT</code>环境变量中指定的日期格式。</span></li>
                              <li><span>如果未配置自动通道，则根据需要手动分配磁盘和磁带通道。</span></li>
                              <li><span>还原并恢复应用程序容器。</span></li>
                           </ol>
                           <div><pre class="pre codeblock"><code>RUN {SET UNTIL SCN 34506; RESTORE PLUGGABLE DATABASE hr_appcont_pdb1; RECOVER PLUGGABLE DATABASE hr_appcont_pdb1; }</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>使用<code class="codeph">RESETLOGS</code>打开应用程序PDB。这导致目标SCN被放弃后的所有更改。</span><div><pre class="pre codeblock"><code>ALTER PLUGGABLE DATABASE hr_appcont_pdb1 OPEN RESETLOGS;</code></pre></div>
                        </li>
                     </ol>
                     <div class="section">
                        <div class="infoboxnotealso" id="GUID-1414BF57-1CBF-4BE6-A4C1-2521B3CF8B5F__GUID-AA791871-6730-46C5-BE1A-FF3F3C0029A1">
                           <p class="notep1">也可以看看：</p>
                           <p><a href="starting-interacting-with-rman-client.html#GUID-B397ADD8-D9CF-4DDA-B6AC-8C5FF04447AD" title="您可以将RMAN客户端连接到多租户容器数据库（CDB）和可插拔数据库（PDB）。">与CDB建立RMAN连接</a></p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
               <div class="sect3"><a id="GUID-AB0D518A-4959-4714-AD88-01518969A939" name="GUID-AB0D518A-4959-4714-AD88-01518969A939"></a><h4 id="BRADV-GUID-AB0D518A-4959-4714-AD88-01518969A939" class="sect4"><span class="enumeration_section">18.5.5</span>执行稀疏数据库的时间点恢复</h4>
                  <div>
                     <p>执行稀疏数据库的时间点恢复与执行普通数据库的时间点恢复类似。</p>
                     <p>确保要恢复的数据库的<code class="codeph">COMPATIBLE</code>初始化参数设置为12.2或更高。
                     </p>
                     <div class="infoboxnote" id="GUID-AB0D518A-4959-4714-AD88-01518969A939__GUID-F231B9FF-FEC3-48A2-9943-20C1F99EA7F8">
                        <p class="notep1">注意：</p>
                        <p>稀疏数据库中的基本（只读）数据文件未加密。确保基础数据文件存储在受保护的存储中，并使用安全通信进行访问。</p>
                     </div>
                     <p><span class="bold">要执行稀疏数据库的时间点恢复：</span></p>
                     <ol>
                        <li>
                           <p>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="Certain prerequisites must be met to perform database point-in-time recovery (DBPITR).">数据库时间点恢复</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="必须满足某些先决条件才能执行数据库时间点恢复（DBPITR）。">先决条件</a></span> 。
                           </p>
                        </li>
                        <li>
                           <p>确定结束恢复的时间，SCN，还原点或日志序列。</p>
                           <p>您可以使用闪回查询功能来帮助您确定何时发生逻辑损坏。如果为表启用了<a href="glossary.html#GUID-2298E7F2-79F8-451F-B180-8A58300E29CB"><span class="xrefglossterm">闪回数据存档</span></a> ，则可以查询过去存在的数据。
                           </p>
                           <p>您还可以使用警报日志来尝试确定必须从中恢复的事件的时间。</p>
                           <p>或者，您可以使用SQL查询来确定包含目标SCN的日志序列号，然后通过此日志进行恢复。例如，运行以下查询以列出当前数据库中的日志（包括示例输出）：</p><pre class="oac_no_warn" dir="ltr">SELECT RECID，STAMP，THREAD＃，SEQUENCE＃，FIRST_CHANGE＃FIRST_TIME，NEXT_CHANGE＃FROM V $ ARCHIVED_LOG WHERE RESETLOGS_CHANGE＃=（SELECT RESETLOGS_CHANGE＃FROM V $ DATABASE_INCARNATION WHERE STATUS ='CURRENT'）; RECID STAMP THREAD＃SEQUENCE＃FIRST_CHAN FIRST_TIM NEXT_CHANG ---------- ---------- ---------- ----------- --------- --------- ---------- 1 344890611 1 1 20037 24-SEP-13 20043 2 344890615 1 2 20043 24-SEP-13 20045 3 344890618 1 3 20045 24-SEP-13 20046</pre><p>例如，如果您发现用户在上午9:02意外删除了表空间，那么您可以在发生丢弃之前恢复到上午9点。在此时间之后，您将丢失对数据库所做的所有更改。</p>
                        </li>
                        <li>
                           <p>如果使用目标时间表达式而不是目标SCN，请在调用RMAN之前确保时间格式环境变量是合适的。</p>
                           <p>以下是全球化支持设置示例：</p><pre class="oac_no_warn" dir="ltr">NLS_LANG = american_america.us7ascii NLS_DATE_FORMAT =“Mon DD YYYY HH24：MI：SS”</pre></li>
                        <li>
                           <p>将RMAN连接到目标数据库以及恢复目录数据库（如果适用），如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。
                           </p>
                        </li>
                        <li>
                           <p>将数据库置于已装入状态。</p><pre class="oac_no_warn" dir="ltr">立即关闭;启动安装;</pre><p>如果操作完成且没有错误，则DBPITR已成功完成。</p>
                        </li>
                        <li>
                           <div class="p">在<code class="codeph">RUN</code>块中执行以下操作：<ol type="a">
                                 <li>
                                    <p>对于DBPITR，使用<code class="codeph">SET</code> <code class="codeph">UNTIL</code>指定目标时间，SCN或日志序列号，或使用<code class="codeph">SET</code> <code class="codeph">TO</code>指定还原点。如果指定时间，则使用<code class="codeph">NLS_LANG</code>和<code class="codeph">NLS_DATE_FORMAT</code>环境变量中指定的日期格式。
                                    </p>
                                 </li>
                                 <li>
                                    <p>如果未配置自动通道，则根据需要手动分配磁盘和磁带通道。</p>
                                 </li>
                                 <li>
                                    <p>使用<code class="codeph">FROM SPARSE</code>选项还原和恢复稀疏数据库。
                                    </p>
                                    <p>以下示例为稀疏数据库执行时间点恢复，直到SCN <code class="codeph">2775080</code> ：</p><pre class="pre codeblock"><code>RUN {SET UNTIL SCN 2775080;从SPARSE DATABASE恢复;恢复数据库; }</code></pre></li>
                              </ol>
                           </div>
                        </li>
                        <li>
                           <div class="p">执行以下任一互斥操作：<ul style="list-style-type:disc">
                                 <li>
                                    <p>打开数据库进行读/写，放弃目标SCN之后的所有更改。在这种情况下，您必须关闭数据库，装入它，然后执行以下命令：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre><p>如果数据文件脱机， <code class="codeph">OPEN RESETLOGS</code>操作将失败，除非数据文件正常脱机或为只读。您可以在<code class="codeph">RESETLOGS</code>之后将文件以只读或脱机正常表空间的形式联机，因为它们不需要任何重做。
                                    </p>
                                 </li>
                                 <li>
                                    <p>使用Data Pump Export从数据库导出一个或多个对象。然后，您可以将数据库恢复到当前时间点并重新导入导出的对象，从而将这些对象返回到不需要的更改之前的状态，而不会放弃所有其他更改。</p>
                                 </li>
                              </ul>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div>
            </div><a id="BRADV89755"></a><div class="props_rev_3"><a id="GUID-F9C8CB5E-5954-4114-99D0-D121BA616058" name="GUID-F9C8CB5E-5954-4114-99D0-D121BA616058"></a><h3 id="BRADV-GUID-F9C8CB5E-5954-4114-99D0-D121BA616058" class="sect3"><span class="enumeration_section">18.6</span>闪回和数据库时间点恢复方案</h3>
               <div>
                  <p>本节介绍基本闪回数据库和DBPITR方案的变体。</p>
                  <p>本节包含以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-7E39909E-E2D5-4D08-ADD8-0D5FEF028489" title="闪回数据库可用于撤消OPEN RESETLOGS操作。">使用闪回数据库重新打开OPEN RESETLOGS操作</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-CECE183D-C000-485A-99DA-371768A79011" title="您可以使用闪回数据库将数据库回滚到废弃的数据库化身。">将数据库重绕到废弃的化身分支中的SCN</a></p>
                     </li>
                     <li>
                        <p><a href="rman-performing-flashback-dbpitr.html#GUID-F1818201-98E5-4B70-BDFE-A61AB84397E6" title="要将DPITR执行到非当前数据库化身，必须显式执行RESET DATABASE以将数据库重置为目标SCN上当前的化身。您还必须从包含目标SCN的数据库化身中还原控制文件。">将数据库恢复为祖先的化身</a></p>
                     </li>
                  </ul>
               </div><a id="BRADV347"></a><a id="BRADV85442"></a><div class="props_rev_3"><a id="GUID-7E39909E-E2D5-4D08-ADD8-0D5FEF028489" name="GUID-7E39909E-E2D5-4D08-ADD8-0D5FEF028489"></a><h4 id="BRADV-GUID-7E39909E-E2D5-4D08-ADD8-0D5FEF028489" class="sect4"><span class="enumeration_section">18.6.1</span>使用闪回数据库重新打开OPEN RESETLOGS操作</h4>
                  <div>
                     <p>闪回数据库可用于撤消<code class="codeph">OPEN RESETLOGS</code>操作。
                     </p>
                     <div class="section">
                        <p>使用闪回数据库来反转不需要的<code class="codeph">ALTER DATABASE OPEN RESETLOGS</code>语句的过程类似于<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-3EB4D790-77C7-49CB-8D96-0940394E6BC8" title="闪回数据库操作使用FLASHBACK DATABASE命令将数据库回滚到过去的某个时间点。">执行闪回数据库操作</a> ”中</span>描述的一般情况。但是，不是为<code class="codeph">FLASHBACK DATABASE</code>命令指定特定的SCN或时间点，而是<code class="codeph">FLASHBACK DATABASE TO BEFORE RESETLOGS</code>使用<code class="codeph">FLASHBACK DATABASE TO BEFORE RESETLOGS</code> 。</p>
                        <p><span class="bold">要撤消<code class="codeph">OPEN RESETLOGS</code>操作：</span></p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>将SQL * Plus连接到目标数据库，并验证闪回窗口的开头是否早于最近的<code class="codeph">OPEN RESETLOGS</code> 。</span><div>
                              <p>运行以下查询：</p><pre class="oac_no_warn" dir="ltr">SELECT RESETLOGS_CHANGE＃FROM V $ DATABASE; SELECT OLDEST_FLASHBACK_SCN FROM V $ FLASHBACK_DATABASE_LOG;</pre><p>如果<code class="codeph">V$DATABASE.RESETLOGS_CHANGE#</code>大于<code class="codeph">V$FLASHBACK_DATABASE_LOG.OLDEST_FLASHBACK_SCN</code> ，则可以使用闪回数据库来反转<code class="codeph">OPEN RESETLOGS</code>操作。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>关闭数据库，安装它，然后重新检查闪回窗口。如果重置日志SCN仍在闪回窗口内，则继续执行下一步。</span></li>
                        <li class="stepexpand"><span>将RMAN连接到目标数据库，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。</span></li>
                        <li class="stepexpand"><span>在<code class="codeph">RESETLOGS</code>之前立即执行闪回SCN。</span><div>
                              <p>使用以下形式的<code class="codeph">FLASHBACK DATABASE</code>命令：</p><pre class="oac_no_warn" dir="ltr">重置之前的FLASHBACK数据库;</pre><p>与<code class="codeph">FLASHBACK DATABASE</code>其他用法一样，如果目标SCN位于闪回数据库窗口的开头之前，则会返回错误并且不会修改数据库。如果命令成功完成，则数据库将保持挂载并恢复到上一个版本中<code class="codeph">OPEN RESETLOGS</code>操作之前的最新SCN。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>在SQL * Plus中以只读方式打开数据库，并根据需要执行查询，以确保已反转逻辑损坏的影响。</span><div>
                              <p>以如下方式打开数据库只读：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN READ ONLY;</pre></div>
                        </li>
                        <li class="stepexpand"><span>要使数据库再次可用于更新，请关闭数据库，装入它，然后执行以下命令：</span><div><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre></div>
                        </li>
                     </ol>
                  </div><a id="BRADV89757"></a><div class="props_rev_3"><a id="GUID-FFA88389-D132-48BA-9BB6-CAEED6CDA228" name="GUID-FFA88389-D132-48BA-9BB6-CAEED6CDA228"></a><h5 id="BRADV-GUID-FFA88389-D132-48BA-9BB6-CAEED6CDA228" class="sect5"><span class="enumeration_section">18.6.1.1</span>关于使用闪回数据库撤消备用数据库上的OPEN RESETLOGS</h5>
                     <div>
                        <p>跨<code class="codeph">OPEN RESETLOGS</code>闪回数据库可用于在Data Guard环境中执行多个功能。
                        </p>
                        <p>这包括以下内容：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>闪回以撤消逻辑备用切换</p>
                              <p>在这种情况下，数据库将在闪回数据库操作的目标时间恢复为其角色（主要或备用）。</p>
                           </li>
                           <li>
                              <p>撤消物理备用激活</p>
                              <p>您可以临时激活物理备用数据库，将其用于测试或报告目的，然后使用闪回数据库将其恢复为物理备用数据库的角色。</p>
                           </li>
                           <li>
                              <p>正在使用备用数据库进行测试</p>
                              <p>使用闪回数据库意味着您不需要使用存储快照。</p>
                           </li>
                        </ul>
                        <div class="infoboxnotealso" id="GUID-FFA88389-D132-48BA-9BB6-CAEED6CDA228__GUID-F49D6FC3-3FA9-4B5A-8873-7BA30607B1B0">
                           <p class="notep1">也可以看看：</p>
                           <p>有关使用Data Guard的闪回数据库的这些高级应用程序的详细信息，请参阅<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/bradv&amp;id=SBYDB00717" target="_blank"><span><cite>Oracle Data Guard概念和管理</cite></span></a></p>
                        </div>
                     </div>
                  </div>
               </div><a id="BRADV348"></a><a id="BRADV89758"></a><div class="props_rev_3"><a id="GUID-CECE183D-C000-485A-99DA-371768A79011" name="GUID-CECE183D-C000-485A-99DA-371768A79011"></a><h4 id="BRADV-GUID-CECE183D-C000-485A-99DA-371768A79011" class="sect4"><span class="enumeration_section">18.6.2</span>将数据库<span class="enumeration_section">复制</span>到废弃的化身分支中的SCN</h4>
                  <div>
                     <p>您可以使用闪回数据库将数据库回滚到废弃的数据库化身。</p>
                     <div class="section">
                        <p>闪回数据库或DBPITR后跟<code class="codeph">OPEN RESETLOGS</code>操作的作用是将数据库返回到先前的SCN，并在此之后放弃更改。因此，此后的某些SCN可以引用已放弃的更改或数据库当前历史记录的更改。以这种方式，在<code class="codeph">FLASHBACK DATABASE</code>指定的目标SCN可能是不明确的。
                        </p>
                        <p>与SCN不同，时间表达式和还原点不是模糊的。时间表达式始终与当时最新的化身相关联。还原点始终与创建时的当前化身相关联。即使对于与废弃的数据库化身相对应的时间和还原点也是如此。数据库化身将自动重置为在指定时间或创建还原点时当前的化身。</p>
                        <p>您可能希望使用闪回数据库将数据库倒回到父级化身中的SCN，该父级化身晚于<code class="codeph">OPEN RESETLOGS</code>操作的SCN，当前化身路径从旧化身分支。<a href="rman-data-repair-concepts.html#GUID-EC2E2F24-0AD3-486D-9289-407E7F1F5C9C__CHDCJGGD">图14-1</a>显示了即使在<code class="codeph">OPEN RESETLOGS</code>操作创建新的化身后，如何在化身分支中生成SCN。如图所示，当您必须返回到化身1中的废弃SCN 1500时，数据库可能处于化身3中的SCN 3000。
                        </p>
                        <p>如果要重绕的SCN位于<a href="glossary.html#GUID-9FA6E4CA-C9C0-47E8-8FDF-2C2A313F8944"><span class="xrefglossterm">直接祖先路径中</span></a> ，或者您要将数据库倒回到<a href="glossary.html#GUID-A5A5E7B1-72B6-4F50-8E11-04C03EB5FFAE"><span class="xrefglossterm">还原点</span></a> ，则闪回数据库不需要显式的<code class="codeph">RESET DATABASE</code>命令。但是，当您使用<code class="codeph">FLASHBACK DATABASE</code>将数据库回滚到已放弃的数据库版本中的SCN时，需要显式的<code class="codeph">RESET DATABASE TO INCARNATION</code>命令。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CECE183D-C000-485A-99DA-371768A79011__GUID-0DA5EE26-05F4-40BC-8741-1E1391A50FFC">要将数据库回滚到废弃的化身分支中的SCN：</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>使用SQL * Plus连接到目标数据库，并验证闪回日志是否包含足够的信息以闪回到SCN。</span><div>
                              <p>例如，执行以下查询：</p><pre class="oac_no_warn" dir="ltr">SELECT OLDEST_FLASHBACK_SCN FROM V $ FLASHBACK_DATABASE_LOG;</pre></div>
                        </li>
                        <li class="stepexpand"><span>确定闪回数据库操作的目标化身编号，即父化身的化身键。</span><div>
                              <p>例如，执行以下查询：</p><pre class="oac_no_warn" dir="ltr">SELECT PRIOR_INCARNATION＃FROM V $ DATABASE_INCARNATION WHERE STATUS ='CURRENT';</pre></div>
                        </li>
                        <li class="stepexpand"><span>启动RMAN并连接到目标数据库，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。</span></li>
                        <li class="stepexpand"><span>关闭数据库，然后按如下方式安装它：</span><div><pre class="oac_no_warn" dir="ltr">立即关闭;启动安装;</pre></div>
                        </li>
                        <li class="stepexpand"><span>将数据库化身设置为父化身。</span><div>
                              <p>例如，使用以下命令返回到化身1：</p><pre class="oac_no_warn" dir="ltr">将数据库重置为INCARNATION 1;</pre></div>
                        </li>
                        <li class="stepexpand"><span>运行<code class="codeph">FLASHBACK DATABASE</code>命令，指定目标SCN。</span><div>
                              <p>例如，使用以下命令将数据库回滚到SCN 1500：</p><pre class="oac_no_warn" dir="ltr">FLASHBACK数据库到SCN 1500;</pre></div>
                        </li>
                        <li class="stepexpand"><span>在SQL * Plus中以只读方式打开数据库，并根据需要执行查询，以确保已反转逻辑损坏的影响。</span><div>
                              <p>以如下方式打开数据库只读：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN READ ONLY;</pre></div>
                        </li>
                        <li class="stepexpand"><span>要使数据库再次可用于更新，请关闭数据库，装入它，然后执行以下命令：</span><div><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre></div>
                        </li>
                     </ol>
                     <div class="section">
                        <div class="infoboxnotealso" id="GUID-CECE183D-C000-485A-99DA-371768A79011__GUID-6FA70F22-A044-4401-899F-599067B7B5BF">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><span class="q">“ <a href="rman-data-repair-concepts.html#GUID-9942AC94-A35D-4A06-9A45-A5A43B82B23D" title="只要使用RESETLOGS选项打开数据库，就会创建数据库化身。">关于数据库化身</a> ”</span>有关数据库化身，废弃的更改以及<code class="codeph">ALTER DATABASE OPEN RESETLOGS</code>的效果的有用背景信息 
                                 </p>
                              </li>
                              <li>
                                 <p>有关<code class="codeph">RESET DATABASE</code>命令的详细信息，请<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/bradv&amp;id=RCMRF148" target="_blank"><span><cite>参见Oracle数据库备份和恢复参考</cite></span></a></p>
                              </li>
                           </ul>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="BRADV349"></a><a id="BRADV84153"></a><div class="props_rev_3"><a id="GUID-F1818201-98E5-4B70-BDFE-A61AB84397E6" name="GUID-F1818201-98E5-4B70-BDFE-A61AB84397E6"></a><h4 id="BRADV-GUID-F1818201-98E5-4B70-BDFE-A61AB84397E6" class="sect4"><span class="enumeration_section">18.6.3</span>将数据库恢复为祖先的化身</h4>
                  <div>
                     <p>要将DPITR执行到非当前数据库化身，必须显式执行<code class="codeph">RESET DATABASE</code>以将数据库重置为目标SCN上当前的化身。您还必须从包含目标SCN的数据库化身中还原控制文件。</p>
                     <div class="section">
                        <p>当RMAN连接到恢复目录时， <code class="codeph">RESTORE CONTROLFILE</code>命令仅在当前数据库化身中搜索<code class="codeph">UNTIL</code>子句中指定的最近时间。要从非当前版本恢复控制文件，必须执行<code class="codeph">LIST INCARNATION</code>以标识目标数据库版本，并在<code class="codeph">RESET DATABASE TO INCARNATION</code>命令中指定此版本。
                        </p>
                        <p>当RMAN未连接到恢复目录时，您无法在装入数据库之前执行<code class="codeph">RESET DATABASE TO INCARNATION</code>命令。因此，您必须执行<code class="codeph">SET UNTIL</code> ，从自动备份恢复控制文件，然后安装它。
                        </p>
                        <p>假设以下情况：</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <ul style="list-style-type:disc">
                           <li>
                              <p>RMAN已连接到恢复目录。</p>
                           </li>
                           <li>
                              <p>您从2013年10月2日起备份了目标数据库<code class="codeph">trgt</code> 。
                              </p>
                           </li>
                           <li>
                              <p>DBPITR于2013年10月10日在此数据库上执行，以更正先前的错误。在DBPITR开始新的化身后， <code class="codeph">OPEN</code> <code class="codeph">RESETLOGS</code>操作。
                              </p>
                           </li>
                        </ul>
                        <p>10月25日，您发现需要在2013年10月8日上午8:00从数据库中删除的关键数据。这一次是在当前化身开始之前。</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p><span class="bold">要将DBPITR执行到非当前的化身：</span></p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>确保满足<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="Certain prerequisites must be met to perform database point-in-time recovery (DBPITR).">数据库时间点恢复</a></span>的先决条件”中描述的<span class="q"><a href="rman-performing-flashback-dbpitr.html#GUID-2CF6EEFB-0344-4FD6-9BBB-F2D241172BC6" title="必须满足某些先决条件才能执行数据库时间点恢复（DBPITR）。">先决条件</a></span> 。</span></li>
                        <li class="stepexpand"><span>如果需要，启动RMAN并连接到目标数据库和恢复目录，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。</span></li>
                        <li class="stepexpand"><span>确定备份时哪个数据库化身是最新的。</span><div>
                              <p>使用<code class="codeph">LIST INCARNATION</code>查找目标时间当前的化身的主键：</p><pre class="oac_no_warn" dir="ltr">列出数据库trgt;数据库化身列表DB Key Inc密钥DB名称DB ID STATUS复位SCN复位时间------- ------- ------- ------ ------ -  ---------- ---------- 1 2 TRGT 1224038686 PARENT 1 02-OCT-13 1 582 TRGT 1224038686 CURRENT 59727 10-OCT-13</pre><p>查看“ <code class="codeph">Reset SCN</code>和“ <code class="codeph">Reset Time</code>列以确定正确的化身，并记下“ <code class="codeph">Inc</code> <code class="codeph">Key</code>列中的化身键。在此示例中，备份是在2013年10月2日完成的。在这种情况下，化身键值为2。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>确保数据库已启动但未装入。</span><div><pre class="oac_no_warn" dir="ltr">STARTUP FORCE NOMOUNT;</pre></div>
                        </li>
                        <li class="stepexpand"><span>将目标数据库重置为在步骤2中获得的化身。</span><div>
                              <p>在此示例中，指定10月2日备份时的化身当前状态。使用<code class="codeph">Inc Key</code>列中的值来标识化身。
                              </p><pre class="oac_no_warn" dir="ltr">将数据库重置为INCARNATION 2;</pre></div>
                        </li>
                        <li class="stepexpand"><span>恢复并恢复数据库，在<code class="codeph">RUN</code>命令中执行以下操作：</span><div>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>将恢复的结束时间设置为丢失数据之前的时间。</p>
                                 </li>
                                 <li>
                                    <p>分配未配置的任何所需通道。</p>
                                 </li>
                                 <li>
                                    <p>从10月2日备份恢复控制文件并安装它。</p>
                                 </li>
                                 <li>
                                    <p>恢复数据文件并恢复数据库。使用<code class="codeph">RECOVER DATABASE ...UNTIL</code>命令执行DBPITR，将数据库带到10月8日上午7:55的目标时间，就在数据丢失之前。
                                    </p>
                                 </li>
                              </ul>
                              <p>以下示例显示了此案例中所需的所有步骤：</p><pre class="oac_no_warn" dir="ltr">RUN {SET UNTIL TIME'2013年10月8日07:55:00'; RESTORE CONTROLFILE; ＃没有恢复目录，使用RESTORE CONTROLFILE FROM AUTOBACKUP ALTER DATABASE MOUNT; RESTORE DATABASE;恢复数据库; ALTER DATABASE OPEN RESETLOGS;</pre><div class="infoboxnotealso" id="GUID-F1818201-98E5-4B70-BDFE-A61AB84397E6__GUID-13F6CB08-29CA-40C5-86AF-1279D7FE6D81">
                                 <p class="notep1">也可以看看：</p>
                                 <p>有关<code class="codeph">RESET DATABASE</code>命令的详细信息，请<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/bradv&amp;id=RCMRF148" target="_blank"><span><cite>参见Oracle数据库备份和恢复参考</cite></span></a></p>
                              </div>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>