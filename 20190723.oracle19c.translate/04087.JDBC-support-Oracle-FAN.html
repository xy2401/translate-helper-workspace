<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <title>对FAN事件的Oracle JDBC支持</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="JDBC Developer&#39;s Guide"></meta>
      <meta property="og:description" content=""></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="JDBC Developer&#39;s Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="jdbc-developers-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-02-13T13:20:37-08:00"></meta>
      <meta name="dcterms.title" content="JDBC Developer&#39;s Guide"></meta>
      <meta name="dcterms.dateCopyrighted" content="1999, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96471-02"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="application-continuity.html" title="Previous" type="text/html"></link>
      <link rel="next" href="transparent-application-failover.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="JJDBC"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="application-continuity.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="transparent-application-failover.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">JDBC开发人员指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="high-availablility.html" property="item" typeof="WebPage"><span property="name">高可用性</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">对FAN事件的Oracle JDBC支持</li>
            </ol>
            <a id="GUID-54252C2F-FFEE-4B9D-844B-0AAA3492D57C" name="GUID-54252C2F-FFEE-4B9D-844B-0AAA3492D57C"></a>
            
            <h2 id="JJDBC-GUID-54252C2F-FFEE-4B9D-844B-0AAA3492D57C" class="sect2"><span class="enumeration_chapter">30</span> FAN事件的Oracle JDBC支持</h2>
         </header>
         <div class="ind">
            <div>
               <p>从Oracle Database 12 <span class="italic">c</span>第2版（12.2.0.1）开始，Oracle JDBC驱动程序支持Oracle RAC快速应用程序通知（FAN）事件，用于计划内和计划外中断。这有助于第三方连接池利用Oracle RAC功能实现高可用性。不使用Oracle通用连接池（UCP）或WebLogic Server的Java应用程序现在可以利用此支持。例如，Oracle RAC服务器端的滚动升级等方案不会在应用程序中导致JDBC错误。
               </p>
               <div class="infoboxnote" id="GUID-54252C2F-FFEE-4B9D-844B-0AAA3492D57C__GUID-43C44712-8C36-46F5-9782-62C13414D312">
                  <p class="notep1">注意：</p>
                  <p>虽然Oracle JDBC驱动程序现在支持FAN事件，但Oracle UCP为所有FAN事件提供了更全面的支持。</p>
               </div>
               <div class="infoboxnotealso" id="GUID-54252C2F-FFEE-4B9D-844B-0AAA3492D57C__GUID-54013444-A9D6-4402-8D58-D843C78AB726">
                  <p class="notep1">也可以看看：</p>
                  <p><a href="../jjucp/fast-connection-failover.html#JJUCP-GUID-126F8C9B-C0B3-426B-B07D-4B127BBDD867" target="_blank"><span><cite>Oracle通用连接池开发人员指南</cite></span></a></p>
               </div>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="JDBC-support-Oracle-FAN.html#GUID-FA7C92EE-6AA3-4F32-B60D-4558A6F27020">Oracle JDBC对FAN事件的支持概述</a></p>
                  </li>
                  <li>
                     <p><a href="JDBC-support-Oracle-FAN.html#GUID-5C6B8DF7-8542-4533-9D68-0D2E6D1ACDA9">计划维护的安全排水API</a></p>
                  </li>
                  <li>
                     <p><a href="JDBC-support-Oracle-FAN.html#GUID-069265AF-BBEE-4682-9906-98D8429BFC1C">安装和配置用于FAN事件支持的Oracle JDBC驱动程序</a></p>
                  </li>
               </ul>
            </div>
            <div class="sect2"><a id="GUID-FA7C92EE-6AA3-4F32-B60D-4558A6F27020" name="GUID-FA7C92EE-6AA3-4F32-B60D-4558A6F27020"></a><h3 id="JJDBC-GUID-FA7C92EE-6AA3-4F32-B60D-4558A6F27020" class="sect3"><span class="enumeration_section">30.1</span> Oracle JDBC概述支持FAN事件</h3>
               <div>
                  <p></p>
                  <p>必须在单个实例数据库上使用Oracle RAC数据库或Oracle Restart才能使用此功能。此功能支持：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>计划维护</p>
                        <p>此案例涉及Oracle RAC服务器上的计划维护，可以正常关闭Oracle RAC服务。在这种情况下，来自连接池的借用或使用中的连接不会中断，只有在调用任何安全耗尽的API时才会关闭。例如，当应用程序完成此类连接的工作并将其返回到连接池时。</p>
                     </li>
                     <li>
                        <p>意外中断</p>
                        <p>在这种情况下，快速检测并中止死连接，从而切断网络连接以防止挂起。在这种情况下，借用和使用中的连接在意外中断期间中断。应用程序需要处理受影响连接上的任何异常，并自行执行必要的恢复，或使用Oracle高可用性解决方案（如应用程序连续性）。</p>
                     </li>
                  </ul>
               </div>
               <div>
                  <div class="relinfo">
                     <p><strong>相关话题</strong></p>
                     <ul>
                        <li><a href="application-continuity.html#GUID-AAC6F9B7-9B4C-4098-B0D5-312BF9A13928">Java的应用程序连续性</a></li>
                        <li><a href="JDBC-support-Oracle-FAN.html#GUID-5C6B8DF7-8542-4533-9D68-0D2E6D1ACDA9">计划维护的安全排水API</a></li>
                     </ul>
                  </div>
                  <div class="infoboxnotealso" id="GUID-FA7C92EE-6AA3-4F32-B60D-4558A6F27020__GUID-9CBF9B59-7C66-42FE-AAAC-BE765755E456">
                     <p class="notep1">也可以看看：</p>
                     <p>有关使用Oracle RAC的服务器端配置的<a href="../racad/converting-single-instance-oracle-databases-to-oracle-rac-and-oracle-rac-one-node.html#RACAD-GUID-CDCBB95C-59EA-4CA7-BDB6-11B3D114E397" target="_blank"><span><cite>Oracle Real Application Clusters管理和部署指南</cite></span></a> 。本章仅介绍在对FAN事件使用Oracle JDBC驱动程序支持时应用程序必须执行的客户端配置步骤。
                     </p>
                  </div>
               </div>
               
            </div>
            <div class="sect2"><a id="GUID-5C6B8DF7-8542-4533-9D68-0D2E6D1ACDA9" name="GUID-5C6B8DF7-8542-4533-9D68-0D2E6D1ACDA9"></a><h3 id="JJDBC-GUID-5C6B8DF7-8542-4533-9D68-0D2E6D1ACDA9" class="sect3"><span class="enumeration_section">30.2</span>计划维护的安全排水API</h3>
               <div>
                  <p></p>
                  <div class="section">
                     <p>对于计划的Oracle RAC维护，JDBC驱动程序支持安全耗尽API列表，这些API是与第三方Java连接池进行额外握手或集成工作所必需的。这些API用作<span class="italic">排放点</span> ，驱动程序可以安全地关闭受计划维护影响的任何连接，而不会导致应用程序可见错误。以下是驱动程序FAN支持的安全排放API列表：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><code class="codeph">java.sql中。Connection.isValid（int timeout）</code></p>
                        </li>
                        <li>
                           <p><code class="codeph">oracle.jdbc。OracleConnection.pingDatabase（）</code></p>
                        </li>
                        <li>
                           <p><code class="codeph">oracle.jdbc。OracleConnection.pingDatabase（int timeout）</code></p>
                        </li>
                        <li>
                           <p><code class="codeph">oracle.jdbc。OracleConnection.endRequest（）</code></p>
                        </li>
                        <li>
                           <p>所有标准JDBC和Oracle JDBC扩展<code class="codeph">EXECUTE***</code>调用<code class="codeph">Statement</code> ， <code class="codeph">PreparedStatement</code>和<code class="codeph">CallableStatement</code>接口</p>
                        </li>
                     </ul>
                     <p>对于标准JDBC和Oracle JDBC扩展<code class="codeph">EXECUTE***</code>调用，执行的SQL命令字符串必须包含以下SQL提示作为SQL字符串中的第一个非注释标记：</p><pre class="pre codeblock"><code>/ * + CLIENT_CONNECTION_VALIDATION * /</code></pre><p>合格的SQL被视为连接验证SQL。例如：</p><pre class="pre codeblock"><code>/ * + CLIENT_CONNECTION_VALIDATION * / SELECT 1 FROM DUAL</code></pre><p>通常，第三方连接池会调用这些API。预计在检测到与此类调用的任何错误连接时，第三方连接池将关闭并从池中删除相关连接，以便应用程序不会看到任何错误。当应用程序本身调用这些API时，预计应用程序正在主动验证底层连接，并将关闭并删除检测到的任何错误连接。</p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
            <div class="sect2"><a id="GUID-069265AF-BBEE-4682-9906-98D8429BFC1C" name="GUID-069265AF-BBEE-4682-9906-98D8429BFC1C"></a><h3 id="JJDBC-GUID-069265AF-BBEE-4682-9906-98D8429BFC1C" class="sect3"><span class="enumeration_section">30.3</span>安装和配置用于FAN事件支持的Oracle JDBC驱动程序</h3>
               <div>
                  <p></p>
                  <div class="section">
                     <p>Oracle JDBC驱动程序通过检查连接到的数据库服务器，以及除了Oracle JDBC驱动程序之外是否在应用程序环境中可用以下必需的JAR文件，自动确定是否为FAN事件启用Oracle JDBC支持：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><code class="codeph">simplefan.jar</code>和<code class="codeph">ons.jar</code>文件</p>
                           <p>您必须从以下链接安装12.3.0.1版本的<code class="codeph">simplefan.jar</code>和<code class="codeph">ons.jar</code>文件，并将它们包含在<code class="codeph">CLASSPATH</code> 。</p>
                           <p><a href="http://www.oracle.com/technetwork/database/application-development/jdbc/jdbc-ucp-122-3110062.html" target="_blank">http://www.oracle.com/technetwork/database/application-development/jdbc/jdbc-ucp-122-3110062.html</a></p>
                           <p>如果其中任何一个丢失，或者驱动程序无法加载，则禁用此功能。与第三方连接池一起使用时，这些JAR文件必须放在同一位置，连接池将在该位置检索并加载驱动程序JAR文件。</p>
                        </li>
                        <li>
                           <p>Oracle JDBC数据源</p>
                           <p>您可以使用相同的典型Oracle JDBC数据源，例如<code class="codeph">oracle.jdbc.pool.OracleDataSource</code>或<code class="codeph">oracle.jdbc.OracleDriver</code>用于获取JDBC连接。与第三方连接池一起使用时，应用程序必须将这些类指定为连接池的连接工厂。
                           </p>
                        </li>
                     </ul>
                     <p>想要显式禁用此功能的应用程序可以将<code class="codeph">oracle.jdbc.fanEnabled</code>属性设置为<code class="codeph">FALSE</code> 。此属性既可用作系统属性，也可用作连接属性。对于使用通用连接池（UCP）或WebLogic Server Active GridLink（AGL）的应用程序，默认情况下此属性设置为<code class="codeph">FALSE</code> 。否则，默认值为<code class="codeph">TRUE</code> 。</p>
                     <div class="infoboxnote" id="GUID-069265AF-BBEE-4682-9906-98D8429BFC1C__GUID-D4AD0BBD-F2BE-48EB-A8DC-9932FD0B3615">
                        <p class="notep1">注意：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>当JDBC驱动程序自动启用对FAN事件的支持时，如果在<code class="codeph">CLASSPATH</code>上同时存在<code class="codeph">simplefan.jar</code>和<code class="codeph">ons.jar</code>文件，则调用<code class="codeph">getConnection</code>方法可能会抛出异常，例如<code class="codeph">java.lang.IllegalArgumentException</code> 。为避免这种情况，您可以执行以下任一操作：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>从<code class="codeph">CLASSPATH</code>删除<code class="codeph">simplefan.jar</code>或<code class="codeph">ons.jar</code> 。</p>
                                 </li>
                                 <li>
                                    <p>将<code class="codeph">oracle.jdbc.fanEnabled</code>属性设置为<code class="codeph">FALSE</code>以显式禁用此功能。
                                    </p>
                                 </li>
                              </ul>
                           </li>
                           <li>
                              <p>将<code class="codeph">oracle.jdbc.fanEnabled</code>属性设置为<code class="codeph">TRUE</code>可能无法启用Oracle JDBC支持FAN事件功能，因为该功能也取决于其他因素。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <p>JDBC驱动程序需要对第三方连接池进行最少的配置更改或代码更改，以支持Oracle FAN事件。对于不需要任何配置更改或代码更改的连接池，假定它满足以下条件之一：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>该池有一个配置选项，用于在池结帐时验证JDBC连接。</p>
                        </li>
                        <li>
                           <p>该池使用<code class="codeph">javax.sql.PooledConnection</code>并具有用于插入<code class="codeph">javax.sql.的配置选项<code class="codeph">javax.sql.ConnectionPoolDataSource</code>实现。还假设这样的连接池能够在连接返回时检查关闭或坏的物理连接。
                           </p>
                        </li>
                     </ul>
                     <p>以下是一些第三方Java连接池上的一些连接验证选项。这些选项中的大多数都基于SQL，而不是基于验证API：</p>
                     <div class="tblformal" id="GUID-069265AF-BBEE-4682-9906-98D8429BFC1C__GUID-B9E1FD8E-FF16-4269-B1F7-D32BF7E77AEA">
                        <table cellpadding="4" cellspacing="0" class="Formal" title="" border="1" summary="Example of connection validation options on other Java connection pools" frame="hsides" rules="rows">
                           <thead>
                              <tr align="left" valign="top">
                                 <th align="left" valign="bottom" id="d78717e340">Java连接池</th>
                                 <th align="left" valign="bottom" id="d78717e343">连接验证选项</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" id="d78717e348" headers="d78717e340 ">
                                    <p>Oracle WebLogic Generic和MDS数据源</p>
                                 </td>
                                 <td align="left" valign="top" headers="d78717e348 d78717e343 ">
                                    <p><code class="codeph">TestConnectionsOnReserve</code> ， <code class="codeph">TestConnectionsOnRelease</code> ， <code class="codeph">TestConnectionsOnCreate</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" id="d78717e362" headers="d78717e340 ">
                                    <p>IBM WebSphere</p>
                                 </td>
                                 <td align="left" valign="top" headers="d78717e362 d78717e343 ">
                                    <p><code class="codeph">PreTest</code>连接</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" id="d78717e371" headers="d78717e340 ">
                                    <p>RedHat JBoss</p>
                                 </td>
                                 <td align="left" valign="top" headers="d78717e371 d78717e343 ">
                                    <p><code class="codeph">入住有效的连接，SQL</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" id="d78717e379" headers="d78717e340 ">
                                    <p>Apache TomCat</p>
                                 </td>
                                 <td align="left" valign="top" headers="d78717e379 d78717e343 ">
                                    <p><code class="codeph">TestonBorrow</code> ， <code class="codeph">TestonRelease</code></p>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                     <!-- class="inftblhruleinformal" -->
                     <p>当您对Oracle RAC服务器版本11 <span class="italic">g</span>使用Oracle JDBC支持FAN事件功能时，应用程序必须通过<code class="codeph">oracle.jdbc.fanONSConfig</code>系统属性为Oracle RAC FAN显式设置远程ONS配置字符串。该属性的值和格式与UCP快速连接故障转移（FCF）相同。
                     </p>
                     <div class="infoboxnotealso" id="GUID-069265AF-BBEE-4682-9906-98D8429BFC1C__GUID-132E6303-7A34-4648-8B9D-D010AFD1395B">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../jjucp/fast-connection-failover.html#JJUCP-GUID-C8D5FF91-6333-4E7F-BC81-CF7B93D56BEE" target="_blank">通用连接池开发人员指南</a></p>
                     </div>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
            <div class="sect2"><a id="GUID-EA53B96C-5A3E-43DE-A427-D7517AB749E0" name="GUID-EA53B96C-5A3E-43DE-A427-D7517AB749E0"></a><h3 id="JJDBC-GUID-EA53B96C-5A3E-43DE-A427-D7517AB749E0" class="sect3"><span class="enumeration_section">30.4</span> Oracle JDBC驱动程序FAN支持计划维护的示例</h3>
               <div>
                  <p></p>
                  <div class="section">
                     <p>以下示例说明了如何在Oracle RAC上通过计划维护启用和使用JDBC Oracle FAN支持。遵循这些说明后，应用程序在计划维护期间不应收到任何异常：</p>
                     <ol>
                        <li>
                           <p>将Oracle JDBC驱动程序升级到版本12.2.0.1以使用<code class="codeph">ojdbc8.jar</code>文件。
                           </p>
                        </li>
                        <li>
                           <p>安装并使用<code class="codeph">ons.jar</code>和<code class="codeph">simplefan.jar</code>文件的12.2.0.1版本。
                           </p>
                        </li>
                        <li>
                           <p>使用<code class="codeph">oracle.jdbc.pool.OracleDataSource</code>类用于获取物理连接或将此类配置为第三方Java连接池上的连接工厂。在后一种情况下，您必须设置启用连接验证的特定池属性。
                           </p>
                           <p>（可选）在针对Oracle RAC版本11 <span class="italic">g</span>运行时，请指定系统属性<code class="codeph">oracle.jdbc.fanONSConfig</code>以配置远程ONS。</p>
                        </li>
                        <li>
                           <p>应用程序一直运行，直到您准备好执行计划的维护活动，例如在Oracle RAC上滚动升级。在计划维护期间，对于基于使用模式的每个服务，DBA将使用扩展的12.2 <code class="codeph">srvctl</code>接口执行以下活动：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>重新定位或停止下一个要升级的实例上的服务，没有<code class="codeph">–f</code> （强制）</p>
                              </li>
                              <li>
                                 <p>等到驱动程序FAN将所有与此服务的连接耗尽</p>
                              </li>
                              <li>
                                 <p>达到超时后，使用定义的停止模式断开会话（建议使用事务）</p>
                              </li>
                              <li>
                                 <p>重新定位或停止所有服务后，请关闭实例并应用升级或修补程序</p>
                              </li>
                              <li>
                                 <p>重新启动实例并在服务停止时重新启动服务</p>
                              </li>
                              <li>
                                 <p>迭代直到升级/修补所有实例</p>
                              </li>
                           </ul>
                        </li>
                     </ol>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>