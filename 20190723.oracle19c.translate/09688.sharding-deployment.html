<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="Sharded database deployment includes the prerequisites and instructions for installing the required software components, creating the catalog, roles, and the sharded database, configuring replication for high availability, and creating the schema for the sharded database."></meta>
      <meta name="description" content="Sharded database deployment includes the prerequisites and instructions for installing the required software components, creating the catalog, roles, and the sharded database, configuring replication for high availability, and creating the schema for the sharded database."></meta>
      <title>Sharded数据库部署</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Using Oracle Sharding"></meta>
      <meta property="og:description" content="Sharded database deployment includes the prerequisites and instructions for installing the required software components, creating the catalog, roles, and the sharded database, configuring replication for high availability, and creating the schema for the sharded database."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Using Oracle Sharding"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="using-oracle-sharding.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-02-14T12:19:13-08:00"></meta>
      <meta name="dcterms.title" content="Using Oracle Sharding"></meta>
      <meta name="dcterms.dateCopyrighted" content="2018, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E87088-04"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="sharding-high-availability.html" title="Previous" type="text/html"></link>
      <link rel="next" href="sharding-loading-data.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="SHARD"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="sharding-high-availability.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="sharding-loading-data.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">使用Oracle Sharding</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Sharded数据库部署</li>
            </ol>
            <a id="GUID-F99B8742-4089-4E77-87D4-4691EA932207" name="GUID-F99B8742-4089-4E77-87D4-4691EA932207"></a>
            
            <h2 id="SHARD-GUID-F99B8742-4089-4E77-87D4-4691EA932207" class="sect2"><span class="enumeration_chapter">8</span> Sharded Database Deployment</h2>
         </header>
         <div class="ind">
            <div>
               <p>分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。</p>
               <p>以下主题包含部署分片数据库所需的概念和任务：</p>
            </div>
            <div>
               <ul class="ullinks">
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC">Sharded数据库部署简介</a><br>Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。
                  </li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-9EC92076-7DD0-41ED-9E0C-B96CF074118D">Oracle Sharding先决条件</a><br>在安装任何软件之前，请查看Oracle Sharding的这些硬件，网络和操作系统要求。
                  </li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-3F3A387E-FAC5-467C-A45E-4A7DFF95B62D">安装Oracle数据库软件</a><br>在将托管分片目录或数据库分片的每个系统上安装Oracle数据库。
                  </li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-E1F8A199-D0D2-4ABA-94EA-E314E83A966F">安装Shard Director软件</a><br>在要托管分片导向器的每个系统上安装全局服务管理器软件。
                  </li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-9A0F96A7-4D52-4B3A-8538-6DA2AB5A9BFB">创建分片目录数据库</a><br>使用DBCA创建Oracle数据库以托管分片目录。
                  </li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-96ABB404-844C-457E-9C10-2D5C352D3928">设置Oracle Sharding管理和路由层</a><br>必须将分片目录，分片控制器和分片配置为相互通信。
                  </li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-A2492CE2-A98C-4F59-9946-889FFD0FEBA9">创建和部署系统管理的分片数据库</a><br></li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-6E11AA09-B7D3-45FB-9693-33B1329F7396">创建和部署用户定义的SDB</a><br></li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-C43E1E4A-DA8F-4556-9EE7-39097C0276BC">创建和部署复合SDB</a><br>要部署复合SDB，您必须安装所需的Oracle Sharding软件组件，配置复合SDB的对象并创建架构。
                  </li>
                  <li class="ulchildlink"><a href="sharding-deployment.html#GUID-ACFBA061-F74B-4C31-9596-8BD7451846F3">在Oracle Sharding中使用透明数据加密</a><br>Oracle Sharding支持透明数据加密（TDE），但为了在启用TDE的分片数据库中成功移动块，所有分片必须共享并使用加密表空间的相同加密密钥。
                  </li>
               </ul>
            </div>
            
            <div class="sect2"><a id="GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" name="GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC"></a><h3 id="SHARD-GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" class="sect3"><span class="enumeration_section">8.1</span> Sharded数据库部署简介</h3>
               <div>
                  <p>Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。</p>
                  <p>分片数据库管理员定义拓扑（区域，分片主机，复制技术），并使用GDSCTL命令行界面使用声明性规范调用DEPLOY命令。</p>
                  <p>在较高级别，部署步骤是：</p>
                  <ol>
                     <li>
                        <p>设置组件。</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>创建承载分片目录的数据库。</p>
                           </li>
                           <li>
                              <p>在分片节点上安装Oracle数据库软件。</p>
                           </li>
                           <li>
                              <p>在分片导向器节点上安装shard director（GSM）软件。</p>
                           </li>
                        </ul>
                        <div class="infoboxnote" id="GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC__GUID-7A30118E-A5AD-4027-B657-D5958A8A6910">
                           <p class="notep1">注意：</p>对于生产部署，强烈建议您为分片目录数据库配置Data Guard。
                        </div>
                     </li>
                     <li>
                        <p>使用以下命令指定拓扑布局。</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">创建SHARDCATALOG</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">添加GSM</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">开始GSM</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">ADD CREDENTIAL</code> （如果使用<code class="codeph">CREATE SHARD</code> ）</p>
                           </li>
                           <li>
                              <p><code class="codeph">添加SHARDGROUP</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">添加INVITEDNODE</code></p>
                           </li>
                           <li>
                              <p>为每个分片<code class="codeph">CREATE SHARD</code> （或<code class="codeph">ADD SHARD</code> ）</p>
                           </li>
                        </ul>
                     </li>
                     <li>
                        <p>运行<code class="codeph">DEPLOY</code>并添加全局服务以访问分片数据库中的任何分片。
                        </p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">部署</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">添加服务</code></p>
                           </li>
                        </ul>
                     </li>
                  </ol>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-F9C2D239-0F1C-4805-A7FA-1D3D5EBC61FA">选择部署方法</a><br>您可以通过为新数据库同时创建分片来部署分片数据库，也可以通过从预先存在的数据库添加分片来部署分片数据库。
                     </li>
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365">将Oracle Multitenant与Oracle Sharding配合使用</a><br>您可以在Oracle Sharding配置中将包含可插拔数据库（PDB）的多租户容器数据库（CDB）用作分片和分片目录。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-F9C2D239-0F1C-4805-A7FA-1D3D5EBC61FA" name="GUID-F9C2D239-0F1C-4805-A7FA-1D3D5EBC61FA"></a><h4 id="SHARD-GUID-F9C2D239-0F1C-4805-A7FA-1D3D5EBC61FA" class="sect4"><span class="enumeration_section">8.1.1</span>选择部署方法</h4>
                  <div>
                     <p>您可以通过为新数据库同时创建分片来部署分片数据库，也可以通过从预先存在的数据库添加分片来部署分片数据库。</p>
                     <p>Oracle Sharding支持两种部署方法。第一种方法是使用<code class="codeph">CREATE SHARD</code>命令，其中分片的创建和复制配置由Oracle Sharding管理层自动完成。此方法不能用于将PDB用作分片的多租户架构。
                     </p>
                     <p>第二种部署方法是使用<code class="codeph">ADD SHARD</code>命令。如果您的数据库创建标准要求您使用自己预先创建的数据库部署SDB，则<code class="codeph">ADD SHARD</code>部署方法只需添加预先构建的数据库分片即可支持此要求。
                     </p>
                     <div class="section">
                        <p class="subhead3" id="GUID-F9C2D239-0F1C-4805-A7FA-1D3D5EBC61FA__GUID-F213B7D6-F513-471D-867D-D3A750344288">部署方法：CREATE SHARD</p>
                        <p><code class="codeph">DEPLOY</code>命令创建分片。这是使用<code class="codeph">DBMS_SCHEDULER</code>包（在分片目录上执行）完成的，该包与远程分片主机上的Scheduler代理进行通信。
                        </p>
                        <p>然后代理调用DBCA和NETCA，如果指定了Oracle GoldenGate复制，则使用GoldenGate Creation Assistance（GGCA）来创建分片和本地监听器。创建主分片后，使用RMAN <code class="codeph">DUPLICATE</code>命令构建相应的备用分片。
                        </p>
                        <p>当Data Guard用作高可用性解决方案时，一旦构建主分片和备用分片， <code class="codeph">DEPLOY</code>命令就会配置启用了快速启动故障转移（FSFO）的Data Guard Broker。FSFO观察员自动在区域分片导演上启动。
                        </p>
                        <div class="infoboxnote" id="GUID-F9C2D239-0F1C-4805-A7FA-1D3D5EBC61FA__GUID-78696CD0-5EBD-44AA-8BC8-A398302E149A">
                           <p class="notep1">注意：</p>
                           <p>用作分片的PDB不支持CREATE SHARD方法。只有ADD SHARD方法可用于多租户架构。</p>
                           <p>为所有分片启用Archivelog和闪回。这是FSFO观察者在故障转移时执行备用自动重新实现所必需的。</p>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-F9C2D239-0F1C-4805-A7FA-1D3D5EBC61FA__GUID-8CCEFB8E-E5E1-4302-ADE9-184BD428FCA8">部署方法：添加SHARD</p>
                        <p>如果您有自己的数据库创建标准，并且更喜欢使用自己预先创建的数据库部署分片数据库，请使用<code class="codeph">ADD SHARD</code>命令将分片添加到分片数据库配置。对于启用了Oracle RAC，启用Oracle Restart或PDB分片的分片，建议使用此方法。使用ASM时，建议使用此方法。<code class="codeph">ADD SHARD</code>部署方法通过添加已在其上部署数据库安装的分片而不是创建新实例来支持此要求。
                        </p>
                        <p>当<code class="codeph">ADD SHARD</code>命令用于部署，并且Data Guard用于高可用性时， <code class="codeph">DEPLOY</code>命令处理Oracle GoldenGate或Data Guard，Broker和快速启动故障转移的配置。它还处理您为要添加的分片预先配置Data Guard的情况。
                        </p>
                        <p>与使用Data Guard或Active Data Guard进行分片不同，您无法手动部署Oracle GoldenGate，必须使用<code class="codeph">DEPLOY</code>命令完成。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" title="Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。">Sharded Database Deployment简介</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
               <div class="sect3"><a id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365" name="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365"></a><h4 id="SHARD-GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365" class="sect4"><span class="enumeration_section">8.1.2</span>将Oracle Multitenant与Oracle Sharding结合使用</h4>
                  <div>
                     <p>您可以在Oracle Sharding配置中将包含可插拔数据库（PDB）的多租户容器数据库（CDB）用作分片和分片目录。</p>
                     <p>为了支持在未充分利用的硬件上合并数据库，为了便于管理或地理业务需求，您可以将CDB中的PDB用作数据库分片。例如，对于数据库合并，您可以将其他非分片或分片PDB添加到包含分片PDB的CDB。 CDB可以包含来自不同分片数据库的分片PDB，每个分片数据库都有自己独立的目录数据库。CDB可以支持来自不同分片数据库的多个PDB分片;但是，对于每个CDB，此支持仅限于给定分片数据库中的一个PDB分片。</p>
                     <p>要将分片PDB添加到分片数据库配置，应首先将包含该分片PDB的CDB添加到分片目录中。GDSCTL命令<code class="codeph">ADD CDB</code>用于将预先创建的CDB添加到分片目录。然后，使用带有<code class="codeph">-cdb</code>选项的GDSCTL <code class="codeph">ADD SHARD</code> SHARD命令在部署期间将作为CDB中包含的PDB的分片添加到分片数据库。
                     </p>
                     <p>以下示例将具有唯一名称db11的CDB添加到分片目录，然后将其添加到分片数据库配置中的shardgroup shgrp1。</p><pre class="pre codeblock"><code>GDSCTL&gt; add cdb -connect <span class="variable" translate="no">CDB$ROOT_connect_string</span> -pwd <span class="variable" translate="no">GSMROOTUSER_password</span> GDSCTL&gt; add shard -cdb db11 -connect <span class="variable" translate="no">PDB_connect_string</span> -shardgroup shgrp1 -deploy_as active_standby -pwd <span class="variable" translate="no">GSMUSER_password</span></code></pre><p>使用<code class="codeph">CONFIG CDB</code>在分片目录中显示有关CDB的信息。
                     </p><pre class="pre codeblock"><code>GDSCTL&gt; config cdb名称：tstsdbyb连接字符串：（DESCRIPTION =（ADDRESS =（PROTOCOL = tcp）（HOST = cdb1host）（PORT = 1521））（CONNECT_DATA =（SERVICE_NAME = cdb1.example.com）））SCAN地址：ONS远程端口：0磁盘阈值，ms：20 CPU阈值，％：75版本：18.0.0.0机架：</code></pre><div class="infoboxnote" id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365__GUID-9C0809ED-2610-4F33-8D94-314D23B90A27">
                        <p class="notep1">注意：</p>
                        <p>Oracle GoldenGate复制不支持将PDB作为分片。</p>
                     </div>
                     <div class="section">
                        <p class="subhead3" id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365__GUID-E007BD6B-C825-4AE9-805C-D02E8FE6564E">移动PDB碎片</p>
                        <p>您可以从CDB手动拔出碎片PDB，然后将其插入另一个CDB。这可以在分片界面之外完成，然后您可以更新分片目录元数据以指示PDB分片已移动到另一个CDB。带有<code class="codeph">–REPLACE</code>选项的GDSCTL命令<code class="codeph">ADD SHARD</code> <code class="codeph">–REPLACE</code>用于更新分片目录<code class="codeph">–REPLACE</code> PDB的位置。
                        </p>
                        <p>某些PDB操作（例如，使用SQL命令<code class="codeph">ALTER PLUGGABLE DATABASE UNPLUG</code>和<code class="codeph">ALTER PLUGGABLE DATABASE OPEN</code>将现有PDB拔出并插入同一CDB）不会导致注册更新事件。这可能意味着在重新插入后，分片PDB将不会在GDSCTL <code class="codeph">config shard</code>输出中显示为已注册。如果发生这种情况，可以通过连接到SQL * Plus中的PDB并使用<code class="codeph">SHUTDOWN</code>和<code class="codeph">STARTUP</code> SQL命令为PDB运行完全关闭和启动周期来强制注册事件。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365__GUID-D51A6040-45A1-4256-9793-05072D146FD1">PDB Shard高可用性</p>
                        <p>Oracle Data Guard仅支持CDB级别的复制。现有的分片架构允许分片数据的复制副本以实现高可用性，并且可以选择配置和使用Data Guard来创建和维护这些副本。Data Guard当前不支持PDB级别的复制;它只能复制整个容器。</p>
                        <p>如果选择将来自不同分片数据库的PDB分片添加到同一CDB中，则CDB中所有常驻分片数据库中的复制拓扑必须匹配。可以创建无效配置，其中分片数据库在每个Data Guard配置中配置了不同数量的备用PDB，因此您有责任通过验证PDB的数量和位置来确保不会发生此不匹配。每个分片数据库中的CDB。</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365__GUID-20B18EE4-0686-40A2-BCA8-DAAAFE36ACCC">在分片配置中对CDB进行更改</p>
                        <p>使用<code class="codeph">MODIFY CDB</code>更改分片目录中CDB的元数据。CDB包含分片或包含已部署的分片后，某些参数无法使用。
                        </p><pre class="pre codeblock"><code>GDSCTL&gt;修改cdb -shard cdb1 <span class="variable" translate="no">new_GSMROOTUSER_password</span></code></pre><p>使用<code class="codeph">REMOVE CDB</code>从分片目录中删除CDB。删除CDB不会破坏它。
                        </p><pre class="pre codeblock"><code>GDSCTL&gt;删除cdb -cdb cdb1</code></pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365__GUID-74654D0D-169C-47F2-A404-D398002E3CD7">从非PDB分片升级到PDB分片</p>
                        <p>从非PDB分片环境升级到使用PDB的环境时，必须备份每个现有的非PDB分片，然后在其中创建新的CDB和PDB。然后，如CDB迁移指南所建议的那样，该分片将恢复到CDB内的PDB。此时，分片已成为CDB中的PDB，您使用GDSCTL <code class="codeph">ADD CDB</code>命令添加新CDB，然后运行<code class="codeph">ADD SHARD -REPLACE</code> ，指定PDB的连接字符串，以告知分片基础结构用新的PDB位置替换分片的旧位置。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365__GUID-BEA18ECE-DAA9-4D37-854D-EFD34671EE11">数据库兼容性和迁移</p>
                        <p>从包含给定CDB的单个PDB分片的Oracle Database 18c安装升级时，必须更新任何PDB的分片目录元数据。具体地，在18c中，PDB分片的名称是其CDB的<span class="variable" translate="no">db_unique_name</span> ;但是，在Oracle Database 19c中，分<span class="variable" translate="no">db_unique_name_of_CDB</span> _ <span class="variable" translate="no">pdb_name</span> 。
                        </p>
                        <p>要更新目录元数据以反映这种新的命名方法，并且还支持<a href="sharding-lifecycle-management.html#GUID-506BB8D0-6150-4622-9F1B-34EA81B49745" title="GSMROOTUSER is a database account specific to Oracle Sharding that is only used when pluggable database (PDB) shards are present. The account is used by GDSCTL and global service managers to connect to the root container of container databases (CDBs) to perform administrative tasks.">关于</a> <code class="codeph">GSMROOTUSER</code>帐户中所述的新<a href="sharding-lifecycle-management.html#GUID-506BB8D0-6150-4622-9F1B-34EA81B49745" title="GSMROOTUSER是特定于Oracle Sharding的数据库帐户，仅在存在可插入数据库（PDB）分片时使用。GDSCTL和全局服务管理器使用该帐户连接到容器数据库（CDB）的根容器以执行管理任务。">GSMROOTUSER帐户</a> ，请在升级过程中执行以下步骤，如<a href="sharding-lifecycle-management.html#GUID-62AC31EB-2FEE-412B-9DF0-2C235BB32A2A" title="升级分片数据库组件的顺序对于限制停机时间和避免错误非常重要，因为组件已关闭并重新联机。">升级分片数据库组件中所述</a> 。
                        </p>
                        <ul id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365__UL_RGD_DMH_2GB" style="list-style-type:disc">
                           <li>升级包含PDB分片的任何CDB后，请确保GSMROOTUSER帐户存在，已解锁，已分配密码，并已被授予SYSDG，SYSBACKUP和gsmrootuser_role权限。SQL * Plus中的以下SQL语句将在连接到CDB的根容器（CDB $ ROOT）时成功设置GSMROOTUSER。<pre class="pre codeblock"><code>SQL&gt; alter session set“_oracle_script”= true;会话改变了。SQL&gt; create user gsmrootuser;用户创建。SQL&gt; alter user gsmrootuser由<span class="variable" translate="no">new_GSMROOTUSER_password</span>帐户解锁标识;用户改动了。SQL&gt; grant sysdg，sysbackup，gsmrootuser_role to gsmrootuser container = current;格兰特成功了。SQL&gt; alter session set“_oracle_script”= false;会话改变了。</code></pre></li>
                           <li>
                              <p>将目录数据库升级到所需的Oracle数据库版本后，运行以下PL / SQL过程以更新目录元数据以反映配置中存在的PDB分片的新名称。必须为每个Oracle Database 18c PDB分片执行此过程。</p>
                              <p><code class="codeph">pdb_fixup</code>的第一个参数是CDB中包含PDB分片的<code class="codeph">db_unique_name</code>的值。在Oracle Database 18c中，这与<code class="codeph">gdsctl config shard</code>所示的分<code class="codeph">gdsctl config shard</code>名称相同。
                              </p>
                              <p>第二个参数是分片PDB的PDB名称，如连接到分片PDB时由SQL * Plus中的<code class="codeph">show con_name</code>所示。</p>
                              <p><code class="codeph">pdb_fixup</code>过程将更新目录元数据，使其与PDB分片的新命名方法兼容。
                              </p><pre class="pre codeblock"><code>SQL&gt; connect sys / <span class="variable" translate="no">password</span> as sysdba已连接。SQL&gt;在SQL上设置serveroutput&gt;执行gsmadmin_internal.dbms_gsm_pooladmin.pdb_fixup（'cdb1'，'pdb1'）;</code></pre></li>
                           <li>将所有分片导向器升级到所需版本后，对配置中的每个CDB运行以下GDSCTL命令一次，以通知分片<code class="codeph">GSMROOTUSER</code>每个CDB中<code class="codeph">GSMROOTUSER</code>的密码。<pre class="pre codeblock"><code>GDSCTL&gt;修改cdb <span class="variable" translate="no">CDB_name</span> CDB_name <span class="variable" translate="no">new_GSMROOTUSER_password</span></code></pre></li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section"></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-4FFB5665-B925-4DB6-ACDD-807D6E699365__GUID-8D0DA0DF-A547-4CC7-88BD-D9AB70F6FBF9">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../gsmug/release-changes.html#GSMUG-GUID-98E3FE17-E87D-4ED8-9C64-30D1D527DDC3" target="_blank"><span><cite>“Oracle数据库全局数据服务概念和管理指南”，</cite></span></a>以获取有关与PDB分片一起使用的GDSCTL命令的信息</p>
                        <p>有关Oracle Multitenant的信息的<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=MULTI-GUID-A1F3A63E-3BE5-4B80-A053-46D9EF71D45E" target="_blank"><span><cite>Oracle Multitenant管理员指南</cite></span></a></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" title="Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。">Sharded Database Deployment简介</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
            <div class="sect2"><a id="GUID-9EC92076-7DD0-41ED-9E0C-B96CF074118D" name="GUID-9EC92076-7DD0-41ED-9E0C-B96CF074118D"></a><h3 id="SHARD-GUID-9EC92076-7DD0-41ED-9E0C-B96CF074118D" class="sect3"><span class="enumeration_section">8.2</span> Oracle Sharding先决条件</h3>
               <div>
                  <p>在安装任何软件之前，请查看Oracle Sharding的这些硬件，网络和操作系统要求。</p>
                  <div class="section">
                     <ul style="list-style-type:disc">
                        <li>
                           <p>分片的硬件和操作系统要求与支持Oracle数据库的要求相同。有关这些要求，请参阅Oracle数据库安装文档。</p>
                        </li>
                        <li>
                           <p>分片目录和分片导向器的硬件，软件和操作系统要求与支持全局数据服务目录和全局服务管理器的要求相同。有关这些要求，请参阅<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=GSMUG-GUID-B7010949-4EAE-4AB1-A136-D5A4CD2AE688" target="_blank"><span><cite>Oracle数据库全局数据服务概念和管理指南</cite></span></a> 。
                           </p>
                        </li>
                        <li>
                           <p>网络要求是低延迟GigE</p>
                        </li>
                        <li>
                           <p>端口通信要求如下所列。使用CREATE SHARD需要以下所有内容。使用ADD SHARD时，第4项和第5项无关。</p>
                           <ol>
                              <li>
                                 <p>每个碎片必须能够到达每个碎片导演的侦听器和ONS端口。分片导向器的默认侦听器端口为1522，大多数平台上的默认ONS端口为本地ONS的6123和远程ONS的6234。这些分片导向器侦听器端口和ONS端口也必须打开到应用程序/客户端层，所有分片，分片目录和所有其他分片导向器。</p>
                              </li>
                              <li>
                                 <p>每个分片必须能够到达分片目录的TNS监听器端口（主要和备用）。</p>
                              </li>
                              <li>
                                 <p>必须为每个分片的TNS侦听器端口（默认为1521）打开分片导向器和分片目录。</p>
                              </li>
                              <li>
                                 <p>在主<code class="codeph">-agent_port</code>目录数据库和备用分片目录数据库中， <code class="codeph">CREATE SHARDCATALOG</code>命令中用于<code class="codeph">-agent_port</code> （缺省<code class="codeph">-agent_port</code> 8080）的端口必须对所有分片可见。
                                 </p>
                              </li>
                              <li>
                                 <p>所有分片上的调度程序代理端口必须对分片目录节点可见。在每个分<code class="codeph">schagent -status</code>上执行<code class="codeph">schagent -status</code>以标识端口。
                                 </p>
                              </li>
                           </ol>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div>
               <div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
            </div>
            <div class="sect2"><a id="GUID-3F3A387E-FAC5-467C-A45E-4A7DFF95B62D" name="GUID-3F3A387E-FAC5-467C-A45E-4A7DFF95B62D"></a><h3 id="SHARD-GUID-3F3A387E-FAC5-467C-A45E-4A7DFF95B62D" class="sect3"><span class="enumeration_section">8.3</span>安装Oracle数据库软件</h3>
               <div>
                  <p>在将托管分片目录或数据库分片的每个系统上安装Oracle数据库。</p>
                  <div class="p">
                     <p>在安装Oracle数据库之前，在将托管分片数据库，分片目录和分片导向器的所有系统上创建操作系统用户，并将它们分配给DBA组。允许用户运行<code class="codeph">su</code> ，并记下凭据，以便您可以在以后的过程中使用它们。
                     </p>
                     <p>有关配置操作系统用户的信息，请参见“ <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=LADBI-GUID-B65E6113-D056-4DD9-940F-DFF493E413D5" target="_blank"><span><cite>Oracle数据库安装指南（适用于Linux</cite></span></a> ）”或平台的安装指南。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <ol>
                     <li><span>在将托管分片目录或数据库分片的所有系统上下载Oracle数据库安装程序。</span></li>
                     <li><span>在要承载分片目录和分片数据库的所有系统上安装Oracle数据库。</span><ol type="a">
                           <li class="substepexpand"><span>在第一个系统上运行安装程序。</span><div><pre class="pre codeblock"><code>$ cd / u01 / stage / database $ ./runInstaller</code></pre><p>在逐步完成Oracle数据库安装时，请务必在所提及的屏幕上选择以下选项：</p>
                                 <ul style="list-style-type:disc">
                                    <li>
                                       <p>在“安装选项”页面上，选择“ <span class="uicontrol bold">仅安装数据库软件”</span> 。
                                       </p>
                                    </li>
                                    <li>
                                       <p>在“网格安装选项”页面上，选择“ <span class="uicontrol bold">单实例数据库安装”</span> 。此版本不支持Oracle RAC和Oracle RAC One Node。
                                       </p>
                                    </li>
                                    <li>
                                       <p>在Database Edition页面上，选择<span class="uicontrol bold">Enterprise Edition</span> 。
                                       </p>
                                    </li>
                                    <li>
                                       <p>在“安装位置”页面上，使用在上述步骤中创建环境脚本时使用的相同<span class="uicontrol bold">Oracle基础</span>和<span class="uicontrol bold">软件位置</span>值。
                                       </p>
                                    </li>
                                    <li>
                                       <p>在“创建库存”页面上，接受默认值。</p>
                                    </li>
                                    <li>
                                       <p>在“操作系统组”页面上，接受默认值或根据您的环境进行适当的更改。</p>
                                    </li>
                                    <li>
                                       <p>在“摘要”页面上，可以单击“ <span class="uicontrol bold">保存响应文件”</span>以在其余主机上创建用于静默安装Oracle数据库软件的文件。
                                       </p>
                                    </li>
                                    <li>
                                       <p>在安装过程中，出现提示时，以<code class="codeph">root</code>身份在单独的终端中执行<code class="codeph">orainstRoot.sh</code>和<code class="codeph">root.sh</code>脚本。
                                       </p>
                                    </li>
                                 </ul>
                              </div>
                           </li>
                           <li class="substepexpand"><span>（可选）使用您在第一次安装中创建的响应文件，在每个剩余主机上运行静默安装。</span><div>
                                 <p>请注意，在使用响应文件执行静默安装后，当您运行数据库<code class="codeph">root.sh</code>脚本时，它的执行可能不会以交互方式提示您输入任何值，并且仅使用默认值（例如，对于本地用户<code class="codeph">bin</code>目录）。如果需要任何非默认值，请在调用安装程序时仅指定<code class="codeph">-responseFile</code>位置并省略<code class="codeph">-silent</code>选项。单击安装程序屏幕，接受响应文件值，然后在出现提示时运行根脚本。在根脚本执行期间，会向您显示任何用户提示，并且可以输入非默认值。
                                 </p>
                              </div>
                           </li>
                        </ol>
                     </li>
                  </ol>
                  <div class="section"></div>
                  <!-- class="section" -->
               </div>
               <div>
                  <div class="infoboxnotealso" id="GUID-3F3A387E-FAC5-467C-A45E-4A7DFF95B62D__GUID-ECA079BF-D17D-4C39-AEE7-5A6FD9AC57D5">
                     <p class="notep1">也可以看看：</p>
                     <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=LADBI-GUID-D53355E9-E901-4224-9A2A-B882070EDDF7" target="_blank"><span><cite>适用于Linux的Oracle数据库安装指南，</cite></span></a>了解有关使用响应文件进行Oracle数据库静默安装的更多信息</p>
                  </div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
            </div>
            <div class="sect2"><a id="GUID-E1F8A199-D0D2-4ABA-94EA-E314E83A966F" name="GUID-E1F8A199-D0D2-4ABA-94EA-E314E83A966F"></a><h3 id="SHARD-GUID-E1F8A199-D0D2-4ABA-94EA-E314E83A966F" class="sect3"><span class="enumeration_section">8.4</span>安装Shard Director软件</h3>
               <div>
                  <p>在要托管分片导向器的每个系统上安装全局服务管理器软件。</p>
                  <ol>
                     <li class="stepexpand"><span>在将托管分片导向器的所有系统上下载Oracle Global Service Manager安装程序。</span></li>
                     <li class="stepexpand"><span>有关安装全局服务管理器的信息，请参阅“ <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=GSMUG-GUID-04D33448-2CB4-40C7-9DA0-1CFC6EC5E101" target="_blank"><span><cite>Oracle数据库全局数据服务概念和管理指南”</cite></span></a> 。</span></li>
                     <li class="stepexpand"><span>（可选）使用您在第一次安装中创建的响应文件，在每个剩余的分片导向器主机上运行静默安装。</span><div>
                           <p>有关静默安装过程的详细信息，请参阅“ <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=GSMUG-GUID-C03F39F9-576F-48B7-892B-2636F423BF21" target="_blank"><span><cite>Oracle数据库全局数据服务概念和管理指南”</cite></span></a> 。
                           </p>
                           <p>请注意，在使用响应文件执行静默安装后，当您运行数据库<code class="codeph">root.sh</code>脚本时，它的执行可能不会以交互方式提示您输入任何值，并且仅使用默认值（例如，对于本地用户<code class="codeph">bin</code>目录）。如果需要任何非默认值，请在调用安装程序时仅指定<code class="codeph">-responseFile</code>位置并省略<code class="codeph">-silent</code>选项。单击安装程序屏幕，接受响应文件值，然后在出现提示时运行根脚本。在根脚本执行期间，会向您显示任何用户提示，并且可以输入非默认值。
                           </p>
                        </div>
                     </li>
                  </ol>
               </div>
               <div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
            </div>
            <div class="sect2"><a id="GUID-9A0F96A7-4D52-4B3A-8538-6DA2AB5A9BFB" name="GUID-9A0F96A7-4D52-4B3A-8538-6DA2AB5A9BFB"></a><h3 id="SHARD-GUID-9A0F96A7-4D52-4B3A-8538-6DA2AB5A9BFB" class="sect3"><span class="enumeration_section">8.5</span>创建分片目录数据库</h3>
               <div>
                  <p>使用DBCA创建Oracle数据库以托管分片目录。</p>
                  <ol>
                     <li class="stepexpand"><span>连接到将托管分片目录的主机，并验证预期的环境变量是否设置为正确的值。</span><div><pre class="pre codeblock"><code>$ env | grep ORA ORACLE_BASE = / u01 / app / oracle ORACLE_HOME = / u01 / app / oracle / product / 18.0.0 / dbhome_1</code></pre></div>
                     </li>
                     <li class="stepexpand"><span>创建oradata和fast_recovery_area目录。</span><div><pre class="pre codeblock"><code>$ mkdir / u01 / app / oracle / oradata $ mkdir / u01 / app / oracle / fast_recovery_area</code></pre></div>
                     </li>
                     <li class="stepexpand"><span>运行DBCA以创建分片目录数据库。</span><div><pre class="pre codeblock"><code>$ dbca</code></pre></div>
                        <div>数据库配置助手将打开。</div>
                     </li>
                     <li class="stepexpand"><span>在Database Operation页面上，选择<span class="uicontrol bold">Create a database</span> ，然后单击<span class="uicontrol bold">Next</span> 。</span></li>
                     <li class="stepexpand"><span>在Creation Mode页面上，选择<span class="uicontrol bold">Advanced configuration</span> ，然后单击<span class="uicontrol bold">Next</span> 。</span></li>
                     <li class="stepexpand"><span>在Deployment Type页面上，选择<span class="uicontrol bold">Oracle Single Instance数据库</span>数据库类型，选择<span class="uicontrol bold">General Purpose或Transaction Processing</span>模板，然后单击<span class="uicontrol bold">Next</span> 。</span></li>
                     <li class="stepexpand"><span>在“数据库标识”页上，输入您在分片目录主机环境脚本中配置的<span class="uicontrol bold">全局数据库名称</span>和分片目录<span class="uicontrol bold">SID</span> ，然后单击“ <span class="uicontrol bold">下一步”</span> 。</span></li>
                     <li class="stepexpand"><span>在Storage Option页面上，选择<span class="uicontrol bold">Use following for the database storage attributes</span>选项，选择<span class="uicontrol bold">File System</span> ，选择<span class="uicontrol bold">Use Oracle-Managed Files（OMF）</span>选项，然后单击<span class="uicontrol bold">Next</span> 。</span></li>
                     <li class="stepexpand"><span>在Select Fast Recovery Option页面上，选择<span class="uicontrol bold">Specify Fast Recovery Area</span> ，选择<span class="uicontrol bold">Enable archiving</span> ，然后单击<span class="uicontrol bold">Next</span> 。</span></li>
                     <li class="stepexpand"><span>在“指定网络配置详细信息”页面上，选择“ <span class="uicontrol bold">创建新侦听器”</span> ，设置侦听器名称和端口号，然后单击“ <span class="uicontrol bold">下一步”</span> 。</span><div>记下侦听器名称，以便以后可以连接到数据库。</div>
                     </li>
                     <li class="stepexpand"><span>跳过Data Vault Option页面。</span></li>
                     <li class="stepexpand"><span>在Configuration Options页面<span class="uicontrol bold">Memory</span>选项卡上，选择<span class="uicontrol bold">Use Automatic Shared Memory Management</span> 。</span></li>
                     <li class="stepexpand"><span>在“配置选项”页面的“ <span class="uicontrol bold">字符集”</span>选项卡上，选择“ <span class="uicontrol bold">使用Unicode（AL32UTF8）”</span> ，然后单击“ <span class="uicontrol bold">下一步”</span></span></li>
                     <li class="stepexpand"><span>在“管理选项”页面上，取消选中“ <span class="uicontrol bold">配置企业管理器（EM）数据库快速”</span>选项，然后单击“ <span class="uicontrol bold">下一步”</span> 。</span></li>
                     <li class="stepexpand"><span>在“用户凭据”页面上，根据业务需要选择适当的选项，输入密码，然后单击“ <span class="uicontrol bold">下一步”</span> 。</span><div>
                           <p>记下您输入的密码，因为稍后您将需要它们。</p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>在Creation Option页面上，选择<span class="uicontrol bold">Create database</span> ，然后单击<span class="uicontrol bold">Next</span> 。</span></li>
                     <li class="stepexpand"><span>在“摘要”页面上，单击“ <span class="uicontrol bold">完成”</span> 。</span></li>
                     <li class="stepexpand"><span>创建数据库后，记下全局数据库名称，SID和spfile值。</span></li>
                     <li class="stepexpand"><span>如果您计划使用Oracle Data Guard保护分片目录数据库，请单击“ <span class="uicontrol bold">密码管理”</span> ，解锁SYSDG帐户，并记下您为此帐户输入的密码。</span></li>
                     <li class="stepexpand"><span>单击“ <span class="uicontrol bold">关闭”</span>退出DBCA。</span></li>
                  </ol>
               </div>
               <div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
            </div>
            <div class="sect2"><a id="GUID-96ABB404-844C-457E-9C10-2D5C352D3928" name="GUID-96ABB404-844C-457E-9C10-2D5C352D3928"></a><h3 id="SHARD-GUID-96ABB404-844C-457E-9C10-2D5C352D3928" class="sect3"><span class="enumeration_section">8.6</span>设置Oracle Sharding管理和路由层</h3>
               <div>
                  <p>必须将分片目录，分片控制器和分片配置为相互通信。</p>
                  <div class="p">
                     <p>在开始之前，请仔细阅读<a href="sharding-deployment.html#GUID-9EC92076-7DD0-41ED-9E0C-B96CF074118D" title="Before you install any software, review these hardware, network, and operating system requirements for Oracle Sharding.">Oracle Sharding先决</a>条件中列出的端口要求先决<a href="sharding-deployment.html#GUID-9EC92076-7DD0-41ED-9E0C-B96CF074118D" title="在安装任何软件之前，请查看Oracle Sharding的这些硬件，网络和操作系统要求。">条件</a> ，并在继续执行本节中的任务之前进行必要的更改。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <ol>
                     <li class="stepexpand"><span>在分片目录主机上，验证预期的环境值是否设置为正确的值。</span><div><pre class="pre codeblock"><code>$ env | grep ORA ORACLE_SID = shardcat ORACLE_BASE = / u01 / app / oracle ORACLE_HOME = / u01 / app / oracle / product / 18.0.0 / dbhome_1</code></pre></div>
                     </li>
                     <li class="stepexpand"><span>如果尚未启动分片目录侦听器，请启动分片目录侦听器。</span><div><pre class="pre codeblock"><code>$ lsnrctl开始</code></pre></div>
                     </li>
                     <li class="stepexpand"><span>验证是否在分片目录数据库上设置了<code class="codeph">DB_CREATE_FILE_DEST</code>参数。</span><div>
                           <p>如果未设置该参数，则按以下示例所示进行设置。请注意，出于Oracle Sharding演示应用程序的目的， <code class="codeph">open_links</code>和<code class="codeph">open_links_per_instance</code>设置为16。
                           </p><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt; alter system set db_create_file_dest ='/ u01 / app / oracle / oradata'cope = both; SQL&gt; alter system set open_links = 16 scope = spfile; SQL&gt; alter system set open_links_per_instance = 16 scope = spfile;</code></pre></div>
                     </li>
                     <li class="stepexpand"><span>关闭并重新启动分片目录数据库。</span><div><pre class="pre codeblock"><code>SQL&gt; shutdown immediate Datablase已关闭。数据库已卸下。SQL&gt;启动ORACLE实例已启动。系统全局总面积4798283776字节固定大小4430760字节可变大小1006634072字节数据库缓冲区3774873600字节重做缓冲区12345344字节数据库已装入。数据库已打开</code></pre></div>
                     </li>
                     <li class="stepexpand"><span>授予分片目录数据库的角色和权限。</span><div><pre class="pre codeblock"><code>SQL&gt;在SQL上设置echo&gt;在SQL上设置termout&gt; spool setup_grants_privs.lst</code></pre></div>
                        <ol type="a">
                           <li class="substepexpand"><span>解锁并设置GSMCATUSER架构的密码。</span><div>
                                 <p>连接到分片目录数据库时，分片控制器使用此模式。</p><pre class="pre codeblock"><code>SQL&gt; alter user gsmcatuser account unlock; SQL&gt; alter user gsmcatuser由<span class="variable" translate="no">gsmcatuser_password</span>标识;</code></pre></div>
                           </li>
                           <li class="substepexpand"><span>创建管理员架构并为其授予权限。</span><div>
                                 <p>mysdbadmin帐户是分片目录数据库中的一个帐户，它存储有关分片环境的信息。mysdbadmin帐户是用于对分片数据库环境进行管理更改的数据库管理员架构。运行GDSCTL命令时，GDSCTL通过此用户连接到数据库，mysdbadmin用户在数据库中进行必要的更改。</p><pre class="pre codeblock"><code>SQL&gt;创建由<span class="variable" translate="no">mysdbadmin_password</span>标识的用户<span class="variable" translate="no">mysdbadmin_password</span> ; SQL&gt; grant connect，create session，gsmadmin_role to mysdbadmin; SQL&gt;将用户SYS的继承权限授予GSMADMIN_INTERNAL; SQL&gt;假脱机</code></pre></div>
                           </li>
                        </ol>
                     </li>
                     <li class="stepexpand"><span>连接到分片导演主机并启动GDSCTL。</span><div>
                           <p>以下步骤中的命令是从分片导向器主机执行的，因为GDSCTL命令行界面安装在那里。</p>
                           <p>以下示例包括已正确设置环境变量的完整性检查。</p><pre class="pre codeblock"><code>$ env | grep ORA ORACLE_BASE = / u01 / app / oracle ORACLE_HOME = / u01 / app / oracle / product / 18.0.0 / gsmhome_1 $ gdsctl</code></pre></div>
                     </li>
                     <li class="stepexpand"><span>创建分片目录并在分片目录上配置远程调度程序代理。</span><div>
                           <p>在此示例中，分片数据库的名称为cust_sdb，并创建了两个区域：region1和region2。这些区域用作本地可用域，用于从主数据库到物理备用数据库的分片故障转移。在这些例子中，这些区域并不代表地理区域。</p>
                           <p>要使用Oracle GoldenGate复制为系统管理的分片创建分片目录，请执行以下操作：</p><pre class="pre codeblock"><code>GDSCTL&gt; create shardcatalog -database <span class="variable" translate="no">shard_catalog_host</span> ： <span class="variable" translate="no">port_number</span> ： <span class="variable" translate="no">shard_catalog_name</span> -user gsm_admin / <span class="variable" translate="no">mysdbadmin_password</span> <span class="bold">-repl OGG</span> <span class="bold">-repfactor 2</span> -sdb cust_sdb -region region1，region2 -agent_port <span class="variable" translate="no">port_num</span> -agent_password <span class="variable" translate="no">rsa_password</span></code></pre><div class="infoboxnote" id="GUID-96ABB404-844C-457E-9C10-2D5C352D3928__GUID-9DCE016B-4CF9-43C1-B03A-331EC45F28B5">
                              <p class="notep1">注意：</p>
                              <p>对于生产系统，最好使用默认值（每个分片120个块），而不是在创建分片目录时指定<code class="codeph">-chunks</code>参数。
                              </p>
                              <p>由于系统管理是默认的分片方法，因此不需要使用<code class="codeph">-sharding</code>参数指定它。
                              </p>
                           </div>
                           <p>要使用Data Guard复制为复合分片数据库创建分片目录，请执行以下操作：</p><pre class="pre codeblock"><code>GDSCTL&gt; create shardcatalog -database <span class="variable" translate="no">shard_catalog_host</span> ： <span class="variable" translate="no">port_number</span> ： <span class="variable" translate="no">shard_catalog_name</span> -chunks 60 -shardspace shardspace1 <span class="bold">-sharding composite</span> -sdb comp_shpool -protectmode maxavailability -user gsm_admin / <span class="variable" translate="no">mysdbadmin_password</span></code></pre><p>要使用Data Guard复制为用户定义的分片数据库创建分片目录，请执行以下操作：</p><pre class="pre codeblock"><code>GDSCTL&gt; create shardcatalog -sdb udef_shpool <span class="bold">-sharding user</span> -protectmode maxavailability -database <span class="variable" translate="no">shard_catalog_host</span> ： <span class="variable" translate="no">port_number</span> ： <span class="variable" translate="no">shard_catalog_name</span> -user gsm_admin / <span class="variable" translate="no">mysdbadmin_password</span> -region region1，region2</code></pre><div class="infoboxnote" id="GUID-96ABB404-844C-457E-9C10-2D5C352D3928__GUID-33D12BCD-CC5E-450F-ACEC-A28DC547DA63">
                              <p class="notep1">注意：</p>
                              <p>如果使用<code class="codeph">ADD SHARD</code>部署方法，则不需要<code class="codeph">-agent_port</code>和<code class="codeph">-agent_password</code>参数。
                              </p>
                           </div>
                        </div>
                     </li>
                     <li class="stepexpand"><span>当您连接到分片导演主机时，创建并启动分片导演。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; add gsm -gsm sharddirector1 -listener <span class="variable" translate="no">listener_port</span> -pwd <span class="variable" translate="no">gsmcatuser_password</span> -catalog <span class="variable" translate="no">shard_catalog_host</span> ：1521：shardcat -region region1 GDSCTL&gt; start gsm -gsm sharddirector1</code></pre><p>在每个分片导向器主机上重复步骤6和8。将分片导向器名称和区域名称替换为每个主机的适当值。</p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>使用GDSCTL，设置操作系统凭据。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;添加凭证-credential <span class="variable" translate="no">credential_name</span> -osaccount <span class="variable" translate="no">os_account_name</span> -ospassword <span class="variable" translate="no">os_password</span> GDSCTL&gt;退出</code></pre><div class="infoboxnote" id="GUID-96ABB404-844C-457E-9C10-2D5C352D3928__GUID-8E45CD46-9496-4459-B166-3DE2FAA93491">
                              <p class="notep1">注意：</p>
                              <p>如果您使用<code class="codeph">ADD SHARD</code>部署方法，则无需执行此步骤。
                              </p>
                           </div>
                           <p>这些凭据是分片主机（而不是目录主机）上的操作系统用户名和密码，远程调度程序代理使用凭据在主机上运行作业以使用DBCA，NETCA等设置分片。</p>
                           <p>如果将为每个主机使用不同的操作系统凭据，请重复此步骤。</p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>连接到每个分片主机，在其上注册远程调度程序代理，并在其上创建oradata和fast_recovery_area的目录。</span><div>
                           <div class="infoboxnote" id="GUID-96ABB404-844C-457E-9C10-2D5C352D3928__GUID-5D285EB7-1EA7-4DDB-B312-8454C5159809">
                              <p class="notep1">注意：</p>只有在使用“分<a href="sharding-deployment.html#GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" title="Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。">片数据库部署简介”中</a>描述的<code class="codeph">CREATE SHARD</code>方法时，才需要执行此步骤。如果您使用<code class="codeph">ADD SHARD</code>方法，则可以跳过此步骤。
                           </div>
                           <p>在将托管分片的每台计算机上执行以下语句。</p>
                           <p>请注意， <span class="variable" translate="no">os_account_name</span>是用于Oracle软件安装的帐户， <span class="variable" translate="no">shard_host</span>是托管分片的计算机的主机名或IP地址， <span class="variable" translate="no">shard_catalog_host</span>是分片目录主机的主机名或IP地址， <span class="variable" translate="no">port_num</span>是远程调度程序代理在上面的步骤7中为<code class="codeph">create shardcatalog</code>的<code class="codeph">-agent_port</code>参数中指定的端口号。远程调度程序代理会提示您输入上面步骤7中<code class="codeph">create shardcatalog</code>的<code class="codeph">-agent_password</code>参数中指定的代理注册密码。
                           </p><pre class="pre codeblock"><code>$ ssh <span class="variable" translate="no">os_account_name</span> <span class="variable" translate="no">shard_host</span> passwd： <span class="variable" translate="no">os_password</span> $ schagent -start $ schagent -status $ schagent -registerdatabase <span class="variable" translate="no">shard_catalog_host</span> <span class="variable" translate="no">port_num</span> $ mkdir / u01 / app / oracle / oradata $ mkdir / u01 / app / oracle / fast_recovery_area</code></pre></div>
                     </li>
                  </ol>
                  <div class="section"></div>
                  <!-- class="section" -->
               </div>
               <div>
                  <div class="infoboxnotealso" id="GUID-96ABB404-844C-457E-9C10-2D5C352D3928__GUID-CDC9841F-455C-41FD-802F-199642D74473">
                     <p class="notep1">也可以看看：</p>
                     <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=GSMUG-GUID-16E4FFF2-29C9-4954-9474-6D269BF3F6AF" target="_blank"><span><cite>“Oracle数据库全局数据服务概念和管理指南”，</cite></span></a>以获取有关GDSCTL命令的用法和选项的信息。
                     </p>
                  </div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
            </div>
            <div class="sect2"><a id="GUID-A2492CE2-A98C-4F59-9946-889FFD0FEBA9" name="GUID-A2492CE2-A98C-4F59-9946-889FFD0FEBA9"></a><h3 id="SHARD-GUID-A2492CE2-A98C-4F59-9946-889FFD0FEBA9" class="sect3"><span class="enumeration_section">8.7</span>创建和部署系统管理的分片数据库</h3>
               <div>
                  <p></p>
                  <p>以下主题描述了创建和部署系统管理的分片数据库的任务。</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-4E77F1B8-F665-40C4-B4AC-B321C7302AA9">部署系统管理的分片数据库</a><br>要部署系统管理的分片数据库，您需要创建分片组和分片，创建和配置要用作分片的数据库，执行<code>DEPLOY</code>命令以及创建基于角色的全局服务。
                     </li>
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-61B495D3-4482-47E2-937E-B7E03286F565">为系统管理的分片数据库创建模式</a><br>为分片数据库创建模式用户，表空间集，分片表和重复表。验证DDL是否已传播到所有分片，并在连接到分片时验证具有快速启动故障转移的自动Data Guard Broker配置。
                     </li>
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-A3433C97-90F8-4CBF-ADA8-2AE2145612DB">系统管理的SDB演示应用程序</a><br>系统管理的分片数据库（SDB）演示应用程序模拟在线零售商店的工作负载。使用它来验证任何系统管理（自动分片）SDB配置的设置。演示应用程序还为管理员和数据库分片新手的开发人员提供了分片概念的实际示例。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-4E77F1B8-F665-40C4-B4AC-B321C7302AA9" name="GUID-4E77F1B8-F665-40C4-B4AC-B321C7302AA9"></a><h4 id="SHARD-GUID-4E77F1B8-F665-40C4-B4AC-B321C7302AA9" class="sect4"><span class="enumeration_section">8.7.1</span>部署系统管理的分片数据库</h4>
                  <div>
                     <p>要部署系统管理的分片数据库，您需要创建分片组和分片，创建和配置要用作分片的数据库，执行<code>DEPLOY</code>命令以及创建基于角色的全局服务。
                     </p>
                     <div class="section">
                        <p>系统管理的分片不需要用户将数据映射到分片。使用一致哈希进行分区，数据将自动分布在分片中。分区算法在分片之间均匀随机地分配数据。有关系统管理的分片数据库的更多概念性信息，请参阅<a href="sharding-methods.html#GUID-37F20817-EFD5-400B-A082-41171C0B6D1C" title="系统管理的分片是一种分片方法，不需要用户指定数据到分片的映射。使用一致哈希进行分区，数据将自动分布在分片中。分区算法在分片之间均匀随机地分配数据。">系统管理分片</a> 。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>如果您使用的<a href="sharding-deployment.html#GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" title="Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。">是Sharded Database Deployment简介中</a>描述的<code class="codeph">ADD SHARD</code>方法，则必须首先创建要在其各自主机上用作分片的数据库。</span><div>
                              <p>分片数据库必须具有以下特征：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>他们必须在每台主机上都有一个关联的TNS监听器</p>
                                 </li>
                                 <li>
                                    <p>必须使用已知密码解锁<code class="codeph">GSMUSER</code>帐户</p>
                                 </li>
                                 <li>
                                    <p>必须向<code class="codeph">GSMUSER</code>授予<code class="codeph">SYSDG</code>和<code class="codeph">SYSBACKUP</code>权限 
                                    </p>
                                 </li>
                                 <li>
                                    <p>必须按原样配置主数据库和备用数据库</p>
                                 </li>
                                 <li>
                                    <p>应在相应的主数据库和备用数据库之间设置重做应用</p>
                                 </li>
                                 <li>
                                    <p>应启用闪回和强制日志记录</p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">compatible</code>参数必须至少设置为12.2.0</p>
                                 </li>
                                 <li>
                                    <p>必须使用服务器参数文件（SPFILE）</p>
                                 </li>
                                 <li>
                                    <p>必须在每个数据库中创建<code class="codeph">DATA_PUMP_DIR</code>目录对象，并且必须指向有效目录</p>
                                 </li>
                              </ul>
                              <p>然后，您必须验证是否正确设置了数据库以进行分片。在将每个数据库添加到配置之前，以SYS身份登录时，对每个数据库运行以下语句。</p><pre class="pre codeblock"><code>SQL&gt;在SQL上设置serveroutput&gt;执行DBMS_GSM_FIX.validateShard</code></pre><p>屏幕输出将包括需要针对任何问题进行分析的INFO，WARNING和ERROR信息。必须解决所有WARNING和ERROR消息。在进行更改以确认配置后重新运行<code class="codeph">validateShard()</code> 。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>连接到分片导演主机。</span><div><pre class="pre codeblock"><code>$ ssh <span class="variable" translate="no">os_user</span> @ <span class="variable" translate="no">shard_director1_host</span>
</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为当前会话设置全局服务管理器，并指定要管理它的凭据。</span><div><pre class="pre codeblock"><code>$ gdsctl GDSCTL&gt; set gsm -gsm sharddirector1 GDSCTL&gt; connect mysdbadmin / <span class="variable" translate="no">mysdbadmin_password</span></code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为主分片添加分片组。</span><div>
                              <p>在此示例中，shardgroup名为primary_shardgroup，是Data Guard复制解决方案的一部分。</p><pre class="pre codeblock"><code>GDSCTL&gt;添加shardgroup -shardgroup primary_shardgroup <span class="bold">-deploy_as primary</span> -region region1</code></pre><p>以下示例显示了Oracle GoldenGate复制解决方案的分片组创建。</p><pre class="pre codeblock"><code>GDSCTL&gt;添加shardgroup -shardgroup shardgroup1 -region region1 <span class="bold">-repfactor 2</span></code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为备用分片添加分片组。</span><div>
                              <p>在此示例中，shardgroup名为standby_shardgroup，并使用<code class="codeph">-deploy_as</code>参数为Active Data Guard活动备用数据库创建。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt;添加shardgroup -shardgroup standby_shardgroup <span class="bold">-deploy_as active_standby</span> -region region2</code></pre><p>在Oracle GoldenGate配置中添加第二个分片组可能类似于以下示例。</p><pre class="pre codeblock"><code>GDSCTL&gt;添加shardgroup -shardgroup shardgroup2 -region region2 <span class="bold">-repfactor 2</span> </code></pre></div>
                        </li>
                        <li class="stepexpand"><span>将每个分片的主机地址添加到目录中的有效节点检查注册（VNCR）列表，然后在主分片组或备用分片组中创建或添加分片，如以下示例所示。</span><div>
                              <div class="infoboxnote" id="GUID-4E77F1B8-F665-40C4-B4AC-B321C7302AA9__THEVALIDNODECHECKINGFORREGISTRATION-3F858F5D">
                                 <p class="notep1">注意：</p>
                                 <p>有效的节点检查注册（VNCR）功能提供了配置和动态更新分片控制器允许注册请求的一组IP地址，主机名或子网的功能。仅当请求源自有效节点时，才使用分片导向器进行数据库实例注册。默认情况下，分片管理层（基于Oracle全局数据服务框架）会自动为每次<code class="codeph">create shard</code>或<code class="codeph">add shard</code>片时运行远程数据库的主机添加VNCR条目。自动化（称为auto-VNCR）查找目标主机的公共IP地址，并自动为该IP地址添加VNCR条目。如果主机具有多个公共IP地址，则数据库注册的地址可能与使用auto-VNCR添加的地址不同，因此，许多注册被拒绝。如果目标数据库主机具有多个公共IP地址，建议您使用<code class="codeph">add invitednode</code>手动为此主机配置VNCR，或在GDSCTL中<code class="codeph">add invitedsubnet</code>命令。</p>
                                 <p>如果目标主机上有多个网卡（ <code class="codeph">/sbin/ifconfig</code>返回多个公共接口），请使用<code class="codeph">add invitednode</code>是安全的（在找出将用于路由数据包的接口之后）。
                                 </p>
                                 <p>如果对注册有任何疑问，请使用<code class="codeph">config vncr</code>并根据需要使用<code class="codeph">add invitednode</code> 。执行此操作没有任何害处，因为如果已添加节点，则自动VNCR会忽略它，如果您尝试在自动VNCR添加它之后添加它，您将收到一条警告，指出它已经存在。
                                 </p>
                              </div>
                              <p>以下示例说明如何使用<code class="codeph">CREATE SHARD</code>命令创建四个分片，使用Data Guard高可用性解决方案，其中两个位于主分片组中，两个位于备用分片组中。<span class="variable" translate="no">credential_name</span>是您在目标主机的分片目录中创建的操作系统凭据。
                              </p>
                              <p>创建分片时，还可以使用<code class="codeph">-sys_password</code>在<code class="codeph">create shard</code> <code class="codeph">-sys_password</code>设置SYS密码，如以下示例所示。这在运行<code class="codeph">DEPLOY</code>时创建分片后设置SYS密码。</p>
                              <p><code class="codeph">CREATE SHARD</code>还有其他可选参数，允许您自定义数据库参数，存储和文件位置，侦听器端口号等，这些参数在<span><cite>Oracle数据库全局数据服务概念和管理指南</cite></span>附录中进行了介绍。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_1</span> GDSCTL&gt; create shard -shardgroup primary_shardgroup -destination <span class="variable" translate="no">shard_host_1</span> -credential <span class="variable" translate="no">credential_name</span> -sys_password <span class="variable" translate="no">sys_password</span> GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_2</span> GDSCTL&gt; create shard -shardgroup standby_shardgroup -destination <span class="variable" translate="no">shard_host_2</span> -credential <span class="variable" translate="no">credential_name</span> -sys_password <span class="variable" translate="no">sys_password</span> GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_3</span> GDSCTL&gt; create shard -shardgroup primary_shardgroup -destination <span class="variable" translate="no">shard_host_3</span> -credential <span class="variable" translate="no">credential_name</span> -sys_password <span class="variable" translate="no">sys_password</span> GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_4</span> GDSCTL&gt; create shard -shardgroup standby_shardgroup -destination <span class="variable" translate="no">shard_host_4</span> -credential <span class="variable" translate="no">credential_name</span> -sys_password <span class="variable" translate="no">sys_password</span></code></pre><p>在Oracle GoldenGate复制解决方案中，不会将分片组指定为主分区和备用分组，因为复制在块级处理并分布在分片组内的分片中。但是，灾难恢复最佳做法是将分片组复制到一个或多个数据中心。以下是使用Oracle GoldenGate复制创建分片的示例。</p><pre class="pre codeblock"><code>GDSCTL&gt;创建shard -shardgroup <span class="variable" translate="no">shardgroup</span> -destination <span class="variable" translate="no">shard_host</span> -credential oracle_cred -netparam /home/oracle/netca_dbhome.rsp -gg_service <span class="variable" translate="no">shard_host_1</span> ：$ ADMINSRVR_PORT / $ GGHOME -gg_password <span class="variable" translate="no">ggadmin_password</span> -dbparamfile /home/oracle/dbparams01.tmp -dbtemplatefile / home / ORACLE / sharddb01.dbt</code></pre><p>如果您使用的<a href="sharding-deployment.html#GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" title="Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。">是Sharded Database Deployment简介中</a>描述的<code class="codeph">ADD SHARD</code>方法，请使用以下命令代替上面示例中的<code class="codeph">CREATE SHARD</code>命令。如果要添加的分片数据库是可插拔数据库（PDB），则必须使用<code class="codeph">-cdb</code>选项<code class="codeph">ADD SHARD</code> <code class="codeph">-cdb</code>指定PDB分片所在的容器数据库（CDB）。此外，必须在<code class="codeph">ADD SHARD</code>命令之前使用<code class="codeph">ADD CDB</code>将CDB添加到目录中。有关<code class="codeph">ADD CDB</code>和<code class="codeph">ADD SHARD</code>的语法，请参阅“ <span><cite>Oracle数据库全局数据服务概念和管理指南”</cite></span> 。注意，在Oracle数据库<span class="italic">18c</span>中，只有一个PDB中的每个CDB允许是一个分片。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt;添加shard -shardgroup shgrp1 -connect <span class="variable" translate="no">shard_host</span> ： <span class="variable" translate="no">TNS_listener_port</span> / <span class="variable" translate="no">shard_database_name</span> -pwd <span class="variable" translate="no">GSMUSER_password</span></code></pre></div>
                        </li>
                        <li class="stepexpand"><span>从分片导向器检查配置。</span><div>
                              <p>请注意，使用<code class="codeph">CREATE SHARD</code>方法时，分片名称sh1，sh2，sh3和sh4是系统生成的分片名称。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt; config Regions ----------------------- region1 region2 GSMs -------------------- --- sharddirector1 sharddirector2 Sharded Database ----------------------- cust_sdb数据库------------------ ----- sh1 sh2 sh3 sh4 Shard Groups ----------------------- primary_shardgroup standby_shardgroup Shard spaces ------------ ----------- shardspaceora服务----------------------- GDSCTL待处理请求----------- ------------命令对象状态------- ------ ------全局属性-------------- ---------名称：oradbcloud Master GSM：sharddirector1 DDL序列＃：0 GDSCTL&gt; config shardspace SHARDSPACE Chunks ---------- ------ shardspaceora 12 GDSCTL&gt; config shardgroup Shard Group Chunks Region SHARDSPACE ----------- ------ ------ ---------- primary_shardgroup 12 region1 shardspaceora standby_shardgroup 12 region2 shardspaceora GDSCTL&gt; config vncr名称组ID ---- -------- shard_host_1 shard_host_2 shard_host_3 shard_host_4 shard_catalog_host_IP GDSCTL&gt; config shard名称Shard Gr oup状态状态区可用性---- ----------- ------ ----- ------ ------------ sh1 primary_shardgroup U无region1  -  sh2 standby_shardgroup U无region2  -  sh3 primary_shardgroup U无region1  -  sh4 standby_shardgroup U无region2  -</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>运行<code>DEPLOY</code>命令以创建分片和副本。</span><div>
                              <p><code>DEPLOY</code>命令需要一些时间才能运行，大约需要15到30分钟。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt;部署</code></pre><p>使用<code class="codeph">CREATE SHARD</code>方法创建分片时，DEPLOY命令使用DBCA创建主分片和备用分片。为所有分片启用了快速启动故障转移观察器执行备用重新实例化所需的Archivelog和闪回。
                              </p>
                              <p>构建主分片和备用分片后， <code>DEPLOY</code>命令会配置启用了快速启动故障转移的Data Guard Broker。快速启动故障转移观察器将自动在备用组的分片控制器（此示例中为sharddirector2）上启动。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证是否已部署所有分片。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; config shard Name Shard Group Status State Region Availability ---- ----------- ------ ----- ------ ------- ----- sh1 primary_shardgroup Ok已部署的region1 ONLINE sh2 standby_shardgroup Ok已部署的region2 READ_ONLY sh3 primary_shardgroup Ok已部署的region1 ONLINE sh4 standby_shardgroup Ok已部署的region2 READ_ONLY</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证是否已注册所有分片。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;数据库数据库：“sh1”已注册：Y状态：确定ONS：N。角色：PRIMARY实例：1区域：region1已注册实例：cust_sdb％1数据库：“sh2”已注册：Y状态：确定ONS：N。角色： PH_STNDBY实例：1区域：region2已注册实例：cust_sdb％11数据库：“sh3”已注册：Y状态：确定ONS：N。角色：PRIMARY实例：1区域：region1已注册实例：cust_sdb％21数据库：“sh4”已注册： Y状态：Ok ONS：N。作用：PH_STNDBY实例：1区域：region2已注册实例：cust_sdb％31</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>检查分片的配置。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; config shard -shard sh1名称：sh1 Shard组：primary_shardgroup状态：Ok状态：已部署区域：region1连接字符串： <span class="variable" translate="no">shard_host_1</span> ： <span class="variable" translate="no">TNS_listener_port</span> / <span class="variable" translate="no">sh1</span> ：专用SCAN地址：ONS远程端口：0磁盘阈值，ms：20 CPU阈值， ％：75版本：18.0.0.0上次失败DDL：DDL错误：--- DDL ID失败：可用性：ONLINE支持的服务-----------------------姓名首选身份---- --------- ------</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>添加在所有主分片上运行的全局服务。</span><div>
                              <p>oltp_rw_srvc全局服务是客户端可用于连接到分片数据库的全局数据服务。oltp_rw_srvc服务在主分片上运行OLTP事务。同样，创建oltp_ro_srvc全局服务以在备用分片上运行只读工作负载。</p><pre class="pre codeblock"><code>GDSCTL&gt;添加服务-service oltp_rw_srvc -role primary GDSCTL&gt; config service名称网络名称Pool Started Preferred all ---- ------------ ---- -------  - ----------- oltp_rw_srvc oltp_rw_srvc.cust_sdb.oracdbcloud cust_sdb否是</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>启动oltp_rw_srvc全局服务。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;启动服务-service oltp_rw_srvc GDSCTL&gt;状态服务服务“oltp_rw_srvc.cust_sdb.oradbcloud”有2个实例。亲和性：ANYWHERE实例“cust_sdb％1”，名称：“sh1”，db：“sh1”，region：“region1”，状态：就绪。实例“cust_sdb％21”，名称：“sh3”，db：“sh3”，区域：“region1”，状态：就绪。</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为只读工作负载添加全局服务以在备用分片上运行。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;添加服务-service oltp_ro_srvc -role physical_standby GDSCTL&gt;配置服务名称网络名称池启动首选全部---- ------------ ---- -------  - ----------- oltp_rw_srvc oltp_rw_srvc.cust_sdb.oracdbcloud cust_sdb是是oltp_ro_srvc oltp_ro_srvc.cust_sdb.oracdbcloud cust_sdb否是</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>启动只读服务，并验证全局服务的状态。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;启动服务-service oltp_ro_srvc GDSCTL&gt;状态服务服务“oltp_ <span class="bold">ro</span> _srvc.cust_sdb.oradbcloud”有2个实例。亲和性：ANYWHERE实例“cust_sdb％11”，名称：“sh2”，db：“sh2”，region：“region2”，状态：就绪。实例“cust_sdb％31”，名称：“sh4”，db：“sh4”，区域：“region2”，状态：就绪。服务“oltp_ <span class="bold">rw</span> _srvc.cust_sdb.oradbcloud”有2个实例。亲和性：ANYWHERE实例“cust_sdb％1”，名称：“sh1”，db：“sh1”，region：“region1”，状态：就绪。实例“cust_sdb％21”，名称：“sh3”，db：“sh3”，区域：“region1”，状态：就绪。</code></pre></div>
                        </li>
                     </ol>
                     <div class="section"></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-4E77F1B8-F665-40C4-B4AC-B321C7302AA9__GUID-0A88E5FE-1FBD-4DD8-BEDE-DB97D221C345">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="sharding-deployment.html#GUID-61B495D3-4482-47E2-937E-B7E03286F565" title="为分片数据库创建模式用户，表空间集，分片表和重复表。验证DDL是否已传播到所有分片，并在连接到分片时验证具有快速启动故障转移的自动Data Guard Broker配置。">为系统管理的分片数据库创建模式</a></p>
                        <p>有关GDSCTL命令用法的详细信息，请参见<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=GSMUG-GUID-3285C437-78F8-4339-AAAB-33DBB7A9D400" target="_blank"><span><cite>“Oracle数据库全局数据服务概念和管理指南”</cite></span></a></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-A2492CE2-A98C-4F59-9946-889FFD0FEBA9">创建和部署系统管理的分片数据库</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
               <div class="sect3"><a id="GUID-61B495D3-4482-47E2-937E-B7E03286F565" name="GUID-61B495D3-4482-47E2-937E-B7E03286F565"></a><h4 id="SHARD-GUID-61B495D3-4482-47E2-937E-B7E03286F565" class="sect4"><span class="enumeration_section">8.7.2</span>为系统管理的分片数据库创建模式</h4>
                  <div>
                     <p>为分片数据库创建模式用户，表空间集，分片表和重复表。验证DDL是否已传播到所有分片，并在连接到分片时验证具有快速启动故障转移的自动Data Guard Broker配置。</p>
                     <ol>
                        <li class="stepexpand"><span>连接到分片目录数据库，创建应用程序模式用户，并向用户授予权限和角色。</span><div>
                              <p>在此示例中，应用程序模式用户称为app_schema。</p><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt; alter session enable shard ddl; SQL&gt; create user app_schema由<span class="variable" translate="no">app_schema_password</span>标识; SQL&gt;授予app_schema所有权限; SQL&gt;将gsmadmin_role授予app_schema; SQL&gt;将select_catalog_role授予app_schema; SQL&gt; grant connect，resource to app_schema; SQL&gt;将dba授予app_schema; SQL&gt;将dbms_crypto上的execute赋予app_schema;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为分片表创建表空间集。</span><div><pre class="pre codeblock"><code>SQL&gt; CREATE TABLESPACE SET TSP_SET_1使用模板（数据文件大小100m自动扩展，在下一个10M maxsize无限范围管理本地段空间管理自动）;</code></pre><p>创建表空间集时，指定shardspace是可选的。如果未在命令中指定分片空间，则使用默认分片空间shardspaceora。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>如果在列中使用LOB，则可以为LOB指定表空间集。</span><div><pre class="pre codeblock"><code>SQL&gt; CREATE TABLESPACE SET LOBTS1;</code></pre><div class="infoboxnote" id="GUID-61B495D3-4482-47E2-937E-B7E03286F565__GUID-DA0D2D1F-4D62-41ED-93A7-615CF0896A4C">
                                 <p class="notep1">注意：</p>
                                 <p>在系统管理的分片中，无法在子分区级别指定LOBS的表空间集。</p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>为重复的表创建表空间。</span><div>
                              <p>在此示例中，重复的表是示例Customers-Orders-Products模式中的Products表。</p><pre class="pre codeblock"><code>SQL&gt; CREATE TABLESPACE products_tsp datafile size 100m autoextend on next 10M maxsize unlimited extent management local local uniform size 1m;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为根表创建分片表。</span><div>
                              <p>在此示例中，根表是Customers-Orders-Products模式示例中的Customers表。</p><pre class="pre codeblock"><code>SQL&gt; CONNECT app_schema / <span class="variable" translate="no">app_schema_password</span> SQL&gt; ALTER SESSION ENABLE SHARD DDL; SQL&gt; CREATE SHARDED TABLE Customers（CustId VARCHAR2（60）NOT NULL，FirstName VARCHAR2（60），LastName VARCHAR2（60），Class VARCHAR2（10），Geo VARCHAR2（8），CustProfile VARCHAR2（4000），Passwd RAW（60） ，CONSTRAINT pk_customers PRIMARY KEY（CustId），CONSTRAINT json_customers CHECK（CustProfile IS JSON））TABLESPACE SET TSP_SET_1 PARTITION BY CONSISTENT HASH（CustId）PARTITIONS AUTO;</code></pre><div class="infoboxnote" id="GUID-61B495D3-4482-47E2-937E-B7E03286F565__GUID-A34A0827-00CE-40AD-BF1C-9016670A1618">
                                 <p class="notep1">注意：</p>
                                 <p>如果任何列包含LOB，则可以在父表创建语句中包含表空间集，如此处所示。</p><pre class="pre codeblock"><code>SQL&gt; CREATE SHARDED TABLE Customers（CustId VARCHAR2（60）NOT NULL，FirstName VARCHAR2（60），LastName VARCHAR2（60），Class VARCHAR2（10），Geo VARCHAR2（8），CustProfile VARCHAR2（4000），Passwd RAW（60） ， <span class="bold">image BLOB，</span> CONSTRAINT pk_customers PRIMARY KEY（CustId），CONSTRAINT json_customers CHECK（CustProfile IS JSON））TABLESPACE SET TSP_SET_1 <span class="bold">LOB（image）store as（TABLESPACE SET LOBTS1）</span> PARTITION BY CONSISTENT HASH（CustId）PARTITIONS AUTO;</code></pre></div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>为表系列中的其他表创建分片表。</span><div>
                              <p>在此示例中，为示例Customers-Orders-Products架构中的Orders和LineItems表创建分片表。</p>
                              <p>首先创建Orders sharded表：</p><pre class="pre codeblock"><code>SQL&gt; CREATE SHARDED TABLE Orders（OrderId INTEGER NOT NULL，CustId VARCHAR2（60）NOT NULL，OrderDate TIMESTAMP NOT NULL，SumTotal NUMBER（19,4），Status CHAR（4），CONSTRAINT pk_orders PRIMARY KEY（CustId，OrderId），CONSTRAINT fk_orders_parent FOREIGN KEY（CustId）REFERENCES DELETE CASCADE）客户参考分区（fk_orders_parent）;</code></pre><p>创建用于OrderId列的序列。</p><pre class="pre codeblock"><code>SQL&gt; CREATE SEQUENCE Orders_Seq;</code></pre><p>为LineItem创建分片表</p><pre class="pre codeblock"><code>SQL&gt; CREATE SHARDED TABLE LineItems（OrderId INTEGER NOT NULL，CustId VARCHAR2（60）NOT NULL，ProductId INTEGER NOT NULL，Price NUMBER（19,4），QTY NUMBER，CONSTRAINT pk_items PRIMARY KEY（CustId，OrderId，ProductId），CONSTRAINT fk_items_parent FOREIGN KEY（CustId，OrderId）REFERENCES OR DELETE CASCADE）参考分区（fk_items_parent）;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>创建任何所需的重复表。</span><div> 
                              <p>在此示例中，Products表是一个重复的对象。</p><pre class="pre codeblock"><code>SQL&gt; CREATE DUPLICATED TABLE产品（由默认为IDENTITY PRIMARY KEY生成的ProductId INTEGER，名称VARCHAR2（128），DescrUri VARCHAR2（128），LastPrice NUMBER（19,4））TABLESPACE products_tsp;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>从分片导向器主机，验证在创建表空间期间没有失败。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; show ddl id DDL Text Failed shards  -  -------- ------------- 5 grant connect，resource to app_schema 6 grant dba to app_schema 7 grant execute on dbms_crypto to应用...8创建TABLESPACE SET TSP_SET_1使用...9 CREATE TABLESPACE products_tsp datafi ...10创建SHARDED TABLE客户（Cu ...11创建SHARDED TABLE订单（订购......12创建序列订单_Seq; 13创建SHARDED TABLE LineItems（或......14创建物质化视图“APP_SCHEMA”......
</code></pre><div class="infoboxnote" id="GUID-61B495D3-4482-47E2-937E-B7E03286F565__GUID-57F55490-D5AB-4801-BA0D-B7D4FE6B3802">
                                 <p class="notep1">注意：</p><code class="codeph">show ddl</code>命令输出可能会被截断。您可以在目录上运行<code class="codeph">SELECT ddl_text FROM gsmadmin_internal.ddl_requests</code>以查看语句的全文。
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证每个分片上是否没有DDL错误。</span><div>
                              <p>在<code>config shard</code>每个分片上运行<code>config shard</code>和<code>config chunks</code>命令。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt; config shard -shard sh1名称：sh1 Shard组：primary_shardgroup状态：Ok状态：已部署区域：region1连接字符串： <span class="variable" translate="no">shard_host_1</span> ：1521 / <span class="variable" translate="no">sh1_host</span> ：专用SCAN地址：ONS远程端口：0磁盘阈值，ms：20 CPU阈值， ％：75版本：18.0.0.0 <span class="bold">上次失败DDL：DDL错误：--- DDL ID失败：</span>可用性：ONLINE支持的服务----------------------- - 名称首选状态---- --------- ------ oltp_ro_srvc是启用oltp_rw_srvc是启用GDSCTL&gt; config chunks Chunks ---------------- --------数据库从To -------- ----  - <span class="bold">sh1 1 6 sh2 1 6 sh3 7 12 sh4 7 12</span> </code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证为分片表系列创建的表空间集的表空间，以及为所有分片创建为重复表创建的表空间。</span><div>
                              <p>表空间集中的表空间数基于您在<code>create shardcatalog</code>命令中指定的块数。
                              </p>
                              <p>使用分片目录创建示例中指定的12个前6个块设置的表空间，以及下面的示例中显示了重复的Products表空间。</p><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt;选择TABLESPACE_NAME，BYTES / 1024/1024 MB，来自sys.dba_data_files，由tablespace_name命令; TABLESPACE_NAME MB ----------------------- ---------- <span class="bold">C001TSP_SET_1 100 C002TSP_SET_1 100 C003TSP_SET_1 100 C004TSP_SET_1 100 C005TSP_SET_1 100 C006TSP_SET_1 100 PRODUCTS_TSP 100</span> SYSAUX 650 SYSTEM 890 SYS_SHARD_TS 100 TSP_SET_1 100 TABLESPACE_NAME MB ------------------------ ---------- UNDOTBS1 105 USERS 5 13 rows selected 。
</code></pre><p>在配置中的所有分片上重复此步骤。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证是否在所有分片上创建了块和块表空间。</span><div><pre class="pre codeblock"><code>SQL&gt; set linesize 140 SQL&gt; column table_name format a20 SQL&gt; column tablespace_name format a20 SQL&gt; column partition_name format a20 SQL&gt; show parameter db_unique_name NAME TYPE VALUE ---------------- --- -------- ------------------------------ db_unique_name string sh1 SQL&gt; select table_name，partition_name，tablespace_name from dba_tab_partitions其中tablespace_name类似于'C％TSP_SET_1'由tablespace_name排序; TABLE_NAME PARTITION_NAME TABLESPACE_NAME ---------------- ---------------- --------------- -----订单CUSTOMERS_P1 C001TSP_SET_1客户CUSTOMERS_P1 C001TSP_SET_1 LINEITEM CUSTOMERS_P1 C001TSP_SET_1客户CUSTOMERS_P2 C002TSP_SET_1了LineItem CUSTOMERS_P2 C002TSP_SET_1订单CUSTOMERS_P2 C002TSP_SET_1客户CUSTOMERS_P3 C003TSP_SET_1订单CUSTOMERS_P3 C003TSP_SET_1了LineItem CUSTOMERS_P3 C003TSP_SET_1订单CUSTOMERS_P4 C004TSP_SET_1客户CUSTOMERS_P4 C004TSP_SET_1 TABLE_NAME PARTITION_NAME TABLESPACE_NAME --------- ------- ---------------- -------------------- LINEITEMS CUSTOMERS_P4 C004TSP_SET_1 CUSTOMERS CUSTOMERS_P5 C005TSP_SET_1 LINEITEMS CUSTOMERS_P5 C005TSP_SET_1订单CUSTOMERS_P5 C005TSP_SET_1客户CUSTOMERS_P6 C006TSP_SET_1 LINEITEMS CUSTOMERS_P6 C006TSP_SET_1订单CUSTOMERS_P6 C006TSP_SET_1选择了18行。
</code></pre><p>在配置中的所有分片上重复此步骤。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>连接到分片目录数据库并验证分块是否均匀分布。</span><div><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt; set echo off SQL&gt; SELECT a.name Shard，COUNT（b.chunk_number）Number_of_Chunks FROM gsmadmin_internal.database a，gsmadmin_internal.chunk_loc b WHERE a.database_num = b.database_num GROUP BY a.name ORDER BY一个名字; SHARD NUMBER_OF_CHUNKS ------------------------------ ---------------- <span class="bold">sh1 6 sh2 6 sh3 6 sh4 6</span></code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证是否已创建分片和重复的表。</span><div>
                              <p>以分片目录数据库和每个分片上的应用程序模式用户身份登录。</p>
                              <p>以下示例显示了将数据库分片上的表作为app_schema用户进行查询。</p><pre class="pre codeblock"><code>$ sqlplus app_schema / <span class="variable" translate="no">app_schema_password</span>已连接。SQL&gt;从user_tables中选择table_name; TABLE_NAME ------------------------------------------------- ----------------------客户订购LINEITEMS产品4行选择。</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证Data Guard Broker自动快速启动故障转移配置是否已完成。</span><div><pre class="pre codeblock"><code>$ ssh os_username @shard_host_1 $ dgmgrl DGMGRL&gt; connect sys / <span class="variable" translate="no">password</span>连接到“sh1”连接为SYSDG。 DGMGRL&gt; show configuration配置 -  sh1保护模式：MaxPerformance成员： <span class="bold">sh1  - 主数据库sh2  - （*）物理备用数据库</span>快速启动故障转移： <span class="bold">启用</span>配置状态： <span class="bold">成功</span> （状态更新15秒前）DGMGRL&gt; show database sh1数据库 -  sh1角色：PRIMARY预期状态：TRANSPORT-ON实例：sh1数据库状态： <span class="bold">SUCCESS</span> DGMGRL&gt; show database sh2数据库 -  sh2角色：PHYSICAL STANDBY预期状态：APPLY-ON传输延迟：0秒（计算0秒前）应用滞后：0秒（计算0秒前）平均应用率：2.00 KByte / s实时查询：ON实例：sh2数据库状态： <span class="bold">SUCCESS</span> DGMGRL&gt; show fast_start failover快速启动故障转移： <span class="bold">启用</span>阈值：30秒目标： <span class="bold">sh2</span>观察者： <span class="variable" translate="no">shard_director_host</span>滞后限制：30秒关闭主要：TRUE自动恢复：TRUE观察者重新连接:(无）观察者覆盖：FALSE可配置故障转移条件健康状况：损坏的控制文件是损坏的字典是YES Inaccessi ble Logfile NO Stuck Archiver NO Datafile写入错误是Oracle错误条件:(无）</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>找到快速启动故障转移观察器。</span><div>
                              <p>连接到分片目录数据库并运行以下命令：</p><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt; SELECT observer_state FROM gsmadmin_internal.broker_configs; OBSERVER_STATE ------------------------------------------------- ------------------------------- GSM服务器SHARDDIRECTOR2。观察者开始了。记录'/u01/app/oracle/product/18.0.0/gsmhome_1/network/admin/gsm_observer_1.log'中的文件。GSM服务器SHARDDIRECTOR2。观察者开始了。记录'/u01/app/oracle/product/18.0.0/gsmhome_1/network.admin/gsm_observer_2.log'中的文件。</code></pre></div>
                        </li>
                     </ol>
                     <div class="section"></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-61B495D3-4482-47E2-937E-B7E03286F565__GUID-81030823-1335-4D74-8266-058942F5FFD3">
                        <p class="notep1">也可以看看：</p>
                        <p>有关GDSCTL命令用法的信息，请参见<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=GSMUG-GUID-3285C437-78F8-4339-AAAB-33DBB7A9D400" target="_blank"><span><cite>“Oracle数据库全局数据服务概念和管理指南”</cite></span></a></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-A2492CE2-A98C-4F59-9946-889FFD0FEBA9">创建和部署系统管理的分片数据库</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
               <div class="sect3"><a id="GUID-A3433C97-90F8-4CBF-ADA8-2AE2145612DB" name="GUID-A3433C97-90F8-4CBF-ADA8-2AE2145612DB"></a><h4 id="SHARD-GUID-A3433C97-90F8-4CBF-ADA8-2AE2145612DB" class="sect4"><span class="enumeration_section">8.7.3</span>系统管理的SDB演示应用程序</h4>
                  <div>
                     <p>系统管理的分片数据库（SDB）演示应用程序模拟在线零售商店的工作负载。使用它来验证任何系统管理（自动分片）SDB配置的设置。演示应用程序还为管理员和数据库分片新手的开发人员提供了分片概念的实际示例。</p>
                     <p>演示应用程序假定已经与CUSTOMER表系列一起创建了系统管理的SDB环境。环境可以具有任意数量的块和分片（数据库节点）。运行时，应用程序将首先填充Products表，然后启动一个小时的工作负载，管理员可以随时暂停该工作负载。工作负载包括四种类型的事务：创建客户订单，查找订单列表，创建新产品以及生成报告的多分片查询。执行分片数据库配置的所有方面。</p>
                     <p>您可以从<a href="https://support.oracle.com/CSP/main/article?cmd=show&amp;type=NOT&amp;id=2184500.1" target="_blank">My Oracle Support Document 2184500.1</a>下载演示应用程序以及描述如何运行和监视它的README文件。
                     </p>
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-A2492CE2-A98C-4F59-9946-889FFD0FEBA9">创建和部署系统管理的分片数据库</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
            <div class="sect2"><a id="GUID-6E11AA09-B7D3-45FB-9693-33B1329F7396" name="GUID-6E11AA09-B7D3-45FB-9693-33B1329F7396"></a><h3 id="SHARD-GUID-6E11AA09-B7D3-45FB-9693-33B1329F7396" class="sect3"><span class="enumeration_section">8.8</span>创建和部署用户定义的SDB</h3>
               <div>
                  <p></p>
                  <p>以下主题描述了创建和部署用户定义的SDB的任务。</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-D0BC77A5-B733-4EF5-AF41-7A3E4D79BD65">部署用户定义的SDB</a><br>以下过程介绍如何使用ADD SHARD命令和Oracle Active Data Guard高可用性解决方案部署用户定义的分片数据库。
                     </li>
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-97C5E0B3-F870-4F4E-9507-9644A73E6C76">为用户定义的SDB创建模式</a><br>为SDB创建模式用户，表空间集，分片表和重复表。验证DDL是否已传播到所有分片，并在连接到分片时验证具有快速启动故障转移的自动Data Guard Broker配置。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-D0BC77A5-B733-4EF5-AF41-7A3E4D79BD65" name="GUID-D0BC77A5-B733-4EF5-AF41-7A3E4D79BD65"></a><h4 id="SHARD-GUID-D0BC77A5-B733-4EF5-AF41-7A3E4D79BD65" class="sect4"><span class="enumeration_section">8.8.1</span>部署用户定义的SDB</h4>
                  <div>
                     <p>以下过程介绍如何使用ADD SHARD命令和Oracle Active Data Guard高可用性解决方案部署用户定义的分片数据库。</p>
                     <div class="section">
                        <p>用户定义的分片允许用户将数据映射到分片。有关用户定义的分片方法的更多概念信息，请参阅<a href="sharding-methods.html#GUID-DA34E219-A601-40B3-A6E4-6545CA2EBB0B" title="用户定义的分片允许您显式指定数据到各个分片的映射。当由于性能，监管或其他原因，某些数据需要存储在特定分片上时，使用它，并且管理员需要完全控制分片之间的移动数据。">用户</a>定义的分片。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>由于此过程描述了使用<a href="sharding-deployment.html#GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" title="Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。">Sharded Database Deployment简介中</a>详述的<code class="codeph">ADD SHARD</code>方法，因此必须首先创建要在其各自主机上用作分片的数据库。</span><div>
                              <p>分片数据库必须具有以下特征：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>他们必须在每台主机上都有一个关联的TNS监听器</p>
                                 </li>
                                 <li>
                                    <p>必须使用已知密码解锁<code class="codeph">GSMUSER</code>帐户</p>
                                 </li>
                                 <li>
                                    <p>必须向<code class="codeph">GSMUSER</code>授予<code class="codeph">SYSDG</code>和<code class="codeph">SYSBACKUP</code>权限 
                                    </p>
                                 </li>
                                 <li>
                                    <p>必须按原样配置主数据库和备用数据库</p>
                                 </li>
                                 <li>
                                    <p>应在相应的主数据库和备用数据库之间设置重做应用</p>
                                 </li>
                                 <li>
                                    <p>应启用闪回和强制日志记录</p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">compatible</code>参数必须至少设置为12.2.0</p>
                                 </li>
                                 <li>
                                    <p>必须使用服务器参数文件（SPFILE）</p>
                                 </li>
                                 <li>
                                    <p>必须在每个数据库中创建<code class="codeph">DATA_PUMP_DIR</code>目录对象，并且必须指向有效目录</p>
                                 </li>
                              </ul>
                              <p>然后，您必须验证是否正确设置了数据库以进行分片。在将每个数据库添加到配置之前，对每个数据库执行以下操作。</p><pre class="pre codeblock"><code>SQL&gt;在SQL上设置serveroutput&gt;执行DBMS_GSM_FIX.validateShard</code></pre><p>屏幕输出将包括需要针对任何问题进行分析的INFO，WARNING和ERROR信息。必须解决所有WARNING和ERROR消息。在进行更改以确认配置后重新运行<code class="codeph">validateShard()</code> 。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>连接到分片导演主机。</span><div><pre class="pre codeblock"><code>$ ssh <span class="variable" translate="no">os_user</span> @ <span class="variable" translate="no">shard_director1_host</span>
</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为当前会话设置全局服务管理器，并指定要管理它的凭据。</span><div><pre class="pre codeblock"><code>$ gdsctl GDSCTL&gt; set gsm -gsm sharddirector1 GDSCTL&gt; connect mysdbadmin / <span class="variable" translate="no">mysdbadmin_password</span></code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为您的业务案例所需的每个自定义分片分组添加分片空间到分片数据库配置。</span><div>
                              <p>分片空间包含主分片数据库和一个或多个活动备用数据库。</p>
                              <p>在此示例中，分片空间名为shspace1和shspace2。您可以选择自己的名字。</p><pre class="pre codeblock"><code>GDSCTL&gt; add shardspace -shardspace shspace1 -protectmode maxavailability GDSCTL&gt; add shardspace -shardspace shspace2 -protectmode maxavailability</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>将每个分片的主机地址添加到目录中的有效节点检查注册（VNCR）列表中，然后将分片添加到主分片组或备用分片组中，如以下示例所示。</span><div>
                              <div class="infoboxnote" id="GUID-D0BC77A5-B733-4EF5-AF41-7A3E4D79BD65__THEVALIDNODECHECKINGFORREGISTRATION-3F858F5D">
                                 <p class="notep1">注意：</p>
                                 <p>有效的节点检查注册（VNCR）功能提供了配置和动态更新分片控制器允许注册请求的一组IP地址，主机名或子网的功能。仅当请求源自有效节点时，才使用分片导向器进行数据库实例注册。默认情况下，分片管理层（基于Oracle全局数据服务框架）会自动为每次<code class="codeph">create shard</code>或<code class="codeph">add shard</code>片时运行远程数据库的主机添加VNCR条目。自动化（称为auto-VNCR）查找目标主机的公共IP地址，并自动为该IP地址添加VNCR条目。如果主机具有多个公共IP地址，则数据库注册的地址可能与使用auto-VNCR添加的地址不同，因此，许多注册被拒绝。如果目标数据库主机具有多个公共IP地址，建议您使用<code class="codeph">add invitednode</code>手动为此主机配置VNCR，或在GDSCTL中<code class="codeph">add invitedsubnet</code>命令。</p>
                                 <p>如果目标主机上有多个网卡（ <code class="codeph">/sbin/ifconfig</code>返回多个公共接口），请使用<code class="codeph">add invitednode</code>是安全的（在找出将用于路由数据包的接口之后）。
                                 </p>
                                 <p>如果对注册有任何疑问，请使用<code class="codeph">config vncr</code>并根据需要使用<code class="codeph">add invitednode</code> 。执行此操作没有任何害处，因为如果已添加节点，则自动VNCR会忽略它，如果您尝试在自动VNCR添加它之后添加它，您将收到一条警告，指出它已经存在。
                                 </p>
                              </div>
                              <p>以下示例显示如何使用<code class="codeph">ADD SHARD</code>命令添加四个分片，前两个分片是分片空间shspace1中的主分区和主分区备用分片，后两个是分片空间shspace2中的主分区和主分支备用分区。注意，原色被赋予区域1的区域，并且备用区域被赋予区域2。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt;添加invitenode <span class="variable" translate="no">shard_host_1</span> GDSCTL&gt;添加shard -connect <span class="variable" translate="no">shard_host_1</span> ：1521 / <span class="variable" translate="no">shard_database_name</span> -shardspace shspace1 -deploy_as primary -pwd <span class="variable" translate="no">GSMUSER_password</span> -region region1 GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_2</span> GDSCTL&gt; add shard -connect <span class="variable" translate="no">shard_host_2</span> ：1521 / <span class="variable" translate="no">shard_database_name</span> -shardspace shspace1 -deploy_as active_standby -pwd <span class="variable" translate="no">GSMUSER_password</span> -region region2 GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_3</span> GDSCTL&gt; add shard -connect <span class="variable" translate="no">shard_host_3</span> ：1521 / <span class="variable" translate="no">shard_database_name</span> -shardspace shspace2 -deploy_as primary -pwd <span class="variable" translate="no">GSMUSER_password</span> -region region1 GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_4</span> GDSCTL&gt; add shard -connect <span class="variable" translate="no">shard_host_4</span> ：1521 / <span class="variable" translate="no">shard_database_name</span> -shardspace shspace2 -deploy_as active_standby -pwd <span class="variable" translate="no">GSMUSER_password</span> -region region2</code></pre><p>如果要添加的分片数据库是可插拔数据库（PDB），则必须使用<code class="codeph">-cdb</code>选项<code class="codeph">ADD SHARD</code> <code class="codeph">-cdb</code>指定PDB分片所在的容器数据库（CDB）。此外，必须在<code class="codeph">ADD SHARD</code>命令之前使用<code class="codeph">ADD CDB</code>将CDB添加到目录中。有关<code class="codeph">ADD CDB</code>和<code class="codeph">ADD SHARD</code>的语法，请参阅“ <span><cite>Oracle数据库全局数据服务概念和管理指南”</cite></span> 。注意，在Oracle数据库<span class="italic">18c</span>中，只有一个PDB中的每个CDB允许是一个分片。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>从分片导向器检查配置。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; <span class="bold">config</span> Regions ----------------------- region1 region2 GSMs -------------------- --- sharddirector1 sharddirector2 Sharded Database ----------------------- udef_shpool数据库------------------ ----- sh1 sh2 sh3 sh4分片空间----------------------- shspace1 shspace2服务------------- ---------- GDSCTL挂起请求-----------------------命令对象状态------- ---- -  ------全局属性-----------------------名称：oradbcloud Master GSM：sharddirector1 DDL序列＃：0 GDSCTL&gt; <span class="bold">config vncr</span>名称组ID ---- -------- shard_host_1 shard_host_2 shard_host_3 shard_host_4 shard_catalog_host_IP GDSCTL&gt; <span class="bold">配置分片</span>名称分片空间状态状态区可用性---- ----------- ----- -  ----- ------ ------------ sh1 shspace1 U无region1  -  sh2 shspace1 U无region2  -  sh3 shspace2 U无region1  -  sh4 shspace2 U无region2  -</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>运行<code>DEPLOY</code>命令以创建分片和副本。</span><div>
                              <p><code>DEPLOY</code>命令需要一些时间才能运行，大约需要15到30分钟。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt;部署</code></pre><p>构建主分片和备用分片后， <code>DEPLOY</code>命令会配置启用了快速启动故障转移的Data Guard Broker。快速启动故障转移观察器将自动在备用组的分片控制器（此示例中为sharddirector2）上启动。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证是否已部署所有分片。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;配置分片名称分片空间状态状态区可用性---- ----------- ------ ----- ------ ------- ----- sh1 shspace1 Ok部署的region1 ONLINE sh2 shspace1 Ok已部署的region2 READ_ONLY sh3 shspace2 Ok已部署的region1 ONLINE sh4 shspace2 Ok已部署的region2 READ_ONLY</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证是否已注册所有分片。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;数据库数据库：“sh1”已注册：Y状态：确定ONS：N。角色：PRIMARY实例：1区域：region1已注册实例：udef_shpool％1数据库：“sh2”已注册：Y状态：确定ONS：N。角色： PH_STNDBY实例：1区域：region2已注册实例：udef_shpool％11数据库：“sh3”已注册：Y状态：确定ONS：N。角色：PRIMARY实例：1区域：region1已注册实例：udef_shpool％21数据库：“sh4”已注册： Y State：Ok ONS：N。角色：PH_STNDBY实例：1地区：region2已注册实例：udef_shpool％31</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>检查分片的配置。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; config shard -shard sh1名称：sh1分片空间：shspace1状态：Ok状态：已部署区域：region1连接字符串： <span class="variable" translate="no">shard_host_1</span> ：1521 / sh1：专用SCAN地址：ONS远程端口：0磁盘阈值，ms：20 CPU阈值， ％：75版本：18.0.0.0上次失败DDL：DDL错误：--- DDL ID失败：可用性：ONLINE支持的服务-----------------------姓名首选身份---- --------- ------</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>添加在所有主分片上运行的全局服务。</span><div>
                              <p>oltp_rw_srvc全局服务是客户端可用于连接到分片数据库的全局数据服务。oltp_rw_srvc服务在主分片上运行OLTP事务。同样，创建oltp_ro_srvc全局服务以在备用分片上运行只读工作负载。</p><pre class="pre codeblock"><code>GDSCTL&gt;添加服务-service oltp_rw_srvc -role primary GDSCTL&gt; config service名称网络名称Pool Started Preferred all ---- ------------ ---- -------  - ----------- oltp_rw_srvc oltp_rw_srvc.cust_sdb.oracdbcloud udef_shpool否是</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>启动oltp_rw_srvc全局服务。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;启动服务-service oltp_rw_srvc GDSCTL&gt;状态服务服务“oltp_rw_srvc.cust_sdb.oradbcloud”有2个实例。亲和力：ANYWHERE实例“udef_shpool％1”，名称：“sh1”，db：“sh1”，region：“region1”，状态：就绪。实例“udef_shpool％21”，名称：“sh3”，db：“sh3”，区域：“region1”，状态：就绪。</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为只读工作负载添加全局服务以在备用分片上运行。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;添加服务-service oltp_ro_srvc -role physical_standby GDSCTL&gt;配置服务名称网络名称池启动首选全部---- ------------ ---- -------  - ----------- oltp_rw_srvc oltp_rw_srvc.cust_sdb.oracdbcloud cust_sdb是是oltp_ro_srvc oltp_ro_srvc.cust_sdb.oracdbcloud cust_sdb否是</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>启动只读服务，并验证全局服务的状态。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;启动服务-service oltp_ro_srvc GDSCTL&gt;状态服务服务“oltp_ <span class="bold">ro</span> _srvc.cust_sdb.oradbcloud”有2个实例。亲和力：ANYWHERE实例“udef_shpool％11”，名称：“sh2”，db：“sh2”，region：“region2”，状态：就绪。实例“udef_shpool％31”，名称：“sh4”，db：“sh4”，region：“region2”，状态：就绪。服务“oltp_ <span class="bold">rw</span> _srvc.cust_sdb.oradbcloud”有2个实例。亲和力：ANYWHERE实例“udef_shpool％1”，名称：“sh1”，db：“sh1”，region：“region1”，状态：就绪。实例“udef_shpool％21”，名称：“sh3”，db：“sh3”，区域：“region1”，状态：就绪。</code></pre></div>
                        </li>
                     </ol>
                     <div class="section"></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-D0BC77A5-B733-4EF5-AF41-7A3E4D79BD65__GUID-0A88E5FE-1FBD-4DD8-BEDE-DB97D221C345">
                        <p class="notep1">也可以看看：</p>
                        <p>有关GDSCTL命令用法的详细信息，请参见<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=GSMUG-GUID-3285C437-78F8-4339-AAAB-33DBB7A9D400" target="_blank"><span><cite>“Oracle数据库全局数据服务概念和管理指南”</cite></span></a></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-6E11AA09-B7D3-45FB-9693-33B1329F7396">创建和部署用户定义的SDB</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
               <div class="sect3"><a id="GUID-97C5E0B3-F870-4F4E-9507-9644A73E6C76" name="GUID-97C5E0B3-F870-4F4E-9507-9644A73E6C76"></a><h4 id="SHARD-GUID-97C5E0B3-F870-4F4E-9507-9644A73E6C76" class="sect4"><span class="enumeration_section">8.8.2</span>为用户定义的SDB创建模式</h4>
                  <div>
                     <p>为SDB创建模式用户，表空间集，分片表和重复表。验证DDL是否已传播到所有分片，并在连接到分片时验证具有快速启动故障转移的自动Data Guard Broker配置。</p>
                     <ol>
                        <li class="stepexpand"><span>连接到分片目录数据库，创建应用程序模式用户，并向用户授予权限和角色。</span><div>
                              <p>在此示例中，应用程序模式用户称为app_schema。</p><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt; alter session enable shard ddl; SQL&gt; create user app_schema由<span class="variable" translate="no">app_schema_password</span>标识; SQL&gt;授予app_schema所有权限; SQL&gt;将gsmadmin_role授予app_schema; SQL&gt;将select_catalog_role授予app_schema; SQL&gt; grant connect，resource to app_schema; SQL&gt;将dba授予app_schema; SQL&gt;将dbms_crypto上的execute赋予app_schema;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为分片表创建表空间。</span><div><pre class="pre codeblock"><code>SQL&gt; CREATE TABLESPACE c1_tsp DATAFILE SIZE 100M autoextend on next 10M maxsize无限范围管理本地段空间管理自动在shardspace shspace1; SQL&gt; CREATE TABLESPACE c2_tsp DATAFILE SIZE 100M autoextend on next 10M maxsize无限范围管理本地段空间管理自动在shardspace shspace2;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>如果在任何列中使用LOB，则可以为LOB指定表空间。</span><div><pre class="pre codeblock"><code>SQL&gt; CREATE TABLESPACE lobts1 ...在shardspace shspace1; SQL&gt; CREATE TABLESPACE lobts2 ...在shardspace shspace2;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为重复的表创建表空间。</span><div>
                              <p>在此示例中，重复的表是示例Customers-Orders-Products模式中的Products表。</p><pre class="pre codeblock"><code>SQL&gt; CREATE TABLESPACE products_tsp datafile size 100m autoextend on next 10M maxsize unlimited extent management local local uniform size 1m;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为根表创建分片表。</span><div>
                              <p>在此示例中，根表是Customers-Orders-Products模式示例中的Customers表。</p><pre class="pre codeblock"><code>SQL&gt; CONNECT app_schema / <span class="variable" translate="no">app_schema_password</span> SQL&gt; ALTER SESSION ENABLE SHARD DDL; SQL&gt; CREATE SHARDED TABLE Customers（CustId VARCHAR2（60）NOT NULL，CustProfile VARCHAR2（4000），Passwd RAW（60），CONSTRAINT pk_customers PRIMARY KEY（CustId），CONSTRAINT json_customers CHECK（CustProfile IS JSON））PARTITION BY <span class="bold">RANGE</span> （CustId） （ <span class="bold">PARTITION ck1</span>值小于（'m'）表空间ck1_tsp， <span class="bold">PARTITION ck2</span>值小于（MAXVALUE）表空间ck2_tsp）;</code></pre><div class="infoboxnote" id="GUID-97C5E0B3-F870-4F4E-9507-9644A73E6C76__GUID-C4911510-CA99-421C-A0F6-9554B63484A1">
                                 <p class="notep1">注意：</p>
                                 <p>如果分片表中的任何列包含LOB，则CREATE SHARDED TABLE语句可以包含LOB表空间，如此处所示。</p><pre class="pre codeblock"><code>SQL&gt; CREATE SHARDED TABLE Customers（CustId VARCHAR2（60）NOT NULL，CustProfile VARCHAR2（4000），Passwd RAW（60）， <span class="bold">image BLOB，</span> CONSTRAINT pk_customers PRIMARY KEY（CustId），CONSTRAINT json_customers CHECK（CustProfile IS JSON））PAR BY BY BY RANGE （CustId）（PARTITION ck1值小于（'m'）表空间ck1_tsp <span class="bold">lob（图像）存储为（tablespace lobts1）</span> ，PARTITION ck2值小于（MAXVALUE）表空间ck2_tsp <span class="bold">lob（image）存储为（tablespace lobts2）</span> ）;</code></pre></div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>为表系列中的其他表创建分片表。</span><div>
                              <p>在此示例中，为示例Customers-Orders-Products架构中的Orders和LineItems表创建分片表。</p>
                              <p>首先创建Orders sharded表：</p><pre class="pre codeblock"><code>SQL&gt; CREATE SHARDED TABLE Orders（OrderId INTEGER NOT NULL，CustId VARCHAR2（60）NOT NULL，OrderDate TIMESTAMP NOT NULL，SumTotal NUMBER（19,4），Status CHAR（4），CONSTRAINT pk_orders PRIMARY KEY（CustId，OrderId），CONSTRAINT fk_orders_parent FOREIGN KEY（CustId）REFERENCES DELETE CASCADE）客户参考分区（fk_orders_parent）;</code></pre><p>创建用于OrderId列的序列。</p><pre class="pre codeblock"><code>SQL&gt; CREATE SEQUENCE Orders_Seq;</code></pre><p>为LineItem创建分片表</p><pre class="pre codeblock"><code>SQL&gt; CREATE SHARDED TABLE LineItems（OrderId INTEGER NOT NULL，CustId VARCHAR2（60）NOT NULL，ProductId INTEGER NOT NULL，Price NUMBER（19,4），QTY NUMBER，CONSTRAINT pk_items PRIMARY KEY（CustId，OrderId，ProductId），CONSTRAINT fk_items_parent FOREIGN KEY（CustId，OrderId）REFERENCES OR DELETE CASCADE）参考分区（fk_items_parent）;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>创建任何所需的重复表。</span><div> 
                              <p>在此示例中，Products表是一个重复的对象。</p><pre class="pre codeblock"><code>SQL&gt; CREATE DUPLICATED TABLE产品（由默认为IDENTITY PRIMARY KEY生成的ProductId INTEGER，名称VARCHAR2（128），DescrUri VARCHAR2（128），LastPrice NUMBER（19,4））TABLESPACE products_tsp;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>从分片导向器主机，验证在创建表空间期间没有失败。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; show ddl id DDL Text Failed shards  -  -------- ------------- 3 grant create table，create procedure，...4授予app_schema 5无限制的表空间，将select_catalog_role授予app_schema 6创建表空间c1_tsp DATAFILE SIZ ...7创建表空间c2_tsp DATAFILE SIZ ...8创建SHARDED TABLE客户（Cu ...9创建SHARDED TABLE订单（订购......10创建SHARDED TABLE LineItems（或......11创建表空间products_tsp datafi ...12创建物质化视图“APP_SCHEMA”......</code></pre><div class="infoboxnote" id="GUID-97C5E0B3-F870-4F4E-9507-9644A73E6C76__GUID-57F55490-D5AB-4801-BA0D-B7D4FE6B3802">
                                 <p class="notep1">注意：</p><code class="codeph">show ddl</code>命令输出可能会被截断。您可以在目录上运行<code class="codeph">SELECT ddl_text FROM gsmadmin_internal.ddl_requests</code>以查看语句的全文。
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证每个分片上是否没有DDL错误。</span><div>
                              <p>在<code>config shard</code>每个分片上运行<code>config shard</code>和<code>config chunks</code>命令。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt; config shard -shard sh1名称：sh1分片空间：shspace1状态：Ok状态：已部署区域：region1连接字符串： <span class="variable" translate="no">shard_host_1</span> ：1521 / sh1：专用SCAN地址：ONS远程端口：0磁盘阈值，ms：20 CPU阈值， ％：75版本：18.0.0.0 <span class="bold">上次失败DDL：DDL错误：--- DDL ID失败：</span>可用性：ONLINE机架：支持的服务--------------------- ---名称首选状态---- --------- ------ oltp_ro_srvc是启用oltp_rw_srvc是启用GDSCTL&gt; config chunks Chunks -------------- ----------数据库从To -------- ----  - <span class="bold">sh1 1 1 sh2 1 1 sh3 2 2 sh4 2 2</span> </code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证是否为所有分片创建了为分片表系列创建的表空间以及为重复表创建的表空间。</span><div>
                              <p>表空间集中的表空间数基于您在<code>create shardcatalog</code>命令中指定的块数。
                              </p>
                              <p>使用分片目录创建示例中指定的12个前6个块设置的表空间，以及下面的示例中显示了重复的Products表空间。</p><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt;选择TABLESPACE_NAME，BYTES / 1024/1024 MB，来自sys.dba_data_files，由tablespace_name命令; TABLESPACE_NAME MB ----------------------- ---------- <span class="bold">C1_TSP 100 PRODUCTS_TSP 10</span> SYSAUX 722.1875 SYSEXT 39 SYSTEM 782.203125 SYS_SHARD_TS 100 UD1 470 7选中的行。
</code></pre><p>在配置中的所有分片上重复此步骤。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证是否在所有分片上创建了块和块表空间。</span><div><pre class="pre codeblock"><code>SQL&gt; set linesize 140 SQL&gt; column table_name format a20 SQL&gt; column tablespace_name format a20 SQL&gt; column partition_name format a20 SQL&gt; show parameter db_unique_name NAME TYPE VALUE ---------------- --- -------- ------------------------------ db_unique_name string sh1 SQL&gt; select table_name，partition_name，tablespace_name from dba_tab_partitions其中tablespace_name类似于'C％TSP_SET_1'由tablespace_name排序; TABLE_NAME PARTITION_NAME TABLESPACE_NAME ---------------- ---------------- --------------- -----客户CK1 C1_TSP订购CK1 C1_TSP LINEITEMS CK1 C1_TSP</code></pre><p>在配置中的所有分片上重复此步骤。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证是否已创建分片和重复的表。</span><div>
                              <p>以分片目录数据库和每个分片上的应用程序模式用户身份登录。</p>
                              <p>以下示例显示了将数据库分片上的表作为app_schema用户进行查询。</p><pre class="pre codeblock"><code>$ sqlplus app_schema / <span class="variable" translate="no">app_schema_password</span>已连接。SQL&gt;从user_tables中选择table_name; TABLE_NAME ------------------------------------------------- ----------------------客户订购LINEITEMS产品USLOG $ _PRODUCTS</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证Data Guard Broker自动快速启动故障转移配置是否已完成。</span><div><pre class="pre codeblock"><code>$ ssh os_username @ <span class="variable" translate="no">shard_host_1</span> $ <span class="variable" translate="no">shard_host_1</span> DGMGRL&gt; connect sys / <span class="variable" translate="no">password</span>连接到“sh1”连接为SYSDG。 DGMGRL&gt; show configuration配置 -  sh1保护模式：MaxPerformance成员： <span class="bold">sh1  - 主数据库sh2  - （*）物理备用数据库</span>快速启动故障转移： <span class="bold">启用</span>配置状态： <span class="bold">成功</span> （状态更新15秒前）DGMGRL&gt; show database sh1数据库 -  sh1角色：PRIMARY预期状态：TRANSPORT-ON实例：sh1数据库状态： <span class="bold">SUCCESS</span> DGMGRL&gt; show database sh2数据库 -  sh2角色：PHYSICAL STANDBY预期状态：APPLY-ON传输延迟：0秒（计算0秒前）应用滞后：0秒（计算0秒前）平均应用率：2.00 KByte / s实时查询：ON实例：sh2数据库状态： <span class="bold">SUCCESS</span> DGMGRL&gt; show fast_start failover快速启动故障转移： <span class="bold">启用</span>阈值：30秒目标： <span class="bold">sh2</span>观察者： <span class="variable" translate="no">shard_director_host</span>滞后限制：30秒关闭主要：TRUE自动恢复：TRUE观察者重新连接:(无）观察者覆盖：FALSE可配置故障转移条件健康状况：损坏的控制文件是损坏的字典是YES Inaccessi ble Logfile NO Stuck Archiver NO Datafile写入错误是Oracle错误条件:(无）</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>找到快速启动故障转移观察器。</span><div>
                              <p>连接到分片目录数据库并运行以下命令：</p><pre class="pre codeblock"><code>$ ssh oracle @shard6 $ ps -ef | grep dgmgrl oracle 8210 8089 0 22:18 pts / 4 00:00:00 grep dgmgrl oracle 20189 1 0 02:57？00:02:40 dgmgrl -delete_script @ / u01 / app / oracle / product / 18.0.0 / gsmhome_1 / network / admin / gsm_observer_1.cfg oracle 20193 1 0 02:57？00:02:43 dgmgrl -delete_script @ / u01 / app / oracle / product / 18.0.0 / gsmhome_1 / network / admin / gsm_observer_2.cfg</code></pre></div>
                        </li>
                     </ol>
                     <div class="section"></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-97C5E0B3-F870-4F4E-9507-9644A73E6C76__GUID-81030823-1335-4D74-8266-058942F5FFD3">
                        <p class="notep1">也可以看看：</p>
                        <p>有关GDSCTL命令用法的信息，请参见<a href="../gsmug/gdsctl-sharding-env.html#GSMUG-GUID-3285C437-78F8-4339-AAAB-33DBB7A9D400" target="_blank"><span><cite>“Oracle数据库全局数据服务概念和管理指南”</cite></span></a></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-6E11AA09-B7D3-45FB-9693-33B1329F7396">创建和部署用户定义的SDB</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
            <div class="sect2"><a id="GUID-C43E1E4A-DA8F-4556-9EE7-39097C0276BC" name="GUID-C43E1E4A-DA8F-4556-9EE7-39097C0276BC"></a><h3 id="SHARD-GUID-C43E1E4A-DA8F-4556-9EE7-39097C0276BC" class="sect3"><span class="enumeration_section">8.9</span>创建和部署复合SDB</h3>
               <div>
                  <p>要部署复合SDB，您必须安装所需的Oracle Sharding软件组件，配置复合SDB的对象并创建架构。</p>
                  <p>复合分片方法允许您为由一致哈希分区的表中的不同数据子集创建多个分片空间。分片<span class="italic">空间</span>是一<span class="italic">组分</span>片，用于存储与范围或键值列表相对应的数据。
                  </p>
                  <p>以下主题描述了部署复合SDB的任务。</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-BD9885B8-55A8-45F8-B29D-5D89BF3DB1CE">部署复合SDB</a><br>要部署复合SDB，您需要创建分片组和分片，执行<code>DEPLOY</code>命令，并创建基于角色的全局服务。
                     </li>
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-D2098302-8636-41E7-ADEA-07099C882F32">为复合SDB创建架构</a><br>为SDB创建模式用户，表空间集，分片表和重复表。验证DDL是否已传播到所有分片，并在连接到分片时验证具有快速启动故障转移的自动Data Guard Broker配置。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-BD9885B8-55A8-45F8-B29D-5D89BF3DB1CE" name="GUID-BD9885B8-55A8-45F8-B29D-5D89BF3DB1CE"></a><h4 id="SHARD-GUID-BD9885B8-55A8-45F8-B29D-5D89BF3DB1CE" class="sect4"><span class="enumeration_section">8.9.1</span>部署复合SDB</h4>
                  <div>
                     <p>要部署复合SDB，您需要创建分片组和分片，执行<code>DEPLOY</code>命令，并创建基于角色的全局服务。
                     </p>
                     <div class="section">此部署过程中使用的示例基于全局分布方案，其中为美国和欧洲创建了单独的分片空间和分片组。</div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>连接到分片导向器主机，并验证环境变量。</span><div><pre class="pre codeblock"><code>$ ssh <span class="variable" translate="no">os_user</span> <span class="variable" translate="no">shard_director_home</span> $ env | grep ORA ORACLE_BASE = / u01 / app / oracle ORACLE_HOME = / u01 / app / oracle / product / 18.0.0 / gsmhome_1</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为当前会话设置全局服务管理器，并指定要管理它的凭据。</span><div><pre class="pre codeblock"><code>$ gdsctl GDSCTL&gt; set gsm -gsm sharddirector1 GDSCTL&gt; connect mysdbadmin / <span class="variable" translate="no">mysdbadmin_password</span></code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为您的业务案例所需的每个自定义分片组添加分片空间和分片组。</span><div>
                              <p>在此示例中，为美国和欧洲客户创建了分片空间和分片组。您可以选择自己的名字。</p><pre class="pre codeblock"><code>GDSCTL&gt; add shardspace -shardspace cust_america GDSCTL&gt; add shardgroup -shardspace cust_america -shardgroup america_shgrp1 -deploy_as primary -region region1 GDSCTL&gt; add shardspace -shardspace cust_europe GDSCTL&gt; add shardgroup -shardspace cust_europe -shardgroup europe_shgrp1 -deploy_as primary -region region2</code></pre><div class="infoboxnote" id="GUID-BD9885B8-55A8-45F8-B29D-5D89BF3DB1CE__GUID-96539EAC-394A-406F-A628-A3BC27D2FAE3">
                                 <p class="notep1">注意：</p>
                                 <p>对于生产部署，必须使用<code class="codeph">add shardgroup</code>命令为高可用性创建其他分片<code class="codeph">add shardgroup</code></p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证分片空间和分片组配置。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; config shardspace SHARDSPACE Chunks ---------- ------ cust_america 12 cust_europe 12 shardspaceora 12 GDSCTL&gt; config shardgroup Shard Group Chunks Region SHARDSPACE -----------  - ---- ------ ---------- america_shgrp1 12 region1 cust_america europe_shgrp1 12 region2 cust_europe</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证分片数据库配置。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; config区域------------------------ region1 region2 GSMs ------------------- ----- sharddirector1 sharddirector2 Sharded Database ------------------------ cust_sdb_comp数据库--------------- ---------碎片组------------------------ america_shgrp1 europe_shgrp1碎片空间----------- ------------- cust_america cust_europe shardspaceora Services ------------------------ GDSCTL待处理请求------ ------------------命令对象状态------- ------ ------全局属性-------- ----------------名称：oradbcloud Master GSM：sharddirector1 DDL序列＃：0</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>将每个分片的主机地址添加到目录中的有效节点检查注册（VNCR）列表中，然后在主分片组或备用分片组中创建分片，如以下示例所示。</span><div>
                              <div class="infoboxnote" id="GUID-BD9885B8-55A8-45F8-B29D-5D89BF3DB1CE__GUID-7FE92210-2C8A-4F7A-A230-73A8F080AF70">
                                 <p class="notep1">注意：</p>
                                 <p>有效的节点检查注册（VNCR）功能提供了配置和动态更新分片控制器允许注册请求的一组IP地址，主机名或子网的功能。仅当请求源自有效节点时，才使用分片导向器进行数据库实例注册。默认情况下，分片管理层（基于Oracle全局数据服务框架）会自动为每次<code class="codeph">create shard</code>或<code class="codeph">add shard</code>片时运行远程数据库的主机添加VNCR条目。自动化（称为auto-VNCR）查找目标主机的公共IP地址，并自动为该IP地址添加VNCR条目。如果主机具有多个公共IP地址，则数据库注册的地址可能与使用auto-VNCR添加的地址不同，因此，许多注册被拒绝。如果目标数据库主机具有多个公共IP地址，建议您使用<code class="codeph">add invitednode</code>手动为此主机配置VNCR，或在GDSCTL中<code class="codeph">add invitedsubnet</code>命令。</p>
                                 <p>如果目标主机上有多个网卡（ <code class="codeph">/sbin/ifconfig</code>返回多个公共接口），请使用<code class="codeph">add invitednode</code>是安全的（在找出将用于路由数据包的接口之后）。
                                 </p>
                                 <p>如果对注册有任何疑问，请使用<code class="codeph">config vncr</code>并根据需要使用<code class="codeph">add invitednode</code> 。执行此操作没有任何害处，因为如果已添加节点，则自动VNCR会忽略它，如果您尝试在自动VNCR添加它之后添加它，您将收到一条警告，指出它已经存在。
                                 </p>
                              </div>
                              <p>该示例显示了如何创建四个分片，其中两个在America shardgroup中，两个在Europe shardgroup中。<span class="variable" translate="no">os_credential</span>是您在每个主机上创建的操作系统凭据。
                              </p>
                              <p>创建分片时，您还可以使用<code class="codeph">-sys_password</code>在<code class="codeph">CREATE SHARD</code> <code class="codeph">-sys_password</code>设置SYS密码，如以下示例所示。这在运行<code class="codeph">DEPLOY</code>时创建分片后设置SYS密码。<code class="codeph">CREATE SHARD</code>还有其他可选参数，允许您自定义数据库参数，存储和文件位置，侦听器端口号等，这些参数在<span><cite>Oracle数据库全局数据服务概念和管理指南</cite></span>附录中进行了介绍。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt;添加invitenode <span class="variable" translate="no">shard_host_1</span> GDSCTL&gt; create shard -shardgroup america_shgrp1 -destination <span class="variable" translate="no">shard_host_1</span> -credential <span class="variable" translate="no">os_credential</span> -sys_password GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_2</span> GDSCTL&gt; create shard -shardgroup america_shgrp1 -destination <span class="variable" translate="no">shard_host_2</span> -credential <span class="variable" translate="no">os_credential</span> -sys_password GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_3</span> GDSCTL&gt; create shard  - shardgroup europe_shgrp1 -destination <span class="variable" translate="no">shard_host_3</span> -credential <span class="variable" translate="no">os_credential</span> -sys_password GDSCTL&gt; add invitenode <span class="variable" translate="no">shard_host_4</span> GDSCTL&gt; create shard -shardgroup europe_shgrp1 -destination <span class="variable" translate="no">shard_host_4</span> -credential <span class="variable" translate="no">os_credential</span> -sys_password</code></pre><p>如果您使用的<a href="sharding-deployment.html#GUID-059FD35C-C1C2-4B14-9A76-B3632A6080DC" title="Oracle Sharding提供了自动部署分片数据库的功能，该数据库包括分片和副本。">是Sharded Database Deployment简介中</a>描述的<code class="codeph">ADD SHARD</code>方法，请使用以下命令代替上面示例中的<code class="codeph">CREATE SHARD</code>命令。如果要添加的分片数据库是可插拔数据库（PDB），则必须使用<code class="codeph">-cdb</code>选项<code class="codeph">ADD SHARD</code> <code class="codeph">-cdb</code>指定PDB分片所在的容器数据库（CDB）。此外，必须在<code class="codeph">ADD SHARD</code>命令之前使用<code class="codeph">ADD CDB</code>将CDB添加到目录中。有关<code class="codeph">ADD CDB</code>和<code class="codeph">ADD SHARD</code>的语法，请参阅“ <span><cite>Oracle数据库全局数据服务概念和管理指南”</cite></span> 。注意，在Oracle数据库<span class="italic">18c</span>中，只有一个PDB中的每个CDB允许是一个分片。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt;添加shard -shardgroup america_shgrp1 -connect <span class="variable" translate="no">shard_host</span> ： <span class="variable" translate="no">TNS_listener_port</span> / <span class="variable" translate="no">shard_database_name</span> -pwd <span class="variable" translate="no">GSMUSER_password</span></code></pre></div>
                        </li>
                        <li class="stepexpand"><span>从分片导向器检查配置。</span><div>
                              <p>请注意，分片名称sh1，sh2，sh3和sh4是系统生成的分片名称。</p><pre class="pre codeblock"><code>GDSCTL&gt; config shard Name Shard Group Status State Region Availability ---- ----------- ------ ----- ------ ------- ----- sh1 america_shgrp1 U无区域1  -  sh2 america_shgrp1 U无区域1  -  sh3 europe_shgrp1 U无区域2  -  sh4 europe_shgrp1 U无区域2  -  GDSCTL&gt; config vncr名称组ID ---- -------- shard_host_1 shard_host_2 shard_host_3 shard_host_4 shard_catalog_host_IP</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>运行<code>DEPLOY</code>命令以创建分片。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;部署</code></pre><p><code>DEPLOY</code>命令需要一些时间才能运行，大约需要15到30分钟。<code>DEPLOY</code>命令使用DBCA创建分片。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证是否已部署所有分片。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; config shard Name Shard Group Status State Region Availability ---- ----------- ------ ----- ------ ------- ----- sh1 america_shgrp1 Ok Deployed region1 ONLINE sh2 america_shgrp1 Ok Deployed region1 ONLINE sh3 europe_shgrp1 Ok Deployed region2 ONLINE sh4 europe_shgrp1 Ok Deployed region2 ONLINE</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证是否已注册所有分片。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;数据库数据库：“sh1”已注册：Y状态：确定ONS：N。角色：PRIMARY实例：1区域：region1已注册实例：cust_sdb_comp％1数据库：“sh2”已注册：Y状态：确定ONS：N。角色：主要实例：1区域：region1已注册实例：cust_sdb_comp％11数据库：“sh3”已注册：Y状态：确定ONS：N。角色：PRIMARY实例：1区域：region2已注册实例：cust_sdb_comp％21数据库：“sh4”已注册： Y状态：Ok ONS：N。角色：PRIMARY实例：1区域：region2已注册实例：cust_sdb_comp％31</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>检查分片的配置。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; config shard -shard sh1名称：sh1 Shard组：america_shgrp1状态：Ok状态：已部署区域：region1连接字符串：shard1：1521 / sh1：专用SCAN地址：ONS远程端口：0磁盘阈值，ms：20 CPU阈值， ％：75版本：18.0.0.0上次失败DDL：DDL错误：--- DDL ID失败：可用性：ONLINE支持的服务----------------------- - 姓名首选状态---- --------- ------</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>添加在所有主分片上运行的全局服务。</span><div>
                              <p>oltp_rw_srvc全局服务是全局数据服务侦听器，它有助于将连接从客户端路由到实际数据库。oltp_rw_srvc服务在主分片上运行OLTP事务。</p><pre class="pre codeblock"><code>GDSCTL&gt;添加服务-service oltp_rw_srvc GDSCTL&gt;配置服务名称网络名称池启动首选全部---- ------------ ---- ------- ----- -------- oltp_rw_srvc oltp_rw_srvc.cust_sdb_comp.or cust_sdb_comp否是adbcloud</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>启动oltp_rw_srvc全局服务。</span><div><pre class="pre codeblock"><code>GDSCTL&gt;启动服务-service oltp_rw_srvc GDSCTL&gt;状态服务服务“oltp_rw_srvc.cust_sdb_comp.oradbcloud”有4个实例。亲和性：ANYWHERE实例“cust_sdb_comp％1”，名称：“sh1”，db：“sh1”，region：“region1”，状态：就绪。实例“cust_sdb_comp％11”，名称：“sh2”，db：“sh2”，region：“region1”，状态：就绪。实例“cust_sdb_comp％21”，名称：“sh3”，db：“sh3”，区域：“region2”，状态：就绪。实例“cust_sdb_comp％31”，名称：“sh4”，db：“sh4”，区域：“region2”，状态：就绪。
</code></pre></div>
                        </li>
                     </ol>
                     <div class="section"></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-BD9885B8-55A8-45F8-B29D-5D89BF3DB1CE__GUID-E0A1E37B-F524-4407-A925-3FCBF53C3379">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=GSMUG-GUID-3285C437-78F8-4339-AAAB-33DBB7A9D400" target="_blank"><span><cite>“Oracle数据库全球数据服务概念和管理指南”</cite></span></a></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-C43E1E4A-DA8F-4556-9EE7-39097C0276BC" title="要部署复合SDB，您必须安装所需的Oracle Sharding软件组件，配置复合SDB的对象并创建架构。">创建和部署复合SDB</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
               <div class="sect3"><a id="GUID-D2098302-8636-41E7-ADEA-07099C882F32" name="GUID-D2098302-8636-41E7-ADEA-07099C882F32"></a><h4 id="SHARD-GUID-D2098302-8636-41E7-ADEA-07099C882F32" class="sect4"><span class="enumeration_section">8.9.2</span>为复合SDB创建模式</h4>
                  <div>
                     <p>为SDB创建模式用户，表空间集，分片表和重复表。验证DDL是否已传播到所有分片，并在连接到分片时验证具有快速启动故障转移的自动Data Guard Broker配置。</p>
                     <ol>
                        <li class="stepexpand"><span>连接到分片目录主机，并将ORACLE_SID设置为分片目录名称。</span></li>
                        <li class="stepexpand"><span>连接到分片目录数据库，创建应用程序模式用户，并向用户授予权限和角色。</span><div>
                              <p>在此示例中，应用程序模式用户称为app_schema。</p><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt; connect / as sysdba SQL&gt; alter session enable shard ddl; SQL&gt; create user app_schema由<span class="variable" translate="no">app_schema_password</span>标识; SQL&gt; grant connect，resource，alter session to app_schema; SQL&gt;将dbms_crypto上的execute赋予app_schema; SQL&gt; grant create table，create procedure，create tablespace，create materialized view to app_schema; SQL&gt;向app_schema授予无限制的表空间; SQL&gt;将select_catalog_role授予app_schema; SQL&gt;授予app_schema所有权限; SQL&gt;将gsmadmin_role授予app_schema; SQL&gt;将dba授予app_schema;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为分片表创建表空间集。</span><div><pre class="pre codeblock"><code>SQL&gt; CREATE TABLESPACE使用模板在分区空间cust_america中设置TSP_SET_1（数据文件大小100m自动扩展，在下一个10M maxsize无限范围管理本地段空间管理自动）; SQL&gt; CREATE TABLESPACE SET TSP_SET_2在shardspace cust_europe中使用模板（数据文件大小100m自动扩展，在下一个10M maxsize无限范围管理本地段空间管理自动）;</code></pre><p>创建表空间集时，指定shardspace是可选的。如果未在命令中指定分片空间，则使用默认分片空间。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>如果在任何列中使用LOB，则可以为LOB指定表空间集。</span><div><pre class="pre codeblock"><code>SQL&gt; CREATE TABLESPACE SET LOBTS1在shardspace cust_america ...; SQL&gt; CREATE TABLESPACE SET LOBTS2在shardspace cust_europe ...;</code></pre><div class="infoboxnote" id="GUID-D2098302-8636-41E7-ADEA-07099C882F32__GUID-385821D7-C68A-466A-8BDF-D302F2B964A6">
                                 <p class="notep1">注意：</p>
                                 <p>在复合分片中，无法在子分区级别指定LOB的表空间集。</p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>为重复的表创建表空间。</span><div>
                              <p>在此示例中，重复的表是示例Customers-Orders-Products模式中的Products表。</p><pre class="pre codeblock"><code>CREATE TABLESPACE products_tsp datafile size 100m autoextend on next 10M maxsize unlimited extent management local local uniform size 1m;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>为根表创建分片表。</span><div>
                              <p>在此示例中，根表是Customers-Orders-Products模式示例中的Customers表。</p><pre class="pre codeblock"><code>connect app_schema / <span class="variable" translate="no">app_schema_password</span> alter session enable shard ddl; CREATE SHARDED TABLE客户（CustId VARCHAR2（60）NOT NULL，FirstName VARCHAR2（60），LastName VARCHAR2（60），Class VARCHAR2（10），Geo VARCHAR2（8），CustProfile VARCHAR2（4000），Passwd RAW（60），CONSTRAINT pk_customers PRIMARY KEY（CustId），CONSTRAINT json_customers CHECK（CustProfile IS JSON））partitionset by list（GEO）分区一致哈希（CustId）分区auto（partitionset america values（'AMERICA'）tablespace set tsp_set_1，partitionset europe values（'EUROPE '）tablespace set tsp_set_2）;</code></pre><div class="infoboxnote" id="GUID-D2098302-8636-41E7-ADEA-07099C882F32__GUID-C89200B3-3D47-40F7-B05E-AADD1DB6C1DA">
                                 <p class="notep1">注意：</p>
                                 <p>如果分片表中的任何列包含LOB，则CREATE SHARDED TABLE语句可以包含LOB表空间集，如此处所示。</p><pre class="pre codeblock"><code>CREATE SHARDED TABLE客户（CustId VARCHAR2（60）NOT NULL，FirstName VARCHAR2（60），LastName VARCHAR2（60），Class VARCHAR2（10），Geo VARCHAR2（8）NOT NULL，CustProfile VARCHAR2（4000），Passwd RAW（60） ， <span class="bold">image BLOB，</span> CONSTRAINT pk_customers PRIMARY KEY（CustId），CONSTRAINT json_customers CHECK（CustProfile IS JSON））partitionset by list（GEO）partition by consistent hash（CustId）partitions auto（partitionset america values（'AMERICA'）tablespace set tsp_set_1 <span class="bold">lob（存储为（表空间设置lobts1）</span> ，partitionset欧洲值（'EUROPE'）表空间设置tsp_set_2 <span class="bold">lob（图像）存储为（表空间设置lobts2）</span> ）;</code></pre></div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>为表系列中的其他表创建分片表。</span><div>
                              <p>在此示例中，为示例Customers-Orders-Products架构中的Orders和LineItems表创建分片表。</p>
                              <p>创建用于OrderId列的序列。</p><pre class="pre codeblock"><code>创建序列订单_Seq;</code></pre><p>首先创建Orders sharded表：</p><pre class="pre codeblock"><code>CREATE SHARDED TABLE Orders（OrderId INTEGER NOT NULL，CustId VARCHAR2（60）NOT NULL，OrderDate TIMESTAMP NOT NULL，SumTotal NUMBER（19,4），Status CHAR（4），约束pk_orders主键（CustId，OrderId），约束fk_orders_parent foreign key（CustId）引用删除级联上的客户）按引用分区（fk_orders_parent）;</code></pre><p>为LineItem创建分片表</p><pre class="pre codeblock"><code>CREATE SHARDED TABLE LineItems（OrderId INTEGER NOT NULL，CustId VARCHAR2（60）NOT NULL，ProductId INTEGER NOT NULL，Price NUMBER（19,4），Qty NUMBER，约束pk_items主键（CustId，OrderId，ProductId），约束fk_items_parent外键（CustId，OrderId）引用删除级联的订单）按引用分区（fk_items_parent）;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>创建任何所需的重复表。</span><div> 
                              <p>在此示例中，Products表是一个重复的对象。</p><pre class="pre codeblock"><code>CREATE DUPLICATED TABLE产品（ProductId INTEGER由DEFAULT生成IDENTITY PRIMARY KEY，Name VARCHAR2（128），DescrUri VARCHAR2（128），LastPrice NUMBER（19,4））tablespace products_tsp;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>从分片导向器主机，验证在创建表空间期间没有失败。</span><div><pre class="pre codeblock"><code>GDSCTL&gt; show ddl id DDL Text Failed shards  -  -------- ------------- 11 CREATE TABLESPACE SET TSP_SET_2 in s ...12 CREATE TABLESPACE products_tsp datafi ...13创建SHARDED TABLE客户（Cu ...14创建序列订单_Seq; 15创建SHARDED TABLE订单（订购......16创建SHARDED TABLE LineItems（或......17创建数据库链接“PRODUCTSDBLINK @ ...18创建物质化的视图“产品”......19创建或替换功能PasswCreat ......20创建或替换功能PasswCheck ...
</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证每个分片上是否没有DDL错误。</span><div>
                              <p>在<code>config shard</code>每个分片上运行<code>config shard</code>和<code>config chunks</code>命令。
                              </p><pre class="pre codeblock"><code>GDSCTL&gt; config shard -shard sh1名称：sh1 Shard组：america_shgrp1状态：Ok状态：已部署区域：region1连接字符串：shard1：1521 / sh1：专用SCAN地址：ONS远程端口：0磁盘阈值，ms：20 CPU阈值， ％：75版本：18.0.0.0上次失败DDL：DDL错误：--- DDL ID失败：可用性：ONLINE支持的服务----------------------- - 名称首选状态---- --------- ------ oltp_rw_srvc是启用GDSCTL&gt; config chunks Chunks ------------------- -----数据库从到-------- ----  -  sh1 1 6 sh2 7 12 sh3 1 6 sh4 7 12</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证为分片表系列创建的表空间集的表空间，以及为所有分片创建为重复表创建的表空间。</span><div>
                              <p>表空间集中的表空间数基于您在<code>create shardcatalog</code>命令中指定的块数。
                              </p>
                              <p>使用分片目录创建示例中指定的12个前6个块设置的表空间，以及shard_host_1上的以下示例中显示了重复的Products表空间。</p><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt;选择TABLESPACE_NAME，BYTES / 1024/1024 MB，来自sys.dba_data_files，由tablespace_name命令; TABLESPACE_NAME MB ------------------------------ ---------- C001TSP_SET_1 100 C002TSP_SET_1 100 C003TSP_SET_1 100 C004TSP_SET_1 100 C005TSP_SET_1 100 C006TSP_SET_1 100 PRODUCTS_TSP 100 SYSAUX 650 SYSTEM 890 SYS_SHARD_TS 100 TSP_SET_1 100 TABLESPACE_NAME MB ------------------------------ ---- ------ TSP_SET_2 100 UNDOTBS1 110 USERS 5 14行选择。
</code></pre><p>在配置中的所有分片上重复此步骤。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证是否在所有分片上创建了块和块表空间。</span><div><pre class="pre codeblock"><code>SQL&gt; set linesize 140 SQL&gt; column table_name format a20 SQL&gt; column tablespace_name format a20 SQL&gt; column partition_name format a20 SQL&gt; show parameter db_unique_name NAME TYPE VALUE ------------------- ----------------- ----------- ---------------------- -------- db_unique_name string sh2 SQL&gt; select table_name，partition_name，tablespace_name from dba_tab_partitions where tablespace_name like'C％TSP_SET_1'order by tablespace_name; TABLE_NAME PARTITION_NAME TABLESPACE_NAME -------------------- -------------------- ------- -------------了LineItem CUSTOMERS_P7 C007TSP_SET_1客户CUSTOMERS_P7 C007TSP_SET_1订单CUSTOMERS_P7 C007TSP_SET_1客户CUSTOMERS_P8 C008TSP_SET_1了LineItem CUSTOMERS_P8 C008TSP_SET_1订单CUSTOMERS_P8 C008TSP_SET_1了LineItem CUSTOMERS_P9 C009TSP_SET_1客户CUSTOMERS_P9 C009TSP_SET_1订单CUSTOMERS_P9 C009TSP_SET_1客户CUSTOMERS_P10 C00ATSP_SET_1了LineItem CUSTOMERS_P10 C00ATSP_SET_1 TABLE_NAME PARTITION_NAME TABLESPACE_NAME  - ------------------- -------------------- ----------- ------订单CUSTOMERS_P10 C00ATSP_SET_1客户CUSTOMERS_P11 C00BTSP_SET_1线路CUSTOMERS_P11 C00BTSP_SET_1订单客户_11 C00BTSP_SET_1客户CUSTOMERS_P12 C00CTSP_SET_1线路CUSTOMERS_P12 C00CTSP_SET_1订单CUSTOMERS_P12 C00CTSP_SET_1选择18行。
</code></pre><p>在配置中的所有分片上重复此步骤。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>连接到分片目录数据库并验证分块是否均匀分布。</span><div><pre class="pre codeblock"><code>$ sqlplus / as sysdba SQL&gt; set echo off SQL&gt; select a.name Shard，count（b.chunk_number）Number_of_Chunks from gsmadmin_internal.database a，gsmadmin_internal.chunk_loc b其中a.database_num = b.database_num group by a.name; SHARD NUMBER_OF_CHUNKS ------------------------------ ---------------- sh1 6 sh2 6 sh3 6 sh4 6</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>验证是否已创建分片和重复的表。</span><div>
                              <p>以分片目录数据库和每个分片上的应用程序模式用户身份登录。</p>
                              <p>以下示例显示了将数据库分片上的表作为app_schema用户进行查询。</p><pre class="pre codeblock"><code>$ sqlplus app_schema / <span class="variable" translate="no">app_schema_password</span>已连接。SQL&gt;从user_tables中选择table_name; TABLE_NAME ------------------------------------------------- ----------------------客户订购LINEITEMS产品4行选择。</code></pre></div>
                        </li>
                     </ol>
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-C43E1E4A-DA8F-4556-9EE7-39097C0276BC" title="要部署复合SDB，您必须安装所需的Oracle Sharding软件组件，配置复合SDB的对象并创建架构。">创建和部署复合SDB</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
            <div class="sect2"><a id="GUID-ACFBA061-F74B-4C31-9596-8BD7451846F3" name="GUID-ACFBA061-F74B-4C31-9596-8BD7451846F3"></a><h3 id="SHARD-GUID-ACFBA061-F74B-4C31-9596-8BD7451846F3" class="sect3"><span class="enumeration_section">8.10</span>在Oracle Sharding中使用透明数据加密</h3>
               <div>
                  <p>Oracle Sharding支持透明数据加密（TDE），但为了在启用TDE的分片数据库中成功移动块，所有分片必须共享并使用加密表空间的相同加密密钥。</p>
                  <p>分片数据库由多个独立数据库和目录数据库组成。为使TDE正常工作，尤其是在分片之间移动数据时，会有一些限制。为了在数据加密时分片之间的块移动工作，您必须确保所有分片使用相同的加密密钥。</p>
                  <p>有两种方法可以实现此目的：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>从分片目录中创建和导出加密密钥，然后单独导入并激活所有分片上的密钥。</p>
                     </li>
                     <li>
                        <p>将钱包存储在共享位置，并使分片目录和所有分片使用相同的钱包。</p>
                     </li>
                  </ul>
                  <p>在启用了shard DDL的分片目录上执行时，以下TDE语句会自动传播到分片：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>通过<span class="variable" translate="no">password</span>识别的alter system set加密钱包打开/关闭</p>
                     </li>
                     <li>
                        <p>更改系统设置加密密钥</p>
                     </li>
                     <li>
                        <p>管理密钥管理组密钥库[开|关闭窗口]鉴定<span class="variable" translate="no">password</span></p>
                     </li>
                     <li>
                        <p>管理由<span class="variable" translate="no">password</span>识别的密钥管理集密钥</p>
                     </li>
                     <li>
                        <p>管理密钥管理使用密码识别的<span class="variable" translate="no">password</span></p>
                     </li>
                     <li>
                        <p>管理密钥管理创建由<span class="variable" translate="no">password</span>标识的密钥库</p>
                     </li>
                  </ul>
                  <div class="section">
                     <p class="subhead2" id="GUID-ACFBA061-F74B-4C31-9596-8BD7451846F3__GUID-40DFC99D-58B1-4733-A9D6-F1778FE1C2E6">限制</p>
                     <p>以下限制适用于将TDE与Oracle Sharding一起使用。</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>要使<code class="codeph">MOVE CHUNK</code>正常工作，所有分片数据库主机必须位于同一平台上。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">MOVE CHUNK</code>在数据传输过程中无法使用压缩，这可能会影响性能。
                           </p>
                        </li>
                        <li>
                           <p>仅支持表空间级别的加密。不支持对特定列进行加密。</p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="sharding-deployment.html#GUID-C4E40922-C53E-4BEB-8C01-8D323805B89E">在所有碎片上创建单个加密密钥</a><br>要将单个加密密钥传播到分片数据库配置中的所有数据库，必须在分片目录上创建主加密密钥，然后使用wallet导出，然后将钱包导入到分片，并激活密钥。
                     </li>
                  </ul>
                  <div class="infoboxnotealso" id="GUID-ACFBA061-F74B-4C31-9596-8BD7451846F3__GUID-7EDBE553-FB78-4378-B6FC-7337B8124FA9">
                     <p class="notep1">也可以看看：</p>
                     <p>有关TDE的更多信息，请参见<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/shard&amp;id=ASOAG-GUID-F2F6CF9A-8F59-49AE-B378-556DCDACC856" target="_blank"><span><cite>“Oracle数据库高级安全指南</cite></span></a></p>
                  </div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-F99B8742-4089-4E77-87D4-4691EA932207" title="分片数据库部署包括安装所需软件组件，创建目录，角色和分片数据库，配置高可用性复制以及为分片数据库创建架构的先决条件和说明。">Sharded Database Deployment</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="sect3"><a id="GUID-C4E40922-C53E-4BEB-8C01-8D323805B89E" name="GUID-C4E40922-C53E-4BEB-8C01-8D323805B89E"></a><h4 id="SHARD-GUID-C4E40922-C53E-4BEB-8C01-8D323805B89E" class="sect4"><span class="enumeration_section">8.10.1</span>在所有碎片上创建单个加密密钥</h4>
                  <div>
                     <p>要将单个加密密钥传播到分片数据库配置中的所有数据库，必须在分片目录上创建主加密密钥，然后使用wallet导出，然后将钱包导入到分片，并激活密钥。</p>
                     <div class="section">
                        <p></p>
                        <div class="infoboxnote" id="GUID-C4E40922-C53E-4BEB-8C01-8D323805B89E__GUID-8D476F69-9D05-4E19-8903-EF4CAAEEFB69">
                           <p class="notep1">注意：</p>
                           <p>此过程假定密钥库目录和所有分片的密钥库密码和钱包目录路径相同。如果需要不同的密码和目录路径，则应在每个分片上单独发出所有命令，并使用分片自己的密码和路径禁用具有分片DDL的分片目录。</p>
                        </div>
                        <p>应在执行任何数据加密之前完成这些步骤。</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>在分片目录上创建加密密钥。</span><div>
                              <p>启用分片DDL后，发出以下语句。</p><pre class="pre codeblock"><code>ADMINISTER密钥管理CREATE KEYSTORE <span class="variable" translate="no">wallet_directory_path</span> IDENTIFIED BY <span class="variable" translate="no">keystore_password</span> ;管理员密钥管理设置KEYSTORE OPEN由<span class="variable" translate="no">keystore_password</span>标识;</code></pre><p>如果您希望从目录集中发出钱包打开和关闭命令，则<span class="variable" translate="no">keystore_password</span>应该相同。
                              </p>
                              <div class="infoboxnote" id="GUID-C4E40922-C53E-4BEB-8C01-8D323805B89E__GUID-11DFE396-E38D-4660-986D-A6B70007DAAD">
                                 <p class="notep1">注意：</p>
                                 <p>wallet目录路径应与相应sqlnet.ora中的<code class="codeph">ENCRYPTION_WALLET_LOCATION</code>匹配。
                                 </p>
                                 <p>不推荐使用<code class="codeph">ENCRYPTION_WALLET_LOCATION</code>参数。建议您使用<code class="codeph">WALLET_ROOT</code>静态初始化和<code class="codeph">TDE_CONFIGURATION</code>动态初始化参数。
                                 </p>
                              </div>
                              <p>禁用分片DDL后，发出以下语句。</p><pre class="pre codeblock"><code>通过<span class="variable" translate="no">keystore_password</span> WITH BACKUP识别的ADMINISTER密钥管理集<span class="variable" translate="no">keystore_password</span> ;</code></pre><p>在分片目录数据库的钱包中创建并激活加密密钥。</p>
                              <p>如果在启用DDL的情况下发出此语句，它还将在每个分片的钱包中创建加密密钥，这些密钥与目录的密钥不同。为了使数据移动起作用，您不能在每个分片上使用不同的加密密钥。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>从分片目录密钥库中获取主密钥ID。</span><div><pre class="pre codeblock"><code>SELECT KEY_ID FROM V $ ENCRYPTION_KEYS WHERE ACTIVATION_TIME =（SELECT MAX（ACTIVATION_TIME）FROM V $ ENCRYPTION_KEYS WHERE ACTIVATING_DBID =（从V $ DATABASE中选择DBID））;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>禁用分片DDL后，导出包含加密密钥的目录钱包。</span><div><pre class="pre codeblock"><code>管理员密钥管理导出加密密钥与SECRET <span class="variable" translate="no">secret_phrase</span> TO <span class="variable" translate="no">wallet_export_file</span>由<span class="variable" translate="no">keystore_password</span>标识;</code></pre></div>
                           <div>（可选）在此处输入步骤的结果。</div>
                        </li>
                        <li class="stepexpand"><span>将钱包文件以物理方式复制到每个分片主机，并将其复制到相应的钱包导出文件位置，或将钱包文件放在所有分片都可以访问的共享磁盘上。</span></li>
                        <li class="stepexpand"><span>禁用分片DDL后，登录到每个分片并导入包含密钥的钱包。</span><div><pre class="pre codeblock"><code>管理员密钥管理设置KEYSTORE OPEN由<span class="variable" translate="no">keystore_password</span>标识; ADMINISTER密钥管理使用SECRET <span class="variable" translate="no">secret_phrase</span> <span class="variable" translate="no">keystore_password</span>加密<span class="variable" translate="no">secret_phrase</span> FROM <span class="variable" translate="no">wallet_export_file</span>由<span class="variable" translate="no">keystore_password</span> WITH BACKUP标识;</code></pre></div>
                        </li>
                        <li class="stepexpand"><span>重新启动分片数据库。</span></li>
                        <li class="stepexpand"><span>激活所有分片上的键。</span><div>
                              <p>在启用了分片DDL的目录上</p><pre class="pre codeblock"><code>管理员密钥管理设置KEYSTORE OPEN由<span class="variable" translate="no">keystore_password</span>标识; ADMINISTER密钥管理使用密钥<span class="variable" translate="no">master_key_id</span> IDENTIFIED BY <span class="variable" translate="no">keystore_password</span> WITH BACKUP;</code></pre></div>
                        </li>
                     </ol>
                     <div class="section">
                        <p>现在，所有分片和分片目录数据库都激活了相同的加密密钥，可以用于数据加密。在分片目录上，您可以发出TDE DDL（启用了分片DDL），例如：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>创建加密表空间和表空间集。</p>
                           </li>
                           <li>
                              <p>使用加密表空间创建分片表。</p>
                           </li>
                           <li>
                              <p>创建包含加密列的分片表（有限制）。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>验证所有分片上的密钥ID是否与分片目录上的ID匹配。</p><pre class="pre codeblock"><code>SELECT KEY_ID FROM V $ ENCRYPTION_KEYS WHERE ACTIVATION_TIME =（SELECT MAX（ACTIVATION_TIME）FROM V $ ENCRYPTION_KEYS WHERE ACTIVATING_DBID =（从V $ DATABASE中选择DBID））;</code></pre></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="sharding-deployment.html#GUID-ACFBA061-F74B-4C31-9596-8BD7451846F3" title="Oracle Sharding支持透明数据加密（TDE），但为了在启用TDE的分片数据库中成功移动块，所有分片必须共享并使用加密表空间的相同加密密钥。">将透明数据加密与Oracle Sharding一起使用</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
         </div>
      </article>
   </body>
</html>