<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="Recovery Manager (RMAN) provides tools to migrate data to and from Oracle ASM."></meta>
      <meta name="description" content="Recovery Manager (RMAN) provides tools to migrate data to and from Oracle ASM."></meta>
      <title>使用RMAN执行Oracle ASM数据迁移</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Administrator&#39;s Guide"></meta>
      <meta property="og:description" content="Recovery Manager (RMAN) provides tools to migrate data to and from Oracle ASM."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Administrator&#39;s Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="automatic-storage-management-administrators-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-04-23T18:56:15-07:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="2007, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96198-03"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="admin-asm-em.html" title="Previous" type="text/html"></link>
      <link rel="next" href="manage-asm-asmca.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Automatic Storage Management Administrator&#39;s Guide"></meta>
    <meta name="dcterms.isVersionOf" content="OSTMG"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="admin-asm-em.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="manage-asm-asmca.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">管理员指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="part-instance-diskgroup.html" property="item" typeof="WebPage"><span property="name">Oracle ASM实例和磁盘组</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">使用RMAN执行Oracle ASM数据迁移</li>
            </ol>
            <a id="GUID-EE232095-823A-4717-8629-75E6A750FCDB" name="GUID-EE232095-823A-4717-8629-75E6A750FCDB"></a><a id="OSTMG12000"></a>
            
            <h2 id="OSTMG-GUID-EE232095-823A-4717-8629-75E6A750FCDB" class="sect2"><span class="enumeration_chapter">8</span>使用RMAN执行Oracle ASM数据迁移</h2>
         </header>
         <div class="ind">
            <div>
               <p>Recovery Manager（RMAN）提供了与Oracle ASM之间迁移数据的工具。</p>
               <p>本章介绍如何使用Recovery Manager（RMAN）将数据迁入和迁出Oracle自动存储管理（Oracle ASM）存储。</p>
               <p>本章包括以下主题：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-B43E349F-9065-4422-8558-E22A0CE579C5">Oracle ASM数据迁移概述</a></p>
                  </li>
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">准备使用RMAN将数据库迁移到Oracle ASM</a></p>
                  </li>
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">使用RMAN将数据库迁移到Oracle ASM</a></p>
                  </li>
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63">将数据库从Oracle ASM迁移到备用存储</a></p>
                  </li>
                  <li>
                     <p><a href="asm-migration-rman.html#GUID-3B8D0956-0888-452D-A9E4-9FB8D98577E0">使用RMAN在Oracle ASM磁盘组之间移动数据文件</a></p>
                  </li>
               </ul>
               <p>本章中的过程涵盖Linux平台上的Oracle ASM独立环境。对于不同的Oracle配置和其他操作系统平台，文件位置和过程可能不同。</p>
               <div class="infoboxnotealso" id="GUID-EE232095-823A-4717-8629-75E6A750FCDB__GUID-48C0CF37-8CCA-4A27-B715-76C99FE03C7E">
                  <p class="notep1">也可以看看：</p>
                  <p></p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>有关使用RMAN的完整信息，请参见<a href="../bradv/introduction-backup-recovery.html#BRADV8001" target="_blank"><span class="italic">“Oracle数据库备份和恢复用户指南”</span></a></p>
                     </li>
                     <li>
                        <p>特定于操作系统的文档，用于在特定平台上将数据迁入和迁出Oracle ASM</p>
                     </li>
                     <li>
                        <p>有关管理和迁移Oracle Cluster Registry and voting文件的信息，请参阅<a href="../cwadd/managing-oracle-cluster-registry-and-voting-files.html#CWADD92368" target="_blank"><span class="italic">“Oracle Clusterware管理和部署指南”</span></a></p>
                     </li>
                     <li>
                        <p><a href="../racad/managing-backup-and-recovery.html#RACAD059" target="_blank"><span class="italic">“Oracle Real Applications集群管理和部署指南”，</span></a>用于在Oracle RAC配置中将数据迁入和迁出Oracle ASM</p>
                     </li>
                     <li>
                        <p>有关以格式化方式收集和备份Oracle ASM和Oracle ACFS元数据的信息， <a href="https://support.oracle.com" target="_blank"><code class="codeph">https://support.oracle.com</code></a>访问<a href="https://support.oracle.com" target="_blank">My Oracle Support</a> （ <a href="https://support.oracle.com" target="_blank"><code class="codeph">https://support.oracle.com</code></a> ），例如HTML格式</p>
                     </li>
                  </ul>
               </div>
            </div><a id="OSTMG89991"></a><div class="props_rev_3"><a id="GUID-B43E349F-9065-4422-8558-E22A0CE579C5" name="GUID-B43E349F-9065-4422-8558-E22A0CE579C5"></a><h3 id="OSTMG-GUID-B43E349F-9065-4422-8558-E22A0CE579C5" class="sect3">Oracle ASM数据迁移概述</h3>
               <div>
                  <p><a id="d60040e351" class="indexterm-anchor"></a>本节介绍了与Oracle ASM之间迁移数据所涉及的基本概念和任务。</p>
                  <p>本节包括以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="asm-migration-rman.html#GUID-096830E5-3F25-47A7-A8E4-4728AC164F9E">Oracle ASM数据迁移的目的</a></p>
                     </li>
                     <li>
                        <p><a href="asm-migration-rman.html#GUID-93E85B47-D624-4814-B476-D7C7098A3A59">Oracle ASM数据迁移的基本概念</a></p>
                     </li>
                     <li>
                        <p><a href="asm-migration-rman.html#GUID-55735241-F963-4FF5-BAD3-1D6ECF07D4FB">使用RMAN将数据迁移到Oracle ASM的基本步骤</a></p>
                     </li>
                  </ul>
               </div><a id="OSTMG89992"></a><div class="props_rev_3"><a id="GUID-096830E5-3F25-47A7-A8E4-4728AC164F9E" name="GUID-096830E5-3F25-47A7-A8E4-4728AC164F9E"></a><h4 id="OSTMG-GUID-096830E5-3F25-47A7-A8E4-4728AC164F9E" class="sect4">Oracle ASM数据迁移的目的</h4>
                  <div>
                     <p>Oracle ASM存储的替代方案包括文件系统，原始磁盘和SAN配置。Oracle ASM包含许多优于这些存储替代方案的优势，包括性能优化，冗余保护和负载平衡。您不需要第三方逻辑卷管理器，因为Oracle ASM会为您管理磁盘。Oracle Real Application Clusters（Oracle RAC）数据库受益于Oracle ASM，因为它提供了现成的共享存储。</p>
                     <p>如果数据库当前使用Oracle ASM以外的存储系统，则可以将全部或部分数据库迁移到Oracle ASM，从而简化数据库管理。您还可以将快速恢复区域迁移到Oracle ASM。</p>
                     <p>本机操作系统命令（如Linux <code class="codeph">cp</code>或Windows <code class="codeph">COPY</code>无法在Oracle ASM存储中写入或读取文件。由于RMAN可以读取和写入Oracle ASM文件，因此您可以使用RMAN将数据文件复制到Oracle ASM存储或从Oracle ASM存储复制到Oracle ASM磁盘组之间。如果必须在用户管理的磁盘上存储备份，则此方法很有用。
                     </p>
                  </div>
               </div><a id="OSTMG89993"></a><div class="props_rev_3"><a id="GUID-93E85B47-D624-4814-B476-D7C7098A3A59" name="GUID-93E85B47-D624-4814-B476-D7C7098A3A59"></a><h4 id="OSTMG-GUID-93E85B47-D624-4814-B476-D7C7098A3A59" class="sect4">Oracle ASM数据迁移的基本概念</h4>
                  <div>
                     <p>即使您没有使用RMAN作为主要备份工具，也可以使用RMAN将数据迁移到Oracle ASM。迁移需要一个RMAN数据库备份。</p>
                     <p>如果您有足够的磁盘空间来容纳Oracle ASM和备用存储系统中的整个数据库，则可以将数据库直接移动到Oracle ASM中。如果没有足够的存储空间，则可以将数据库备份到磁带，创建使用旧磁盘空间的Oracle ASM磁盘组，并将数据库从磁带还原到Oracle ASM。</p>
                     <p>设置新恢复区域的位置后，现有备份将保留在旧恢复区域中，并计入恢复区域的总磁盘配额。需要空间时，将从旧恢复区域删除备份。RMAN可以使用这些备份。除非您需要磁盘空间，否则无需将旧备份移动到新的Oracle ASM恢复区域。要释放旧恢复区域中文件占用的空间，可以将它们备份到磁带或将它们迁移到Oracle ASM恢复区域。</p>
                     <div class="infoboxnote" id="GUID-93E85B47-D624-4814-B476-D7C7098A3A59__GUID-2E7760E9-FC43-41FF-ADA7-4347061C429D">
                        <p class="notep1">注意：</p>
                        <p>外部归档重做日志是逻辑备用数据库为LogMiner会话接收的日志。无法迁移外部归档重做日志。与普通的归档日志不同，外部归档日志具有不同的内部数据库标识符（DBID）。因此，无法在逻辑备用数据库上备份或还原它们。</p>
                     </div>
                     <p>将数据库从Oracle ASM迁移到备用存储系统类似于从备用存储系统迁移到Oracle ASM。主要更改是修改每个步骤以引用备用存储系统中的文件位置。</p>
                  </div>
               </div><a id="OSTMG89994"></a><div class="props_rev_3"><a id="GUID-55735241-F963-4FF5-BAD3-1D6ECF07D4FB" name="GUID-55735241-F963-4FF5-BAD3-1D6ECF07D4FB"></a><h4 id="OSTMG-GUID-55735241-F963-4FF5-BAD3-1D6ECF07D4FB" class="sect4">使用RMAN将数据迁移到Oracle ASM的基本步骤</h4>
                  <div>
                     <p>本节讨论使用RMAN将整个数据库和快速恢复区域从备用存储迁移到Oracle ASM的过程。</p>
                     <p>快速恢复区域是可选磁盘位置，可用于存储与恢复相关的文件，例如控制文件和联机重做日志副本，归档重做日志文件，闪回日志和RMAN备份。Oracle数据库和RMAN自动管理快速恢复区中的文件。您可以指定磁盘配额，这是用户指定的快速恢复区域的最大大小。达到磁盘配额后，Oracle会自动删除不再需要的文件。</p>
                     <p>闪回日志是Oracle生成的日志，用于执行闪回数据库操作。数据库只能将闪回日志写入快速恢复区。闪回日志按顺序写入，不归档。它们无法备份到磁盘。</p>
                     <p>要将整个数据库和快速恢复区域从备用存储迁移到Oracle ASM，请执行以下步骤：</p>
                     <ol>
                        <li>
                           <p>备份数据库和服务器参数文件，并禁用Oracle闪回数据库。</p>
                           <p>Oracle闪回数据库选项使用RMAN或SQL中的<code class="codeph">FLASHBACK</code> <code class="codeph">DATABASE</code>命令将整个数据库返回到先前一致的系统变更编号（SCN）。数据库闪回与传统介质恢复不同，因为它不涉及物理文件的还原，而是使用已更改数据块的已保存映像将当前数据文件还原到过去状态。此功能使用闪回日志和归档重做日志。
                           </p>
                           <p><a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">准备使用RMAN将数据库迁移到Oracle ASM中</a>描述了此步骤。</p>
                        </li>
                        <li>
                           <p>将文件还原到Oracle ASM，恢复数据库，并可选择将快速恢复区域迁移到Oracle ASM。</p>
                           <p><a href="asm-migration-rman.html#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">使用RMAN将数据库迁移到Oracle ASM中</a>描述了此步骤。</p>
                        </li>
                     </ol>
                     <p>要将文件从Oracle ASM迁移到备用存储，请参阅<a href="asm-migration-rman.html#GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63">将数据库从Oracle ASM迁移到备用存储</a> 。
                     </p>
                  </div>
               </div>
            </div><a id="OSTMG89995"></a><div class="props_rev_3"><a id="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D" name="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D"></a><h3 id="OSTMG-GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D" class="sect3">准备使用RMAN将数据库迁移到Oracle ASM</h3>
               <div>
                  <p>本节介绍如何准备数据库以进行迁移。本节做出以下假设：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>您希望将数据库迁移到两个Oracle ASM磁盘组：数据库为<code class="codeph">+DATA</code> ，快速恢复区为<code class="codeph">+FRA</code> 。
                        </p>
                     </li>
                     <li>
                        <p>要迁移到Oracle ASM存储的数据库名为<code class="codeph">mydb</code> 。
                        </p>
                     </li>
                  </ul>
                  <p>要为Oracle ASM迁移准备数据库：</p>
                  <ol>
                     <li>
                        <p>如果数据库的<code class="codeph">COMPATIBLE</code>初始化参数设置小于<code class="codeph">11.0.0</code> ，则使任何只读可传输表空间读/写。
                        </p>
                        <p>无法迁移只读可传输表空间，因为RMAN无法备份它们。</p>
                     </li>
                     <li>
                        <p>如果数据库是物理备用数据库，并且启动了托管恢复，则停止托管恢复。</p>
                        <p>物理备用数据库是可用于灾难保护的生产数据库的副本。</p>
                        <p>例如，使用<code class="codeph">SYSBACKUP</code>权限（而不是<code class="codeph">SYSDBA</code>权限）将SQL * Plus连接到数据库以强制执行职责分离安全模型，并运行以下语句以停止托管恢复：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;</pre><p>保持此终端窗口打开。</p>
                     </li>
                     <li>
                        <p>将服务器参数文件或初始化参数文件复制到临时位置。</p>
                        <p>以下示例使用操作系统实用程序复制服务器参数文件：</p><pre class="oac_no_warn" dir="ltr">$ cp spfileMYDB.ora orig_spfileMYDB.ora</pre></li>
                     <li>
                        <p>在新的终端窗口中，启动RMAN会话并以<code class="codeph">TARGET</code>身份连接到要迁移的数据库。（可选）连接到恢复目录。使用<code class="codeph">SYSBACKUP</code>权限连接以强制执行职责分离安全模型。
                        </p>
                     </li>
                     <li id="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D__BAJHEEDG">
                        <p>将数据文件备份到Oracle ASM磁盘组。</p>
                        <p>以下示例使用<code class="codeph">RUN</code>命令进行0级增量备份，并分配4个通道以提高备份速度。0级增量备份是RMAN增量备份，用于备份正在备份的数据文件中的所有数据块。级别0的增量备份在内容上与完全备份相同，但与完全备份不同，0级备份被视为增量备份策略的一部分。
                        </p>
                        <p>增量备份是RMAN备份，其中仅备份已修改的块。增量备份按<strong class="term">级别</strong>分类。0级增量备份执行与完全备份相同的功能，因为它们都备份了所有曾经使用过的块。不同之处在于完整备份不会影响后续增量备份备份的块，而增量备份会影响后续增量备份备份的块。
                        </p>
                        <p>完整备份是非增量RMAN备份。Full不是指备份数据库的数量，而是指备份不是增量备份的事实。因此，您可以对一个数据文件进行完整备份。</p>
                        <p>相应地增加或减少此数字。format子句指定<code class="codeph">+DATA</code> ，它是用于存储数据库的Oracle ASM磁盘组的名称。
                        </p><pre class="oac_no_warn" dir="ltr">RUN {ALLOCATE CHANNEL dev1 DEVICE TYPE DISK; ALLOCATE CHANNEL dev2 DEVICE TYPE DISK; ALLOCATE CHANNEL dev3 DEVICE TYPE DISK; ALLOCATE CHANNEL dev4 DEVICE TYPE DISK; BACKUP AS COPY INCREMENTAL LEVEL 0 DATABASE FORMAT'+ DATA'TAG'ORA_ASM_MIGRATION'; }</pre></li>
                     <li>
                        <p>如果为数据库启用了块更改跟踪，则可以选择进行一级增量备份，以后可以使用该备份来恢复数据库副本。</p>
                        <p>块更改跟踪是一种数据库选项，可使Oracle跟踪受每个数据库更新影响的数据文件块。跟踪信息存储在块改变跟踪文件中。启用块更改跟踪时，RMAN使用更改跟踪文件中已更改块的记录，通过仅读取已知已更改的块而不是完整读取数据文件来提高增量备份性能。</p>
                        <p>以下示例生成在上一步中创建的0级备份的增量级别1副本：</p><pre class="oac_no_warn" dir="ltr">RUN {ALLOCATE CHANNEL dev1 DEVICE TYPE DISK; ALLOCATE CHANNEL dev2 DEVICE TYPE DISK; ALLOCATE CHANNEL dev3 DEVICE TYPE DISK; ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;用TAG'ORA_ASM_MIGRATION'数据库恢复补充级别1以恢复复制; }</pre></li>
                     <li>
                        <p>如果数据库处于<code class="codeph">ARCHIVELOG</code>模式，并且数据库已打开，则归档联机日志。
                        </p>
                        <p>以下示例使用<code class="codeph">SQL</code>命令存档当前的重做日志：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL“ALTER SYSTEM ARCHIVE LOG CURRENT”;</pre></li>
                     <li>
                        <p>如果数据库实例当前正在使用服务器参数文件，则将其备份。</p>
                        <p>以下示例备份服务器参数文件：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; BACKUP作为BACKUPSET SPFILE;</pre></li>
                     <li>
                        <p>如果启用了块更改跟踪，则禁用它。</p>
                        <p>以下命令禁用块更改跟踪：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL“ALTER DATABASE DISABLE BLOCK CHANGE TRACKING”;</pre></li>
                     <li>
                        <p>如果启用了闪回数据库，则禁用它并删除任何保证的还原点。</p>
                        <div class="infoboxnote" id="GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D__GUID-A7E02510-D67B-4FA9-B8B4-537CADDB6F39">
                           <p class="notep1">注意：</p>
                           <p>如果您没有迁移快速恢复区域，请跳过此步骤。</p>
                        </div>
                        <p>禁用Oracle闪回数据库是必要的，因为您无法将闪回日志迁移到Oracle ASM。以下命令禁用闪回数据库：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL“ALTER DATABASE FLASHBACK OFF”;</pre><p>以下命令将删除名为<code class="codeph">Q106</code>的保证还原点：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL“DROP RESTORE POINT Q106”;</pre></li>
                     <li>
                        <p>一致地关闭数据库。</p>
                        <p>以下命令将关闭数据库：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt;立即关闭;</pre></li>
                  </ol>
               </div>
            </div><a id="OSTMG94244"></a><a id="OSTMG12121"></a><div class="props_rev_3"><a id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1" name="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1"></a><h3 id="OSTMG-GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1" class="sect3">使用RMAN将数据库迁移到Oracle ASM</h3>
               <div>
                  <p>以下过程旨在最大限度地减少数据库停机时间。根据您是要迁移主数据库还是备用数据库，这些步骤略有不同。该过程<a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">使用RMAN准备将数据库迁移到Oracle ASM中</a>描述的相同假设。如果您没有将恢复区域迁移到Oracle ASM，则必须修改一些注意到的步骤。
                  </p>
                  <div class="infoboxnote" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-F6A61E3E-6516-41E5-8AC7-41A90415B200">
                     <p class="notep1">注意：</p>
                     <p>以下过程在SQL * Plus和RMAN之间切换，因此请为每个实用程序保持打开终端窗口。</p>
                  </div>
                  <p>要将数据库迁移到Oracle ASM：</p>
                  <ol>
                     <li>
                        <p>按照<a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">准备使用RMAN将数据库迁移到Oracle ASM中</a>的步骤进行操作。</p>
                     </li>
                     <li>
                        <p>在Oracle ASM存储中还原或创建服务器参数文件。</p>
                        <p>步骤取决于数据库是否使用服务器参数文件：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>如果数据库使用服务器参数文件，则使用以下命令将其还原到Oracle ASM磁盘组，其中<span class="italic"><code class="codeph">sid</code></span>是实例的SID：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; STARTUP MOUNT; RMAN&gt; RESTORE SPFILE TO'+ DATA / spfile <span class="italic">sid</span> .ora'; RMAN&gt;立即关闭;</pre></li>
                           <li>
                              <p>如果数据库未使用服务器参数文件，则在Oracle ASM中创建一个。在SQL * Plus中运行<code class="codeph">CREATE SPFILE</code>命令，如下所示，其中<span class="italic"><code class="codeph">sid</code></span>是数据库的SID：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; CREATE SPFILE ='+ DATA / spfile <span class="italic">sid</span> .ora'FROM PFILE ='？/ dbs / init <span class="italic">sid</span> .ora';</pre></li>
                        </ul>
                     </li>
                     <li id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__BAJCGAFE">
                        <p>将Oracle Managed Files初始化参数设置为Oracle ASM位置。</p>
                        <div class="infoboxnote" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-65F747BA-B195-4A7D-97A0-3C1E2BA2BA32">
                           <p class="notep1">注意：</p>
                           <p>如果不迁移快速恢复区域，则不要更改<code class="codeph">DB_RECOVERY_FILE_DEST</code>和<code class="codeph">DB_RECOVERY_FILE_DEST_SIZE</code>初始化参数设置。但是，必须将<code class="codeph">DB_CREATE_ONLINE_LOG_DEST_</code> <span class="italic"><code class="codeph">n</code></span>参数设置为Oracle ASM位置才能迁移联机重做日志。
                           </p>
                        </div>
                        <p>将<code class="codeph">DB_CREATE_FILE_DEST</code>和可选的<code class="codeph">DB_CREATE_ONLINE_LOG_DEST_</code> <span class="italic"><code class="codeph">n</code></span>初始化参数设置为Oracle ASM磁盘组。如果数据库使用恢复区域，则将恢复区域位置更改为Oracle ASM磁盘组。此外，更改恢复区域大小。
                        </p>
                        <p>在SQL * Plus中运行命令，如以下示例所示。该示例假定快速恢复区域的大小为100 GB，并指定快速恢复区域的磁盘组<code class="codeph">+FRA</code> 。
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT; SQL&gt; ALTER SYSTEM SET DB_CREATE_FILE_DEST ='+ DATA'SID ='*'; SQL&gt; ALTER SYSTEM SET DB_RECOVERY_FILE_DEST_SIZE = 100G SID ='*'; SQL&gt; ALTER SYSTEM SET DB_RECOVERY_FILE_DEST ='+ FRA'SID ='*';</pre></li>
                     <li>
                        <p>将<code class="codeph">CONTROL_FILES</code>初始化参数设置为Oracle ASM位置。
                        </p>
                        <p>如果要迁移快速恢复区域，请在SQL * Plus中输入以下命令以重新启动数据库实例并将控制文件位置设置为磁盘组<code class="codeph">+DATA</code>和<code class="codeph">+FRA</code> ：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT; SQL&gt; ALTER SYSTEM SET CONTROL_FILES ='+ DATA'，'+ FRA'SCOPE = SPFILE SID ='*';</pre><p>如果不迁移快速恢复区域，请在SQL * Plus中输入以下命令以重新启动数据库实例并将控制文件位置设置为磁盘组<code class="codeph">+DATA</code> ：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP FORCE NOMOUNT; SQL&gt; ALTER SYSTEM SET CONTROL_FILES ='+ DATA'，'+ DATA'SCOOPE = SPFILE SID ='*';</pre></li>
                     <li>
                        <p>将控制文件迁移到Oracle ASM并装入控制文件。</p>
                        <p>切换到RMAN终端以恢复控制文件。在以下示例中， <span class="italic"><code class="codeph">original_cf_name</code></span>是迁移前初始化参数文件中的控制文件名：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; STARTUP FORCE NOMOUNT; RMAN&gt; RESTORE CONTROLFILE来自' <span class="italic">original_cf_name</span> '; RMAN&gt; ALTER DATABASE MOUNT;</pre></li>
                     <li>
                        <p>将数据文件迁移到Oracle ASM。</p>
                        <p>使用RMAN切换到在<a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">准备使用RMAN将数据库迁移到Oracle ASM的</a>步骤“将数据文件备份到Oracle ASM磁盘组”中创建的数据库副本。交换机将所有数据文件重命名为Oracle ASM磁盘组上的文件。之后，恢复数据库。如果采用增量备份，则RMAN会在恢复期间应用它们。例如，在RMAN提示符处输入以下命令：</p><pre class="oac_no_warn" dir="ltr">切换数据库复制; RUN {ALLOCATE CHANNEL dev1 DEVICE TYPE DISK; ALLOCATE CHANNEL dev2 DEVICE TYPE DISK; ALLOCATE CHANNEL dev3 DEVICE TYPE DISK; ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;恢复数据库; }</pre></li>
                     <li>
                        <p>如果数据库使用块更改跟踪或闪回数据库，则启用这些功能。</p>
                        <div class="infoboxnote" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-1925625F-780B-442E-B533-8FA5234F2A2F">
                           <p class="notep1">注意：</p>
                           <p>如果您没有迁移恢复区域，则除非先前已禁用闪回数据库，否则不会启用闪回数据库。</p>
                        </div>
                        <p>例如，在SQL * Plus中输入以下语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE使用文件'+ DATA'启用块更改跟踪; SQL&gt; ALTER DATABASE FLASHBACK ON;</pre></li>
                     <li>
                        <p>将数据库置于其正常操作模式。</p>
                        <p>正常操作模式取决于数据库是主数据库还是备用数据库：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>如果数据库是主数据库，则按如下所示打开它：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN;</pre></li>
                           <li>
                              <p>如果数据库是备用数据库，则按如下方式恢复受管恢复模式：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE;</pre></li>
                        </ul>
                     </li>
                     <li>
                        <p>删除临时文件并在Oracle ASM中重新创建它们。</p>
                        <p>使用SQL * Plus重新创建临时文件。在以下示例中，原始存储中的<span class="italic"><code class="codeph">tempfile_name</code></span>的名称为<span class="italic"><code class="codeph">tempfile_name</code></span> 。临时表空间的名称是<span class="italic"><code class="codeph">temp_tbs_name</code></span> 。
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE TEMPFILE <span class="italic">'tempfile_name'</span> DROP; SQL&gt; ALTER TABLESPACE <span class="italic">temp_tbs_name</span> ADD TEMPFILE;</pre></li>
                     <li>
                        <p>迁移联机重做日志文件。</p>
                        <p>如果这是主数据库，则在Oracle ASM中添加新的日志组成员并删除旧成员。您可以使用以下PL / SQL脚本将联机重做日志组迁移到Oracle ASM磁盘组。PL / SQL脚本假定已设置在<a href="asm-migration-rman.html#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">使用RMAN将数据库迁移</a>到Oracle ASM的步骤“将Oracle托管文件初始化参数设置为Oracle ASM位置”中指定的Oracle Managed Files初始化参数。
                        </p>
                     </li>
                     <li>
                        <p>（可选）将旧快速恢复区域中的备份和副本迁移到Oracle ASM，如下所示：</p>
                        <ol type="a">
                           <li>
                              <p>如果恢复区域中存在外部归档日志，则无法将它们迁移到Oracle ASM。在RMAN提示符下运行以下命令：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; DELETE ARCHIVELOG ALL;</pre></li>
                           <li>
                              <p>将归档的重做日志文件，备份集和数据文件副本备份到Oracle ASM。例如，在RMAN提示符处运行以下命令：</p><pre class="oac_no_warn" dir="ltr">RUN {ALLOCATE CHANNEL dev1 DEVICE TYPE DISK; ALLOCATE CHANNEL dev2 DEVICE TYPE DISK; ALLOCATE CHANNEL dev3 DEVICE TYPE DISK; ALLOCATE CHANNEL dev4 DEVICE TYPE DISK; BACKUP AS COPY ARCHIVELOG ALL DELETE INPUT; BACKUP BACKUPSET ALL DELETE INPUT; BACKUP as COPY DATAFILECOPY ALL DELETE INPUT; }</pre></li>
                        </ol>
                     </li>
                  </ol>
                  <div class="example" id="GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1__GUID-24DD750B-790F-4360-A6BF-0C5D04AD7D8A">
                     <p class="titleinexample">示例8-1迁移联机重做日志</p><pre class="oac_no_warn" dir="ltr">SET SERVEROUTPUT ON; DECLARE CURSOR rlc IS SELECT GROUP＃GRP，THREAD＃THR，BYTES，'NO'SRL FROM V $ LOG UNION SELECT GROUP＃GRP，THREAD＃THR，BYTES，'YES'SRL FROM V $ STANDBY_LOG ORDER BY 1; stmt VARCHAR2（2048）;从rlcRec IN rlc LOOP IF开始（rlcRec.srl ='YES'）然后stmt：='ALTER DATABASE添加STANDBY LOGFILE THREAD'|| rlcRec.thr || 'SIZE'|| rlcRec.bytes; EXECUTE IMMEDIATE stmt; stmt：='ALTER DATABASE DROP STANDBY LOGFILE GROUP'|| rlcRec.grp; EXECUTE IMMEDIATE stmt; ELSE stmt：='ALTER DATABASE添加LOGFILE THREAD'|| rlcRec.thr || 'SIZE'|| rlcRec.bytes; EXECUTE IMMEDIATE stmt; BEGIN stmt：='ALTER DATABASE DROP LOGFILE GROUP'|| rlcRec.grp; DBMS_OUTPUT.PUT_LINE（语句）; EXECUTE IMMEDIATE stmt;其他人执行时立即执行“更改系统切换日志文件”;执行立即'ALTER SYSTEM CHECKPOINT GLOBAL'; EXECUTE IMMEDIATE stmt;结束;万一;结束循环;结束; /</pre></div>
                  <!-- class="example" -->
               </div>
            </div><a id="OSTMG89996"></a><div class="props_rev_3"><a id="GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63" name="GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63"></a><h3 id="OSTMG-GUID-DDC3A9AD-4230-437D-92A7-4D10DBB52B63" class="sect3">将数据库从Oracle ASM迁移到备用存储</h3>
               <div>
                  <p>将数据库从Oracle ASM迁移到备用存储系统基本上与迁移到Oracle ASM相反。修改<a href="asm-migration-rman.html#GUID-4DCA6235-83FE-4EE0-9080-73558D7FF06D">准备使用RMAN</a> <a href="asm-migration-rman.html#GUID-85FF9270-0C21-44C8-B5EC-C1096A488BA1">将数据库迁移到Oracle ASM并使用RMAN将数据库迁移到Oracle ASM中的步骤</a> ，如下所示：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>如果该过程指定了Oracle托管文件位置，则更改过程以在备用存储中使用位置。</p>
                     </li>
                     <li>
                        <p>如果<code class="codeph">BACKUP</code>命令的<code class="codeph">FORMAT</code>子句指定Oracle ASM位置，则将备份格式更改为备用存储位置。
                        </p>
                     </li>
                     <li>
                        <p>如果SQL语句中使用的文件名是Oracle ASM位置，则将其更改为备用存储位置中的文件名。</p>
                     </li>
                  </ul>
               </div>
            </div><a id="OSTMG89997"></a><div class="props_rev_3"><a id="GUID-3B8D0956-0888-452D-A9E4-9FB8D98577E0" name="GUID-3B8D0956-0888-452D-A9E4-9FB8D98577E0"></a><h3 id="OSTMG-GUID-3B8D0956-0888-452D-A9E4-9FB8D98577E0" class="sect3">使用RMAN在Oracle ASM磁盘组之间移动数据文件</h3>
               <div>
                  <p>您可能希望将<code class="codeph">ARCHIVELOG</code>模式数据库中的活动数据文件从一个Oracle ASM磁盘组移动到另一个Oracle ASM磁盘组。您可以使用RMAN <code class="codeph">BACKUP</code> <code class="codeph">AS</code> <code class="codeph">COPY</code>将数据文件复制到新磁盘组，使用<code class="codeph">SET</code> <code class="codeph">NEWNAME</code>和<code class="codeph">SWITCH</code>命令重命名控制文件中的数据文件。
                  </p>
                  <p>您还可以使用<code class="codeph">ALTER</code> <code class="codeph">DATABASE</code> <code class="codeph">MOVE</code> <code class="codeph">DATAFILE</code> 。用于移动数据文件的SQL语句。有关使用<code class="codeph">ALTER</code> <code class="codeph">DATABASE</code> <code class="codeph">MOVE</code> <code class="codeph">DATAFILE</code>在线移动数据文件的信息，请参阅<a href="asm-files-directories-templates.html#GUID-CF6CB742-9DCD-4211-8A45-3C0B48AB6FBE" title="您可以使用ALTER DATABASE MOVE DATAFILE SQL语句在数据库打开且用户访问数据文件时在磁盘组之间移动数据文件。">使用ALTER DATABASE在磁盘组之间移动数据文件</a> 。</p>
                  <p>对于使用RMAN的此方案，假设您正在使用磁盘组<code class="codeph">DATA</code>和<code class="codeph">USERDATA</code>并且您希望将数据文件<code class="codeph">users.261.689589837</code>移动到磁盘组<code class="codeph">USERDATA</code> 。在开始移动数据文件的过程之前，请确保为数据库启用了<code class="codeph">ARCHIVELOG</code>模式。
                  </p>
                  <p>要使用带有<code class="codeph">SET</code> <code class="codeph">NEWNAME</code>和<code class="codeph">SWITCH</code>命令的RMAN <code class="codeph">BACKUP</code> <code class="codeph">AS</code> <code class="codeph">COPY</code>过程将数据文件从一个Oracle ASM磁盘组移动到另一个磁盘组，请执行以下步骤。
                  </p>
                  <ol>
                     <li>
                        <p>启动RMAN并连接到目标数据库。</p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">$ rman RMAN&gt; CONNECT TARGET SYS @ orcl目标数据库密码： <span class="italic">XXXXXXXXX</span>连接到目标数据库：ORCL（DBID = 1217369048）</pre></li>
                     <li>
                        <p>生成显示数据文件名称的报告。</p>
                        <p>将RMAN连接到目标数据库后，运行以下<code class="codeph">REPORT</code>命令。记下要移动的文件的数据文件名。
                        </p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt;报告计划;使用db_unique_name报告数据库的数据库模式ORCL永久数据文件列表===========================文件大小（MB）表空间RB segs数据文件名---- -------- -------------- ------- ----------------- ------- 1 740 SYSTEM *** + DATA / orcl / datafile / system.258.689589737 2 570 SYSAUX *** + DATA / orcl / datafile / sysaux.259.689589785 3 55 UNDOTBS1 *** + DATA / orcl / datafile / undotbs1.260.689589831 4 5 USERS *** + DATA / orcl / datafile / users.261.689589837临时文件列表=======================文件大小（MB）表空间Maxsize（MB）Tempfile Name ---- -------- -------------- ----------- --- ----------------- 1 20 TEMP 32767 + DATA / orcl / tempfile / temp.262.689589851</pre></li>
                     <li>
                        <p>将数据文件备份到新的Oracle ASM磁盘组。</p>
                        <p>运行<code class="codeph">BACKUP</code> <code class="codeph">AS</code> <code class="codeph">COPY</code>命令将<code class="codeph">DATA</code>上的数据文件备份到<code class="codeph">USERDATA</code> 。</p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt;备份为复制数据文件“+ DATA / orcl / datafile / users.261.689589837”FORMAT“+ USERDATA”;在16-JUN-09分配的通道开始备份：ORA_DISK_1通道ORA_DISK_1：SID = 51设备类型= DISK通道ORA_DISK_1：启动数据文件复制输入数据文件文件号= 00004名称= + DATA / orcl / datafile / users.261.689589837输出文件名= + USERDATA / orcl / datafile / users.256.689682663 tag = TAG20090616T103101 RECID = 13 STAMP = 689682663 channel ORA_DISK_1：datafile copy complete，elapsed time：00：00：01 16-JUN-09完成备份</pre><p>您还可以按数据文件编号和数据文件类型指定数据文件。</p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">备份为复制数据文件4格式“+ USERDATA”;</pre></li>
                     <li>
                        <p>使您要移动到新磁盘组的数据文件脱机。</p>
                        <p>在RMAN客户端中运行以下<code class="codeph">SQL</code>命令。在数据文件的名称周围使用两个单引号，而不是双引号。
                        </p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL“ALTER DATABASE DATAFILE''+ DATA / orcl / datafile / users.261.689589837''OFFLINE”; sql语句：ALTER DATABASE DATAFILE''+ DATA / orcl / datafile / users.261.689589837''OFFLINE</pre></li>
                     <li>
                        <p>将控制文件指向新创建的数据文件副本。</p>
                        <p>运行<code class="codeph">SWITCH...TO COPY</code>在RMAN客户端中TO COPY</code>命令。<code class="codeph">SWITCH</code>的<code class="codeph">TO</code> <code class="codeph">COPY</code>选项将数据文件切换到数据文件的最新副本。
                        </p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SWITCH DATAFILE“+ DATA / orcl / datafile / users.261.689589837”要复制; datafile 4切换到数据文件复制“+ USERDATA / orcl / datafile / users.256.689682663”</pre><p>此命令的输出显示数据文件的新名称。</p>
                     </li>
                     <li>
                        <p>恢复重命名的数据文件。</p>
                        <p>在RMAN客户端中运行<code class="codeph">RECOVER</code>命令。
                        </p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; RECOVER DATAFILE“+ USERDATA / orcl / datafile / users.256.689682663”;使用ORA_DISK_1频道开始恢复在16-JUN-09开始媒体恢复媒体恢复完成，已用时间：00：00：01在16-JUN-09完成恢复</pre></li>
                     <li>
                        <p>将数据文件联机。</p>
                        <p>在RMAN客户端中运行<code class="codeph">SQL</code>命令。在数据文件的名称周围使用两个单引号，而不是双引号。
                        </p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; SQL“ALTER DATABASE DATAFILE''+ USERDATA / orcl / datafile / users.256.689682663''ONLINE”; sql语句：ALTER DATABASE DATAFILE''+ USERDATA / orcl / datafile / users.256.689682663''ONLINE</pre></li>
                     <li>
                        <p>从原始Oracle ASM磁盘组中删除数据文件副本。</p>
                        <p>在这种情况下， <code class="codeph">+DATA/orcl/datafile/users.261.689589837</code>是<code class="codeph">DATA</code>的原始数据文件。因为您为此数据文件发出了<code class="codeph">SET NEWNAME</code>和<code class="codeph">SWITCH</code>命令，所以原始文件现在作为数据文件副本记录在RMAN存储库中。在RMAN客户端中运行<code class="codeph">DELETE</code>命令以删除此文件。
                        </p>
                        <p>例如：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; DELETE DATAFILECOPY“+ DATA / orcl / datafile / users.261.689589837”;已发布通道：ORA_DISK_1已分配通道：ORA_DISK_1通道ORA_DISK_1：SID = 51设备类型= DISK数据文件副本列表=======================密钥文件S完成时间Ckp SCN Ckp时间------- ------ --------------- ---------- --------- ------ 14 4 A 16-JUN-09 864471 16-JUN-09名称：+ DATA / orcl / datafile / users.261.689589837标签：TAG20090615T084217是否真的要删除上述对象（输入YES或NO） ？y删除数据文件复制数据文件复制文件名= + DATA / orcl / datafile / users.261.689589837 RECID = 14 STAMP = 689683255删除1个对象</pre></li>
                  </ol>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>