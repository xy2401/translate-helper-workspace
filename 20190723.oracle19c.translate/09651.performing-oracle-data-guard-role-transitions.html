<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="Prior to Oracle Database 12c Release 1 (12.1), the procedures for performing switchovers and failovers to a physical standby database were different."></meta>
      <meta name="description" content="Prior to Oracle Database 12c Release 1 (12.1), the procedures for performing switchovers and failovers to a physical standby database were different."></meta>
      <title>使用旧语法执行角色转换</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Concepts and Administration "></meta>
      <meta property="og:description" content="Prior to Oracle Database 12c Release 1 (12.1), the procedures for performing switchovers and failovers to a physical standby database were different."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Concepts and Administration"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="data-guard-concepts-and-administration.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-02-12T10:50:21-08:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="1999, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96244-02"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="setting-LOG_ARCHIVE_TRACE-initialization-parameter.html" title="Previous" type="text/html"></link>
      <link rel="next" href="using-ALTERNATE-attribute-to-configure-alternate-destinations.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Data Guard Concepts and Administration"></meta>
    <meta name="dcterms.isVersionOf" content="SBYDB"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="setting-LOG_ARCHIVE_TRACE-initialization-parameter.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="using-ALTERNATE-attribute-to-configure-alternate-destinations.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">概念和管理</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="oracle-data-guard-supplemental-information.html" property="item" typeof="WebPage"><span property="name">附录</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">使用旧语法执行角色转换</li>
            </ol>
            <a id="GUID-6E78412B-8E55-4D8B-A318-9F0612376E86" name="GUID-6E78412B-8E55-4D8B-A318-9F0612376E86"></a><a id="SBYDB5172"></a>
            
            <h2 id="SBYDB-GUID-6E78412B-8E55-4D8B-A318-9F0612376E86" class="sect2"><span class="enumeration_chapter">G</span>使用旧语法执行角色转换</h2>
         </header>
         <div class="ind">
            <div>
               <p>在Oracle Database <span class="italic">12c</span>第1版（12.1）之前，执行切换和故障转移到物理备用数据库的过程是不同的。
               </p>
               <p>仍然支持这些过程，但Oracle建议您使用<span class="q">“ <a href="managing-oracle-data-guard-role-transitions.html#GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD" title="The procedures to perform switchovers and failovers to a physical standby database have been simplified if you are running Oracle Database 12c Release 1 (12.1) or later.">涉及物理备用数据库的角色转换</a> ” <a href="managing-oracle-data-guard-role-transitions.html#GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD" title="如果您运行的是Oracle Database 12c第1版（12.1）或更高版本，则可以简化对物理备用数据库执行切换和故障转移的过程。">中</a></span>描述的新过程。
               </p>
               <p>如果您使用的是Oracle Database 12 <span class="italic">c</span>第1版（12.1）之前的版本，则必须使用旧过程。
               </p>
               <p>讨论了以下主题：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-EEBC6DA6-E192-470E-8FC9-F507B004406E" title="Oracle Database 12c第1版（12.1）引入了新的SQL语法，用于对物理备用数据库执行切换和故障转移操作。">涉及物理备用数据库的角色转换的SQL语法</a></p>
                  </li>
                  <li>
                     <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-F4A18A3A-6308-4580-B1F3-9647E2669BA0" title="在Oracle Database 12c第1版（12.1）之前的版本中，执行切换和故障转移到物理备用数据库的SQL语法是不同的。">涉及物理备用数据库的角色转换</a></p>
                  </li>
                  <li>
                     <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-E80C5A58-6D05-4281-81DB-6268EE1757AC" title="这些是切换到物理备用数据库期间可能发生的一些问题。">故障排除切换到物理备用数据库</a></p>
                  </li>
               </ul>
            </div><a id="SBYDB5173"></a><div class="props_rev_3"><a id="GUID-EEBC6DA6-E192-470E-8FC9-F507B004406E" name="GUID-EEBC6DA6-E192-470E-8FC9-F507B004406E"></a><h3 id="SBYDB-GUID-EEBC6DA6-E192-470E-8FC9-F507B004406E" class="sect3"><span class="enumeration_section">G.1</span>涉及物理备用数据库的角色转换的SQL语法</h3>
               <div>
                  <p>Oracle Database <span class="italic">12c</span>第1版（12.1）引入了新的SQL语法，用于对物理备用数据库执行切换和故障转移操作。
                  </p>
                  <div class="section">
                     <p>Oracle Database <span class="italic">12c</span>第1版（12.1）引入了新的SQL语法，用于对物理备用数据库执行切换和故障转移操作。除非特别指示，否则不要混合旧过程（本主题中描述）和新过程（在<a href="managing-oracle-data-guard-role-transitions.html#GUID-44F26D5F-E036-4ACD-B8F0-224F5498FBCE" title="Oracle Data Guard配置包含一个在主角色中运行的数据库和一个在备用角色中运行的一个或多个数据库。">角色转换中</a>描述）中的语法。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="tblformal" id="GUID-EEBC6DA6-E192-470E-8FC9-F507B004406E__GUID-349730FC-DE8C-4853-93FD-FE4C7D54F254">
                     <table cellpadding="4" cellspacing="0" class="Formal" title="" width="100%" border="1" summary="This table describes differences in role transition SQL syntax for physical standby databases between Oracle Database 12c and earlier releases. There are two columns and two rows, excluding the header row." frame="hsides" rules="rows">
                        <thead>
                           <tr align="left" valign="top">
                              <th align="left" valign="bottom" width="47%" id="d69299e227">物理备用数据库的12c前角色转换语法</th>
                              <th align="left" valign="bottom" width="53%" id="d69299e230">12c物理备用数据库的角色转换语法</th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="47%" id="d69299e235" headers="d69299e227 ">
                                 <p>要切换到主数据库上的物理备用数据库：</p>
                                 <p><code class="codeph">SQL&gt; ALTER DATABASE承诺切换到物理待机;</code></p>
                                 <p>在物理备用数据库上：</p>
                                 <p><code class="codeph">SQL&gt; ALTER DATABASE COMMIT to SWITCHOVER to PRIMARY;</code> 
                                 </p>
                              </td>
                              <td align="left" valign="top" width="53%" headers="d69299e235 d69299e230 ">
                                 <p>要切换到物理备用数据库：</p>
                                 <p><code class="codeph">SQL&gt; ALTER DATABASE SWITCHOVER TO</code> <span class="italic"><code class="codeph">target_db_name</code></span> <code class="codeph">[FORCE] [VERIFY]</code> ;</p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="47%" id="d69299e262" headers="d69299e227 ">
                                 <p>要故障转移到物理备用数据库，（ <span class="q">“ <a href="performing-oracle-data-guard-role-transitions.html#GUID-AAAA9A3B-7A1A-4044-90EC-F581D87439F4" title="这些步骤描述了如何执行到物理备用数据库的故障转移。">使用旧语法执行故障转移到物理备用数据库</a> ”中的</span>步骤6和步骤8）：</p>
                                 <p><code class="codeph">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE FINISH</code> ;</p>
                                 <p>和</p>
                                 <p><code class="codeph">SQL&gt; ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY</code> ;</p>
                              </td>
                              <td align="left" valign="top" width="53%" headers="d69299e262 d69299e230 ">
                                 <p>要故障转移到物理备用数据库，以下语句将替换先前所需的两个语句：</p>
                                 <p><code class="codeph">SQL&gt; ALTER DATABASE FAILOVER TO</code> <span class="italic"><code class="codeph">target_db_name</code></span> ;</p>
                              </td>
                           </tr>
                        </tbody>
                     </table>
                  </div>
                  <!-- class="inftblhruleinformal" -->
                  <div class="section">
                     <div class="infoboxnotealso" id="GUID-EEBC6DA6-E192-470E-8FC9-F507B004406E__GUID-B2FCFA5C-0E56-4CCF-8F16-796025E17534">
                        <p class="notep1">也可以看看：</p>
                        <p></p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>有关SQL语法的详细信息，请<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=SQLRF00802" target="_blank"><span class="italic">参见Oracle数据库SQL语言参考</span></a></p>
                           </li>
                        </ul>
                     </div>
                  </div>
                  <!-- class="section" -->
               </div><a id="SBYDB5212"></a><div class="props_rev_3"><a id="GUID-C1E83316-FD7F-4944-8CC8-784A37172B95" name="GUID-C1E83316-FD7F-4944-8CC8-784A37172B95"></a><h4 id="SBYDB-GUID-C1E83316-FD7F-4944-8CC8-784A37172B95" class="sect4"><span class="enumeration_section">G.1.1</span>使用旧语法时的新功能</h4>
                  <div>
                     <p>从Oracle Database 12 <span class="italic">c</span>第1版（12.1）开始，不再需要<code class="codeph">WITH SESSION SHUTDOWN</code>子句来终止活动的SQL会话。
                     </p>
                     <p>您可以发出以下语句来自动终止活动的SQL会话：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE承诺切换到物理待机;</pre><p>此外，当您执行从Oracle RAC主数据库切换到物理备用数据库时，不再需要关闭除一个主数据库实例之外的所有数据库实例。切换完成后，所有实例都会自动关闭。</p>
                  </div>
               </div>
            </div><a id="SBYDB5174"></a><div class="props_rev_3"><a id="GUID-F4A18A3A-6308-4580-B1F3-9647E2669BA0" name="GUID-F4A18A3A-6308-4580-B1F3-9647E2669BA0"></a><h3 id="SBYDB-GUID-F4A18A3A-6308-4580-B1F3-9647E2669BA0" class="sect3"><span class="enumeration_section">G.2</span>涉及物理备用数据库的角色转换</h3>
               <div>
                  <p>在Oracle Database 12 <span class="italic">c</span>第1版（12.1）之前的版本中，执行切换和故障转移到物理备用数据库的SQL语法是不同的。
                  </p>
                  <p>如果您在12.1之前运行发行版，则必须使用以下过程：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-65C1BE5E-A2AC-4938-B03F-2495761DE500" title="在主数据库上启动切换，并在目标备用数据库上完成切换。">使用旧语法执行到物理备用数据库的切换</a></p>
                     </li>
                     <li>
                        <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-AAAA9A3B-7A1A-4044-90EC-F581D87439F4" title="这些步骤描述了如何执行到物理备用数据库的故障转移。">使用旧语法执行到物理备用数据库的故障转移</a></p>
                     </li>
                  </ul>
                  <div class="infoboxnotealso" id="GUID-F4A18A3A-6308-4580-B1F3-9647E2669BA0__GUID-A22A4754-4421-4575-B7FD-63539F50F536">
                     <p class="notep1">也可以看看：</p>
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-44F26D5F-E036-4ACD-B8F0-224F5498FBCE" title="Oracle Data Guard配置包含一个在主角色中运行的数据库和一个在备用角色中运行的一个或多个数据库。">角色转换</a>有关如何准备切换和故障转移的信息</p>
                  </div>
               </div><a id="SBYDB5175"></a><div class="props_rev_3"><a id="GUID-65C1BE5E-A2AC-4938-B03F-2495761DE500" name="GUID-65C1BE5E-A2AC-4938-B03F-2495761DE500"></a><h4 id="SBYDB-GUID-65C1BE5E-A2AC-4938-B03F-2495761DE500" class="sect4"><span class="enumeration_section">G.2.1</span>使用旧语法执行到物理备用数据库的切换</h4>
                  <div>
                     <p>在主数据库上启动切换，并在目标备用数据库上完成切换。</p>
                     <div class="section">
                        <p>本主题介绍如何切换到物理备用数据库。</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>验证主数据库是否可以切换到备用角色。</span><div>
                              <p>查询主数据库上<code class="codeph">V$DATABASE</code>视图的<code class="codeph">SWITCHOVER_STATUS</code>列。例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS ----------------- TO STANDBY选择1行</pre><p>值<code class="codeph">TO STANDBY</code>或<code class="codeph">SESSIONS ACTIVE</code>表示主数据库可以切换到备用角色。如果这两个值均未返回，则无法进行切换，因为重做传输配置错误或无法正常运行。有关配置和监视重做传输的信息，请参阅<a href="oracle-data-guard-redo-transport-services.html#GUID-0EC71C7D-A80B-40AA-93E5-28BB7E24ED31" title="Oracle Data Guard配置要求配置和监视Oracle重做传输服务。">重做传输服务</a> 。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>在主数据库上发出以下SQL语句以将其切换到备用角色：在主数据库上发出以下SQL语句以将其切换到备用角色：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE承诺切换到物理待机;</pre><p>此语句将主数据库转换为物理备用数据库。在切换之前，当前控制文件将备份到当前SQL会话跟踪文件。如果需要，这使得可以重建当前控制文件。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>挂载以前的主数据库。例如：例如：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP MOUNT;</pre><p>此时，在切换过程中，原始主数据库是物理备用数据库。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>查询备用数据库上<code class="codeph">V$DATABASE</code>视图的<code class="codeph">SWITCHOVER_STATUS</code>列，以验证切换目标是否已准备好切换到主角色。例如：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS -----------------要选择PRIMARY 1行</pre><p><code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code>值表示备用数据库已准备好切换到主要角色。如果未返回这些值，请验证重做应用是否处于活动状态，并且已配置重做传输并且正常工作。继续查询此列，直到返回的值为<code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code> 。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>在目标物理备用数据库上发出以下SQL语句，以将其切换为主要角色：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE使用SESSION SHUTDOWN进行切换到主切换;</pre><div class="infoboxnote" id="GUID-65C1BE5E-A2AC-4938-B03F-2495761DE500__GUID-99B34AA8-C099-4292-8BDD-B2E2EA023838">
                                 <p class="notep1">注意：</p>
                                 <p>如果在步骤4中执行的查询返回<code class="codeph">TO PRIMARY</code>值，则可以从switchover语句中省略<code class="codeph">WITH SESSION SHUTDOWN</code>子句。</p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>打开新的主数据库：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN;</pre></div>
                        </li>
                        <li class="stepexpand"><span>在新的物理备用数据库上启动重做应用：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE  - &gt;断开会话;</pre></div>
                        </li>
                        <li class="stepexpand"><span>如果已在Oracle Data Guard配置中的任何其他物理备用数据库中停止，请重新启动重做应用：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE  - &gt;断开会话;</pre></div>
                        </li>
                     </ol>
                  </div>
               </div><a id="SBYDB5184"></a><div class="props_rev_3"><a id="GUID-AAAA9A3B-7A1A-4044-90EC-F581D87439F4" name="GUID-AAAA9A3B-7A1A-4044-90EC-F581D87439F4"></a><h4 id="SBYDB-GUID-AAAA9A3B-7A1A-4044-90EC-F581D87439F4" class="sect4"><span class="enumeration_section">G.2.2</span>使用旧语法执行到物理备用数据库的故障转移</h4>
                  <div>
                     <p>这些步骤描述了如何执行到物理备用数据库的故障转移。</p>
                     <ol>
                        <li class="stepexpand"><span>如果可能，请装入主数据库并将任何未发送的已归档和当前重做从主数据库刷新到备用数据库。如果此操作成功，即使主数据库不处于零数据丢失数据保护模式，也可以进行零数据丢失故障转移。</span><div>
                              <p>确保Redo Apply在目标备用数据库中处于活动状态。</p>
                              <p>挂载，但不要打开主数据库。如果无法装入主数据库，请转到步骤2。</p>
                              <p>在主数据库上发出以下SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM FLUSH REDO TO <span class="italic">target_db_name</span> ;</pre><p>对于<span class="italic"><code class="codeph">target_db_name</code></span> ，请指定备用数据库的<code class="codeph">DB_UNIQUE_NAME</code> ，该数据库将接收从主数据库刷新的重做。
                              </p>
                              <p>此语句刷新从主数据库到备用数据库的任何未发送的重做，并等待将该重做应用于备用数据库。</p>
                              <p>如果此语句完成且没有任何错误，请转到步骤5。如果语句以任何错误完成，或者由于您不能再等待语句完成而必须停止语句，请继续执行步骤2。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证备用数据库是否具有每个主数据库重做线程的最近归档的重做日志文件。</span><div>
                              <p>为此，请查询目标备用数据库上的<code class="codeph">V$ARCHIVED_LOG</code>视图，以获取每个重做线程的最高日志序列号。
                              </p>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT UNIQUE THREAD #AS THREAD，MAX（SEQUENCE＃） - &gt; OVER（PARTITION BY thread＃）AS VAST ARCHIVED_LOG;线程最后---------- ---------- 1 100</pre><p>如果可能，将每个主数据库重做线程的最近归档的重做日志文件复制到备用数据库（如果该数据库不存在），并进行注册。必须为每个重做线程执行此操作。</p>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE注册PHYSICAL LOGFILE'vilespec1';</pre></div>
                        </li>
                        <li class="stepexpand"><span>查询目标备用数据库上的<code class="codeph">V$ARCHIVE_GAP</code>视图，以确定目标备用数据库上是否存在任何重做间隙。</span><div>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT THREAD＃，LOW_SEQUENCE＃，HIGH_SEQUENCE＃FROM V $ ARCHIVE_GAP; THREAD＃LOW_SEQUENCE＃HIGH_SEQUENCE＃---------- ------------- -------------- 1 90 92</pre><p>在此示例中，间隙包括具有序列号90,91和92的归档重做日志文件，用于线程1。</p>
                              <p>如果可能，将任何缺少的归档重做日志文件从主数据库复制到目标备用数据库，并将它们注册到目标备用数据库。必须为每个重做线程执行此操作。</p>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE注册PHYSICAL LOGFILE'vilespec1';</pre></div>
                        </li>
                        <li class="stepexpand"><span>重复步骤3，直到解决所有间隙。（在步骤3中执行的查询仅显示最高间隙的信息，因此在解决间隙后，必须重复查询，直到不再返回任何行。）</span><div>
                              <p>如果在执行步骤2到步骤4之后，您无法解决归档重做日志文件中的所有空白（例如，因为您无权访问托管故障主数据库的系统），则会丢失一些数据在故障转移期间发生。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>在目标备用数据库上发出以下SQL语句以停止重做应用：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;</pre></div>
                        </li>
                        <li class="stepexpand"><span>完成应用所有收到的重做数据：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE FINISH;</pre><p>如果此语句完成且没有任何错误，则继续执行步骤7。</p>
                              <p>如果发生错误，则不会应用某些接收的重做数据。尝试解决错误原因并重新发出语句，然后再继续执行下一步。</p>
                              <p>如果在步骤3和步骤4中存在未解决的重做间隙，则会收到错误消息，指出存在重做间隙。</p>
                              <p>如果无法解决错误情况，则仍可通过在目标备用数据库上发出以下SQL语句来执行故障转移（丢失一些数据）：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE激活物理备用数据库;</pre><p>当<code class="codeph">ACTIVATE</code>语句完成时，继续执行步骤9。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>验证目标备用数据库是否已准备好成为主数据库。</span><div>
                              <p>为此，请查询目标备用数据库上<code class="codeph">V$DATABASE</code>视图的<code class="codeph">SWITCHOVER_STATUS</code>列。例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS -----------------要选择PRIMARY 1行</pre><p><code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code>值表示备用数据库已准备好切换到主要角色。如果未返回这些值，请验证Redo Apply是否处于活动状态并继续查询此视图，直到返回<code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code> 。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>在目标备用数据库上发出以下SQL语句，以将物理备用数据库切换为主要角色：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE使用SESSION SHUTDOWN进行切换到主切换;</pre><div class="infoboxnote" id="GUID-AAAA9A3B-7A1A-4044-90EC-F581D87439F4__GUID-EC00BDBC-06A6-4AD6-9F3B-C0843A933015">
                                 <p class="notep1">注意：</p>
                                 <p>如果在上一步骤中执行的<code class="codeph">SWITCHOVER_STATUS</code>列的查询返回<code class="codeph">TO PRIMARY</code>值，则可以从switchover语句中省略<code class="codeph">WITH SESSION SHUTDOWN</code>子句。</p>
                              </div>
                           </div>
                        </li>
                        <li class="stepexpand"><span>打开新的主数据库：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN;</pre></div>
                        </li>
                        <li class="stepexpand"><span>Oracle建议您现在备份新的主数据库。</span></li>
                        <li class="stepexpand"><span>如果已在Oracle Data Guard配置中的任何其他物理备用数据库中停止，请重新启动重做应用：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE  - &gt;断开会话;</pre></div>
                        </li>
                        <li class="stepexpand"><span>（可选）还原失败的主数据库。</span><div>
                              <p>故障转移后，可以<a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="After a failover occurs, the original primary database can no longer participate in the Oracle Data Guard configuration until it is repaired and established as a standby database in the new configuration.">使用使用闪回数据库</a> <a href="examples-of-using-oracle-data-guard.html#GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" title="To convert a failed primary database, Oracle recommends that you enable the Flashback Database feature on the primary and follow one of these procedures, as appropriate.">将故障主</a> <a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="发生故障转移后，原始主数据库无法再参与Oracle Data Guard配置，直到在新配置中将其修复并建立为备用数据库。">数据库</a> <a href="examples-of-using-oracle-data-guard.html#GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" title="要转换发生故障的主数据库，Oracle建议您在主数据库上启用闪回数据库功能，并根据需要执行以下过程之一。">转换为备用数据库或使用RMAN备份</a>将故障主数据库转换为备用数据库中描述的方法将原始主数据库转换为新主数据库的物理备用数据库，或者可以使用创建物理备用数据库<a href="creating-oracle-data-guard-physical-standby.html#GUID-A86D403B-B3F5-4B05-9255-5BADD513F9CF" title="These are the tasks you perform to create a physical standby database.">的分步说明中</a>描述的方法从新主数据库的备份中将其重新创建为<a href="creating-oracle-data-guard-physical-standby.html#GUID-A86D403B-B3F5-4B05-9255-5BADD513F9CF" title="这些是您创建物理备用数据库时执行的任务。">物理备用数据库</a> 。
                              </p>
                              <p>原始主数据库以备用角色运行后，可以执行切换以将其还原为主角色。</p>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div>
            </div><a id="SBYDB5205"></a><div class="props_rev_3"><a id="GUID-E80C5A58-6D05-4281-81DB-6268EE1757AC" name="GUID-E80C5A58-6D05-4281-81DB-6268EE1757AC"></a><h3 id="SBYDB-GUID-E80C5A58-6D05-4281-81DB-6268EE1757AC" class="sect3"><span class="enumeration_section">G.3</span>故障切换切换到物理备用数据库</h3>
               <div>
                  <p>这些是切换到物理备用数据库期间可能发生的一些问题。</p>
                  <p></p>
                  <div class="infoboxnote" id="GUID-E80C5A58-6D05-4281-81DB-6268EE1757AC__GUID-DBF51E79-DDB2-46AF-BEA8-FD655BE3F528">
                     <p class="notep1">注意：</p>
                     <p>以下故障排除主题仅适用于使用Oracle Database 12c第1版（12.1）之前的发行版中提供的过程执行切换和故障转移到物理备用数据库的情况。</p>
                  </div>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-9D024B1F-54EF-4C95-A810-1FA09B7AE3E4" title="如果切换未成功完成，您可以在V $ ARCHIVED_LOG视图中查询SEQUENCE＃列，以查看从原始主数据库传输的最后一个重做数据是否已应用于备用数据库。">切换失败，因为重做数据未传输</a></p>
                     </li>
                     <li>
                        <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-A9CF13FE-3E89-4FB3-B2BF-6536DCAD3ADB" title="如果您收到ORA-01102错误，这些是可能的原因和解决方案。">切换失败，出现ORA-01102错误</a></p>
                     </li>
                     <li>
                        <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-F394098F-8726-45AC-A66F-B91402719D6A" title="如果切换后归档的重做日志文件未应用于新的备用数据库，则可能是因为切换后未正确设置某些环境或初始化参数。">切换后不应用重做数据</a></p>
                     </li>
                     <li>
                        <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-2CF7243A-24DA-42CB-86C7-D48E648D9F5D" title="对于发生错误且无法继续切换的情况下的物理备用数据库，仍可能将新的物理备用数据库还原为主要角色。">切换失败后重新启动并重新开始</a></p>
                     </li>
                  </ul>
               </div><a id="SBYDB5206"></a><div class="props_rev_3"><a id="GUID-9D024B1F-54EF-4C95-A810-1FA09B7AE3E4" name="GUID-9D024B1F-54EF-4C95-A810-1FA09B7AE3E4"></a><h4 id="SBYDB-GUID-9D024B1F-54EF-4C95-A810-1FA09B7AE3E4" class="sect4"><span class="enumeration_section">G.3.1</span>切换失败，因为没有传输重做数据</h4>
                  <div>
                     <p>如果切换未成功完成，您可以在<code class="codeph">V$ARCHIVED_LOG</code>视图中查询<code class="codeph">SEQUENCE#</code>列，以查看从原始主数据库传输的最后一个重做数据是否已应用于备用数据库。
                     </p>
                     <div class="section">
                        <p>如果最后一个重做数据未传输到备用数据库，则可以手动将包含重做数据的存档重做日志文件从原始主数据库复制到旧备用数据库，并使用SQL <code class="codeph">ALTER DATABASE REGISTER LOGFILE</code> <span class="variable" translate="no">file_specification</span>语句进行<code class="codeph">ALTER DATABASE REGISTER LOGFILE</code> 。如果您随后开始应用服务，则会自动应用存档的重做日志文件。查询<code class="codeph">V$DATABASE</code>视图中的<code class="codeph">SWITCHOVER_STATUS</code>列。如果<code class="codeph">SWITCHOVER_STATUS</code>列返回<code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code>则现在可以切换到主要角色：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS -----------------要选择PRIMARY 1行</pre><p>有关<code class="codeph">SWITCHO</code>其他有效值的信息，请参阅<a href="oracle-data-guard-in-oracle-database-views.html#GUID-FF72163C-78B0-475F-B4CE-135EF288A32A" title="在监视Oracle Data Guard环境时，有许多视图特别有用。">与Oracle Data Guard相关</a>的<code class="codeph">SWITCHO</code> <a id="d69299e1190" class="indexterm-anchor"></a><a id="d69299e1194" class="indexterm-anchor"></a> <code class="codeph">V$DATABASE</code>视图的<code class="codeph">VER_STATUS</code>列。
                        </p>
                        <p>要继续切换，请按照<a href="performing-oracle-data-guard-role-transitions.html#GUID-65C1BE5E-A2AC-4938-B03F-2495761DE500" title="A switchover is initiated on the primary database and is completed on the target standby database.">使用旧语法执行切换到物理备用数据库中</a>的说明<a href="performing-oracle-data-guard-role-transitions.html#GUID-65C1BE5E-A2AC-4938-B03F-2495761DE500" title="在主数据库上启动切换，并在目标备用数据库上完成切换。">进行</a>操作，然后再次尝试将目标备用数据库切换为主要角色。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB5209"></a><div class="props_rev_3"><a id="GUID-A9CF13FE-3E89-4FB3-B2BF-6536DCAD3ADB" name="GUID-A9CF13FE-3E89-4FB3-B2BF-6536DCAD3ADB"></a><h4 id="SBYDB-GUID-A9CF13FE-3E89-4FB3-B2BF-6536DCAD3ADB" class="sect4"><span class="enumeration_section">G.3.2</span>切换因ORA-01102错误而失败</h4>
                  <div>
                     <p>如果您收到ORA-01102错误，这些是可能的原因和解决方案。</p>
                     <div class="section">
                        <p>假设备用数据库和主数据库位于同一站点上。在<code class="codeph">ALTER DATABASE COMMIT TO SWITCHOVER TO PHYSICAL</code> <code class="codeph">STANDBY</code>和<code class="codeph">ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY</code>语句之后，成功执行，关闭并重新启动物理备用数据库和主数据库。
                        </p>
                        <div class="infoboxnote" id="GUID-A9CF13FE-3E89-4FB3-B2BF-6536DCAD3ADB__GUID-5C2C8B82-FAE1-40CA-A092-4D530FE8A728">
                           <p class="notep1">注意：</p>
                           <p>如果物理备用数据库在实例启动后尚未以只读方式打开，则无需关闭并重新启动物理备用数据库。</p>
                        </div>
                        <p>但是，第二个数据库的启动失败， <code class="codeph">ORA-01102 cannot mount database in EXCLUSIVE mode</code>错误。
                        </p>
                        <p>如果未在备用数据库（原始主数据库）使用的初始化参数文件中设置<code class="codeph">DB_UNIQUE_NAME</code>参数，则可能会在切换期间发生这种情况。如果未设置备用数据库的<code class="codeph">DB_UNIQUE_NAME</code>参数，则备用数据库和主数据库都使用相同的安装锁定，并在启动第二个数据库期间导致ORA-01102错误。
                        </p>
                        <p>操作：将<code class="codeph">DB_UNIQUE_NAME=</code> <span class="italic"><code class="codeph">unique_database_name</code></span>添加到备用数据库使用的初始化参数文件中，然后关闭并重新启动备用数据库和主数据库。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB5210"></a><div class="props_rev_3"><a id="GUID-F394098F-8726-45AC-A66F-B91402719D6A" name="GUID-F394098F-8726-45AC-A66F-B91402719D6A"></a><h4 id="SBYDB-GUID-F394098F-8726-45AC-A66F-B91402719D6A" class="sect4">切换后不应用<span class="enumeration_section">G.3.3</span>重做数据</h4>
                  <div>
                     <p>如果切换后归档的重做日志文件未应用于新的备用数据库，则可能是因为切换后未正确设置某些环境或初始化参数。</p>
                     <div class="section">
                        <p>行动：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>检查<a id="d69299e1435" class="indexterm-anchor"></a><a id="d69299e1439" class="indexterm-anchor"></a>新主站点上的<code class="codeph">tnsnames.ora</code>文件和新备用站点上的<code class="codeph">listener.ora</code>文件。备用站点上的侦听器应该有条目，主站点上应该有相应的服务名称。
                              </p>
                           </li>
                           <li>
                              <p>如果尚未启动，则在备用站点启动侦听器。</p>
                           </li>
                           <li>
                              <p>检查<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>初始化参数是否已设置为正确地将重做数据从主站点传输到备用站点。例如，在主站点查询<code class="codeph">V$ARCHIVE_DEST</code>固定视图，如下所示：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DEST_ID，STATUS，DESTINATION from V $ ARCHIVE_DEST;</pre><p>如果没有看到与备用站点对应的条目，则需要设置<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>和<code class="codeph">LOG_ARCHIVE_DEST_STATE_</code> <span class="italic"><code class="codeph">n</code></span>初始化参数。
                              </p>
                           </li>
                           <li>
                              <p>验证在备用站点上是否正确设置了<code class="codeph">LOG_ARCHIVE_FORMAT</code>初始化参数。
                              </p>
                           </li>
                           <li>
                              <p>在备用站点，设置<a id="d69299e1489" class="indexterm-anchor"></a><a id="d69299e1493" class="indexterm-anchor"></a> <code class="codeph">DB_FILE_NAME_CONVERT</code>和<a id="d69299e1501" class="indexterm-anchor"></a><a id="d69299e1505" class="indexterm-anchor"></a> <code class="codeph">LOG_FILE_NAME_CONVERT</code>初始化参数。将<code class="codeph">STANDBY_FILE_MANAGEMENT</code>初始化参数设置为<code class="codeph">AUTO</code>以使备用站点能够自动添加在主站点上创建的新数据文件。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB5211"></a><div class="props_rev_3"><a id="GUID-2CF7243A-24DA-42CB-86C7-D48E648D9F5D" name="GUID-2CF7243A-24DA-42CB-86C7-D48E648D9F5D"></a><h4 id="SBYDB-GUID-2CF7243A-24DA-42CB-86C7-D48E648D9F5D" class="sect4"><span class="enumeration_section">G.3.4</span>切换失败并重新启动后回滚</h4>
                  <div>
                     <p>对于发生错误且无法继续切换的情况下的物理备用数据库，仍可能将新的物理备用数据库还原为主要角色。</p>
                     <div class="section">
                        <p>采取以下步骤：</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>关闭并装入新的备用数据库（旧的主数据库）。</span></li>
                        <li class="stepexpand"><span>在新的备用数据库上启动重做应用。</span></li>
                        <li class="stepexpand"><span>验证新备用数据库是否已准备好切换回主角色。查询新备用数据库上<code class="codeph">V$DATABASE</code>视图的<code class="codeph">SWITCHOVER_STATUS</code>列。例如：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS ----------------- TO_PRIMARY选择了1行</pre><p><code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code>值表示新备用数据库已准备好切换到主要角色。继续查询此列，直到返回的值为<code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code> 。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>发出以下语句以将新备用数据库转换回主要角色：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE使用SESSION SHUTDOWN进行切换到主切换;</pre><p>如果此语句成功，则数据库将以主数据库角色运行，您无需执行任何其他步骤。</p>
                              <p>如果此声明不成功，请继续步骤5。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>当启动切换以将角色从主服务器更改为物理服务器时，会在日志目录中写入跟踪文件。此跟踪文件包含重新创建原始主控制文件所需的SQL语句。找到跟踪文件并将SQL语句提取到临时文件中。从SQL * Plus执行临时文件。这会将新备用数据库还原为主角色。</span></li>
                        <li class="stepexpand"><span>关闭原始物理备用数据库。</span></li>
                        <li class="stepexpand"><span>创建一个新的备用控制文件。这是重新同步主数据库和物理备用数据库所必需的。将物理备用控制文件复制到原始物理备用系统。<a href="creating-oracle-data-guard-physical-standby.html#GUID-B471D788-AFD3-48B3-9709-D63C34DBC269" title="为备用数据库创建控制文件（主数据库不必打开，但必须至少安装它）。">为备用数据库创建控制文件</a>描述了如何创建物理备用控制文件。</span></li>
                        <li class="stepexpand"><span>重新启动原始物理备用实例。</span><div>
                              <p>如果此过程成功并且启用了存档间隙管理，则FAL进程会启动并将任何丢失的存档重做日志文件重新存档到物理备用数据库。强制主数据库上的日志切换并检查主数据库和物理备用数据库上的警报日志，以确保归档的重做日志文件序列号正确无误。</p>
                              <p>有关存档间隙管理和<a href="setting-LOG_ARCHIVE_TRACE-initialization-parameter.html#GUID-515A27B2-5163-42E1-A78D-B6E979BA54EB" title="Oracle数据库使用LOG_ARCHIVE_TRACE初始化参数来启用和控制日志归档和重做传输活动的综合跟踪信息的生成。">设置存档跟踪</a>的信息，请参阅<a href="oracle-data-guard-redo-transport-services.html#GUID-97EB433B-4125-4082-9276-2454349BC4F8" title="在某些情况下，无法自动执行间隙分辨，必须手动执行。">手动间隙分辨率</a> ，以获取有关查找跟踪文件的信息。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>再次尝试切换。</span><div>
                              <p>此时，Oracle Data Guard配置已回滚到其初始状态，您可以再次尝试切换操作（在纠正可能导致初始切换失败的任何问题之后）。</p>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>