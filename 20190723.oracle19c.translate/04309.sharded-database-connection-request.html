<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="abstract" content="">
      <meta name="description" content="">
      <title>About Handling Connection Requests for a Sharded Database</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="Universal Connection Pool Developer's Guide ">
      <meta property="og:description" content="">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="Universal Connection Pool Developer's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="universal-connection-pool-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2019-02-13T06:57:38-08:00">
      
      <meta name="dcterms.dateCopyrighted" content="1999, 2019">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E96473-02">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19">
      
      <link rel="prev" href="ucp-database-sharding-overview.html" title="Previous" type="text/html">
      <link rel="next" href="middle-tier-routing-using-ucp.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Universal Connection Pool Developer's Guide">
    <meta name="dcterms.isVersionOf" content="JJUCP">
    <meta name="dcterms.release" content="Release 19">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="ucp-database-sharding-overview.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="middle-tier-routing-using-ucp.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">Universal Connection Pool Developer's Guide </span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="ucp-database-sharding-support.html" property="item" typeof="WebPage"><span property="name">Shared Pool for Sharded Databases</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">About Handling Connection Requests for a Sharded Database</li>
            </ol>
            <a id="GUID-A0371FC7-5644-4AC7-AEFE-37BE974D6616" name="GUID-A0371FC7-5644-4AC7-AEFE-37BE974D6616"></a>
            
            <h2 id="JJUCP-GUID-A0371FC7-5644-4AC7-AEFE-37BE974D6616" class="sect2"><span class="enumeration_section">11.2 </span>About Handling Connection Requests for a Sharded Database
            </h2>
         </header>
         <div class="ind">
            <div>
               <p></p>
               <p>The following sections describe how Universal Connection Pool (UCP) handles connection requests for a sharded database:</p>
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="../jjdbc/database-sharding.html#JJDBC-GUID-D0D95DEB-0B38-4F70-AA1D-D03CB045E328" target="_blank">About Building the Sharding Key</a></p>
                  </li>
                  <li>
                     <p><a href="sharded-database-connection-request.html#GUID-3FA27C3E-58E9-4688-827A-77D855D852F0">How to Checkout Connections from a Pool with a Known Sharding key</a></p>
                  </li>
                  <li>
                     <p><a href="sharded-database-connection-request.html#GUID-940C3FA5-5D67-42D5-BBA0-6632BCD71127">About Checking Out Connections without Providing the Sharding Keys</a></p>
                  </li>
                  <li>
                     <p><a href="sharded-database-connection-request.html#GUID-117FCA87-57BE-4A11-A752-6D3FB9C1B677">About Connecting to the Catalog Database for Cross Shard Queries</a></p>
                  </li>
                  <li>
                     <p><a href="sharded-database-connection-request.html#GUID-40E98C33-2BB2-4787-B626-D5A4DD7DFDE5">About Configuring the Number of Connections Per Shard</a></p>
                  </li>
                  <li>
                     <p><a href="sharded-database-connection-request.html#GUID-B2C039D2-7169-406F-8497-305E5E58F9F6">Pool Connection Selection Algorithm During Connection Checkout</a></p>
                  </li>
                  <li>
                     <p><a href="sharded-database-connection-request.html#GUID-51CC6F8D-ECA0-479D-9107-7CAB2E4CA686">Failover or Resharding Event handling in UCP</a></p>
                  </li>
               </ul>
            </div>
            <div class="sect2"><a id="GUID-D0D95DEB-0B38-4F70-AA1D-D03CB045E328" name="GUID-D0D95DEB-0B38-4F70-AA1D-D03CB045E328"></a><h3 id="JJUCP-GUID-D0D95DEB-0B38-4F70-AA1D-D03CB045E328" class="sect3"><span class="enumeration_section">11.2.1 </span>About Building the Sharding Key
               </h3>
               <div>
                  <div class="section">
                     <p class="subhead2" id="GUID-D0D95DEB-0B38-4F70-AA1D-D03CB045E328__GUID-54BB180B-2BA7-42D4-ACF5-7B1D4F51D71A"></p>
                     <p>The shard aware applications must identify and build the sharding key and the super sharding key, which are required to establish a connection to the sharded database. For achieving this, the shard aware applications must use the <code class="codeph">OracleShardingKey</code> and the <code class="codeph">OracleShardingKeyBuilder</code> interfaces.
                     </p>
                     <p>The <code class="codeph">OracleShardingKeyBuilder</code> uses the following builder method for supporting compound keys with different data types:
                     </p><pre class="pre codeblock"><code>subkey(Object subkey, java.sql.SQLTYPE subkeyDataType)</code></pre><p>There are multiple invocations of the <code class="codeph">subkey</code> method on the builder for building a compound sharding key, where each subkey can be of different data types. The data type can be defined using the <code class="codeph">oracle.jdbc.OracleType</code> enum or <code class="codeph">java.sql.JDBCType</code>.
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="example" id="GUID-D0D95DEB-0B38-4F70-AA1D-D03CB045E328__GUID-AA0F82B8-48ED-4D5B-8BFB-E572EC98E266">
                     <p class="titleinexample">Example 11-1 Building a Sharding Key</p>
                     <p>The following example shows how to build a sharding key:</p><pre class="pre codeblock"><code>import java.sql.Connection;
import java.sql.Date;
import java.sql.SQLException;
import java.sql.Statement;

import oracle.jdbc.OracleShardingKey;
import oracle.jdbc.OracleType;
import oracle.ucp.jdbc.PoolDataSource;
import oracle.ucp.jdbc.PoolDataSourceFactory;

  public class ShardExample
  {   
    public static void main(String[] args) throws SQLException
    {   
      String url = "jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(HOST=myhost)(PORT=3216)(PROTOCOL=tcp))(CONNECT_DATA=(SERVICE_NAME=myservice)(REGION=east)))";
      String user="testuser1";
      String pwd = "password";
         
      PoolDataSource pds = PoolDataSourceFactory.getPoolDataSource();
      pds.setURL(url);
      pds.setUser(user);
      pds.setPassword(pwd);
      pds.setConnectionFactoryClassName("oracle.jdbc.pool.OracleDataSource");
      pds.setInitialPoolSize(5);
      pds.setMinPoolSize(5);
      pds.setMaxPoolSize(20);
                 
      // build the sharding key object
      Date shardingKeyVal = new java.sql.Date(0L);
      OracleShardingKey sdkey = pds.createShardingKeyBuilder()
                                   .subkey(shardingKeyVal, OracleType.DATE)
                                   .build();
      
      Connection conn = pds.createConnectionBuilder()
                            .shardingKey(sdkey)
                            .build();
     
      Statement stmt = conn.createStatement();
      stmt.execute("... SQL statement here ...");
      stmt.close();
      conn.close();
    }
  }</code></pre><p>The following code snippet shows how to build a compound sharding key that consists of String and Date data types:</p><pre class="pre codeblock"><code>...
Date shardingKeyVal = new java.sql.Date(0L);
...
OracleShardingKey shardingKey = datasource.createShardingKeyBuilder()
				          .subkey("abc@xyz.com", JDBCType.VARCHAR)
				          .subkey(shardingKeyVal, OracleType.DATE)
				          .build();
...</code></pre><div class="infoboxnote" id="GUID-D0D95DEB-0B38-4F70-AA1D-D03CB045E328__GUID-E6020FB5-8A0B-4A2C-B797-CFD1E057954B">
                        <p class="notep1">Note:</p>
                        <ul style="list-style-type: disc;">
                           <li>
                              <p>There is a fixed set of data types that are valid and supported. If any unsupported data types are used as keys, then exceptions are thrown. The following list specifies the supported data types:</p>
                              <ul style="list-style-type: disc;">
                                 <li>
                                    <p><code class="codeph">OracleType.VARCHAR2/JDBCType.VARCHAR</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.CHAR/JDBCType.CHAR</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.NVARCHAR/JDBCType.NVARCHAR</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.NCHAR/JDBCType.NCHAR</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.NUMBER/JDBCType.NUMERIC</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.FLOAT/ JDBCType.FLOAT</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.DATE/ JDBCType.DATE</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.TIMESTAMP/JDBCType.TIMESTAMP</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.TIMESTAMP_WITH_LOCAL_TIME_ZONE</code></p>
                                 </li>
                                 <li>
                                    <p><code class="codeph">OracleType.RAW</code></p>
                                 </li>
                              </ul>
                           </li>
                           <li>
                              <p>You must provide a sharding key that is compliant to the NLS formatting specified in the database.</p>
                           </li>
                        </ul>
                     </div>
                  </div>
                  <!-- class="example" -->
               </div>
            </div>
            <div class="sect2"><a id="GUID-3FA27C3E-58E9-4688-827A-77D855D852F0" name="GUID-3FA27C3E-58E9-4688-827A-77D855D852F0"></a><h3 id="JJUCP-GUID-3FA27C3E-58E9-4688-827A-77D855D852F0" class="sect3"><span class="enumeration_section">11.2.2 </span>How to Checkout Connections from a Pool with a Sharding Key
               </h3>
               <div>
                  <p></p>
                  <div class="section">When a connection is borrowed from UCP, then the shard aware application can provide the sharding key and the super sharding key using the new connection builder present in the <code class="codeph">PoolDataSource</code> class. If sharding keys do not exist or do not map to the data types specified by the database metadata, then an <code class="codeph">IllegalArgumentException</code> is thrown. The following code snippet shows how to checkout a connection with sharding keys:
                  </div>
                  <!-- class="section" -->
                  <div class="example" id="GUID-3FA27C3E-58E9-4688-827A-77D855D852F0__GUID-54956DEF-3628-4482-947B-47B95A69A1A1"><pre class="pre codeblock"><code>PoolDataSource pds = PoolDataSourceFactory.getPoolDataSource();
...
Connection conn = pds.createConnectionBuilder()
// Establish a connection using sharding key and super sharding key
		     .shardingKey(shardingKey) 
		     .superShardingKey(superShardingKey)
		     .build();

OracleShardingKey shardKey = pds.createShardingKeyBuilder() 
// Build a compound sharding key with email address and customer ID as the two sharding keys
				.subkey(&lt;email&gt;, OracleType.VARCHAR2)
				.subkey(&lt;custid&gt;, OracleType.NUMBER)
				.build();

OracleShardingKey superShardKey = pds.createShardingKeyBuilder() 
// Build a super sharding key with the customer region
				     .subkey(&lt;cust_region&gt;, OracleType.VARCHAR2)
				     .build();</code></pre><div class="infoboxnote" id="GUID-3FA27C3E-58E9-4688-827A-77D855D852F0__GUID-FB93CCD5-CB90-42F6-ACD5-9045955A9AE4">
                        <p class="notep1">Note:</p>
                        <p>You must specify a sharding key during the connection checkout. Otherwise, an error or exception is thrown back to the application. Race condition also results in exception during connection usage.</p>
                     </div>
                  </div>
                  <!-- class="example" -->
               </div>
            </div>
            <div class="sect2"><a id="GUID-940C3FA5-5D67-42D5-BBA0-6632BCD71127" name="GUID-940C3FA5-5D67-42D5-BBA0-6632BCD71127"></a><h3 id="JJUCP-GUID-940C3FA5-5D67-42D5-BBA0-6632BCD71127" class="sect3"><span class="enumeration_section">11.2.3 </span>About Checking Out Connections without Providing the Sharding Keys
               </h3>
               <div>
                  <p></p>
                  <div class="section">
                     <p>Providing sharding keys in a connection request through connection builder API is mandatory when you use UCP data source for connecting to a sharded database. If you do not provide the sharding key, then an exception is thrown back to the user.</p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
            <div class="sect2"><a id="GUID-117FCA87-57BE-4A11-A752-6D3FB9C1B677" name="GUID-117FCA87-57BE-4A11-A752-6D3FB9C1B677"></a><h3 id="JJUCP-GUID-117FCA87-57BE-4A11-A752-6D3FB9C1B677" class="sect3"><span class="enumeration_section">11.2.4 </span>About Connecting to the Shard Catalog or Co-ordinator for Multi Shard Queries
               </h3>
               <div>
                  <p></p>
                  <div class="section">
                     <p>When connecting to the Shard Catalog or Co-ordinator for running multi shard queries, it is recommended that a separate pool be created using a new <code class="codeph">PoolDataSource</code> instance. You can run multi shard queries on connections retrieved from a data source that is created on the coordinator service. The connection request for the coordinator should not have sharding keys in the connection builder API.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
            <div class="sect2"><a id="GUID-40E98C33-2BB2-4787-B626-D5A4DD7DFDE5" name="GUID-40E98C33-2BB2-4787-B626-D5A4DD7DFDE5"></a><h3 id="JJUCP-GUID-40E98C33-2BB2-4787-B626-D5A4DD7DFDE5" class="sect3"><span class="enumeration_section">11.2.5 </span>About Configuring the Number of Connections Per Shard
               </h3>
               <div>
                  <p></p>
                  <div class="section">
                     <p>When UCP is used to pool connections for a sharded database, the pool contains connections to different shards. So, when connections are pulled, to ensure a fair usage of the pool capacity across all shards connected, UCP uses the <code class="codeph">MaxConnectionsPerShard</code> parameter. This is a global parameter, which applies to every shard in the sharded database, and is used to limit the total number of connections to any shard below the specified limit.
                     </p>
                     <p>The following table describes the APIs for setting and retrieving this parameter:</p>
                     <div class="tblformal" id="GUID-40E98C33-2BB2-4787-B626-D5A4DD7DFDE5__GUID-06F31DF8-A456-4C24-81BB-33F808C95CB7">
                        <table cellpadding="4" cellspacing="0" class="Formal" title="" summary="Describes the APIs used to set and retrieve the MaxConnectionsPerShard parameter." frame="hsides" border="1" rules="rows">
                           <thead>
                              <tr align="left" valign="top">
                                 <th align="left" valign="bottom" id="d11988e380">Method</th>
                                 <th align="left" valign="bottom" id="d11988e382">Description</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" id="d11988e386" headers="d11988e380 "><code class="codeph">poolDatasource.setMaxConnectionsPerShard(&lt;max_connections_per_shard_limit&gt;)</code></td>
                                 <td align="left" valign="top" headers="d11988e386 d11988e382 ">Sets the maximum number of connections per shard.</td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" id="d11988e392" headers="d11988e380 "><code class="codeph">poolDatasource.getMaxConnectionsPerShard()</code></td>
                                 <td align="left" valign="top" headers="d11988e392 d11988e382 ">Retrieves the value that was set using the <code class="codeph">setMaxConnectionsPerShard(&lt;max_connections_per_shard_limit&gt;)</code> method.
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                     <!-- class="inftblhruleinformal" -->
                     <div class="infoboxnote" id="GUID-40E98C33-2BB2-4787-B626-D5A4DD7DFDE5__GUID-59DDBF16-DDF3-4768-B5FC-FBD8E11CCCB2">
                        <p class="notep1">Note:</p>
                        <p>You cannot use the <code class="codeph">MaxConnectionsPerShard</code> parameter in a sharded database with Oracle Golden Gate configuration.
                        </p>
                     </div>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
            <div class="sect2"><a id="GUID-B2C039D2-7169-406F-8497-305E5E58F9F6" name="GUID-B2C039D2-7169-406F-8497-305E5E58F9F6"></a><h3 id="JJUCP-GUID-B2C039D2-7169-406F-8497-305E5E58F9F6" class="sect3"><span class="enumeration_section">11.2.6 </span>Pool Connection Selection Algorithm During Connection Checkout
               </h3>
               <div>
                  <p></p>
                  <p>Whenever new connections are created through UCP to different shards in the sharded database, the pool incrementally learns and builds a shard routing cache internally.</p>
                  <p>The routing cache maps the sharding keys to the respective shards, on which the keys exist. While looking up connections in the pool for a connection request with specific sharding keys, UCP uses the cache to redirect the request to the correct shard. This feature, called Fast Path Connection Borrow, enables efficient reuse of connections in the pool, based on the requested sharding keys. This feature also helps in avoiding going to the sharded database for routing the requests.</p>
               </div>
            </div>
            <div class="sect2"><a id="GUID-51CC6F8D-ECA0-479D-9107-7CAB2E4CA686" name="GUID-51CC6F8D-ECA0-479D-9107-7CAB2E4CA686"></a><h3 id="JJUCP-GUID-51CC6F8D-ECA0-479D-9107-7CAB2E4CA686" class="sect3"><span class="enumeration_section">11.2.7 </span>Failover or Resharding Event Handling in UCP
               </h3>
               <div>
                  <p></p>
                  <p>After a resharding or failover event, an attempt is made to keep the UCP shard routing cache in sync with the data on the server. The cache is kept up-to-date by subscribing to the ONS notification for various changes on the database.</p>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>