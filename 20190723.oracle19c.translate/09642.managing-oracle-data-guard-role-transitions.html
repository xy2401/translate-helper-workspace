<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="An Oracle Data Guard configuration consists of one database that functions in the primary role and one or more databases that function in the standby role."></meta>
      <meta name="description" content="An Oracle Data Guard configuration consists of one database that functions in the primary role and one or more databases that function in the standby role."></meta>
      <title>角色转换</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Concepts and Administration "></meta>
      <meta property="og:description" content="An Oracle Data Guard configuration consists of one database that functions in the primary role and one or more databases that function in the standby role."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Concepts and Administration"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="data-guard-concepts-and-administration.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-02-12T10:50:21-08:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="1999, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96244-02"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="oracle-data-guard-redo-apply-services.html" title="Previous" type="text/html"></link>
      <link rel="next" href="managing-oracle-data-guard-physical-standby-databases.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Data Guard Concepts and Administration"></meta>
    <meta name="dcterms.isVersionOf" content="SBYDB"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="oracle-data-guard-redo-apply-services.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="managing-oracle-data-guard-physical-standby-databases.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">概念和管理</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="oracle-data-guard-concepts.html" property="item" typeof="WebPage"><span property="name">概念和管理</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">角色转换</li>
            </ol>
            <a id="GUID-44F26D5F-E036-4ACD-B8F0-224F5498FBCE" name="GUID-44F26D5F-E036-4ACD-B8F0-224F5498FBCE"></a><a id="SBYDB00600"></a>
            
            <h2 id="SBYDB-GUID-44F26D5F-E036-4ACD-B8F0-224F5498FBCE" class="sect2"><span class="enumeration_chapter">9</span>角色转换</h2>
         </header>
         <div class="ind">
            <div>
               <p>Oracle Data Guard配置包含一个在主角色中运行的数据库和一个在备用角色中运行的一个或多个数据库。</p>
               <p>要查看数据库的当前角色，请在<code class="codeph">V$DATABASE</code>视图中查询<code class="codeph">DATABASE_ROLE</code>列。
               </p>
               <p>Oracle Data Guard配置中备用数据库的数量，位置和类型以及主数据库中的重做数据传播到每个备用数据库的方式决定了您可用于响应主数据库中断的角色管理选项。</p>
               <p>有关如何在Oracle Data Guard配置中管理角色转换的信息，请参阅以下主题：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-BEB883C9-0391-472A-A05E-9A5776C06F4C" title="数据库以以下互斥角色之一运行：主要或备用。">角色转换简介</a></p>
                  </li>
                  <li>
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD" title="如果您运行的是Oracle Database 12c第1版（12.1）或更高版本，则可以简化对物理备用数据库执行切换和故障转移的过程。">涉及物理备用数据库的角色转换</a></p>
                  </li>
                  <li>
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-CE785178-FD22-4A81-9248-DF5ED8E91635" title="角色转换步骤因您执行切换还是故障转移而异。">涉及逻辑备用数据库的角色转换</a></p>
                  </li>
                  <li>
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-95E5629A-17F6-44B7-813F-00DD871359FA" title="在角色转换之后，您可以选择使用FLASHBACK DATABASE命令将数据库还原到角色转换发生之前的某个时间点或系统更改号（SCN）。">角色转换后使用闪回数据库</a></p>
                  </li>
               </ul>
               <div class="infoboxnote" id="GUID-44F26D5F-E036-4ACD-B8F0-224F5498FBCE__GUID-9C64ABA2-20BE-41F8-B873-73F97A2A446B">
                  <p class="notep1">注意：</p>
                  <p>这些主题描述了如何使用SQL语句手动执行角色转换。请勿使用这些手动过程在代理管理的Oracle Data Guard配置中执行角色转换。请改用<a href="../dgbkr/using-data-guard-broker-to-manage-switchovers-failovers.html#DGBKR330" target="_blank"><span class="italic">Oracle Data Guard Broker中</span></a>提供的角色转换过程。
                  </p>
               </div>
               <div class="infoboxnotealso" id="GUID-44F26D5F-E036-4ACD-B8F0-224F5498FBCE__GUID-FF152951-1BC1-43EF-9614-F7F3652DB5A1">
                  <p class="notep1">也可以看看：</p>
                  <p>有关使用的信息，请参阅<a href="../dgbkr/using-data-guard-broker-to-manage-switchovers-failovers.html#DGBKR330" target="_blank"><span class="italic">Oracle Data Guard Broker</span></a> <a id="d18444e148" class="indexterm-anchor"></a><a id="d18444e152" class="indexterm-anchor"></a> Oracle Data Guard经纪人：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>简化<a id="d18444e161" class="indexterm-anchor"></a><a id="d18444e165" class="indexterm-anchor"></a><a id="d18444e169" class="indexterm-anchor"></a><a id="d18444e173" class="indexterm-anchor"></a>转换和<a id="d18444e178" class="indexterm-anchor"></a><a id="d18444e182" class="indexterm-anchor"></a><a id="d18444e188" class="indexterm-anchor"></a><a id="d18444e192" class="indexterm-anchor"></a>允许您使用Oracle Enterprise Manager Cloud Control中的单个键单击或DGMGRL命令行界面中的单个命令来调用它们进行故障转移。
                        </p>
                     </li>
                     <li>
                        <p>启用<a id="d18444e200" class="indexterm-anchor"></a><a id="d18444e204" class="indexterm-anchor"></a><a id="d18444e210" class="indexterm-anchor"></a> <strong class="term">快速启动故障转移</strong>以在主数据库不可用时<span class="italic">自动进行</span> <strong class="term">故障转移</strong> 。启用快速启动故障切换后，Oracle Data Guard代理会确定是否需要进行故障切换，并自动启动故障切换到指定的目标备用数据库，而无需DBA干预。
                        </p>
                     </li>
                  </ul>
               </div>
            </div><a id="SBYDB00605"></a><div class="props_rev_3"><a id="GUID-BEB883C9-0391-472A-A05E-9A5776C06F4C" name="GUID-BEB883C9-0391-472A-A05E-9A5776C06F4C"></a><h3 id="SBYDB-GUID-BEB883C9-0391-472A-A05E-9A5776C06F4C" class="sect3"><span class="enumeration_section">9.1</span>角色转换简介</h3>
               <div>
                  <p>数据库以以下互斥角色之一运行： <span class="bold">主要</span>或<span class="bold">备用</span> 。
                  </p>
                  <p>Oracle Data Guard使您可以使用SQL语句或使用任一Oracle Data Guard代理接口动态更改这些角色。Oracle Data Guard支持以下角色转换：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><span class="bold">切换</span></p>
                        <p>允许主数据库使用其中一个备用数据库切换角色。切换期间没有数据丢失。切换后，每个数据库将继续以其新角色参与Oracle Data Guard配置。</p>
                     </li>
                     <li>
                        <p><span class="bold">故障转移</span></p>
                        <p>将备用数据库更改为主要角色以响应主数据库故障。如果主数据库在故障之前未在最大保护模式或最大可用性模式下运行，则可能会发生一些数据丢失。如果在主数据库上启用了闪回数据库，则可以在更正失败原因后将其恢复为新主数据库的备用数据库。</p>
                     </li>
                  </ul>
                  <div class="infoboxnotealso" id="GUID-BEB883C9-0391-472A-A05E-9A5776C06F4C__GUID-752E7364-0328-46FD-92C6-D251F34E163D">
                     <p class="notep1">也可以看看：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-66282DCD-5E7B-43C2-ADA1-03342E2750A0" title="Before starting any role transitions, you must verify that each database is properly configured and that there are no redo transport errors or redo gaps at the standby database.">准备角色转换</a>以获取有助于您选择最佳地减少停机时间和数据丢失风险的<a href="managing-oracle-data-guard-role-transitions.html#GUID-66282DCD-5E7B-43C2-ADA1-03342E2750A0" title="在开始任何角色转换之前，必须验证每个数据库是否已正确配置，以及备用数据库中是否存在重做传输错误或重做间隙。">角色转换</a>的信息</p>
                        </li>
                        <li>
                           <p> <a href="managing-oracle-data-guard-role-transitions.html#GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD" title="切换通常用于在计划中断期间减少主数据库停机时间。">切换</a>有关切换的更多信息。
                           </p>
                        </li>
                        <li>
                           <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083" title="A failover is typically used only when the primary database becomes unavailable, and there is no possibility of restoring it to service within a reasonable period of time.">故障转移</a>有关故障<a href="managing-oracle-data-guard-role-transitions.html#GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083" title="故障转移通常仅在主数据库不可用时使用，并且不可能在合理的时间段内将其恢复为服务。">转移</a>的更多信息</p>
                        </li>
                        <li>
                           <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=DGBKR3425" target="_blank"><span><cite>Oracle Data Guard Broker</cite></span></a> ，提供有关在发生代理管理的故障转移时数据库客户端可用的事件通知和数据库连接故障转移支持的信息</p>
                        </li>
                     </ul>
                  </div>
               </div><a id="SBYDB4769"></a><div class="props_rev_3"><a id="GUID-66282DCD-5E7B-43C2-ADA1-03342E2750A0" name="GUID-66282DCD-5E7B-43C2-ADA1-03342E2750A0"></a><h4 id="SBYDB-GUID-66282DCD-5E7B-43C2-ADA1-03342E2750A0" class="sect4"><span class="enumeration_section">9.1.1</span>准备角色转换</h4>
                  <div>
                     <p>在开始任何角色转换之前，必须验证每个数据库是否已正确配置，以及备用数据库中是否存在重做传输错误或重做间隙。</p>
                     <div class="section">
                        <ul style="list-style-type:disc">
                           <li>
                              <p>验证是否为其将要承担的角色正确配置了每个数据库。有关如何在<a href="creating-oracle-data-guard-physical-standby.html#GUID-B511FB6E-E3E7-436D-94B5-071C37550170" title="You can manually create a physical standby database in maximum performance mode using asynchronous redo transport and real-time apply, the default Oracle Data Guard configuration.">主数据库</a>和<a href="creating-oracle-data-guard-logical-standby.html#GUID-3666CA35-D993-44B6-8D70-A2B8B9EC8B2E" title="There are a number of steps involved in creating a logical standby database, including prerequisites and post-creation tasks.">备用数据库</a>上配置数据库初始化参数， <code class="codeph">ARCHIVELOG</code>模式，备用重做日志和联机重做日志的信息，请参阅<a href="creating-oracle-data-guard-physical-standby.html#GUID-B511FB6E-E3E7-436D-94B5-071C37550170" title="您可以使用异步重做传输和实时应用（默认的Oracle Data Guard配置）以最高性能模式手动创建物理备用数据库。">创建物理备用数据库</a>和<a href="creating-oracle-data-guard-logical-standby.html#GUID-3666CA35-D993-44B6-8D70-A2B8B9EC8B2E" title="创建逻辑备用数据库涉及许多步骤，包括先决条件和创建后任务。">创建逻辑</a>备用数据库。
                              </p>
                              <div class="infoboxnote" id="GUID-66282DCD-5E7B-43C2-ADA1-03342E2750A0__GUID-0BBF6EBE-CB46-4D87-A2C0-49BD927BD85E">
                                 <p class="notep1">注意：</p>
                                 <p>必须在每个备用数据库上定义<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>和<code class="codeph">LOG_ARCHIVE_DEST_STATE_</code> <span class="italic"><code class="codeph">n</code></span>参数，以便在发生切换或故障转移时，所有备用站点继续从新的主数据库接收重做数据。
                                 </p>
                              </div>
                           </li>
                           <li>
                              <p>通过查询主数据库上的<code class="codeph">V$ARCHIVE_DEST_STATUS</code>视图，验证备用数据库中是否存在重做传输错误或重做间隙。
                              </p>
                              <p>例如，以下查询将用于检查与<code class="codeph">LOG_ARCHIVE_DEST_2</code>关联的备用数据库的状态：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT STATUS，GAP_STATUS FROM V $ ARCHIVE_DEST_STATUS WHERE DEST_ID = 2;状态GAP_STATUS --------- ------------------------有效无效</pre><p>对于与备用数据库对应的行，在<code class="codeph">STATUS</code>列的值为<code class="codeph">VALID</code>且<code class="codeph">GAP_STATUS</code>列的值为<code class="codeph">NOGAP</code>之前，请勿继续。
                              </p>
                           </li>
                           <li>
                              <p>确保备用数据库上存在与主数据库上的临时文件匹配的临时文件。</p>
                           </li>
                           <li>
                              <p>删除应用重做的任何延迟，该重做可能对设置为新主数据库的备用数据库有效。不删除延迟会导致更长的切换时间，并且可能导致不允许切换。</p>
                           </li>
                           <li>
                              <p>在切换到处于实时查询模式的物理备用数据库之前，请考虑将该备用数据库的所有实例置于已挂载但未打开的状态，以实现最快的角色转换并彻底终止连接到该备用数据库的任何用户会话。角色转换之前的物理备用数据库。</p>
                           </li>
                           <li>
                              <p>当您执行从Oracle RAC主数据库切换到物理备用数据库时， <span class="italic">不必</span>关闭除一个主数据库实例之外的所有数据库实例。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB4770"></a><div class="props_rev_3"><a id="GUID-60804EE7-88C0-4CB7-AEE7-073EBCAFD1AC" name="GUID-60804EE7-88C0-4CB7-AEE7-073EBCAFD1AC"></a><h4 id="SBYDB-GUID-60804EE7-88C0-4CB7-AEE7-073EBCAFD1AC" class="sect4"><span class="enumeration_section">9.1.2</span>为角色转换选择目标备用数据库</h4>
                  <div>
                     <p>对于具有多个备用数据库的Oracle Data Guard配置，在为角色转换选择目标备用数据库时需要考虑许多因素。</p>
                     <p>这些包括以下内容：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>备用数据库的位置。</p>
                        </li>
                        <li>
                           <p>备用数据库的功能（硬件规格 - 例如CPU数量，可用I / O带宽等）。</p>
                        </li>
                        <li>
                           <p>执行角色转换所需的时间。这受备用数据库应用重做数据的距离以及在数据丢失时权衡应用程序可用性方面的灵活性的影响。</p>
                        </li>
                        <li>
                           <p>备用数据库类型。</p>
                        </li>
                     </ul>
                     <p>选择作为角色转换目标的备用数据类型确定配置中其他备用数据库在角色转换后的行为方式。如果新主服务器在角色转换之前是物理备用数据库，则配置中的所有其他备用数据库将成为新主数据库的备用数据库。如果新主服务器在角色转换之前是逻辑备用服务器，则配置中的所有其他逻辑备用服务器将成为新主服务器的备用服务器，但配置中的物理备用服务器仍然是旧主服务器的备用服务器，因此，不保护新主服务器主。在后一种情况下，将来切换或故障转移回原始主数据库会将所有备用数据库恢复为其原始角色，作为当前主数据库的备用数据库。由于上述原因，物理备用数据库通常是包含物理和逻辑备用数据库的配置中的最佳角色转换目标。</p>
                     <div class="infoboxnote" id="GUID-60804EE7-88C0-4CB7-AEE7-073EBCAFD1AC__GUID-554A7B80-8AD0-41F4-847A-7AAC34BE1287">
                        <p class="notep1">注意：</p>
                        <p>快照备用数据库不能成为角色转换的目标。要将快照备用数据库用作角色转换的目标，请首先将其转换为物理备用数据库，并允许应用从主数据库接收的所有重做。请参阅<a href="managing-oracle-data-guard-physical-standby-databases.html#GUID-36B87563-A971-43B4-8320-52BBA27EE749" title="这些步骤描述了如何将快照备用数据库转换为物理备用数据库。">将快照备用数据库转换为物理备用数据库</a> 。
                        </p>
                     </div>
                     <p>Oracle Data Guard提供了<a id="d18444e651" class="indexterm-anchor"></a> <code class="codeph">V$DATAGUARD_STATS</code>视图，可用于根据备用数据库中数据的货币评估每个备用数据库，以及在将所有可用重做数据应用于备用数据库时执行角色转换所需的时间。例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt;列名称格式A24 SQL&gt;列值格式A16 SQL&gt; COLUMN DATUM_TIME格式A24 SQL&gt; SELECT NAME，VALUE，DATUM_TIME FROM V $ DATAGUARD_STATS; NAME VALUE DATUM_TIME ------------------------ ---------------- ------- -----------------运输滞后+00 00:00:00 06/18/2009 12:22:06应用滞后+00 00:00:00 06/18/2009 12:22:06申请完成时间+00 00：00：00.000估计启动时间9</pre><p>此查询输出显示备用数据库已接收并应用主数据库生成的所有重做。这些统计数据是使用截至2009年6月18日12：22.06从主数据库收到的数据计算得出的。</p>
                     <p><code class="codeph">apply</code> <code class="codeph">lag</code>和<code class="codeph">transport</code> <code class="codeph">lag</code>度量是基于从主数据库接收的数据计算的。如果主数据库和备用数据库之间的通信中断，这些指标将变得陈旧。<code class="codeph">apply</code> <code class="codeph">lag</code>和<code class="codeph">transport</code> <code class="codeph">lag</code>度量标准在<code class="codeph">DATUM_TIME</code>列中的不变值表示这些度量标准未更新并且已变得陈旧，可能是由于主数据库和备用数据库之间的通信故障。<a id="d18444e690" class="indexterm-anchor"></a><a id="d18444e692" class="indexterm-anchor"></a><a id="d18444e694" class="indexterm-anchor"></a></p>
                  </div>
               </div><a id="SBYDB5135"></a><a id="SBYDB5034"></a><a id="SBYDB5035"></a><a id="SBYDB5036"></a><a id="SBYDB00610"></a><div class="props_rev_3"><a id="GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD" name="GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD"></a><h4 id="SBYDB-GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD" class="sect4"><span class="enumeration_section">9.1.3</span>切换</h4>
                  <div>
                     <p>切换通常用于在计划中断期间减少主数据库停机时间。</p>
                     <p>计划中断是诸如操作系统或硬件升级之类的事件，或Oracle数据库软件和补丁集的滚动升级。</p>
                     <p>切换分两个阶段进行。在第一阶段，现有主数据库将转换为备用角色。在第二阶段，备用数据库将转换为主要角色。</p>
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD__DAFDEHCI">图9-1</a>显示了在切换数据库角色之前的双站点Oracle Data Guard配置。主数据库位于旧金山，备用数据库位于波士顿。
                     </p>
                     <div class="figure" id="GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD__DAFDEHCI">
                        <p class="titleinfigure">图9-1切换前的Oracle Data Guard配置</p><img src="img/sbydb044.gif" alt="下面是图9-1的描述" title="下面是图9-1的描述" longdesc="img_text/sbydb044.html"><br><a href="img_text/sbydb044.html">“图9-1切换前的Oracle Data Guard配置”的说明</a></div>
                     <!-- class="figure" -->
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD__I1032037">图9-2</a>显示了在将原始主数据库切换到备用数据库之后但在原始备用数据库成为新的主数据库之前的Oracle Data Guard环境。在此阶段，Oracle Data Guard配置临时具有两个备用数据库。
                     </p>
                     <div class="figure" id="GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD__I1032037">
                        <p class="titleinfigure">图9-2切换到新主数据库之前的备用数据库</p><img src="img/sbydb045.gif" alt="下面是图9-2的描述" title="下面是图9-2的描述" longdesc="img_text/sbydb045.html"><br><a href="img_text/sbydb045.html">“图9-2切换到新主数据库之前的备用数据库”的说明</a></div>
                     <!-- class="figure" -->
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD__I1026434">图9-3</a>显示了切换发生后的Oracle Data Guard环境。原始备用数据库成为新的主数据库。主数据库现在位于波士顿，备用数据库现在位于旧金山。
                     </p>
                     <div class="figure" id="GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD__I1026434">
                        <p class="titleinfigure">图9-3切换后的Oracle Data Guard环境</p><img src="img/sbydb033.gif" alt="下面是图9-3的描述" title="下面是图9-3的描述" longdesc="img_text/sbydb033.html"><br><a href="img_text/sbydb033.html">“图9-3切换后的Oracle Data Guard环境”的说明</a></div>
                     <!-- class="figure" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD__GUID-E9A16A3B-A6F1-4AE6-BBFA-B5E4B04BCB8F">准备切换</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>确保满足<a href="managing-oracle-data-guard-role-transitions.html#GUID-66282DCD-5E7B-43C2-ADA1-03342E2750A0" title="在开始任何角色转换之前，必须验证每个数据库是否已正确配置，以及备用数据库中是否存在重做传输错误或重做间隙。">准备角色转换</a>中列出的先决条件。此外，切换时必须满足以下先决条件：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>对于涉及物理备用数据库的切换，请验证主数据库是否已打开，并且备用数据库上的Redo Apply是否处于活动状态。</p>
                           </li>
                           <li>
                              <p>对于涉及逻辑备用数据库的切换，请验证主数据库实例和备用数据库实例是否都已打开且SQL Apply是否处于活动状态。</p>
                           </li>
                        </ul>
                        <div class="infoboxnotealso" id="GUID-E86F0570-A207-4F14-AFE4-81B537B96AFD__GUID-AAB17FDE-146E-47CB-AA2B-94EFDE03EE21">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p><a href="using-sql-apply-to-perform-rolling-upgrade.html#GUID-290F632F-5295-47F3-AEF1-2D37C69C00D7" title="您可以使用逻辑备用数据库执行Oracle数据库软件的滚动升级。">使用SQL Apply升级Oracle数据库</a></p>
                              </li>
                              <li>
                                 <p><a href="oracle-data-guard-redo-apply-services.html#GUID-2B839172-947E-48A4-9FFD-33CC6907809F" title="执行重做应用时，物理备用数据库可以使用实时应用功能直接从备用重做日志文件应用重做，因为它们是由远程文件服务器（RFS）进程写入的。">将重做数据应用于物理备用数据库</a>以获取有关重做应用的更多信息</p>
                              </li>
                              <li>
                                 <p><a href="oracle-data-guard-redo-apply-services.html#GUID-7D8A891C-2906-4CC0-9181-B29C4F3C2450" title="SQL Apply将归档重做日志或备用重做日志中的数据转换为SQL语句，然后在逻辑备用数据库上执行这些SQL语句。">将重做数据应用于逻辑备用数据库</a>以获取有关SQL Apply的更多信息</p>
                              </li>
                           </ul>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB5037"></a><a id="SBYDB5038"></a><a id="SBYDB00615"></a><div class="props_rev_3"><a id="GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083" name="GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083"></a><h4 id="SBYDB-GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083" class="sect4"><span class="enumeration_section">9.1.4</span>故障转移</h4>
                  <div>
                     <p>故障转移通常仅在主数据库不可用时使用，并且不可能在合理的时间段内将其恢复为服务。</p>
                     <p>根据故障转移中是否包含逻。</p>
                     <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083__I1026472">图9-4</a>显示了从旧金山的主数据库到波士顿的物理备用数据库的故障转移结果。
                     </p>
                     <div class="figure" id="GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083__I1026472">
                        <p class="titleinfigure">图9-4故障转移到备用数据库</p><img src="img/sbydb048.gif" alt="下面是图9-4的描述" title="下面是图9-4的描述" longdesc="img_text/sbydb048.html"><br><a href="img_text/sbydb048.html">“图9-4故障转移到备用数据库”的说明</a></div>
                     <!-- class="figure" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083__GUID-40BF9A7B-158C-40B0-BEF1-75EFA6A02B72">准备故障转移</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <div class="infoboxnote" id="GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083__GUID-988CF46D-B923-40B7-9E3F-F967D21BCDB4">
                           <p class="notep1">注意：</p>
                           <p>如果为故障转移选择的物理备用数据库的托管备用数据库恢复已停止并出现错误<code class="codeph">ORA-752</code>或<code class="codeph">ORA-600</code> <code class="codeph">[3020]</code> ，则直接继续<a href="examples-of-using-oracle-data-guard.html#GUID-8F4E7807-6013-480F-8780-088F5639732F" title="在Oracle Data Guard配置中进行介质恢复期间，可以使用物理备用数据库检测主数据库上的丢失写入数据损坏错误。">从主数据库上的“从丢失写入错误中恢复”</a> 。
                           </p>
                        </div>
                        <p>如果可能，在执行故障转移之前，尽可能多地将可用和未应用的主数据库重做数据传输到备用数据库。
                        </p>
                        <p>确保满足<a href="managing-oracle-data-guard-role-transitions.html#GUID-66282DCD-5E7B-43C2-ADA1-03342E2750A0" title="在开始任何角色转换之前，必须验证每个数据库是否已正确配置，以及备用数据库中是否存在重做传输错误或重做间隙。">准备角色转换</a>中列出的先决条件。此外，还必须满足以下先决条件才能进行故障转移：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>如果故障转移中涉及当前以最大保护模式运行的备用数据库，则首先通过在备用数据库上发出以下语句将其置于最大性能模式：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; <a id="d18444e1026" class="indexterm-anchor"></a><a id="d18444e1032" class="indexterm-anchor"></a> ALTER DATABASE设置备用数据库以最大限度地提高性能;</pre><p>然后，如果有适当的备用数据库，则可以在故障转移完成后在新的主数据库上重置所需的保护模式。</p>
                              <p>这是必需的，因为您无法故障转移到处于最大保护模式的备用数据库。此外，如果处于最大保护模式的主数据库仍在与备用数据库进行主动通信，则发出<code class="codeph">ALTER DATABASE</code>语句以将备用数据库从最大保护模式更改为最高性能模式不会成功。由于故障转移会从Oracle Data Guard配置中删除原始主数据库，因此这些功能用于保护在最大保护模式下运行的主数据库免受意外故障转移的影响。
                              </p>
                              <div class="infoboxnote" id="GUID-3E6BE44A-3077-4E67-86E7-B641DBF30083__GUID-FEBEAD59-346D-4F99-89FF-3CDF97140760">
                                 <p class="notep1">注意：</p>
                                 <p>请勿故障转移到备用数据库以测试是否正确更新了sta ndby数据库。代替：</p>
                                 <ul style="list-style-type:disc">
                                    <li>
                                       <p>请参阅<a href="creating-oracle-data-guard-physical-standby.html#GUID-AAA6D97B-A345-4825-A320-B662BB16E2ED" title="创建物理备用数据库并设置重做传输服务后，您可能希望验证数据库修改是否已成功从主数据库传输到备用数据库。">验证物理备用数据库是否正常执行</a></p>
                                    </li>
                                    <li>
                                       <p>请参阅<a href="creating-oracle-data-guard-logical-standby.html#GUID-930CFC64-4EFD-4CF3-A5D0-062FBBD069E1" title="创建逻辑备用数据库后，验证它是否正常运行非常重要。">验证逻辑备用数据库是否正常执行</a></p>
                                    </li>
                                 </ul>
                              </div>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB4771"></a><div class="props_rev_3"><a id="GUID-18E84C50-79D7-4158-A5B8-FD0C3EEEB8B6" name="GUID-18E84C50-79D7-4158-A5B8-FD0C3EEEB8B6"></a><h4 id="SBYDB-GUID-18E84C50-79D7-4158-A5B8-FD0C3EEEB8B6" class="sect4"><span class="enumeration_section">9.1.5</span>角色转换触发器</h4>
                  <div>
                     <p>每当发生角色转换时，都会发出<code class="codeph">DB_ROLE_CHANGE</code>系统事件的信号。
                     </p>
                     <p>如果在发生角色转换时数据库是打开的，则立即发出此系统事件，如果在发生角色转换时关闭数据库，则下次打开该系统事件。</p>
                     <p><code class="codeph">DB_ROLE_CHANGE</code>系统事件可用于触发在发生角色转换时执行一组操作的触发器。
                     </p>
                  </div>
               </div>
            </div><a id="SBYDB4772"></a><div class="props_rev_3"><a id="GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD" name="GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD"></a><h3 id="SBYDB-GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD" class="sect3"><span class="enumeration_section">9.2</span>涉及物理备用数据库的角色转换</h3>
               <div>
                  <p>如果您运行的是Oracle Database 12 <span class="italic">c</span>第1版（12.1）或更高版本，则可以简化对物理备用数据库执行切换和故障转移的过程。
                  </p>
                  <p>仍支持以前的过程，但Oracle建议您使用以下部分中描述的新过程：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF" title="这些步骤描述了如何切换到物理备用数据库。">执行切换到物理备用数据库</a></p>
                     </li>
                     <li>
                        <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-1496944D-3089-4A56-A518-5F9FBF82D2C6" title="这些步骤描述了如何执行到物理备用数据库的故障转移。">执行故障转移到物理备用数据库</a></p>
                     </li>
                  </ul>
                  <div class="infoboxnote" id="GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD__GUID-67612FDB-0303-4EE9-AD40-28843C77BFE8">
                     <p class="notep1">注意：</p>从Oracle Database 18c开始，在角色转换期间，Active Data Guard备用数据库上维护数据库缓冲区高速缓存状态，以便应用程序性能不受从磁盘读取以填充缓冲区高速缓存的物理块的影响。这样可以在角色转换后提高新主数据库的应用程序性能。
                  </div>
                  <div class="section">
                     <p class="subhead2" id="GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD__GUID-62852B19-1871-4D3C-8B34-A7A02284E410">在角色转换期间保持物理备用会话连接</p>
                     <p>如Oracle数据库12 <code class="codeph">c</code> 2版（12.2.0.1），当物理备用数据库被转换成主你必须保持连接到物理备用连接的任何会话的选项，而无需中断，切换/故障转移期间。
                     </p>
                     <p>要启用此功能，请在启动备用实例之前在init.ora文件中设置<code class="codeph">STANDBY_DB_PRESERVE_STATES</code>初始化参数。此参数仅适用于物理备用数据库。允许的值是：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><code class="codeph">NONE</code> - 在切换/故障切换期间，未保留备用数据库上的任何会话。这是默认值。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">ALL</code> - 在切换/故障转移期间保留用户会话。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">SESSION</code> - 在切换/故障转移期间保留用户会话。
                           </p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
                  <div class="infoboxnotealso" id="GUID-857F6F45-DC1C-4345-BD39-F3BE7D79F1CD__GUID-C05ABA14-47E0-4ED7-98CC-67225C291BB3">
                     <p class="notep1">也可以看看：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="troubleshooting-oracle-data-guard.html#GUID-1AF3825C-C58B-4362-ADD5-A21FEF75912F" title="These are some of the problems that can occur on a standby database, and the troubleshooting procedures to address them.">对Oracle Data Guard</a>进行<a href="troubleshooting-oracle-data-guard.html#GUID-1AF3825C-C58B-4362-ADD5-A21FEF75912F" title="这些是备用数据库可能出现的一些问题，以及解决这些问题的故障排除过程。">故障排除，</a>以获取有关如何解决在执行到物理备用数据库的角色转换时可能遇到的问题的信息</p>
                        </li>
                        <li>
                           <p><a href="performing-oracle-data-guard-role-transitions.html#GUID-6E78412B-8E55-4D8B-A318-9F0612376E86" title="在Oracle Database 12c第1版（12.1）之前，执行切换和故障转移到物理备用数据库的过程是不同的。">执行角色转换使用旧语法</a>获取有关先前版本中使用的过程的信息，以及旧语法和新语法的比较</p>
                        </li>
                        <li>
                           <p>有关<code class="codeph">STANDBY_DB_PRESERVE_STATES</code>初始化参数的完整说明，请<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=REFRN-GUID-8D332556-30B7-4C45-8557-50988DC2219E" target="_blank"><span><cite>参见Oracle数据库参考</cite></span></a> 。
                           </p>
                        </li>
                     </ul>
                  </div>
               </div><a id="SBYDB5170"></a><div class="props_rev_3"><a id="GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF" name="GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF"></a><h4 id="SBYDB-GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF" class="sect4"><span class="enumeration_section">9.2.1</span>执行到物理备用数据库的切换</h4>
                  <div>
                     <p>这些步骤描述了如何切换到物理备用数据库。</p>
                     <div class="section">
                        <div class="infoboxnote" id="GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF__GUID-D6DE34A8-B3FA-4661-8491-4D99023BE608">
                           <p class="notep1">注意：</p>
                           <p>如果存在连接主数据库和备用数据库的远程同步实例（或首选远程同步实例和备用远程同步实例的组合），则切换到备用数据库的过程与本主题中描述的过程相同。远程同步实例是可用还是不可用不会影响切换。在切换期间，主服务器和备用服务器必须能够直接相互通信，并执行无法远程同步实例的切换角色转换步骤。有关如何正确设置此类配置的示例，请参阅<span><cite>Oracle Data Guard概念和管理中的</cite></span> “使用远程同步实例”，以便远程同步实例可以在切换后为两个数据库的新角色提供服务。
                           </p>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>验证目标备用数据库是否已准备好进行切换。</span><div>
                              <p>新的switchover语句具有<code class="codeph">VERIFY</code>选项，可以检查切换所需的许多条件。检查的一些项目是：Redo Apply是否在切换目标上运行;切换目标的发布版本是否为12.1或更高版本;切换目标是否同步;以及是否有MRP运行。
                              </p>
                              <p>假设主数据库具有<code class="codeph">BOSTON</code>的<code class="codeph">DB_UNIQUE_NAME</code> ，并且切换目标备用数据库具有<code class="codeph">CHICAGO</code>的<code class="codeph">DB_UNIQUE_NAME</code> 。在主数据库<code class="codeph">BOSTON</code> ，发出以下SQL语句以验证切换目标<code class="codeph">CHICAGO</code>是否已准备好进行切换：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE SWITCHOVER到CHICAGO VERIFY;第1行的错误：ORA-16470：重做应用未在切换目标上运行</pre><p>如果此操作成功，则会返回<code class="codeph">Database Altered</code>消息，但在此示例中返回了<code class="codeph">ORA-16470</code>错误。此错误意味着切换目标<code class="codeph">CHICAGO</code>尚未准备好进行切换。必须在切换操作之前启动重做应用。
                              </p>
                              <p>启动Redo Apply后，再次发出以下语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE SWITCHOVER到CHICAGO VERIFY;第1行的错误：ORA-16475：成功发出警告，查看警报日志了解更多详情</pre><p>切换目标<code class="codeph">CHICAGO</code>已准备好进行切换。但是， <code class="codeph">ORA-16475</code>错误指示的警告可能会影响切换性能。警报日志包含类似于以下内容的消息：</p><pre class="oac_no_warn" dir="ltr">SWITCHOVER VERIFY警告：切换目标具有需要清除的脏的联机重做日志文件。清除在线重做日志文件需要时间。这可能会减慢切换过程。
</pre><p>您可以解决问题，或者如果切换性能不重要，则可以忽略这些警告。在确定了必要的修复后，再次发出以下SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE SWITCHOVER到CHICAGO VERIFY;数据库改变了
</pre><p>切换目标<code class="codeph">CHICAGO</code>现在可以进行切换。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>通过发出以下SQL语句在主数据库<code class="codeph">BOSTON</code>上启动切换：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE SWITCHOVER TO CHICAGO;数据库改变了
</pre><p>如果此语句完成且没有任何错误，请继续执行步骤3。</p>
                              <p>如果发生错误，请装入旧的主数据库（ <code class="codeph">BOSTON</code> ）和旧的备用数据库（ <code class="codeph">CHICAGO</code> ）。在这两个数据库，查询<code class="codeph">DATABASE_ROLE</code>从<code class="codeph">V$DATABASE</code> 。 <code class="codeph">BOSTON</code>和<code class="codeph">CHICAGO</code>有三种可能的数据库角色组合。下表描述了这些组合，并为每种情况提供了可能的原因和高级补救措施。有关特定错误情况的详细信息，请参阅<span><cite>Oracle Data Guard概念和管理中的</cite></span> “ <span><cite>Oracle Data Guard</cite></span>故障排除”。
                              </p>
                              <div class="tblformal" id="GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF__GUID-721B4677-26AB-41E0-B888-4C5A8FEFD22D">
                                 <table cellpadding="4" cellspacing="0" class="Formal" title="" width="90%" border="1" summary="This table describes the possible causes, and remedial actions to take, for various values of V$DATABASE.DATABASE_ROLE. There are two columns and three rows." frame="hsides" rules="rows">
                                    <thead>
                                       <tr align="left" valign="top">
                                          <th align="left" valign="bottom" width="35%" id="d18444e1535">DATABASE_ROLE列在V $ DATABASE中的值</th>
                                          <th align="left" valign="bottom" width="65%" id="d18444e1538">原因和补救措施</th>
                                       </tr>
                                    </thead>
                                    <tbody>
                                       <tr align="left" valign="top">
                                          <td align="left" valign="top" width="35%" id="d18444e1543" headers="d18444e1535 ">
                                             <p><code class="codeph">BOSTON</code>数据库是主要的， <code class="codeph">CHICAGO</code>数据库是备用的</p>
                                          </td>
                                          <td align="left" valign="top" width="65%" headers="d18444e1543 d18444e1538 ">
                                             <p>原因： <code class="codeph">BOSTON</code>数据库无法转换为备用数据库角色。
                                             </p>
                                             <p>操作：有关阻止<code class="codeph">BOSTON</code>切换到备用角色的错误的详细信息，请参阅警报日志，采取必要的操作来修复错误，必要时重新打开<code class="codeph">BOSTON</code>其中一个节点，然后重复步骤1中的切换过程。
                                             </p>
                                          </td>
                                       </tr>
                                       <tr align="left" valign="top">
                                          <td align="left" valign="top" width="35%" id="d18444e1566" headers="d18444e1535 ">
                                             <p><code class="codeph">BOSTON</code>数据库处于待机状态， <code class="codeph">CHICAGO</code>数据库处于待机状态</p>
                                          </td>
                                          <td align="left" valign="top" width="65%" headers="d18444e1566 d18444e1538 ">
                                             <p>原因： <code class="codeph">CHICAGO</code>数据库无法转换为主数据库角色。
                                             </p>
                                             <p>操作：发出以下SQL语句以将<code class="codeph">BOSTON</code>或<code class="codeph">CHICAGO</code>转换为主数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE SWITCHOVER TO <span class="italic">target_db_name</span> FORCE;</pre><p>例如：</p>
                                             <ul style="list-style-type:disc">
                                                <li>
                                                   <p>在<code class="codeph">CHICAGO</code>数据库上，发出以下SQL语句以将其转换为主数据库：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE SWITCHOVER TO CHICAGO FORCE;</pre></li>
                                                <li>
                                                   <p>在<code class="codeph">BOSTON</code>数据库上，发出以下SQL语句以将其转换为主数据库：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE SWITCHOVER转向波士顿力量;</pre></li>
                                             </ul>
                                             <p>如果SQL语句因<code class="codeph">ORA-16473</code>错误而失败，则必须在重新发出命令之前启动重做应用。
                                             </p>
                                             <p>重启重做应用如下：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;</pre><p>重新发出切换命令如下：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE SWTICHOVER TO BOSTON FORCE;数据库改变了</pre></td>
                                       </tr>
                                       <tr align="left" valign="top">
                                          <td align="left" valign="top" width="35%" id="d18444e1626" headers="d18444e1535 ">
                                             <p><code class="codeph">BOSTON</code>数据库处于待机状态， <code class="codeph">CHICAGO</code>数据库是主数据库</p>
                                          </td>
                                          <td align="left" valign="top" width="65%" headers="d18444e1626 d18444e1538 ">
                                             <p>原因： <code class="codeph">BOSTON</code>和<code class="codeph">CHICAGO</code>数据库已成功切换到新角色，但将最终成功状态传回<code class="codeph">BOSTON</code>出错。</p>
                                             <p>操作：继续执行步骤3以完成切换操作。</p>
                                          </td>
                                       </tr>
                                    </tbody>
                                 </table>
                              </div>
                              <!-- class="inftblhruleinformal" -->
                           </div>
                        </li>
                        <li class="stepexpand"><span>在新的主数据库<code class="codeph">CHICAGO</code>上发出以下SQL语句以将其打开。</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN;</pre></div>
                        </li>
                        <li class="stepexpand"><span>发出以下SQL语句来挂载新的物理备用数据库<code class="codeph">BOSTON</code> ：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP MOUNT;</pre><p>或者，如果<code class="codeph">BOSTON</code>是Oracle Active Data Guard物理备用数据库，则发出以下SQL语句以将其打开为只读：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP;</pre></div>
                        </li>
                        <li class="stepexpand"><span>在新的物理备用数据库上启动重做应用。例如：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER管理待机数据库与会话断开连接;</pre></div>
                        </li>
                     </ol>
                  </div>
                  <div>
                     <div class="relinfo">
                        <p><strong>相关话题</strong></p>
                        <ul>
                           <li><a href="troubleshooting-oracle-data-guard.html#GUID-1AF3825C-C58B-4362-ADD5-A21FEF75912F" title="这些是备用数据库可能出现的一些问题，以及解决这些问题的故障排除过程。">Oracle Data Guard故障排除</a></li>
                           <li><a href="creating-oracle-data-guard-far-sync-instance.html#GUID-8AD7FBA2-42B0-46CF-852B-1AF0CB4A36E8" title="Oracle Data Guard远程同步实例是远程Oracle Data Guard目标，它接受来自主数据库的重做，然后将该重做发送到Oracle Data Guard配置的其他成员。">使用远程同步实例</a></li>
                        </ul>
                     </div>
                  </div>
                  
               </div><a id="SBYDB5171"></a><div class="props_rev_3"><a id="GUID-1496944D-3089-4A56-A518-5F9FBF82D2C6" name="GUID-1496944D-3089-4A56-A518-5F9FBF82D2C6"></a><h4 id="SBYDB-GUID-1496944D-3089-4A56-A518-5F9FBF82D2C6" class="sect4"><span class="enumeration_section">9.2.2</span>对物理备用数据库执行故障转移</h4>
                  <div>
                     <p>这些步骤描述了如何执行到物理备用数据库的故障转移。</p>
                     <ol>
                        <li class="stepexpand"><span>如果可以装入主数据库，则将任何未发送的已归档和当前重做从主数据库刷新到备用数据库。如果此操作成功，即使主数据库不处于零数据丢失数据保护模式，也可以进行零数据丢失故障转移。</span><div>
                              <p>首先，确保Redo Apply在目标备用数据库中处于活动状态。然后挂载，但不要打开主数据库。如果无法挂载主数据库，请转到步骤2。</p>
                              <p>如果尚未完成，则设置在主服务器上配置的远程<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>以指向目标目标。（您可能没有任何远程<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>如果目标目的地是由远同步实例提供服务，或者是在一个级联结构的终端待机配置）。此外，通过验证<code class="codeph">NET_ALIAS_TARGET_DB_NAME</code>是否有效并正确建立，确保主服务器可以连接到目标目标。
                              </p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM SET LOG_ARCHIVE_DEST_6 ='SERVICE = NET_ALIAS_TARGET_DB_NAME  - &gt; ASYNC VALID_FOR =（online_logfile，primary_role） - &gt; DB_UNIQUE_NAME =“target_db_unique_name”'SCOPE = memory;</pre><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_6 = ENABLE;</pre><p>还假设<code class="codeph">LOG_ARCHIVE_CONFIG</code>规范包括主数据库中目标目标的<code class="codeph">DB_UNIQUE_NAME</code> （目标目标的<code class="codeph">LOG_ARCHIVE_CONFIG</code>包括主数据库的<code class="codeph">DB_UNIQUE_NAME</code> ）。如果不是，则根据需要将该信息添加到主目标和目标目标的<code class="codeph">LOG_ARCHIVE_CONFIG</code> 。
                              </p>
                              <p>在主数据库上发出以下SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM FLUSH REDO TO <span class="italic">target_db_name</span> ;</pre><p>对于<code class="codeph">target_db_name</code> ，请指定备用数据库的<code class="codeph">DB_UNIQUE_NAME</code> ，该数据库将接收从主数据库刷新的重做。
                              </p>
                              <p>此语句刷新从主数据库到备用数据库的任何未发送的重做，并等待将该重做应用于备用数据库。</p>
                              <p>如果此语句完成且没有任何错误，请转到步骤5。如果语句以任何错误完成，或者由于您不能再等待语句完成而必须停止语句，请继续执行步骤2。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>查询目标备用数据库上的<code class="codeph">V$ARCHIVED_LOG</code>视图，以获取每个重做线程的最高日志序列号。</span><div>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT UNIQUE THREAD #AS THREAD，MAX（SEQUENCE＃） - &gt; OVER（PARTITION BY thread＃）AS VAST ARCHIVED_LOG;线程最后---------- ---------- 1 100</pre><p>如果可能，将每个主数据库重做线程的最近归档的重做日志文件复制到备用数据库（如果该数据库不存在），并进行注册。必须为每个重做线程执行此操作。</p>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE注册PHYSICAL LOGFILE'vilespec1';</pre></div>
                        </li>
                        <li class="stepexpand"><span>查询目标备用数据库上的<code class="codeph">V$ARCHIVE_GAP</code>视图，以确定目标备用数据库上是否存在任何重做间隙。</span><div>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT THREAD＃，LOW_SEQUENCE＃，HIGH_SEQUENCE＃FROM V $ ARCHIVE_GAP; THREAD＃LOW_SEQUENCE＃HIGH_SEQUENCE＃---------- ------------- -------------- 1 90 92</pre><p>在此示例中，间隙包括具有序列号90,91和92的归档重做日志文件，用于线程1。</p>
                              <p>如果可能，将任何缺少的归档重做日志文件从主数据库复制到目标备用数据库，并将它们注册到目标备用数据库。必须为每个重做线程执行此操作。</p>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE注册PHYSICAL LOGFILE'vilespec1';</pre></div>
                        </li>
                        <li class="stepexpand"><span>在步骤3中执行的查询仅显示最高间隙的信息。解决间隙后，必须重复查询，直到不再返回任何行。</span><div>
                              <p>如果在执行步骤2到步骤4之后，您无法解决归档重做日志文件中的所有空白（例如，因为您无权访问托管失败的主数据库的系统），那么您可以期待一些故障转移期间的数据丢失。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>在目标备用数据库上发出以下SQL语句：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;</pre></div>
                        </li>
                        <li class="stepexpand"><span>在目标备用数据库上发出以下SQL语句：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE FAILOVER TO <span class="italic">target_db_name</span> ;</pre><p>例如，假设目标备用数据库名为<code class="codeph">CHICAGO</code> ：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE FAILOVER TO CHICAGO;</pre><p>如果此语句完成且没有任何错误，请继续执行步骤10。</p>
                              <p>如果有错误，请转到步骤7。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>如果发生错误，请尝试解决错误原因，然后重新发出该语句。</span><div>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果成功，请转到步骤10。</p>
                                 </li>
                                 <li>
                                    <p>如果错误仍然发生且涉及远程同步实例，请转到步骤8。</p>
                                 </li>
                                 <li>
                                    <p>如果错误仍然发生且没有涉及远程同步实例，请转到步骤9。</p>
                                 </li>
                              </ul>
                           </div>
                        </li>
                        <li class="stepexpand"><span>此步骤仅适用于远程同步实例错误情况。如果错误涉及远程同步实例（例如，它不可用）并且您已尝试解决问题并重新发出语句但未成功，则可以使用<code class="codeph">FORCE</code>选项。例如：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE FAILVOVER TO CHICAGO FORCE;</pre><p><code class="codeph">FORCE</code>选项指示故障转移忽略与远程同步实例交互时遇到的任何故障，并在可能的情况下继续进行故障转移。（仅当远程同步实例为故障转移目标提供服务时， <code class="codeph">FORCE</code>选项才有意义。）
                              </p>
                              <p>如果<code class="codeph">FORCE</code>选项成功，请转到步骤10。
                              </p>
                              <p>如果<code class="codeph">FORCE</code>选项不成功，请转到步骤9。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>执行数据丢失故障转移。</span><div>
                              <p>如果无法解决错误情况，则仍可通过在目标备用数据库上发出以下SQL语句来执行故障转移（丢失一些数据）：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE激活物理备用数据库;</pre><p>在以下示例中，故障转移操作失败，并显示<code class="codeph">ORA-16472</code>错误。该错误意味着数据库配置为MaxAvailability或MaxProtection模式，但在故障转移期间检测到数据丢失。
                              </p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE FAILOVER TO CHICAGO;第1行的错误：ORA-16472：由于数据丢失，故障转移失败</pre><p>您可以通过发出以下SQL语句来完成数据丢失故障转移：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE激活物理备用数据库;数据库改变了
</pre></div>
                        </li>
                        <li class="stepexpand"><span>打开新的主数据库：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE OPEN;</pre></div>
                        </li>
                        <li class="stepexpand"><span>Oracle建议您执行新主数据库的完整备份。</span></li>
                        <li class="stepexpand"><span>如果Redo Apply已停止在Data Guard配置中的任何其他物理备用数据库中，则重新启动它。例如：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;</pre></div>
                        </li>
                        <li class="stepexpand"><span>故障转移后，可以<a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="After a failover occurs, the original primary database can no longer participate in the Oracle Data Guard configuration until it is repaired and established as a standby database in the new configuration.">使用使用闪回数据库</a> <a href="examples-of-using-oracle-data-guard.html#GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" title="To convert a failed primary database, Oracle recommends that you enable the Flashback Database feature on the primary and follow one of these procedures, as appropriate.">将故障主</a> <a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="发生故障转移后，原始主数据库无法再参与Oracle Data Guard配置，直到在新配置中将其修复并建立为备用数据库。">数据库</a> <a href="examples-of-using-oracle-data-guard.html#GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" title="要转换失败的主数据库，Oracle建议您在主数据库上启用闪回数据库功能，并根据需要执行以下过程之一。">转换为备用数据库或使用RMAN备份</a>将故障主数据库转换为备用数据库中描述的方法将原始主数据库转换为新主数据库的物理备用数据库，或者可以使用创建物理备用数据库<a href="creating-oracle-data-guard-physical-standby.html#GUID-A86D403B-B3F5-4B05-9255-5BADD513F9CF" title="These are the tasks you perform to create a physical standby database.">的分步说明中</a>描述的方法从新主数据库的备份中将其重新创建为<a href="creating-oracle-data-guard-physical-standby.html#GUID-A86D403B-B3F5-4B05-9255-5BADD513F9CF" title="这些是您创建物理备用数据库时执行的任务。">物理备用数据库</a> 。</span><div>
                              <p>原始主数据库以备用角色运行后，可以执行切换以将其还原为主角色。</p>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div>
            </div><a id="SBYDB4773"></a><div class="props_rev_3"><a id="GUID-CE785178-FD22-4A81-9248-DF5ED8E91635" name="GUID-CE785178-FD22-4A81-9248-DF5ED8E91635"></a><h3 id="SBYDB-GUID-CE785178-FD22-4A81-9248-DF5ED8E91635" class="sect3"><span class="enumeration_section">9.3</span>涉及逻辑备用数据库的角色转换</h3>
               <div>
                  <p>角色转换步骤因您执行切换还是故障转移而异。</p>
                  <p>有关如何执行涉及逻辑备用数据库的切换和故障转移的信息，请参阅以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-42B8B448-90E0-4D7D-82A3-AAA273E6E49B" title="执行切换以更改主数据库和逻辑备用数据库之间的角色时，请始终在主数据库上启动切换并在逻辑备用数据库上完成切换。">执行切换到逻辑备用数据库</a></p>
                     </li>
                     <li>
                        <p><a href="managing-oracle-data-guard-role-transitions.html#GUID-EBD0C21B-6356-446E-8BF5-7B7D96554713" title="涉及逻辑备用数据库的故障转移角色转换需要对发生故障的主数据库和所有旁观者逻辑备用数据库采取纠正措施。">执行故障转移到逻辑备用数据库</a></p>
                     </li>
                  </ul>
                  <div class="infoboxnote" id="GUID-CE785178-FD22-4A81-9248-DF5ED8E91635__GUID-132CC199-8259-4982-A390-F7A7EE9357A9">
                     <p class="notep1">注意：</p>
                     <p>逻辑备用数据库不会复制数据库服务。如果发生故障转移或切换到逻辑备用数据库，连接到主服务器的中间层将无法连接（因为未复制服务的创建），或连接到不正确的版本（因为修改了不复制服务属性）。</p>
                     <p>Oracle Clusterware不会将其管理的服务复制到逻辑备用数据库。您必须手动使它们在主要和备用之间保持同步。有关<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=CWADD1111" target="_blank"><span class="italic">Oracle Clusterware</span></a>的详细信息，请参见“ <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=CWADD1111" target="_blank"><span class="italic">Oracle Clusterware管理和部署指南”</span></a> 。
                     </p>
                  </div>
               </div><a id="SBYDB00630"></a><div class="props_rev_3"><a id="GUID-42B8B448-90E0-4D7D-82A3-AAA273E6E49B" name="GUID-42B8B448-90E0-4D7D-82A3-AAA273E6E49B"></a><h4 id="SBYDB-GUID-42B8B448-90E0-4D7D-82A3-AAA273E6E49B" class="sect4"><span class="enumeration_section">9.3.1</span>执行切换到逻辑备用数据库</h4>
                  <div>
                     <p>执行切换以更改主数据库和逻辑备用数据库之间的角色时，请始终在主数据库上启动切换并在逻辑备用数据库上完成切换。</p>
                     <div class="section">
                        <p>要使切换成功，必须按照描述顺序执行这些步骤。</p>
                        <ol>
                           <li>
                              <p>在当前主数据库上，查询主数据库上<code class="codeph">V$DATABASE</code>固定视图的<code class="codeph">SWITCHOVER_STATUS</code>列，以验证是否可以执行切换。
                              </p>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS ----------------- TO STANDBY选择1行</pre><p><code class="codeph">SWITCHOVER_STATUS</code>列中的<code class="codeph">TO STANDBY</code>或<code class="codeph">SESSIONS ACTIVE</code>值表示可以将主数据库切换到逻辑备用角色。如果未显示其中一个值，则验证Oracle Data Guard配置是否正常运行（例如，验证是否正确指定了所有<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>参数值）。有关<code class="codeph">V$DATABASE</code>视图的<code class="codeph">SWITCHOVER_STATUS</code>列的其他有效值的信息，请参见<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=REFRN30047" target="_blank"><span class="italic">Oracle数据库参考</span></a> 。
                              </p>
                           </li>
                           <li>
                              <p>要为逻辑备用数据库角色准备当前主数据库，请在主数据库上发出以下SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; <a id="d18444e2251" class="indexterm-anchor"></a><a id="d18444e2255" class="indexterm-anchor"></a> ALTER DATABASE准备切换到LOGICAL STANDBY;</pre><p>此语句通知当前主数据库它将很快切换到逻辑备用角色并开始从新的主数据库接收重做数据。您可以在主数据库上执行此步骤，以准备接收要记录在当前逻辑备用数据库的重做流中的LogMiner字典，如步骤3中所述。</p>
                              <p>如果此操作成功，则值<code class="codeph">PREPARING SWITCHOVER</code>将显示在<code class="codeph">V$DATABASE.SWITCHOVER_STATUS</code>列中。
                              </p>
                           </li>
                           <li>
                              <p>使用以下语句在作为切换目标的逻辑备用数据库上构建LogMiner字典：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; <a id="d18444e2275" class="indexterm-anchor"></a><a id="d18444e2279" class="indexterm-anchor"></a> ALTER DATABASE准备切换到初级;</pre><p>此语句还会在逻辑备用数据库上启动重做传输服务，该数据库开始将其重做数据传输到当前主数据库以及Oracle Data Guard配置中的其他备用数据库。从此逻辑备用数据库接收重做数据的站点接受重做数据但不应用它。</p>
                              <p>逻辑备用数据库上的<code class="codeph">V$DATABASE.SWITCHOVER_STATUS</code>最初显示<code class="codeph">PREPARING DICTIONARY</code>而LogMiner字典正在重做流中记录。成功完成后， <code class="codeph">SWITCHOVER_STATUS</code>列将显示<code class="codeph">PREPARING SWITCHOVER</code> 。</p>
                           </li>
                           <li>
                              <p>在完成主数据库到逻辑备用角色的角色转换之前，请通过查询主数据库上<code class="codeph">V$DATABASE</code>固定视图的<code class="codeph">SWITCHOVER_STATUS</code>列来验证主数据库是否收到了LogMiner字典。如果没有收到LogMiner字典，则切换无法继续，因为当前主数据库必须能够解释从未来主数据库发送的重做记录。<code class="codeph">SWITCHOVER_STATUS</code>列显示<code class="codeph">SWITCHOVER_STATUS</code>的进度。
                              </p>
                              <p>当查询返回<code class="codeph">TO LOGICAL STANDBY</code>值时，您可以继续执行步骤5。例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS -----------------至LOGICAL STANDBY选择1行</pre><div class="infoboxnote" id="GUID-42B8B448-90E0-4D7D-82A3-AAA273E6E49B__GUID-7E72F6DC-4D65-4EE5-8F30-D2EB88E76FAE">
                                 <p class="notep1">注意：</p>
                                 <p>您可以通过按所示顺序发出以下语句来取消切换操作：</p>
                                 <ol type="a">
                                    <li>
                                       <p>取消主数据库上的切换：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE PREPARE TO SWITCHOVER CANCEL;</pre></li>
                                    <li>
                                       <p>取消逻辑备用数据库上的切换：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE PREPARE TO SWITCHOVER CANCEL;</pre></li>
                                 </ol>
                              </div>
                           </li>
                           <li>
                              <p>要完成主数据库到逻辑备用数据库的角色转换，请发出以下SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; <a id="d18444e2338" class="indexterm-anchor"></a><a id="d18444e2342" class="indexterm-anchor"></a> ALTER DATABASE承诺切换到LOGICAL STANDBY;</pre><p>此语句等待主数据库上的所有当前事务结束，阻止任何新用户启动新事务，并建立切换提交的时间点。</p>
                              <p>执行此语句还会阻止用户对逻辑备用数据库中维护的数据进行任何更改。要确保更快的执行，请确保在发出切换语句之前主数据库处于安静状态且没有更新活动（例如，让所有用户临时注销主数据库）。您可以查询<code class="codeph">V$TRANSACTION</code>视图，以获取有关可能延迟执行此语句的任何当前正在进行的事务的状态的信息。
                              </p>
                              <p>主数据库现在已经过角色转换以在备用数据库角色中运行。</p>
                              <p>当主数据库经历角色转换为逻辑备用数据库角色时，您不必关闭并重新启动数据库。</p>
                           </li>
                           <li>
                              <p>完成主数据库到逻辑备用角色的角色转换并且配置中的备用数据库收到切换通知后，通过查询<code class="codeph">V$DATABASE</code>的<code class="codeph">SWITCHOVER_STATUS</code>列，验证目标备用数据库是否处理了切换通知目标备用数据库上的固定视图。将所有可用的重做记录应用于逻辑备用数据库后，SQL Apply会自动关闭，以预期会发生预期的角色转换。
                              </p>
                              <p>更新<code class="codeph">SWITCHOVER_STATUS</code>值以显示切换期间的进度。当状态为“ <code class="codeph">TO PRIMARY</code> ，您可以继续执行步骤7。
                              </p>
                              <p>例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS -----------------要选择PRIMARY 1行</pre><p>有关<code class="codeph">V$DATABASE</code>视图的<code class="codeph">SWITCHOVER_STATUS</code>列的其他有效值的信息，请参见<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=REFRN30047" target="_blank"><span class="italic">Oracle数据库参考</span></a> 。
                              </p>
                           </li>
                           <li>
                              <p>在要切换到主角色的逻辑备用数据库上，使用以下SQL语句将逻辑备用数据库切换到主角色：</p><pre class="oac_no_warn" dir="ltr">SQL&gt;更新数据库提交切换到主要;</pre><p>无需关闭并重新启动Oracle Data Guard配置中的任何逻辑备用数据库。如<a href="managing-oracle-data-guard-role-transitions.html#GUID-60804EE7-88C0-4CB7-AEE7-073EBCAFD1AC" title="For an Oracle Data Guard configuration with multiple standby databases, there are a number of factors to consider when choosing the target standby database for a role transition.">为角色转换选择目标备用数据库</a>中所述，配置中的所有其他逻辑<a href="managing-oracle-data-guard-role-transitions.html#GUID-60804EE7-88C0-4CB7-AEE7-073EBCAFD1AC" title="对于具有多个备用数据库的Oracle Data Guard配置，在为角色转换选择目标备用数据库时需要考虑许多因素。">备用数据库</a>都成为新主数据库的备用数据库，但任何物理备用数据库仍然是原始主数据库的备用数据库。
                              </p>
                           </li>
                           <li>
                              <p>在新的逻辑备用数据库上，启动SQL Apply：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;</pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB00635"></a><div class="props_rev_3"><a id="GUID-EBD0C21B-6356-446E-8BF5-7B7D96554713" name="GUID-EBD0C21B-6356-446E-8BF5-7B7D96554713"></a><h4 id="SBYDB-GUID-EBD0C21B-6356-446E-8BF5-7B7D96554713" class="sect4"><span class="enumeration_section">9.3.2</span>对逻辑备用数据库执行故障转移</h4>
                  <div>
                     <p>涉及逻辑备用数据库的故障转移角色转换需要对发生故障的主数据库和所有旁观者逻辑备用数据库采取纠正措施。</p>
                     <div class="section">
                        <p>本主题描述如何执行涉及逻辑备用数据库的故障转移。如果未在故障主数据库上启用闪回数据库，则必须从从当前主数据库获取的备份重新创建数据库。否则，您可以按照<a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="After a failover occurs, the original primary database can no longer participate in the Oracle Data Guard configuration until it is repaired and established as a standby database in the new configuration.">使用闪回数据库</a>将故障主数据库转换为<a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="发生故障转移后，原始主数据库无法再参与Oracle Data Guard配置，直到在新配置中将其修复并建立为备用数据库。">备用数据库中</a>所述的过程将故障主数据库转换为新主数据库的逻辑备用数据库。
                        </p>
                        <p>根据配置的保护模式和为重做传输服务选择的属性，可以自动恢复所有或部分主数据库修改。</p>
                        <ol>
                           <li>
                              <p>如果可以装入主数据库，则将任何未发送的已归档和当前重做从主数据库刷新到备用数据库。如果此操作成功，即使主数据库不处于零数据丢失数据保护模式，也可以进行零数据丢失故障转移。</p>
                              <p>首先，确保Redo Apply在目标备用数据库中处于活动状态。然后挂载，但不要打开主数据库。</p>
                              <p>在主数据库上发出以下SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM FLUSH REDO TO target_db_name;</pre><p>对于<code class="codeph">target_db_name</code> ，请指定备用数据库的<code class="codeph">DB_UNIQUE_NAME</code> ，该数据库将接收从主数据库刷新的重做。
                              </p>
                              <p>此语句刷新从主数据库到备用数据库的任何未发送的重做，并等待将该重做应用于备用数据库。</p>
                           </li>
                           <li>
                              <p>根据配置中组件的条件，您可以访问主数据库上的归档重做日志文件。如果是这样，请执行以下操作：</p>
                              <ol type="a">
                                 <li>
                                    <p>确定逻辑备用数据库上是否缺少任何已归档的重做日志文件。</p>
                                 </li>
                                 <li>
                                    <p>将缺少的日志文件从主数据库复制到逻辑备用数据库。</p>
                                 </li>
                                 <li>
                                    <p>注册复制的日志文件。</p>
                                 </li>
                              </ol>
                              <p>您可以通过发出以下语句向逻辑备用数据库注册存档的重做日志文件，例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE REGISTER LOGICAL LOGFILE  - &gt;'/disk1/oracle/dbs/log-%r_%s_%t.arc';数据库改变了
</pre></li>
                           <li>
                              <p>如果先前未配置基于角色的目标，请标识与新主数据库的远程逻辑备用目标对应的初始化参数，并手动为每个目标启用重做数据存档。</p>
                              <p>例如，要为<code class="codeph">LOG_ARCHIVE_DEST_2</code>参数定义的远程目标启用存档，请发出以下语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_2 = ENABLE SCOPE = BOTH;</pre><p>要确保在以后重新启动新的主数据库时此更改仍然存在，请更新相应的文本初始化参数文件或服务器参数文件。通常，当数据库以主角色运行时，必须启用对远程目标的归档，并且当数据库以备用角色运行时，必须禁用对远程目标的归档。</p>
                           </li>
                           <li>
                              <p>在目标逻辑备用数据库上发出以下语句（您正在转换到新的主要角色）：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; <a id="d18444e2591" class="indexterm-anchor"></a> ALTER DATABASE ACTIVATE <a id="d18444e2596" class="indexterm-anchor"></a> LOGICAL STANDBY DATABASE FINISH APPLY;</pre><p>该声明停止<a id="d18444e2603" class="indexterm-anchor"></a><a id="d18444e2607" class="indexterm-anchor"></a>远程文件服务器（RFS）进程，在逻辑备用数据库成为主数据库之前，在备用重做日志文件中应用剩余的重做数据，停止SQL应用，并以主数据库角色激活数据库。
                              </p>
                              <p>如果未指定<code class="codeph">FINISH APPLY</code>子句，则在备用数据库成为主数据库之前，不会应用当前备用重做日志文件中的未应用重做。
                              </p>
                           </li>
                           <li>
                              <p>按照<a href="examples-of-using-oracle-data-guard.html#GUID-CBC9D920-C2D0-4342-ACEF-C16289D1774A" title="这些是在主数据库故障转移到另一个备用数据库之后逻辑备用数据库上所需的步骤。">故障转移后配置逻辑备用数据库中</a>描述的方法确保现有逻辑备用数据库可以继续为新主数据库提供保护。
                              </p>
                           </li>
                           <li>
                              <p>在Oracle Data Guard数据库故障转移后立即备份新的主数据库。立即执行备份是必要的安全措施，因为如果没有完整的数据库备份副本，则无法恢复故障转移后所做的更改。</p>
                           </li>
                           <li>
                              <p>故障转移后，可以<a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="After a failover occurs, the original primary database can no longer participate in the Oracle Data Guard configuration until it is repaired and established as a standby database in the new configuration.">使用使用闪回数据库</a> <a href="examples-of-using-oracle-data-guard.html#GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" title="To convert a failed primary database, Oracle recommends that you enable the Flashback Database feature on the primary and follow one of these procedures, as appropriate.">将故障主</a> <a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="发生故障转移后，原始主数据库无法再参与Oracle Data Guard配置，直到在新配置中将其修复并建立为备用数据库。">数据库</a> <a href="examples-of-using-oracle-data-guard.html#GUID-B734C79F-A2BB-43A5-89D7-7733089FB577" title="要转换失败的主数据库，Oracle建议您在主数据库上启用闪回数据库功能，并根据需要执行以下过程之一。">转换为备用数据库或使用RMAN备份</a>将故障主数据库转换为备用数据库中描述的方法将原始主数据库转换为新主数据库的逻辑备用数据库，或者它可以从新主数据库的备份重新创建为逻辑备用数据库，如<a href="creating-oracle-data-guard-logical-standby.html#GUID-3666CA35-D993-44B6-8D70-A2B8B9EC8B2E" title="创建逻辑备用数据库涉及许多步骤，包括先决条件和创建后任务。">创建逻辑备用数据库中所述</a> 。
                              </p>
                              <p>将原始主数据库转换为备用数据库后，可以执行切换以将其还原为主要角色。</p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="SBYDB4774"></a><div class="props_rev_3"><a id="GUID-95E5629A-17F6-44B7-813F-00DD871359FA" name="GUID-95E5629A-17F6-44B7-813F-00DD871359FA"></a><h3 id="SBYDB-GUID-95E5629A-17F6-44B7-813F-00DD871359FA" class="sect3"><span class="enumeration_section">9.4</span>角色转换后使用闪回数据库</h3>
               <div>
                  <p>在角色转换之后，您可以选择使用<code class="codeph">FLASHBACK DATABASE</code>命令将数据库还原到角色转换发生之前的某个时间点或系统更改号（SCN）。
                  </p>
                  <p>如果闪回主数据库，则必须将其所有备用数据库闪回到相同（或更早）的SCN或时间。以这种方式闪回主数据库或备用数据库时，您不必知道过去的切换。如果SCN /时间在任何过去的切换之前，Oracle可以自动闪回过去的切换。</p>
                  <div class="infoboxnote" id="GUID-95E5629A-17F6-44B7-813F-00DD871359FA__GUID-31794F07-7F7E-49E0-BC70-A9971542400F">
                     <p class="notep1">注意：</p>
                     <p>必须在角色转换发生之前在数据库上启用闪回数据库。有关更多信息，请参见“ <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=BRADV71000" target="_blank"><span class="italic">Oracle数据库备份和恢复用户指南”</span></a></p>
                  </div>
               </div><a id="SBYDB00717"></a><div class="props_rev_3"><a id="GUID-6BB6072E-2010-47A5-859D-A7E1EFA2A038" name="GUID-6BB6072E-2010-47A5-859D-A7E1EFA2A038"></a><h4 id="SBYDB-GUID-6BB6072E-2010-47A5-859D-A7E1EFA2A038" class="sect4"><span class="enumeration_section">9.4.1</span>切换后使用闪回数据库</h4>
                  <div>
                     <p>切换后，您可以使用<code class="codeph">FLASHBACK DATABASE</code>命令将数据库返回到发生切换之前的时间或系统更改编号（SCN）。
                     </p>
                     <p>如果切换涉及物理备用数据库，则在闪回操作期间将保留主数据库角色和备用数据库角色。当数据库闪回到目标SCN或闪回数据库的时间时，数据库运行的角色不会更改。在闪回数据库操作之后，在切换之后但在闪回之前以物理备用角色运行的数据库仍然以物理备用数据库角色运行。</p>
                     <p>如果切换涉及逻辑备用数据库，则闪回会将备用数据库的角色更改为目标SCN上的角色或闪回数据库的时间。</p>
                  </div>
               </div><a id="SBYDB4775"></a><div class="props_rev_3"><a id="GUID-A4EE4D20-3FA6-416D-B7C9-A720786E0FEC" name="GUID-A4EE4D20-3FA6-416D-B7C9-A720786E0FEC"></a><h4 id="SBYDB-GUID-A4EE4D20-3FA6-416D-B7C9-A720786E0FEC" class="sect4"><span class="enumeration_section">9.4.2</span>故障转移后使用闪回数据库</h4>
                  <div>
                     <p>您可以使用闪回数据库将发生故障的主数据库转换为发生故障转移之前的某个时间点，然后将其转换为备用数据库。</p>
                     <div class="section">
                        <p>有关完整的分步过程，请参阅<a href="examples-of-using-oracle-data-guard.html#GUID-1163448F-6B18-4A44-AA8D-7CDF0D1360FB" title="发生故障转移后，原始主数据库无法再参与Oracle Data Guard配置，直到在新配置中将其修复并建立为备用数据库。">使用闪回数据库将失败的主数据库转换为备用数据库</a> 。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>