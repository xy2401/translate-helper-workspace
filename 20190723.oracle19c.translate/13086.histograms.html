<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="A histogram is a special type of column statistic that provides more detailed information about the data distribution in a table column. A histogram sorts values into " buckets="=" =""></meta>
      <meta name="description" content="A histogram is a special type of column statistic that provides more detailed information about the data distribution in a table column. A histogram sorts values into " buckets="=" =""></meta>
      <title>直方图</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="SQL Tuning Guide"></meta>
      <meta property="og:description" content="A histogram is a special type of column statistic that provides more detailed information about the data distribution in a table column. A histogram sorts values into " buckets="=" =""></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="SQL Tuning Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="sql-tuning-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-01-31T14:57:08-08:00"></meta>
      <meta name="dcterms.title" content="SQL Tuning Guide"></meta>
      <meta name="dcterms.dateCopyrighted" content="2013, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96095-03"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="optimizer-statistics-concepts.html" title="Previous" type="text/html"></link>
      <link rel="next" href="options-for-optimizer-statistics-gathering.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="TGSQL"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="optimizer-statistics-concepts.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="options-for-optimizer-statistics-gathering.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">SQL调优指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="optimizer-statistics.html" property="item" typeof="WebPage"><span property="name">优化器统计</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">直方图</li>
            </ol>
            <a id="GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" name="GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64"></a><a id="TGSQL366"></a>
            
            <h2 id="TGSQL-GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" class="sect2"><span class="enumeration_chapter">11</span>直方图</h2>
         </header>
         <div class="ind">
            <div>
               <p><strong class="term">直方图</strong>是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值分类为“桶”，因为您可以将硬币分类到桶中。
               </p>
               <p>基于<a href="glossary.html#GUID-34DC46FD-32CE-4242-8ED9-945AE7A9F922"><span class="xrefglossterm">NDV</span></a>和数据的分布，数据库选择要创建的直方图的类型。（在某些情况下，创建直方图时，数据库会对内部预定的行数进行采样。）直方图的类型如下：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p>频率直方图和最高频率直方图</p>
                  </li>
                  <li>
                     <p>高度平衡直方图（传统）</p>
                  </li>
                  <li>
                     <p>混合直方图</p>
                  </li>
               </ul>
               <p>本章包含以下主题：</p>
            </div>
            <div>
               <ul class="ullinks">
                  <li class="ulchildlink"><a href="histograms.html#GUID-8C41E2C8-5097-4D1A-97B2-4338F1B168B7">直方图的目的</a><br>默认情况下，优化程序假定列中不同值的行的统一分布。
                  </li>
                  <li class="ulchildlink"><a href="histograms.html#GUID-92C94E9C-AE31-4135-86A0-3BE1A541BB36">Oracle数据库创建直方图时</a><br>如果<code class="codeph">DBMS_STATS</code>收集表的统计信息，并且查询引用了此表中的列，则Oracle数据库会根据先前的查询工作负载根据需要自动创建直方图。
                  </li>
                  <li class="ulchildlink"><a href="histograms.html#GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE">Oracle数据库如何选择直方图类型</a><br>Oracle数据库使用多个条件来确定要创建的直方图：频率，顶部频率，高度平衡或混合。
                  </li>
                  <li class="ulchildlink"><a href="histograms.html#GUID-F02DAAC5-31F9-477B-9C25-AE33E21DB350">使用直方图时的基数算法</a><br>对于直方图，基数算法取决于诸如端点数和值之类的因素，以及列值是流行还是非流行。
                  </li>
                  <li class="ulchildlink"><a href="histograms.html#GUID-13686AA8-A6DA-43A9-A3C6-CB5A623F3E33">频率直方图</a><br>在<strong class="term">频率直方图中</strong> ，每个不同的列值对应于直方图的单个桶。因为每个值都有自己的专用存储桶，所以某些存储桶可能有很多值，而其他存储桶很少。
                  </li>
                  <li class="ulchildlink"><a href="histograms.html#GUID-DA1B97DA-DFE5-47CA-B8A0-57AB248B10EF">顶部频率直方图</a><br><strong class="term">顶部频率直方图</strong>是<strong class="term">频率直方图</strong>的变化，其忽略统计上无关紧要的非流行值。
                  </li>
                  <li class="ulchildlink"><a href="histograms.html#GUID-7A54B5FC-DB26-46C7-AA92-F986279A4CFD">高度平衡直方图（遗留）</a><br>在传统的高度平衡直方图中，列值被分成桶，以便每个桶包含大致相同的行数。
                  </li>
                  <li class="ulchildlink"><a href="histograms.html#GUID-59C57EDF-E763-436A-9CB2-B59A536A10F7">混合直方图</a><br><strong class="term">混合直方图</strong>结合了基于高度的直方图和频率直方图的特征。这种“两全其美”的方法使优化器能够在某些情况下获得更好的选择性估计。
                  </li>
               </ul>
               <div class="familylinks">
                  <div class="parentlink">
                     <p><strong>父主题：</strong> <a href="optimizer-statistics.html#GUID-0A2F3D52-A135-43E1-9CAB-55BFE068A297" title="执行计划的准确性取决于优化程序统计信息的质量。">优化程序统计信息</a></p>
                  </div>
               </div>
            </div>
            <a id="TGSQL367"></a><div class="props_rev_3"><a id="GUID-8C41E2C8-5097-4D1A-97B2-4338F1B168B7" name="GUID-8C41E2C8-5097-4D1A-97B2-4338F1B168B7"></a><h3 id="TGSQL-GUID-8C41E2C8-5097-4D1A-97B2-4338F1B168B7" class="sect3"><span class="enumeration_section">11.1</span>直方图的目的</h3>
               <div>
                  <p>默认情况下，优化程序假定列中不同值的行的统一分布。</p>
                  <p>对于包含<a href="glossary.html#GUID-D20523EE-FDDA-4C69-95CB-52EFC512616B"><span class="xrefglossterm">数据偏斜的</span></a>列（列中<a href="glossary.html#GUID-D20523EE-FDDA-4C69-95CB-52EFC512616B"><span class="xrefglossterm">数据</span></a>的非均匀分布），直方图使优化器能够为涉及这些列的过滤器和连接谓词生成准确的<a href="glossary.html#GUID-FE541AF8-DCAB-4B00-8015-04BDCB295A85"><span class="xrefglossterm">基数</span></a>估计。
                  </p>
                  <p>例如，一家位于加利福尼亚的书店将95％的书籍运往加利福尼亚州，4％运往俄勒冈州，1％运往内华达州。图书订单表有300,000行。表列存储订单的发货状态。用户查询运往俄勒冈州的图书数量。如果没有直方图，优化器会假设均匀分布为300000/3（NDV为3），估计基数为100,000行。通过此估计，优化程序将选择<a href="glossary.html#GUID-DCAD1CDB-8714-4900-9CB3-8C26802D3B63"><span class="xrefglossterm">全表扫描</span></a> 。使用直方图，优化程序会计算出4％的图书被运送到俄勒冈州，并选择索引扫描。
                  </p>
               </div>
               <div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="histograms.html#GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" title="直方图是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值排序为" buckets="=" ="">直方图</a></p>
                     </div>
                  </div>
               </div>
               
            </div><a id="TGSQL95250"></a><a id="TGSQL95249"></a><div class="props_rev_3"><a id="GUID-92C94E9C-AE31-4135-86A0-3BE1A541BB36" name="GUID-92C94E9C-AE31-4135-86A0-3BE1A541BB36"></a><h3 id="TGSQL-GUID-92C94E9C-AE31-4135-86A0-3BE1A541BB36" class="sect3"><span class="enumeration_section">11.2</span> Oracle数据库创建直方图时</h3>
               <div>
                  <p>如果<code class="codeph">DBMS_STATS</code>收集表的统计信息，并且查询引用了此表中的列，则Oracle数据库会根据先前的查询工作负载根据需要自动创建直方图。
                  </p>
                  <p>基本流程如下：</p>
                  <ol>
                     <li>
                        <p>您为一个表运行<code class="codeph">DBMS_STATS</code> ，其<code class="codeph">METHOD_OPT</code>参数设置为默认的<code class="codeph">SIZE AUTO</code> 。</p>
                     </li>
                     <li>
                        <p>用户查询该表。</p>
                     </li>
                     <li>
                        <p>数据库记录前面查询中的谓词并更新数据字典表<code class="codeph">SYS.COL_USAGE$</code> 。
                        </p>
                     </li>
                     <li>
                        <p>您再次运行<code class="codeph">DBMS_STATS</code> ，导致<code class="codeph">DBMS_STATS</code>查询<code class="codeph">SYS.COL_USAGE$</code>以确定哪些列需要基于先前查询工作负载的直方图。
                        </p>
                     </li>
                  </ol>
                  <p><code class="codeph">AUTO</code>功能的后果包括以下内容：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>随着查询随时间的变化， <code class="codeph">DBMS_STATS</code>可能会更改它收集的统计信息。例如，即使表中的数据没有更改，查询和<code class="codeph">DBMS_STATS</code>操作也可能导致引用这些表的查询计划发生更改。
                        </p>
                     </li>
                     <li>
                        <p>如果收集表的统计信息而不查询表，则数据库不会为此表中的列创建直方图。要使数据库自动创建直方图，您必须运行一个或多个查询以填充<code class="codeph">SYS.COL_USAGE$</code>的列使用信息。
                        </p>
                     </li>
                  </ul>
                  <div class="example" id="GUID-92C94E9C-AE31-4135-86A0-3BE1A541BB36__GUID-FB35EECC-3F12-4488-A52A-E76654DC2609">
                     <p class="titleinexample">例11-1自动直方图创建</p>
                     <p>假设<code class="codeph">sh.sh_ext</code>是一个包含与<code class="codeph">sh.sales</code>表相同的行的<code class="codeph">sh.sales</code>表。您创建新表<code class="codeph">sales2</code>并使用<code class="codeph">sh_ext</code>作为源执行批量加载，这会自动为<code class="codeph">sales2</code>创建统计信息。您还可以按如下方式创建索引：</p><pre class="pre codeblock"><code>SQL&gt; CREATE TABLE sales2 AS SELECT * FROM sh_ext; SQL&gt; CREATE INDEX sh_12c_idx1 ON sales2（prod_id）; SQL&gt; CREATE INDEX sh_12c_idx2 ON sales2（cust_id，time_id）;</code></pre><p>您查询数据字典以确定<code class="codeph">sales2</code>列是否存在直方图。由于尚未查询<code class="codeph">sales2</code> ，因此数据库尚未创建直方图：</p><pre class="pre codeblock"><code>SQL&gt; SELECT COLUMN_NAME，NOTES，HISTOGRAM 2 FROM USER_TAB_COL_STATISTICS 3 WHERE TABLE_NAME ='SALES2'; COLUMN_NAME NOTES HISTOGRAM ------------- -------------- --------- AMOUNT_SOLD STATS_ON_LOAD NONE QUANTITY_SOLD STATS_ON_LOAD NONE PROMO_ID STATS_ON_LOAD NONE CHANNEL_ID STATS_ON_LOAD NONE TIME_ID STATS_ON_LOAD NONE CUST_ID STATS_ON_LOAD NONE PROD_ID STATS_ON_LOAD NONE</code></pre><p>您在<code class="codeph">sales2</code>中查询产品<code class="codeph">42</code>的行数，然后使用<code class="codeph">GATHER AUTO</code>选项收集表统计信息：</p><pre class="pre codeblock"><code>SQL&gt; SELECT COUNT（*）FROM sales2 WHERE prod_id = 42; COUNT（*）---------- 12116 SQL&gt; EXEC DBMS_STATS.GATHER_TABLE_STATS（USER，'SALES2'，OPTIONS =&gt;'GATHER AUTO'）;</code></pre><p>现在，数据字典的查询显示数据库基于前一查询期间收集的信息在<code class="codeph">prod_id</code>列上创建了直方图：</p><pre class="pre codeblock"><code>SQL&gt; SELECT COLUMN_NAME，NOTES，HISTOGRAM 2 FROM USER_TAB_COL_STATISTICS 3 WHERE TABLE_NAME ='SALES2'; COLUMN_NAME NOTES HISTOGRAM ------------- -------------- --------- AMOUNT_SOLD STATS_ON_LOAD NONE QUANTITY_SOLD STATS_ON_LOAD NONE PROMO_ID STATS_ON_LOAD NONE CHANNEL_ID STATS_ON_LOAD NONE TIME_ID STATS_ON_LOAD NONE CUST_ID STATS_ON_LOAD NONE <span class="bold">PROD_ID HISTOGRAM_ONLY FREQUENCY</span></code></pre></div>
                  <!-- class="example" -->
               </div>
               <div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="histograms.html#GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" title="直方图是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值排序为" buckets="=" ="">直方图</a></p>
                     </div>
                  </div>
               </div>
               
            </div>
            <div class="sect2"><a id="GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE" name="GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE"></a><h3 id="TGSQL-GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE" class="sect3"><span class="enumeration_section">11.3</span> Oracle数据库如何选择直方图类型</h3>
               <div>
                  <p>Oracle数据库使用多个条件来确定要创建的直方图：频率，顶部频率，高度平衡或混合。</p>
                  <p>直方图公式使用以下变量：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>NDV</p>
                        <p>这表示列中不同值的数量。例如，如果一个列只包含值<code class="codeph">100</code> ， <code class="codeph">200</code> ，和<code class="codeph">300</code> ，那么NDV此列是3。
                        </p>
                     </li>
                     <li>
                        <p><span class="italic">ñ</span></p>
                        <p>此变量表示直方图桶的数量。默认值为254。</p>
                     </li>
                     <li>
                        <p><span class="italic">p</span></p>
                        <p>此变量表示内部百分比阈值，等于（1-（1 / <span class="italic">n</span> ））* 100。例如，如果<span class="italic">n</span> = 254，则<span class="italic">p</span>为99.6。
                        </p>
                     </li>
                  </ul>
                  <p>另一个标准是<code class="codeph">DBMS_STATS</code>统计信息收集过程中的<code class="codeph">estimate_percent</code>参数是否设置为<code class="codeph">AUTO_SAMPLE_SIZE</code> （默认值）。
                  </p>
                  <p>下图显示了直方图创建的决策树。</p>
                  <div class="figure" id="GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE__GUID-F0C8F6A0-FD2C-4CEC-A8CF-025C9AFFDBDA">
                     <p class="titleinfigure">图11-1直方图创建的决策树</p><img src="img/tgsql_vm_090.png" alt="下面是图11-1的描述" title="下面是图11-1的描述" longdesc="img_text/tgsql_vm_090.html"><br><a href="img_text/tgsql_vm_090.html">“图11-1直方图创建决策树”的描述</a></div>
                  <!-- class="figure" -->
               </div>
               <div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="histograms.html#GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" title="直方图是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值排序为" buckets="=" ="">直方图</a></p>
                     </div>
                  </div>
               </div>
               
            </div><a id="TGSQL380"></a><div class="props_rev_3"><a id="GUID-F02DAAC5-31F9-477B-9C25-AE33E21DB350" name="GUID-F02DAAC5-31F9-477B-9C25-AE33E21DB350"></a><h3 id="TGSQL-GUID-F02DAAC5-31F9-477B-9C25-AE33E21DB350" class="sect3"><span class="enumeration_section">11.4</span>使用直方图时的基数算法</h3>
               <div>
                  <p>对于直方图，基数算法取决于诸如端点数和值之类的因素，以及列值是流行还是非流行。</p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="histograms.html#GUID-EED37588-DEB3-4426-92D1-76A1B73888B4">端点号和值</a><br><strong class="term">端点号</strong>是唯一标识存储桶的编号。在频率和混合直方图中，端点号是当前和先前桶中包含的所有值的累积频率。
                     </li>
                     <li class="ulchildlink"><a href="histograms.html#GUID-894C65FC-17A7-4893-8F09-A04B54E41EDE">流行和非流行的价值观</a><br>直方图中值的流行度影响基数估计算法。
                     </li>
                     <li class="ulchildlink"><a href="histograms.html#GUID-75F48CB8-BD9C-4BAC-BD55-E137945B8112">铲斗压缩</a><br>在某些情况下，为了减少存储桶的总数，优化程序会将多个存储桶压缩到一个存储桶中。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="histograms.html#GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" title="直方图是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值排序为" buckets="=" ="">直方图</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL95026"></a><div class="props_rev_3"><a id="GUID-EED37588-DEB3-4426-92D1-76A1B73888B4" name="GUID-EED37588-DEB3-4426-92D1-76A1B73888B4"></a><h4 id="TGSQL-GUID-EED37588-DEB3-4426-92D1-76A1B73888B4" class="sect4"><span class="enumeration_section">11.4.1</span>端点号和值</h4>
                  <div>
                     <p><strong class="term">端点号</strong>是唯一标识存储桶的编号。在频率和混合直方图中，端点号是当前和先前桶中包含的所有值的累积频率。
                     </p>
                     <p>例如，端点号为<code class="codeph">100</code>的存储桶表示当前和所有先前存储桶中的值的总频率为100。在高度平衡的直方图中，优化器按顺序编号，从<code class="codeph">0</code>或<code class="codeph">1</code> 。在所有情况下，端点号都是桶号。
                     </p>
                     <p><a href="glossary.html#GUID-ED2009D8-C205-4CBA-85A7-BAC6595F65BF"><span class="xrefglossterm">端点值</span></a>是存储桶中值范围中的最高值。例如，如果存储桶仅包含值<code class="codeph">52794</code>和<code class="codeph">52795</code> ，则端点值为<code class="codeph">52795</code> 。
                     </p>
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-F02DAAC5-31F9-477B-9C25-AE33E21DB350" title="对于直方图，基数算法取决于诸如端点数和值之类的因素，以及列值是流行还是非流行。">使用直方图时的基数算法</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL95027"></a><div class="props_rev_3"><a id="GUID-894C65FC-17A7-4893-8F09-A04B54E41EDE" name="GUID-894C65FC-17A7-4893-8F09-A04B54E41EDE"></a><h4 id="TGSQL-GUID-894C65FC-17A7-4893-8F09-A04B54E41EDE" class="sect4"><span class="enumeration_section">11.4.2</span>流行和非流行价值观</h4>
                  <div>
                     <p>直方图中值的流行度影响基数估计算法。</p>
                     <p>具体而言，基数估计受到如下影响：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>热门价值观</p>
                           <p><a href="glossary.html#GUID-8D40A1EF-8A7C-4BB6-A3C9-5E170F5C7B94"><span class="xrefglossterm">流行值</span></a>作为多个桶的端点<a href="glossary.html#GUID-8D40A1EF-8A7C-4BB6-A3C9-5E170F5C7B94"><span class="xrefglossterm">值</span></a>出现。优化器通过首先检查它是否是存储桶的端点值来确定值是否受欢迎。如果是，则对于频率直方图，优化器从当前桶的端点号中减去前一个桶的端点号。混合直方图已经为每个端点单独存储此信息。如果此值大于1，则该值很受欢迎。
                           </p>
                           <p>优化程序使用以下公式计算其热门值的基数估计值：</p><pre class="pre codeblock"><code>流行值的基数=（表中的行数）*（此值跨越的端点数/端点总数）</code></pre></li>
                        <li>
                           <p>非流行的价值观</p>
                           <p>任何不受欢迎的值都是非流行<a href="glossary.html#GUID-DB4CA979-5A26-44B9-A0C4-70CC5C0DE8D9"><span class="xrefglossterm">值</span></a> 。优化程序使用以下公式计算非流行值的基数估计值：</p><pre class="pre codeblock"><code>非流行值的基数=（表中的行数）*密度</code></pre><p>优化器使用基于诸如桶数和NDV等因素的内部算法来计算<a href="glossary.html#GUID-34816C85-C13E-486E-B555-A85A30629089"><span class="xrefglossterm">密度</span></a> 。密度表示为<code class="codeph">0</code>到<code class="codeph">1</code>之间的十进制数。值接近<code class="codeph">1</code>表示优化程序期望在其谓词列表中引用此列的查询返回许多行。值接近<code class="codeph">0</code>表示优化程序需要返回几行。
                           </p>
                        </li>
                     </ul>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-894C65FC-17A7-4893-8F09-A04B54E41EDE__GUID-C8F50DF6-8AAE-45B1-B0B5-EE365F833B5C">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../refrn/DBA_TAB_COL_STATISTICS.html#REFRN23275" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">DBA_TAB_COL_STATISTICS.DENSITY</code>列</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-F02DAAC5-31F9-477B-9C25-AE33E21DB350" title="对于直方图，基数算法取决于诸如端点数和值之类的因素，以及列值是流行还是非流行。">使用直方图时的基数算法</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL95028"></a><div class="props_rev_3"><a id="GUID-75F48CB8-BD9C-4BAC-BD55-E137945B8112" name="GUID-75F48CB8-BD9C-4BAC-BD55-E137945B8112"></a><h4 id="TGSQL-GUID-75F48CB8-BD9C-4BAC-BD55-E137945B8112" class="sect4"><span class="enumeration_section">11.4.3</span>铲斗压缩</h4>
                  <div>
                     <p>在某些情况下，为了减少存储桶的总数，优化程序会将多个存储桶压缩到一个存储桶中。</p>
                     <p>例如，以下频率直方图表示第一个桶号为<code class="codeph">1</code> ，最后一个桶号为<code class="codeph">23</code> ：</p><pre class="pre codeblock"><code>ENDPOINT_NUMBER ENDPOINT_VALUE --------------- -------------- 1 52792 6 52793 8 52794 9 52795 10 52796 12 52797 14 52798 23 52799</code></pre><p>几个水桶“缺失”。最初，桶<code class="codeph">2</code>到<code class="codeph">6</code>每个包含一个值为<code class="codeph">52793</code>实例。优化器将所有这些桶压缩到具有最高端点号（桶<code class="codeph">6</code> ）的桶中，该桶现在包含5个值<code class="codeph">52793</code>实例。该值很流行，因为当前桶（ <code class="codeph">6</code> ）和前一个桶（ <code class="codeph">1</code> ）的端点号之间的差值是5。因此，在压缩之前，值<code class="codeph">52793</code>是5个桶的端点。
                     </p>
                     <p>以下注释显示了哪些存储区被压缩，以及哪些值很受欢迎：</p><pre class="pre codeblock"><code>ENDPOINT_NUMBER ENDPOINT_VALUE --------------- -------------- 1 52792  - &gt; nonpopular 6 52793  - &gt;桶2-6压缩成6;流行8 52794  - &gt;桶7-8压缩成8;流行9 52795  - &gt; nonpopular 10 52796  - &gt; nonpopular 12 52797  - &gt;桶11-12压缩成12;流行14 52798  - &gt;水桶13-14压缩成14;流行23 52799  - &gt;桶15-23压缩成23;流行</code></pre></div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-F02DAAC5-31F9-477B-9C25-AE33E21DB350" title="对于直方图，基数算法取决于诸如端点数和值之类的因素，以及列值是流行还是非流行。">使用直方图时的基数算法</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL368"></a><div class="props_rev_3"><a id="GUID-13686AA8-A6DA-43A9-A3C6-CB5A623F3E33" name="GUID-13686AA8-A6DA-43A9-A3C6-CB5A623F3E33"></a><h3 id="TGSQL-GUID-13686AA8-A6DA-43A9-A3C6-CB5A623F3E33" class="sect3"><span class="enumeration_section">11.5</span>频率直方图</h3>
               <div>
                  <p>在<strong class="term">频率直方图中</strong> ，每个不同的列值对应于直方图的单个桶。因为每个值都有自己的专用存储桶，所以某些存储桶可能有很多值，而其他存储桶很少。
                  </p>
                  <p>类似于频率直方图是对硬币进行分类，以便每个单独的硬币最初获得自己的桶。例如，第一个便士在桶1中，第二个便士在桶2中，第一个镍在桶3中，依此类推。然后你将所有的便士合并成一个便士桶，将所有的镍币合并成一个镍桶，依此类推剩余的硬币。</p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="histograms.html#GUID-2786B655-A6EA-4288-8544-BDA3025AAB2E">频率直方图的标准</a><br>频率直方图取决于所请求的直方图桶的数量。
                     </li>
                     <li class="ulchildlink"><a href="histograms.html#GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC">生成频率直方图</a><br>此场景显示如何使用示例模式生成频率直方图。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="histograms.html#GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" title="直方图是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值排序为" buckets="=" ="">直方图</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL95029"></a><div class="props_rev_3"><a id="GUID-2786B655-A6EA-4288-8544-BDA3025AAB2E" name="GUID-2786B655-A6EA-4288-8544-BDA3025AAB2E"></a><h4 id="TGSQL-GUID-2786B655-A6EA-4288-8544-BDA3025AAB2E" class="sect4"><span class="enumeration_section">11.5.1</span>频率直方图的标准</h4>
                  <div>
                     <p>频率直方图取决于所请求的直方图桶的数量。</p>
                     <p>如<span class="q">“ <a href="histograms.html#GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE" title="Oracle数据库使用多个条件来确定要创建的直方图：频率，顶部频率，高度平衡或混合。">Oracle数据库如何选择直方图类型</a> ”</span>中的逻辑图所示，数据库在满足以下条件时创建频率直方图：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>NDV小于或等于<span class="italic">n</span> ，其中<span class="italic">n</span>是直方图桶的数量（默认值为<code class="codeph">254</code> ）。
                           </p>
                           <p>例如， <code class="codeph">sh.countries.country_subregion_id</code>列有8个不同的值，从<code class="codeph">52792</code>到<code class="codeph">52799</code>顺序<code class="codeph">52799</code> 。如果<span class="italic">n</span>是默认值<code class="codeph">254</code> ，则优化程序会创建频率直方图，因为<code class="codeph">8 &lt;= 254</code> 。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">DBMS_STATS</code>统计信息收集过程中的<code class="codeph">estimate_percent</code>参数设置为用户指定的值或<code class="codeph">AUTO_SAMPLE_SIZE</code> 。</p>
                        </li>
                     </ul>
                     <p>从<span>Oracle Database 12c开始</span> ，如果采样大小是<code class="codeph">AUTO_SAMPLE_SIZE</code>的默认值，则数据库会从全表扫描中创建频率直方图。对于所有其他采样百分比规范，数据库从样本中导出频率直方图。在<span>Oracle Database 12c</span>之前的版本中，数据库基于一个小样本收集了直方图，这意味着低频值通常不会出现在样本中。在这种情况下使用密度有时会导致优化器过高估计选择性。
                     </p>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-2786B655-A6EA-4288-8544-BDA3025AAB2E__GUID-05A102B1-8BC4-4198-8F9E-4E582B2DCFBF">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/tgsql&amp;id=ARPLS68490" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">AUTO_SAMPLE_SIZE</code> 
                        </p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-13686AA8-A6DA-43A9-A3C6-CB5A623F3E33" title="在频率直方图中，每个不同的列值对应于直方图的单个桶。因为每个值都有自己的专用存储桶，所以某些存储桶可能有很多值，而其他存储桶很少。">频率直方图</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL95031"></a><a id="TGSQL95032"></a><a id="TGSQL95030"></a><div class="props_rev_3"><a id="GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC" name="GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC"></a><h4 id="TGSQL-GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC" class="sect4"><span class="enumeration_section">11.5.2</span>生成频率直方图</h4>
                  <div>
                     <p>此场景显示如何使用示例模式生成频率直方图。</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC__GUID-C2D0A748-1CCA-410D-89F4-9289120B16AF">假设</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>此方案假定您要在<code class="codeph">sh.countries.country_subregion_id</code>列上生成频率直方图。该表有23行。
                        </p>
                        <p>以下查询显示<code class="codeph">country_subregion_id</code>列包含不均匀分布的8个不同值（包括样本输出）：</p><pre class="pre codeblock"><code>SELECT country_subregion_id，count（*）FROM sh.countries GROUP BY country_subregion_id ORDER BY 1; COUNTRY_SUBREGION_ID COUNT（*）-------------------- ---------- 52792 1 52793 5 52794 2 52795 1 52796 1 52797 2 52798 2 52799 9</code></pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC__GUID-705368EF-8DC5-4B3C-85CB-4FB489D512E0">要生成频率直方图：</p>
                        <ol>
                           <li>
                              <p>收集<code class="codeph">sh.countries</code>和<code class="codeph">country_subregion_id</code>列的统计信息，使桶的数量默认为254。
                              </p>
                              <p>例如，执行以下PL / SQL匿名块：</p><pre class="pre codeblock"><code>BEGIN DBMS_STATS.GATHER_TABLE_STATS（ownname =&gt;'SH'，tabname =&gt;'COUNTRIES'，method_opt =&gt;'FOR COLUMNS COUNTRY_SUBREGION_ID'）;结束;</code></pre></li>
                           <li>
                              <p>查询<code class="codeph">country_subregion_id</code>列的直方图信息。
                              </p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>SELECT TABLE_NAME，COLUMN_NAME，NUM_DISTINCT，来自USER_TAB_COL_STATISTICS的HISTOGRAM，其中TABLE_NAME ='COUNTRIES'和COLUMN_NAME ='COUNTRY_SUBREGION_ID'; TABLE_NAME COLUMN_NAME NUM_DISTINCT HISTOGRAM ---------- -------------------- ------------ ---- ----------- COUNTRY COUNTRY_SUBREGION_ID 8 FREQUENCY</code></pre><p>优化器选择频率直方图，因为列中存在<span class="italic">n个</span>或更少的不同值，其中<span class="italic">n</span>默认为<code class="codeph">254</code> 。
                              </p>
                           </li>
                           <li>
                              <p>查询<code class="codeph">country_subregion_id</code>列的端点号和端点值。
                              </p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>从USER_HISTOGRAMS中选择ENDPOINT_NUMBER，ENDPOINT_VALUE，其中TABLE_NAME ='COUNTRIES'和COLUMN_NAME ='COUNTRY_SUBREGION_ID'; ENDPOINT_NUMBER ENDPOINT_VALUE --------------- -------------- 1 52792 6 52793 8 52794 9 52795 10 52796 12 52797 14 52798 23 52799</code></pre><p><a href="histograms.html#GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC__BABDFIHE">图11-2</a>是直方图中8个桶的图形说明。每个值都表示为放入桶中的硬币。
                              </p>
                              <div class="figure" id="GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC__BABDFIHE">
                                 <p class="titleinfigure">图11-2频率直方图</p><img src="img/tgsql_vm_072.png" alt="下面是图11-2的描述" title="下面是图11-2的描述" longdesc="img_text/tgsql_vm_072.html"><br><a href="img_text/tgsql_vm_072.html">“图11-2频率直方图”的说明</a></div>
                              <!-- class="figure" -->
                              <p><a href="histograms.html#GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC__BABDFIHE">如图11-2</a>所示，每个不同的值都有自己的桶。由于这是频率直方图，因此端点号是端点的累积频率。对于<code class="codeph">52793</code> ，端点号<code class="codeph">6</code>表示该值出现5次（6  -  1）。对于<code class="codeph">52794</code> ，端点号<code class="codeph">8</code>表示该值出现2次（8  -  6）。
                              </p>
                              <p>端点比前一个端点至少大2的每个存储桶都包含一个流行值。因此，铲斗<code class="codeph">6</code> ， <code class="codeph">8</code> ， <code class="codeph">12</code> ， <code class="codeph">14</code> ，和<code class="codeph">23</code>包含流行值。优化器根据端点号计算其基数。例如，优化器使用以下公式计算值<code class="codeph">52799</code>的基数（ <code class="codeph">C</code> ），其中表中的行数为23：</p><pre class="pre codeblock"><code>C = 23 *（9/23）</code></pre><p>桶<code class="codeph">1</code> ， <code class="codeph">9</code>和<code class="codeph">10</code>包含nonpopular值。优化器根据密度估算其基数。
                              </p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC__GUID-41AC48E4-D354-49E4-B00A-71A598F625B0">
                        <p class="notep1">也可以看看：</p>
                        <ul id="GUID-C67F68B6-65AF-4ADC-9445-9420E60C28AC__UL_HYN_YCY_2GB" style="list-style-type:disc">
                           <li>
                              <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-CA6A56B9-0540-45E9-B1D7-D78769B7714C" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">DBMS_STATS.GATHER_TABLE_STATS</code>过程</p>
                           </li>
                           <li>
                              <p><a href="../refrn/USER_TAB_COL_STATISTICS.html#REFRN-GUID-4FF4364B-29D0-4365-AA0F-ABD17CE298EC" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">USER_TAB_COL_STATISTICS</code>视图</p>
                           </li>
                           <li>
                              <p><a href="../refrn/USER_HISTOGRAMS.html#REFRN-GUID-582FAF05-FA3B-45D6-BDD3-B35C5E209368" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">USER_HISTOGRAMS</code>视图</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-13686AA8-A6DA-43A9-A3C6-CB5A623F3E33" title="在频率直方图中，每个不同的列值对应于直方图的单个桶。因为每个值都有自己的专用存储桶，所以某些存储桶可能有很多值，而其他存储桶很少。">频率直方图</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
            <div class="props_rev_3"><a id="GUID-DA1B97DA-DFE5-47CA-B8A0-57AB248B10EF" name="GUID-DA1B97DA-DFE5-47CA-B8A0-57AB248B10EF"></a><h3 id="TGSQL-GUID-DA1B97DA-DFE5-47CA-B8A0-57AB248B10EF" class="sect3"><span class="enumeration_section">11.6</span>顶部频率直方图</h3>
               <div>
                  <p><strong class="term">顶部频率直方图</strong>是<strong class="term">频率直方图</strong>的变化，其忽略统计上无关紧要的非流行值。
                  </p>
                  <p>例如，如果一堆1000个硬币只包含一个便士，那么您可以在将硬币分类到桶中时忽略便士。顶部频率直方图可以为高度流行的值产生更好的直方图。</p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="histograms.html#GUID-A97DF0B5-ADDE-45D8-B6B9-1128F61F24E3">最高频率直方图的标准</a><br>如果少量值占据大多数行，则即使NDV大于请求的直方图桶的数量，在这一小组值上创建频率直方图也是有用的。要为流行值创建更高质量的直方图，优化程序会忽略非流行值并创建顶部频率直方图。
                     </li>
                     <li class="ulchildlink"><a href="histograms.html#GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F">生成顶部频率直方图</a><br>此场景显示如何使用示例模式生成顶部频率直方图。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="histograms.html#GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" title="直方图是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值排序为" buckets="=" ="">直方图</a></p>
                     </div>
                  </div>
               </div>
               
               <div class="props_rev_3"><a id="GUID-A97DF0B5-ADDE-45D8-B6B9-1128F61F24E3" name="GUID-A97DF0B5-ADDE-45D8-B6B9-1128F61F24E3"></a><h4 id="TGSQL-GUID-A97DF0B5-ADDE-45D8-B6B9-1128F61F24E3" class="sect4"><span class="enumeration_section">11.6.1</span>顶部频率直方图的标准</h4>
                  <div>
                     <p>如果少量值占据大多数行，则即使NDV大于请求的直方图桶的数量，在这一小组值上创建频率直方图也是有用的。要为流行值创建更高质量的直方图，优化程序会忽略非流行值并创建顶部频率直方图。</p>
                     <p>如<span class="q">“ <a href="histograms.html#GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE" title="Oracle数据库使用多个条件来确定要创建的直方图：频率，顶部频率，高度平衡或混合。">Oracle数据库如何选择直方图类型</a> ”</span>中的逻辑图所示，数据库在满足以下条件时创建顶部频率直方图：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>NDV大于<span class="italic">n</span> ，其中<span class="italic">n</span>是直方图桶的数量（默认值为<code class="codeph">254</code> ）。
                           </p>
                        </li>
                        <li>
                           <p>前<span class="italic">n个</span>频繁值占据的行的百分比等于或大于阈值<span class="italic">p</span> ，其中<span class="italic">p</span>是<code class="codeph">(1-(1/</code> <span class="italic"><code class="codeph">n</code></span> <code class="codeph">))*100</code> 。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">DBMS_STATS</code>统计信息收集过程中的<code class="codeph">estimate_percent</code>参数设置为<code class="codeph">AUTO_SAMPLE_SIZE</code> 。</p>
                        </li>
                     </ul>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-A97DF0B5-ADDE-45D8-B6B9-1128F61F24E3__GUID-05A102B1-8BC4-4198-8F9E-4E582B2DCFBF">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../arpls/DBMS_STATS.html#ARPLS68490" target="_blank"><span class="italic">Oracle Database PL / SQL包和类型参考，</span></a>以了解<code class="codeph">AUTO_SAMPLE_SIZE</code></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-DA1B97DA-DFE5-47CA-B8A0-57AB248B10EF" title="顶部频率直方图是频率直方图的变化，其忽略统计上无关紧要的非流行值。">顶部频率直方图</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL95034"></a><a id="TGSQL95035"></a><a id="TGSQL95033"></a><div class="props_rev_3"><a id="GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F" name="GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F"></a><h4 id="TGSQL-GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F" class="sect4"><span class="enumeration_section">11.6.2</span>生成顶部频率直方图</h4>
                  <div>
                     <p>此场景显示如何使用示例模式生成顶部频率直方图。</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F__GUID-C0CD4C7B-131F-48DD-90D4-7626408E43AD">假设</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>此方案假定您要在<code class="codeph">sh.countries.country_subregion_id</code>列上生成顶部频率直方图。该表有23行。
                        </p>
                        <p>以下查询显示<code class="codeph">country_subregion_id</code>列包含不均匀分布的8个不同值（包括样本输出）：</p><pre class="pre codeblock"><code>SELECT country_subregion_id，count（*）FROM sh.countries GROUP BY country_subregion_id ORDER BY 1; COUNTRY_SUBREGION_ID COUNT（*）-------------------- ---------- 52792 1 52793 5 52794 2 52795 1 52796 1 52797 2 52798 2 52799 9</code></pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F__GUID-466AE9C9-A58B-4333-8D4C-F37511038B37">要生成顶部频率直方图：</p>
                        <ol>
                           <li>
                              <p>收集<code class="codeph">sh.countries</code>和<code class="codeph">country_subregion_id</code>列的统计信息，指定的桶数少于不同的值。
                              </p>
                              <p>例如，输入以下命令以指定7个存储桶：</p><pre class="pre codeblock"><code>BEGIN DBMS_STATS.GATHER_TABLE_STATS（ownname =&gt;'SH'，tabname =&gt;'COUNTRIES'，method_opt =&gt;'FOR COLUMNS COUNTRY_SUBREGION_ID SIZE 7'）;结束;</code></pre></li>
                           <li>
                              <p>查询<code class="codeph">country_subregion_id</code>列的直方图信息。
                              </p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>SELECT TABLE_NAME，COLUMN_NAME，NUM_DISTINCT，来自USER_TAB_COL_STATISTICS的HISTOGRAM，其中TABLE_NAME ='COUNTRIES'和COLUMN_NAME ='COUNTRY_SUBREGION_ID'; TABLE_NAME COLUMN_NAME NUM_DISTINCT HISTOGRAM ---------- -------------------- ------------ ---- ----------- COUNTRYIES COUNTRY_SUBREGION_ID 7顶级频率</code></pre><p><code class="codeph">sh.countries.country_subregion_id</code>列包含8个不同的值，但直方图仅包含7个桶，使得<span class="italic">n</span> <code class="codeph">=7</code> 。在这种情况下，数据库只能创建顶级频率或混合直方图。在<code class="codeph">country_subregion_id</code>列中，前7个最常见的值占据行的95.6％，超过了85.7％的阈值，生成了顶部频率直方图。
                              </p>
                           </li>
                           <li>
                              <p>查询列的端点号和端点值。</p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>从USER_HISTOGRAMS中选择ENDPOINT_NUMBER，ENDPOINT_VALUE，其中TABLE_NAME ='COUNTRIES'和COLUMN_NAME ='COUNTRY_SUBREGION_ID'; ENDPOINT_NUMBER ENDPOINT_VALUE --------------- -------------- 1 52792 6 52793 8 52794 9 52796 11 52797 13 52798 22 52799</code></pre><p><a href="histograms.html#GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F__BABGFHDJ">图11-3</a>是顶部频率直方图中的7个桶的图形说明。这些值在图中表示为硬币。
                              </p>
                              <div class="figure" id="GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F__BABGFHDJ">
                                 <p class="titleinfigure">图11-3顶部频率直方图</p><img src="img/tgsql_vm_073.png" alt="下面是图11-3的描述" title="下面是图11-3的描述" longdesc="img_text/tgsql_vm_073.html"><br><a href="img_text/tgsql_vm_073.html">“图11-3顶部频率直方图”的说明</a></div>
                              <!-- class="figure" -->
                              <p><a href="histograms.html#GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F__BABGFHDJ">如图11-3</a>所示，每个不同的值都有自己的桶，但<code class="codeph">52795</code>除外，它被排除在直方图之外，因为它不受欢迎且统计上无关紧要。与标准频率直方图一样，端点号表示值的累积频率。
                              </p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                     <div class="section"></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-E0193C9B-84F0-4293-B1FE-32AC19FE484F__GUID-C02CEA3D-FB12-427F-AE68-BA32E94F677B">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="histograms.html#GUID-2786B655-A6EA-4288-8544-BDA3025AAB2E" title="频率直方图取决于所请求的直方图桶的数量。">频率直方图的标准</a> ”</span></p>
                           </li>
                           <li>
                              <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-CA6A56B9-0540-45E9-B1D7-D78769B7714C" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">DBMS_STATS.GATHER_TABLE_STATS</code>过程</p>
                           </li>
                           <li>
                              <p><a href="../refrn/USER_TAB_COL_STATISTICS.html#REFRN-GUID-4FF4364B-29D0-4365-AA0F-ABD17CE298EC" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">USER_TAB_COL_STATISTICS</code>视图</p>
                           </li>
                           <li>
                              <p><a href="../refrn/USER_HISTOGRAMS.html#REFRN-GUID-582FAF05-FA3B-45D6-BDD3-B35C5E209368" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">USER_HISTOGRAMS</code>视图</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-DA1B97DA-DFE5-47CA-B8A0-57AB248B10EF" title="顶部频率直方图是频率直方图的变化，其忽略统计上无关紧要的非流行值。">顶部频率直方图</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL378"></a><div class="props_rev_3"><a id="GUID-7A54B5FC-DB26-46C7-AA92-F986279A4CFD" name="GUID-7A54B5FC-DB26-46C7-AA92-F986279A4CFD"></a><h3 id="TGSQL-GUID-7A54B5FC-DB26-46C7-AA92-F986279A4CFD" class="sect3"><span class="enumeration_section">11.7</span>高度平衡直方图（遗留）</h3>
               <div>
                  <p>在传统的高度平衡直方图中，列值被分成桶，以便每个桶包含大致相同的行数。</p>
                  <p>例如，如果您在4个桶中分配99个硬币，则每个桶包含大约25个硬币。直方图显示端点落在值范围内的位置。</p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="histograms.html#GUID-7F75F5E9-7761-4564-A6CD-DC504B0FE56D">高度平衡直方图的标准</a><br>在<span>Oracle Database 12c</span>之前，当NDV大于<span class="italic">n</span>时，数据库创建了高度平衡的直方图。这种类型的直方图对范围谓词很有用，并且对至少在两个桶中显示为端点的值的等式谓词。
                     </li>
                     <li class="ulchildlink"><a href="histograms.html#GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D">生成高度平衡直方图</a><br>此场景显示如何使用示例模式生成高度平衡的直方图。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="histograms.html#GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" title="直方图是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值排序为" buckets="=" ="">直方图</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL379"></a><div class="props_rev_3"><a id="GUID-7F75F5E9-7761-4564-A6CD-DC504B0FE56D" name="GUID-7F75F5E9-7761-4564-A6CD-DC504B0FE56D"></a><h4 id="TGSQL-GUID-7F75F5E9-7761-4564-A6CD-DC504B0FE56D" class="sect4"><span class="enumeration_section">11.7.1</span>高度平衡直方图的标准</h4>
                  <div>
                     <p>在<span>Oracle Database 12c</span>之前，当NDV大于<span class="italic">n</span>时，数据库创建了高度平衡的直方图。这种类型的直方图对范围谓词很有用，并且对至少在两个桶中显示为端点的值的等式谓词。
                     </p>
                     <p>如<span class="q">“ <a href="histograms.html#GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE" title="Oracle数据库使用多个条件来确定要创建的直方图：频率，顶部频率，高度平衡或混合。">Oracle数据库如何选择直方图类型</a> ”</span>中的逻辑图所示，当满足以下条件时，数据库会创建高度平衡的直方图：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>NDV大于<span class="italic">n</span> ，其中<span class="italic">n</span>是直方图桶的数量（默认值为<code class="codeph">254</code> ）。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">DBMS_STATS</code>统计信息收集过程中的<code class="codeph">estimate_percent</code>参数<span class="italic">未</span>设置为<code class="codeph">AUTO_SAMPLE_SIZE</code> 。</p>
                        </li>
                     </ul>
                     <p>因此，如果<span>Oracle Database 12c</span>创建新的直方图，并且如果采样百分比是<code class="codeph">AUTO_SAMPLE_SIZE</code> ，则直方图可以是顶级频率或混合频率，但不是高度平衡的。
                     </p>
                     <p>如果将Oracle Database 11g升级到<span>Oracle Database 12c</span> ，则在升级<span class="italic">之前</span>创建的任何基于高度的直方图仍在使用中。但是，如果刷新创建直方图的表的统计信息，则数据库将替换此表上现有的高度平衡直方图。替换直方图的类型取决于NDV和以下标准：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>如果采样百分比为<code class="codeph">AUTO_SAMPLE_SIZE</code> ，则数据库会创建混合或频率直方图。
                           </p>
                        </li>
                        <li>
                           <p>如果采样百分比不是<code class="codeph">AUTO_SAMPLE_SIZE</code> ，则数据库会创建高度平衡或频率直方图。
                           </p>
                        </li>
                     </ul>
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-7A54B5FC-DB26-46C7-AA92-F986279A4CFD" title="在传统的高度平衡直方图中，列值被分成桶，以便每个桶包含大致相同的行数。">高度平衡直方图（遗留）</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL95036"></a><a id="TGSQL95037"></a><a id="TGSQL383"></a><div class="props_rev_3"><a id="GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D" name="GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D"></a><h4 id="TGSQL-GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D" class="sect4"><span class="enumeration_section">11.7.2</span>生成高度平衡直方图</h4>
                  <div>
                     <p>此场景显示如何使用示例模式生成高度平衡的直方图。</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D__GUID-D207BF55-60D8-4DA8-B364-DA361B573622">假设</p>
                        <p>此方案假定您要在<code class="codeph">sh.countries.country_subregion_id</code>列上生成高度平衡的直方图。该表有23行。
                        </p>
                        <p>以下查询显示<code class="codeph">country_subregion_id</code>列包含不均匀分布的8个不同值（包括样本输出）：</p><pre class="pre codeblock"><code>SELECT country_subregion_id，count（*）FROM sh.countries GROUP BY country_subregion_id ORDER BY 1; COUNTRY_SUBREGION_ID COUNT（*）-------------------- ---------- 52792 1 52793 5 52794 2 52795 1 52796 1 52797 2 52798 2 52799 9</code></pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D__GUID-15F9B026-B28F-4A5B-85A7-D89696560EDA">要生成高度平衡的直方图：</p>
                        <ol>
                           <li>
                              <p>收集<code class="codeph">sh.countries</code>和<code class="codeph">country_subregion_id</code>列的统计信息，指定的桶数少于不同的值。
                              </p>
                              <div class="infoboxnote" id="GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D__GUID-ABB9A0FB-D307-4EF8-8F86-E8C88AF62513">
                                 <p class="notep1">注意：</p>
                                 <p>要模拟创建基于高度的直方图所必需的<span>Oracle Database 11g</span>行为，请将<code class="codeph">estimate_percent</code>设置为非默认值。如果指定非默认百分比，则数据库会创建频率或高度平衡的直方图。
                                 </p>
                              </div>
                              <p>例如，输入以下命令：</p><pre class="pre codeblock"><code>BEGIN DBMS_STATS.GATHER_TABLE_STATS（ownname =&gt;'SH'，tabname =&gt;'COUNTRIES'，method_opt =&gt;'FOR COLUMNS COUNTRY_SUBREGION_ID SIZE 7'，estimate_percent =&gt; 100）;结束;</code></pre></li>
                           <li>
                              <p>查询<code class="codeph">country_subregion_id</code>列的直方图信息。
                              </p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>SELECT TABLE_NAME，COLUMN_NAME，NUM_DISTINCT，来自USER_TAB_COL_STATISTICS的HISTOGRAM，其中TABLE_NAME ='COUNTRIES'和COLUMN_NAME ='COUNTRY_SUBREGION_ID'; TABLE_NAME COLUMN_NAME NUM_DISTINCT HISTOGRAM ---------- -------------------- ------------ ---- ----------- COUNTRYIES COUNTRY_SUBREGION_ID 8高度平衡</code></pre><p>优化器选择高度平衡的直方图，因为不同值（8）的数量大于桶的数量（7），而<code class="codeph">estimate_percent</code>值是非默认值。
                              </p>
                           </li>
                           <li>
                              <p>查询每个不同值占用的行数。</p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>SELECT COUNT（country_subregion_id）AS NUM_OF_ROWS，country_subregion_id FROM countries GROUP BY country_subregion_id ORDER BY 2; NUM_OF_ROWS COUNTRY_SUBREGION_ID ----------- -------------------- 1 52792 5 52793 2 52794 1 52795 1 52796 2 52797 2 52798 9 52799</code></pre></li>
                           <li>
                              <p>查询<code class="codeph">country_subregion_id</code>列的端点号和端点值。
                              </p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>从USER_HISTOGRAMS中选择ENDPOINT_NUMBER，ENDPOINT_VALUE，其中TABLE_NAME ='COUNTRIES'和COLUMN_NAME ='COUNTRY_SUBREGION_ID'; ENDPOINT_NUMBER ENDPOINT_VALUE --------------- -------------- 0 52792 2 52793 3 52795 4 52798 7 52799</code></pre><p>下图表示高度平衡的直方图。这些值在图中表示为硬币。</p>
                              <div class="figure" id="GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D__BABDFDAD">
                                 <p class="titleinfigure">图11-4高度平衡直方图</p><img src="img/tgsql_vm_071.png" alt="下面是图11-4的描述" title="下面是图11-4的描述" longdesc="img_text/tgsql_vm_071.html"><br><a href="img_text/tgsql_vm_071.html">“图11-4高度平衡直方图”的说明</a></div>
                              <!-- class="figure" -->
                              <p>桶号与端点号相同。优化程序将每个存储桶中最后一行的值记录为端点值，然后检查以确保最小值是第一个存储桶的端点值，最大值是最后一个存储桶的端点值。在此示例中，优化程序添加存储桶<code class="codeph">0</code>以便最小值<code class="codeph">52792</code>是存储桶的端点。
                              </p>
                              <p>优化器必须将23行均匀分配到7个指定的直方图桶中，因此每个桶包含大约3行。但是，优化程序使用相同的端点压缩存储区。所以，代替铲斗<code class="codeph">1</code>含有值的2个实例<code class="codeph">52793</code>和铲斗<code class="codeph">2</code>含有的值3个实例<code class="codeph">52793</code> ，优化器把的值的所有5个实例<code class="codeph">52793</code>到桶<code class="codeph">2</code> 。类似地，代替具有桶<code class="codeph">5</code> ， <code class="codeph">6</code> ，和<code class="codeph">7</code>包含每3个值，其中每个桶的端点作为<code class="codeph">52799</code> ，优化器把的值的所有实例9 <code class="codeph">52799</code>到铲斗<code class="codeph">7</code> 。
                              </p>
                              <p>在此示例中，存储桶<code class="codeph">3</code>和<code class="codeph">4</code>包含非流行值，因为当前端点号与先前端点号之间的差异为1。优化程序根据密度计算这些值的基数。剩余的桶包含流行的值。优化程序根据端点号计算这些值的基数。
                              </p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-3632AF1E-3721-47DC-B4BC-06420E73E37D__GUID-605338B1-838E-4BA4-9EC0-8E1C727F8C8B">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-CA6A56B9-0540-45E9-B1D7-D78769B7714C" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">DBMS_STATS.GATHER_TABLE_STATS</code>过程</p>
                           </li>
                           <li>
                              <p><span><cite>Oracle Database Reference</cite></span>了解<a href="../refrn/USER_TAB_COL_STATISTICS.html#REFRN-GUID-4FF4364B-29D0-4365-AA0F-ABD17CE298EC" target="_blank"><code class="codeph">USER_TAB_COL_STATISTICS</code></a>和<a href="../refrn/USER_HISTOGRAMS.html#REFRN-GUID-582FAF05-FA3B-45D6-BDD3-B35C5E209368" target="_blank"><code class="codeph">USER_HISTOGRAMS</code></a>视图</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-7A54B5FC-DB26-46C7-AA92-F986279A4CFD" title="在传统的高度平衡直方图中，列值被分成桶，以便每个桶包含大致相同的行数。">高度平衡直方图（遗留）</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL371"></a><div class="props_rev_3"><a id="GUID-59C57EDF-E763-436A-9CB2-B59A536A10F7" name="GUID-59C57EDF-E763-436A-9CB2-B59A536A10F7"></a><h3 id="TGSQL-GUID-59C57EDF-E763-436A-9CB2-B59A536A10F7" class="sect3"><span class="enumeration_section">11.8</span>混合直方图</h3>
               <div>
                  <p><strong class="term">混合直方图</strong>结合了基于高度的直方图和频率直方图的特征。这种“两全其美”的方法使优化器能够在某些情况下获得更好的选择性估计。
                  </p>
                  <p>基于高度的直方图有时会对<span class="italic">几乎</span>受欢迎的值产生不准确的估计。例如，作为仅一个存储桶的端点值而几乎占据两个存储桶的值不被认为是流行的。
                  </p>
                  <p>为了解决这个问题，混合直方图分配值，使得没有值占用多个桶，然后为直方图中的每个端点（桶）存储<a href="glossary.html#GUID-AE89C350-C30B-4A67-9EC3-E31ABD41A011"><span class="xrefglossterm">端点重复计</span></a>数值，这是端点值重复的次数。通过使用重复计数，优化器可以获得几乎流行值的准确估计。
                  </p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="histograms.html#GUID-D1E9A2D5-00D5-45A8-9B99-9A1077FAE206">端点重复如何工作</a><br>在桶之间分配的硬币的类比说明了显示端点重复计数的工作。
                     </li>
                     <li class="ulchildlink"><a href="histograms.html#GUID-BDE60322-28F2-4F4B-824E-D18F3C919FA3">混合直方图的标准</a><br>与顶部频率直方图相比，混合直方图的唯一区分标准是前<span class="italic">n个</span>频繁值小于内部阈值<span class="italic">p</span> 。
                     </li>
                     <li class="ulchildlink"><a href="histograms.html#GUID-EF84AF34-01FC-40A6-9ABB-C54E4DAECB18">生成混合直方图</a><br>此方案显示如何使用示例模式生成混合直方图。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="histograms.html#GUID-BE10EBFC-FEFC-4530-90DF-1443D9AD9B64" title="直方图是一种特殊类型的列统计信息，它提供有关表列中数据分布的更多详细信息。直方图将值排序为" buckets="=" ="">直方图</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL372"></a><div class="props_rev_3"><a id="GUID-D1E9A2D5-00D5-45A8-9B99-9A1077FAE206" name="GUID-D1E9A2D5-00D5-45A8-9B99-9A1077FAE206"></a><h4 id="TGSQL-GUID-D1E9A2D5-00D5-45A8-9B99-9A1077FAE206" class="sect4"><span class="enumeration_section">11.8.1</span>端点重复计数的工作原理</h4>
                  <div>
                     <p>在桶之间分配的硬币的类比说明了显示端点重复计数的工作。</p>
                     <p>下图说明了一个将值从低到高排序的<code class="codeph">coins</code>列。
                     </p>
                     <div class="figure" id="GUID-D1E9A2D5-00D5-45A8-9B99-9A1077FAE206__GUID-36C6CE07-CDFF-4FF1-97FB-2F488F46751A">
                        <p class="titleinfigure">图11-5硬币</p><img src="img/tgsql_vm_053.png" alt="下面是图11-5的描述" title="下面是图11-5的描述" longdesc="img_text/tgsql_vm_053.html"><br><a href="img_text/tgsql_vm_053.html">“图11-5硬币”的描述</a></div>
                     <!-- class="figure" -->
                     <p>您收集此表的统计信息，将<code class="codeph">DBMS_STATS.GATHER_TABLE_STATS</code>的<code class="codeph">method_opt</code>参数设置为<code class="codeph">FOR ALL COLUMNS SIZE 3</code> 。在这种情况下，优化器最初将<code class="codeph">coins</code>列中的值分组为三个桶，如下图所示。
                     </p>
                     <div class="figure" id="GUID-D1E9A2D5-00D5-45A8-9B99-9A1077FAE206__GUID-EC8CF3BA-DDC2-4942-B92F-98788353F1FE">
                        <p class="titleinfigure">图11-6值的初始分布</p><img src="img/tgsql_vm_054.png" alt="下面是图11-6的描述" title="下面是图11-6的描述" longdesc="img_text/tgsql_vm_054.html"><br><a href="img_text/tgsql_vm_054.html">“图11-6值的初始分布”的描述</a></div>
                     <!-- class="figure" -->
                     <p>如果存储桶边框拆分某个值，以便某些值出现在一个存储桶中而另一些存储在另一个存储桶中，则优化程序会将存储桶边界（以及所有其他存储桶边框）向前移动以包括所有出现的值。例如，优化器将值<code class="codeph">5</code>移位，使其现在完全位于第一个存储桶中，而值<code class="codeph">25</code>现在完全位于第二个存储桶中。
                     </p>
                     <div class="figure" id="GUID-D1E9A2D5-00D5-45A8-9B99-9A1077FAE206__GUID-60E9E709-5C8F-4FE8-B315-C57B06C41572">
                        <p class="titleinfigure">图11-7值的重新分配</p><img src="img/tgsql_vm_055.png" alt="下面是图11-7的描述" title="下面是图11-7的描述" longdesc="img_text/tgsql_vm_055.html"><br><a href="img_text/tgsql_vm_055.html">“图11-7重新分配值”的描述</a></div>
                     <!-- class="figure" -->
                     <p>端点重复计数测量相应的桶端点（右桶边界处的值）重复自身的次数。例如，在第一个桶中，值<code class="codeph">5</code>重复3次，因此端点重复计数为<code class="codeph">3</code> 。
                     </p>
                     <div class="figure" id="GUID-D1E9A2D5-00D5-45A8-9B99-9A1077FAE206__GUID-9D4E5C95-474C-49C7-97DB-D96EDC76FAE2">
                        <p class="titleinfigure">图11-8端点重复计数</p><img src="img/tgsql_vm_056.png" alt="下面是图11-8的描述" title="下面是图11-8的描述" longdesc="img_text/tgsql_vm_056.html"><br><a href="img_text/tgsql_vm_056.html">“图11-8端点重复计数”的说明</a></div>
                     <!-- class="figure" -->
                     <p>高度平衡的直方图不存储与混合直方图一样多的信息。通过使用重复计数，优化程序可以确切地确定存在多少次端点值。例如，优化器知道值<code class="codeph">5</code>出现3次，值<code class="codeph">25</code>出现4次，值<code class="codeph">100</code>出现2次。此频率信息有助于优化器生成更好的基数估计值。
                     </p>
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-59C57EDF-E763-436A-9CB2-B59A536A10F7" title="混合直方图结合了基于高度的直方图和频率直方图的特征。这个" best="" of="" both="" world="=" ="">混合直方图</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL95038"></a><div class="props_rev_3"><a id="GUID-BDE60322-28F2-4F4B-824E-D18F3C919FA3" name="GUID-BDE60322-28F2-4F4B-824E-D18F3C919FA3"></a><h4 id="TGSQL-GUID-BDE60322-28F2-4F4B-824E-D18F3C919FA3" class="sect4"><span class="enumeration_section">11.8.2</span>混合直方图的标准</h4>
                  <div>
                     <p>与顶部频率直方图相比，混合直方图的唯一区分标准是前<span class="italic">n个</span>频繁值小于内部阈值<span class="italic">p</span> 。
                     </p>
                     <p>如<span class="q">“ <a href="histograms.html#GUID-FFA0C0AF-3761-4829-995E-9AFA524F96CE" title="Oracle数据库使用多个条件来确定要创建的直方图：频率，顶部频率，高度平衡或混合。">Oracle数据库如何选择直方图类型</a> ”</span>中的逻辑图所示，数据库在满足以下条件时创建混合直方图：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>NDV大于<span class="italic">n</span> ，其中<span class="italic">n</span>是直方图桶的数量（默认值为<code class="codeph">254</code> ）。
                           </p>
                        </li>
                        <li>
                           <p>顶频直方图的标准不适用。</p>
                           <p>这是说明前<span class="italic">n个</span>频繁值占据的行的百分比小于阈值<span class="italic">p的</span>另一种方式，其中<span class="italic">p</span>是<code class="codeph">(1-(1/</code> <span class="italic"><code class="codeph">n</code></span> <code class="codeph">))*100</code> 。
                           </p>
                        </li>
                        <li>
                           <p><code class="codeph">DBMS_STATS</code>统计信息收集过程中的<code class="codeph">estimate_percent</code>参数设置为<code class="codeph">AUTO_SAMPLE_SIZE</code> 。</p>
                           <p>如果用户指定自己的百分比，则数据库会创建频率或高度平衡的直方图。</p>
                        </li>
                     </ul>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-BDE60322-28F2-4F4B-824E-D18F3C919FA3__NOTE-143-9825E7A0">
                        <p class="notep1">也可以看看：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><span class="q">“ <a href="histograms.html#GUID-A97DF0B5-ADDE-45D8-B6B9-1128F61F24E3" title="如果少量值占据大多数行，则即使NDV大于请求的直方图桶的数量，在这一小组值上创建频率直方图也是有用的。要为流行值创建更高质量的直方图，优化程序会忽略非流行值并创建顶部频率直方图。">最高频率直方图的标准</a> 。”</span></p>
                           </li>
                           <li>
                              <p><span class="q">“ <a href="histograms.html#GUID-7A54B5FC-DB26-46C7-AA92-F986279A4CFD" title="在传统的高度平衡直方图中，列值被分成桶，以便每个桶包含大致相同的行数。">高度平衡直方图（遗留）</a> ”</span></p>
                           </li>
                           <li>
                              <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-CA6A56B9-0540-45E9-B1D7-D78769B7714C" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解有关<code class="codeph">estimate_percent</code>参数的更多信息</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-59C57EDF-E763-436A-9CB2-B59A536A10F7" title="混合直方图结合了基于高度的直方图和频率直方图的特征。这个" best="" of="" both="" world="=" ="">混合直方图</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL95040"></a><a id="TGSQL95039"></a><div class="props_rev_3"><a id="GUID-EF84AF34-01FC-40A6-9ABB-C54E4DAECB18" name="GUID-EF84AF34-01FC-40A6-9ABB-C54E4DAECB18"></a><h4 id="TGSQL-GUID-EF84AF34-01FC-40A6-9ABB-C54E4DAECB18" class="sect4"><span class="enumeration_section">11.8.3</span>生成混合直方图</h4>
                  <div>
                     <p>此方案显示如何使用示例模式生成混合直方图。</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-EF84AF34-01FC-40A6-9ABB-C54E4DAECB18__GUID-D9C89D44-55DC-4A90-81CE-5E288DA6E313">假设</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>此方案假定您要在<code class="codeph">sh.products.prod_subcategory_id</code>列上生成混合直方图。该表有72行。<code class="codeph">prod_subcategory_id</code>列包含22个不同的值。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-EF84AF34-01FC-40A6-9ABB-C54E4DAECB18__GUID-03637819-0051-45B1-9253-1241E9AF0F3E">要生成混合直方图：</p>
                        <ol>
                           <li>
                              <p>收集<code class="codeph">sh.products</code>和<code class="codeph">prod_subcategory_id</code>列的统计信息，指定10个桶。
                              </p>
                              <p>例如，输入以下命令：</p><pre class="pre codeblock"><code>BEGIN DBMS_STATS.GATHER_TABLE_STATS（ownname =&gt;'SH'，tabname =&gt;'PRODUCTS'，method_opt =&gt;'FOR COLUMNS PROD_SUBCATEGORY_ID SIZE 10'）;结束;</code></pre></li>
                           <li>
                              <p>查询每个不同值占用的行数。</p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>SELECT COUNT（prod_subcategory_id）AS NUM_OF_ROWS，prod_subcategory_id FROM products GROUP BY prod_subcategory_id ORDER BY 1 DESC; NUM_OF_ROWS PROD_SUBCATEGORY_ID ----------- ------------------- 8 2014 7 2055 6 2032 6 2054 5 2056 5 2031 5 2042 5 2051 4 2036选择3 2043 2 2033 2 2034 2 2013 2 2012 2 2053 2 2035 1 2022 1 2041 1 2044 1 2011 1 2021 1 2052 22行。
</code></pre><p>该列包含22个不同的值。由于桶（10）的数量小于22，优化器无法创建频率直方图。优化器考虑混合和顶部频率直方图。为了有资格获得最高频率直方图，前10个最频繁值占据的行的百分比必须等于或大于阈值<span class="italic">p</span> ，其中<span class="italic">p</span>是（1-（1/10））* 100或90％。然而，在这种情况下，前10个最常见的值占据了72行中的54行，这仅占总数的75％。因此，优化器选择混合直方图，因为顶部频率直方图的标准不适用。
                              </p>
                           </li>
                           <li>
                              <p>查询<code class="codeph">country_subregion_id</code>列的直方图信息。
                              </p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>SELECT TABLE_NAME，COLUMN_NAME，NUM_DISTINCT，来自USER_TAB_COL_STATISTICS的HISTOGRAM，其中TABLE_NAME ='PRODUCTS'和COLUMN_NAME ='PROD_SUBCATEGORY_ID'; TABLE_NAME COLUMN_NAME NUM_DISTINCT直方图---------- ------------------- ------------ ----- ----产品PROD_SUBCATEGORY_ID 22 HYBRID</code></pre></li>
                           <li>
                              <p>查询<code class="codeph">country_subregion_id</code>列的端点号，端点值和端点重复计数。
                              </p>
                              <p>例如，使用以下查询（包括示例输出）：</p><pre class="pre codeblock"><code>从USER_HISTOGRAMS中选择END ENDINTINT_NUMBER，ENDPOINT_VALUE，ENDPOINT_REPEAT_COUNT，其中TABLE_NAME ='PRODUCTS'和COLUMN_NAME ='PROD_SUBCATEGORY_ID'Order By 1; ENDPOINT_NUMBER ENDPOINT_VALUE ENDPOINT_REPEAT_COUNT --------------- -------------- ------------------ --- 1 2011 1 13 2014 8 26 2032 6 36 2036 4 45 2043 3 51 2051 5 52 2052 1 54 2053 2 60 2054 6 72 2056 5选择10行。
</code></pre><p>在基于高度的直方图中，优化器会将72行均匀分布到10个指定的直方图桶中，以便每个桶包含大约7行。因为这是混合直方图，所以优化器会分配值，以便任何值都不会占用多个存储桶。例如，优化器不会将一些值为<code class="codeph">2036</code>实例放入一个存储桶中，而将此值的某些实例放入另一个存储桶中：所有实例都在存储桶<code class="codeph">36</code> 。
                              </p>
                              <p>端点重复计数显示桶中最高值重复的次数。通过使用这些值的端点号和重复计数，优化程序可以估计基数。例如，桶<code class="codeph">36</code>中包含的值的实例<code class="codeph">2033</code> ， <code class="codeph">2034</code> ， <code class="codeph">2035</code> ，和<code class="codeph">2036</code> 。端点值<code class="codeph">2036</code>的端点重复计数为<code class="codeph">4</code> ，因此优化器知道存在该值的4个实例。对于不是端点的<code class="codeph">2033</code>等值，优化程序使用密度估计基数。
                              </p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-EF84AF34-01FC-40A6-9ABB-C54E4DAECB18__GUID-16096DF5-A070-4CAB-81A4-D55180C6A531">
                        <p class="notep1">也可以看看：</p>
                        <ul id="GUID-EF84AF34-01FC-40A6-9ABB-C54E4DAECB18__UL_RDD_Y5G_5FB" style="list-style-type:disc">
                           <li>
                              <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-CA6A56B9-0540-45E9-B1D7-D78769B7714C" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">DBMS_STATS.GATHER_TABLE_STATS</code>过程</p>
                           </li>
                           <li>
                              <p><a href="../refrn/USER_TAB_COL_STATISTICS.html#REFRN-GUID-4FF4364B-29D0-4365-AA0F-ABD17CE298EC" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">USER_TAB_COL_STATISTICS</code>视图</p>
                           </li>
                           <li>
                              <p><a href="../refrn/USER_HISTOGRAMS.html#REFRN-GUID-582FAF05-FA3B-45D6-BDD3-B35C5E209368" target="_blank"><span><cite>Oracle Database Reference</cite></span></a>了解<code class="codeph">USER_HISTOGRAMS</code>视图</p>
                           </li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="histograms.html#GUID-59C57EDF-E763-436A-9CB2-B59A536A10F7" title="混合直方图结合了基于高度的直方图和频率直方图的特征。这个" best="" of="" both="" world="=" ="">混合直方图</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
         </div>
      </article>
   </body>
</html>