<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="These are some of the problems that can occur on a standby database, and the troubleshooting procedures to address them."></meta>
      <meta name="description" content="These are some of the problems that can occur on a standby database, and the troubleshooting procedures to address them."></meta>
      <title>Oracle Data Guard故障排除</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Concepts and Administration "></meta>
      <meta property="og:description" content="These are some of the problems that can occur on a standby database, and the troubleshooting procedures to address them."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Concepts and Administration"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="data-guard-concepts-and-administration.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-02-12T10:50:21-08:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="1999, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96244-02"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="oracle-data-guard-supplemental-information.html" title="Previous" type="text/html"></link>
      <link rel="next" href="upgrading-patching-downgrading-oracle-data-guard-configuration.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Data Guard Concepts and Administration"></meta>
    <meta name="dcterms.isVersionOf" content="SBYDB"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="oracle-data-guard-supplemental-information.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="upgrading-patching-downgrading-oracle-data-guard-configuration.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">概念和管理</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="oracle-data-guard-supplemental-information.html" property="item" typeof="WebPage"><span property="name">附录</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Oracle Data Guard故障排除</li>
            </ol>
            <a id="GUID-1AF3825C-C58B-4362-ADD5-A21FEF75912F" name="GUID-1AF3825C-C58B-4362-ADD5-A21FEF75912F"></a><a id="SBYDB01400"></a>
            
            <h2 id="SBYDB-GUID-1AF3825C-C58B-4362-ADD5-A21FEF75912F" class="sect2"><span class="enumeration_chapter">A</span>故障排除的Oracle Data Guard的</h2>
         </header>
         <div class="ind">
            <div>
               <p>这些是备用数据库可能出现的一些问题，以及解决这些问题的故障排除过程。</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-07FDFFCC-6FFB-458B-B7A3-F0833EE3BF8B" title="这些是使用备用数据库时可能遇到的一些常见问题。">常见问题</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-397ED7EA-1A1C-4224-82A3-746448BE6944" title="如果为MANDATORY目标指定REOPEN，则重做传输服务会在无法成功传输重做数据时停止主数据库。">日志文件目标失败</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-3BC98594-CFA0-4EDC-92B9-52F19088B224" title="处理逻辑备用数据库故障的重要工具是DBMS_LOGSTDBY.SKIP_ERROR过程。">处理逻辑备用数据库故障</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-05C15D55-8CD8-4CB3-ADD3-642AED0FB3A3" title="这些是可能导致切换失败的一些问题，以及可能的解决方案。">切换到物理备用数据库时出现问题</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-0D1E5C2A-A8E9-4866-89F4-47AA1D86BB7C" title="涉及逻辑备用数据库的切换操作通常包括两个阶段：准备和提交。例外情况是使用逻辑备用数据库滚动升级Oracle软件，或者使用Oracle Data Guard代理。">切换到逻辑备用数据库时出现问题</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-E2C9EEB9-CDCE-46B4-A7ED-D60B7FCD657A" title="遇到不受支持的语句或包时，SQL Apply将停止。">如果SQL Apply停止，该怎么办</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-5B879B01-2433-4B08-8D58-E91DBA58FEF7" title="为获得最佳性能，请在重做传输服务使用的每个Oracle Net连接描述符中将Oracle Net SDU参数设置为其最大值65535字节。">重做数据传输的网络调整</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-5F933817-AD03-43D7-878D-E4B115448DAD" title="如果文件系统本身的异步I / O显示性能问题，请尝试使用Direct I / O选项安装文件系统或设置FILESYSTEMIO_OPTIONS = SETALL初始化参数。">备用数据库上的磁盘性能较低</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-82348347-C02B-4179-A325-3192E6F94737" title="如果已在配置中的一个或多个备用数据库上配置了备用重做日志，请确保每个备用数据库上的备用重做日志文件的大小与主数据库上的联机重做日志文件的大小完全匹配。">日志文件必须匹配以避免主数据库关闭</a></p>
                  </li>
                  <li>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-B1551FC6-1B9F-49A5-A462-124697A449C3" title="这些疑难解答提示可帮助您从错误中恢复。">逻辑备用数据库故障排除</a></p>
                  </li>
               </ul>
            </div><a id="SBYDB01405"></a><div class="props_rev_3"><a id="GUID-07FDFFCC-6FFB-458B-B7A3-F0833EE3BF8B" name="GUID-07FDFFCC-6FFB-458B-B7A3-F0833EE3BF8B"></a><h3 id="SBYDB-GUID-07FDFFCC-6FFB-458B-B7A3-F0833EE3BF8B" class="sect3"><span class="enumeration_section">A.1</span>常见问题</h3>
               <div>
                  <p>这些是使用备用数据库时可能遇到的一些常见问题。</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-AFDF503B-600D-4B7E-A476-2E7E0CB489C0" title="当STANDBY_FILE_MANAGEMENT初始化参数设置为AUTO时，无法在备用站点上重命名数据文件。">使用ALTER DATABASE语句重命名数据文件</a></p>
                     </li>
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-E0F5B423-208F-4F7E-8CA4-0350D3A7CF0B" title="如果备用站点未接收重做数据，请查询V $ ARCHIVE_DEST视图并检查错误消息。">备用数据库不会从主数据库接收重做数据</a></p>
                     </li>
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-A0AF4052-4B12-496A-AC20-820E184C5A05" title="如果未使用ALTER DATABASE CREATE [LOGICAL] STANDBY CONTROLFILE ...语句或RMAN命令创建备用控制文件，则无法装入备用数据库。">您无法挂载物理备用数据库</a></p>
                     </li>
                  </ul>
               </div><a id="SBYDB4905"></a><div class="props_rev_3"><a id="GUID-AFDF503B-600D-4B7E-A476-2E7E0CB489C0" name="GUID-AFDF503B-600D-4B7E-A476-2E7E0CB489C0"></a><h4 id="SBYDB-GUID-AFDF503B-600D-4B7E-A476-2E7E0CB489C0" class="sect4"><span class="enumeration_section">A.1.1</span>使用ALTER DATABASE语句重命名数据文件</h4>
                  <div>
                     <p>当<code class="codeph">STANDBY_FILE_MANAGEMENT</code>初始化参数设置为<code class="codeph">AUTO</code>时，无法在备用站点上重命名数据文件。</p>
                     <p>将<code class="codeph">STANDBY_FILE_MANAGEMENT</code>初始化参数设置为<code class="codeph">AUTO</code> ，使用以下SQL语句<a id="d58098e358" class="indexterm-anchor"></a>不允许：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><code class="codeph">ALTER DATABASE RENAME</code></p>
                        </li>
                        <li>
                           <p><code class="codeph">ALTER DATABASE ADD / DROP LOGFILE</code></p>
                        </li>
                        <li>
                           <p><code class="codeph">ALTER DATABASE ADD / DROP STANDBY LOGFILE MEMBER</code></p>
                        </li>
                        <li>
                           <p><code class="codeph">ALTER DATABASE创建数据文件AS</code></p>
                        </li>
                     </ul>
                     <p>如果尝试在备用数据库上使用这些语句中的任何一个，则会返回错误。例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; <a id="d58098e384" class="indexterm-anchor"></a><a id="d58098e388" class="indexterm-anchor"></a> ALTER DATABASE RENAME FILE'/disk1/oracle/oradata/payroll/t_db2.log'改为'dummy'; alter database将文件'/disk1/oracle/oradata/payroll/t_db2.log'重命名为'dummy'*第1行的错误：ORA-01511：重命名日志/数据文件时出错ORA-01270：如果STANDBY_FILE_MANAGEMENT为，则不允许进行RENAME操作汽车</pre><p>请参阅<a href="managing-oracle-data-guard-physical-standby-databases.html#GUID-C60E4DB4-F424-454D-B4DF-7A97B2F09540" title="STANDBY_FILE_MANAGEMENT数据库初始化参数控制是否将数据文件添加到主数据库自动传播到物理备用数据库。">添加数据文件或创建表空间</a>以了解如何将数据文件添加到物理备用数据库。
                     </p>
                  </div>
               </div><a id="SBYDB4906"></a><div class="props_rev_3"><a id="GUID-E0F5B423-208F-4F7E-8CA4-0350D3A7CF0B" name="GUID-E0F5B423-208F-4F7E-8CA4-0350D3A7CF0B"></a><h4 id="SBYDB-GUID-E0F5B423-208F-4F7E-8CA4-0350D3A7CF0B" class="sect4"><span class="enumeration_section">A.1.2</span>备用数据库不从主数据库接收重做数据</h4>
                  <div>
                     <p>如果备用站点未接收重做数据，请查询<code class="codeph">V$ARCHIVE_DEST</code>视图并检查错误消息。
                     </p>
                     <p>例如，输入以下查询：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DEST_ID“ID”， - &gt; STATUS“DB_status”， - &gt; DESTINATION“Archive_dest”， - &gt; ERROR“Error” - &gt; FROM V $ ARCHIVE_DEST WHERE DEST_ID &lt;= 5; ID DB_status Archive_dest错误 -  --------- ------------------------------ ----- ------------------------------- 1 VALID / vobs / oracle / work / arc_dest / arc 2 ERROR standby1 ORA-16012： Archivelog备用数据库标识符不匹配3 INACTIVE 4 INACTIVE 5 INACTIVE 5行被选中。
</pre><p>如果查询的输出对您没有帮助，请检查以下可能的问题列表。如果存在以下任何条件，则重做传输服务无法将重做数据传输到备用数据库：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>备用实例的服务名称未正确配置<a id="d58098e499" class="indexterm-anchor"></a><a id="d58098e503" class="indexterm-anchor"></a><a id="d58098e507" class="indexterm-anchor"></a><a id="d58098e511" class="indexterm-anchor"></a>主数据库的<code class="codeph">tnsnames.ora</code>文件。
                           </p>
                        </li>
                        <li>
                           <p>主数据库的<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>参数指定的Oracle Net服务名称不正确。
                           </p>
                        </li>
                        <li>
                           <p>备用数据库的<code class="codeph">LOG_ARCHIVE_DEST_STATE_</code> <span class="italic"><code class="codeph">n</code></span>参数未设置为值<code class="codeph">ENABLE.</code></p>
                        </li>
                        <li>
                           <p>尚未为备用数据库正确配置<code class="codeph">listener.ora</code>文件。
                           </p>
                        </li>
                        <li>
                           <p>侦听器未在备用站点启动。</p>
                        </li>
                        <li>
                           <p>备用实例未启动。</p>
                        </li>
                        <li>
                           <p>您已将备用归档目标添加到主SPFILE或文本初始化参数文件，但尚未启用更改。</p>
                        </li>
                        <li>
                           <p>尚未正确配置重做传输身份验证。有关重做传输身份验证配置要求，请参阅第3.1.2节。</p>
                        </li>
                        <li>
                           <p>您使用无效备份作为备用数据库的基础（例如，您使用了来自错误数据库的备份，或者未使用正确的方法创建备用控制文件）。</p>
                        </li>
                     </ul>
                  </div>
               </div><a id="SBYDB4907"></a><div class="props_rev_3"><a id="GUID-A0AF4052-4B12-496A-AC20-820E184C5A05" name="GUID-A0AF4052-4B12-496A-AC20-820E184C5A05"></a><h4 id="SBYDB-GUID-A0AF4052-4B12-496A-AC20-820E184C5A05" class="sect4"><span class="enumeration_section">A.1.3</span>您无法挂载物理备用数据库</h4>
                  <div>
                     <p>如果未使用<code class="codeph">ALTER DATABASE CREATE [LOGICAL] STANDBY CONTROLFILE ...</code>语句或RMAN命令创建备用控制文件，则无法装入备用数据库。
                     </p>
                     <p>您不能使用以下类型的控制文件备份：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>操作系统创建的备份</p>
                        </li>
                        <li>
                           <p>使用<code class="codeph">ALTER DATABASE</code>语句创建的备份， <span class="italic">没有</span> <code class="codeph">PHYSICAL STANDBY</code>或<code class="codeph">LOGICAL STANDBY</code>选项</p>
                        </li>
                     </ul>
                  </div>
               </div>
            </div><a id="SBYDB5084"></a><a id="SBYDB5085"></a><a id="SBYDB4908"></a><div class="props_rev_3"><a id="GUID-397ED7EA-1A1C-4224-82A3-746448BE6944" name="GUID-397ED7EA-1A1C-4224-82A3-746448BE6944"></a><h3 id="SBYDB-GUID-397ED7EA-1A1C-4224-82A3-746448BE6944" class="sect3"><span class="enumeration_section">A.2日志文件目标失败</span></h3>
               <div>
                  <p>如果为<code class="codeph">MANDATORY</code>目标指定<code class="codeph">REOPEN</code> ，则重做传输服务会在无法成功传输重做数据时停止主数据库。
                  </p>
                  <div class="section">
                     <p>使用<code class="codeph">MAX_FAILURE</code>属性时需要<code class="codeph">REOPEN</code>属性。<a href="troubleshooting-oracle-data-guard.html#GUID-397ED7EA-1A1C-4224-82A3-746448BE6944__I635145">示例A-1</a>显示了如何设置5秒的重试时间并将重试次数限制为3次。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="example" id="GUID-397ED7EA-1A1C-4224-82A3-746448BE6944__I635145">
                     <p class="titleinexample">示例A-1设置重试时间和限制</p><pre class="oac_no_warn" dir="ltr">LOG_ARCHIVE_DEST_1 ='LOCATION = / arc_dest REOPEN = 5 MAX_FAILURE = 3'</pre><p><a id="d58098e765" class="indexterm-anchor"></a><a id="d58098e771" class="indexterm-anchor"></a><a id="d58098e775" class="indexterm-anchor"></a><a id="d58098e779" class="indexterm-anchor"></a>使用<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>参数的<code class="codeph">ALTERNATE</code>属性指定备用存档目标。当重做数据到备用数据库的传输失败时，可以使用备用存档目标。如果传输失败并且未指定<code class="codeph">REOPEN</code>属性或超出<code class="codeph">MAX_FAILURE</code>属性阈值，则重做传输服务会尝试在下一个存档操作时将重做数据传输到备用目标。
                     </p>
                     <p><a id="d58098e801" class="indexterm-anchor"></a><a id="d58098e805" class="indexterm-anchor"></a>使用<code class="codeph">NOALTERNATE</code>属性可防止原始存档目标在原始存档目标失败时自动更改为备用存档目标。
                     </p>
                     <p><a href="troubleshooting-oracle-data-guard.html#GUID-397ED7EA-1A1C-4224-82A3-746448BE6944__I635159">示例A-2</a>显示了如何设置<a id="d58098e816" class="indexterm-anchor"></a><a id="d58098e822" class="indexterm-anchor"></a>初始化参数，以便在发生任何错误时，单个强制本地目标自动故障转移到不同的目标。
                     </p>
                  </div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-397ED7EA-1A1C-4224-82A3-746448BE6944__I635159">
                     <p class="titleinexample">示例A-2指定备用目标</p><pre class="oac_no_warn" dir="ltr">LOG_ARCHIVE_DEST_1 ='LOCATION = / disk1 MANDATORY ALTERNATE = LOG_ARCHIVE_DEST_2'LOG_ARCHIVE_DEST_STATE_1 = ENABLE LOG_ARCHIVE_DEST_2 ='LOCATION = / disk2 MANDATORY'LOG_ARCHIVE_DEST_STATE_2 = ALTERNATE</pre><p>如果<code class="codeph">LOG_ARCHIVE_DEST_1</code>目标失败，则归档进程会自动切换到主数据库<code class="codeph">LOG_ARCHIVE_DEST_2</code>一个日志文件开关的<code class="codeph">LOG_ARCHIVE_DEST_2</code>目标。
                     </p>
                  </div>
                  <!-- class="example" -->
               </div>
            </div><a id="SBYDB4909"></a><div class="props_rev_3"><a id="GUID-3BC98594-CFA0-4EDC-92B9-52F19088B224" name="GUID-3BC98594-CFA0-4EDC-92B9-52F19088B224"></a><h3 id="SBYDB-GUID-3BC98594-CFA0-4EDC-92B9-52F19088B224" class="sect3"><span class="enumeration_section">A.3</span>处理逻辑备用数据库故障</h3>
               <div>
                  <p>处理逻辑备用数据库故障的重要工具是<code class="codeph">DBMS_LOGSTDBY.SKIP_ERROR</code>过程。
                  </p>
                  <p>根据表的重要程度，您可能希望执行以下操作之一：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>忽略表或特定DDL的失败</p>
                     </li>
                     <li>
                        <p>将存储过程与过滤器相关联，以便在运行时可以确定跳过语句，执行此语句或执行替换语句</p>
                     </li>
                  </ul>
                  <p>采取这些操作之一可防止SQL Apply停止。稍后，您可以查询<code class="codeph">DBA_LOGSTDBY_EVENTS</code>视图以查找并更正存在的任何问题。有关将<code class="codeph">DBMS_LOGSTDBY</code>程序包与PL / SQL标注过程一起使用的详细信息，请参阅<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=ARPLS363" target="_blank"><span class="italic">Oracle数据库PL / SQL程序包和类型参考</span></a> 。
                  </p>
               </div>
            </div><a id="SBYDB01410"></a><div class="props_rev_3"><a id="GUID-05C15D55-8CD8-4CB3-ADD3-642AED0FB3A3" name="GUID-05C15D55-8CD8-4CB3-ADD3-642AED0FB3A3"></a><h3 id="SBYDB-GUID-05C15D55-8CD8-4CB3-ADD3-642AED0FB3A3" class="sect3"><span class="enumeration_section">A.4</span>切换到物理备用数据库的问题</h3>
               <div>
                  <p>这些是可能导致切换失败的一些问题，以及可能的解决方案。</p>
                  <p></p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-616EF287-25CE-4F6D-A0C3-9A4DEDA3A97C" title="如果切换未成功完成，您可以在V $ ARCHIVED_LOG视图中查询SEQUENCE＃列，以查看从原始主数据库传输的最后一个重做数据是否已应用于备用数据库。">切换失败，因为重做数据未传输</a></p>
                     </li>
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-2BE05596-2E74-4FEE-84AB-81777B5B9E13" title="这是对切换期间可能收到ORA-01102错误的原因的解释，以及采取的措施。">切换失败，出现ORA-01102错误</a></p>
                     </li>
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-ACDE1813-1DBD-48E1-8C42-0A2E4ED36631" title="如果在切换后归档的重做日志文件未应用于新的备用数据库，则可能是因为切换后未正确设置某些环境或初始化参数。">切换后不应用重做数据</a></p>
                     </li>
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-97282862-4EA0-42D9-97EF-34E75A29F87F" title="对于发生错误且无法继续切换的情况下的物理备用数据库，仍可能将新的物理备用数据库还原为主要角色。">切换失败后重新启动并重新开始</a></p>
                     </li>
                  </ul>
               </div><a id="SBYDB4910"></a><div class="props_rev_3"><a id="GUID-616EF287-25CE-4F6D-A0C3-9A4DEDA3A97C" name="GUID-616EF287-25CE-4F6D-A0C3-9A4DEDA3A97C"></a><h4 id="SBYDB-GUID-616EF287-25CE-4F6D-A0C3-9A4DEDA3A97C" class="sect4"><span class="enumeration_section">A.4.1</span>切换失败，因为未传输重做数据</h4>
                  <div>
                     <p>如果切换未成功完成，您可以在<code class="codeph">V$ARCHIVED_LOG</code>视图中查询<code class="codeph">SEQUENCE#</code>列，以查看从原始主数据库传输的最后一个重做数据是否已应用于备用数据库。
                     </p>
                     <p>如果最后一个重做数据未传输到备用数据库，则可以手动将包含重做数据的存档重做日志文件从原始主数据库复制到旧备用数据库，并使用SQL <code class="codeph">ALTER DATABASE REGISTER LOGFILE</code> <span class="variable" translate="no">file_specification</span>语句进行<code class="codeph">ALTER DATABASE REGISTER LOGFILE</code> 。如果您随后开始应用服务，则会自动应用存档的重做日志文件。查询<code class="codeph">V$DATABASE</code>视图中的<code class="codeph">SWITCHOVER_STATUS</code>列。如果<code class="codeph">SWITCHOVER_STATUS</code>列返回<code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code>则现在可以切换到主要角色。</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS -----------------要选择PRIMARY 1行</pre><p>要继续切换，请按照指示<a href="managing-oracle-data-guard-role-transitions.html#GUID-AAD70601-D248-4309-B8DD-F461EE31A5FF" title="这些步骤描述了如何切换到物理备用数据库。">执行切换到物理备用数据库</a>的物理备用数据库或<a href="managing-oracle-data-guard-role-transitions.html#GUID-42B8B448-90E0-4D7D-82A3-AAA273E6E49B" title="执行切换以更改主数据库和逻辑备用数据库之间的角色时，请始终在主数据库上启动切换并在逻辑备用数据库上完成切换。">执行切换到逻辑备用数据库</a>的逻辑备用数据库，并再次尝试的目标备用数据库切换到主角色。
                     </p>
                  </div>
               </div><a id="SBYDB4913"></a><div class="props_rev_3"><a id="GUID-2BE05596-2E74-4FEE-84AB-81777B5B9E13" name="GUID-2BE05596-2E74-4FEE-84AB-81777B5B9E13"></a><h4 id="SBYDB-GUID-2BE05596-2E74-4FEE-84AB-81777B5B9E13" class="sect4"><span class="enumeration_section">A.4.2</span>切换因ORA-01102错误而失败</h4>
                  <div>
                     <p>这是对切换期间可能收到<code class="codeph">ORA-01102</code>错误的原因的解释，以及采取的措施。
                     </p>
                     <p>假设备用数据库和主数据库位于同一站点上。成功执行<code class="codeph">ALTER DATABASE SWITCHOVER TO</code> <span class="italic"><code class="codeph">target_db_name</code></span>语句后，关闭并重新启动物理备用数据库和主数据库。
                     </p>
                     <div class="infoboxnote" id="GUID-2BE05596-2E74-4FEE-84AB-81777B5B9E13__GUID-911F3AA6-A1EC-47FC-8C75-12411224C05C">
                        <p class="notep1">注意：</p>
                        <p>如果物理备用数据库在实例启动后尚未以只读方式打开，则无需关闭并重新启动物理备用数据库。</p>
                     </div>
                     <p>但是，第二个数据库的启动失败， <code class="codeph">ORA-01102</code>错误“无法在<code class="codeph">EXCLUSIVE</code>模式下安装数据库”。</p>
                     <p>如果未在备用数据库（原始主数据库）使用的初始化参数文件中设置<code class="codeph">DB_UNIQUE_NAME</code>参数，则可能会在切换期间发生这种情况。如果未设置备用数据库的<code class="codeph">DB_UNIQUE_NAME</code>参数，则备用数据库和主数据库都使用相同的安装锁定，并在启动第二个数据库期间导致<code class="codeph">ORA-01102</code>错误。
                     </p>
                     <p>操作：将<code class="codeph">DB_UNIQUE_NAME=</code> <span class="italic"><code class="codeph">unique_database_name</code></span>添加到备用数据库使用的初始化参数文件中，然后关闭并重新启动备用数据库和主数据库。
                     </p>
                  </div>
               </div><a id="SBYDB4914"></a><div class="props_rev_3"><a id="GUID-ACDE1813-1DBD-48E1-8C42-0A2E4ED36631" name="GUID-ACDE1813-1DBD-48E1-8C42-0A2E4ED36631"></a><h4 id="SBYDB-GUID-ACDE1813-1DBD-48E1-8C42-0A2E4ED36631" class="sect4"><span class="enumeration_section">A.4.3</span>切换后不应用重做数据</h4>
                  <div>
                     <p>如果在切换后归档的重做日志文件未应用于新的备用数据库，则可能是因为切换后未正确设置某些环境或初始化参数。</p>
                     <div class="section">
                        <p></p>
                        <p></p>
                        <p>行动：</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <ul style="list-style-type:disc">
                           <li>
                              <p>检查新主站点上的<code class="codeph">tnsnames.ora</code>文件和新备用站点上的<code class="codeph">listener.ora</code>文件。备用站点上的侦听器应该有条目，主站点上应该有相应的服务名称。
                              </p>
                           </li>
                           <li>
                              <p>如果尚未启动，则在备用站点启动侦听器。</p>
                           </li>
                           <li>
                              <p>检查<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>初始化参数是否已设置为正确地将重做数据从主站点传输到备用站点。例如，在主站点查询<code class="codeph">V$ARCHIVE_DEST</code>固定视图，如下所示：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DEST_ID，STATUS，DESTINATION from V $ ARCHIVE_DEST;</pre><p>如果没有看到与备用站点对应的条目，则需要设置<code class="codeph">LOG_ARCHIVE_DEST_</code> <span class="italic"><code class="codeph">n</code></span>和<code class="codeph">LOG_ARCHIVE_DEST_STATE_</code> <span class="italic"><code class="codeph">n</code></span>初始化参数。
                              </p>
                           </li>
                           <li>
                              <p>验证在备用站点上是否正确设置了<code class="codeph">LOG_ARCHIVE_FORMAT</code>初始化参数。
                              </p>
                           </li>
                           <li>
                              <p>在备用站点，设置<code class="codeph">DB_FILE_NAME_CONVERT</code>和<code class="codeph">LOG_FILE_NAME_CONVERT</code>初始化参数。将<code class="codeph">STANDBY_FILE_MANAGEMENT</code>初始化参数设置为<code class="codeph">AUTO</code>以使备用站点能够自动添加在主站点上创建的新数据文件。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB4915"></a><div class="props_rev_3"><a id="GUID-97282862-4EA0-42D9-97EF-34E75A29F87F" name="GUID-97282862-4EA0-42D9-97EF-34E75A29F87F"></a><h4 id="SBYDB-GUID-97282862-4EA0-42D9-97EF-34E75A29F87F" class="sect4"><span class="enumeration_section">A.4.4</span>切换失败并重新启动后回滚</h4>
                  <div>
                     <p>对于发生错误且无法继续切换的情况下的物理备用数据库，仍可能将新的物理备用数据库还原为主要角色。</p>
                     <div class="section">
                        <p>请执行以下步骤。（此功能从Oracle Database <span class="italic">11g</span>第2版（11.2.0.2）开始提供。）
                        </p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>关闭并装入新的备用数据库（旧的主数据库）。</span></li>
                        <li class="stepexpand"><span>在新的备用数据库上启动重做应用。</span></li>
                        <li class="stepexpand"><span>验证新备用数据库是否已准备好切换回主角色。查询新备用数据库上<code class="codeph">V$DATABASE</code>视图的<code class="codeph">SWITCHOVER_STATUS</code>列。例如：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SWITCHOVER_STATUS FROM V $ DATABASE; SWITCHOVER_STATUS ----------------- TO_PRIMARY选择了1行</pre><p><code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code>值表示新备用数据库已准备好切换到主要角色。继续查询此列，直到返回的值为<code class="codeph">TO PRIMARY</code>或<code class="codeph">SESSIONS ACTIVE</code> 。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>发出以下语句以将新备用数据库转换回主要角色：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE SWITCHOVER到<span class="italic">target_db_name</span> [FORCE];</pre><p>如果此语句成功，则数据库将以主数据库角色运行，您无需再执行任何步骤。</p>
                              <p>如果此声明不成功，请继续步骤5。</p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>当启动切换以将角色从主服务器更改为物理服务器时，会在日志目录中写入跟踪文件。此跟踪文件包含重新创建原始主控制文件所需的SQL语句。找到跟踪文件并将SQL语句提取到临时文件中。从SQL * Plus执行临时文件。这会将新备用数据库还原为主角色。</span></li>
                        <li class="stepexpand"><span>关闭原始物理备用数据库。</span></li>
                        <li class="stepexpand"><span>创建一个新的备用控制文件。这是重新同步主数据库和物理备用数据库所必需的。将物理备用控制文件复制到原始物理备用系统。<a href="creating-oracle-data-guard-physical-standby.html#GUID-B471D788-AFD3-48B3-9709-D63C34DBC269" title="为备用数据库创建控制文件（主数据库不必打开，但必须至少安装它）。">为备用数据库创建控制文件</a>描述了如何创建物理备用控制文件。</span></li>
                        <li class="stepexpand"><span>重新启动原始物理备用实例。</span><div>
                              <p>如果此过程成功并且启用了存档间隙管理，则FAL进程会启动并将任何丢失的存档重做日志文件重新存档到物理备用数据库。强制主数据库上的日志切换并检查主数据库和物理备用数据库上的警报日志，以确保归档的重做日志文件序列号正确无误。</p>
                              <p>有关存档间隙管理和<a href="setting-LOG_ARCHIVE_TRACE-initialization-parameter.html#GUID-515A27B2-5163-42E1-A78D-B6E979BA54EB" title="Oracle数据库使用LOG_ARCHIVE_TRACE初始化参数来启用和控制日志归档和重做传输活动的综合跟踪信息的生成。">设置存档跟踪</a>的信息，请参阅<a href="oracle-data-guard-redo-transport-services.html#GUID-97EB433B-4125-4082-9276-2454349BC4F8" title="在某些情况下，无法自动执行间隙分辨，必须手动执行。">手动间隙分辨率</a> ，以获取有关查找跟踪文件的信息。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>再次尝试切换。</span><div>
                              <p>此时，Oracle Data Guard配置已回滚到其初始状态，您可以再次尝试切换操作（在纠正可能导致初始切换失败的任何问题之后）。</p>
                           </div>
                        </li>
                     </ol>
                  </div>
               </div>
            </div><a id="SBYDB4916"></a><div class="props_rev_3"><a id="GUID-0D1E5C2A-A8E9-4866-89F4-47AA1D86BB7C" name="GUID-0D1E5C2A-A8E9-4866-89F4-47AA1D86BB7C"></a><h3 id="SBYDB-GUID-0D1E5C2A-A8E9-4866-89F4-47AA1D86BB7C" class="sect3"><span class="enumeration_section">A.5</span>切换到逻辑备用数据库的问题</h3>
               <div>
                  <p>涉及逻辑备用数据库的切换操作通常包括两个阶段：准备和提交。例外情况是使用逻辑备用数据库滚动升级Oracle软件，或者使用Oracle Data Guard代理。</p>
                  <p>如果在使用逻辑备用数据库进行滚动升级或在Oracle Data Guard代理启动的切换操作期间遇到故障，请在切换操作<a href="troubleshooting-oracle-data-guard.html#GUID-A97E4093-B9C0-48E7-BCBE-77DB570A16C2" title="Although committing to a switchover involves a single SQL statement, internally a number of operations are performed.">的提交阶段</a>直接转至<a href="troubleshooting-oracle-data-guard.html#GUID-A97E4093-B9C0-48E7-BCBE-77DB570A16C2" title="尽管提交切换涉及单个SQL语句，但在内部执行许多操作。">故障</a> 。
                  </p>
                  <div class="infoboxnote" id="GUID-0D1E5C2A-A8E9-4866-89F4-47AA1D86BB7C__GUID-D8BAD7F7-74E4-4C53-B3C1-B197570B786E">
                     <p class="notep1">注意：</p>
                     <p>Oracle建议为Oracle Data Guard配置中的所有数据库启用闪回数据库。本节中的步骤假定您在Oracle Data Guard配置中的所有数据库上都启用了闪回数据库。</p>
                  </div>
               </div><a id="SBYDB4917"></a><div class="props_rev_3"><a id="GUID-7B380888-6FEF-4B79-93B9-0D25821E704E" name="GUID-7B380888-6FEF-4B79-93B9-0D25821E704E"></a><h4 id="SBYDB-GUID-7B380888-6FEF-4B79-93B9-0D25821E704E" class="sect4"><span class="enumeration_section">A.5.1</span>切换操作准备阶段的失败</h4>
                  <div>
                     <p>如果在切换操作的准备阶段发生故障，则取消切换并从一开始就重新尝试切换操作。</p>
                  </div><a id="SBYDB4918"></a><div class="props_rev_3"><a id="GUID-3A7971C1-3593-4F68-873C-26A2CCA33258" name="GUID-3A7971C1-3593-4F68-873C-26A2CCA33258"></a><h5 id="SBYDB-GUID-3A7971C1-3593-4F68-873C-26A2CCA33258" class="sect5"><span class="enumeration_section">A.5.1.1</span>准备主数据库时失败</h5>
                     <div>
                        <p>如果在执行<code class="codeph">ALTER DATABASE PREPARE TO SWITCHOVER TO LOGICAL STANDBY</code>语句时遇到故障，则可以取消切换的准备阶段。
                        </p>
                        <div class="section">
                           <p>为此，请在主数据库中发出以下SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE准备切换到LOGICAL STANDBY CANCEL;</pre><p>您现在可以从头开始重试切换操作。</p>
                        </div>
                        <!-- class="section" -->
                     </div>
                  </div><a id="SBYDB4919"></a><div class="props_rev_3"><a id="GUID-7A07B541-BD0D-440D-92A3-EC305F3D9821" name="GUID-7A07B541-BD0D-440D-92A3-EC305F3D9821"></a><h5 id="SBYDB-GUID-7A07B541-BD0D-440D-92A3-EC305F3D9821" class="sect5"><span class="enumeration_section">A.5.1.2</span>准备逻辑备用数据库时<span class="enumeration_section">出现</span>故障</h5>
                     <div>
                        <p>如果在执行<code class="codeph">ALTER DATABASE PREPARE TO SWITCHOVER TO PRIMARY</code>语句时遇到故障，则需要在主数据库和目标备用数据库中取消准备操作。
                        </p>
                        <div class="section">
                           <p>采取以下步骤：</p>
                        </div>
                        <!-- class="section" -->
                        <ol>
                           <li class="stepexpand"><span>在主数据库中，取消为准备切换而发出的语句：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE准备切换到LOGICAL STANDBY CANCEL;</pre></div>
                           </li>
                           <li class="stepexpand"><span>在作为切换目标的逻辑备用数据库中，取消您为准备切换而发出的语句：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE准备切换到初级取消;</pre><p>您现在可以从头开始重试切换操作。</p>
                              </div>
                           </li>
                        </ol>
                     </div>
                  </div>
               </div><a id="SBYDB4920"></a><div class="props_rev_3"><a id="GUID-A97E4093-B9C0-48E7-BCBE-77DB570A16C2" name="GUID-A97E4093-B9C0-48E7-BCBE-77DB570A16C2"></a><h4 id="SBYDB-GUID-A97E4093-B9C0-48E7-BCBE-77DB570A16C2" class="sect4"><span class="enumeration_section">A.5.2</span>切换操作的提交阶段失败</h4>
                  <div>
                     <p>尽管提交切换涉及单个SQL语句，但在内部执行许多操作。</p>
                     <p>您需要采取的纠正措施取决于遇到错误时切换操作的提交状态。</p>
                  </div><a id="SBYDB01415"></a><div class="props_rev_3"><a id="GUID-46D11649-5971-4A47-BA25-6FFAD2D4B83E" name="GUID-46D11649-5971-4A47-BA25-6FFAD2D4B83E"></a><h5 id="SBYDB-GUID-46D11649-5971-4A47-BA25-6FFAD2D4B83E" class="sect5"><span class="enumeration_section">A.5.2.1</span>无法转换原始主数据库</h5>
                     <div>
                        <p>如果在执行<code class="codeph">ALTER DATABASE COMMIT TO SWITCHOVER TO LOGICAL STANDBY</code>语句时遇到故障，则可以采取纠正措施。
                        </p>
                        <div class="section">
                           <p></p>
                           <ol>
                              <li>
                                 <p>检查原始主数据库上<code class="codeph">V$DATABASE</code>修复视图的<code class="codeph">DATABASE_ROLE</code>列：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DATABASE_ROLE FROM V $ DATABASE;</pre><ul style="list-style-type:disc">
                                    <li>
                                       <p>如果列包含值<code class="codeph">LOGICAL STANDBY</code> ，则切换操作已完成，但在切换后任务期间失败。在这种情况下，Oracle建议您关闭并重新打开数据库。
                                       </p>
                                    </li>
                                    <li>
                                       <p>如果列包含值<code class="codeph">PRIMARY</code> ，请继续执行步骤2。
                                       </p>
                                    </li>
                                 </ul>
                              </li>
                              <li>
                                 <p>在原始主节点上执行以下查询：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT COUNT（*）FROM SYSTEM.LOGSTDBY $ PARAMETERS  - &gt; WHERE NAME ='END_PRIMARY';</pre><ul style="list-style-type:disc">
                                    <li>
                                       <p>如果查询返回0，则主节点处于与发出提交切换命令之前相同的状态。您无需采取任何纠正措施。您可以继续提交切换操作或取消切换操作，如<a href="troubleshooting-oracle-data-guard.html#GUID-7A07B541-BD0D-440D-92A3-EC305F3D9821" title="如果在执行ALTER DATABASE PREPARE TO SWITCHOVER TO PRIMARY语句时遇到故障，则需要在主数据库和目标备用数据库中取消准备操作。">准备逻辑备用数据库时的故障中所述</a> 。
                                       </p>
                                    </li>
                                    <li>
                                       <p>如果查询返回1，则主节点处于不一致状态，您需要继续执行步骤3。</p>
                                    </li>
                                 </ul>
                              </li>
                              <li>
                                 <p>在原始主数据库上采取纠正措施，以保持其受现有或新实例化的逻辑备用数据库保护的能力。</p>
                                 <p>您可以修复在提交切换操作期间引发的错误的根本原因，并重新<code class="codeph">ALTER DTABASE COMMIT TO SWITCHOVER TO LOGICAL STANDBY</code> SQL语句（ <code class="codeph">ALTER DTABASE COMMIT TO SWITCHOVER TO LOGICAL STANDBY</code> ），或者您可以执行以下步骤：</p>
                                 <ol type="a">
                                    <li>
                                       <p>从启动了commit to switchover命令的实例的警报日志中，确定闪回原始主节点所需的SCN。在<code class="codeph">ALTER DATABASE COMMIT TO SWITCHOVER TO LOGICAL STANDBY</code> SQL语句之后显示此信息：</p><pre class="oac_no_warn" dir="ltr">LOGSTDBY：在scn [flashback_scn]上准备COMMIT TO SWITCHOVER到LOGICAL STANDBY DDL。
</pre></li>
                                    <li>
                                       <p>关闭主数据库的所有实例：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SHUTDOWN IMMEDIATE;</pre></li>
                                    <li>
                                       <p>以独占模式挂载主数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP MOUNT;</pre></li>
                                    <li>
                                       <p>将数据库闪回到从警报日志中获取的SCN：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; FLASHBACK DATABASE到SCN之前&lt;flashback_scn&gt;;</pre></li>
                                    <li>
                                       <p>打开主数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP;</pre></li>
                                    <li>
                                       <p>降低原始主数据库中的数据库防护：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE GUARD NONE;</pre></li>
                                 </ol>
                                 <p>此时，主节点处于与发出提交切换命令之前相同的状态。您无需采取任何纠正措施。您可以继续提交切换操作或取消切换操作，如<a href="troubleshooting-oracle-data-guard.html#GUID-3A7971C1-3593-4F68-873C-26A2CCA33258" title="如果在执行ALTER DATABASE PREPARE TO SWITCHOVER TO LOGICAL STANDBY语句时遇到故障，则可以取消切换的准备阶段。">准备主数据库时的故障中所述</a> 。
                                 </p>
                              </li>
                           </ol>
                        </div>
                        <!-- class="section" -->
                     </div>
                  </div><a id="SBYDB01420"></a><div class="props_rev_3"><a id="GUID-8EF3068B-4A91-43A9-8004-5B6418CE9482" name="GUID-8EF3068B-4A91-43A9-8004-5B6418CE9482"></a><h5 id="SBYDB-GUID-8EF3068B-4A91-43A9-8004-5B6418CE9482" class="sect5"><span class="enumeration_section">A.5.2.2</span>无法转换目标逻辑备用数据库</h5>
                     <div>
                        <p>如果在执行<code class="codeph">ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY</code>语句时遇到故障，则可以采取纠正措施。
                        </p>
                        <div class="section">
                           <ol>
                              <li>
                                 <p>检查目标备用数据库上<code class="codeph">V$DATABASE</code>固定视图的<code class="codeph">DATABASE_ROLE</code>列：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT DATABASE_ROLE FROM V $ DATABASE;</pre><ul style="list-style-type:disc">
                                    <li>
                                       <p>如果列包含值<code class="codeph">PRIMARY</code> ，则切换操作已完成，但在切换后任务期间失败。在这种情况下，您必须执行以下步骤：</p>
                                       <ol type="a">
                                          <li>
                                             <p>关闭并重新打开数据库。</p>
                                          </li>
                                          <li>
                                             <p>发出<code class="codeph">ALTER DATABASE GUARD NONE</code>命令以删除对数据库的写入限制。
                                             </p>
                                          </li>
                                       </ol>
                                    </li>
                                    <li>
                                       <p>如果列包含<code class="codeph">LOGICAL STANDBY</code>值，请继续执行步骤2。
                                       </p>
                                    </li>
                                 </ul>
                              </li>
                              <li>
                                 <p>在目标逻辑备用数据库上执行以下查询：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT COUNT（*）FROM SYSTEM.LOGSTDBY $ PARAMETERS  - &gt; WHERE NAME ='BEGIN_PRIMARY';</pre><ul style="list-style-type:disc">
                                    <li>
                                       <p>如果查询返回0，则逻辑备用数据库的状态与发出提交切换命令之前的状态相同。您无需采取任何纠正措施。您可以继续提交切换操作或取消切换操作，如<a href="troubleshooting-oracle-data-guard.html#GUID-7A07B541-BD0D-440D-92A3-EC305F3D9821" title="如果在执行ALTER DATABASE PREPARE TO SWITCHOVER TO PRIMARY语句时遇到故障，则需要在主数据库和目标备用数据库中取消准备操作。">准备逻辑备用数据库时的故障中所述</a> 。
                                       </p>
                                    </li>
                                    <li>
                                       <p>如果查询返回1，则逻辑备用数据库处于不一致状态。继续第3步。</p>
                                    </li>
                                 </ul>
                              </li>
                              <li>
                                 <p>在逻辑备用数据库上采取纠正措施，以保持其成为新主服务器或成为不同新主服务器的旁观者的能力。</p>
                                 <p>您可以修复在提交切换操作期间引发的错误的根本原因，并重新发出SQL语句（ <code class="codeph">ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY</code> ），或者您可以执行以下步骤将逻辑备用数据库闪回到一致性点在提交切换尝试之前：</p>
                                 <ol type="a">
                                    <li>
                                       <p>从启动commit to switchover命令的实例的警报日志中，确定闪回逻辑备用数据库所需的SCN。在<code class="codeph">ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY</code> SQL语句之后显示此信息：</p><pre class="oac_no_warn" dir="ltr">LOGSTDBY：在scn [flashback_scn]上准备COMMIT TO SWITCHOVER到PRIMARY DDL。
</pre></li>
                                    <li>
                                       <p>关闭目标备用数据库的所有实例：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SHUTDOWN IMMEDIATE;</pre></li>
                                    <li>
                                       <p>挂载目标逻辑备用数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP MOUNT;</pre></li>
                                    <li>
                                       <p>将目标逻辑备用闪回到所需的SCN：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; FLASHBACK DATABASE到SCN之前&lt;flashback_scn&gt;;</pre></li>
                                    <li>
                                       <p>打开数据库（如果是Oracle RAC，请打开所有实例）;</p><pre class="oac_no_warn" dir="ltr">SQL&gt; STARTUP OPEN;</pre></li>
                                 </ol>
                              </li>
                           </ol>
                           <p>此时，目标备用数据库的状态与发出提交切换命令之前的状态相同。您无需采取任何进一步的纠正措施。您可以继续提交切换操作。</p>
                        </div>
                        <!-- class="section" -->
                     </div>
                  </div>
               </div>
            </div><a id="SBYDB5087"></a><a id="SBYDB4921"></a><div class="props_rev_3"><a id="GUID-E2C9EEB9-CDCE-46B4-A7ED-D60B7FCD657A" name="GUID-E2C9EEB9-CDCE-46B4-A7ED-D60B7FCD657A"></a><h3 id="SBYDB-GUID-E2C9EEB9-CDCE-46B4-A7ED-D60B7FCD657A" class="sect3"><span class="enumeration_section">A.6</span>如果SQL Apply停止怎么办</h3>
               <div>
                  <p>遇到不受支持的语句或包时，SQL Apply将停止。</p>
                  <div class="section">
                     <p>Apply服务无法将不受支持的DML语句，DDL语句和Oracle提供的包应用于运行SQL Apply的逻辑备用数据库。</p>
                     <p>如果由于语句或程序包不受支持而导致SQL Apply停止，则可以采取<a href="troubleshooting-oracle-data-guard.html#GUID-E2C9EEB9-CDCE-46B4-A7ED-D60B7FCD657A__G640603" title="此2列表列出了SQL Apply停止的典型原因，并描述了纠正每种情况的可能解决方案。">表A-1中</a>所述的操作来更正此情况并再次在逻辑备用数据库上启动SQL Apply。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="tblformalwide" id="GUID-E2C9EEB9-CDCE-46B4-A7ED-D60B7FCD657A__G640603">
                     <p class="titleintable">表A-1修复典型的SQL应用错误</p>
                     <table cellpadding="4" cellspacing="0" class="FormalWide" title="修复典型的SQL应用错误" width="100%" border="1" summary="This 2 column table lists typical reasons why SQL Apply stops and describes possible solutions to correct each situation." frame="hsides" rules="rows">
                        <thead>
                           <tr align="left" valign="top">
                              <th align="left" valign="bottom" width="43%" id="d58098e2584">如果...</th>
                              <th align="left" valign="bottom" width="57%" id="d58098e2587">然后...</th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="43%" id="d58098e2592" headers="d58098e2584 ">
                                 <p>您怀疑遇到了不受支持的语句或Oracle提供的包</p>
                              </td>
                              <td align="left" valign="top" width="57%" headers="d58098e2592 d58098e2587 ">
                                 <p>找到最后一个语句<a id="d58098e2598" class="indexterm-anchor"></a><a id="d58098e2600" class="indexterm-anchor"></a> <code class="codeph">DBA_LOGSTDBY_EVENTS</code>视图。它显示导致SQL Apply失败的语句和错误。如果不正确的SQL语句导致SQL Apply失败，则可以查看事务信息以及语句和错误信息。事务信息可与LogMiner工具一起使用，以了解问题的原因。
                                 </p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="43%" id="d58098e2608" headers="d58098e2584 ">
                                 <p>发生了需要进行数据库管理的错误，例如特定表空间中的空间不足</p>
                              </td>
                              <td align="left" valign="top" width="57%" headers="d58098e2608 d58098e2587 ">
                                 <p>解决问题并使用。恢复SQL Apply <a id="d58098e2614" class="indexterm-anchor"></a><a id="d58098e2618" class="indexterm-anchor"></a> <code class="codeph">ALTER DATABASE START LOGICAL STANDBY APPLY</code>语句。
                                 </p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="43%" id="d58098e2626" headers="d58098e2584 ">
                                 <p>发生错误是因为输入的SQL语句不正确，例如在表空间语句中输入了错误的备用数据库文件名</p>
                              </td>
                              <td align="left" valign="top" width="57%" headers="d58098e2626 d58098e2587 ">
                                 <p>输入正确的SQL语句并使用<a id="d58098e2632" class="indexterm-anchor"></a><a id="d58098e2636" class="indexterm-anchor"></a> <code class="codeph">DBMS_LOGSTDBY.SKIP_TRANSACTION</code>过程以确保在下次运行SQL Apply时忽略不正确的语句。然后，使用<code class="codeph">ALTER DATABASE START LOGICAL STANDBY APPLY</code>语句重新启动SQL Apply。
                                 </p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="43%" id="d58098e2647" headers="d58098e2584 ">
                                 <p>发生错误，因为跳过参数设置不正确，例如指定跳过给定表的所有DML但未指定跳过<code class="codeph">CREATE</code> ， <code class="codeph">ALTER</code>和<code class="codeph">DROP TABLE</code>语句</p>
                              </td>
                              <td align="left" valign="top" width="57%" headers="d58098e2647 d58098e2587 ">
                                 <p>发出<a id="d58098e2662" class="indexterm-anchor"></a><a id="d58098e2666" class="indexterm-anchor"></a> <code class="codeph">DBMS_LOGSTDBY.SKIP('TABLE','schema_name','table_name',null)</code>过程，然后重新启动SQL Apply。
                                 </p>
                              </td>
                           </tr>
                        </tbody>
                     </table>
                  </div>
                  <!-- class="inftblhruleinformal" -->
                  <div class="section">
                     <p>有关查询<code class="codeph">DBA_LOGSTDBY_EVENTS</code>视图以确定故障原因的信息，请参阅<a href="oracle-data-guard-in-oracle-database-views.html#GUID-FF72163C-78B0-475F-B4CE-135EF288A32A" title="在监视Oracle Data Guard环境时，有许多视图特别有用。">与Oracle Data Guard相关</a>的视图。
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="SBYDB00440"></a><div class="props_rev_3"><a id="GUID-5B879B01-2433-4B08-8D58-E91DBA58FEF7" name="GUID-5B879B01-2433-4B08-8D58-E91DBA58FEF7"></a><h3 id="SBYDB-GUID-5B879B01-2433-4B08-8D58-E91DBA58FEF7" class="sect3"><span class="enumeration_section">A.7</span>重做数据传输的网络调整</h3>
               <div>
                  <p>为获得最佳性能，请在重做传输服务使用的每个Oracle Net连接描述符中将Oracle Net SDU参数设置为其最大值65535字节。</p>
                  <p>以下示例显示了定义远程目标<code class="codeph">netserv</code>的数据库初始化参数文件段：</p><pre class="oac_no_warn" dir="ltr">LOG_ARCHIVE_DEST_3 = 'SERVICE = netserv'</pre><p>下面的示例显示了该服务名称的定义<a id="d58098e2790" class="indexterm-anchor"></a><a id="d58098e2794" class="indexterm-anchor"></a><a id="d58098e2798" class="indexterm-anchor"></a><a id="d58098e2802" class="indexterm-anchor"></a> <code class="codeph">tnsnames.ora</code>文件：</p><pre class="oac_no_warn" dir="ltr">netserv =（DESCRIPTION =（SDU = 32768）（ADDRESS =（PROTOCOL = tcp）（HOST = host）（PORT = 1521））（CONNECT_DATA =（SERVICE_NAME = srvc）））</pre><p>以下示例显示了<code class="codeph">listener.ora</code>文件中的定义：</p><pre class="oac_no_warn" dir="ltr">LISTENER =（DESCRIPTION =（ADDRESS_LIST =（ADDRESS =（PROTOCOL = tcp）（HOST = host）（PORT = 1521））））SID_LIST_LISTENER =（SID_LIST =（SID_DESC =（SDU = 32768）（SID_NAME = sid）（GLOBALDBNAME = SRVC）（ORACLE_HOME = / ORACLE）））</pre><p>如果使用高延迟或高带宽网络链接存档到远程站点，则可以使用<code class="codeph">SQLNET.SEND_BUF_SIZE</code>和<code class="codeph">SQLNET.RECV_BUF_SIZE</code> Oracle Net配置文件参数来提高性能，以增加网络发送和接收I / O的大小缓冲区。
                  </p>
                  <p>有关更改Oracle NET SDU参数的其他方法的信息，请参阅“ <a href="../netag/optimizing-performance.html#NETAG0141" target="_blank"><span class="italic">Oracle数据库网络服务管理员指南”</span></a> 。
                  </p>
               </div>
            </div><a id="SBYDB4922"></a><div class="props_rev_3"><a id="GUID-5F933817-AD03-43D7-878D-E4B115448DAD" name="GUID-5F933817-AD03-43D7-878D-E4B115448DAD"></a><h3 id="SBYDB-GUID-5F933817-AD03-43D7-878D-E4B115448DAD" class="sect3"><span class="enumeration_section">A.8</span>备用数据库的磁盘性能较低</h3>
               <div>
                  <p>如果文件系统本身的异步I / O显示性能问题，请尝试使用Direct I / O选项安装文件系统或设置<code class="codeph">FILESYSTEMIO_OPTIONS=SETALL</code>初始化参数。
                  </p>
                  <p>最大I / O大小设置为1 MB。</p>
               </div>
            </div><a id="SBYDB4923"></a><div class="props_rev_3"><a id="GUID-82348347-C02B-4179-A325-3192E6F94737" name="GUID-82348347-C02B-4179-A325-3192E6F94737"></a><h3 id="SBYDB-GUID-82348347-C02B-4179-A325-3192E6F94737" class="sect3"><span class="enumeration_section">A。9日志文件必须匹配以避免主数据库关闭</span></h3>
               <div>
                  <p>如果已在配置中的一个或多个备用数据库上配置了备用重做日志，请确保每个备用数据库上的备用重做日志文件的大小与主数据库上的联机重做日志文件的大小完全匹配。</p>
                  <p>在日志切换时，如果没有可用的备用重做日志文件与主数据库上新的当前联机重做日志文件的大小匹配：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>如果主数据库在最大保护模式下运行，则会关闭主数据库，</p>
                        <p><span class="italic"><span class="bold">要么</span></span> 
                        </p>
                     </li>
                     <li>
                        <p>备用数据库上的RFS进程在备用数据库上创建归档重做日志文件，并在警报日志中写入以下消息：</p><pre class="oac_no_warn" dir="ltr">没有大小&lt;＃&gt;块的备用日志文件可用。
</pre></li>
                  </ul>
                  <p>例如，如果主数据库使用两个日志文件为100K的联机重做日志组，则备用数据库应具有3个备用重做日志组，日志文件大小为100K。</p>
                  <p>此外，每次将重做日志组添加到主数据库时，都必须将相应的备用重做日志组添加到备用数据库。这样可以降低对主数据库产生负面影响的可能性，因为在日志切换时，所需大小的备用重做日志文件不可用。</p>
               </div>
            </div><a id="SBYDB4924"></a><div class="props_rev_3"><a id="GUID-B1551FC6-1B9F-49A5-A462-124697A449C3" name="GUID-B1551FC6-1B9F-49A5-A462-124697A449C3"></a><h3 id="SBYDB-GUID-B1551FC6-1B9F-49A5-A462-124697A449C3" class="sect3"><span class="enumeration_section">A.10</span>对逻辑备用数据库进行故障排除</h3>
               <div>
                  <p>这些疑难解答提示可帮助您从错误中恢复。</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-1D92D18C-488C-4896-9592-33FBB4BEEAB2" title="逻辑备用数据库维护用户表，序列和作业。要维护其他对象，必须重新发出重做数据流中的DDL语句。">从错误中恢复</a></p>
                     </li>
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-0AB63229-F105-44EF-AB5E-29E19946DC2F" title="Oracle SQL * Loader提供了一种将来自不同源的数据加载到Oracle数据库中的方法。">SQL *加载程序会话疑难解答</a></p>
                     </li>
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-0C23E281-5ED2-4411-851C-B609EA1C350E" title="在SQL Apply环境中长时间运行事务的主要原因之一是全表扫描。">排除长时间运行的故障</a></p>
                     </li>
                     <li>
                        <p><a href="troubleshooting-oracle-data-guard.html#GUID-B25EE583-E622-4F0C-AA50-84582DFDD5DD" title="如果SQL Apply返回ORA-1403：No Data Found错误，则可以使用Flashback Transaction重建丢失的数据。">使用闪回事务排除ORA-1403错误</a></p>
                     </li>
                  </ul>
               </div><a id="SBYDB4925"></a><div class="props_rev_3"><a id="GUID-1D92D18C-488C-4896-9592-33FBB4BEEAB2" name="GUID-1D92D18C-488C-4896-9592-33FBB4BEEAB2"></a><h4 id="SBYDB-GUID-1D92D18C-488C-4896-9592-33FBB4BEEAB2" class="sect4"><span class="enumeration_section">A.10.1</span>从错误中恢复</h4>
                  <div>
                     <p>逻辑备用数据库维护用户表，序列和作业。要维护其他对象，必须重新发出重做数据流中的DDL语句。</p>
                     <p>如果SQL Apply失败，则会在<code class="codeph">DBA_LOGSTDBY_EVENTS</code>表中记录错误。以下部分演示了如何从两个此类错误中恢复。
                     </p>
                  </div><a id="SBYDB4926"></a><div class="props_rev_3"><a id="GUID-16CE2533-7190-4717-88E0-BDC53DBD887B" name="GUID-16CE2533-7190-4717-88E0-BDC53DBD887B"></a><h5 id="SBYDB-GUID-16CE2533-7190-4717-88E0-BDC53DBD887B" class="sect5"><span class="enumeration_section">A.10.1.1</span>包含文件规范的DDL事务</h5>
                     <div>
                        <p>DDL语句在主数据库和逻辑备用数据库上以相同的方式执行。</p>
                        <div class="section">
                           <p>如果两个数据库上的基础文件结构相同，则DDL将按预期在备用数据库上执行。</p>
                           <p>如果错误是由包含在逻辑备用数据库环境中不匹配的文件规范的DDL事务引起的，请执行以下步骤来解决问题：</p>
                        </div>
                        <!-- class="section" -->
                        <ol>
                           <li class="stepexpand"><span>使用<code class="codeph">ALTER SESSION DISABLE</code> <code class="codeph">GUARD</code>语句绕过数据库防护，以便您可以对逻辑备用数据库进行修改：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SESSION DISABLE GUARD;</pre></div>
                           </li>
                           <li class="stepexpand"><span>使用正确的文件规范执行DDL语句，然后重新启用数据库防护。例如：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; <a id="d58098e3290" class="indexterm-anchor"></a><a id="d58098e3294" class="indexterm-anchor"></a> ALTER TABLESPACE t_table ADD DATAFILE'/ dbs / t_db.f'SIZE 100M REUSE; SQL&gt; ALTER SESSION ENABLE GUARD;</pre></div>
                           </li>
                           <li class="stepexpand"><span>在逻辑备用数据库上启动SQL Apply并跳过失败的事务。</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请 - &gt; SKIP FAILED TRANSACTION;</pre></div>
                           </li>
                        </ol>
                        <div class="section">
                           <p>在某些情况下，可以纠正导致事务失败的问题，并在不跳过事务的情况下重新启动SQL Apply。例如，当可用空间耗尽时。（跳过DDL事务时，不要让主数据库和逻辑备用数据库发生分歧。如果可能，手动执行补偿交易以代替跳过的交易。）</p>
                           <p>以下示例显示SQL Apply停止，更正错误，然后重新启动SQL Apply：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SET LONG 1000 SQL&gt; ALTER SESSION SET NLS_DATE_FORMAT ='DD-MON-YY HH24：MI：SS';会话改变了。SQL&gt; SELECT EVENT_TIME，COMMIT_SCN，EVENT，STATUS FROM DBA_LOGSTDBY_EVENTS; EVENT_TIME COMMIT_SCN ------------------ --------------- EVENT -------------- -------------------------------------------------- -  -  -  -  -  -  - - 状态  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  - --------------------------------------------- 22-OCT-03 15:47:58 ORA-16111：日志挖掘和应用设置22-OCT-03 15:48:04 209627插入“SCOTT”。“EMP”值“EMPNO”= 7900，“ENAME”='ADAMS'， “JOB”='CLERK'，“MGR”为空，“HIREDATE”= TO_DATE（'22 -OCT-03'，'DD-MON-RR'），“SAL”= 950，“COMM”为空，“ DEPTNO“IS NULL ORA-01653：无法在表空间T_TABLE中将表SCOTT.EMP扩展％200字节</pre><p>在该示例中， <code class="codeph">ORA-01653</code>消息指示表空间已满并且无法自行扩展。要更正此问题，请将新数据文件添加到表空间。例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; <a id="d58098e3321" class="indexterm-anchor"></a><a id="d58098e3323" class="indexterm-anchor"></a><a id="d58098e3327" class="indexterm-anchor"></a> ALTER TABLESPACE t_table ADD DATAFILE' / dbs / t_db.f'SIZE 60M;表空间已更改。
</pre><p>然后，重新启动SQL Apply：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;数据库改变了
</pre><p>当SQL Apply重新启动时，将重新执行失败的事务并将其应用于逻辑备用数据库。</p>
                        </div>
                        <!-- class="section" -->
                     </div>
                  </div><a id="SBYDB4927"></a><div class="props_rev_3"><a id="GUID-A146A62B-550F-4520-9001-C11C043E3A64" name="GUID-A146A62B-550F-4520-9001-C11C043E3A64"></a><h5 id="SBYDB-GUID-A146A62B-550F-4520-9001-C11C043E3A64" class="sect5"><span class="enumeration_section">A.10.1.2</span>从DML故障中恢复</h5>
                     <div>
                        <p>不要使用<code class="codeph">SKIP_TRANSACTION</code>过程来过滤DML失败，因为它不仅会跳过事件表中看到的DML，还会跳过与事务关联的所有DML。
                        </p>
                        <div class="section">
                           <p>DML故障通常表示特定表存在问题。例如，假设失败是您无法立即解决的存储库内错误。以下步骤演示了一种响应此问题的方法。</p>
                        </div>
                        <!-- class="section" -->
                        <ol>
                           <li class="stepexpand"><span>通过将表添加到跳过列表来绕过表，但不绕过事务：</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_LOGSTDBY.SKIP（'DML'，'SCOTT'，'EMP'）; SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;</pre><p>从现在开始，不应用<code class="codeph">SCOTT.EMP</code>表的DML活动。纠正存储问题后，可以修复表，前提是您设置了具有管理员权限的主数据库的数据库链接，以便在<code class="codeph">DBMS_LOGSTDBY</code>包中运行过程。
                                 </p>
                              </div>
                           </li>
                           <li class="stepexpand"><span>使用指向主数据库的数据库链接，删除本地<code class="codeph">SCOTT.EMP</code>表，然后重新创建它，并将数据提取到备用数据库。</span><div><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE STOP LOGICAL STANDBY APPLY; SQL&gt; EXECUTE DBMS_LOGSTDBY.INSTANTIATE_TABLE（'SCOTT'，'EMP'，'PRIMARYDB'）; SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;</pre></div>
                           </li>
                           <li class="stepexpand"><span>要确保在新实例化的表和数据库的其余部分之间保持一致的视图，请在查询此表之前等待SQL Apply赶上主数据库。有关详细示例，请参阅<a href="managing-oracle-data-guard-logical-standby-databases.html#GUID-DD88E3D6-D6DB-4175-BB59-F048B9A87BAA" title="Typically, you use the DBMS_LOGSTDBY.INSTANTIATE_TABLE procedure to re-create a table after an unrecoverable operation.">在逻辑备用数据库</a>上<a href="managing-oracle-data-guard-logical-standby-databases.html#GUID-DD88E3D6-D6DB-4175-BB59-F048B9A87BAA" title="通常，您使用DBMS_LOGSTDBY.INSTANTIATE_TABLE过程在不可恢复的操作后重新创建表。">添加或重新创建表</a> 。</span></li>
                        </ol>
                     </div>
                  </div>
               </div><a id="SBYDB4928"></a><div class="props_rev_3"><a id="GUID-0AB63229-F105-44EF-AB5E-29E19946DC2F" name="GUID-0AB63229-F105-44EF-AB5E-29E19946DC2F"></a><h4 id="SBYDB-GUID-0AB63229-F105-44EF-AB5E-29E19946DC2F" class="sect4"><span class="enumeration_section">A.10.2</span> SQL *加载程序会话疑难解答</h4>
                  <div>
                     <p>Oracle SQL * Loader提供了一种将来自不同源的数据加载到Oracle数据库中的方法。</p>
                     <p>本主题分析SQL * Loader实用程序的一些功能，因为它与SQL Apply有关。</p>
                     <p>无论选择何种数据加载方法，SQL * Loader控制文件都包含有关如何通过<code class="codeph">APPEND</code>和<code class="codeph">REPLACE</code>的关键字对要加载新数据的Oracle表的当前内容执行操作的说明。以下示例显示如何在名为<code class="codeph">LOAD_STOK</code>的表上使用这些关键字：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>使用<code class="codeph">APPEND keyword</code> ，要加载的新数据将附加到<code class="codeph">LOAD_STOK</code>表的内容中：</p><pre class="oac_no_warn" dir="ltr">将数据加载到表LOAD_STOK APPEND</pre></li>
                        <li>
                           <p>使用<code class="codeph">REPLACE</code>关键字时， <code class="codeph">LOAD_STOK</code>表的内容将在加载新数据之前删除。Oracle SQL * Loader使用<code class="codeph">DELETE</code>语句在单个事务中清除表的内容：</p><pre class="oac_no_warn" dir="ltr">将数据加载到表LOAD_STOK REPLACE中</pre></li>
                     </ul>
                     <p>Oracle建议在加载数据之前，针对主数据库上的<code class="codeph">TRUNCATE TABLE</code>发出SQL * Plus <code class="codeph">TRUNCATE TABLE</code>命令，而不是在SQL * Loader脚本中使用<code class="codeph">REPLACE</code>关键字。这与以快速和高效的方式清除表的主数据库和备用数据库副本具有相同的效果，因为<code class="codeph">TRUNCATE TABLE</code>命令记录在联机重做日志文件中并由逻辑备用数据库上的SQL Apply发出。
                     </p>
                     <p>SQL * Loader脚本可能继续包含<code class="codeph">REPLACE</code>关键字，但它现在尝试从主数据库上的对象中<code class="codeph">DELETE</code>零行。由于没有从主数据库中删除任何行，因此重做日志文件中没有记录重做。因此，不会对逻辑备用数据库发出<code class="codeph">DELETE</code>语句。
                     </p>
                     <p>在不需要SQL语句的情况下发出<code class="codeph">REPLACE</code>关键字<code class="codeph">TRUNCATE TABLE</code>在需要将事务应用于逻辑备用数据库时为SQL Apply提供以下潜在问题。
                     </p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>如果表当前包含大量行，则需要从备用数据库中删除这些行。由于SQL Apply无法确定语句的原始语法，因此SQL Apply必须为从主数据库中清除的每一行发出<code class="codeph">DELETE</code>语句。
                           </p>
                           <p>例如，如果主数据库上的表最初有10,000行，则Oracle SQL * Loader会发出一个<code class="codeph">DELETE</code>语句来清除10,000行。在备用数据库上，SQL Apply不知道要清除所有行，而是必须发出10,000个单独的<code class="codeph">DELETE</code>语句，每个语句都清除一行。
                           </p>
                        </li>
                        <li>
                           <p>如果备用数据库上的表不包含可由SQL Apply使用的索引，则<code class="codeph">DELETE</code>语句将发出全表扫描以清除信息。
                           </p>
                           <p>继续前面的示例，因为SQL Apply已发出10,000个单独的<code class="codeph">DELETE</code>语句，这可能导致针对备用数据库发出10,000个全表扫描。
                           </p>
                        </li>
                     </ul>
                  </div>
               </div><a id="SBYDB5088"></a><a id="SBYDB5089"></a><a id="SBYDB5091"></a><a id="SBYDB5092"></a><a id="SBYDB5093"></a><a id="SBYDB4929"></a><div class="props_rev_3"><a id="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E" name="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E"></a><h4 id="SBYDB-GUID-0C23E281-5ED2-4411-851C-B609EA1C350E" class="sect4"><span class="enumeration_section">A.10.3</span>对长时间运行的事务进行故障排除</h4>
                  <div>
                     <p>在SQL Apply环境中长时间运行事务的主要原因之一是全表扫描。</p>
                     <p>此外，长时间运行的事务可能是SQL语句被复制到备用数据库的结果，例如在创建或重建索引时。</p>
                     <div class="section">
                        <p class="subhead3" id="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E__GUID-63E4BBA7-7A71-4123-BA89-DDB5393067C6">识别长时间运行的事务</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>如果SQL Apply长时间执行单个SQL语句，则会在SQL Apply实例的警报日志中报告类似于以下内容的警告消息：</p><pre class="oac_no_warn" dir="ltr">2003年2月17日星期一14:40:15警告：以下事务没有进展警告：在给定消息的最后30秒内！警告：xid = 0x0016.007.000017b6 cscn = 1550349，消息＃= 28，slavid = 1 knacrb：未找到违规会话（不是ITL压力）</pre><p>请注意有关警告消息的以下内容：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>此警告类似于为感兴趣的事务列表（ITL）压力返回的警告消息，但是以<code class="codeph">knacrb</code>开头的最后一行<code class="codeph">knacrb</code> 。最后一行表明：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>可能正在进行全表扫描</p>
                                 </li>
                                 <li>
                                    <p>此问题与感兴趣的交易清单（ITL）压力无关</p>
                                 </li>
                              </ul>
                           </li>
                           <li>
                              <p>仅当单个语句执行时间超过30秒时才会报告此警告消息。</p>
                           </li>
                        </ul>
                        <p>可能无法确定长时间运行的语句正在执行的SQL语句，但以下SQL语句可能有助于识别SQL Apply正在运行的数据库对象：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SAS.SERVER_ID  - &gt;，SS.OWNER  - &gt;，SS.OBJECT_NAME  - &gt;，SS.STATISTIC_NAME  - &gt;，SS.VALUE  - &gt; FROM V $ SEGMENT_STATISTICS SS  - &gt;，V $ LOCK L  - &gt;，V $ STREAMS_APPLY_SERVER SAS  - &gt; WHERE SAS.SERVER_ID =＆SLAVE_ID  - &gt; AND L.SID = SAS.SID  - &gt; AND L.TYPE ='TM' - &gt; AND SS.OBJ＃= L.ID1;</pre><p>此外，您可以发出以下SQL语句来标识导致每次执行时发出大量磁盘读取的SQL语句：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SUBSTR（SQL_TEXT，1,40） - &gt;，DISK_READS  - &gt;，EXECUTIONS  - &gt;，DISK_READS / EXECUTIONS  - &gt;，HASH_VALUE  - &gt;，ADDRESS  - &gt; FROM V $ SQLAREA  - &gt; WHERE DISK_READS / GREATEST（EXECUTIONS，1） &gt; 1  - &gt; AND ROWNUM &lt;10  - &gt;按DISK_READS / GREATEST（执行，1）DESC排序;</pre><p>Oracle建议所有表都定义了主键约束，这自动意味着该列被定义为<code class="codeph">NOT NULL</code> 。对于无法定义主键约束的任何表，请在定义为<code class="codeph">NOT NULL</code>的相应列上定义索引。如果表中不存在合适的列，则应检查该表，并在可能的情况下由SQL Apply跳过。以下步骤描述了如何跳过针对<code class="codeph">SCOTT</code>模式上的<code class="codeph">FTS</code>表发出的所有DML语句：</p>
                        <ol>
                           <li>
                              <p>停止SQL应用：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE STOP LOGICAL STANDBY APPLY;数据库改变了</pre></li>
                           <li>
                              <p>为所有DML事务配置<code class="codeph">SCOTT.FTS</code>表的跳过过程：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; EXECUTE DBMS_LOGSTDBY.SKIP（stmt =&gt;'DML'， - &gt; schema_name =&gt;'SCOTT'， - &gt; object_name =&gt;'FTS'）; PL / SQL过程成功完成</pre></li>
                           <li>
                              <p>启动SQL Apply：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;数据库改变了</pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E__GUID-E29F181A-1263-4EA0-B736-910DBE293ECB">ITL压力故障排除</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>在SQL Apply实例的警报日志中报告感兴趣的事务列表（ITL）压力。以下显示了警告消息的示例。</p><pre class="oac_no_warn" dir="ltr">Tue Apr 22 15:50:42 2003警告：以下事务没有进展警告：在给定消息的最后30秒内！警告：xid = 0x0006.005.000029fa cscn = 2152982，消息＃= 2，slavid = 17</pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E__GUID-2F5B37CF-D061-4498-B18C-C5E21E40C7F7">实时分析</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>上面输出中显示的消息表明SQL Apply进程（ <code class="codeph">slavid</code> ）＃17在过去30秒内没有取得任何进展。要确定Apply进程发出的SQL语句，请发出以下查询：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SA.SQL_TEXT  - &gt; FROM V $ SQLAREA SA  - &gt;，V $ SESSION S  - &gt;，V $ STREAMS_APPLY_SERVER SAS  - &gt; WHERE SAS.SERVER_ID =＆SLAVEID  - &gt; AND S.SID = SAS.SID  - &gt; AND SA。 ADDRESS = S.SQL_ADDRESS SQL_TEXT -------------------------------------------- ----------------插入“APP”。“LOAD_TAB_1”p（“PK”，“TEXT”）值（：1，：2）</pre><p>识别ITL压力的另一种方法是查询<code class="codeph">V$LOCK</code>视图，如以下示例所示。任何在<code class="codeph">TX</code>锁上请求值为4的会话正在等待ITL变为可用。
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT SID，TYPE，ID1，ID2，LMODE，REQUEST  - &gt; FROM V $ LOCK  - &gt; WHERE TYPE ='TX'SID TY ID1 ID2 LMODE REQUEST ----------  -  ---- ------ ---------- ---------- ---------- 8 TX 327688 48 6 0 10 TX 327688 48 0 4</pre><p>在该示例中， <code class="codeph">SID 10</code>正在等待<code class="codeph">SID 8</code>保持的<code class="codeph">TX</code>锁定。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E__GUID-6D90F34F-5EF9-440E-8F32-B4885586A57B">事故后审查</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>分部ITL的压力不太可能持续很长一段时间。此外，备用数据库警报日志中不会报告持续时间少于30秒的ITL压力。因此，要确定哪些对象受到ITL压力，请发出以下声明：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; SELECT OWNER，OBJECT_NAME，OBJECT_TYPE  - &gt; FROM V $ SEGMENT_STATISTICS  - &gt; WHERE STATISTIC_NAME ='ITL等待' - &gt; AND VALUE&gt; 0  - &gt; ORDER BY VALUE;</pre><p>此语句报告自上次启动实例以来在某个时间内具有ITL压力的所有数据库段。</p>
                        <div class="infoboxnote" id="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E__GUID-77DCB093-F8D8-42C6-AB03-3D8F7AACC1A8">
                           <p class="notep1">注意：</p>
                           <p>此SQL语句不限于Oracle Data Guard环境中的逻辑备用数据库。它适用于任何Oracle数据库。</p>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E__GUID-3E5573C0-38F5-4CAC-A5B4-7E86C15E5BF6">解决ITL压力</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>要增加特定数据库对象的<code class="codeph">INITRANS</code>整数，必须先停止SQL Apply。
                        </p>
                        <div class="infoboxnotealso" id="GUID-0C23E281-5ED2-4411-851C-B609EA1C350E__GUID-8F389FAA-0AD0-442D-803C-697AAFB05332">
                           <p class="notep1">也可以看看：</p>
                           <p>有关指定<code class="codeph">INITRANS</code>整数的更多信息，请<code class="codeph">INITRANS</code> <a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/sbydb&amp;id=SQLRF52296" target="_blank"><span class="italic">Oracle数据库SQL语言参考</span></a> ，该整数是分配给数据库对象的每个数据块中分配的初始并发事务条目数</p>
                        </div>
                        <p>以下示例显示了在架构<code class="codeph">app</code>增加表<code class="codeph">load_tab_1</code>的<code class="codeph">INITRANS</code>的必要步骤。
                        </p>
                        <ol>
                           <li>
                              <p>停止SQL应用：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE STOP LOGICAL STANDBY APPLY;数据库改变了
</pre></li>
                           <li>
                              <p>暂时绕过数据库防护：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SESSION DISABLE GUARD;会话改变了。
</pre></li>
                           <li>
                              <p>增加备用数据库上的<code class="codeph">INITRANS</code> 。例如：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER TABLE APP.LOAD_TAB_1 INITRANS 30;表改变了</pre></li>
                           <li>
                              <p>重新启用数据库防护：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER SESSION ENABLE GUARD;会话改变了</pre></li>
                           <li>
                              <p>启动SQL Apply：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;数据库改变了
</pre></li>
                        </ol>
                        <p>另外，请考虑修改主数据库上的数据库对象，以便在切换时，新备用数据库上不会发生错误。</p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="SBYDB5094"></a><a id="SBYDB5095"></a><a id="SBYDB4930"></a><div class="props_rev_3"><a id="GUID-B25EE583-E622-4F0C-AA50-84582DFDD5DD" name="GUID-B25EE583-E622-4F0C-AA50-84582DFDD5DD"></a><h4 id="SBYDB-GUID-B25EE583-E622-4F0C-AA50-84582DFDD5DD" class="sect4"><span class="enumeration_section">A.10.4</span>使用闪回事务排除ORA-1403错误</h4>
                  <div>
                     <p>如果SQL Apply返回<code class="codeph">ORA-1403: No Data Found</code>错误，则可以使用Flashback Transaction重建丢失的数据。
                     </p>
                     <p>此策略依赖于备用数据库实例上指定的<code class="codeph">UNDO_RETENTION</code>初始化参数。
                     </p>
                     <p>在正常情况下，在逻辑备用数据库环境中看不到<code class="codeph">ORA-1403</code>错误。当直接在备用数据库上修改由SQL Apply管理的表中的数据，然后在主数据库上修改相同的数据时，会发生此错误。当修改的数据在主数据库上更新并随后在逻辑备用数据库上接收时，SQL Apply将在更新记录之前验证备用数据库上是否存在数据的原始版本。当此验证失败时，将返回<code class="codeph">ORA-1403: No Data Found</code>错误。
                     </p>
                     <div class="section">
                        <p class="subhead3" id="GUID-B25EE583-E622-4F0C-AA50-84582DFDD5DD__GUID-3DD3D17C-AFB2-49B0-9E61-4B6CD7EB0DBA">初始错误</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>当SQL Apply验证失败时，将在逻辑备用数据库的警报日志中报告错误消息，并在<code class="codeph">DBA_LOGSTDBY_EVENTS</code>视图中插入记录。警报日志中的信息将被截断，而错误将在数据库视图中完整报告。例如：</p><pre class="oac_no_warn" dir="ltr">LOGSTDBY stmt：UPDATE“SCOTT”。“MASTER”SET“NAME”='john'WHERE“PK”= 1且“NAME”='andrew'和ROWID ='AAAAAAAAEAAAAAPAAA'STOGSTDBY状态：ORA-01403：未找到数据LOGSTDBY PID 1006，oracle @ staco03（P004）LOGSTDBY XID 0x0006.00e.00000417，线程1，RBA 0x02dd.00002221.10</pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-B25EE583-E622-4F0C-AA50-84582DFDD5DD__GUID-000D9C0B-F852-43FA-86E8-F39CC5C2C481">调查</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>第一步是分析导致错误的表的历史数据。这可以使用<code class="codeph">SELECT</code>语句的<code class="codeph">VERSIONS</code>子句来实现。例如，您可以在主数据库上发出以下查询：</p><pre class="oac_no_warn" dir="ltr">选择VERSIONS_XID，VERSIONS_STARTSCN，VERSIONS_ENDSCN，VERSIONS_OPERATION，PK，NAME SCN.MASTER版本SCN MINVALUE和MAXVALUE之间PK = 1按NVL排序（VERSIONS_STARTSCN，0）; VERSIONS_XID VERSIONS_STARTSCN VERSIONS_ENDSCN V PK NAME ---------------- ----------------- ----------- ------ --- ------- 03001900EE070000 3492279 3492290 I 1 andrew 02000D00E4070000 3492290 D 1 andrew</pre><p>根据数据库配置为保留的撤消保留量（ <code class="codeph">UNDO_RETENTION</code> ）和表上的活动，返回的信息可能很广泛，您可能需要更改语法之间的版本以限制返回的信息量。根据返回的信息，您可以看到该记录首先插入SCN 3492279，然后作为事务ID 02000D00E4070000的一部分在SCN 3492290中删除。使用事务ID，查询数据库以查找事务的范围。这是通过查询<code class="codeph">FLASHBACK_TRANSACTION_QUERY</code>视图来实现的。
                        </p><pre class="oac_no_warn" dir="ltr">SELECT OPERATION，UNDO_SQL FROM FLASHBACK_TRANSACTION_QUERY WHERE XID = HEXTORAW（'02000D00E4070000'）;操作UNDO_SQL ---------- -------------------------------------- ----------删除插入“SCOTT”。“MASTER”（“PK”，“NAME”）值（'1'，'andrew'）;开始</pre><p>始终返回一行代表事务的开始。在此事务中，主表中只删除了一行。<code class="codeph">UNDO_SQL</code>列在执行时会将原始数据恢复到表中。
                        </p><pre class="oac_no_warn" dir="ltr">SQL&gt; INSERT INTO“SCOTT”。“MASTER”（“PK”，“NAME”）VALUES（'1'，'ANDREW'）; SQL&gt; COMMIT;</pre><p>重新启动SQL Apply时，事务将应用于备用数据库：</p><pre class="oac_no_warn" dir="ltr">SQL&gt; ALTER DATABASE START LOGICAL STANDBY立即申请;</pre></div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>