<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <title>分布式事务</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="JDBC Developer&#39;s Guide"></meta>
      <meta property="og:description" content=""></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="JDBC Developer&#39;s Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="jdbc-developers-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-02-13T13:20:37-08:00"></meta>
      <meta name="dcterms.title" content="JDBC Developer&#39;s Guide"></meta>
      <meta name="dcterms.dateCopyrighted" content="1999, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96471-02"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="transaction-management.html" title="Previous" type="text/html"></link>
      <link rel="next" href="manageability.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="JJDBC"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="transaction-management.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="manageability.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">JDBC开发人员指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="transaction-management.html" property="item" typeof="WebPage"><span property="name">交易管理</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">分布式事务</li>
            </ol>
            <a id="GUID-FD21627C-0183-4AF3-8719-8490F069A41E" name="GUID-FD21627C-0183-4AF3-8719-8490F069A41E"></a><a id="JJDBC28000"></a>
            
            <h2 id="JJDBC-GUID-FD21627C-0183-4AF3-8719-8490F069A41E" class="sect2"><span class="enumeration_chapter">33</span>分布式事务</h2>
         </header>
         <div class="ind">
            <div>
               <p>本章讨论分布式事务的Oracle Java数据库连接（JDBC）实现。这些是多阶段事务，通常使用多个数据库，必须以协调的方式提交。对于分布式事务，还有一个相关的XA讨论，它是一个通用标准，而不是Java特有的。</p>
               <p>讨论了以下主题：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="distributed-transactions.html#GUID-78C5DAB6-46E5-44A4-9EC8-1149FDA176AB">关于分布式交易</a></p>
                  </li>
                  <li>
                     <p><a href="distributed-transactions.html#GUID-178456B8-4C4E-43BB-9097-DF2F269513CB">XA组件</a></p>
                  </li>
                  <li>
                     <p><a href="distributed-transactions.html#GUID-EAB7ACFA-5708-4608-B94D-0D9ECE391D67">错误处理和优化</a></p>
                  </li>
                  <li>
                     <p><a href="distributed-transactions.html#GUID-A1736524-8CB5-4965-89E3-C65C3861E784">关于实现分布式事务</a></p>
                  </li>
                  <li>
                     <p><a href="distributed-transactions.html#GUID-1EF2D070-305D-49D9-9124-16FFDF7CCF74">Oracle JDBC驱动程序中的Native-XA</a></p>
                  </li>
               </ul>
               <div class="infoboxnote" id="GUID-FD21627C-0183-4AF3-8719-8490F069A41E__GUID-91D5AE93-7677-4312-838E-BF70C3A367DE">
                  <p class="notep1">注意：</p>
                  <p>本章讨论JDBC 2.0可选包的功能，以前称为通过<code class="codeph">javax</code>包提供的JDBC 2.0标准扩展应用程序编程接口（API）。
                  </p>
               </div>
               <p>有关分布式事务的更多介绍性和一般信息，请参阅JDBC 2.0可选包和Java Transaction API（JTA）的规范。</p>
            </div><a id="JJDBC28843"></a><div class="props_rev_3"><a id="GUID-78C5DAB6-46E5-44A4-9EC8-1149FDA176AB" name="GUID-78C5DAB6-46E5-44A4-9EC8-1149FDA176AB"></a><h3 id="JJDBC-GUID-78C5DAB6-46E5-44A4-9EC8-1149FDA176AB" class="sect3"><span class="enumeration_section">33.1</span>关于分布式事务</h3>
               <div>
                  <p>该部分包括以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="distributed-transactions.html#GUID-ECD0D367-582D-40F1-99E9-D76ABA451B23">分布式事务概述</a></p>
                     </li>
                     <li>
                        <p><a href="distributed-transactions.html#GUID-1E5899A5-1977-4B25-A98A-B9AC0837EADF">分布式事务组件和方案</a></p>
                     </li>
                     <li>
                        <p><a href="distributed-transactions.html#GUID-D80FEF14-8360-4E0A-B950-AA5B56E98DE8">分布式事务概念</a></p>
                     </li>
                     <li>
                        <p><a href="distributed-transactions.html#GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17">关于在全局和本地事务之间切换</a></p>
                     </li>
                     <li>
                        <p><a href="distributed-transactions.html#GUID-B5EBFDDD-5A19-43C8-A2B7-6838F752800E">Oracle XA包</a></p>
                     </li>
                  </ul>
               </div>
               <div class="props_rev_3"><a id="GUID-ECD0D367-582D-40F1-99E9-D76ABA451B23" name="GUID-ECD0D367-582D-40F1-99E9-D76ABA451B23"></a><h4 id="JJDBC-GUID-ECD0D367-582D-40F1-99E9-D76ABA451B23" class="sect4"><span class="enumeration_section">33.1.1</span>分布式事务概述</h4>
                  <div>
                     <p><span class="bold">分布式事务</span> （有时称为<span class="bold">全局事务</span> ）是一组必须以协调方式管理的两个或多个相关事务。构成分布式事务的事务可能位于同一数据库中，但更常见的是位于不同的数据库中，并且通常位于不同的位置。分布式事务的每个单独事务称为<span class="bold">事务分支</span> 。
                     </p>
                     <p>例如，分布式交易可能包括从一个银行的账户转移到另一个银行的账户的钱。您不希望任何事务提交，而不保证两者都将成功完成。</p>
                     <p>在JDBC中，分布式事务功能构建在连接池功能之上。此分布式事务功能也基于分布式事务的开放XA标准构建。X A是X / Open标准的一部分，并不是特定于Java的。
                     </p>
                     <p>JDBC用于连接数据库资源。但是，要在事务中包含对多个数据库的所有更改，必须在JTA全局事务中使用JDBC连接。在事务中包含数据库SQL更新的过程称为登记数据库资源。</p>
                  </div>
               </div><a id="JJDBC28844"></a><div class="props_rev_3"><a id="GUID-1E5899A5-1977-4B25-A98A-B9AC0837EADF" name="GUID-1E5899A5-1977-4B25-A98A-B9AC0837EADF"></a><h4 id="JJDBC-GUID-1E5899A5-1977-4B25-A98A-B9AC0837EADF" class="sect4"><span class="enumeration_section">33.1.2</span>分布式事务组件和方案</h4>
                  <div>
                     <div class="section">
                        <p>在阅读分布式事务部分的其余部分时，请牢记以下几点：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>分布式事务系统通常依赖于外部事务管理器，例如实现标准JTA功能的软件组件，以协调各个事务。
                              </p>
                              <p>许多供应商都提供符合XA标准的JTA模块，包括Oracle，其中包括Oracle9 <span class="italic">i</span> Application Server和Oracle Application Server 10 <span class="italic">g中的</span> JTA。
                              </p>
                           </li>
                           <li>
                              <p>XA功能通常与客户端应用程序隔离，而是在中间层环境（例如应用程序服务器）中实现。</p>
                              <p>在许多情况下，应用程序服务器和事务管理器将在中间层上，也可能与一些应用程序代码一起。</p>
                           </li>
                           <li>
                              <p>本节中的讨论主要针对中层开发人员。</p>
                           </li>
                           <li>
                              <p>术语资源管理器通常用于讨论分布式事务。资源管理器只是管理数据或其他类型资源的实体。无论在本章中使用哪个术语，它都指的是数据库。
                              </p>
                              <div class="infoboxnote" id="GUID-1E5899A5-1977-4B25-A98A-B9AC0837EADF__GUID-7B743D14-3A5F-4F39-9B41-EBBC30EBB2E5">
                                 <p class="notep1">注意：</p>
                                 <p>使用JTA功能需要<code class="codeph">jta.jar</code>位于<code class="codeph">CLASSPATH</code>环境变量中。该文件位于<span class="italic"><code class="codeph">ORACLE_HOME</code></span> <code class="codeph">/jlib</code> 。Oracle将此文件包含在JDBC产品中。
                                 </p>
                              </div>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28845"></a><div class="props_rev_3"><a id="GUID-D80FEF14-8360-4E0A-B950-AA5B56E98DE8" name="GUID-D80FEF14-8360-4E0A-B950-AA5B56E98DE8"></a><h4 id="JJDBC-GUID-D80FEF14-8360-4E0A-B950-AA5B56E98DE8" class="sect4"><span class="enumeration_section">33.1.3</span>分布式事务概念</h4>
                  <div>
                     <div class="section">
                        <p>使用XA功能时，事务管理器使用XA资源实例来准备和协调每个事务分支，然后适当地提交或回滚所有事务分支。</p>
                        <p>XA功能包括以下关键组件：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>XA <a id="d80952e276" class="indexterm-anchor"></a>数据源</p>
                              <p>这些是连接池数据源和其他数据源的扩展，在概念和功能上类似。</p>
                              <p>将在分布式事务中使用的每个资源管理器将有一个XA数据源实例。您通常会在中间层软件中创建XA数据源实例。</p>
                              <p>XA数据源生成XA连接。</p>
                           </li>
                           <li>
                              <p>XA连接</p>
                              <p>这些是池化连接的扩展，在概念和功能上类似。XA连接封装了物理数据库连接。各个连接实例是这些物理连接的临时句柄。</p>
                              <p>XA连接实例对应于单个Oracle会话，尽管会话可以由多个逻辑连接实例按顺序使用，与池化连接实例一样。</p>
                              <p>您通常会从中间层软件中的XA数据源实例获取XA连接实例。如果分布式事务涉及同一数据库中的多个会话，则可以从单个XA数据源实例获取多个XA连接实例。</p>
                              <p>XA连接生成<code class="codeph">OracleXAResource</code>实例和JDBC连接实例。
                              </p>
                           </li>
                           <li>
                              <p>XA资源</p>
                              <p>这些由事务管理器用于协调分布式事务的事务分支。</p>
                              <p>您将从每个XA连接实例获得一个<code class="codeph">OracleXAResource</code>实例，通常在您的中间层软件中。<code class="codeph">OracleXAResource</code>实例与XA连接实例之间<code class="codeph">OracleXAResource</code>一对一的关联。同样， <code class="codeph">OracleXAResource</code>实例与Oracle会话之间<code class="codeph">OracleXAResource</code>一对一的关联。
                              </p>
                              <p>在典型情况下，中间层组件会将<code class="codeph">OracleXAResource</code>实例<code class="codeph">OracleXAResource</code>给事务管理器，以用于协调分布式事务。
                              </p>
                              <p>每个<code class="codeph">OracleXAResource</code>实例对应一个Oracle会话。因此，在任何给定时间，只能有一个与<code class="codeph">OracleXAResource</code>实例关联的活动事务分支。但是，可以有其他暂停的事务分支。
                              </p>
                              <p>每个<code class="codeph">OracleXAResource</code>实例都具有启动，结束，准备，提交或回滚与<code class="codeph">OracleXAResource</code>实例关联的会话中运行的事务分支的操作的功能。
                              </p>
                              <p>准备步骤是两阶段提交操作的第一步。事务管理器将为每个<code class="codeph">OracleXAResource</code>实例发出<code class="codeph">PREPARE</code> 。一旦事务管理器发现每个事务分支的操作已成功准备，它将向每个<code class="codeph">OracleXAResource</code>实例发出<code class="codeph">COMMIT</code>以提交所有更改。
                              </p>
                           </li>
                           <li>
                              <p>交易ID</p>
                              <p>这些用于标识事务分支。每个ID包括事务分支ID组件和分布式事务ID组件。这是分支与分布式事务关联的方式。与给定分布式事务关联的所有<code class="codeph">OracleXAResource</code>实例都将具有包含相同分布式事务ID组件的事务ID。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">OracleXAResource。ORATRANSLOOSE</code></p>
                              <p>使用事务ID <code class="codeph">xid</code>启动松散耦合的事务。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28847"></a><a id="JJDBC28848"></a><a id="JJDBC28846"></a><div class="props_rev_3"><a id="GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17" name="GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17"></a><h4 id="JJDBC-GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17" class="sect4"><span class="enumeration_section">33.1.4</span>关于全局和本地事务之间的切换</h4>
                  <div>
                     <div class="section">
                        <p><a id="d80952e408" class="indexterm-anchor"></a>应用程序可以共享本地和全局事务之间的连接应用程序还可以在本地事务和全局事务之间切换连接。
                        </p>
                        <p>连接始终处于以下模式之一：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">NO_TXN</code></p>
                              <p>没有事务正在使用此连接。</p>
                           </li>
                           <li>
                              <p><code class="codeph">LOCAL_TXN</code></p>
                              <p>关闭或禁用自动提交的本地事务正在使用此连接。</p>
                           </li>
                           <li>
                              <p><code class="codeph">GLOBAL_TXN</code></p>
                              <p>全局事务正在使用此连接。</p>
                           </li>
                        </ul>
                        <p>每个连接在这些模式之间自动切换，具体取决于连接上执行的操作。实例化时，连接始终处于<code class="codeph">NO_TXN</code>模式。
                        </p>
                        <div class="infoboxnote" id="GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17__GUID-51AEDDA8-8DFC-4A24-8C5C-79DE922987B7">
                           <p class="notep1">注意：</p>
                           <p>这些模式由JDBC驱动程序内部维护，与Oracle数据库相关联。</p>
                        </div>
                        <p><a href="distributed-transactions.html#GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17__CHDGEBDI" title="表">表33-1</a>介绍了连接模式转换规则。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="tblformal" id="GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17__CHDGEBDI">
                        <p class="titleintable">表33-1连接模式转换</p>
                        <table cellpadding="4" cellspacing="0" class="Formal" title="连接模式转换" width="100%" border="1" summary="table" frame="hsides" rules="rows">
                           <thead>
                              <tr align="left" valign="top">
                                 <th align="left" valign="bottom" width="20%" id="d80952e460">当前模式</th>
                                 <th align="left" valign="bottom" width="27%" id="d80952e463">切换到NO_TXN时</th>
                                 <th align="left" valign="bottom" width="25%" id="d80952e468">切换到LOCAL_TXN时</th>
                                 <th align="left" valign="bottom" width="28%" id="d80952e471">切换到GLOBAL_TXN时</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="20%" id="d80952e476" headers="d80952e460 ">
                                    <p><code class="codeph">NO_TXN</code></p>
                                 </td>
                                 <td align="left" valign="top" width="27%" headers="d80952e476 d80952e463 ">
                                    <p>NA</p>
                                 </td>
                                 <td align="left" valign="top" width="25%" headers="d80952e476 d80952e468 ">
                                    <p>自动提交模式为false，并运行Oracle数据操作语言（DML）语句。</p>
                                 </td>
                                 <td align="left" valign="top" width="28%" headers="d80952e476 d80952e471 ">
                                    <p>在从提供当前连接的<code class="codeph">XAconnection</code>获取的<code class="codeph">XAResource</code>上调用<code class="codeph">start</code>方法。
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="20%" id="d80952e499" headers="d80952e460 ">
                                    <p><code class="codeph">LOCAL_TXN</code></p>
                                 </td>
                                 <td align="left" valign="top" width="27%" headers="d80952e499 d80952e463 ">
                                    <p>发生以下任何一种情况：</p>
                                    <ul style="list-style-type:disc">
                                       <li>
                                          <p>运行Oracle数据定义语言（DDL）语句。</p>
                                       </li>
                                       <li>
                                          <p><code class="codeph">commit</code>被调用。
                                          </p>
                                       </li>
                                       <li>
                                          <p>调用<code class="codeph">rollback</code> ，但没有参数。
                                          </p>
                                       </li>
                                    </ul>
                                 </td>
                                 <td align="left" valign="top" width="25%" headers="d80952e499 d80952e468 ">
                                    <p>NA</p>
                                 </td>
                                 <td align="left" valign="top" width="28%" headers="d80952e499 d80952e471 ">
                                    <p>在从提供当前连接的<code class="codeph">XAconnection</code>获取的<code class="codeph">XAResource</code>上调用<code class="codeph">start</code>方法。从Oracle Database 12 <span class="italic">c</span>第1版（12.1.0.2）开始提供此功能。
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="20%" id="d80952e539" headers="d80952e460 ">
                                    <p><code class="codeph">GLOBAL_TXN</code></p>
                                 </td>
                                 <td align="left" valign="top" width="27%" headers="d80952e539 d80952e463 ">
                                    <p>在此连接上打开的全局事务中，在从提供此连接的<code class="codeph">XAconnection</code>获取的<code class="codeph">XAResource</code>上调用<code class="codeph">end</code> 。
                                    </p>
                                 </td>
                                 <td align="left" valign="top" width="25%" headers="d80952e539 d80952e468 ">
                                    <p>决不</p>
                                 </td>
                                 <td align="left" valign="top" width="28%" headers="d80952e539 d80952e471 ">
                                    <p>NA</p>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                     <!-- class="inftblhruleinformal" -->
                     <div class="section">
                        <p>如果这些规则都不适用，则模式不会更改。</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17__GUID-0BE039EC-D760-467A-9AAC-E900145458EA">操作的模式限制</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>当前连接模式限制哪些操作在事务中有效。</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>在<code class="codeph">LOCAL_TXN</code>模式下，应用程序不得在<code class="codeph">XAResource</code>上调用<code class="codeph">prepare</code> ， <code class="codeph">commit</code> ， <code class="codeph">rollback</code> ， <code class="codeph">forget</code>或<code class="codeph">end</code> 。这样做会导致抛出<code class="codeph">XAException</code> 。
                              </p>
                           </li>
                           <li>
                              <p>在<code class="codeph">GLOBAL_TXN</code>模式下，应用程序不得在<code class="codeph">java.sql.上调用<code class="codeph">commit</code> ， <code class="codeph">rollback</code> ， <code class="codeph">rollback(Savepoint)</code> ， <code class="codeph">setAutoCommit(true)</code>或<code class="codeph">setSavepoint</code> <code class="codeph">java.sql.Connection</code> ，不得在<code class="codeph">oracle.jdbc.上调用<code class="codeph">OracleSetSavepoint</code>或<code class="codeph">oracleRollback</code> <code class="codeph">oracle.jdbc.OracleConnection</code> 。这样做会导致<code class="codeph">SQLException</code> 。
                              </p>
                              <div class="infoboxnote" id="GUID-C6290011-D20A-41BD-9FA5-FEDBCD9B4F17__GUID-B0E41C1E-FDAF-45F2-9BCE-0E5DB459BB89">
                                 <p class="notep1">注意：</p>
                                 <p>此模式限制错误检查是对事务和保存点API的标准错误检查的补充。</p>
                              </div>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28849"></a><div class="props_rev_3"><a id="GUID-B5EBFDDD-5A19-43C8-A2B7-6838F752800E" name="GUID-B5EBFDDD-5A19-43C8-A2B7-6838F752800E"></a><h4 id="JJDBC-GUID-B5EBFDDD-5A19-43C8-A2B7-6838F752800E" class="sect4"><span class="enumeration_section">33.1.5</span> Oracle XA包</h4>
                  <div>
                     <div class="section">
                        <p>Oracle提供以下三个包，这些包具有根据XA标准实现分布式事务功能的类：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">oracle.jdbc.xa</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">oracle.jdbc.xa.client</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">oracle.jdbc.xa.server</code></p>
                           </li>
                        </ul>
                        <p>XA数据源，XA连接和XA资源的类都在<code class="codeph">client</code>软件包和<code class="codeph">server</code>软件包中。每个的抽象类都在顶级包中。<code class="codeph">OracleXid</code>和<code class="codeph">OracleXAException</code>类位于顶级<code class="codeph">oracle.jdbc.xa</code>包中，因为它们的功能不依赖于代码的运行位置。
                        </p>
                        <p>在中间层方案中，您将导入<code class="codeph">OracleXid</code> ， <code class="codeph">OracleXAException</code>和<code class="codeph">oracle.jdbc.xa.client</code>包。
                        </p>
                        <p>但是，如果您打算在目标Oracle数据库中运行XA代码，则将导入<code class="codeph">oracle.jdbc.xa.server</code>包而不是<code class="codeph">client</code>包。
                        </p>
                        <p>如果将在目标数据库中运行的代码也必须访问远程数据库，则不要导入任何包。相反，您必须完全限定从<code class="codeph">client</code>程序包使用的任何类的名称以访问远程数据库或从<code class="codeph">server</code>程序包访问本地数据库。类名在这些包之间重复。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="JJDBC28850"></a><div class="props_rev_3"><a id="GUID-178456B8-4C4E-43BB-9097-DF2F269513CB" name="GUID-178456B8-4C4E-43BB-9097-DF2F269513CB"></a><h3 id="JJDBC-GUID-178456B8-4C4E-43BB-9097-DF2F269513CB" class="sect3"><span class="enumeration_section">33.2</span> XA组件</h3>
               <div>
                  <div class="section">
                     <p>本节讨论XA组件，即JDBC标准中指定的标准XA接口，以及实现它们的Oracle类。涵盖以下主题：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="distributed-transactions.html#GUID-0600DB23-5DBF-4729-AB20-EDBE71EC6CCB">XADatasource接口和Oracle实现</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-03941C0D-32EF-49E6-934B-6EB080C5A64D">XAConnection接口和Oracle实现</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-F7013AB7-8F57-4260-A0F6-E7EAEDFBC063">XAResource接口和Oracle实现</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-CD752E5A-309E-440A-A711-71083DD5B6A6">OracleXAResource方法功能和输入参数</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-4FE2BFF4-9F22-4752-B571-B44D6F220BDC">Xid接口和Oracle实现</a></p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div><a id="JJDBC28851"></a><div class="props_rev_3"><a id="GUID-0600DB23-5DBF-4729-AB20-EDBE71EC6CCB" name="GUID-0600DB23-5DBF-4729-AB20-EDBE71EC6CCB"></a><h4 id="JJDBC-GUID-0600DB23-5DBF-4729-AB20-EDBE71EC6CCB" class="sect4"><span class="enumeration_section">33.2.1</span> XADatasource接口和Oracle实现</h4>
                  <div>
                     <div class="section">
                        <p><code class="codeph">javax.sql.XADataSource</code>接口概述了XA数据源的标准功能，XA数据源是XA连接的工厂。重载的<code class="codeph">getXAConnection</code>方法返回一个XA连接实例，并可选择将用户名和密码作为输入：</p><pre class="oac_no_warn" dir="ltr">公共接口XADataSource {XAConnection getXAConnection（）抛出SQLException; XAConnection getXAConnection（String user，String password）抛出SQLException; ...}</pre><p>Oracle JDBC使用<code class="codeph">OracleXADataSource</code>类实现<code class="codeph">XADataSource</code>接口，该类位于<code class="codeph">oracle.jdbc.xa.client package</code>和<code class="codeph">oracle.jdbc.xa.server</code>包中。
                        </p>
                        <p><code class="codeph">OracleXADataSource</code>类还扩展了<code class="codeph">OracleConnectionPoolDataSource</code>类，该类扩展了<code class="codeph">OracleDataSource</code>类，因此包括所有连接属性。
                        </p>
                        <p><code class="codeph">OracleXADataSource</code>类的<code class="codeph">getXAConnection</code>方法返回XA连接实例的Oracle实现，这些实例是<code class="codeph">OracleXAConnection</code>实例。
                        </p>
                        <div class="infoboxnote" id="GUID-0600DB23-5DBF-4729-AB20-EDBE71EC6CCB__GUID-2771AC67-E5A5-40E5-ACE1-A9EB2F90FFED">
                           <p class="notep1">注意：</p>
                           <p>您可以使用与前面讨论的非池化数据源相同的命名约定，在Java命名目录和接口（JNDI）中注册XA数据源。</p>
                        </div>
                        <div class="infoboxnotealso" id="GUID-0600DB23-5DBF-4729-AB20-EDBE71EC6CCB__GUID-D7E220D5-B021-4FB3-958D-B83FC8FB2B97">
                           <p class="notep1">也可以看看：</p>
                           <p>有关快速连接故障转移的信息，请参阅<a href="../jjucp/fast-connection-failover.html#JJUCP08100" target="_blank"><span class="italic">“JDBC开发人员指南的Oracle通用连接池”</span></a> 。
                           </p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28852"></a><div class="props_rev_3"><a id="GUID-03941C0D-32EF-49E6-934B-6EB080C5A64D" name="GUID-03941C0D-32EF-49E6-934B-6EB080C5A64D"></a><h4 id="JJDBC-GUID-03941C0D-32EF-49E6-934B-6EB080C5A64D" class="sect4"><span class="enumeration_section">33.2.2</span> XAConnection接口和Oracle实现</h4>
                  <div>
                     <div class="section">
                        <p>与池化连接实例一样，XA连接实例封装了与数据库的物理连接。这将是在生成XA连接实例的XA数据源实例的连接属性中指定的数据库。</p>
                        <p>每个XA连接实例还具有生成<code class="codeph">OracleXAResource</code>实例的功能，该实例将与其对应，以用于协调分布式事务。
                        </p>
                        <p>XA连接实例是实现标准<code class="codeph">javax.sql.的类的实例<code class="codeph">javax.sql.XAConnection</code>接口：</p><pre class="oac_no_warn" dir="ltr">公共接口XAConnection扩展了PooledConnection {javax.jta.xa。XAResource getXAResource（）抛出SQLException; }</pre><p>如您所见， <code class="codeph">XAConnection</code>接口扩展了<code class="codeph">javax.sql.PooledConnection</code>接口，因此它还包括<code class="codeph">getConnection</code> ， <code class="codeph">close</code> ， <code class="codeph">addConnectionEventListener</code>和<code class="codeph">removeConnectionEventListener</code>方法。
                        </p>
                        <p>Oracle JDBC使用<code class="codeph">OracleXAConnection</code>类实现<code class="codeph">XAConnection</code>接口，该类位于<code class="codeph">oracle.jdbc.xa.client package</code>和<code class="codeph">oracle.jdbc.xa.server</code>包中。
                        </p>
                        <p><code class="codeph">OracleXAConnection</code>类还扩展了<code class="codeph">OraclePooledConnection</code>类。
                        </p>
                        <p><code class="codeph">OracleXAConnection</code>类<code class="codeph">getXAResource</code>方法返回<code class="codeph">OracleXAResource</code>实例的Oracle实现，该实例是<code class="codeph">OracleXAResource</code>实例。<code class="codeph">getConnection</code>方法返回<code class="codeph">OracleConnection</code>实例。
                        </p>
                        <p>XA连接实例返回的JDBC连接实例充当物理连接的临时句柄，而不是封装物理连接。物理连接由XA连接实例封装。从<code class="codeph">XAConnection</code>对象获取的连接的行为与常规连接完全相同，直到它参与全局事务。那时，自动提交状态设置为<code class="codeph">false</code> 。全局事务结束后，自动提交状态将返回到全局事务之前的值。在Oracle Database <span class="italic">10g</span>之前的所有版本中，从<code class="codeph">XAConnection</code>获取的连接上的默认自动提交状态为<code class="codeph">false</code> 。从Oracle Database 10 <span class="italic">g开始</span> ，默认状态为<code class="codeph">true</code> 。
                        </p>
                        <p>每次调用XA连接实例<code class="codeph">getConnection</code>方法时，它都会返回一个展示默认行为的新连接实例，并关闭任何以前仍然存在且已由同一XA连接实例返回的连接实例。但是，建议在打开新连接实例之前显式关闭它。
                        </p>
                        <p>调用XA连接实例的<code class="codeph">close</code>方法会关闭与数据库的物理连接。这通常在中间层执行。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28853"></a><div class="props_rev_3"><a id="GUID-F7013AB7-8F57-4260-A0F6-E7EAEDFBC063" name="GUID-F7013AB7-8F57-4260-A0F6-E7EAEDFBC063"></a><h4 id="JJDBC-GUID-F7013AB7-8F57-4260-A0F6-E7EAEDFBC063" class="sect4"><span class="enumeration_section">33.2.3</span> XAResource接口和Oracle实现</h4>
                  <div>
                     <div class="section">
                        <p>事务管理器使用<code class="codeph">OracleXAResource</code>实例来协调构成分布式事务的所有事务分支。
                        </p>
                        <p>每个<code class="codeph">OracleXAResource</code>实例都提供以下关键功能，通常由事务管理器调用：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>它将分布式事务与在生成此<code class="codeph">OracleXAResource</code>实例的XA连接实例中操作的事务分支关联和取消关联。实质上，它将分布式事务与XA连接实例封装的物理连接或会话相关联。这是通过使用事务ID完成的。
                              </p>
                           </li>
                           <li>
                              <p>它执行分布式事务的两阶段提交功能，以确保在确保更改在所有事务分支中成功之前，不会在一个事务分支中提交更改。</p>
                              <div class="infoboxnote" id="GUID-F7013AB7-8F57-4260-A0F6-E7EAEDFBC063__GUID-DCCFBACE-2494-477B-9E5E-E0B6486C0B6C">
                                 <p class="notep1">注意：</p>
                                 <ul style="list-style-type:disc">
                                    <li>
                                       <p>由于XA连接实例和<code class="codeph">OracleXAResource</code>实例之间必须始终存在一对一关联， <code class="codeph">OracleXAResource</code>关闭关联的XA连接实例时会隐式关闭<code class="codeph">OracleXAResource</code>实例。
                                       </p>
                                    </li>
                                    <li>
                                       <p>如果某个<code class="codeph">OracleXAResource</code>实例打开了一个事务，那么它也必须由同一个<code class="codeph">OracleXAResource</code>实例关闭。
                                       </p>
                                    </li>
                                 </ul>
                              </div>
                           </li>
                        </ul>
                        <p><code class="codeph">OracleXAResource</code>实例是实现标准<code class="codeph">javax.transaction.xa.的类的实例<code class="codeph">javax.transaction.xa.XAResource</code>接口。Oracle JDBC使用<code class="codeph">OracleXAResource</code>类实现<code class="codeph">XAResource</code>接口，该类位于<code class="codeph">oracle.jdbc.xa.client</code>包和<code class="codeph">oracle.jdbc.xa.server</code>包中。
                        </p>
                        <p>每当调用<code class="codeph">OracleXAConnection</code>类的<code class="codeph">getXAResource</code>方法时，Oracle JDBC驱动程序都会创建并返回<code class="codeph">OracleXAResource</code>实例，并且它是Oracle JDBC驱动程序， <code class="codeph">OracleXAResource</code>实例与连接实例相关联，并且通过该连接运行事务分支。
                        </p>
                        <p>此方法是<code class="codeph">OracleXAResource</code>实例与特定连接以及在该连接中运行的事务分支的关联方式。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28855"></a><a id="JJDBC28856"></a><a id="JJDBC28857"></a><a id="JJDBC28858"></a><a id="JJDBC28859"></a><a id="JJDBC28860"></a><a id="JJDBC28861"></a><a id="JJDBC28862"></a><a id="JJDBC28854"></a><div class="props_rev_3"><a id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6" name="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6"></a><h4 id="JJDBC-GUID-CD752E5A-309E-440A-A711-71083DD5B6A6" class="sect4"><span class="enumeration_section">33.2.4</span> OracleXAResource方法功能和输入参数</h4>
                  <div>
                     <div class="section">
                        <p><code class="codeph">OracleXAResource</code>类有几种方法可以将事务分支与与之关联的分布式事务进行协调。此功能通常涉及两阶段提交操作。
                        </p>
                        <p>从中间层组件（例如应用程序服务器）接收<code class="codeph">OracleXAResource</code>实例的事务管理器通常会调用此功能。
                        </p>
                        <p>这些方法中的每一个都以<code class="codeph">Xid</code>实例的形式将事务ID作为输入，其包括事务分支ID组件和分布式事务ID组件。每个事务分支都具有唯一的事务ID，但属于同一全局事务的事务分支具有相同的全局事务组件作为其事务ID的一部分。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-F66E0F1D-762E-4E76-BEF6-84C455709BB3">开始</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>代表事务分支开始工作，将事务分支与分布式事务相关联。</p><pre class="oac_no_warn" dir="ltr">void start（Xid xid，int flags）</pre><p><code class="codeph">flags</code>参数必须是以下一个或多个值：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">XA资源。TMNOFLAGS</code></p>
                              <p>标记新事务分支的开始，以便在与此XA资源实例关联的会话中进行后续操作。该分支将具有事务ID <code class="codeph">xid</code> ，它是由事务管理器创建的<code class="codeph">OracleXid</code>实例。这会将事务分支映射到适当的分布式事务。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">XA资源。TMJOIN</code></p>
                              <p>将与此XA资源实例关联的会话中的后续操作连接到<code class="codeph">xid</code>指定的现有事务分支。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">XA资源。TMRESUME</code></p>
                              <p>恢复<code class="codeph">xid</code>指定的事务分支。
                              </p>
                              <div class="infoboxnote" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-84C6551D-D36F-43CE-91F5-21444E0410AB">
                                 <p class="notep1">注意：</p>
                                 <p>事务分支只有在先前被挂起时才能恢复。</p>
                              </div>
                           </li>
                           <li>
                              <p><code class="codeph">OracleXAResource。TMPROMOTE</code></p>
                              <p>将本地事务提升为全局事务</p>
                           </li>
                           <li>
                              <p><code class="codeph">OracleXAResource。ORATMSERIALIZABLE</code></p>
                              <p>使用事务ID <code class="codeph">xid</code>启动可序列化事务。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">OracleXAResource。ORATMREADONLY</code></p>
                              <p>使用事务ID <code class="codeph">xid</code>启动只读事务。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">OracleXAResource。ORATMREADWRITE</code></p>
                              <p>使用事务ID <code class="codeph">xid</code>启动读/写事务。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">OracleXAResource。ORATRANSLOOSE</code></p>
                              <p>使用事务ID <code class="codeph">xid</code>启动松散耦合的事务。
                              </p>
                           </li>
                        </ul>
                        <p><code class="codeph">TMNOFLAGS</code> ， <code class="codeph">TMJOIN</code> ， <code class="codeph">TMRESUME</code> ， <code class="codeph">TMPROMOTE</code> ， <code class="codeph">ORATMSERIALIZABLE</code> ， <code class="codeph">ORATMREADONLY</code>和<code class="codeph">ORATMREADWRITE</code>被定义为<code class="codeph">XAResource</code>接口和<code class="codeph">OracleXAResource</code>类的<code class="codeph">static</code>成员。<code class="codeph">ORATMSERIALIZABLE</code> ， <code class="codeph">ORATMREADONLY</code>和<code class="codeph">ORATMREADWRITE</code>是隔离模式标志。默认隔离行为是<code class="codeph">READ COMMITTED</code> 。</p>
                        <div class="infoboxnote" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-A277F597-3D7F-4F04-B5B9-BB67F8AB14F6">
                           <p class="notep1">注意：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>事务管理器可以转换为<code class="codeph">OracleXAResource</code>并使用<code class="codeph">resume(Xid xid)</code>方法（Oracle扩展<code class="codeph">resume(Xid xid)</code> ，而不是使用<code class="codeph">TMRESUME</code>的<code class="codeph">start</code>方法。
                                 </p>
                              </li>
                              <li>
                                 <p>如果使用<code class="codeph">TMRESUME</code> ，则还必须使用<code class="codeph">TMNOMIGRATE</code> ，如<code class="codeph">start(xid, XAResource.TMRESUME | OracleXAResource。TMNOMIGRATE)</code> 。这可以防止应用程序收到错误<code class="codeph">ORA 1002: fetch out of sequence</code> 。
                                 </p>
                              </li>
                              <li>
                                 <p>如果错误地使用隔离模式标志，则会引发代码为<code class="codeph">XAER_INVAL</code>的异常。此外，在恢复全局事务时不能使用隔离模式标志，因为您无法设置现有事务的隔离级别。如果在恢复事务时尝试使用隔离模式标志，则会引发代码为ORA-24790的外部Oracle异常。
                                 </p>
                              </li>
                              <li>
                                 <p>为了避免<code class="codeph">Error ORA 1002: fetch out of sequence</code> ，请将<code class="codeph">TMNOMIGRATE</code>标志包含在<code class="codeph">start</code>方法的一部分中。例如：</p><pre class="oac_no_warn" dir="ltr">start（xid，XAResource。TMSUSPEND | OracleXAResource。TMNOMIGRATE）;</pre></li>
                              <li>
                                 <p><code class="codeph">OracleXAResource</code>中定义的所有标志都是Oracle扩展。在编写使用这些标志的事务管理器时，您应该注意这一点。
                                 </p>
                              </li>
                           </ul>
                        </div>
                        <p>请注意，要在启动事务分支时创建适当的事务ID，事务管理器必须知道事务分支属于哪个分布式事务。其中的机制在中间层和事务管理器之间处理。</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-89F6688F-529A-4418-8FE7-A4B4772D7278">结束</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>结束代表<code class="codeph">xid</code>指定的事务分支工作，解除事务分支与其分布式事务的关联。
                        </p><pre class="oac_no_warn" dir="ltr">void end（Xid xid，int flags）</pre><p><code class="codeph">flags</code>参数可以具有以下值之一：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">XA资源。TMSUCCESS</code></p>
                              <p>这表示已知此事务分支已成功。</p>
                           </li>
                           <li>
                              <p><code class="codeph">XA资源。TMFAIL</code></p>
                              <p>这表示已知此事务分支已失败。</p>
                           </li>
                           <li>
                              <p><code class="codeph">XA资源。TMSUSPEND</code></p>
                              <p>这是暂停<code class="codeph">xid</code>指定的事务分支。通过挂起事务分支，您可以在单个会话中拥有多个事务分支。但是，在任何给定时间只能有一个活动。而且，就资源而言，这往往比拥有两个会话更昂贵。
                              </p>
                           </li>
                        </ul>
                        <p><code class="codeph">TMSUCCESS</code> ， <code class="codeph">TMFAIL</code>和<code class="codeph">TMSUSPEND</code>被定义为<code class="codeph">XAResource</code>接口和<code class="codeph">OracleXAResource</code>类的静态成员。
                        </p>
                        <div class="infoboxnote" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-07664836-6AA1-42DB-BDF1-6966841F53A5">
                           <p class="notep1">注意：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>事务管理器可以转换为<code class="codeph">OracleXAResource</code>并使用<code class="codeph">suspend(Xid xid)</code>方法（Oracle扩展<code class="codeph">suspend(Xid xid)</code> ，而不是将<code class="codeph">end</code>方法与<code class="codeph">TMSUSPEND</code> <code class="codeph">OracleXAResource</code>使用。
                                 </p>
                              </li>
                              <li>
                                 <p>这种挂起事务的XA功能提供了在单个JDBC连接中切换各种事务的方法。您可以使用XA类来完成此任务，即使您不在分布式事务环境中，也不需要XA类。</p>
                              </li>
                              <li>
                                 <p>如果您使用<code class="codeph">TMSUSPEND</code> ，那么您还必须使用<code class="codeph">TMNOMIGRATE</code> ，如<code class="codeph">end(xid, XAResource.TMSUSPEND | OracleXAResource。TMNOMIGRATE)</code> 。这可以防止应用程序收到错误<code class="codeph">ORA 1002: fetch out of sequence</code> 。
                                 </p>
                              </li>
                              <li>
                                 <p>为了避免<code class="codeph">Error ORA 1002: fetch out of sequence</code> ，请将<code class="codeph">TMNOMIGRATE</code>标志包含在end方法的一部分中。例如：</p><pre class="oac_no_warn" dir="ltr">结束（xid，XAResource。TMSUSPEND | OracleXAResource。TMNOMIGRATE）;</pre></li>
                              <li>
                                 <p><code class="codeph">OracleXAResource</code>中定义的所有标志都是Oracle扩展。任何使用这些标志的事务管理器都应该注意这一点。
                                 </p>
                              </li>
                           </ul>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-3C5E0195-77F6-4768-9B6C-1BECFA80B9C4">准备</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>准备在<code class="codeph">xid</code>指定的事务分支中执行的更改。这是两阶段提交操作的第一阶段，以确保可以访问数据库并且可以成功提交更改。
                        </p><pre class="oac_no_warn" dir="ltr">int prepare（Xid xid）</pre><p>此方法返回一个整数值，如下所示：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">XA资源。XA_RDONLY</code></p>
                              <p>如果事务分支仅运行<code class="codeph">SELECT</code>语句等只读操作，则返回此值。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">XA资源。XA_OK</code></p>
                              <p>如果事务分支运行全部准备且没有错误的更新，则返回此值。</p>
                           </li>
                        </ul>
                        <p><code class="codeph">XA_RDONLY</code>和<code class="codeph">XA_OK</code>被定义为<code class="codeph">XAResource</code>接口和<code class="codeph">OracleXAResource</code>类的<code class="codeph">static</code>成员。
                        </p>
                        <div class="infoboxnote" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-B871A921-D468-484E-9DA2-2392B7E1B6E4">
                           <p class="notep1">注意：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>如果事务分支运行更新并且其中任何一个在准备期间遇到错误，则<code class="codeph">prepare</code>方法有时不返回任何值。在这种情况下，抛出XA异常。
                                 </p>
                              </li>
                              <li>
                                 <p>在调用<code class="codeph">prepare</code>方法之前，始终在分支上调用<code class="codeph">end</code>方法。
                                 </p>
                              </li>
                              <li>
                                 <p>如果分布式事务中只有一个事务分支，则无需调用<code class="codeph">prepare</code>方法。您可以先调用<code class="codeph">OracleXAResource</code> <code class="codeph">commit</code>方法，而无需先做好准备。
                                 </p>
                              </li>
                           </ul>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-C52864D1-B662-4AD8-92C4-DA75B4A73D1C">承诺</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>在<code class="codeph">xid</code>指定的事务分支中提交准备好的更改。这是两阶段提交的第二阶段，仅在成功准备好所有事务分支后执行。
                        </p><pre class="oac_no_warn" dir="ltr">void commit（Xid xid，boolean onePhase）</pre><p>设置<code class="codeph">onePhase</code>参数如下：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">真正</code></p>
                              <p>这是在提交事务分支时使用单阶段而不是两阶段协议。如果分布式事务中只有一个事务分支，这是合适的。 <code class="codeph">prepare</code>步骤将被跳过。
                              </p>
                           </li>
                           <li>
                              <p><code class="codeph">假</code></p>
                              <p>这是在提交事务分支时使用两阶段协议。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-22B85181-296C-4CDF-82F0-D796CCCCBC10">回滚</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>在<code class="codeph">xid</code>指定的事务分支中回滚准备好的更改。
                        </p><pre class="oac_no_warn" dir="ltr">void rollback（Xid xid）</pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-84832424-E7A8-4BF3-B00D-A0758ADC8923">忘记</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>告诉资源管理器忘记启发式完成的事务分支。</p><pre class="oac_no_warn" dir="ltr">public void forget（Xid xid）</pre></div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-77BD844A-6E3F-4F07-A344-DDE7ECEB5D3C">恢复</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>事务管理器在恢复期间调用此方法以获取当前处于准备或启发式完成状态的事务分支列表。</p><pre class="oac_no_warn" dir="ltr">public Xid [] recover（int flag）</pre><div class="infoboxnote" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-4539DB7A-5DD5-4D48-BEC8-0BFC1B6DFB04">
                           <p class="notep1">注意：</p>
                           <p><code class="codeph">TMSTARTRSCAN</code> ， <code class="codeph">TMENDRSCAN</code>或<code class="codeph">TMNOFLAGS</code>以外的<code class="codeph">flag</code>值会引发异常，否则将忽略<code class="codeph">flag</code> 。
                           </p>
                        </div>
                        <p>资源管理器为当前处于准备或启发式完成状态的事务分支返回零个或多个<code class="codeph">Xid</code> 。如果在操作期间发生错误，则资源管理器将抛出相应的<code class="codeph">XAException</code> 。
                        </p>
                        <div class="infoboxnote" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-50CF2CD2-8A13-4C3B-BE63-4A069A6709D8">
                           <p class="notep1">注意：</p>
                           <p>该<code class="codeph">recover</code>方法需要在SELECT权限<code class="codeph">DBA_PENDING_TRANSACTIONS</code>并执行特权<code class="codeph">SYS.DBMS_XA</code>在Oracle数据库服务器。对于Oracle Database <span class="italic">11g</span>第1版之前的数据库版本，其中包含针对错误5945463的修补程序的Oracle修补程序不可用，或者对于特定应用程序方案应用修补程序是不可行的，则<code class="codeph">recover</code>方法需要<code class="codeph">SYSBDBA</code>权限。定期使用<code class="codeph">SYSDBA</code>权限是一种安全风险。因此，如果您需要使用<code class="codeph">recover</code>方法，Oracle强烈建议您升级数据库或应用错误5945463的修复程序。
                           </p>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-CD752E5A-309E-440A-A711-71083DD5B6A6__GUID-CA19D762-2DEA-4B57-BD1B-83FD47477D66">isSameRM</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>要确定两个<code class="codeph">OracleXAResource</code>实例是否对应于同一资源管理器，请从一个<code class="codeph">OracleXAResource</code>实例调用<code class="codeph">isSameRM</code>方法，并将另一个<code class="codeph">OracleXAResource</code>实例指定为输入。在以下示例中，假设<code class="codeph">xares1</code>和<code class="codeph">xares2</code>是<code class="codeph">OracleXAResource</code>实例：</p><pre class="oac_no_warn" dir="ltr">boolean sameRM = xares1.isSameRM（xares2）;</pre></div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28863"></a><div class="props_rev_3"><a id="GUID-4FE2BFF4-9F22-4752-B571-B44D6F220BDC" name="GUID-4FE2BFF4-9F22-4752-B571-B44D6F220BDC"></a><h4 id="JJDBC-GUID-4FE2BFF4-9F22-4752-B571-B44D6F220BDC" class="sect4"><span class="enumeration_section">33.2.5</span> Xid接口和Oracle实现</h4>
                  <div>
                     <div class="section">
                        <p>事务管理器创建事务ID实例，并在协调分布式事务的分支时使用它们。每个事务分支都分配有唯一的事务ID，其中包括以下信息：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>对于垫标识符</p>
                              <p>格式标识符指定Java事务管理器。例如，可能存在格式标识符<code class="codeph">orcl</code> 。该字段<span class="italic">不能</span>为空。格式标识符的大小为4个字节。
                              </p>
                           </li>
                           <li>
                              <p>Glo bal交易标识符</p>
                              <p>它也称为分布式事务ID组件。全局事务标识符的大小为64个字节。</p>
                           </li>
                           <li>
                              <p>Bra nch资格赛</p>
                              <p>它也称为事务分支ID组件。分支限定符的大小为64个字节。</p>
                           </li>
                        </ul>
                        <p>64字节的全局事务标识符值在属于同一分布式事务的所有事务分支的事务ID中是相同的。但是，整个事务ID对于每个事务分支都是唯一的。</p>
                        <p>XA事务ID实例是实现标准<code class="codeph">javax.transaction.xa.的类的实例<code class="codeph">javax.transaction.xa.Xid</code>接口，它是X / Open事务标识符XID结构的Java映射。
                        </p>
                        <p>Oracle使用<code class="codeph">oracle.jdbc.xa</code>包中的<code class="codeph">OracleXid</code>类实现此接口。<code class="codeph">OracleXid</code>实例仅在事务管理器中使用，对应用程序或应用程序服务器是透明的。
                        </p>
                        <div class="infoboxnote" id="GUID-4FE2BFF4-9F22-4752-B571-B44D6F220BDC__GUID-2AE19F6E-33F3-45F2-8F85-FF9631CC940B">
                           <p class="notep1">注意：</p>
                           <p>Oracle不要求使用<code class="codeph">OracleXid</code>进行<code class="codeph">OracleXAResource</code>调用。相反，使用任何实现<code class="codeph">javax.transaction.xa.类<code class="codeph">javax.transaction.xa.Xid</code>界面。
                           </p>
                        </div>
                        <p>事务管理器可以在创建<code class="codeph">OracleXid</code>实例时使用以下内容：</p><pre class="oac_no_warn" dir="ltr">public OracleXid（int fId，byte gId []，byte bId []）抛出XAException</pre><p><code class="codeph">fId</code>是格式标识符的整数值， <code class="codeph">gId[]</code>是全局事务标识符的字节数组， <code class="codeph">bId[]</code>是分支限定符的字节数组。
                        </p>
                        <p><code class="codeph">Xid</code>接口指定以下getter方法：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">public int getFormatId（）</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">public byte [] getGlobalTransactionId（）</code></p>
                           </li>
                           <li>
                              <p><code class="codeph">public type [] getBranchQualifier（）</code></p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="JJDBC28864"></a><div class="props_rev_3"><a id="GUID-EAB7ACFA-5708-4608-B94D-0D9ECE391D67" name="GUID-EAB7ACFA-5708-4608-B94D-0D9ECE391D67"></a><h3 id="JJDBC-GUID-EAB7ACFA-5708-4608-B94D-0D9ECE391D67" class="sect3"><span class="enumeration_section">33.3</span>错误处理和优化</h3>
               <div>
                  <div class="section">
                     <p>本节重点介绍XA异常和错误处理的功能以及XA实现中的Oracle优化。它包括以下主题：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="distributed-transactions.html#GUID-31804AB5-6CA2-45A4-AE4C-F58FCF86EB5D">XAException类和方法</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-57581BCF-85CE-4671-8323-CCAC62BA980A">Oracle错误与XA错误之间的映射</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-2C258328-7DFD-42ED-AA03-01959FFE924A">XA错误处理</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-FDF1F19F-7B5D-4BD8-AB6C-B26F47340C71">Oracle XA优化</a></p>
                        </li>
                     </ul>
                     <p>异常和错误处理讨论包括标准XA异常类和Oracle特定的XA异常类，以及特定的XA错误代码和错误处理技术。</p>
                  </div>
                  <!-- class="section" -->
               </div><a id="JJDBC28865"></a><div class="props_rev_3"><a id="GUID-31804AB5-6CA2-45A4-AE4C-F58FCF86EB5D" name="GUID-31804AB5-6CA2-45A4-AE4C-F58FCF86EB5D"></a><h4 id="JJDBC-GUID-31804AB5-6CA2-45A4-AE4C-F58FCF86EB5D" class="sect4"><span class="enumeration_section">33.3.1</span> XAException类和方法</h4>
                  <div>
                     <div class="section">
                        <p>XA方法抛出XA异常，而不是一般异常或<code class="codeph">SQLExceptions</code> 。XA异常是标准类<code class="codeph">javax.transaction.xa.一个实例<code class="codeph">javax.transaction.xa.XAException</code>或子类。
                        </p>
                        <p>Oracle XAException是一个由Oracle错误部分和XA错误部分组成的实例。Oracle提供了<code class="codeph">oracle.jdbc.xa.标准<code class="codeph">javax.transaction.xa. OracleXAException</code>子类<code class="codeph">javax.transaction.xa.XAException</code>类。使用以下构造函数之一构造<code class="codeph">OracleXAException</code>实例：</p><pre class="oac_no_warn" dir="ltr">public OracleXAException（）public OracleXAException（int error）</pre><p>错误值是一个错误代码，它结合了Oracle SQL错误值和XA错误值。JDBC驱动程序确切地确定如何组合Oracle和XA错误值。</p>
                        <p><code class="codeph">OracleXAException</code>类具有以下方法：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">public int getOracleError（）</code></p>
                              <p>此方法返回与异常有关的Oracle SQL错误代码，标准ORA错误号，如果没有Oracle SQL错误，则返回0。</p>
                           </li>
                           <li>
                              <p><code class="codeph">public int getXAError（）</code></p>
                              <p>此方法返回与异常有关的XA错误代码。XA错误值在<code class="codeph">javax.transaction.xa.中定义<code class="codeph">javax.transaction.xa.XAException</code>类。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28867"></a><a id="JJDBC28866"></a><div class="props_rev_3"><a id="GUID-57581BCF-85CE-4671-8323-CCAC62BA980A" name="GUID-57581BCF-85CE-4671-8323-CCAC62BA980A"></a><h4 id="JJDBC-GUID-57581BCF-85CE-4671-8323-CCAC62BA980A" class="sect4"><span class="enumeration_section">33.3.2</span> Oracle错误和XA错误之间的映射</h4>
                  <div>
                     <div class="section">
                        <p>Oracle错误对应于<code class="codeph">OracleXAException</code>实例中的XA错误，如<a href="distributed-transactions.html#GUID-57581BCF-85CE-4671-8323-CCAC62BA980A__CFHEEBFF" title="表">表33-2中所述</a> 。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="tblformal" id="GUID-57581BCF-85CE-4671-8323-CCAC62BA980A__CFHEEBFF">
                        <p class="titleintable">表33-2 Oracle-XA错误映射</p>
                        <table cellpadding="4" cellspacing="0" class="Formal" title="Oracle-XA错误映射" width="100%" border="1" summary="table" frame="hsides" rules="rows">
                           <thead>
                              <tr align="left" valign="top">
                                 <th align="left" valign="bottom" width="41%" id="d80952e2096">Oracle错误代码</th>
                                 <th align="left" valign="bottom" width="59%" id="d80952e2099">XA错误代码</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2104" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24756</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2104 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_NOTA</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2113" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24764</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2113 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_HEURCOM</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2122" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24765</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2122 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_HEURRB</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2131" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24766</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2131 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_HEURMIX</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2140" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24767</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2140 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_RDONLY</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2149" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 25351</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2149 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_RETRY</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2158" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 30006</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2158 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_RETRY</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2167" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24763</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2167 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_PROTO</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2176" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24769</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2176 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_PROTO</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2185" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24770</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2185 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_PROTO</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2194" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24776</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2194 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_PROTO</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2204" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 2056</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2204 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_PROTO</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2213" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 17448</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2213 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_PROTO</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2222" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24768</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2222 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_PROTO</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2231" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24775</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2231 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_PROTO</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2240" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24761</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2240 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_RBROLLBACK</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2249" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 2091</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2249 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_RBROLLBACK</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2258" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 2092</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2258 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XA_RBROLLBACK</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2267" headers="d80952e2096 ">
                                    <p><code class="codeph">ORA 24780</code></p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2267 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_RMERR</code></p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="41%" id="d80952e2276" headers="d80952e2096 ">
                                    <p>所有其他<code class="codeph">ORA</code>错误</p>
                                 </td>
                                 <td align="left" valign="top" width="59%" headers="d80952e2276 d80952e2099 ">
                                    <p><code class="codeph">的XAException。XAER_RMFAIL</code></p>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                     <!-- class="inftblhruleinformal" -->
                  </div>
               </div><a id="JJDBC28868"></a><div class="props_rev_3"><a id="GUID-2C258328-7DFD-42ED-AA03-01959FFE924A" name="GUID-2C258328-7DFD-42ED-AA03-01959FFE924A"></a><h4 id="JJDBC-GUID-2C258328-7DFD-42ED-AA03-01959FFE924A" class="sect4"><span class="enumeration_section">33.3.3</span> XA错误处理</h4>
                  <div>
                     <div class="section">
                        <p>以下代码段使用<code class="codeph">OracleXAException</code>类来处理XA异常：</p><pre class="oac_no_warn" dir="ltr">尝试{......<span class="italic">执行XA操作</span> .........} catch（OracleXAException oxae）{int oraerr = oxae.getOracleError（）; System.out.println（“错误”+ oraerr）; } catch（XAException xae）{...<span class="italic">处理通用XA例外</span> ...}
</pre><p>如果XA操作没有抛出特定于Oracle的XA异常，则代码将逐步处理泛型XA异常。</p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28869"></a><div class="props_rev_3"><a id="GUID-FDF1F19F-7B5D-4BD8-AB6C-B26F47340C71" name="GUID-FDF1F19F-7B5D-4BD8-AB6C-B26F47340C71"></a><h4 id="JJDBC-GUID-FDF1F19F-7B5D-4BD8-AB6C-B26F47340C71" class="sect4"><span class="enumeration_section">33.3.4</span> Oracle XA优化</h4>
                  <div>
                     <div class="section">
                        <p>如果分布式事务的两个或多个分支使用相同的数据库实例，则Oracle JDBC具有提高性能的功能，这意味着与这些分支关联的<code class="codeph">OracleXAResource</code>实例与同一资源管理器相关联。
                        </p>
                        <p>在这种情况下，只有其中一个<code class="codeph">OracleXAResource</code>实例的<code class="codeph">prepare</code>方法将返回<code class="codeph">XA_OK</code>或将失败。其余的将返回<code class="codeph">XA_RDONLY</code> ，即使进行了更新。这允许事务管理器隐式加入所有事务分支，并在发生故障时通过返回<code class="codeph">XA_OK</code>或失败的<code class="codeph">OracleXAResource</code>实例提交或回滚加入的事务。
                        </p>
                        <p>事务管理器可以使用<code class="codeph">OracleXAResource</code>类<code class="codeph">isSameRM</code>方法来确定两个<code class="codeph">OracleXAResource</code>实例是否使用相同的资源管理器。这样它就可以解释<code class="codeph">XA_RDONLY</code>返回值的含义。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="JJDBC28870"></a><div class="props_rev_3"><a id="GUID-A1736524-8CB5-4965-89E3-C65C3861E784" name="GUID-A1736524-8CB5-4965-89E3-C65C3861E784"></a><h3 id="JJDBC-GUID-A1736524-8CB5-4965-89E3-C65C3861E784" class="sect3"><span class="enumeration_section">33.4</span>关于实现分布式事务</h3>
               <div>
                  <div class="section">
                     <p>本节提供了如何使用Oracle XA功能实现分布式事务的示例。本节包括以下主题：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="distributed-transactions.html#GUID-DE4E55A0-9798-4FB1-BF11-1B011607612B">Oracle XA导入摘要</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-1964042C-AA18-4E8B-8B43-5DE58BFE2610">Oracle XA代码示例</a></p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div><a id="JJDBC28871"></a><div class="props_rev_3"><a id="GUID-DE4E55A0-9798-4FB1-BF11-1B011607612B" name="GUID-DE4E55A0-9798-4FB1-BF11-1B011607612B"></a><h4 id="JJDBC-GUID-DE4E55A0-9798-4FB1-BF11-1B011607612B" class="sect4"><span class="enumeration_section">33.4.1</span> Oracle XA的导入摘要</h4>
                  <div>
                     <div class="section">
                        <p>您必须为Oracle XA功能导入以下内容：</p><pre class="oac_no_warn" dir="ltr">import oracle.jdbc.xa。OracleXid; import oracle.jdbc.xa。OracleXAException; import oracle.jdbc.pool。*; import oracle.jdbc.xa.client。*; import javax.transaction.xa。*;</pre><p><code class="codeph">oracle.jdbc.pool</code>包具有用于连接池功能的类，其中一些包含与XA相关的类作为子类。
                        </p>
                        <p>或者，如果代码将在Oracle数据库中运行并访问该数据库以进行SQL操作，则必须导入<code class="codeph">oracle.jdbc.xa.server</code>而不是<code class="codeph">oracle.jdbc.xa.client</code> 。
                        </p><pre class="oac_no_warn" dir="ltr">import oracle.jdbc.xa.server。*;</pre><p>如果您的应用程序必须使用服务器端Thin驱动程序作为XA事务的一部分访问另一个Oracle数据库，那么您的代码可以使用<code class="codeph">oracle.xa.client</code>类的完全限定名称。
                        </p>
                        <p>每个<code class="codeph">client</code>和<code class="codeph">server</code>包都有<code class="codeph">OracleXADataSource</code> ， <code class="codeph">OracleXAConnection</code>和<code class="codeph">OracleXAResource</code>类的版本。这三个类的抽象版本位于顶级<code class="codeph">oracle.jdbc.xa</code>包中。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="JJDBC28872"></a><div class="props_rev_3"><a id="GUID-1964042C-AA18-4E8B-8B43-5DE58BFE2610" name="GUID-1964042C-AA18-4E8B-8B43-5DE58BFE2610"></a><h4 id="JJDBC-GUID-1964042C-AA18-4E8B-8B43-5DE58BFE2610" class="sect4"><span class="enumeration_section">33.4.2</span> Oracle XA代码示例</h4>
                  <div>
                     <div class="section">
                        <p>此示例使用具有两个事务分支的两阶段分布式事务，每个事务分支到一个单独的数据库。</p>
                        <p>请注意，为简单起见，此示例将通常位于中间层的代码与通常位于事务管理器中的代码（例如<code class="codeph">OracleXAResource</code>方法调用和事务ID的创建）组合<code class="codeph">OracleXAResource</code> 。
                        </p>
                        <p>为简洁起见，此处未显示创建事务ID和执行SQL操作的细节。完整的示例随产品一起提供。</p>
                        <p>此示例执行以下序列：</p>
                        <ol>
                           <li>
                              <p>启动事务分支＃1。</p>
                           </li>
                           <li>
                              <p>启动事务分支＃2。</p>
                           </li>
                           <li>
                              <p>在分支＃1上执行DML操作。</p>
                           </li>
                           <li>
                              <p>在分支＃2上执行DML操作。</p>
                           </li>
                           <li>
                              <p>结束交易分支＃1。</p>
                           </li>
                           <li>
                              <p>结束交易分支＃2。</p>
                           </li>
                           <li>
                              <p>准备分支＃1。</p>
                           </li>
                           <li>
                              <p>准备分支＃2。</p>
                           </li>
                           <li>
                              <p>提交分支＃1。</p>
                           </li>
                           <li>
                              <p>提交分支＃2。</p>
                           </li>
                        </ol><pre class="oac_no_warn" dir="ltr">//您需要导入java.sql包以使用JDBC import java.sql。*; import javax.sql。*; import oracle.jdbc。*; import oracle.jdbc.pool。*; import oracle.jdbc.xa。OracleXid; import oracle.jdbc.xa。OracleXAException; import oracle.jdbc.xa.client。*; import javax.transaction.xa。*; class XA4 {public static void main（String args []）抛出SQLException {try {String URL1 =“jdbc：oracle：oci：@”; //您可以在连接URL中的@符号后面添加数据库名称。 String URL2 =“jdbc：oracle：thin：@（description =（address =（host = localhost）（protocol = tcp）（port = 5521））（connect_data =（service_name = orcl）））”; //创建第一个DataSource并获取连接OracleDataSource ods1 = new OracleDataSource（）; ods1.setURL（URL1）; ods1.setUser（ “HR”）; ods1.setPassword（ “HR”）;连接conna = ods1.getConnection（）; //创建第二个DataSource并获取连接OracleDataSource ods2 = new OracleDataSource（）; ods2.setURL（URL2）; ods2.setUser（ “HR”）; ods2.setPassword（ “HR”）; Connection connb = ods2.getConnection（）; //准备一个语句来创建表语句stmta = conna.createStatement（）; //准备一个语句来创建表语句stmtb = connb.createStatement（）; try {//删除测试表stmta.execute（“drop table my_table”）; } catch（SQLException e）{//忽略这里的错误} try {//创建一个测试表stmta.execute（“create table my_table（col1 int）”）; } catch（SQLException e）{//此处也忽略错误} try {//删除测试表stmtb.execute（“drop table my_tab”）; } catch（SQLException e）{//在这里忽略错误} try {//创建一个测试表stmtb.execute（“create table my_tab（col1 char（30））”）; } catch（SQLException e）{//此处也忽略错误} //创建XADataSource实例并设置属性。OracleXADataSource oxds1 = new OracleXADataSource（）; oxds1.setURL（ “JDBC：预言：OCI：@”）; oxds1.setUser（ “HR”）; oxds1.setPassword（ “HR”）; OracleXADataSource oxds2 = new OracleXADataSource（）; oxds2.setURL（“jdbc：oracle：thin：@（description =（address =（host = localhost）（protocol = tcp）（port = 5521））（connect_data =（service_name = orcl）））”）; oxds2.setUser（ “HR”）; oxds2.setPassword（ “HR”）; //获取与底层数据源的XA连接XAConnection pc1 = oxds1.getXAConnection（）; XAConnection pc2 = oxds2.getXAConnection（）; //获取物理连接Connection conn1 = pc1.getConnection（）;连接conn2 = pc2.getConnection（）; //获取XA资源XAResource oxar1 = pc1.getXAResource（）; XAResource oxar2 = pc2.getXAResource（）; //创建具有相同全局ID的Xid Xid xid1 = createXid（1）; Xid xid2 = createXid（2）; //启动资源oxar1.start（xid1，XAResource。TMNOFLAGS）; oxar2.start（xid2，XAResource。TMNOFLAGS）; //使用conn1和conn2 doSomeWork1（conn1）执行SQL操作; doSomeWork2（conn2）; //结束两个分支 - 重要的是oxar1.end（xid1，XAResource。TMSUCCESS）; oxar2.end（xid2，XAResource。TMSUCCESS）; //准备RMs int prp1 = oxar1.prepare（xid1）; int prp2 = oxar2.prepare（xid2）; System.out.println（“准备1的返回值为”+ prp1）; System.out.println（“准备2的返回值为”+ prp2）; boolean do_commit = true; if（！（（prp1 == XAResource。XA_OK）|| （prp1 == XAResource。XA_RDONLY）））do_commit = false; if（！（（prp2 == XAResource。XA_OK）|| （prp2 == XAResource。XA_RDONLY）））do_commit = false; System.out.println（“do_commit is”+ do_commit）; System.out.println（“oxar1与oxar2相同？“+ oxar1.isSameRM（oxar2））; if（prp1 == XAResource。XA_OK）if（do_commit）oxar1.commit（xid1，false）; else oxar1.rollback（xid1）; if（prp2 == XAResource。XA_OK）if（do_commit）oxar2.commit（xid2，false）; else oxar2.rollback（xid2）; //关闭连接conn1.close（）; conn1 = null; conn2.close（）; conn2 = null; pc1.close（）; pc1 = null; pc2.close（）; pc2 = null; ResultSet rset = stmta.executeQuery（“从my_table中选择col1”）; while（rset.next（））System.out.println（“Col1 is”+ rset.getInt（1））; rset.close（）; rset = null; rset = stmtb.executeQuery（“从my_tab中选择col1”）; while（rset.next（））System.out.println（“Col1 is”+ rset.getString（1））; rset.close（）; rset = null; stmta.close（）; stmta = null; stmtb.close（）; stmtb = null; conna.close（）; conna = null; connb.close（）; connb = null; } catch（SQLException sqe）{sqe.printStackTrace（）; } catch（XAException xae）{if（xae instanceof OracleXAException）{System.out.println（“XA Error is”+（（OracleXAException）xae）.getXAError（））; System.out.println（“SQL Error is”+（（OracleXAException）xae）.getOracleError（））; static Xid createXid（int bids）抛出XAException {...<span class="italic">创建交易ID</span> ...}private static void doSomeWork1（Connection conn）抛出SQLException {...<span class="italic">执行SQL操作</span> ...}private static void doSomeWork2（Connection conn）抛出SQLException {...<span class="italic">执行SQL操作</span> ...}}</pre></div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="JJDBC28873"></a><div class="props_rev_3"><a id="GUID-1EF2D070-305D-49D9-9124-16FFDF7CCF74" name="GUID-1EF2D070-305D-49D9-9124-16FFDF7CCF74"></a><h3 id="JJDBC-GUID-1EF2D070-305D-49D9-9124-16FFDF7CCF74" class="sect3"><span class="enumeration_section">33.5</span> Oracle JDBC驱动程序中的Native-XA</h3>
               <div>
                  <div class="section">
                     <p>通常，XA命令可以通过以下方式发送到服务器：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>通过非本机API</p>
                        </li>
                        <li>
                           <p>通过本机API</p>
                        </li>
                     </ul>
                     <p>将XA命令发送到服务器的两种方法之间存在巨大的性能差异。与使用非本机API相比，使用本机API可以提高性能。</p>
                     <p>在Oracle Database <span class="italic">10g</span>之前，Thin驱动程序使用非本机API将XA命令发送到服务器，因为Thin本机API不可用。非本机API使用PL / SQL过程，因此它们具有以下缺点：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>它们需要在线路上发送不同的消息。</p>
                        </li>
                        <li>
                           <p>它们导致更多往返数据库。</p>
                        </li>
                        <li>
                           <p>它们会导致更多游标保持打开状态。</p>
                        </li>
                        <li>
                           <p>它们通过占用Statement Cache中的空间来破坏语句缓存。</p>
                        </li>
                     </ul>
                     <p>此外，非本机API的实现在服务器中。因此，为了解决发送XA命令的任何问题，它需要服务器补丁。这会产生一个主要问题，因为有时补丁需要重新启动服务器。</p>
                     <p>从Oracle数据库<span class="italic">10g开始</span> ，Thin本机API可用，默认情况下用于发送XA命令。原生API比非原生API快10倍以上。
                     </p>
                     <p>本节包括以下主题：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><a href="distributed-transactions.html#GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55">OCI Native XA</a></p>
                        </li>
                        <li>
                           <p><a href="distributed-transactions.html#GUID-1F63D0AC-A68E-48D8-B07C-E4E04CC42609">瘦本机XA</a></p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div><a id="JJDBC28875"></a><a id="JJDBC28876"></a><a id="JJDBC28877"></a><a id="JJDBC28874"></a><div class="props_rev_3"><a id="GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55" name="GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55"></a><h4 id="JJDBC-GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55" class="sect4"><span class="enumeration_section">33.5.1</span> OCI Native XA</h4>
                  <div>
                     <div class="section">
                        <p>通过使用<code class="codeph">OracleXADataSource</code>类的<code class="codeph">tnsEntry</code>和<code class="codeph">nativeXA</code>属性启用本机XA。
                        </p>
                        <div class="infoboxnote" id="GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55__GUID-23D64F4D-3959-4C2F-A0DE-04D49CDC7860">
                           <p class="notep1">注意：</p>
                           <p>目前，OCI Native XA在多线程环境中不起作用。OCI驱动程序使用Oracle的C / XA库来支持分布式事务，这要求在恢复全局事务之前为每个线程获取XAConnection。</p>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55__GUID-8C43188C-0089-4528-B4E3-10915B30C471">配置和安装</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>在一个<a id="d80952e2716" class="indexterm-anchor"></a>在Solaris或Linux系统中，您需要<code class="codeph">libheteroxa11.so</code>共享库来启用Native XA功能。必须在搜索路径中安装此库并使其可用于本机XA功能才能正常工作。
                        </p>
                        <p>在Microsoft Windows系统上，您需要<code class="codeph">heteroxa11.dll</code>文件才能启用Native XA功能。必须在Windows DLL路径中安装此文件并使其可用，才能使Native XA功能正常工作。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55__GUID-728D08D0-2CD2-43CC-896C-0BB6ED8AE5B6">异常处理</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>在分布式事务中使用Native XA功能时，建议应用程序只检查<code class="codeph">XAException</code>或<code class="codeph">SQLException</code> ，而不是<code class="codeph">OracleXAException</code>或<code class="codeph">OracleSQLException</code> 。
                        </p>
                        <div class="infoboxnote" id="GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55__GUID-7EF7EE79-9165-4C84-A027-5970763BBBC6">
                           <p class="notep1">注意：</p>
                           <p>从SQL错误代码到标准XA错误代码的映射不适用于Native XA功能。</p>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-C569E55B-4E1C-4DCF-88F4-05D831B69A55__GUID-F625D2D5-ECD4-49F0-9724-AEBC8686CF50">原生XA代码示例</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p>以下部分代码显示了如何启用Native XA功能：</p><pre class="oac_no_warn" dir="ltr">...//创建XADataSource实例OracleXADataSource oxds = new OracleXADataSource（）; oxds.setURL（URL）; //设置nativeXA属性以使用Native XA功能oxds.setNativeXA（true）; //根据需要将tnsEntry属性设置为较旧的数据库oxds.setTNSEntryName（“ora805”）; ...
</pre></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="relinfo">
                        <p><strong>相关话题</strong></p>
                        <ul>
                           <li><a href="data-sources-and-URLs.html#GUID-088B1600-C6C2-4F19-A020-2DAF8FE1F1C3">数据源的特征和属性</a></li>
                           <li><a href="JDBC-error-messages.html#GUID-1F040951-2DB5-4A65-8027-8A737E34F6B3">本机XA消息</a></li>
                        </ul>
                     </div>
                  </div>
                  
               </div><a id="JJDBC28878"></a><div class="props_rev_3"><a id="GUID-1F63D0AC-A68E-48D8-B07C-E4E04CC42609" name="GUID-1F63D0AC-A68E-48D8-B07C-E4E04CC42609"></a><h4 id="JJDBC-GUID-1F63D0AC-A68E-48D8-B07C-E4E04CC42609" class="sect4"><span class="enumeration_section">33.5.2</span>瘦本机XA</h4>
                  <div>
                     <div class="section">
                        <p>与JDBC OCI驱动程序一样，JDBC Thin驱动程序也提供对Native XA的支持。但是，JDBC Thin驱动程序默认情况下为Native XA提供支持。这与JDBC OCI驱动程序的情况不同，在该驱动程序中，默认情况下不启用对Native XA的支持。</p>
                        <p>您可以通过在XA数据源上调用<code class="codeph">setNativeXA(false)</code>来禁用Native XA，如下所示：</p><pre class="oac_no_warn" dir="ltr">...//创建XADataSource实例OracleXADataSource oxds = new OracleXADataSource（）; ...//禁用Native XA oxds.setNativeXA（false）; ...
</pre><p>例如，您可能需要禁用Native XA作为Native XA代码中的错误的解决方法。</p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>