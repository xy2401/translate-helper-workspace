<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <meta name="abstract" content="This chapter how to retain, report on, and restore non-current statistics."></meta>
      <meta name="description" content="This chapter how to retain, report on, and restore non-current statistics."></meta>
      <title>管理历史优化器统计信息</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="SQL Tuning Guide"></meta>
      <meta property="og:description" content="This chapter how to retain, report on, and restore non-current statistics."></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="SQL Tuning Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="sql-tuning-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-01-31T14:57:08-08:00"></meta>
      <meta name="dcterms.title" content="SQL Tuning Guide"></meta>
      <meta name="dcterms.dateCopyrighted" content="2013, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96095-03"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="controlling-the-use-of-optimizer-statistics.html" title="Previous" type="text/html"></link>
      <link rel="next" href="transporting-optimizer-statistics.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="TGSQL"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="controlling-the-use-of-optimizer-statistics.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="transporting-optimizer-statistics.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">SQL调优指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="optimizer-statistics.html" property="item" typeof="WebPage"><span property="name">优化器统计</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">管理历史优化器统计信息</li>
            </ol>
            <a id="GUID-F1399D77-7E2E-434F-A67C-6ADB4C648D95" name="GUID-F1399D77-7E2E-434F-A67C-6ADB4C648D95"></a><a id="TGSQL449"></a>
            
            <h2 id="TGSQL-GUID-F1399D77-7E2E-434F-A67C-6ADB4C648D95" class="sect2"><span class="enumeration_chapter">16</span>管理历史优化程序统计信息</h2>
         </header>
         <div class="ind">
            <div>
               <p>本章如何保留，报告和恢复非当前统计信息。</p>
               <p>本章包含以下主题：</p>
            </div>
            <div>
               <ul class="ullinks">
                  <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-D3050CB5-C0FA-4BD7-B7FF-88566437D461">恢复优化程序统计信息</a><br>您可以使用<code class="codeph">DBMS_STATS</code>还原存储在数据字典中的旧版统计信息。
                  </li>
                  <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-DEEE6740-F601-4B77-B4D3-AF03F5883456">管理优化程序统计信息保留</a><br>默认情况下，数据库会保留优化程序统计信息31天，之后统计信息将进行清除。
                  </li>
                  <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-48022C00-9B87-4470-BC23-AECFCDA0E434">报告过去的统计数据收集操作</a><br>您可以使用<code class="codeph">DBMS_STATS</code>函数报告特定统计信息收集操作或在指定时间内发生的操作。
                  </li>
               </ul>
               <div class="familylinks">
                  <div class="parentlink">
                     <p><strong>父主题：</strong> <a href="optimizer-statistics.html#GUID-0A2F3D52-A135-43E1-9CAB-55BFE068A297" title="执行计划的准确性取决于优化程序统计信息的质量。">优化程序统计信息</a></p>
                  </div>
               </div>
            </div>
            <a id="TGSQL502"></a><div class="props_rev_3"><a id="GUID-D3050CB5-C0FA-4BD7-B7FF-88566437D461" name="GUID-D3050CB5-C0FA-4BD7-B7FF-88566437D461"></a><h3 id="TGSQL-GUID-D3050CB5-C0FA-4BD7-B7FF-88566437D461" class="sect3"><span class="enumeration_section">16.1</span>恢复优化器统计信息</h3>
               <div>
                  <p>您可以使用<code class="codeph">DBMS_STATS</code>还原存储在数据字典中的旧版统计信息。
                  </p>
                  <p>本主题包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-20CDFDE1-96AA-4F70-9C12-70912E62EDBA">关于优化程序统计信息的还原操作</a><br>每当修改数据字典中的统计信息时，数据库都会自动保存旧版本的统计信息。如果新收集的统计信息导致次优执行计划，那么您可能希望恢复到以前的统计信息。
                     </li>
                     <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-77E3F1DF-919C-45EE-B515-1E7C6D3382D7">恢复优化程序统计信息的准则</a><br>恢复统计信息与导入和导出统计信息类似。
                     </li>
                     <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-61DB66DE-7967-4453-9898-FC903A704B5D">恢复优化程序统计信息的限制</a><br>恢复以前版本的统计信息时，会有各种限制。
                     </li>
                     <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-8AAE84DA-487B-41AB-92A5-F41215DDAF52">使用DBMS_STATS还原优化程序统计信息</a><br>您可以使用<code class="codeph">DBMS_STATS.RESTORE_*_STATS</code>过程还原统计信息。
                     </li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-F1399D77-7E2E-434F-A67C-6ADB4C648D95" title="本章如何保留，报告和恢复非当前统计信息。">管理历史优化程序统计信息</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL503"></a><div class="props_rev_3"><a id="GUID-20CDFDE1-96AA-4F70-9C12-70912E62EDBA" name="GUID-20CDFDE1-96AA-4F70-9C12-70912E62EDBA"></a><h4 id="TGSQL-GUID-20CDFDE1-96AA-4F70-9C12-70912E62EDBA" class="sect4"><span class="enumeration_section">16.1.1</span>关于优化程序统计信息的还原操作</h4>
                  <div>
                     <p>每当修改数据字典中的统计信息时，数据库都会自动保存旧版本的统计信息。如果新收集的统计信息导致次优执行计划，那么您可能希望恢复到以前的统计信息。</p>
                     <p>恢复优化程序统计信息有助于排除次优计划的故障。下图说明了恢复统计信息的时间表。在图中，统计数据收集发生在8月10日和8月20日。8月24日，DBA确定当前统计信息可能导致优化器生成次优计划。8月25日，管理员恢复8月10日收集的统计信息。</p>
                     <div class="figure" id="GUID-20CDFDE1-96AA-4F70-9C12-70912E62EDBA__CHDEHCDA">
                        <p class="titleinfigure">图16-1恢复优化器统计信息</p><img src="img/tgsql_vm_020.png" alt="下面是图16-1的描述" title="下面是图16-1的描述" longdesc="img_text/tgsql_vm_020.html"><br><a href="img_text/tgsql_vm_020.html">“图16-1恢复优化器统计信息”的说明</a></div>
                     <!-- class="figure" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-D3050CB5-C0FA-4BD7-B7FF-88566437D461" title="您可以使用DBMS_STATS还原存储在数据字典中的旧版统计信息。">还原优化程序统计信息</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL504"></a><div class="props_rev_3"><a id="GUID-77E3F1DF-919C-45EE-B515-1E7C6D3382D7" name="GUID-77E3F1DF-919C-45EE-B515-1E7C6D3382D7"></a><h4 id="TGSQL-GUID-77E3F1DF-919C-45EE-B515-1E7C6D3382D7" class="sect4"><span class="enumeration_section">16.1.2</span>恢复优化器统计信息的指导原则</h4>
                  <div>
                     <p>恢复统计信息与导入和导出统计信息类似。</p>
                     <div class="section">
                        <p>通常，在以下情况下还原统计信息而不是导出它们：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>您想要恢复旧版本的统计信息。例如，您希望将优化程序行为还原到较早的日期。</p>
                           </li>
                           <li>
                              <p>您希望数据库管理统计信息历史记录的保留和清除。</p>
                           </li>
                        </ul>
                        <p>导出统计信息而不是在以下情况下恢复它们：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>您希望尝试多组统计信息并来回更改值。</p>
                           </li>
                           <li>
                              <p>您希望将统计信息从一个数据库移动到另一个数据库。例如，将统计信息从生产系统移动到测试系统。</p>
                           </li>
                           <li>
                              <p>您希望将一组已知统计信息保留的时间段长于恢复统计信息所需的保留日期。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-77E3F1DF-919C-45EE-B515-1E7C6D3382D7__GUID-FC7D7F55-EFC3-4D62-A87A-36EE36F9757E">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../arpls/DBMS_STATS.html#ARPLS68491" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考</cite></span></a> ，以获取有关还原和导入统计信息的过程的概述</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-D3050CB5-C0FA-4BD7-B7FF-88566437D461" title="您可以使用DBMS_STATS还原存储在数据字典中的旧版统计信息。">还原优化程序统计信息</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL505"></a><div class="props_rev_3"><a id="GUID-61DB66DE-7967-4453-9898-FC903A704B5D" name="GUID-61DB66DE-7967-4453-9898-FC903A704B5D"></a><h4 id="TGSQL-GUID-61DB66DE-7967-4453-9898-FC903A704B5D" class="sect4"><span class="enumeration_section">16.1.3</span>恢复优化器统计信息的限制</h4>
                  <div>
                     <p>恢复以前版本的统计信息时，会有各种限制。</p>
                     <div class="section">
                        <p>限制包括以下内容：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">DBMS_STATS.RESTORE_*_STATS</code>过程无法恢复用户定义的统计信息。
                              </p>
                           </li>
                           <li>
                              <p>使用<code class="codeph">ANALYZE</code>命令收集统计信息时，不会存储旧版本的统计信息。
                              </p>
                           </li>
                           <li>
                              <p>删除表时，自动直方图收集功能使用的工作负载信息和<code class="codeph">RESTORE_*_STATS</code>过程使用的已保存统计信息历史记录将丢失。没有这些数据，这些功能将无法正常运行。要从表中删除所有行，并使用<code class="codeph">DBMS_STATS</code>还原这些统计信息，请使用<code class="codeph">TRUNCATE</code>而不是删除并重新创建同一个表。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-D3050CB5-C0FA-4BD7-B7FF-88566437D461" title="您可以使用DBMS_STATS还原存储在数据字典中的旧版统计信息。">还原优化程序统计信息</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL507"></a><a id="TGSQL508"></a><a id="TGSQL506"></a><div class="props_rev_3"><a id="GUID-8AAE84DA-487B-41AB-92A5-F41215DDAF52" name="GUID-8AAE84DA-487B-41AB-92A5-F41215DDAF52"></a><h4 id="TGSQL-GUID-8AAE84DA-487B-41AB-92A5-F41215DDAF52" class="sect4"><span class="enumeration_section">16.1.4</span>使用DBMS_STATS恢复优化器统计信息</h4>
                  <div>
                     <p>您可以使用<code class="codeph">DBMS_STATS.RESTORE_*_STATS</code>过程还原统计信息。
                     </p>
                     <div class="section">
                        <p>下表中列出的过程接受时间戳作为参数，并在指定时间（ <code class="codeph">as_of_timestamp</code> ）恢复统计信息。
                        </p>
                        <div class="tblformal" id="GUID-8AAE84DA-487B-41AB-92A5-F41215DDAF52__CHDIHEAE">
                           <p class="titleintable">表16-1 DBMS_STATS还原过程</p>
                           <table cellpadding="4" cellspacing="0" class="Formal" title="DBMS_STATS恢复程序" width="100%" border="1" summary="DBMS_STATS restore procedures" frame="hsides" rules="rows">
                              <thead>
                                 <tr align="left" valign="top">
                                    <th align="left" valign="bottom" width="43%" id="d88724e868">程序</th>
                                    <th align="left" valign="bottom" width="57%" id="d88724e871">描述</th>
                                 </tr>
                              </thead>
                              <tbody>
                                 <tr align="left" valign="top">
                                    <td align="left" valign="top" width="43%" id="d88724e876" headers="d88724e868 ">
                                       <p><code class="codeph">RESTORE_DICTIONARY_STATS</code></p>
                                    </td>
                                    <td align="left" valign="top" width="57%" headers="d88724e876 d88724e871 ">
                                       <p>从指定的时间戳恢复所有字典表（ <code class="codeph">SYS</code> ， <code class="codeph">SYSTEM</code>和<code class="codeph">RDBMS</code>组件模式的表）的统计信息。
                                       </p>
                                    </td>
                                 </tr>
                                 <tr align="left" valign="top">
                                    <td align="left" valign="top" width="43%" id="d88724e893" headers="d88724e868 ">
                                       <p><code class="codeph">RESTORE_FIXED_OBJECTS_STATS</code></p>
                                    </td>
                                    <td align="left" valign="top" width="57%" headers="d88724e893 d88724e871 ">
                                       <p>从指定的时间戳恢复所有固定表的统计信息。</p>
                                    </td>
                                 </tr>
                                 <tr align="left" valign="top">
                                    <td align="left" valign="top" width="43%" id="d88724e901" headers="d88724e868 ">
                                       <p><code class="codeph">RESTORE_SCHEMA_STATS</code></p>
                                    </td>
                                    <td align="left" valign="top" width="57%" headers="d88724e901 d88724e871 ">
                                       <p>从指定的时间戳恢复架构的所有表的统计信息。</p>
                                    </td>
                                 </tr>
                                 <tr align="left" valign="top">
                                    <td align="left" valign="top" width="43%" id="d88724e909" headers="d88724e868 ">
                                       <p><code class="codeph">RESTORE_SYSTEM_STATS</code></p>
                                    </td>
                                    <td align="left" valign="top" width="57%" headers="d88724e909 d88724e871 ">
                                       <p>从指定的时间戳恢复系统统计信息。</p>
                                    </td>
                                 </tr>
                                 <tr align="left" valign="top">
                                    <td align="left" valign="top" width="43%" id="d88724e917" headers="d88724e868 ">
                                       <p><code class="codeph">RESTORE_TABLE_STATS</code></p>
                                    </td>
                                    <td align="left" valign="top" width="57%" headers="d88724e917 d88724e871 ">
                                       <p>从指定的时间戳恢复表的统计信息。该过程还会还原关联索引和列的统计信息。如果表统计信息已锁定在指定的时间戳，则该过程将锁定统计信息。</p>
                                    </td>
                                 </tr>
                              </tbody>
                           </table>
                        </div>
                        <!-- class="inftblhruleinformal" -->
                        <p>字典视图显示统计信息修改的时间。您可以使用以下视图来确定用于还原操作的时间戳：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">DBA_OPTSTAT_OPERATIONS</code>视图包含使用<code class="codeph">DBMS_STATS</code>在架构和数据库级别执行的统计信息操作的历史记录。</p>
                           </li>
                           <li>
                              <p><code class="codeph">DBA_TAB_STATS_HISTORY</code>视图包含表统计信息修改的历史记录。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-8AAE84DA-487B-41AB-92A5-F41215DDAF52__GUID-4F915400-6680-4E65-8F11-E97577523ED2">假设</p>
                        <p>本教程假设以下内容：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>在<code class="codeph">oe.orders</code>表的最新统计信息收集之后，优化器开始为此表的查询选择次优计划。
                              </p>
                           </li>
                           <li>
                              <p>您希望从最近的统计信息收集之前恢复统计信息，以查看计划是否有所改进。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-8AAE84DA-487B-41AB-92A5-F41215DDAF52__GUID-F22197D2-8B3D-4F43-BC7E-27C0E53AE126">要还原优化程序统计信息：</p>
                        <ol>
                           <li>
                              <p>启动SQL * Plus并使用管理员权限连接到数据库。</p>
                           </li>
                           <li>
                              <p>查询<code class="codeph">oe.orders</code>的统计历史记录。
                              </p>
                              <p>例如，运行以下查询：</p><pre class="pre codeblock"><code>COL TABLE_NAME FORMAT a10 SELECT TABLE_NAME，TO_CHAR（STATS_UPDATE_TIME，'YYYY-MM-DD：HH24：MI：SS'）AS STATS_MOD_TIME FROM DBA_TAB_STATS_HISTORY WHERE TABLE_NAME ='ORDERS'和OWNER ='OE'ORDER BY STATS_UPDATE_TIME DESC;</code></pre><p>示例输出如下：</p><pre class="pre codeblock"><code>TABLE_NAME STATS_MOD_TIME ---------- ------------------- ORDERS 2012-08-20：11：36：38订单2012-08-10： 11点06分20秒</code></pre></li>
                           <li>
                              <p>将优化程序统计信息还原到上一个修改时间。</p>
                              <p>例如，将<code class="codeph">oe.orders</code>表统计信息恢复到2012年8月10日：</p><pre class="pre codeblock"><code>BEGIN DBMS_STATS.RESTORE_TABLE_STATS（'OE'，'ORDERS'，TO_TIMESTAMP（'2012-08-10：11：06：20'，'YYYY-MM-DD：HH24：MI：SS'））;结束; /</code></pre><p>您可以指定8/10到8/20之间的任何日期，因为<code class="codeph">DBMS_STATS</code>在指定时间内恢复统计信息。
                              </p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-8AAE84DA-487B-41AB-92A5-F41215DDAF52__GUID-2A1CFADE-0412-4887-AC18-16AC0D0AEE56">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-DAF4653C-2C8F-462E-9509-6BA3E6AE768F" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解有关<code class="codeph">DBMS_STATS.RESTORE_TABLE_STATS</code>过程的更多信息</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-D3050CB5-C0FA-4BD7-B7FF-88566437D461" title="您可以使用DBMS_STATS还原存储在数据字典中的旧版统计信息。">还原优化程序统计信息</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL494"></a><div class="props_rev_3"><a id="GUID-DEEE6740-F601-4B77-B4D3-AF03F5883456" name="GUID-DEEE6740-F601-4B77-B4D3-AF03F5883456"></a><h3 id="TGSQL-GUID-DEEE6740-F601-4B77-B4D3-AF03F5883456" class="sect3"><span class="enumeration_section">16.2</span>管理优化器统计信息保留</h3>
               <div>
                  <p>默认情况下，数据库会保留优化程序统计信息31天，之后统计信息将进行清除。</p>
                  <p>您可以使用<code class="codeph">DBMS_STATS</code>程序包来确定保留期，更改期间以及手动清除旧统计信息。
                  </p>
                  <p>本节包含以下主题：</p>
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-D5C8B818-5D69-4F18-B504-A96433310C48">获取优化程序统计历史记录</a><br>您可以使用<code class="codeph">DBMS_STATS</code>过程获取优化程序统计信息的历史信息。
                     </li>
                     <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-7522E2BD-1FCF-4FD0-B62F-CFB7858D53C1">更改优化程序统计信息保留期</a><br>您可以使用<code class="codeph">DBMS_STATS.ALTER_STATS_HISTORY_RETENTION</code>过程配置保留期。默认值为31天。
                     </li>
                     <li class="ulchildlink"><a href="managing-historical-optimizer-statistics.html#GUID-46AC849E-6C18-494B-9E5E-E6F87879610A">清除优化程序统计信息</a><br>当<code class="codeph">STATISTICS_LEVEL</code>初始化参数设置为<code class="codeph">TYPICAL</code>或<code class="codeph">ALL</code>时，将启用自动清除。</li>
                  </ul>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-F1399D77-7E2E-434F-A67C-6ADB4C648D95" title="本章如何保留，报告和恢复非当前统计信息。">管理历史优化程序统计信息</a></p>
                     </div>
                  </div>
               </div>
               <a id="TGSQL495"></a><div class="props_rev_3"><a id="GUID-D5C8B818-5D69-4F18-B504-A96433310C48" name="GUID-D5C8B818-5D69-4F18-B504-A96433310C48"></a><h4 id="TGSQL-GUID-D5C8B818-5D69-4F18-B504-A96433310C48" class="sect4"><span class="enumeration_section">16.2.1</span>获取优化器统计信息历史记录</h4>
                  <div>
                     <p>您可以使用<code class="codeph">DBMS_STATS</code>过程获取优化程序统计信息的历史信息。
                     </p>
                     <div class="section">
                        <p>当您想要确定数据库保留优化程序统计信息的时间以及可以恢复这些统计信息的时间时，历史信息非常有用。您可以使用以下过程获取有关优化程序统计信息历史记录的信息：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p><code class="codeph">GET_STATS_HISTORY_RETENTION</code></p>
                              <p>此函数可以检索当前统计历史记录保留值。</p>
                           </li>
                           <li>
                              <p><code class="codeph">GET_STATS_HISTORY_AVAILABILITY</code></p>
                              <p>当统计历史可用时，此函数将检索最旧的时间戳。用户无法将统计信息还原到早于最早时间戳的时间戳。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-D5C8B818-5D69-4F18-B504-A96433310C48__GUID-4D41C4D1-3F33-4C1E-81BF-802BFB535058">要获取优化程序统计信息历史信息：</p>
                        <ol>
                           <li>
                              <p>启动SQL * Plus并使用必要的权限连接到数据库。</p>
                           </li>
                           <li>
                              <p>执行以下PL / SQL程序：</p><pre class="pre codeblock"><code>DECLARE v_stats_retn NUMBER; v_stats_date DATE; BEGIN v_stats_retn：= DBMS_STATS.GET_STATS_HISTORY_RETENTION; DBMS_OUTPUT.PUT_LINE（'保留设置为'|| v_stats_retn ||'。“）; v_stats_date：= DBMS_STATS.GET_STATS_HISTORY_AVAILABILITY; DBMS_OUTPUT.PUT_LINE（'最早的恢复日期是'|| v_stats_date ||'。“）;结束; /</code></pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-D5C8B818-5D69-4F18-B504-A96433310C48__GUID-2D3DE7F4-4C36-431C-B160-25D853DEE617">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-03065EEA-54F1-4B69-9D3E-EB9EEAD27103" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">DBMS_STATS.GET_STATS_HISTORY_RETENTION</code>过程</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-DEEE6740-F601-4B77-B4D3-AF03F5883456" title="默认情况下，数据库会保留优化程序统计信息31天，之后统计信息将进行清除。">管理优化程序统计信息保留</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL497"></a><a id="TGSQL498"></a><a id="TGSQL496"></a><div class="props_rev_3"><a id="GUID-7522E2BD-1FCF-4FD0-B62F-CFB7858D53C1" name="GUID-7522E2BD-1FCF-4FD0-B62F-CFB7858D53C1"></a><h4 id="TGSQL-GUID-7522E2BD-1FCF-4FD0-B62F-CFB7858D53C1" class="sect4"><span class="enumeration_section">16.2.2</span>更改优化程序统计信息保留期</h4>
                  <div>
                     <p>您可以使用<code class="codeph">DBMS_STATS.ALTER_STATS_HISTORY_RETENTION</code>过程配置保留期。默认值为31天。
                     </p>
                     <div class="section">
                        <p class="subhead3" id="GUID-7522E2BD-1FCF-4FD0-B62F-CFB7858D53C1__GUID-2FFE7A12-FC57-4135-AC4B-AEC25D1B7730">先决条件</p>
                        <p>要运行此过程，您必须具有<code class="codeph">SYSDBA</code>权限，或者具有<code class="codeph">ANALYZE ANY DICTIONARY</code>和<code class="codeph">ANALYZE ANY</code>系统权限。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-7522E2BD-1FCF-4FD0-B62F-CFB7858D53C1__GUID-0E64C517-E1D8-49DC-BC47-90BF908D51F8">假设</p>
                        <p>本教程假设以下内容：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>优化程序统计信息的当前保留期为31天。</p>
                           </li>
                           <li>
                              <p>作为年度报告的一部分，您每年都会运行查询。要使统计历史记录保留超过365天，以便您可以访问去年的计划（如果现在出现次优计划），则将保留期设置为366天。</p>
                           </li>
                           <li>
                              <p>您希望创建可用于更改优化程序统计信息保留期的PL / SQL过程<code class="codeph">set_opt_stats_retention</code> 。
                              </p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-7522E2BD-1FCF-4FD0-B62F-CFB7858D53C1__GUID-05084790-34EB-4D74-A8EF-DBAC62CBDDF9">要更改优化程序统计信息保留期：</p>
                        <ol>
                           <li>
                              <p>启动SQL * Plus并使用必要的权限连接到数据库。</p>
                           </li>
                           <li>
                              <p>创建一个更改保留期的过程。</p>
                              <p>例如，创建以下过程：</p><pre class="pre codeblock"><code>创建或替换过程set_opt_stats_retention（p_stats_retn IN NUMBER）是v_stats_retn NUMBER; BEGIN v_stats_retn：= DBMS_STATS.GET_STATS_HISTORY_RETENTION; DBMS_OUTPUT.PUT_LINE（'旧保留设置为'|| v_stats_retn ||'。“）; DBMS_STATS.ALTER_STATS_HISTORY_RETENTION（p_stats_retn）; v_stats_retn：= DBMS_STATS.GET_STATS_HISTORY_RETENTION; DBMS_OUTPUT.PUT_LINE（'新保留设置为'|| v_stats_retn ||'。“）;结束; /</code></pre></li>
                           <li>
                              <p>将保留期更改为366天。</p>
                              <p>例如，执行您在上一步中创建的过程（包括示例输出）：</p><pre class="pre codeblock"><code>SQL&gt; EXECUTE set_opt_stats_retention（366）旧保留设置为31。新的保留设置为366。PL / SQL过程成功完成。</code></pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-7522E2BD-1FCF-4FD0-B62F-CFB7858D53C1__GUID-5DD8309E-3CDB-4814-A6D1-15D36745E37D">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-A04AE1C0-5DE1-4AFC-91F8-D35D41DF98A2" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">DBMS_STATS.ALTER_STATS_HISTORY_RETENTION</code>过程</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-DEEE6740-F601-4B77-B4D3-AF03F5883456" title="默认情况下，数据库会保留优化程序统计信息31天，之后统计信息将进行清除。">管理优化程序统计信息保留</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="TGSQL500"></a><a id="TGSQL501"></a><a id="TGSQL499"></a><div class="props_rev_3"><a id="GUID-46AC849E-6C18-494B-9E5E-E6F87879610A" name="GUID-46AC849E-6C18-494B-9E5E-E6F87879610A"></a><h4 id="TGSQL-GUID-46AC849E-6C18-494B-9E5E-E6F87879610A" class="sect4"><span class="enumeration_section">16.2.3</span>清除优化器统计信息</h4>
                  <div>
                     <p>当<code class="codeph">STATISTICS_LEVEL</code>初始化参数设置为<code class="codeph">TYPICAL</code>或<code class="codeph">ALL</code>时，将启用自动清除。</p>
                     <div class="section">
                        <p>数据库清除所有早于旧版本的历史记录（当前时间 - <code class="codeph">ALTER_STATS_HISTORY_RETENTION</code>设置）和（最近统计信息收集的时间 -  1）。
                        </p>
                        <p>您可以使用<code class="codeph">PURGE_STATS</code>过程手动清除旧统计信息。如果未指定参数，则此过程使用自动清除策略。如果指定<code class="codeph">before_timestamp</code>参数，则数据库将清除在指定时间戳之前保存的统计信息。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-46AC849E-6C18-494B-9E5E-E6F87879610A__GUID-E2E7C86E-595A-470A-83DA-44FF93F22545">先决条件</p>
                        <p>要运行此过程，您必须具有<code class="codeph">SYSDBA</code>权限，或者具有<code class="codeph">ANALYZE ANY DICTIONARY</code>和<code class="codeph">ANALYZE ANY</code>系统权限。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-46AC849E-6C18-494B-9E5E-E6F87879610A__GUID-4C9EF089-EE96-447C-83A7-9DF349CBA74C">假设</p>
                        <p>本教程假定您要清除超过一周的统计信息。</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-46AC849E-6C18-494B-9E5E-E6F87879610A__GUID-E7438FA3-5994-42FF-A3B5-5BA5D6F0D3B0">要清除优化程序统计信息：</p>
                        <ol>
                           <li>
                              <p>在SQL * Plus中，使用必要的权限登录数据库。</p>
                           </li>
                           <li>
                              <p>执行<code class="codeph">DBMS_STATS.PURGE_STATS</code>过程。
                              </p>
                              <p>例如，执行以下过程：</p><pre class="pre codeblock"><code>EXEC DBMS_STATS.PURGE_STATS（SYSDATE-7）;</code></pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-46AC849E-6C18-494B-9E5E-E6F87879610A__GUID-DE884555-0FA1-40B5-B5EB-B0DE635F9A2B">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="../arpls/DBMS_STATS.html#ARPLS-GUID-8E6413D5-F827-4F57-9FAD-7EC56362A98C" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考，</cite></span></a>以了解<code class="codeph">DBMS_STATS.PURGE_STATS</code>过程</p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-DEEE6740-F601-4B77-B4D3-AF03F5883456" title="默认情况下，数据库会保留优化程序统计信息31天，之后统计信息将进行清除。">管理优化程序统计信息保留</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div><a id="TGSQL94642"></a><a id="TGSQL94643"></a><a id="TGSQL94641"></a><div class="props_rev_3"><a id="GUID-48022C00-9B87-4470-BC23-AECFCDA0E434" name="GUID-48022C00-9B87-4470-BC23-AECFCDA0E434"></a><h3 id="TGSQL-GUID-48022C00-9B87-4470-BC23-AECFCDA0E434" class="sect3"><span class="enumeration_section">16.3</span>报告过去的统计数据收集操作</h3>
               <div>
                  <p>您可以使用<code class="codeph">DBMS_STATS</code>函数报告特定统计信息收集操作或在指定时间内发生的操作。
                  </p>
                  <div class="section">
                     <p><a href="managing-historical-optimizer-statistics.html#GUID-48022C00-9B87-4470-BC23-AECFCDA0E434__CHDCDHHH" title="DBMS_STATS恢复程序">表16-2</a>列出了这些功能。
                     </p>
                     <div class="tblformal" id="GUID-48022C00-9B87-4470-BC23-AECFCDA0E434__CHDCDHHH">
                        <p class="titleintable">表16-2 DBMS_STATS报告功能</p>
                        <table cellpadding="4" cellspacing="0" class="Formal" title="DBMS_STATS报告功能" width="100%" border="1" summary="DBMS_STATS restore procedures" frame="hsides" rules="rows">
                           <thead>
                              <tr align="left" valign="top">
                                 <th align="left" valign="bottom" width="44%" id="d88724e1857">功能</th>
                                 <th align="left" valign="bottom" width="56%" id="d88724e1860">描述</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="44%" id="d88724e1865" headers="d88724e1857 ">
                                    <p><code class="codeph">REPORT_STATS_OPERATIONS</code></p>
                                 </td>
                                 <td align="left" valign="top" width="56%" headers="d88724e1865 d88724e1860 ">
                                    <p>生成两个时间点之间发生的所有统计操作的报告。您可以缩小报告的范围，仅包括自动统计信息收集运行。您还可以提供一组可插拔数据库（PDB）ID，以便数据库仅报告指定PDB中的统计信息操作。</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="44%" id="d88724e1873" headers="d88724e1857 ">
                                    <p><code class="codeph">REPORT_SINGLE_STATS_OPERATION</code></p>
                                 </td>
                                 <td align="left" valign="top" width="56%" headers="d88724e1873 d88724e1860 ">
                                    <p>生成指定操作的报告。（可选）您可以在容器数据库（CDB）中指定特定的PDB ID。</p>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                     <!-- class="inftblhruleinformal" -->
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-48022C00-9B87-4470-BC23-AECFCDA0E434__GUID-24B87E94-4A9E-4975-95D1-D20313042962">假设</p>
                     <p>本教程假定您要生成以下HTML报告：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>所有统计信息在最后一天内收集操作</p>
                        </li>
                        <li>
                           <p>最近的统计数据收集操作</p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-48022C00-9B87-4470-BC23-AECFCDA0E434__GUID-4D7A6B73-61FD-4B04-A0EB-B30104FD230A">要报告过去一天的所有操作：</p>
                     <ol>
                        <li>
                           <p>启动SQL * Plus并使用管理员权限连接到数据库。</p>
                        </li>
                        <li>
                           <p>运行<code class="codeph">DBMS_STATS.REPORT_STATS_OPERATIONS</code>函数。
                           </p>
                           <p>例如，运行以下命令：</p><pre class="pre codeblock"><code>SET LINES 200 PAGES 0 SET LONG 100000 COLUMN REPORT FORMAT A200 VARIABLE my_report CLOB; BEGIN：my_report：= DBMS_STATS.REPORT_STATS_OPERATIONS（since =&gt; SYSDATE-1，until =&gt; SYSDATE，detail_level =&gt;'TYPICAL'，format =&gt;'HTML'）;结束; /</code></pre><p>下图显示了一个示例报告：</p>
                           <div class="figure" id="GUID-48022C00-9B87-4470-BC23-AECFCDA0E434__GUID-4F82753E-3A6E-44D7-9049-188A3962B5B1"><img src="img/reporting_past_ops.gif" alt="reporting_past_ops.gif的描述如下" title="reporting_past_ops.gif的描述如下" longdesc="img_text/reporting_past_ops.html"><br><a href="img_text/reporting_past_ops.html">报告说明reporting_past_ops.gif</a></div>
                           <!-- class="figure" -->
                        </li>
                        <li>
                           <p>为单个操作运行<code class="codeph">DBMS_STATS.REPORT_SINGLE_STATS_OPERATION</code>函数。
                           </p>
                           <p>例如，运行以下程序以生成操作<code class="codeph">848</code>的报告：</p><pre class="pre codeblock"><code>BEGIN：my_report：= DBMS_STATS.REPORT_SINGLE_STATS_OPERATION（OPID =&gt; 848，FORMAT =&gt;'HTML'）;结束;</code></pre></li>
                     </ol>
                     <p>下图显示了一个示例报告：</p>
                     <div class="figure" id="GUID-48022C00-9B87-4470-BC23-AECFCDA0E434__GUID-5C83050B-40D3-4983-9FAC-4D93ED74F9FE"><img src="img/reporting_past_op.gif" alt="reporting_past_op.gif的描述如下" title="reporting_past_op.gif的描述如下" longdesc="img_text/reporting_past_op.html"><br><a href="img_text/reporting_past_op.html">报告说明reporting_past_op.gif</a></div>
                     <!-- class="figure" -->
                  </div>
                  <!-- class="section" -->
               </div>
               <div>
                  <div class="infoboxnotealso" id="GUID-48022C00-9B87-4470-BC23-AECFCDA0E434__GUID-3E9019C0-F1D8-491F-AC68-27175F68FDC7">
                     <p class="notep1">也可以看看：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p><span class="q">“ <a href="options-for-optimizer-statistics-gathering.html#GUID-7D050AB3-B3E6-4318-B9AC-B0D751131CD3" title="Cloud Control中的Manage Optimizer Statistics页面是一个GUI，可用于管理优化程序统计信息。">优化器统计管理的图形界面</a> ”</span> ，了解用于统计管理的Cloud Control GUI</p>
                        </li>
                        <li>
                           <p><a href="../arpls/DBMS_STATS.html#ARPLS059" target="_blank"><span><cite>Oracle Database PL / SQL包和类型参考</cite></span></a>以了解有关<code class="codeph">DBMS_STATS</code>更多信息 
                           </p>
                        </li>
                     </ul>
                  </div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>父主题：</strong> <a href="managing-historical-optimizer-statistics.html#GUID-F1399D77-7E2E-434F-A67C-6ADB4C648D95" title="本章如何保留，报告和恢复非当前统计信息。">管理历史优化程序统计信息</a></p>
                     </div>
                  </div>
               </div>
               
            </div>
         </div>
      </article>
   </body>
</html>