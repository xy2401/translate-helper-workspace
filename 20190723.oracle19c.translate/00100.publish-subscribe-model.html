<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <title>使用发布 - 订阅模型开发应用程序</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Database Development Guide"></meta>
      <meta property="og:description" content=""></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Database Development Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="database-development-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-01-31T23:23:15-08:00"></meta>
      <meta name="dcterms.title" content="Database Development Guide"></meta>
      <meta name="dcterms.dateCopyrighted" content="1996, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96334-02"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="xa.html" title="Previous" type="text/html"></link>
      <link rel="next" href="odbc-driver.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="ADFNS"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="xa.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="odbc-driver.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">数据库开发指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="advanced-part.html" property="item" typeof="WebPage"><span property="name">应用程序开发人员的高级主题</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">使用发布 - 订阅模型开发应用程序</li>
            </ol>
            <a id="GUID-AF669B8F-426E-45D2-BC02-7647CAD25B7A" name="GUID-AF669B8F-426E-45D2-BC02-7647CAD25B7A"></a><a id="ADFNS1111"></a><a id="ADFNS014"></a>
            
            <h2 id="ADFNS-GUID-AF669B8F-426E-45D2-BC02-7647CAD25B7A" class="sect2"><span class="enumeration_chapter">23</span>使用发布 - 订阅模型开发应用程序</h2>
         </header>
         <div class="ind">
            <div>
               <p>本章介绍如何在发布 - 订阅模型上开发应用程序。</p>
               <div class="section">
                  <p class="subhead1" id="GUID-AF669B8F-426E-45D2-BC02-7647CAD25B7A__GUID-612C8B61-4E2D-43F4-82DD-C2C0D1DF1EE1">话题：</p>
               </div>
               <!-- class="section" -->
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="publish-subscribe-model.html#GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25">发布 - 订阅模型简介</a></p>
                  </li>
                  <li>
                     <p><a href="publish-subscribe-model.html#GUID-8DE18549-CD9E-4EA7-87B4-53FC4474570C">发布 - 订阅体系结构</a></p>
                  </li>
                  <li>
                     <p><a href="publish-subscribe-model.html#GUID-327BA412-08EB-41E2-9059-B49355ABA51D">发布 - 订阅概念</a></p>
                  </li>
                  <li>
                     <p><a href="publish-subscribe-model.html#GUID-3E344EF4-8AD0-442E-9E18-D0747C491E40">发布 - 订阅机制的示例</a></p>
                  </li>
               </ul>
            </div><a id="ADFNS826"></a><a id="ADFNS1601"></a><div class="props_rev_3"><a id="GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25" name="GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25"></a><h3 id="ADFNS-GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25" class="sect3">发布 - 订阅模型简介</h3>
               <div>
                  <p>由于数据库是企业中最重要的信息资源，因此Oracle为企业信息传递和消息传递创建了一个发布 - 订阅解决方案，以补充此角色。</p>
                  <p>网络技术和产品可在大量计算机，应用程序和用户之间实现高度连接。在这些环境中，为分布式系统提供异步通信非常重要，这些分布式系统以松散耦合和自治的方式运行，并且需要操作免受网络故障的影响。此要求由各种中间件产品填充，这些产品的特征在于消息传递，面向消息的中间件（MOM），消息队列或发布 - 订阅。</p>
                  <p>通过发布和订阅范例进行通信的应用程序要求发送应用程序（发布者）在不明确指定收件人或了解预期收件人的情况下发布邮件。类似地，接收应用程序（订户）必须仅接收订户已注册感兴趣的那些消息。</p>
                  <p>发送者和接收者之间的这种分离通常由发布者和订阅者之间的中间实体来完成，该实体用作间接级别。该中间实体是表示主题或频道的队列。<a href="publish-subscribe-model.html#GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25__i1006201">图23-1</a>说明了发布和订阅功能。
                  </p>
                  <div class="figure" id="GUID-47FC01C8-06F6-4DE2-B20A-3F9DCBA63E25__i1006201">
                     <p class="titleinfigure">图23-1 Oracle发布 - 订阅功能</p><img width="460" src="img/adfns065.gif" alt="下面是图23-1的描述" title="下面是图23-1的描述" longdesc="img_text/adfns065.html"><br><a href="img_text/adfns065.html">“图23-1 Oracle发布 - 订阅功能”的说明</a></div>
                  <!-- class="figure" -->
                  <p>订户通过表达对排队到该队列的消息的兴趣并通过使用基于主题或基于内容的规则作为过滤器来订阅队列。这导致一组与给定队列相关联的基于规则的订阅。</p>
                  <p>在运行时，发布者将消息发布到各种队列。然后，队列（换句话说，底层基础架构的传递机制）将与各种订阅匹配的消息传递给适当的订户。</p>
               </div>
            </div><a id="ADFNS1602"></a><div class="props_rev_3"><a id="GUID-8DE18549-CD9E-4EA7-87B4-53FC4474570C" name="GUID-8DE18549-CD9E-4EA7-87B4-53FC4474570C"></a><h3 id="ADFNS-GUID-8DE18549-CD9E-4EA7-87B4-53FC4474570C" class="sect3">发布 - 订阅体系结构</h3>
               <div>
                  <p>Oracle数据库包括这些功能，以支持启用数据库的发布 - 订阅消息传递：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="publish-subscribe-model.html#GUID-893AB488-7C25-41DA-A88A-4B8871B68921">数据库事件</a></p>
                     </li>
                     <li>
                        <p><a href="publish-subscribe-model.html#GUID-743BB76B-0681-4719-A9DB-14888A15DE3C">Oracle高级队列</a></p>
                     </li>
                     <li>
                        <p><a href="publish-subscribe-model.html#GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3">客户通知</a></p>
                     </li>
                  </ul>
               </div><a id="ADFNS827"></a><div class="props_rev_3"><a id="GUID-893AB488-7C25-41DA-A88A-4B8871B68921" name="GUID-893AB488-7C25-41DA-A88A-4B8871B68921"></a><h4 id="ADFNS-GUID-893AB488-7C25-41DA-A88A-4B8871B68921" class="sect4">数据库事件</h4>
                  <div>
                     <p>数据库事件支持用于发布此类事件的数据库事件，检测和运行时发布的声明性定义。此功能允许以事件驱动的方式向最终用户主动发布信息，以补充传统的面向拉取的信息访问方法。</p>
                     <div class="infoboxnotealso" id="GUID-893AB488-7C25-41DA-A88A-4B8871B68921__GUID-6D1B89CC-703F-4B38-9F6A-E8F25D6050B2">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/adfns&amp;id=LNPLS2014" target="_blank"><span class="italic">Oracle数据库PL / SQL语言参考</span></a></p>
                     </div>
                  </div>
               </div><a id="ADFNS828"></a><div class="props_rev_3"><a id="GUID-743BB76B-0681-4719-A9DB-14888A15DE3C" name="GUID-743BB76B-0681-4719-A9DB-14888A15DE3C"></a><h4 id="ADFNS-GUID-743BB76B-0681-4719-A9DB-14888A15DE3C" class="sect4">Oracle高级队列</h4>
                  <div>
                     <p>Oracle Advanced Queuing（AQ）支持基于队列的发布 - 订阅范例。数据库队列充当消息的持久存储，以及允许基于队列进行发布和订阅的功能。规则引擎和订阅服务根据表达的兴趣动态地将消息路由到接收者。这允许在发送器和接收器之间解耦寻址，以补充现有的显式发送器 - 接收器消息寻址。</p>
                     <div class="infoboxnotealso" id="GUID-743BB76B-0681-4719-A9DB-14888A15DE3C__GUID-9C26EC05-F529-4820-95EC-CBAE0F75E577">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/adfns&amp;id=ADQUE1400" target="_blank"><span class="italic">Oracle数据库高级队列用户指南</span></a></p>
                     </div>
                  </div>
               </div><a id="ADFNS829"></a><div class="props_rev_3"><a id="GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3" name="GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3"></a><h4 id="ADFNS-GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3" class="sect4">客户通知</h4>
                  <div>
                     <p>客户端通知支持向感兴趣的订户异步传递消息，使数据库客户端能够注册对某些队列的兴趣，并使这些客户端能够在发生此类队列上的发布时接收通知。向数据库客户端异步传递消息与用于检索信息的传统轮询技术形成对比。</p>
                     <div class="infoboxnotealso" id="GUID-DE5DA74A-B852-49C1-A163-11D6E9C38EC3__GUID-DD1C71DE-B133-462F-8DCD-19A6E402D8DE">
                        <p class="notep1">也可以看看：</p>
                        <p><a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/adfns&amp;id=LNOCI090" target="_blank"><span class="italic">Oracle调用接口程序员指南</span></a></p>
                     </div>
                  </div>
               </div>
            </div><a id="ADFNS830"></a><a id="ADFNS831"></a><a id="ADFNS832"></a><a id="ADFNS833"></a><a id="ADFNS834"></a><a id="ADFNS835"></a><a id="ADFNS836"></a><a id="ADFNS837"></a><a id="ADFNS838"></a><a id="ADFNS839"></a><a id="ADFNS840"></a><a id="ADFNS841"></a><a id="ADFNS1603"></a><div class="props_rev_3"><a id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D" name="GUID-327BA412-08EB-41E2-9059-B49355ABA51D"></a><h3 id="ADFNS-GUID-327BA412-08EB-41E2-9059-B49355ABA51D" class="sect3">发布 - 订阅概念</h3>
               <div>
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-45409F10-022D-462B-82F9-C040892A0AD6">队列</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p><span class="bold">队列</span>是支持感兴趣的命名主题概念的实体。队列可以表征为持久性或非持久性（轻量级）。
                     </p>
                     <p><span class="bold">持久队列</span>充当消息的持久容器。消息以延迟和可靠的模式传递。
                     </p>
                     <p><span class="bold">非持久或轻量级队列</span>的底层基础结构以轻量级，最佳一次方式将发布的消息推送到连接的客户端。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-750D4E98-5667-43F0-9299-E9CC6E875BB4">代理人</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>发布者和订阅者在内部表示为代理。</p>
                     <p><strong class="term">代理</strong>是持久性逻辑订阅实体，通过订阅表达对队列的兴趣。代理具有属性，例如关联的订阅，地址和消息的传递模式。在此上下文中，代理是发布者或订阅者的电子代理。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-7C8F1412-98A1-495A-A092-4A2348EBC681">客户</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p><strong class="term">客户端</strong>是瞬态物理实体。客户端的属性包括客户端程序运行的物理进程，节点名称和客户端应用程序逻辑。多个客户可以代表单个代理进行操作。如果获得授权，同一客户可以代表多个代理商行事。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-02681D78-5693-4A18-937A-CFEAF633A130">统治队列</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>使用消息格式属性或消息头属性上的预定义运算符集<span class="bold">将队列规则</span>指定为条件表达式。每个队列都有一个关联的消息内容格式，用于描述该队列所表示的消息的结构。消息格式可能是非结构化的（ <code class="codeph">RAW</code> ），也可能是定义良好的结构（ADT）。这允许基于主题或内容的订阅。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-418CECA5-CD69-4482-99F1-2A06748DD934">订户</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>订户（代理）可以使用规则在队列上指定订阅。订户是持久的并存储在目录中。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-563417A5-2CF4-4204-805C-B1956410159D">数据库事件发布框架</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>数据库是发布信息的重要来源。提出了一个事件框架，以允许数据库事件发布的声明性定义。当这些预定义事件发生时，框架会检测并发布此类事件。这允许以事件驱动的方式将信息主动传递给最终用户，作为发布 - 订阅功能的一部分。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-3C12653C-8A63-46C3-B558-56DCE7CA5DC6">注册</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>注册是指代客户代表代理人的相关交付信息的过程。与代理/客户端分离相关的订阅和注册之间存在重要区别。</p>
                     <p>订阅表示代理对特定队列的兴趣。它没有说明必须在何处以及如何进行交付。传递信息是与客户端相关联的物理属性，它是逻辑代理（订户）的瞬时表现形式。代表代理的特定客户端进程通过关联主机和端口来指示传递信息，指示传递将在<span class="italic">何处</span>进行，以及回调，指示<span class="italic">如何进行</span>传递。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-1F0EE71A-DDD6-4008-9A81-5972360971DC">发布消息</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>发布者使用适当的排队接口将消息发布到队列。接口可能取决于实现队列的模型。例如，enqueue调用表示发布消息。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-BF4BEC05-D712-4762-A225-67D763430A56">规则引擎</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>当消息发布或发布到给定队列时，规则引擎从该队列上定义的与发布消息匹配的所有规则中提取候选规则集。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-130B82B0-9747-4C61-8CD0-CB6B3CBCCED2">订阅服务</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>对应于给定队列上的候选规则列表，可以评估与候选规则匹配的订户组。反过来，可以确定并通知与该订阅列表相对应的代理集。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-8229BFDF-812D-49A7-B76C-092061A21825">发帖</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>该队列通知所有已注册的客户端相应的已发布消息。这个概念叫做<strong class="term">发布</strong> 。当队列必须通知所有感兴趣的客户端时，它会将消息发布到所有已注册的客户端。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-327BA412-08EB-41E2-9059-B49355ABA51D__GUID-6F8CB4D6-F0CF-4033-9BF0-54DDDC2F0D2C">收到一条消息</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p>订阅者可以通过以下任何机制接收消息：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>代表订户执行的客户端进程使用注册机制指定回调。当消息与订阅者的订阅匹配时，发布机制然后异步调用回调。消息内容可以传递给回调函数（仅限非持久队列）。</p>
                        </li>
                        <li>
                           <p>代表订户执行的客户端进程使用注册机制指定回调。然后，发布机制异步调用回调函数，但没有完整的消息内容。这用作客户端的通知，客户端随后以拉取方式检索消息内容（仅限持久队列）。</p>
                        </li>
                        <li>
                           <p>代表订户行动的客户端进程仅以定期或其他适当的方式从队列中检索消息。虽然消息被延迟，但是没有异步传递到最终客户端。</p>
                        </li>
                     </ul>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="ADFNS1604"></a><div class="props_rev_3"><a id="GUID-3E344EF4-8AD0-442E-9E18-D0747C491E40" name="GUID-3E344EF4-8AD0-442E-9E18-D0747C491E40"></a><h3 id="ADFNS-GUID-3E344EF4-8AD0-442E-9E18-D0747C491E40" class="sect3">发布 - 订阅机制的示例</h3>
               <div>
                  <div class="section">
                     <p>此示例显示数据库事件，客户端通知和AQ如何实现发布 - 订阅。</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <ul style="list-style-type:disc">
                        <li>
                           <p>在用户模式<code class="codeph">pubsub</code>下创建，包含支持发布 - 订阅机制所需的所有对象。在此特定代码中，代理<code class="codeph">snoop</code>订阅在登录事件中发布的消息。要使用AQ功能，用户<code class="codeph">pubsub</code>需要<code class="codeph">AQ_ADMINISTRATOR_ROLE</code>权限和<code class="codeph">DBMS_AQ</code>和<code class="codeph">DBMS_AQADM</code> <code class="codeph">EXECUTE</code>权限。</p>
                        </li>
                     </ul><pre class="oac_no_warn" dir="ltr">Rem ------------------------------------------------- ----- REM为持久性多个消费者创建队列表：Rem ----------------------------------- ------------------- Rem创建或替换队列表BEGIN DBMS_AQADM.CREATE_QUEUE_TABLE（Queue_table =&gt;'Pubsub。Raw_msg_table'，Multiple_consumers =&gt; TRUE，Queue_payload_type =&gt;'RAW'，Compatible =&gt;'8.1'）;结束; / Rem ------------------------------------------------ ------ Rem为发布消息创建一个持久队列：Rem ---------------------------------- -------------------- Rem为登录事件创建队列BEGIN DBMS_AQADM.CREATE_QUEUE（Queue_name =&gt;'Pubsub。登录'，Queue_table =&gt;'Pubsub。Raw_msg_table'，Comment =&gt;'Q for error triggers'）;结束; / Rem ------------------------------------------------ ------ Rem开始排队：Rem -------------------------------------- ---------------- BEGIN DBMS_AQADM.START_QUEUE（'pubsub.logon'）;结束; / Rem ------------------------------------------------ ------ Rem为了方便起见定义new_enqueue：Rem ------------------------------------- -----------------创建或替换过程New_enqueue（Queue_name IN VARCHAR2，Payload IN RAW，Correlation IN VARCHAR2：= NULL，Exception_queue IN VARCHAR2：= NULL）AS Enq_ct DBMS_AQ.Enqueue_options_t ; Msg_prop DBMS_AQ.Message_properties_t; Enq_msgid RAW（16）; Userdata RAW（1000）; BEGIN Msg_prop。Exception_queue：= Exception_queue; Msg_prop。相关性：=相关性;用户数据：=有效负载; DBMS_AQ.ENQUEUE（Queue_name，Enq_ct，Msg_prop，Userdata，Enq_msgid）;结束; / Rem ------------------------------------------------ ------ Rem使用基于当前用户名的规则添加订阅者，Rem使用correlation_id Rem ----------------------------- ------------------------- DECLARE Subscriber Sys。AQ $ _agent; BEGIN订阅者：= sys.aq $ _agent（'SNOOP'，NULL，NULL）; DBMS_AQADM.ADD_SUBSCRIBER（Queue_name =&gt;'Pubsub.logon'，Subscriber =&gt; subscriber，Rule =&gt;'CORRID =''HR'''）;结束; / <span class="italic">Rem ------------------------------------------------ ------</span> <span class="italic">Rem在登录数据库时创建一个触发器：</span> <span class="italic">Rem ---------------------------------- --------------------</span> <span class="italic">Rem在登录后创建触发器：</span> CREATE OR REPLACE TRIGGER pubsub。登录数据库后的Systrig2开始New_enqueue（'Pubsub。登录'，HEXTORAW（'9999'），Dbms_standard.login_user）;结束; /</pre><ul style="list-style-type:disc">
                        <li>
                           <p>创建订阅后，下一步是客户端使用回调函数注册通知。这是使用Oracle调用接口（OCI）完成的。此代码执行注册所需的步骤。为清楚起见，这里省略了分配和初始化会话句柄的初始步骤：</p>
                        </li>
                     </ul><pre class="oac_no_warn" dir="ltr">ub4 namespace = OCI_SUBSCR_NAMESPACE_AQ; <span class="italic">/ *回调函数，用于通知用户'HR'在数据库上的登录：* /</span> ub4 notifySnoop（ctx，subscrhp，pay，payl，desc，mode）dvoid * ctx; OCISubscription * subscrhp; dvoid * pay; ub4 payl; dvoid * desc; ub4模式; {printf（“通知：用户HR已登录\ n”）; } int main（）{OCISession * authp =（OCISession *）0; OCISubscription * subscrhpSnoop =（OCISubscription *）0; <span class="italic">/ ******************* ****</span> <span class="italic">初始化OCI进程/环境</span> <span class="italic">初始化服务器上下文</span> <span class="italic">连接到服务器</span> <span class="italic">集服务上下文</span> <span class="italic">******************************** ********************** /</span> <span class="italic">/ *注册码开始* /</span> <span class="italic">/ *每次调用initSubscriptionHn都会分配</span> <span class="italic">并初始化一个注册句柄* /</span> initSubscriptionHn（＆subscrhpSnoop， <span class="italic">/ *订阅句柄*</span> /“ADMIN：PUBSUB.SNOOP”，/ <span class="italic">*订阅名称* /</span> <span class="italic">/ * &lt;agent_name&gt;：&lt;queue_name&gt; * /</span> （dvoid *）notifySnoop）; <span class="italic">/ *回调函数* /</span> <span class="italic">/ ******************************************* **********</span> <span class="italic">客户端进程不需要回调</span> <span class="italic">结束会话和从服务器分离</span> <span class="italic">的实时会话</span> <span class="italic">*********************** ******************************* /</span> OCISessionEnd（svchp，errhp，authp，（ub4）OCI_DEFAULT）; <span class="italic">/ *从服务器分离* /</span> OCIServerDetach（srvhp，errhp，OCI_DEFAULT）; while（1） <span class="italic">/ *等待回调* /</span> sleep（1）; } void initSubscriptionHn（subscrhp，subscriptionName，func）OCISubscription ** subscrhp; char * subscriptionName; dvoid * func; { <span class="italic">/ * allocate subscription handle：* /</span> （void）OCIHandleAlloc（（dvoid *）envhp，（dvoid **）subscrhp，（ub4）OCI_HTYPE_SUBSCRIPTION，（size_t）0，（dvoid **）0）; <span class="italic">/ *在句柄中设置订阅名称：* /</span> （void）OCIAttrSet（（dvoid *）* subscrhp，（ub4）OCI_HTYPE_SUBSCRIPTION，（dvoid *）subscriptionName，（ub4）strlen（（char *）subscriptionName），（ub4）OCI_ATTR_SUBSCR_NAME， errhp）; <span class="italic">/ *在句柄中设置回调函数：* /</span> （void）OCIAttrSet（（dvoid *）* subscrhp，（ub4）OCI_HTYPE_SUBSCRIPTION，（dvoid *）func，（ub4）0，（ub4）OCI_ATTR_SUBSCR_CALLBACK，errhp）; （void）OCIAttrSet（（dvoid *）* subscrhp，（ub4）OCI_HTYPE_SUBSCRIPTION，（dvoid *）0，（ub4）0，（ub4）OCI_ATTR_SUBSCR_CTX，errhp）; <span class="italic">/ *在句柄中设置名称空间：* /</span> （void）OCIAttrSet（（dvoid *）* subscrhp，（ub4）OCI_HTYPE_SUBSCRIPTION，（dvoid *）＆namespace，（ub4）0，（ub4）OCI_ATTR_SUBSCR_NAMESPACE，errhp）; checkerr（errhp，OCISubscriptionRegister（svchp，subscrhp，1，errhp，OCI_DEFAULT））; }</pre><p>如果用户<code class="codeph">HR</code>登录到数据库，则通知客户端，并调用回调函数<code class="codeph">notifySnoop</code> 。
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>