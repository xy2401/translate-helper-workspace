<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
      <title>执行RMAN恢复：高级方案</title>
      <meta property="og:site_name" content="Oracle Help Center"></meta>
      <meta property="og:title" content="Backup and Recovery User&#39;s Guide"></meta>
      <meta property="og:description" content=""></meta>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css"></link>
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico"></link>
      <meta name="application-name" content="Backup and Recovery User&#39;s Guide"></meta>
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)"></meta>
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2"></meta>
      <link rel="alternate" href="database-backup-and-recovery-users-guide.pdf" title="PDF File" type="application/pdf"></link>
      <meta name="robots" content="all"></meta>
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/"></link>
      <meta name="dcterms.created" content="2019-01-09T05:20:45-08:00"></meta>
      
      <meta name="dcterms.dateCopyrighted" content="2003, 2019"></meta>
      <meta name="dcterms.category" content="database"></meta>
      <meta name="dcterms.identifier" content="E96241-01"></meta>
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19"></meta>
      
      <link rel="prev" href="rman-block-media-recovery.html" title="Previous" type="text/html"></link>
      <link rel="next" href="performing-rman-tspitr.html" title="Next" type="text/html"></link>
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script src="/sp_common/book-template/requirejs/require.js" data-main="/sp_common/book-template/ohc-book-template/js/book-config"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="Database Backup and Recovery User&#39;s Guide"></meta>
    <meta name="dcterms.isVersionOf" content="BRADV"></meta>
    <meta name="dcterms.release" content="Release 19"></meta>
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="rman-block-media-recovery.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="performing-rman-tspitr.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">备份和恢复用户指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="part-diagnosing-responding-failures.html" property="item" typeof="WebPage"><span property="name">诊断和应对失败</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">执行RMAN恢复：高级方案</li>
            </ol>
            <a id="GUID-EA9DB3ED-2481-47DD-908B-A314D5C3F730" name="GUID-EA9DB3ED-2481-47DD-908B-A314D5C3F730"></a><a id="BRADV008"></a>
            
            <h2 id="BRADV-GUID-EA9DB3ED-2481-47DD-908B-A314D5C3F730" class="sect2"><span class="enumeration_chapter">20</span>执行RMAN恢复：高级方案</h2>
         </header>
         <div class="ind">
            <div>
               <p>“ <a href="part-diagnosing-responding-failures.html#GUID-ED89DC53-A816-450B-BFF4-A712D2694EEC">诊断和响应失败</a> ”的前几章涵盖了最基本的恢复方案，旨在尽可能通用。本章中的场景不太常见，或者比基本场景更复杂。
               </p>
               <p>本章包含以下主题：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="rman-recovery-advanced.html#GUID-18DC642E-DA14-47A9-9547-02F385CA47EA" title="您可以通过应用增量备份对在NOARCHIVELOG模式下运行的数据库执行有限的恢复恢复。增量备份必须一致，就像在NOARCHIVELOG模式下运行的数据库的所有备份一样，因此在打开数据库时无法对数据库进行备份。">使用增量备份恢复NOARCHIVELOG数据库</a></p>
                  </li>
                  <li>
                     <p><a href="rman-recovery-advanced.html#GUID-2B93E1AF-5ED1-4FAE-91BB-63362CADF7AD" title="RMAN可以将丢失的服务器参数文件还原到其默认位置或您选择的位置。与丢失控制文件不同，丢失服务器参数文件不会导致实例立即停止。实例可能会继续运行，但您必须将其关闭并在还原服务器参数文件后重新启动它。">恢复服务器参数文件</a></p>
                  </li>
                  <li>
                     <p><a href="rman-recovery-advanced.html#GUID-77C2B092-4BEB-4BAC-91F9-7368EA16A2B6" title="当所有当前控制文件都丢失时，您必须还原备份控制文件。">使用备份控制文件执行恢复</a></p>
                  </li>
                  <li>
                     <p><a href="rman-recovery-advanced.html#GUID-195E30B2-6077-446D-A255-089D3341268A" title="灾难恢复包括在丢失整个目标数据库，恢复目录数据库，所有当前控制文件，所有联机重做日志文件和所有参数文件后恢复和恢复目标数据库。">执行灾难恢复</a></p>
                  </li>
                  <li>
                     <p><a href="rman-recovery-advanced.html#GUID-6B71E7DF-A2B6-44F5-A8D5-B184BB41A768" title="使用RESTORE和RECOVER命令还原新主机上的数据库。当您要执行灾难恢复过程的测试运行或将数据库永久移动到新主机时，在新主机上还原数据库非常有用。">在新主机上还原数据库</a></p>
                  </li>
                  <li>
                     <p><a href="rman-recovery-advanced.html#GUID-8E64485B-3788-4389-A892-8C560F12443F" title="RMAN使您可以通过网络连接到包含所需文件的物理备用数据库来还原或恢复文件。您可以还原整个数据库，数据文件，控制文件，服务器参数文件或表空间。在需要同步主数据库和备用数据库的情况下，通过网络还原文件非常有用。">通过网络恢复和恢复文件</a></p>
                  </li>
               </ul>
            </div><a id="BRADV362"></a><a id="BRADV89841"></a><div class="props_rev_3"><a id="GUID-18DC642E-DA14-47A9-9547-02F385CA47EA" name="GUID-18DC642E-DA14-47A9-9547-02F385CA47EA"></a><h3 id="BRADV-GUID-18DC642E-DA14-47A9-9547-02F385CA47EA" class="sect3"><span class="enumeration_section">20.1</span>使用增量备份恢复NOARCHIVELOG数据库</h3>
               <div>
                  <p>您可以通过应用增量备份对在<code class="codeph">NOARCHIVELOG</code>模式下运行的数据库执行有限的恢复恢复。增量备份必须一致，就像在<code class="codeph">NOARCHIVELOG</code>模式下运行的数据库的所有备份一样，因此在打开数据库时无法对数据库进行备份。
                  </p>
                  <div class="section">
                     <p>恢复在<code class="codeph">NOARCHIVELOG</code>模式下运行的数据库与在<code class="codeph">ARCHIVELOG</code>模式下恢复数据库类似。主要区别是：</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <ul style="list-style-type:disc">
                        <li>
                           <p>在<code class="codeph">NOARCHIVELOG</code>模式下，只能使用一致的备份来恢复数据库。
                           </p>
                        </li>
                        <li>
                           <p>无法进行介质恢复，因为不存在归档重做日志。</p>
                        </li>
                     </ul>
                     <p>在恢复<code class="codeph">NOARCHIVELOG</code>数据库时，请在<code class="codeph">RECOVER</code>命令上指定<code class="codeph">NOREDO</code>选项，以指示RMAN不会尝试应用存档的重做日志。否则，RMAN返回错误。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p><span class="bold">要使用增量备份恢复NOARCHIVELOG数据库：</span></p>
                  </div>
                  <!-- class="section" -->
                  <ol>
                     <li class="stepexpand"><span>连接到目标数据库和恢复目录后，将数据库置于已装入状态：</span><div><pre class="oac_no_warn" dir="ltr">STARTUP FORCE MOUNT</pre></div>
                     </li>
                     <li class="stepexpand"><span>还原并恢复数据库。</span><div>
                           <p>例如，您可以使用以下命令执行不完全恢复：</p><pre class="oac_no_warn" dir="ltr">从TAG恢复数据库“consistent_whole_backup”; RECOVER DATABASE NOREDO;</pre></div>
                     </li>
                     <li class="stepexpand"><span>使用<code class="codeph">RESETLOGS</code>选项打开数据库。</span><div>
                           <p>例如，输入以下命令：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre></div>
                     </li>
                  </ol>
               </div>
            </div><a id="BRADV363"></a><a id="BRADV85339"></a><div class="props_rev_3"><a id="GUID-2B93E1AF-5ED1-4FAE-91BB-63362CADF7AD" name="GUID-2B93E1AF-5ED1-4FAE-91BB-63362CADF7AD"></a><h3 id="BRADV-GUID-2B93E1AF-5ED1-4FAE-91BB-63362CADF7AD" class="sect3"><span class="enumeration_section">20.2</span>恢复服务器参数文件</h3>
               <div>
                  <p>RMAN可以将丢失的服务器参数文件还原到其默认位置或您选择的位置。与丢失控制文件不同，丢失服务器参数文件不会导致实例立即停止。实例可能会继续运行，但您必须将其关闭并在还原服务器参数文件后重新启动它。</p>
                  <div class="section">
                     <p>还原服务器参数文件时，请注意以下注意事项：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>如果实例已使用服务器参数文件启动，则无法覆盖现有服务器参数文件。</p>
                        </li>
                        <li>
                           <p>使用客户端初始化参数文件启动实例时，如果还原命令中未使用<code class="codeph">TO</code>子句，RMAN会将服务器参数文件还原到缺省位置。默认位置是特定于平台的，例如， <code class="codeph">?</code>Linux上的<code class="codeph">/dbs/spfile.ora</code> 。
                           </p>
                        </li>
                        <li>
                           <p>恢复目录简化了恢复过程，因为您可以避免记录和记住DBID。此过程假定您<span class="italic">没有</span>使用恢复目录。
                           </p>
                        </li>
                     </ul>
                     <p><span class="bold">从自动备份恢复服务器参数文件：</span></p>
                  </div>
                  <!-- class="section" -->
                  <ol>
                     <li class="stepexpand"><span>启动RMAN并执行以下操作之一：</span><div>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>如果在丢失服务器参数文件时启动数据库实例，则连接到目标数据库。</p>
                              </li>
                              <li>
                                 <p>如果在服务器参数文件丢失时未启动数据库实例，并且未使用恢复目录，则运行<code class="codeph">SET DBID</code>命令以设置目标数据库的DBID。
                                 </p>
                              </li>
                           </ul>
                        </div>
                     </li>
                     <li class="stepexpand"><span>关闭数据库实例并重新启动它而不安装数据库。</span><div>
                           <p>当服务器参数文件不可用时，RMAN使用虚拟参数文件启动实例。例如，输入以下命令：</p><pre class="oac_no_warn" dir="ltr">STARTUP FORCE NOMOUNT;</pre></div>
                     </li>
                     <li class="stepexpand"><span>执行<code class="codeph">RUN</code>命令以恢复服务器参数文件。</span><div>
                           <p>根据具体情况，您可能需要在<code class="codeph">RUN</code>命令中执行多个命令。请注意以下注意事项：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>如果从磁带恢复，则使用<code class="codeph">ALLOCATE CHANNEL</code>手动分配SBT通道。如果从磁盘还原，则RMAN使用默认磁盘通道。
                                 </p>
                              </li>
                              <li>
                                 <p>如果未使用默认格式（ <code class="codeph">%F</code> ）生成自动备份，则使用<code class="codeph">SET CONTROLFILE AUTOBACKUP FOR DEVICE TYPE</code>命令指定执行自动备份时生效的格式。
                                 </p>
                              </li>
                              <li>
                                 <p>如果今天未创建最新的自动备份，则使用<code class="codeph">SET UNTIL</code>指定开始搜索的日期。
                                 </p>
                              </li>
                              <li>
                                 <p>如果RMAN未连接到恢复目录，则使用<code class="codeph">SET DBID</code>设置目标数据库的DBID。
                                 </p>
                              </li>
                              <li>
                                 <p>要将服务器参数文件还原到非缺省位置，请在<code class="codeph">RESTORE SPFILE</code>命令上指定<code class="codeph">TO</code>子句或<code class="codeph">TO PFILE</code>子句。
                                 </p>
                              </li>
                              <li>
                                 <p>如果您知道RMAN每天不会生成超过<span class="italic">n次</span>自动备份，那么您可以设置<code class="codeph">RESTORE SPFILE FROM AUTOBACKUP ...MAXSEQ</code>参数为<span class="italic">n</span>减少搜索时间。<code class="codeph">MAXSEQ</code>默认设置为255， <code class="codeph">RESTORE</code>从<code class="codeph">MAXSEQ</code>向后计数以查找当天的最后一个备份。要在当天（或指定日期）找不到自动备份时终止还原操作，请在<code class="codeph">RESTORE</code>命令中设置<code class="codeph">MAXDAYS 1</code> 。
                                 </p>
                              </li>
                           </ul>
                           <p>以下示例说明了从磁带上的自动备份恢复服务器参数文件的<code class="codeph">RUN</code>命令：</p><pre class="oac_no_warn" dir="ltr">运行{ALLOCATE CHANNEL c1设备类型sbt PARMS ...;设置时间'SYSDATE-7';设备类型的SET CONTROLFILE AUTOBACKUP格式sbt为'/ disk1 / control_files / autobackup_％F'; SET DBID 123456789;从AUTOBACKUP MAXDAYS 10恢复SPFILE到'/tmp/spfileTEMP.ora'; }</pre></div>
                     </li>
                     <li class="stepexpand"><span>使用还原的文件重新启动数据库实例。</span><div>
                           <p>如果要在非缺省位置使用服务器参数文件重新启动RMAN，请使用行<code class="codeph">SPFILE=</code> <span class="italic"><code class="codeph">new_location</code></span>创建初始化参数文件，其中<span class="italic"><code class="codeph">new_location</code></span>是已还原服务器参数文件的路径名。然后，使用客户端初始化参数文件重新启动实例。
                           </p>
                           <p>例如，创建一个包含单行的文件<code class="codeph">/tmp/init.ora</code> ：</p><pre class="oac_no_warn" dir="ltr">SPFILE = / TMP / spfileTEMP.ora</pre><p>您可以使用以下RMAN命令使用还原的服务器参数文件重新启动实例：</p><pre class="oac_no_warn" dir="ltr">STARTUP FORCE PFILE = / tmp / init.ora;</pre></div>
                     </li>
                  </ol>
                  <div class="section">
                     <div class="infoboxnotealso" id="GUID-2B93E1AF-5ED1-4FAE-91BB-63362CADF7AD__GUID-682AAC78-47F6-4F67-BA49-09F6BDD6D0B7">
                        <p class="notep1">也可以看看：</p>
                        <p><span class="q">“ <a href="rman-complete-database-recovery.html#GUID-34BB2E4B-B2FC-4701-BB65-BFED027DB865" title="建议您记录数据库的DBID。">确定数据库的DBID</a> ”</span>以获取有关确定DBID的详细信息</p>
                     </div>
                  </div>
                  <!-- class="section" -->
               </div><a id="BRADV364"></a><a id="BRADV89829"></a><div class="props_rev_3"><a id="GUID-8077F97F-76A7-49DC-8C1E-5FE8ADD0914F" name="GUID-8077F97F-76A7-49DC-8C1E-5FE8ADD0914F"></a><h4 id="BRADV-GUID-8077F97F-76A7-49DC-8C1E-5FE8ADD0914F" class="sect4"><span class="enumeration_section">20.2.1</span>从控制文件自动<span class="enumeration_section">备份</span>恢复服务器参数文件</h4>
                  <div>
                     <p>如果已配置控制文件自动备份，则只要执行自动备份，就会使用控制文件备份服务器参数文件。</p>
                     <div class="section">
                        <p><span class="bold">要从控制文件autobackup恢复服务器参数文件：</span></p>
                        <ol>
                           <li>
                              <p>设置数据库的DBID。</p>
                           </li>
                           <li>
                              <p>使用<code class="codeph">RESTORE SPFILE FROM AUTOBACKUP</code>命令。
                              </p>
                              <p>如果自动备份是非默认格式，则首先使用<code class="codeph">SET CONTROLFILE AUTOBACKUP FORMAT</code>命令指定格式。
                              </p>
                           </li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                     <div class="example" id="GUID-8077F97F-76A7-49DC-8C1E-5FE8ADD0914F__CHDCEIII">
                        <p class="titleinexample">示例20-1从控制文件自动备份恢复服务器参数文件</p>
                        <p>此示例设置DBID并从非默认位置的控制文件自动备份中恢复服务器参数文件。RMAN使用自动备份格式和DBID来搜索控制文件自动备份。如果找到控制文件自动备份，则RMAN将服务器参数文件从该备份还原到其默认位置。</p><pre class="oac_no_warn" dir="ltr">SET DBID 320066378;为设备类型磁盘运行{SET CONTROLFILE AUTOBACKUP格式为' <span class="italic">autobackup_format</span> ';从AUTOBACKUP恢复SPFILE; }</pre></div>
                     <!-- class="example" -->
                     <div class="section">
                        <div class="infoboxnotealso" id="GUID-8077F97F-76A7-49DC-8C1E-5FE8ADD0914F__GUID-97387305-9495-4D48-823C-6E189A2F5018">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>“ <a href="../rcmrf/CONFIGURE.html#RCMRF113" target="_blank"><span><cite>Oracle数据库备份和恢复参考</cite></span></a> ”中<code class="codeph">CONFIGURE</code>命令条目中的<code class="codeph">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT</code>说明，了解如何为<code class="codeph"><span class="codeinlineitalic">autobackup_format</span></code>确定正确的值</p>
                              </li>
                              <li>
                                 <p><span class="q">“ <a href="rman-complete-database-recovery.html#GUID-34BB2E4B-B2FC-4701-BB65-BFED027DB865" title="建议您记录数据库的DBID。">确定数据库的DBID</a> ”</span>以获取有关如何确定DBID的详细信息</p>
                              </li>
                           </ul>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="BRADV89830"></a><div class="props_rev_3"><a id="GUID-AE7CD28F-3187-44DD-BEC2-E43839EC63E6" name="GUID-AE7CD28F-3187-44DD-BEC2-E43839EC63E6"></a><h4 id="BRADV-GUID-AE7CD28F-3187-44DD-BEC2-E43839EC63E6" class="sect4"><span class="enumeration_section">20.2.2</span>使用RMAN创建初始化参数文件</h4>
                  <div>
                     <p>您也可以恢复服务器参数文件作为与客户端的初始化参数文件<code class="codeph">TO PFILE ' <span class="codeinlineitalic">filename</span> '</code>的条款。
                     </p>
                     <div class="section">
                        <p>您指定的文件名必须位于可从运行RMAN客户端的主机访问的文件系统上。无需直接从运行实例的主机访问此文件。</p>
                        <p>以下RMAN命令在运行RMAN客户端的系统上创建名为<code class="codeph">/tmp/initTEMP.ora</code>的初始化参数文件：</p><pre class="oac_no_warn" dir="ltr">恢复SPFILE到PFILE'/tmp/initTEMP.ora';</pre><p>要使用初始化参数文件重新启动实例，请使用以下命令，再次在同一客户端主机上运行RMAN：</p><pre class="oac_no_warn" dir="ltr">STARTUP FORCE PFILE ='/ tmp / initTEMP.ora';</pre></div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="BRADV154"></a><div class="props_rev_3"><a id="GUID-77C2B092-4BEB-4BAC-91F9-7368EA16A2B6" name="GUID-77C2B092-4BEB-4BAC-91F9-7368EA16A2B6"></a><h3 id="BRADV-GUID-77C2B092-4BEB-4BAC-91F9-7368EA16A2B6" class="sect3"><span class="enumeration_section">20.3</span>使用备份控制文件执行恢复</h3>
               <div>
                  <p>当所有当前控制文件都丢失时，您必须还原备份控制文件。</p>
                  <p>本节包含以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-7B78C0E8-423A-4BE0-88D5-AB903DB49608" title="如果当前控制文件的所有副本都丢失或损坏，则必须还原并装入备份控制文件。然后，您必须运行RECOVER命令，即使没有还原数据文件，也可以使用RESETLOGS选项打开数据库。">关于使用备份控制文件进行恢复</a></p>
                     </li>
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-927C5614-DC12-4B58-B261-EBD5F08A4202" title="使用备份控制文件恢复数据库，如果未使用恢复目录，则需要从自动备份还原控制文件。">使用备份控制文件和无恢复目录执行恢复</a></p>
                     </li>
                  </ul>
               </div><a id="BRADV89834"></a><div class="props_rev_3"><a id="GUID-7B78C0E8-423A-4BE0-88D5-AB903DB49608" name="GUID-7B78C0E8-423A-4BE0-88D5-AB903DB49608"></a><h4 id="BRADV-GUID-7B78C0E8-423A-4BE0-88D5-AB903DB49608" class="sect4"><span class="enumeration_section">20.3.1</span>关于使用备份控制文件进行恢复</h4>
                  <div>
                     <p>如果当前控制文件的所有副本都丢失或损坏，则必须还原并装入备份控制文件。然后，您必须运行<code class="codeph">RECOVER</code>命令，即使没有还原数据文件，也可以使用<code class="codeph">RESETLOGS</code>选项打开数据库。
                     </p>
                     <p>在恢复期间，RMAN会自动搜索未记录在RMAN存储库中的联机和归档日志，并对其找到的任何目录进行编目。RMAN尝试使用当前日志格式在任何当前归档目标中查找有效的归档重做日志。当前格式在用于启动实例的初始化参数文件（或Oracle RAC配置中的所有实例）中指定。同样，RMAN尝试使用控制文件中列出的文件名来查找联机重做日志。</p>
                     <p>如果在恢复期间更改了归档目标或格式，或者在备份控制文件后添加了新的联机日志成员，则RMAN可能无法自动编录所需的联机或归档日志。只要RMAN无法找到联机重做日志并且您未指定<code class="codeph">UNTIL</code>时间，RMAN就会报告类似于以下内容的错误：</p><pre class="oac_no_warn" dir="ltr">RMAN-00571：============================================== ============= RMAN-00569：===============错误信息堆栈跟踪============== = RMAN-00571：============================================= ============== RMAN-03002：恢复命令失败于08/29/2013 14:23:09 RMAN-06054：媒体恢复请求未知日志：thread 1 scn 86945</pre><p>在这种情况下，必须使用<code class="codeph">CATALOG</code>命令手动将所需的重做日志添加到存储库，以便可以继续进行恢复。
                     </p>
                     <div class="infoboxnote" id="GUID-7B78C0E8-423A-4BE0-88D5-AB903DB49608__GUID-4A57B8F8-D63B-41C6-8988-A530E79810CC">
                        <p class="notep1">注意：</p>
                        <p>但是，如果当前控制文件的某些副本可用，则可以按照<span class="q">“ <a href="user-managed-recovery-advanced.html#GUID-22AD5382-06ED-4FDF-BDD4-C8CD682F83E0">响应当前控制文件的子集丢失</a> ”中</span>的过程进行操作，并避免恢复和<code class="codeph">RESETLOGS</code>操作。
                        </p>
                     </div>
                     <div class="infoboxnotealso" id="GUID-7B78C0E8-423A-4BE0-88D5-AB903DB49608__GUID-7B4AEE7B-AFC2-4270-9FE2-89B78BD8312C">
                        <p class="notep1">也可以看看：</p>
                        <p>的讨论<code class="codeph">RESTORE CONTROLFILE</code>在<a href="../rcmrf/RESTORE.html#RCMRF149" target="_blank"><span><cite>Oracle数据库的备份和恢复参考</cite></span></a>有关使用限制的详细细节<code class="codeph">RESTORE CONTROLFILE</code>在不同的场景（例如，使用恢复目录时，或从一个特定的备份中恢复）</p>
                     </div>
                  </div><a id="BRADV89835"></a><div class="props_rev_3"><a id="GUID-64F583E8-2E1A-4F13-847B-5FCEFA9E008A" name="GUID-64F583E8-2E1A-4F13-847B-5FCEFA9E008A"></a><h5 id="BRADV-GUID-64F583E8-2E1A-4F13-847B-5FCEFA9E008A" class="sect5"><span class="enumeration_section">20.3.1.1</span>关于RMAN还原期间的控制文件位置</h5>
                     <div>
                        <p>还原控制文件时，默认目标是<code class="codeph">CONTROL_FILES</code>初始化参数中定义的所有位置。如果未设置<code class="codeph">CONTROL_FILES</code>初始化参数，则数据库使用相同的规则来确定在未设置<code class="codeph">CONTROL_FILES</code>参数时创建控制文件时它使用的还原控制文件的目标。
                        </p>
                        <p>将控制文件还原到一个或多个新位置的一种方法是更改<code class="codeph">CONTROL_FILES</code>初始化参数，然后使用不带参数的<code class="codeph">RESTORE CONTROLFILE</code>命令将控制文件还原到默认位置。例如，如果在磁盘发生故障后恢复控制文件，但某些但不是所有<code class="codeph">CONTROL_FILES</code>位置都不可用，则可以更改<code class="codeph">CONTROL_FILES</code>以使用指向另一个磁盘的路径名替换对故障磁盘的引用，然后运行不带参数的<code class="codeph">RESTORE CONTROLFILE</code> 。
                        </p>
                        <p>您还可以还原控制文件到您选择以外的任何位置<code class="codeph">CONTROL_FILES</code>位置，通过形式<code class="codeph">RESTORE CONTROLFILE TO ' <span class="codeinlineitalic">filename</span> '</code> ：</p><pre class="oac_no_warn" dir="ltr">将CONTROLFILE恢复为'/ tmp / my_controlfile';</pre><p>您可以在<code class="codeph">NOMOUNT</code> ， <code class="codeph">MOUNT</code>或<code class="codeph">OPEN</code>状态下对数据库执行此操作，因为您不会覆盖当前正在使用的任何控制文件。任何名为<code class="codeph">' <span class="codeinlineitalic">filename</span> '</code>现有文件都将被覆盖。将控制文件还原到新位置后，可以更新<code class="codeph">CONTROL_FILES</code>初始化参数以包含新位置。
                        </p>
                        <div class="infoboxnotealso" id="GUID-64F583E8-2E1A-4F13-847B-5FCEFA9E008A__GUID-D28E208B-1670-4B52-AFA2-6A4D9153A519">
                           <p class="notep1">也可以看看：</p>
                           <ul style="list-style-type:disc">
                              <li>
                                 <p>“ <a href="../sqlrf/CREATE-CONTROLFILE.html#SQLRF01203" target="_blank"><span><cite>Oracle数据库SQL语言参考”</cite></span></a>中的<code class="codeph">CREATE CONTROLFILE</code>语句的说明，用于确定已还原控制文件的目标的规则</p>
                              </li>
                              <li>
                                 <p>适用于<code class="codeph">RESTORE CONTROLFILE</code>语法的<a href="../rcmrf/RESTORE.html#RCMRF149" target="_blank"><span><cite>Oracle数据库备份和恢复参考</cite></span></a></p>
                              </li>
                           </ul>
                        </div>
                     </div>
                  </div><a id="BRADV365"></a><a id="BRADV89836"></a><div class="props_rev_3"><a id="GUID-FE57B2EA-428A-4408-BBB5-D9392D6B0F8B" name="GUID-FE57B2EA-428A-4408-BBB5-D9392D6B0F8B"></a><h5 id="BRADV-GUID-FE57B2EA-428A-4408-BBB5-D9392D6B0F8B" class="sect5"><span class="enumeration_section">20.3.1.2</span>关于使用和不使用恢复目录的RMAN恢复</h5>
                     <div>
                        <p>恢复控制文件的过程取决于是否使用了恢复目录。</p>
                        <p>当RMAN连接到恢复目录时，具有备份控制文件的恢复过程与使用当前控制文件的恢复相同。备份控制文件中缺少的RMAN元数据可从恢复目录中获得。唯一的例外是数据库名称在目录中不唯一，在这种情况下，必须在还原控制文件之前使用<code class="codeph">SET DBID</code>命令。
                        </p>
                        <p>如果您没有使用恢复目录，则必须从自动备份恢复控制文件。要从自动备份还原控制文件，数据库必须处于<code class="codeph">NOMOUNT</code>状态。您必须首先为数据库设置DBID，然后使用<code class="codeph">RESTORE CONTROLFILE FROM AUTOBACKUP</code>命令。
                        </p>
                        <div class="example" id="GUID-FE57B2EA-428A-4408-BBB5-D9392D6B0F8B__CHDBHDJD">
                           <p class="titleinexample">示例20-2设置DBID并从自动备份恢复控制文件</p>
                           <p>在此示例中，RMAN使用自动备份格式和DBID来确定控制文件自动备份的位置。如果找到一个，RMAN会将控制文件还原到<code class="codeph">CONTROL_FILES</code>初始化参数中列出的所有控制文件位置。
                           </p><pre class="oac_no_warn" dir="ltr">SET DBID 320066378;为设备类型磁盘运行{SET CONTROLFILE AUTOBACKUP格式为' <span class="italic">autobackup_format</span> ';从AUTOBACKUP恢复CONTROLFILE; }</pre><div class="infoboxnotealso" id="GUID-FE57B2EA-428A-4408-BBB5-D9392D6B0F8B__GUID-32787659-7CD3-492F-9608-62A17F77338F">
                              <p class="notep1">也可以看看：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p><span class="q">“ <a href="rman-complete-database-recovery.html#GUID-34BB2E4B-B2FC-4701-BB65-BFED027DB865" title="建议您记录数据库的DBID。">确定数据库的DBID</a> ”</span>以了解如何确定您的DBID</p>
                                 </li>
                                 <li>
                                    <p>“ <a href="../rcmrf/CONFIGURE.html#RCMRF113" target="_blank"><span><cite>Oracle数据库备份和恢复参考”中“</cite></span></a> <code class="codeph">CONFIGURE</code> ”条目中的“ <code class="codeph">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT</code> ”说明，了解如何确定自动备份格式的正确值</p>
                                 </li>
                              </ul>
                           </div>
                        </div>
                        <!-- class="example" -->
                     </div>
                  </div><a id="BRADV89837"></a><div class="props_rev_3"><a id="GUID-918B5EE1-DBE9-464E-B8F9-454E1F94136A" name="GUID-918B5EE1-DBE9-464E-B8F9-454E1F94136A"></a><h5 id="BRADV-GUID-918B5EE1-DBE9-464E-B8F9-454E1F94136A" class="sect5"><span class="enumeration_section">20.3.1.3</span>使用快速恢复区时关于RMAN恢复</h5>
                     <div>
                        <p>无论数据库是否使用快速恢复区域，恢复控制文件的命令都是相同的。</p>
                        <p>如果数据库使用快速恢复区域，则RMAN会通过交叉检查控制文件中记录的所有基于磁盘的备份和映像副本来更新从备份还原的控制文件。RMAN会对恢复区中未记录的任何备份进行编目。因此，还原的控制文件可以完整准确地记录恢复区中的所有备份以及备份时控制文件已知的任何其他备份。</p>
                        <p>恢复控制文件后，RMAN不会自动交叉检查磁带备份。如果使用磁带备份，则可以还原并装入控制文件，并可选择交叉检查磁带上的备份，如以下示例所示：</p><pre class="oac_no_warn" dir="ltr">CROSSCHECK BACKUP DEVICE TYPE sbt;</pre></div>
                  </div>
               </div><a id="BRADV366"></a><a id="BRADV89838"></a><div class="props_rev_3"><a id="GUID-927C5614-DC12-4B58-B261-EBD5F08A4202" name="GUID-927C5614-DC12-4B58-B261-EBD5F08A4202"></a><h4 id="BRADV-GUID-927C5614-DC12-4B58-B261-EBD5F08A4202" class="sect4"><span class="enumeration_section">20.3.2</span>使用备份控制文件和无恢复目录执行恢复</h4>
                  <div>
                     <p>使用备份控制文件恢复数据库，如果未使用恢复目录，则需要从自动备份还原控制文件。</p>
                     <div class="section">
                        <p>本节假定您具有控制文件的RMAN备份，但不使用恢复目录。它还假定您为目标数据库启用了控制文件自动备份功能，并可以恢复控制文件的自动备份。</p>
                        <p>由于自动备份使用众所周知的格式，因此即使RMAN没有可用的列表可用备份的存储库，也可以将其还原。您可以将自动备份还原到默认位置或新位置。RMAN自动将控制文件复制到所有<code class="codeph">CONTROL_FILES</code>位置。
                        </p>
                        <div class="infoboxnote" id="GUID-927C5614-DC12-4B58-B261-EBD5F08A4202__GUID-8697184C-FD28-4DD8-AACE-EA08B73F576D">
                           <p class="notep1">注意：</p>
                           <p>如果您知道包含控制文件（例如，从媒体经理或因为一块是在磁盘上）的备份片的名字，那么你可以使用指定作品名称<code class="codeph">RESTORE CONTROLFILE FROM ' <span class="codeinlineitalic">filename</span> '</code>命令。数据库记录警报日志中每个自动备份的位置。
                           </p>
                        </div>
                        <p>由于您未连接到恢复目录，因此RMAN存储库仅包含有关控制文件备份时可用备份的信息。如果您知道其他可用备份集或映像副本的位置，请使用<code class="codeph">CATALOG</code>命令将它们添加到控制文件RMAN存储库中。
                        </p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p><span class="bold">要在<code class="codeph">NOCATALOG</code>模式下使用控制文件自动<code class="codeph">NOCATALOG</code>恢复数据库：</span></p>
                        <ol>
                           <li>
                              <p>启动RMAN并连接到目标数据库，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。
                              </p>
                           </li>
                           <li>
                              <p>启动目标数据库实例而不安装数据库。例如：</p><pre class="oac_no_warn" dir="ltr">启动NOMOUNT;</pre></li>
                           <li>
                              <p>使用<code class="codeph">SET DBID</code>命令<code class="codeph">SET DBID</code>目标数据库的数据库标识符。
                              </p>
                              <p>每当连接到目标数据库时，RMAN都会显示DBID。您还可以通过检查已保存的RMAN日志文件，查询目录或查看控制文件自动备份的文件名来获取它。例如，运行：</p><pre class="oac_no_warn" dir="ltr">SET DBID 676549873;</pre></li>
                           <li>
                              <p>编写RMAN命令文件以还原自动备份控制文件并执行恢复。</p>
                              <p>命令文件包含以下步骤：</p>
                              <ol type="a">
                                 <li>
                                    <p>（可选）指定RMAN在搜索要还原的控制文件自动备份时可以使用的最新备份时间戳。</p>
                                 </li>
                                 <li>
                                    <p>如果在创建控制文件自动备份时知道其他控制文件自动备份格式有效，则为恢复控制文件指定非默认格式。</p>
                                 </li>
                                 <li id="GUID-927C5614-DC12-4B58-B261-EBD5F08A4202__CHDIDAIJ">
                                    <p>如果<a href="glossary.html#GUID-2E48CE71-9547-4196-B715-5CE59033262E"><span class="xrefglossterm">SBT</span></a>通道创建了控制文件自动备份，则分配一个或多个SBT通道。由于没有可用的恢复目录，因此无法使用预配置的通道。
                                    </p>
                                 </li>
                                 <li>
                                    <p>恢复控制文件的自动备份，可选择设置RMAN可以搜索的最大后退天数以及它在搜索第一天时使用的初始序列号。</p>
                                 </li>
                                 <li>
                                    <p>如果您知道控制文件包含有关在其余恢复过程中对您有用的已配置通道的信息，则可以退出RMAN以清除步骤<a href="rman-recovery-advanced.html#GUID-927C5614-DC12-4B58-B261-EBD5F08A4202__CHDIDAIJ">4.c中</a>手动分配的通道。
                                    </p>
                                    <p>如果重新启动RMAN客户端并装入数据库，则可以使用这些已配置的通道。如果您不关心使用控制文件中的已配置通道，则只需安装数据库即可。</p>
                                 </li>
                                 <li>
                                    <p>此步骤取决于联机重做日志是否可用。无论日志是否可用，使用备份控制文件恢复后，始终需要<code class="codeph">OPEN RESETLOGS</code>选项。
                                    </p>
                                    <p>如果联机重做日志可用，则RMAN可以查找并应用这些日志。按照<span class="q">“ <a href="rman-complete-database-recovery.html#GUID-5E09344A-76D0-4188-A39D-CBA07F0B5C25" title="在完全恢复期间，RMAN将还原一个或多个数据文件，然后应用还原备份后生成的所有重做。">执行完整数据库恢复</a> ”中的说明</span>执行完整的还原和恢复。
                                    </p>
                                    <p>如果联机重做日志不可用，则按<span class="q">“ <a href="rman-performing-flashback-dbpitr.html#GUID-7D3EE2F7-77A2-4264-8875-CC0AEC64ABE0" title="RMAN DBPITR在目标恢复时间之前从备份还原数据库，然后使用增量备份和重做将数据库前滚到目标时间。您可以恢复到SCN，时间，日志序列号或还原点。Oracle建议您在重要时间创建还原点，以便在必要时使时间点恢复更易于管理。">执行数据库时间点恢复</a> ”中的说明</span>执行DBPITR。需要<code class="codeph">UNTIL</code>子句来指定在线重做日志的第一个SCN之前的恢复的目标时间，SCN或日志序列号（否则，RMAN会发出<code class="codeph">RMAN-6054</code>错误）。
                                    </p>
                                    <p>使用备份控制文件执行DBPITR时，在使用<code class="codeph">RESETLOGS</code>打开数据库之前，可以使用SQL * Plus以只读方式打开数据库，并根据需要运行查询以验证逻辑损坏的影响是否已被撤消。如果您对结果满意，则可以使用<code class="codeph">RESETLOGS</code>打开数据库。</p>
                                    <div class="infoboxnote" id="GUID-927C5614-DC12-4B58-B261-EBD5F08A4202__GUID-96220562-6887-4750-ACD6-8DD4C0E8211B">
                                       <p class="notep1">注意：</p>
                                       <p>指定日志序列时，如果最后创建的归档重做日志具有序列<span class="italic">n</span> ，则指定<code class="codeph">UNTIL SEQUENCE <span class="codeinlineitalic">n</span> +1</code>以便RMAN应用<span class="italic">n</span>然后停止。
                                       </p>
                                    </div>
                                 </li>
                              </ol>
                              <p>在以下示例中，联机重做日志文件已丢失，最新的归档重做日志序列号为13243。此示例显示如何还原控制文件自动备份并通过最新日志进行恢复。</p><pre class="oac_no_warn" dir="ltr">RUN {＃或者，设置控制文件的合格时间戳上限＃backups＃SET UNTIL TIME '09 / 10/2017 13:45:00'; ＃仅在需要时指定非默认自动备份格式#SET CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK＃TO'？/oradata/%F.bck'; ALLOCATE CHANNEL c1设备类型sbt PARMS'...'; ＃手动分配RESTORE CONTROLFILE来自AUTOBACKUP MAXSEQ 100＃从序列100开始并倒计时MAXDAYS 180; ＃从UNTIL TIME开始并搜索6个月ALTER DATABASE MOUNT; }＃现在使用在恢复的控制文件中配置的自动通道RESTORE DATABASE UNTIL SEQUENCE 13244;恢复数据库直到序列13244;</pre></li>
                           <li>
                              <p>如果恢复成功，则打开数据库并重置联机日志：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="BRADV156"></a><div class="props_rev_3"><a id="GUID-195E30B2-6077-446D-A255-089D3341268A" name="GUID-195E30B2-6077-446D-A255-089D3341268A"></a><h3 id="BRADV-GUID-195E30B2-6077-446D-A255-089D3341268A" class="sect3"><span class="enumeration_section">20.4</span>执行灾难恢复</h3>
               <div>
                  <p>灾难恢复包括在丢失整个目标数据库，恢复目录数据库，所有当前控制文件，所有联机重做日志文件和所有参数文件后恢复和恢复目标数据库。</p>
                  <p>本节包含以下主题：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-DC3C8F0E-403C-4AE4-BCD9-17A0812B9D13" title="在使用RMAN执行灾难恢复之前，必须满足某些先决条件。">灾难恢复的先决条件</a></p>
                     </li>
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-8A4F7C00-AA51-48DB-BEF7-FA16B132E1D9" title="假设运行数据库的Linux服务器已经损坏，无法修复。幸运的是，您将数据库备份到Oracle Secure Backup并使磁带可用。您可以使用这些备份来恢复数据库。">灾难发生后恢复数据库</a></p>
                     </li>
                  </ul>
               </div><a id="BRADV89839"></a><div class="props_rev_3"><a id="GUID-DC3C8F0E-403C-4AE4-BCD9-17A0812B9D13" name="GUID-DC3C8F0E-403C-4AE4-BCD9-17A0812B9D13"></a><h4 id="BRADV-GUID-DC3C8F0E-403C-4AE4-BCD9-17A0812B9D13" class="sect4"><span class="enumeration_section">20.4.1</span>灾难恢复的先决条件</h4>
                  <div>
                     <p>在使用RMAN执行灾难恢复之前，必须满足某些先决条件。</p>
                     <p>您必须具备以下条件：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>备份所有数据文件</p>
                        </li>
                        <li>
                           <p>在您要恢复的最旧备份的创建时间之后生成的所有归档重做日志</p>
                        </li>
                        <li>
                           <p>至少一个控制文件自动备份</p>
                        </li>
                        <li>
                           <p>数据库的DBID记录</p>
                        </li>
                     </ul>
                  </div>
               </div><a id="BRADV367"></a><a id="BRADV89840"></a><div class="props_rev_3"><a id="GUID-8A4F7C00-AA51-48DB-BEF7-FA16B132E1D9" name="GUID-8A4F7C00-AA51-48DB-BEF7-FA16B132E1D9"></a><h4 id="BRADV-GUID-8A4F7C00-AA51-48DB-BEF7-FA16B132E1D9" class="sect4"><span class="enumeration_section">20.4.2</span>灾难后恢复数据库</h4>
                  <div>
                     <p>假设运行数据库的Linux服务器已经损坏，无法修复。幸运的是，您将数据库备份到Oracle Secure Backup并使磁带可用。您可以使用这些备份来恢复数据库。</p>
                     <div class="section">
                        <p>灾难恢复的过程类似于在<code class="codeph">NOCATALOG</code>模式下使用备份控制文件恢复数据库的过程。如果要将数据库还原到新主机，请查看<span class="q">“ <a href="rman-recovery-advanced.html#GUID-6B71E7DF-A2B6-44F5-A8D5-B184BB41A768" title="使用RESTORE和RECOVER命令还原新主机上的数据库。当您要执行灾难恢复过程的测试运行或将数据库永久移动到新主机时，在新主机上还原数据库非常有用。">在新主机上还原数据库</a> ”中</span>描述的注意事项。
                        </p>
                        <p>。该方案假设如下：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>Oracle数据库安装在新主机上。</p>
                           </li>
                           <li>
                              <p>您正在将数据库还原到具有与旧主机相同的目录结构的新Linux主机。</p>
                           </li>
                           <li>
                              <p>您有一个磁带驱动器包含所有数据文件的备份和通过日志1124的归档重做日志，以及控制文件和服务器参数文件的自动备份。</p>
                           </li>
                           <li>
                              <p>您不对数据库使用恢复目录。</p>
                           </li>
                        </ul>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p class="subhead3" id="GUID-8A4F7C00-AA51-48DB-BEF7-FA16B132E1D9__GUID-B3CF5EEF-9D36-4EB0-93CE-B05EB8307F58">要在新主机上恢复数据库：</p>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <ol>
                           <li>
                              <p>确保满足<span class="q">“ <a href="rman-recovery-advanced.html#GUID-DC3C8F0E-403C-4AE4-BCD9-17A0812B9D13" title="Certain prerequisites must be met before you perform disaster recovery using RMAN.">灾难恢复</a></span>的先决条件”中描述的<span class="q"><a href="rman-recovery-advanced.html#GUID-DC3C8F0E-403C-4AE4-BCD9-17A0812B9D13" title="在使用RMAN执行灾难恢复之前，必须满足某些先决条件。">先决条件</a></span> 。
                              </p>
                           </li>
                           <li>
                              <p>如果可能，请还原或重新创建所有相关的网络文件，例如<code class="codeph">tnsnames.ora</code>和<code class="codeph">listener.ora</code>以及密码文件。
                              </p>
                           </li>
                           <li>
                              <p>启动RMAN并连接到目标数据库实例，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。
                              </p>
                              <p>在此阶段，不存在初始化参数文件。如果已设置<code class="codeph">ORACLE_SID</code>和<code class="codeph">ORACLE_HOME</code> ，则可以使用操作系统身份验证以<code class="codeph">SYSDBA</code>或<code class="codeph">SYSBACKUP</code>身份进行连接。</p>
                           </li>
                           <li>
                              <p>使用<code class="codeph">SET</code> <code class="codeph">DBID</code>命令指定目标数据库的<code class="codeph">DBID</code> ，如<span class="q">“ <a href="rman-recovery-advanced.html#GUID-2B93E1AF-5ED1-4FAE-91BB-63362CADF7AD" title="RMAN可以将丢失的服务器参数文件还原到其默认位置或您选择的位置。与丢失控制文件不同，丢失服务器参数文件不会导致实例立即停止。实例可能会继续运行，但您必须将其关闭并在还原服务器参数文件后重新启动它。">恢复服务器参数文件</a> ”中所述</span> 。
                              </p>
                              <p>例如，输入以下命令：</p><pre class="oac_no_warn" dir="ltr">SET DBID 676549873;</pre></li>
                           <li>
                              <p>运行<code class="codeph">STARTUP NOMOUNT</code>命令。
                              </p>
                              <p>当服务器参数文件不可用时，RMAN会尝试使用虚拟服务器参数文件启动实例。</p>
                           </li>
                           <li>
                              <p>将通道分配给介质管理器，然后从自动备份还原服务器参数文件。</p>
                              <p>例如，输入以下命令以从Oracle Secure Backup还原服务器参数文件：</p><pre class="oac_no_warn" dir="ltr">RUN {ALLOCATE CHANNEL c1 DEVICE TYPE sbt;从AUTOBACKUP恢复SPFILE; }</pre></li>
                           <li>
                              <p>使用还原的服务器参数文件重新启动实例。</p><pre class="oac_no_warn" dir="ltr">STARTUP FORCE NOMOUNT;</pre></li>
                           <li>
                              <p>编写命令文件以执行还原和恢复操作，然后执行命令文件。命令文件必须执行以下操作：</p>
                              <ol type="a">
                                 <li>
                                    <p>将频道分配给媒体管理器。</p>
                                 </li>
                                 <li>
                                    <p>还原控制文件自动备份（请参阅<span class="q">“ <a href="rman-recovery-advanced.html#GUID-927C5614-DC12-4B58-B261-EBD5F08A4202" title="使用备份控制文件恢复数据库，如果未使用恢复目录，则需要从自动备份还原控制文件。">使用备份控制文件和无恢复目录执行恢复</a> ”</span> ）。
                                    </p>
                                 </li>
                                 <li>
                                    <p>装入已还原的控制文件。</p>
                                 </li>
                                 <li>
                                    <p>使用<code class="codeph">CATALOG</code>命令编目未记录在存储库中的任何备份。
                                    </p>
                                 </li>
                                 <li>
                                    <p>将数据文件还原到其原始位置。如果卷名已更改，则在还原操作之前运行<code class="codeph">SET</code> <code class="codeph">NEWNAME</code>命令，并在还原操作后执行切换以使用数据文件的新位置更新控制文件，如以下示例所示。
                                    </p>
                                 </li>
                                 <li>
                                    <p>恢复数据文件。RMAN在达到指定的日志序列号时停止恢复。</p>
                                 </li>
                              </ol><pre class="oac_no_warn" dir="ltr">RMAN&gt; RUN {＃手动为媒体管理器分配一个频道ALLOCATE CHANNEL t1 DEVICE TYPE sbt; ＃恢复控制文件的自动备份。此示例假定您已接受＃自动备份名称的默认格式。从AUTOBACKUP恢复CONTROLFILE; ＃如果在最近的备份中数据库＃结构已更改，并且您希望＃recover恢复到该时间点，则使用set until命令。通过这种方式，RMAN将数据库＃恢复到数据库在指定时间具有的相同结构。ALTER DATABASE MOUNT;设置直到序列1124线程1; RESTORE DATABASE;恢复数据库; }</pre><p>以下<code class="codeph">RUN</code>命令示例显示了相同的方案，但恢复的数据文件的新文件名除外：</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; RUN {＃如果您必须将文件恢复到新位置，＃使用SET NEWNAME命令：将DATAFILE 1的SET NEWNAME设置为'/ dev / vgd_1_0 / rlvt5_500M_1';将DATAFILE 2的NEWNAME设置为'/ dev / vgd_1_0 / rlvt5_500M_2';将DATAFILE 3的NEWNAME设置为'/ dev / vgd_1_0 / rlvt5_500M_3'; ALLOCATE CHANNEL t1 DEVICE TYPE sbt;从AUTOBACKUP恢复CONTROLFILE; ALTER DATABASE MOUNT; SET UNTIL SEQUENCE 124 THREAD 1; RESTORE DATABASE; SWITCH DATAFILE ALL; ＃使用数据文件的新位置更新控制文件。恢复数据库; }</pre></li>
                           <li>
                              <p>如果恢复成功，则打开数据库并重置联机日志：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre></li>
                        </ol>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="BRADV908"></a><div class="props_rev_3"><a id="GUID-6B71E7DF-A2B6-44F5-A8D5-B184BB41A768" name="GUID-6B71E7DF-A2B6-44F5-A8D5-B184BB41A768"></a><h3 id="BRADV-GUID-6B71E7DF-A2B6-44F5-A8D5-B184BB41A768" class="sect3"><span class="enumeration_section">20.5</span>在新主机上恢复数据库</h3>
               <div>
                  <p>使用<code class="codeph">RESTORE</code>和<code class="codeph">RECOVER</code>命令还原新主机上的数据库。当您要执行灾难恢复过程的测试运行或将数据库永久移动到新主机时，在新主机上还原数据库非常有用。
                  </p>
                  <p>如果使用本节中的过程，则还原的数据库的DBID与原始数据库的DBID相同。不要将以这种方式创建的测试数据库注册到与源数据库相同的恢复目录中。由于两个数据库的DBID相同，因此测试数据库的元数据可能会干扰RMAN恢复和恢复源数据库的能力。</p>
                  <p>如果您的目标是创建目标数据库的副本以便在新主机上继续使用，则使用RMAN <code class="codeph">DUPLICATE</code>命令而不是此过程。<code class="codeph">DUPLICATE</code>命令将新DBID分配给它创建的数据库，使其能够在与原始数据库相同的恢复目录中注册。
                  </p>
                  <p><span class="bold">要在新主机上还原数据库：</span></p>
                  <ol>
                     <li>
                        <p>完成还原数据库之前必须执行的步骤，如<span class="q">“ <a href="rman-recovery-advanced.html#GUID-0EE8068A-5D2F-41FF-BDB9-DEEC8CBCCDB9" title="必须执行某些步骤以准备在新主机上恢复数据库。">准备在新主机上还原数据库</a> ”中所述</span> 。
                        </p>
                     </li>
                     <li>
                        <p>将目标数据库备份传输到新主机并还原备份，如<span class="q">“将<a href="rman-recovery-advanced.html#GUID-6A176AA2-5E35-4F3D-A125-E7C32A1D672A" title="要使用磁盘上的数据文件副本或备份集将数据库移动到新主机，必须手动将文件传输到新主机。此过程假定RMAN正在使用恢复目录。">磁盘备份还原到新主机</a> ”中所述</span> 。
                        </p>
                     </li>
                  </ol>
                  <div class="infoboxnotealso" id="GUID-6B71E7DF-A2B6-44F5-A8D5-B184BB41A768__GUID-6FEE8087-73E4-4318-A4BC-5407AAE99C6E">
                     <p class="notep1">也可以看看：</p>
                     <p><a href="rman-recovery-advanced.html#GUID-23B34A02-C9D0-4C83-A0C8-C9B5446D5555" title="建议您测试是否可以将数据库还原到新主机。">测试新主机上的数据库还原</a></p>
                  </div>
               </div><a id="BRADV89831"></a><div class="props_rev_3"><a id="GUID-0EE8068A-5D2F-41FF-BDB9-DEEC8CBCCDB9" name="GUID-0EE8068A-5D2F-41FF-BDB9-DEEC8CBCCDB9"></a><h4 id="BRADV-GUID-0EE8068A-5D2F-41FF-BDB9-DEEC8CBCCDB9" class="sect4"><span class="enumeration_section">20.5.1</span>准备在新主机上还原数据库</h4>
                  <div>
                     <p>必须执行某些步骤以准备在新主机上恢复数据库。</p>
                     <div class="section">
                        <p>步骤包括以下内容：</p>
                        <ul style="list-style-type:disc">
                           <li>
                              <p>记录源数据库的DBID。</p>
                           </li>
                           <li>
                              <p>使新数据库上的源数据库初始化参数文件可访问。使用操作系统实用程序将文件从旧主机复制到新主机。</p>
                           </li>
                           <li>
                              <p>如果仅执行测试还原操作，请确保RMAN <span class="italic">未</span>连接到恢复目录。否则，RMAN会在恢复目录中记录有关已还原数据文件的元数据。此元数据会干扰将来恢复和恢复主数据库的尝试。
                              </p>
                              <p>如果必须使用恢复目录，因为控制文件不够大，无法在必须还原的所有备份上包含RMAN存储库数据，请使用Oracle Data Pump导出目录并将其导入到其他模式或数据库中。然后，使用复制的恢复目录进行测试还原。否则，恢复目录会将已还原的数据库视为当前目标数据库。</p>
                           </li>
                           <li>
                              <p>确保可以在还原主机上访问用于还原操作的备份。例如，如果备份是使用介质管理器进行的，则验证磁带设备是否已连接到新主机。如果您使用的是磁盘副本，请使用以下部分中的过程。</p>
                           </li>
                           <li>
                              <p>如果要对生产数据库执行试验性还原，请在测试环境中还原数据库之前执行以下任一操作：</p>
                              <ul style="list-style-type:disc">
                                 <li>
                                    <p>如果测试数据库将使用与生产数据库使用的恢复区域物理上<span class="italic">不同</span>的快速恢复区域，则将测试数据库实例中的<code class="codeph">DB_RECOVERY_FILE_DEST</code>设置为新位置。
                                    </p>
                                 </li>
                                 <li>
                                    <p>如果测试数据库将使用与生产数据库使用的恢复区域在物理上<span class="italic">相同</span>的快速恢复区域，则将测试数据库实例中的<code class="codeph">DB_UNIQUE_NAME</code>设置为与生产数据库不同的名称。
                                    </p>
                                 </li>
                              </ul>
                              <p>如果您不执行上述任一操作，则RMAN会假定您正在还原生产数据库并从快速恢复区域中删除闪回日志，因为它们被视为不可用。</p>
                           </li>
                        </ul>
                        <div class="infoboxnotealso" id="GUID-0EE8068A-5D2F-41FF-BDB9-DEEC8CBCCDB9__GUID-F2C04D83-1034-4335-AB6E-C26BDF17E42A">
                           <p class="notep1">也可以看看：</p>
                           <p><span class="q">“ <a href="rman-complete-database-recovery.html#GUID-34BB2E4B-B2FC-4701-BB65-BFED027DB865" title="建议您记录数据库的DBID。">确定数据库的DBID</a> ”</span>以了解如何确定数据库的DBID</p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="BRADV368"></a><a id="BRADV89832"></a><div class="props_rev_3"><a id="GUID-6A176AA2-5E35-4F3D-A125-E7C32A1D672A" name="GUID-6A176AA2-5E35-4F3D-A125-E7C32A1D672A"></a><h4 id="BRADV-GUID-6A176AA2-5E35-4F3D-A125-E7C32A1D672A" class="sect4"><span class="enumeration_section">20.5.2将</span>磁盘备份还原到新主机</h4>
                  <div>
                     <p>要使用磁盘上的数据文件副本或备份集将数据库移动到新主机，必须手动将文件传输到新主机。此过程假定RMAN正在使用恢复目录。</p>
                     <div class="section">
                        <p><span class="bold">要将备份文件还原到新主机：</span></p>
                        <ol>
                           <li>
                              <p>启动RMAN并连接到目标数据库和恢复目录，如<span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”中所述</span> 。
                              </p>
                           </li>
                           <li>
                              <p>运行<code class="codeph">LIST</code>命令以查看数据文件和控制文件自动备份的备份列表。
                              </p>
                              <p>例如，输入以下命令以查看数据文件副本：</p><pre class="oac_no_warn" dir="ltr">列表复制;</pre><p>例如，输入以下命令以查看控制文件备份：</p><pre class="oac_no_warn" dir="ltr">控制文件的列表备份;</pre><p>自动备份的片段名称必须使用<code class="codeph">%F</code>替换变量，因此自动备份片段名称包含字符串<code class="codeph">c-IIIIIIIIII-YYYYMMDD-QQ</code> ，其中<code class="codeph">IIIIIIIIII</code>代表DBID， <code class="codeph">YYYYMMDD</code>是当天格里高利历中的时间戳。生成备份， <code class="codeph">QQ</code>是十六进制的序列。
                              </p>
                           </li>
                           <li>
                              <p>使用操作系统实用程序将备份复制到新主机。</p>
                              <p>输入如下命令将所有数据文件副本复制到<code class="codeph">?新主机上的/oradata/trgt</code>目录：</p><pre class="oac_no_warn" dir="ltr">％cp -r / disk1 / * dbf / net / new_host / oracle / oradata / trgt</pre><p>输入如下命令将自动备份备份片段复制到新主机上的<code class="codeph">/tmp</code>目录：</p><pre class="oac_no_warn" dir="ltr">％cp -r / disk1 / auto_bkp_loc / c-1618370911-20130208-00 / net / new_host / tmp</pre><p>从非默认位置还原自动备份时，必须使用<code class="codeph">SET CONTROLFILE AUTOBACKUP FORMAT</code>命令。
                              </p>
                           </li>
                        </ol>
                        <div class="infoboxnotealso" id="GUID-6A176AA2-5E35-4F3D-A125-E7C32A1D672A__GUID-06AEB6F1-581E-4310-9B64-CCAEF078008C">
                           <p class="notep1">也可以看看：</p>
                           <p><span class="q">“ <a href="rman-recovery-advanced.html#GUID-8077F97F-76A7-49DC-8C1E-5FE8ADD0914F" title="如果已配置控制文件自动备份，则只要执行自动备份，就会使用控制文件备份服务器参数文件。">从控制文件自动备份恢复服务器参数文件</a> ”</span></p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div><a id="BRADV369"></a><a id="BRADV89833"></a><div class="props_rev_3"><a id="GUID-23B34A02-C9D0-4C83-A0C8-C9B5446D5555" name="GUID-23B34A02-C9D0-4C83-A0C8-C9B5446D5555"></a><h4 id="BRADV-GUID-23B34A02-C9D0-4C83-A0C8-C9B5446D5555" class="sect4"><span class="enumeration_section">20.5.3</span>在新主机上测试数据库的还原</h4>
                  <div>
                     <p>建议您测试是否可以将数据库还原到新主机。</p>
                     <div class="section">
                        <p>在这种情况下，您有两个联网的Linux主机， <code class="codeph">hosta</code>和<code class="codeph">hostb</code> 。目标数据库命名<code class="codeph">trgta</code>是<code class="codeph">hosta</code> ，并在恢复目录中注册<code class="codeph">catdb</code> 。你想测试还原和恢复<code class="codeph">trgta</code>在<code class="codeph">hostb</code> ，同时保持数据库<code class="codeph">trgta</code>并运行<code class="codeph">hosta</code> 。
                        </p>
                        <p>现在，假设的目录结构<code class="codeph">hostb</code>是不同的<code class="codeph">hosta</code> 。目标数据库位于<code class="codeph">/net/hosta/dev3/oracle/dbs</code> ，但您希望将数据库还原到<code class="codeph">/net/hostb/oracle/oradata/test</code> 。您可以在两台主机均可访问的介质管理器上对数据文件，控制文件，归档重做日志和服务器参数文件进行磁带备份。<code class="codeph">TRGTA</code>数据库的<code class="codeph">ORACLE_SID</code>是<code class="codeph">TRGTA</code> ，并且不会更改已还原的数据库。
                        </p>
                        <div class="infoboxnote" id="GUID-23B34A02-C9D0-4C83-A0C8-C9B5446D5555__GUID-0049ABAB-7529-4C00-AAFB-F14052BFF244">
                           <p class="notep1">警告：</p>
                           <p>如果要还原数据库以进行测试，则<span class="italic">永远不要</span>将RMAN连接到测试数据库和恢复目录。
                           </p>
                        </div>
                     </div>
                     <!-- class="section" -->
                     <div class="section">
                        <p><span class="bold">要在新主机上还原数据库：</span></p>
                        <ol>
                           <li>
                              <p>确保可以在新主机上访问目标数据库的备份。</p>
                              <p>要测试灾难恢复，您必须具有目标数据库的可恢复备份。准备灾难恢复策略时，请确保数据文件，控制文件和服务器参数文件的备份可在<code class="codeph">hostb</code>上恢复。因此，您必须配置媒体管理软件，以便<code class="codeph">hostb</code>是媒体管理器客户端，并且可以读取在<code class="codeph">hosta</code>创建的备份集。有关此问题的支持，请咨询媒体管理供应商。
                              </p>
                           </li>
                           <li>
                              <p>在<code class="codeph">hostb</code>上配置<code class="codeph">ORACLE_SID</code> 。
                              </p>
                              <p>此方案假定您要在<code class="codeph">hostb</code>上启动RMAN客户端并通过操作系统对自己进行身份验证。但是，您必须在本地或通过网络服务名称连接到<code class="codeph">hostb</code> 。
                              </p>
                              <p>以管理员权限登录<code class="codeph">hostb</code>后，编辑<code class="codeph">/etc/group</code>文件，以便包含在DBA组中：</p><pre class="oac_no_warn" dir="ltr">DBA：*：614：&lt;your_user_name&gt;</pre><p>设置<code class="codeph">ORACLE_SID</code>的环境变量<code class="codeph">hostb</code>就使用了相同的值<code class="codeph">hosta</code> ：</p><pre class="oac_no_warn" dir="ltr">％setenv ORACLE_SID trgta</pre></li>
                           <li>
                              <p>在<code class="codeph">hostb</code>上启动RMAN并连接到目标数据库， <span class="italic">而不</span>连接到恢复目录。
                              </p>
                              <p>例如，输入以下命令：</p><pre class="oac_no_warn" dir="ltr">％rman NOCATALOG RMAN&gt; CONNECT TARGET /</pre></li>
                           <li>
                              <p>设置DBID并启动数据库实例而不安装数据库。</p>
                              <p>例如，运行<code class="codeph">SET</code> <code class="codeph">DBID</code>来设置DBID，然后运行<code class="codeph">STARTUP</code> <code class="codeph">NOMOUNT</code> ：</p><pre class="oac_no_warn" dir="ltr">SET DBID 1340752057;启动NOMOUNT</pre><p>RMAN无法找到尚未还原的服务器参数文件，但是使用“虚拟”文件启动实例。示例输出如下：</p><pre class="oac_no_warn" dir="ltr">启动失败：ORA-01078：处理系统参数失败LRM-00109：无法打开参数文件'/net/hostb/oracle/dbs/inittrgta.ora'尝试启动没有参数文件的Oracle实例...Oracle实例启动了</pre></li>
                           <li>
                              <p>恢复并编辑服务器参数文件。</p>
                              <p>由于您在进行备份时启用了控制文件自动备份功能，因此服务器参数文件包含在备份中。如果要还原具有非默认格式的自动备份，请使用<code class="codeph">SET CONTROLFILE AUTOBACKUP FORMAT</code>命令指示格式。
                              </p>
                              <p>将通道分配给介质管理器，然后将服务器参数文件还原为客户端参数文件，并使用<code class="codeph">SET</code>命令指示自动备份的位置（在此示例中，自动备份位于<code class="codeph">/tmp</code> ）：</p><pre class="oac_no_warn" dir="ltr">运行{ALLOCATE CHANNEL c1设备类型sbt PARMS'...“;设备类型磁盘的SET CONTROLFILE AUTOBACKUP格式为'/ tmp /％F';恢复SPFILE到PFILE'？/oradata/test/inittrgta.ora'from AUTOBACKUP;关闭中止; }</pre></li>
                           <li>
                              <p>编辑已还原的初始化参数文件。</p>
                              <p>更改任何特定于位置的参数，例如，以<code class="codeph">_DEST</code>结尾的参数，以反映新的目录结构。例如，编辑以下参数：</p><pre class="oac_no_warn" dir="ltr">-  IFILE  -  LOG_ARCHIVE_DEST_1  -  CONTROL_FILES</pre></li>
                           <li>
                              <p>使用编辑的初始化参数文件重新启动实例。</p>
                              <p>例如，输入以下命令：</p><pre class="oac_no_warn" dir="ltr">STARTUP FORCE NOMOUNT PFILE ='？/oradata/test/inittrgta.ora';</pre></li>
                           <li>
                              <p>从自动备份还原控制文件，然后装入数据库。</p>
                              <p>例如，输入以下命令：</p><pre class="oac_no_warn" dir="ltr">运行{ALLOCATE CHANNEL c1设备类型sbt PARMS'...“;从AUTOBACKUP恢复CONTROLFILE; ALTER DATABASE MOUNT; }</pre><p>RMAN将控制文件还原到您在<code class="codeph">CONTROL_FILES</code>初始化参数中指定的任何位置。
                              </p>
                           </li>
                           <li>
                              <p>使用新文件名或<code class="codeph">CATALOG START</code> <code class="codeph">WITH</code>将您在<span class="q">“将<a href="rman-recovery-advanced.html#GUID-6A176AA2-5E35-4F3D-A125-E7C32A1D672A" title="要使用磁盘上的数据文件副本或备份集将数据库移动到新主机，必须手动将文件传输到新主机。此过程假定RMAN正在使用恢复目录。">磁盘备份还原到新主机</a> ”中</span>复制的数据文件副本编目（如果您知道所有文件都在具有公共前缀的目录中，可以使用<code class="codeph">CATALOG START WITH</code>命令轻松解决）。例如，运行：</p><pre class="oac_no_warn" dir="ltr">CATALOG START WITH'/ oracle / oradata / trgt /';</pre><p>如果要单独指定文件，则可以执行<code class="codeph">CATALOG</code>命令，如下所示：</p><pre class="oac_no_warn" dir="ltr">CATALOG DATAFILECOPY'/oracle/oradata/trgt/system01.dbf'，'/ oracle / oradata / strgt / undotbs01.dbf'，'/ oracle / oradata / trgt / cwmlite01.dbf'，'/ oracle / oradata / trgt / drsys01 .dbf'，'/ oracle / oradata / strgt / example01.dbf'，'/ oracle / oradata / strgt / indx01.dbf'，'/ oracle / oradata / trgt / tools01.dbf'，'/ oracle / oradata / trgt /users01.dbf';</pre></li>
                           <li>
                              <p>在新数据库上启动SQL * Plus会话，并查询控制文件中记录的数据库文件名。</p>
                              <p>由于控制文件来自<code class="codeph">trgta</code>数据库，因此录制的文件名使用原始的<code class="codeph">hosta</code>文件名。您可以查询<code class="codeph">V$</code>视图以获取此信息。在SQL * Plus中运行以下查询：</p><pre class="oac_no_warn" dir="ltr">列名称格式a60 SPOOL LOG'/ tmp / db_filenames.out'选择文件#AS“文件/ Grp＃”，名称来自V $ DATAFILE UNION SELECT GROUP＃，成员来自V $ LOGFILE; SPOOL OFF EXIT</pre></li>
                           <li>
                              <p>编写RMAN还原和恢复脚本。该脚本必须包含以下步骤：</p>
                              <ol type="a">
                                 <li>
                                    <p>对于还原到与源主机上的路径不同的目标主机上的每个数据文件，请使用<code class="codeph">SET</code> <code class="codeph">NEWNAME</code>命令在目标主机上指定新路径。如果目标系统上的文件系统设置为与源主机具有相同的路径，则不要将<code class="codeph">SET NEWNAME</code>用于恢复到与源主机上相同路径的文件。
                                    </p>
                                 </li>
                                 <li>
                                    <p>对于要在与源主机上的位置不同的位置创建的每个联机重做日志，请使用SQL <code class="codeph">ALTER</code> <code class="codeph">DATABASE</code> <code class="codeph">RENAME</code> <code class="codeph">FILE</code>命令指定目标主机上的路径名。如果目标系统上的文件系统设置为与源主机具有相同的路径，则不要将<code class="codeph">ALTER DATABASE RENAME FILE</code>用于恢复到与源主机上相同路径的文件。
                                    </p>
                                 </li>
                                 <li>
                                    <p>执行<code class="codeph">SET UNTIL</code>操作以将恢复限制到归档重做日志的末尾。如果未指定<code class="codeph">SET UNTIL</code>命令，则恢复将停止并显示错误。
                                    </p>
                                 </li>
                                 <li>
                                    <p>还原并恢复数据库。</p>
                                 </li>
                                 <li>
                                    <p>运行<code class="codeph">SWITCH DATAFILE ALL</code>命令，以便控制文件将新路径名识别为数据文件的官方新名称。
                                    </p>
                                 </li>
                              </ol>
                              <p>以下代码显示了可以执行还原和恢复操作的RMAN脚本<code class="codeph">reco_test.rman</code> 。
                              </p><pre class="oac_no_warn" dir="ltr">RUN {＃将通道分配给磁带设备ALLOCATE CHANNEL c1 DEVICE TYPE sbt PARMS'...“; ＃重命名数据文件和在线重做日志SET NEWNAME FOR DATAFILE 1 TO'？/oradata/test/system01.dbf';为数据文件2设置NEWNAME''？/oradata/test/undotbs01.dbf';为数据文件设置NEWNAME 3'？/oradata/test/cwmlite01.dbf';为数据文件设置NEWNAME 4'？/oradata/test/drsys01.dbf';为数据文件设置NEWNAME 5'？/oradata/test/example01.dbf';为数据文件设置NEWNAME 6到'？/oradata/test/indx01.dbf';设置数据文件7的NEWNAME到'？/oradata/test/tools01.dbf';设置数据文件8的NEWNAME到'？/oradata/test/users01.dbf'; ALTER DATABASE RENAME FILE'/dev3/oracle/dbs/redo01.log'TO'？/oradata/test/redo01.log'; ALTER DATABASE RENAME FILE'/dev3/oracle/dbs/redo02.log'TO'？/oradata/test/redo02.log'; ＃执行SET UNTIL以防止恢复在线日志SET UNTIL SCN 123456; ＃恢复数据库并切换数据文件名RESTORE DATABASE; SWITCH DATAFILE ALL; ＃recover数据库RECOVER DATABASE; } 出口</pre></li>
                           <li>
                              <p>执行上一步中创建的脚本。</p>
                              <p>例如，启动RMAN以连接到目标数据库并运行<code class="codeph">@</code>命令：</p><pre class="oac_no_warn" dir="ltr">％rman TARGET / NOCATALOG RMAN&gt; @ reco_test.rman</pre></li>
                           <li>
                              <p>使用<code class="codeph">RESETLOGS</code>选项打开已还原的数据库。
                              </p>
                              <p>在RMAN提示符下，使用<code class="codeph">RESETLOGS</code>选项打开数据库：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE OPEN RESETLOGS;</pre><div class="infoboxnote" id="GUID-23B34A02-C9D0-4C83-A0C8-C9B5446D5555__GUID-09A55798-F84C-496A-9832-AE6F616BD5C8">
                                 <p class="notep1">警告：</p>
                                 <p>在下一步中重新打开数据库时，请不要连接到恢复目录。否则，创建的新数据库化身将自动注册到恢复目录中，生产数据库的文件名将替换为脚本中指定的新文件名。</p>
                              </div>
                           </li>
                           <li>
                              <p>（可选）使用其所有文件删除测试数据库。</p>
                              <div class="infoboxnote" id="GUID-23B34A02-C9D0-4C83-A0C8-C9B5446D5555__GUID-1A519371-8FD3-4DC8-BFA0-03C3248C845C">
                                 <p class="notep1">注意：</p>
                                 <p>如果使用ASM磁盘组，则<code class="codeph">DROP DATABASE</code>命令是安全删除测试数据库文件的唯一方法。如果还原到非ASM存储，则还可以使用操作系统命令删除数据库。
                                 </p>
                              </div>
                              <p>使用<code class="codeph">DROP DATABASE</code>命令自动删除与数据库关联的所有文件。以下示例删除数据库文件：</p><pre class="oac_no_warn" dir="ltr">STARTUP FORCE NOMOUNT PFILE ='？/oradata/test/inittrgta.ora'; DROP DATABASE;</pre><p>由于在连接到恢复目录时未执行还原和恢复操作，因此恢复目录不包含任何已还原文件的记录或测试期间执行的过程。同样， <code class="codeph">trgta</code>数据库的控制文件完全不受测试的影响。</p>
                           </li>
                        </ol>
                        <div class="infoboxnotealso" id="GUID-23B34A02-C9D0-4C83-A0C8-C9B5446D5555__GUID-7C9C8A3D-E400-4A21-9E11-3BD91530C303">
                           <p class="notep1">也可以看看：</p>
                           <p><span class="q">“ <a href="starting-interacting-with-rman-client.html#GUID-E07231B2-F213-4F8F-8D02-E410A6DAE94C" title="您可以从RMAN客户端或操作系统命令行创建数据库连接。可以使用密码文件或操作系统身份验证对这些数据库连接进行身份验证。">使用RMAN建立数据库连接</a> ”</span></p>
                        </div>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div>
            <div class="sect2"><a id="GUID-759D9D57-D638-4557-BBCA-891E898CDC76" name="GUID-759D9D57-D638-4557-BBCA-891E898CDC76"></a><h3 id="BRADV-GUID-759D9D57-D638-4557-BBCA-891E898CDC76" class="sect3"><span class="enumeration_section">20.6</span>恢复使用较早版本的RMAN创建的备份</h3>
               <div>
                  <p>您可以还原使用旧版RMAN创建的备份，直至Oracle Database 9 <span class="italic">i</span> Release 2（9.2.0.8）。
                  </p>
                  <div class="section">在创建备份的Oracle数据库版本与要在其上运行还原的数据库的Oracle软件版本之间必须存在受支持的升级路径。</div>
                  <!-- class="section" -->
                  <div class="p">
                     <p>在此示例中，源数据库是Oracle Database <span class="italic">11g</span>第2版数据库，并配置为使用服务器参数文件（spfile）。数据库以<code class="codeph">ARCHIVELOG</code>模式运行，并使用快速恢复区域。还配置了控制文件自动备份。然后，您可以创建源数据库的RMAN备份，包括存档的重做日志。
                     </p>
                     <p>还原这些备份的目标主机安装了Oracle Database 12 <span class="italic">c</span>第1版。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <p class="subhead2" id="GUID-759D9D57-D638-4557-BBCA-891E898CDC76__GUID-97C91D3A-D4EA-4806-8F9E-27BB034EE661">要还原使用早于当前目标数据库版本的RMAN版本创建的RMAN备份：</p>
                  </div>
                  <!-- class="section" -->
                  <ol>
                     <li class="stepexpand"><span>验证从创建备份的数据库版本到计划还原数据库的Oracle服务器版本是否存在受支持的升级路径。</span><div>
                           <p>例如，如果您的RMAN备份是在Oracle Database 11g第2版（11.2.0.3）上创建的，并且您希望在Oracle Database 12 <span class="italic">c</span>第1版（12.1）上运行已还原的数据库，则必须验证是否存在受支持的升级路径从版本11.2.0.3到版本12.1。
                           </p>
                           <div class="infoboxnotealso" id="GUID-759D9D57-D638-4557-BBCA-891E898CDC76__GUID-43FDDB18-61A6-4F85-AFCB-79D3F2CF7F34">
                              <p class="notep1">也可以看看：</p>
                              <p>有关数据库升级路径的信息，请<a href="../upgrd/oracle-database-releases-that-support-direct-upgrade.html#UPGRD12358" target="_blank"><span class="italic">参见Oracle数据库升级指南</span></a></p>
                           </div>
                        </div>
                     </li>
                     <li class="stepexpand"><span>确保源数据库备份在必须还原它们的目标主机上可用。</span><div>您可以使用操作系统实用程序将备份复制到目标主机，也可以将备份存储在目标主机可访问的共享位置。</div>
                     </li>
                     <li class="stepexpand"><span>关闭目标数据库。</span></li>
                     <li class="stepexpand"><span>在目标主机上，将<code class="codeph">ORACLE_SID</code>设置为源数据库上使用的相同值。</span><div><pre class="oac_no_warn" dir="ltr">％setenv ORACLE_SID db112</pre></div>
                     </li>
                     <li class="stepexpand"><span>在目标主机上启动RMAN，并使用操作系统身份验证和没有恢复目录连接到目标数据库。</span><div><pre class="oac_no_warn" dir="ltr">％rman目标/ NOCATALOG</pre></div>
                     </li>
                     <li class="stepexpand"><span>将DBID设置为与源数据库相同的值。</span><div>
                           <p>以下命令将DBID设置为699892390，这是正在还原其备份的源数据库的DBID。</p><pre class="oac_no_warn" dir="ltr">RMAN&gt;设置DBID 699892390;</pre></div>
                     </li>
                     <li class="stepexpand"><span>以nomount模式启动目标数据库。</span><div><pre class="oac_no_warn" dir="ltr">RMAN&gt; startup nomount;</pre><p>RMAN无法找到尚未还原的服务器参数文件。但是，实例以“虚拟”文件启动，并显示以下输出：</p><pre class="oac_no_warn" dir="ltr">启动失败：ORA-01078：处理系统参数失败LRM-00109：无法打开参数文件'/oracle/dbs/inittrgta.ora'尝试启动没有参数文件的Oracle实例...Oracle实例启动了</pre></div>
                     </li>
                     <li class="stepexpand"><span>从源数据库自动备份还原服务器参数文件。</span><div>
                           <p>由于在源数据库中启用了控制文件自动备份，因此服务器参数文件包含在备份中。要还原具有非默认格式的自动备份，请使用<code class="codeph">SET CONTROLFILE AUTOBACKUP FORMAT</code>命令指示格式。
                           </p>
                           <p>以下示例设置自动备份格式，将源数据库中的spfile还原到pfile <code class="codeph">/dev3/oracle/network/init_db112.ora</code> ，然后关闭目标数据库。
                           </p><pre class="oac_no_warn" dir="ltr">运行{设备类型磁盘的设置控制文件自动备份格式为'/scratch/fra/cf/%F.bck';从自动备份恢复区'/ scratch / fra / cf'db_name'DB112'将spfile恢复到pfile'/dev3/oracle/network/init_db112.ora';关机中止; }</pre></div>
                     </li>
                     <li class="stepexpand"><span>编辑已还原的初始化参数文件并修改所需的初始化参数。</span><div>
                           <p>如果目标数据库的兼容性要求与源数据库中设置的兼容性要求不同，则包括<code class="codeph">COMPATIBLE</code>参数，以及目标数据库版本中不推荐使用的参数。还要更新任何特定于位置的参数，例如以<code class="codeph">_DEST</code>结尾的参数，以反映新的目录结构。
                           </p>
                           <p>在此示例中，您必须编辑位于<code>/dev3/oracle/network/init_db112.ora</code>的pfile。
                           </p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>使用编辑的初始化参数文件重新启动实例。</span><div>
                           <p>以下命令使用编辑的参数文件以nomount模式启动数据库实例。</p><pre class="oac_no_warn" dir="ltr">RMAN&gt; startup force nomount pfile ='/ dev3 / oracle / network / init_db112.ora';</pre></div>
                     </li>
                     <li class="stepexpand"><span>从自动备份还原控制文件，然后装入数据库。</span><div>
                           <p>以下示例设置控制文件自动备份的格式，从自动备份还原控制文件，然后装入数据库。</p><pre class="oac_no_warn" dir="ltr">运行{设备类型磁盘的设置控制文件自动备份格式为'/scratch/fra/cf/%F.bck';从自动备份恢复区'/ scratch / fra / cf'db_name'DB112'恢复控制文件; alter database mount; }</pre><p>控制文件将还原到已编辑的初始化参数文件中<code class="codeph">CONTROL_FILES</code>初始化参数中指定的位置。
                           </p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>目标主机数据库的目录数据文件副本可供目标主机使用。</span><div>
                           <p>如果所有文件都在具有公共前缀的<code class="codeph">CATALOG START WITH</code> ，则使用<code class="codeph">CATALOG START WITH</code>命令。如果要单独指定文件名，请使用<code class="codeph">CATALOG DATAFILECOPY</code>命令。
                           </p>
                           <p>在以下示例中，所有数据文件副本都存储在单个文件夹<code>/scratch/fra/DB112/backupset</code> ，因此我们使用<code class="codeph">CATALOG START WITH</code>命令。
                           </p><pre class="oac_no_warn" dir="ltr">RMAN&gt;目录以'/ scratch / fra / DB112 / backupset'开头;</pre></div>
                     </li>
                     <li class="stepexpand"><span>还原并恢复源数据库。</span><div>
                           <p>如果数据文件还原到与源数据库上的路径不同的路径，则必须使用<code class="codeph">SET NEWNAME</code>命令在目标主机上指定新路径。如果要在与源数据库上的位置不同的位置创建联机重做日志，请使用<code class="codeph">ALTER DATABASE RENAME FILE</code>命令指定目标数据库上每个重做日志文件的位置。
                           </p>
                           <p>在此示例中， <code class="codeph">SET NEWNAME FOR DATABASE</code>命令用于指定所有已还原数据文件的新位置。使用<code class="codeph">ALTER DATABASE RENAME FILE</code>命令指定每个联机重做日志文件的新位置。执行恢复直到命令中指定的SCN。
                           </p><pre class="oac_no_warn" dir="ltr">运行{将数据库的新名称设置为'/ ade / b / 1885631999 / oracle / dbs /％Uf'; alter database将文件'/dev1/oracle/dbs/redo01.log'重命名为'/dev3/oracle/dbs/redo1.log'; alter database将文件'/dev1/oracle/dbs/redo02.log'重命名为'/dev3/oracle/dbs/redo2.log';一直到scn 1092435;恢复数据库;切换数据文件全部;恢复数据库; }</pre></div>
                     </li>
                     <li class="stepexpand"><span>使用<code class="codeph">RESETLOGS</code>和<code class="codeph">UPGRADE</code>选项打开已还原的数据库。</span><div><pre class="oac_no_warn" dir="ltr">RMAN&gt; alter database open resetlogs upgrade;已处理语句RMAN-06900：警告：无法生成V $ RMAN_STATUS或V $ RMAN_OUTPUT行RMAN-06901：警告：禁用目标数据库中V $ RMAN_STATUS和V $ RMAN_OUTPUT行ORACLE错误的更新：ORA-04023：对象SYS。 STANDARD无法验证或授权</pre><p>该错误是由需要在升级过程中重新验证的数据库包引起的。</p>
                        </div>
                     </li>
                     <li class="stepexpand"><span>退出RMAN。</span></li>
                     <li class="stepexpand"><span>通过执行升级数据库所需的步骤，将目标数据库升级到所需的Oracle版本。</span><div>
                           <div class="infoboxnotealso" id="GUID-759D9D57-D638-4557-BBCA-891E898CDC76__GUID-E09568CA-36DC-4E93-9CC5-9246346692D5">
                              <p class="notep1">也可以看看：</p>
                              <p>有关升级数据库的信息，请参见<a href="../upgrd/oracle-database-releases-that-support-direct-upgrade.html#UPGRD12358" target="_blank"><span class="italic">Oracle数据库升级指南</span></a></p>
                           </div>
                        </div>
                     </li>
                  </ol>
               </div>
            </div><a id="BRADV680"></a><div class="props_rev_3"><a id="GUID-8E64485B-3788-4389-A892-8C560F12443F" name="GUID-8E64485B-3788-4389-A892-8C560F12443F"></a><h3 id="BRADV-GUID-8E64485B-3788-4389-A892-8C560F12443F" class="sect3"><span class="enumeration_section">20.7</span>通过网络恢复和恢复文件</h3>
               <div>
                  <p>RMAN使您可以通过网络连接到包含所需文件的物理备用数据库来还原或恢复文件。您可以还原整个数据库，数据文件，控制文件，服务器参数文件或表空间。在需要同步主数据库和备用数据库的情况下，通过网络还原文件非常有用。</p>
                  <p>备份集用于通过网络还原或恢复文件。因此，您可以使用多节备份，加密和压缩来提高备份和还原性能。</p>
                  <p>从Oracle Database 12 <span class="italic">c</span>第1版（12.1）开始，支持通过网络还原和恢复文件。
                  </p>
                  <p>本节包括：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-DF586DC2-A0F0-4EFD-AF8A-FC6C0B553C31" title="RMAN使用RESTORE命令的FROM SERVICE子句从物理备用数据库通过网络还原数据库文件。">关于通过网络还原文件</a></p>
                     </li>
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-2ABBC0FC-D01E-4A1E-8FD6-9F04880D4E3F" title="您可以通过网络从主数据库获取增量备份，然后将此增量备份应用于物理备用数据库来执行恢复。">关于通过网络恢复文件</a></p>
                     </li>
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-8466262D-9F86-431B-AA34-A7002A5498A1" title="在某些情况下，通过网络连接到物理备用数据库来恢复文件非常有用。">通过网络还原和恢复文件的方案</a></p>
                     </li>
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-43FF41E9-81D2-41A5-B2E6-8E2E2CE91EDB" title="使用RESTORE命令通过网络连接到主数据库或物理备用数据库来还原丢失或损坏的数据文件。">通过网络恢复数据文件</a></p>
                     </li>
                     <li>
                        <p><a href="rman-recovery-advanced.html#GUID-93C8F7F1-E1FB-485D-ABC7-860757B24A98" title="RMAN通过创建增量备份来转发物理备用数据库，该增量备份包含对主数据库的更改，通过网络将增量备份传输到物理备用数据库，然后将增量备份应用于物理备用数据库。主数据库上的数据文件的所有更改（从备用数据文件头中的SCN开始）都包含在增量备份中。">使用RECOVER命令前滚物理备用数据库</a></p>
                     </li>
                  </ul>
               </div><a id="BRADV681"></a><div class="props_rev_3"><a id="GUID-DF586DC2-A0F0-4EFD-AF8A-FC6C0B553C31" name="GUID-DF586DC2-A0F0-4EFD-AF8A-FC6C0B553C31"></a><h4 id="BRADV-GUID-DF586DC2-A0F0-4EFD-AF8A-FC6C0B553C31" class="sect4"><span class="enumeration_section">20.7.1</span>关于通过网络恢复文件</h4>
                  <div>
                     <p>RMAN使用<code class="codeph">RESTORE</code>命令的<code class="codeph">FROM SERVICE</code>子句从物理备用数据库通过网络还原数据库文件。
                     </p>
                     <p><code class="codeph">FROM SERVICE</code>子句提供必须从中还原文件的物理备用数据库的服务名称。在还原操作期间，RMAN在物理备用数据库上创建需要还原的文件的备份集，然后通过网络将这些备份集传输到目标数据库。
                     </p>
                     <p>使用<code class="codeph">RESTORE</code>命令的<code class="codeph">SECTION SIZE</code>子句执行多节还原操作。要加密在物理备用数据库上创建的备份集，请在<code class="codeph">RESTORE</code>命令之前使用<code class="codeph">SET ENCRYPTION</code>命令指定使用的加密算法。
                     </p>
                     <p>要将文件从物理备用数据库作为压缩备份集传输，请使用<code class="codeph">RESTORE</code>命令中的<code class="codeph">USING COMPRESSED BACKUPSET</code>子句。默认情况下，RMAN使用RMAN配置中设置的算法压缩备份集。您可以在<code class="codeph">RESTORE</code>语句之前使用<code class="codeph">SET COMPRESSION ALGORITHM</code>命令覆盖默认值并设置不同的算法。
                     </p>
                  </div>
               </div><a id="BRADV682"></a><div class="props_rev_3"><a id="GUID-2ABBC0FC-D01E-4A1E-8FD6-9F04880D4E3F" name="GUID-2ABBC0FC-D01E-4A1E-8FD6-9F04880D4E3F"></a><h4 id="BRADV-GUID-2ABBC0FC-D01E-4A1E-8FD6-9F04880D4E3F" class="sect4"><span class="enumeration_section">20.7.2</span>关于通过网络恢复文件</h4>
                  <div>
                     <p>您可以通过网络从主数据库获取增量备份，然后将此增量备份应用于物理备用数据库来执行恢复。</p>
                     <p>RMAN作为<code class="codeph">TARGET</code>连接到物理备用数据库。通过仅恢复数据文件中使用的数据块来优化恢复过程。使用<code class="codeph">FROM SERVICE</code>子句指定必须从中提取增量备份的主数据库的服务名称。
                     </p>
                     <p>要在恢复过程中使用多节备份集，请在<code class="codeph">RECOVER</code>命令中指定<code class="codeph">SECTION SIZE</code>子句。要将所需文件作为加密备份集从主数据库传输，请在<code class="codeph">RESTORE</code>命令之前使用<code class="codeph">SET ENCRYPTION</code>命令指定用于创建备份集的加密算法。
                     </p>
                     <p>要压缩用于通过网络恢复文件的备份集，请使用<code class="codeph">USING COMPRESSED BACKUPSET</code> 。 RMAN在主数据库上创建备份集时会压缩备份集，然后将这些备份集传输到目标数据库。
                     </p>
                  </div>
               </div><a id="BRADV683"></a><div class="props_rev_3"><a id="GUID-8466262D-9F86-431B-AA34-A7002A5498A1" name="GUID-8466262D-9F86-431B-AA34-A7002A5498A1"></a><h4 id="BRADV-GUID-8466262D-9F86-431B-AA34-A7002A5498A1" class="sect4"><span class="enumeration_section">20.7.3</span>通过网络恢复和恢复文件的方案</h4>
                  <div>
                     <p>在某些情况下，通过网络连接到物理备用数据库来恢复文件非常有用。</p>
                     <p>这些方案包括以下内容：</p>
                     <ul style="list-style-type:disc">
                        <li>
                           <p>您需要前滚物理备用数据库以使其与主数据库同步。</p>
                           <p>在主数据库上创建最新更改的增量备份后，可以使用增量备份还原物理备用数据库。</p>
                        </li>
                        <li>
                           <p>您希望使用物理备用数据库上的相应文件还原主数据库上丢失的数据文件，控制文件或表空间。您还可以使用主数据库还原物理备用数据库上的文件。</p>
                        </li>
                     </ul>
                  </div>
               </div><a id="BRADV684"></a><div class="props_rev_3"><a id="GUID-43FF41E9-81D2-41A5-B2E6-8E2E2CE91EDB" name="GUID-43FF41E9-81D2-41A5-B2E6-8E2E2CE91EDB"></a><h4 id="BRADV-GUID-43FF41E9-81D2-41A5-B2E6-8E2E2CE91EDB" class="sect4"><span class="enumeration_section">20.7.4</span>通过网络恢复数据文件</h4>
                  <div>
                     <p>使用<code class="codeph">RESTORE</code>命令通过网络连接到主数据库或物理备用数据库来还原丢失或损坏的数据文件。
                     </p>
                     <div class="section">
                        <p>在这个例子中， <code class="codeph">DB_UNIQUE_NAME</code>主数据库的是<code class="codeph">MAIN</code>和<code class="codeph">DB_UNIQUE_NAME</code>物理备用数据库的是<code class="codeph">STANDBY</code> 。主数据库上的数据文件<code class="codeph">sales.dbf</code>已丢失。您希望从物理备用数据库还原此数据文件。物理备用数据库的服务名称是<code class="codeph">standby_tns</code> 。使用<code class="codeph">FROM SERVICE</code>子句的<code class="codeph">RESTORE</code>命令可以使用物理备用数据库中的数据文件还原主数据库中的丢失数据文件。主数据库和物理备用数据库中的密码文件是相同的。
                        </p>
                        <p>使用物理备用数据库中的数据文件，使用以下步骤还原主数据库中的数据文件<code class="codeph">sales.dbf</code> ：</p>
                     </div>
                     <!-- class="section" -->
                     <ol>
                        <li class="stepexpand"><span>以具有<code class="codeph">SYSBACKUP</code>权限的用户身份连接到主数据库。</span><div><pre class="oac_no_warn" dir="ltr">％RMAN RMAN&gt; CONNECT TARGET“sbu @ main AS SYSBACKUP”;</pre><p>出现提示时输入<code class="codeph">sbu</code>用户的密码。
                              </p>
                           </div>
                        </li>
                        <li class="stepexpand"><span>指定必须使用AES128加密算法对备份集进行加密</span><div><pre class="oac_no_warn" dir="ltr">RMAN&gt; SET ENCRYPTION ALGORITHM'AES128';</pre></div>
                        </li>
                        <li class="stepexpand"><span>确保物理备用数据库中的<code class="codeph">tnsnames.ora</code>文件包含与主数据库对应的条目。还要确保主数据库和物理备用数据库上的密码文件相同。</span></li>
                        <li class="stepexpand"><span>使用物理备用数据库上的数据文件还原主数据库上的数据文件。以下命令创建多节备份集以执行还原操作。</span><div><pre class="oac_no_warn" dir="ltr">RESTORE DATAFILE'/oradata/datafiles/sales.dbf'FRN SERVICE standby_tns SECTION SIZE 120M;</pre></div>
                        </li>
                     </ol>
                  </div>
               </div><a id="BRADV685"></a><div class="props_rev_3"><a id="GUID-93C8F7F1-E1FB-485D-ABC7-860757B24A98" name="GUID-93C8F7F1-E1FB-485D-ABC7-860757B24A98"></a><h4 id="BRADV-GUID-93C8F7F1-E1FB-485D-ABC7-860757B24A98" class="sect4"><span class="enumeration_section">20.7.5</span>使用RECOVER命令前滚物理备用数据库</h4>
                  <div>
                     <p>RMAN通过创建增量备份来转发物理备用数据库，该增量备份包含对主数据库的更改，通过网络将增量备份传输到物理备用数据库，然后将增量备份应用于物理备用数据库。主数据库上的数据文件的所有更改（从备用数据文件头中的SCN开始）都包含在增量备份中。</p>
                     <p>你可以使用<code class="codeph">RECOVER ...FROM SERVICE</code>命令用于将物理备用数据库上的数据文件与主数据库上的数据文件同步。此命令刷新备用数据文件并将它们前滚到与主数据库相同的时间点。但是，备用控制文件仍包含旧SCN值，这些值低于备用数据文件中的SCN值。因此，要完成物理备用数据库的同步，必须刷新备用控制文件，然后更新刷新的备用控制文件中的数据文件名，联机重做日志文件名和备用重做日志文件名。
                     </p>
                     <p>如果网络资源是约束，则可以使用<code class="codeph">BACKUP INCREMENTAL</code>命令在主数据库上创建增量备份，然后使用增量备份来前滚物理备用数据库。
                     </p>
                     <p><span class="q">“ <a href="rman-recovery-advanced.html#GUID-828A4953-3F7E-4975-ADA4-5469D6794BB0" title="Use the RECOVER STANDBY DATABASE command with the FROM SERVICE clause to refresh a physical standby database with changes that were made to the primary database.">使用对主数据库所做的更改来刷新物理备用数据库</a></span>的步骤<span class="q">”</span>描述了使用<code class="codeph">FROM SERVICE</code>子句刷新物理备用<span class="q"><a href="rman-recovery-advanced.html#GUID-828A4953-3F7E-4975-ADA4-5469D6794BB0" title="将RECOVER STANDBY DATABASE命令与FROM SERVICE子句一起使用，以使用对主数据库所做的更改来刷新物理备用数据库。">数据库</a></span>的步骤。
                     </p>
                     <div class="infoboxnotealso" id="GUID-93C8F7F1-E1FB-485D-ABC7-860757B24A98__GUID-C3DCC851-E53E-4C67-AD21-F42B5F93F146">
                        <p class="notep1">也可以看看：</p>
                        <p>有关使用<code class="codeph">BACKUP INCREMENTAL</code>命令前滚物理备用数据库的信息，请参阅<a href="../sbydb/managing-oracle-data-guard-physical-standby-databases.html#SBYDB-GUID-B140C38B-DE01-4252-8422-7154018DDFEC" target="_blank"><span><cite>Oracle Data Guard概念和管理</cite></span></a></p>
                     </div>
                  </div><a id="BRADV858"></a><div class="props_rev_3"><a id="GUID-828A4953-3F7E-4975-ADA4-5469D6794BB0" name="GUID-828A4953-3F7E-4975-ADA4-5469D6794BB0"></a><h5 id="BRADV-GUID-828A4953-3F7E-4975-ADA4-5469D6794BB0" class="sect5"><span class="enumeration_section">20.7.5.1</span>使用对主数据库所做的更改来刷新物理备用数据库的步骤</h5>
                     <div>
                        <p>将<code class="codeph">RECOVER STANDBY DATABASE</code>命令与<code class="codeph">FROM SERVICE</code>子句一起使用，以使用对主数据库所做的更改来刷新物理备用数据库。
                        </p>
                        <div class="section">
                           <p></p>
                           <p>此示例假定主数据库的<code class="codeph">DB_UNIQUE_NAME</code>是<code class="codeph">MAIN</code> ，其网络服务名称是<code class="codeph">primary_db</code> 。备用数据库的<code class="codeph">DB_UNIQUE_NAME</code>是<code class="codeph">STANDBY</code> ，其网络服务名称是<code class="codeph">standby_db</code> 。
                           </p>
                           <p><span class="bold">要使用对主数据库所做的更改来刷新物理备用数据库：</span></p>
                           <ol>
                              <li>
                                 <p>确保满足以下先决条件：</p>
                                 <ul style="list-style-type:disc">
                                    <li>
                                       <p>在物理备用数据库和主数据库之间建立Oracle Net连接。</p>
                                       <p>您可以通过在物理备用数据库的<code class="codeph">tnsnames.ora</code>文件中添加与主数据库相对应的条目来完成此操作。
                                       </p>
                                    </li>
                                    <li>
                                       <p>主数据库和物理备用数据库上的密码文件是相同的。</p>
                                    </li>
                                    <li>
                                       <p>主数据库和物理备用数据库的初始化参数文件中的<code class="codeph">COMPATIBLE</code>参数设置为12.0。
                                       </p>
                                    </li>
                                 </ul>
                              </li>
                              <li>
                                 <p>启动RMAN并将其作为目标连接到物理备用数据库。建议您还连接到恢复目录。</p>
                                 <p>以下命令作为<code class="codeph">TARGET</code>连接到物理备用数据库，并作为<code class="codeph">CATALOG</code>连接到恢复目录。使用已被授予<code class="codeph">SYSBACKUP</code>权限的<code class="codeph">sbu</code>用户建立与物理备用数据库的连接。物理备用数据库的网络服务名称是<code class="codeph">standby_db</code> ，恢复目录的网络服务名称是<code class="codeph">catdb</code> 。
                                 </p><pre class="oac_no_warn" dir="ltr">CONNECT TARGET“sbu @ standby_db AS SYSBACKUP”; CONNECT CATALOG rman @ catdb;</pre></li>
                              <li>
                                 <p>使用带有<code class="codeph">FROM SERVICE</code>子句的<code class="codeph">RECOVER STANDBY DATABASE</code>命令前滚物理备用数据库。
                                 </p>
                                 <p><code class="codeph">FROM SERVICE</code>子句指定必须使用物理备用数据库前滚的主数据库的服务名称。前滚操作后重新启动备用数据库。
                                 </p>
                                 <p>以下示例使用服务名称为<code class="codeph">primary_db</code>的主数据库前滚物理备用数据库。
                                 </p><pre class="pre codeblock"><code>从服务中恢复STANDBY数据库primary_db;</code></pre></li>
                              <li>
                                 <p>（仅适用于Active Data Guard）执行以下步骤以恢复重做数据并以只读模式打开物理备用数据库：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE RECOVER管理备用数据库直到一致; ALTER DATABASE OPEN READ ONLY;</pre></li>
                              <li>
                                 <p>在物理备用数据库上启动受管恢复进程。</p>
                                 <p>以下命令启动托管恢复过程：</p><pre class="oac_no_warn" dir="ltr">ALTER DATABASE RECOVER管理备用数据库与会话断开连接;</pre><p>使用Data Guard Broker时，请使用以下命令启动托管恢复过程：</p><pre class="oac_no_warn" dir="ltr">DGMGRL&gt;编辑数据库standby_db set state ='APPLY-ON';</pre></li>
                           </ol>
                           <div class="infoboxnotealso" id="GUID-828A4953-3F7E-4975-ADA4-5469D6794BB0__GUID-30F15DA5-B540-41F4-BD7A-ED90E200DEB4">
                              <p class="notep1">也可以看看：</p>
                              <p>有关建立Oracle Net连接的信息，请参见<a href="https://www.oracle.com/pls/topic/lookup?ctx=en/database/oracle/oracle-database/19/bradv&amp;id=NETAG177" target="_blank"><span><cite>“Oracle数据库网络服务管理员指南”</cite></span></a></p>
                           </div>
                        </div>
                        <!-- class="section" -->
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>