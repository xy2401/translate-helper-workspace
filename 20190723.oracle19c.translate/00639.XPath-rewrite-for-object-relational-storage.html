<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="abstract" content="For XMLType data stored object-relationally, queries involving XPath expression arguments to various SQL functions can often be automatically rewritten to queries against the underlying SQL tables, which are highly optimized.">
      <meta name="description" content="For XMLType data stored object-relationally, queries involving XPath expression arguments to various SQL functions can often be automatically rewritten to queries against the underlying SQL tables, which are highly optimized.">
      <title>XPath Rewrite for Object-Relational Storage</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="Developer's Guide ">
      <meta property="og:description" content="For XMLType data stored object-relationally, queries involving XPath expression arguments to various SQL functions can often be automatically rewritten to queries against the underlying SQL tables, which are highly optimized.">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="Developer's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="xml-db-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2019-03-30T12:32:42-07:00">
      
      <meta name="dcterms.dateCopyrighted" content="2002, 2019">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E96222-03">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19">
      
      <link rel="prev" href="XML-Schema-and-query-object-relational-storage.html" title="Previous" type="text/html">
      <link rel="next" href="XML-Schema-evolution.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="XML DB Developer's Guide">
    <meta name="dcterms.isVersionOf" content="ADXDB">
    <meta name="dcterms.release" content="Release 19">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="XML-Schema-and-query-object-relational-storage.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="XML-Schema-evolution.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">Developer's Guide </span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="XML-Schema-and-object-relational-XMLType.html" property="item" typeof="WebPage"><span property="name">XML Schema and Object-Relational XMLType </span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem"> XPath Rewrite for Object-Relational Storage</li>
            </ol>
            <a id="GUID-35551023-CCAC-477B-8BBF-CD0E0B44C962" name="GUID-35551023-CCAC-477B-8BBF-CD0E0B44C962"></a><a id="ADXDB0670"></a>
            
            <h2 id="ADXDB-GUID-35551023-CCAC-477B-8BBF-CD0E0B44C962" class="sect2"><span class="enumeration_chapter">19 </span> XPath Rewrite for Object-Relational Storage
            </h2>
         </header>
         <div class="ind"><script type="text/javascript">window.name='XPath-rewrite-for-object-relational-storage'</script><script type="text/javascript">
    function footdisplay(footnum,footnote) {
    var msg = window.open('about:blank', 'NewWindow' + footnum,
        'directories=no,height=100,location=no,menubar=no,resizable=yes,' +
        'scrollbars=yes,status=no,toolbar=no,width=598');
    msg.document.open('text/html');
    msg.document.write('<!DOCTYPE html ');
    msg.document.write('PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" ');
    msg.document.write('"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'); 
    msg.document.write('<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us" dir="ltr"><head><title>');
   
    msg.document.write('Footnote&nbsp; ' + footnum);
    msg.document.write('<\/title><meta http-equiv="Content-Type" ');
    msg.document.write('content="text/html; charset=utf-8" />');
    msg.document.write('<meta http-equiv="Content-Script-Type" ');
    msg.document.write('content="text/javascript" />');
    msg.document.write('<style type="text/css"> <![CDATA[ ');
    msg.document.write('h1 {text-align: center; font-size: 14pt;}');
    msg.document.write('fieldset {border: none;}');
    msg.document.write('form {text-align: center;}');
    msg.document.write(' ]]\u003e <\/style>');
    msg.document.write('<\/head><body><div id="footnote"><h1>Footnote&nbsp; ' + footnum + '<\/h1><p>');
    msg.document.write(footnote);
    msg.document.write('<\/p><form action="" method="post"><fieldset>');
    msg.document.write('<input type="button" value="OK" ');
    msg.document.write('onclick="window.close();" />');
    msg.document.write('<\/fieldset><\/form><\/div><\/body><\/html>');
    msg.document.close();
    setTimeout(function() {
        var height = msg.document.getElementById('footnote').offsetHeight;
        msg.resizeTo(598, height + 100);
    }
    , 100);
    msg.focus();
}
            </script><noscript>
               <p>The script content on this page is for navigation purposes only and does not alter the content in any way.</p>
            </noscript>
            <div>
               <p>For <code class="codeph">XMLType</code> data stored object-relationally, queries involving XPath expression arguments to various SQL functions can often be automatically rewritten to queries against the underlying SQL tables, which are highly optimized.
               </p>
               <div class="section"></div>
               <!-- class="section" -->
            </div>
            <div>
               <ul class="ullinks">
                  <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-A2539B25-DD36-4F4C-8726-0B5FBD7A767B">Overview of XPath Rewrite for Object-Relational Storage</a><br>Oracle XML&nbsp;DB can often optimize queries that use XPath expressions — for example, queries involving SQL functions such as <code class="codeph">XMLQuery</code>, <code class="codeph">XMLTable</code>, and <code class="codeph">XMLExists</code>, which take XPath (XQuery) expressions as arguments. The XPath expression is, in effect, evaluated against the XML document without ever constructing the XML document in memory.
                  </li>
                  <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-1C2FC3C9-7926-4635-85A4-6AC28D503CDA">Common XPath Expressions that Are Rewritten</a><br>The most common XPath expressions that are rewritten during XPath rewrite are described.
                  </li>
                  <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39">XPath Rewrite for Out-Of-Line Tables</a><br>XPath expressions that involve elements stored out of line can be automatically rewritten. The rewritten query involves a join with the out-of-line table.
                  </li>
                  <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157">Guidelines for Using Execution Plans to Analyze and Optimize XPath Queries</a><br>Guidelines are presented for using execution plans to analyze query execution in order to (a) determine whether XPath rewrite occurs and (b) optimize query execution by using secondary indexes. These guidelines apply only to <code class="codeph">XMLType</code> data that is stored object-relationally.
                  </li>
               </ul>
               <div class="relinfo">
                  <p><strong>Related Topics</strong></p>
                  <ul>
                     <li><a href="query-and-update-XML.html#GUID-F72DC7CD-40A9-4F07-9350-B80D2AD1F4D0" title="A SQL query that involves XQuery expressions can often be automatically rewritten (optimized) in one or more ways. This optimization is referred to as XML query rewrite or optimization. When this happens, the XQuery expression is, in effect, evaluated directly against the XML document without constructing a DOM in memory.">Performance Tuning for XQuery</a></li>
                  </ul>
               </div>
               <div class="familylinks">
                  <div class="parentlink">
                     <p><strong>Parent topic:</strong> <a href="XML-Schema-and-object-relational-XMLType.html#GUID-817F95DE-D604-41DC-BCDE-76CDE30F9176" title="The use of XML Schema and object-relational storage of XMLType data is covered.">XML Schema and Object-Relational XMLType</a></p>
                  </div>
               </div>
            </div>
            <a id="ADXDB5845"></a><a id="ADXDB4549"></a><div class="props_rev_3"><a id="GUID-A2539B25-DD36-4F4C-8726-0B5FBD7A767B" name="GUID-A2539B25-DD36-4F4C-8726-0B5FBD7A767B"></a><h3 id="ADXDB-GUID-A2539B25-DD36-4F4C-8726-0B5FBD7A767B" class="sect3"><span class="enumeration_section">19.1 </span>Overview of XPath Rewrite for Object-Relational Storage
               </h3>
               <div>
                  <p>Oracle XML&nbsp;DB can often optimize queries that use XPath expressions — for example, queries involving SQL functions such as <code class="codeph">XMLQuery</code>, <code class="codeph">XMLTable</code>, and <code class="codeph">XMLExists</code>, which take XPath (XQuery) expressions as arguments. The XPath expression is, in effect, evaluated against the XML document without ever constructing the XML document in memory.
                  </p>
                  <p>This optimization is called <strong class="term">XPath rewrite</strong>. It is a proper subset of XML query optimization, which also involves optimization of XQuery expressions, such as FLWOR expressions, that are not XPath expressions. XPath rewrite also enables indexes, if present on the column, to be used in query evaluation by the Optimizer.
                  </p>
                  <p>The XPath expressions that can be rewritten by Oracle XML&nbsp;DB are a proper subset of those that are supported by Oracle XML&nbsp;DB. Whenever you can do so without losing functionality, use XPath expressions that can be rewritten.</p>
                  <p>XPath rewrite can occur in these contexts (or combinations thereof):</p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p>When <code class="codeph">XMLType</code> data is stored in an object-relational column or table or when an <code class="codeph">XMLType</code> view is built on relational data.
                        </p>
                     </li>
                     <li>
                        <p>When you use an <code class="codeph">XMLIndex</code> index.
                        </p>
                     </li>
                  </ul>
                  <p>The first case, rewriting queries that use object-relational XML data or <code class="codeph">XMLType</code> views, is covered here. The <code class="codeph">XMLType</code> views can be XML schema-based or not. Object-relational storage of <code class="codeph">XMLType</code> data is always XML schema-based. Examples in this chapter are related to XML schema-based tables.
                  </p>
                  <p>When XPath rewrite is possible for object-relational XML data, the database optimizer can derive an execution plan based on conventional relational algebra. This in turn means that Oracle XML&nbsp;DB can leverage all of the features of the database and ensure that SQL statements containing XQuery and XPath expressions are executed in a highly performant and efficient manner. There is little overhead with this rewriting, so Oracle XML&nbsp;DB executes XQuery-based and XPath-based queries at near-relational speed.</p>
                  <p>In certain cases, XPath rewrite is not possible. This typically occurs when there is no SQL equivalent of the XPath expression. In this situation, Oracle XML&nbsp;DB performs a functional evaluation of the XPath expressions, which is generally more costly, especially if the number of documents to be processed is large.</p>
                  <p><a href="XPath-rewrite-for-object-relational-storage.html#GUID-A2539B25-DD36-4F4C-8726-0B5FBD7A767B__CACIBIIG">Example 19-1</a> illustrates XPath rewrite for a simple query that uses an XPath expression.
                  </p>
                  <div class="example" id="GUID-A2539B25-DD36-4F4C-8726-0B5FBD7A767B__CACIBIIG">
                     <p class="titleinexample">Example 19-1 XPath Rewrite</p><pre class="pre codeblock"><code>SELECT po.OBJECT_VALUE FROM purchaseorder po
  WHERE XMLCast(XMLQuery('$p/PurchaseOrder/Requestor'
                         PASSING po.OBJECT_VALUE AS "p" RETURNING CONTENT)
                AS VARCHAR2(128))
        = 'Sarah J. Bell';
</code></pre><p>The <code class="codeph">XMLCast(XMLQuery...))</code> expression here is rewritten to the underlying relational column that stores the requestor information for the purchase order. The query is rewritten to something like the following:<a id="fn_1" name="fn_1" href="#fn_1" onclick="footdisplay(1, "This example uses sample database schema OE and its table purchaseorder. The XML schema for this table is annotated with attribute SQLName to specify SQL object attribute names such as REQUESTOR — see Example A-2. Without such annotations, this example would use p.\"XMLDATA\".\"Requestor\", not p.\"XMLDATA\".\".REQUESTOR\".")"><sup>Foot&nbsp;1</sup></a> 
                     </p><pre class="pre codeblock"><code>SELECT OBJECT_VALUE FROM purchaseorder p
 WHERE CAST (p."XMLDATA"."REQUESTOR" AS VARCHAR2(128)) = 'Sarah J. Bell';
</code></pre></div>
                  <!-- class="example" -->
               </div>
               <div>
                  <div class="relinfo">
                     <p><strong>Related Topics</strong></p>
                     <ul>
                        <li><a href="relational-views-over-XML-data.html#GUID-420496CE-D62F-4EBE-A76E-861B932AE1E6" title="Relational database views over XML data provide conventional, relational access to XML content.">Relational Views over XML Data</a></li>
                        <li><a href="XMLType-views.html#GUID-9F0A7B1F-269B-411F-AD8B-8F1CB2E2A671" title="You can create XMLType views over relational and object-relational data.">XMLType Views</a></li>
                        <li><a href="indexes-for-XMLType-data.html#GUID-BF638421-9D6E-4D72-8371-79D084A04BCA" title="You can effectively index XMLType data that is stored object-relationally by creating B-tree indexes on the underlying database columns that correspond to XML nodes.">Indexing XMLType Data Stored Object-Relationally</a></li>
                        <li><a href="indexes-for-XMLType-data.html#GUID-6E6A5BA7-9B84-4E3D-B556-B3B286D26B46">XMLIndex</a></li>
                        <li><a href="XML-Schema-and-query-object-relational-storage.html#GUID-B1B67DF3-8E3A-4383-B67F-D14EF98BFBE9" title="For XMLType data stored object-relationally, careful planning is called for, to optimize performance. Similar considerations are in order as for relational data: entity-relationship models, indexing, data types, table partitions, and so on. To enable XPath rewrite and achieve optimal performance, you implement many such design choices using XML schema annotations.">XML Schema Annotation Guidelines for Object-Relational Storage</a></li>
                     </ul>
                  </div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-35551023-CCAC-477B-8BBF-CD0E0B44C962" title="For XMLType data stored object-relationally, queries involving XPath expression arguments to various SQL functions can often be automatically rewritten to queries against the underlying SQL tables, which are highly optimized.">XPath Rewrite for Object-Relational Storage</a></p>
                     </div>
                  </div>
               </div>
               
            </div><a id="ADXDB4558"></a><a id="ADXDB5847"></a><div class="props_rev_3"><a id="GUID-1C2FC3C9-7926-4635-85A4-6AC28D503CDA" name="GUID-1C2FC3C9-7926-4635-85A4-6AC28D503CDA"></a><h3 id="ADXDB-GUID-1C2FC3C9-7926-4635-85A4-6AC28D503CDA" class="sect3"><span class="enumeration_section">19.2 </span>Common XPath Expressions that Are Rewritten
               </h3>
               <div>
                  <p>The most common XPath expressions that are rewritten during XPath rewrite are described.</p>
                  <p><a href="XPath-rewrite-for-object-relational-storage.html#GUID-1C2FC3C9-7926-4635-85A4-6AC28D503CDA__G1048508" title="This table describes supported XPath expressions for translation to underlying SQL queries. It has two columns.">Table 19-1</a> presents the descriptions
                  </p>
                  <div class="tblformalwide" id="GUID-1C2FC3C9-7926-4635-85A4-6AC28D503CDA__G1048508">
                     <p class="titleintable">Table 19-1 Sample of XPath Expressions that Are Rewritten to Underlying SQL Constructs</p>
                     <table cellpadding="4" cellspacing="0" class="FormalWide" title="Sample of XPath Expressions that Are Rewritten to Underlying SQL Constructs" summary="This table describes supported XPath expressions for translation to underlying SQL queries. It has two columns." width="100%" frame="hsides" border="1" rules="rows">
                        <thead>
                           <tr align="left" valign="top">
                              <th align="left" valign="bottom" width="53%" id="d101315e334">XPath Expression for Translation</th>
                              <th align="left" valign="bottom" width="47%" id="d101315e337">Description</th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="53%" id="d101315e342" headers="d101315e334 ">
                                 <p>Simple XPath expressions (expressions with <code class="codeph">child</code> and <code class="codeph">attribute</code> axes only):
                                 </p>
                                 <p><code class="codeph">/PurchaseOrder/@Reference</code></p>
                                 <p><code class="codeph">/PurchaseOrder/Requestor</code></p>
                              </td>
                              <td align="left" valign="top" width="47%" headers="d101315e342 d101315e337 ">
                                 <p>Involves traversals over object type attributes only, where the attributes are simple scalar or object types themselves. </p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="53%" id="d101315e361" headers="d101315e334 ">
                                 <p>Collection traversal expressions:</p>
                                 <p><code class="codeph">/PurchaseOrder/LineItems/LineItem/Part/@Id</code></p>
                              </td>
                              <td align="left" valign="top" width="47%" headers="d101315e361 d101315e337 ">
                                 <p>Involves traversal of collection expressions. The only axes supported are child and attribute axes. Collection traversal is not supported if the SQL function is used during a <code class="codeph">CREATE INDEX</code> operation.
                                 </p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="53%" id="d101315e374" headers="d101315e334 ">
                                 <p>Predicates:</p>
                                 <p><code class="codeph">[Requestor = "Sarah J. Bell"]</code></p>
                              </td>
                              <td align="left" valign="top" width="47%" headers="d101315e374 d101315e337 ">
                                 <p>Predicates in the XPath are rewritten into SQL predicates. </p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="53%" id="d101315e384" headers="d101315e334 ">
                                 <p>List index (positional predicate): </p>
                                 <p><code class="codeph">LineItem[1]</code></p>
                              </td>
                              <td align="left" valign="top" width="47%" headers="d101315e384 d101315e337 ">
                                 <p>Indexes are rewritten to access the nth item in a collection.</p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="53%" id="d101315e394" headers="d101315e334 ">
                                 <p>Wildcard traversals: </p>
                                 <p><code class="codeph">/PurchaseOrder/*/Part/@Id</code></p>
                              </td>
                              <td align="left" valign="top" width="47%" headers="d101315e394 d101315e337 ">
                                 <p>If the wildcard can be translated to one or more simple XPath expressions, then it is rewritten.</p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="53%" id="d101315e404" headers="d101315e334 ">
                                 <p>Descendant axis (XML schema-based data only), without recursion:</p>
                                 <p><code class="codeph">/PurchaseOrder//Part/@Id</code></p>
                              </td>
                              <td align="left" valign="top" width="47%" headers="d101315e404 d101315e337 ">
                                 <p>Similar to a wildcard expression. The <code class="codeph">descendant</code> axis is rewritten if it can be mapped to one or more simple XPath expressions.
                                 </p>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="53%" id="d101315e417" headers="d101315e334 ">
                                 <p>Descendant axis (XML schema-based data only), with <span class="italic">recursion</span>:
                                 </p>
                                 <p><code class="codeph">/PurchaseOrder//Part/@Id</code></p>
                              </td>
                              <td align="left" valign="top" width="47%" headers="d101315e417 d101315e337 ">
                                 <p>The <code class="codeph">descendant</code> axis is rewritten if both of these conditions holds:
                                 </p>
                                 <ul style="list-style-type: disc;">
                                    <li>
                                       <p>All simple XPath expressions to which this XPath expression expands map to the same out-of-line table.</p>
                                    </li>
                                    <li>
                                       <p>Any simple XPath expression to which this XPath expression does not expand does not map to that out-of-line table.</p>
                                    </li>
                                 </ul>
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" width="53%" id="d101315e440" headers="d101315e334 ">
                                 <p>XPath functions</p>
                              </td>
                              <td align="left" valign="top" width="47%" headers="d101315e440 d101315e337 ">
                                 <p>Some XPath functions are rewritten. These functions include <code class="codeph">not</code>, <code class="codeph">floor</code>, <code class="codeph">ceiling</code>, <code class="codeph">substring</code>, and <code class="codeph">string-length</code>.
                                 </p>
                              </td>
                           </tr>
                        </tbody>
                     </table>
                  </div>
                  <!-- class="inftblhruleinformal" -->
               </div>
               <div>
                  <div class="infoboxnotealso" id="GUID-1C2FC3C9-7926-4635-85A4-6AC28D503CDA__GUID-E01FC34D-DFBF-4402-989E-D955E5779BDC">
                     <p class="notep1">See Also:</p>
                     <p><a href="query-and-update-XML.html#GUID-F72DC7CD-40A9-4F07-9350-B80D2AD1F4D0" title="A SQL query that involves XQuery expressions can often be automatically rewritten (optimized) in one or more ways. This optimization is referred to as XML query rewrite or optimization. When this happens, the XQuery expression is, in effect, evaluated directly against the XML document without constructing a DOM in memory.">Performance Tuning for XQuery</a> for information about rewrite of XQuery expressions
                     </p>
                  </div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-35551023-CCAC-477B-8BBF-CD0E0B44C962" title="For XMLType data stored object-relationally, queries involving XPath expression arguments to various SQL functions can often be automatically rewritten to queries against the underlying SQL tables, which are highly optimized.">XPath Rewrite for Object-Relational Storage</a></p>
                     </div>
                  </div>
               </div>
               
            </div><a id="ADXDB4623"></a><a id="ADXDB4624"></a><a id="ADXDB4622"></a><div class="props_rev_3"><a id="GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39" name="GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39"></a><h3 id="ADXDB-GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39" class="sect3"><span class="enumeration_section">19.3 </span>XPath Rewrite for Out-Of-Line Tables
               </h3>
               <div>
                  <p>XPath expressions that involve elements stored out of line can be automatically rewritten. The rewritten query involves a join with the out-of-line table.</p>
                  <p> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39__CHDCJJHJ">Example 19-2</a> shows such a query. The XQuery expression is rewritten to a SQL <code class="codeph">EXISTS</code> subquery that queries table <code class="codeph">addr_tab</code>, joining it with table <code class="codeph">emp_tab</code> using the object identifier column in <code class="codeph">addr_tab</code>. The optimizer uses full table scans of tables <code class="codeph">emp_tab</code> and <code class="codeph">addr_tab</code>. If there are many entries in the <code class="codeph">addr_tab</code>, then you can try to make this query more efficient by creating an index on the city, as shown in <a href="XPath-rewrite-for-object-relational-storage.html#GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39__CHDEICJC">Example 19-3</a>. An explain-plan fragment for the same query as in <a href="XPath-rewrite-for-object-relational-storage.html#GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39__CHDCJJHJ">Example 19-2</a> shows that the city index is picked up.
                  </p>
                  <div class="infoboxnote" id="GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39__GUID-444E1A87-2020-492C-8FA1-BEC20B312818">
                     <p class="notep1">Note:</p>
                     <p>When gathering statistics for the optimizer on an <code class="codeph">XMLType</code> table that is stored object-relationally, Oracle recommends that you gather statistics on <span class="italic">all</span> of the tables defined by the XML schema, that is, all of the tables in <code class="codeph">USER_XML_TABLES</code>. You can use procedure <code class="codeph">DBMS_STATS.gather_schema_stats</code> to do this, or use <code class="codeph">DBMS_STATS.gather_table_stats</code> on each such table. This informs the optimizer about all of the dependent tables that are used to store the <code class="codeph">XMLType</code> data.
                     </p>
                  </div>
                  <div class="example" id="GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39__CHDCJJHJ">
                     <p class="titleinexample">Example 19-2 XPath Rewrite for an Out-Of-Line Table</p><pre class="pre codeblock"><code>SELECT XMLCast(XMLQuery('declare namespace x = "http://www.oracle.com/emp.xsd"; (: :)
                         /x:Employee/Name' PASSING OBJECT_VALUE RETURNING CONTENT)
               AS VARCHAR2(20))
  FROM emp_tab
  WHERE XMLExists('declare namespace x = "http://www.oracle.com/emp.xsd"; (: :)
                   /x:Employee/Addr[City="San Francisco"]' PASSING OBJECT_VALUE);

XMLCAST(XMLQUERY(...
--------------------
Abe Bee
Eve Fong
George Hu
Iris Jones
Karl Luomo
Marina Namur
Omar Pinano
Quincy Roberts
 
8 rows selected.
</code></pre></div>
                  <!-- class="example" -->
                  <div class="example" id="GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39__CHDEICJC">
                     <p class="titleinexample">Example 19-3 Using an Index with an Out-Of-Line Table</p><pre class="pre codeblock"><code>CREATE INDEX addr_city_idx
  ON addr_tab (extractValue(OBJECT_VALUE, '/Addr/City'));
</code></pre><pre class="pre codeblock"><code>|   2 |   TABLE ACCESS BY INDEX ROWID| ADDR_TAB      |     1 |  2012 |     1   (0)| 00:00:01 |
|*  3 |    INDEX RANGE SCAN          | <span class="bold">ADDR_CITY_IDX</span> |     1 |       |     1   (0)| 00:00:01 |
|   4 |   TABLE ACCESS FULL          | EMP_TAB       |    16 | 32464 |     2   (0)| 00:00:01 |</code></pre></div>
                  <!-- class="example" -->
               </div>
               <div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-35551023-CCAC-477B-8BBF-CD0E0B44C962" title="For XMLType data stored object-relationally, queries involving XPath expression arguments to various SQL functions can often be automatically rewritten to queries against the underlying SQL tables, which are highly optimized.">XPath Rewrite for Object-Relational Storage</a></p>
                     </div>
                  </div>
               </div>
               
            </div><a id="ADXDB4566"></a><div class="props_rev_3"><a id="GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157" name="GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157"></a><h3 id="ADXDB-GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157" class="sect3"><span class="enumeration_section">19.4 </span>Guidelines for Using Execution Plans to Analyze and Optimize XPath Queries 
               </h3>
               <div>
                  <p>Guidelines are presented for using execution plans to analyze query execution in order to (a) determine whether XPath rewrite occurs and (b) optimize query execution by using secondary indexes. These guidelines apply only to <code class="codeph">XMLType</code> data that is stored object-relationally.
                  </p>
                  <p>Use these guidelines together, taking all that apply into consideration.</p>
                  <p>XPath rewrite for object-relational storage means that a query that selects XML fragments defined by an XPath expression is rewritten to a SQL <code class="codeph">SELECT</code> statement on the underlying object-relational tables and columns. These underlying tables can include out-of-line tables.
                  </p>
                  <p>You can use PL/SQL procedure <code class="codeph">DBMS_XMLSTORAGE_MANAGE.XPath2TabColMapping</code> to find the names of the underlying tables and columns that correspond to a given XPath expression.
                  </p>
                  <div class="section"></div>
                  <!-- class="section" -->
               </div>
               <div>
                  <ul class="ullinks">
                     <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-B1658194-2F19-47C0-B82D-10761D68E299">Guideline: Look for underlying tables versus XML functions in execution plans</a><br>The execution plan of a query that is rewritten refers to the names of the object-relational tables and columns that underlie the queried <code class="codeph">XMLType</code> data. These names can be meaningful to you if they are derived from XML element or attribute names or if XML Schema annotation <code class="codeph">xdb:defaultTable</code> was used. 
                     </li>
                     <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-4B3F942D-A767-4870-BB69-18EC4E815A10">Guideline: Name the object-relational tables, so you recognize them in execution plans</a><br>When designing an XML schema, use annotation <code class="codeph">xdb:defaultTable</code> to name the underlying tables that correspond to elements that you select in queries where performance is important. This lets you easily recognize them in an execution plan, indicating by their presence or absence whether the query has been rewritten.
                     </li>
                     <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F">Guideline: Create an index on a column targeted by a predicate</a><br>You can sometimes improve the performance of a query that is rewritten to include a SQL predicate, by creating an index that applies to the column targeted by the predicate.
                     </li>
                     <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4">Guideline: Create indexes on ordered collection tables</a><br>If a collection is stored as an ordered collection table (OCT) or as an <code class="codeph">XMLType</code> instance, then you can directly access members of the collection. Each member becomes a table row, so you can access it directly with SQL. You can often improve performance by indexing such collection members. 
                     </li>
                     <li class="ulchildlink"><a href="XPath-rewrite-for-object-relational-storage.html#GUID-7F6CF536-9DDC-42C8-AB0D-115A5300C616">Guideline: Use XMLOptimizationCheck to determine why a query is not rewritten</a><br>If a query has not been optimized, you can use system variable <code class="codeph">XMLOptimizationCheck</code> to try to determine why. 
                     </li>
                  </ul>
                  <div class="relinfo">
                     <p><strong>Related Topics</strong></p>
                     <ul>
                        <li><a href="XPath-rewrite-for-object-relational-storage.html#GUID-C9B5CA3D-32EC-4617-B654-21307B11CC39" title="XPath expressions that involve elements stored out of line can be automatically rewritten. The rewritten query involves a join with the out-of-line table.">XPath Rewrite for Out-Of-Line Tables</a></li>
                     </ul>
                  </div>
                  <div class="infoboxnotealso" id="GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157__GUID-BC313CFB-D881-41CF-8B2E-E21C34E6FC24">
                     <p class="notep1">See Also:</p>
                     <p><a href="../arpls/DBMS_XMLSTORAGE_MANAGE.html#ARPLS74503" target="_blank"><span><cite>Oracle Database PL/SQL Packages and Types Reference</cite></span></a> for information about procedure <code class="codeph">XPath2TabColMapping</code></p>
                  </div>
                  <div class="familylinks">
                     <div class="parentlink">
                        <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-35551023-CCAC-477B-8BBF-CD0E0B44C962" title="For XMLType data stored object-relationally, queries involving XPath expression arguments to various SQL functions can often be automatically rewritten to queries against the underlying SQL tables, which are highly optimized.">XPath Rewrite for Object-Relational Storage</a></p>
                     </div>
                  </div>
               </div>
               <a id="ADXDB5849"></a><a id="ADXDB5848"></a><div class="props_rev_3"><a id="GUID-B1658194-2F19-47C0-B82D-10761D68E299" name="GUID-B1658194-2F19-47C0-B82D-10761D68E299"></a><h4 id="ADXDB-GUID-B1658194-2F19-47C0-B82D-10761D68E299" class="sect4"><span class="enumeration_section">19.4.1 </span>Guideline: Look for underlying tables versus XML functions in execution plans
                  </h4>
                  <div>
                     <p>The execution plan of a query that is rewritten refers to the names of the object-relational tables and columns that underlie the queried <code class="codeph">XMLType</code> data. These names can be meaningful to you if they are derived from XML element or attribute names or if XML Schema annotation <code class="codeph">xdb:defaultTable</code> was used. 
                     </p>
                     <p>Otherwise, these names are system-generated and have no obvious meaning. In particular, they do not reflect the corresponding XML element or attribute names. </p>
                     <p>Also, some system-generated columns are generally hidden. You do not see them if you use the SQL <code class="codeph">describe</code> command. They nevertheless show up in execution plans.
                     </p>
                     <p>The plan of a query that has not been rewritten shows only the base table names, and it typically refers to user-level XML functions, such as <code class="codeph">XMLExists</code>. Look for this difference to determine whether a query has been optimized. The XML function name shown in an execution plan is actually the internal name (for example, <code class="codeph">XMLEXISTS2</code>), which is sometimes slightly different from the user-level name.
                     </p>
                     <p><a href="XPath-rewrite-for-object-relational-storage.html#GUID-B1658194-2F19-47C0-B82D-10761D68E299__CACDIECD">Example 19-4</a> shows the kind of execution plan output that is generated when Oracle XML&nbsp;DB cannot perform XPath rewrite. The plan here is for a query that uses SQL/XML function <code class="codeph">XMLExists</code>. The corresponding internal function <code class="codeph">XMLExists2</code> appears in the plan output, indicating that the query is not rewritten.
                     </p>
                     <p>In this situation, Oracle XML&nbsp;DB constructs a pre-filtered result set based on any other conditions specified in the query <code class="codeph">WHERE</code> clause. It then filters the rows in this potential result set to determine which rows belong in the result set. The filtering is performed by <span class="italic">constructing a DOM on each document</span> and performing a <strong class="term">functional evaluation</strong> using the methods defined by the DOM API to determine whether or not each document is a member of the result set. 
                     </p>
                     <div class="example" id="GUID-B1658194-2F19-47C0-B82D-10761D68E299__CACDIECD">
                        <p class="titleinexample">Example 19-4 Execution Plan Generated When XPath Rewrite Does Not Occur</p><pre class="pre codeblock"><code>Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter(<span class="bold">XMLEXISTS2</span>('$p/PurchaseOrder[User="SBELL"]' PASSING BY VALUE
              SYS_MAKEXML('61687B202644E297E040578C8A175C1D',4215,"PO"."XMLEXTRA","PO"."X
              MLDATA") AS "p")=1)
</code></pre></div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157" title="Guidelines are presented for using execution plans to analyze query execution in order to (a) determine whether XPath rewrite occurs and (b) optimize query execution by using secondary indexes. These guidelines apply only to XMLType data that is stored object-relationally.">Guidelines for Using Execution Plans to Analyze and Optimize XPath Queries</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="ADXDB5850"></a><div class="props_rev_3"><a id="GUID-4B3F942D-A767-4870-BB69-18EC4E815A10" name="GUID-4B3F942D-A767-4870-BB69-18EC4E815A10"></a><h4 id="ADXDB-GUID-4B3F942D-A767-4870-BB69-18EC4E815A10" class="sect4"><span class="enumeration_section">19.4.2 </span>Guideline: Name the object-relational tables, so you recognize them in execution plans
                  </h4>
                  <div>
                     <p>When designing an XML schema, use annotation <code class="codeph">xdb:defaultTable</code> to name the underlying tables that correspond to elements that you select in queries where performance is important. This lets you easily recognize them in an execution plan, indicating by their presence or absence whether the query has been rewritten.
                     </p>
                     <p>For collection tables, there is no corresponding XML schema annotation. To give user-friendly names to your collection tables you must first register the XML schema. Then you can use PL/SQL procedure <code class="codeph">DBMS_XMLSTORAGE_MANAGE.renameCollectionTable</code> to rename the tables that were created during registration, which have system-generated names.
                     </p>
                  </div>
                  <div>
                     <div class="infoboxnotealso" id="GUID-4B3F942D-A767-4870-BB69-18EC4E815A10__GUID-66967FDC-3985-42C6-A815-AF34F1030F49">
                        <p class="notep1">See Also:</p>
                        <p><a href="../arpls/DBMS_XMLSTORAGE_MANAGE.html#ARPLS74498" target="_blank"><span><cite>Oracle Database PL/SQL Packages and Types Reference</cite></span></a> for information about procedure <code class="codeph">renameCollectionTable</code></p>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157" title="Guidelines are presented for using execution plans to analyze query execution in order to (a) determine whether XPath rewrite occurs and (b) optimize query execution by using secondary indexes. These guidelines apply only to XMLType data that is stored object-relationally.">Guidelines for Using Execution Plans to Analyze and Optimize XPath Queries</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="ADXDB5852"></a><a id="ADXDB6120"></a><a id="ADXDB5854"></a><a id="ADXDB5855"></a><a id="ADXDB5856"></a><a id="ADXDB5857"></a><a id="ADXDB5851"></a><div class="props_rev_3"><a id="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F" name="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F"></a><h4 id="ADXDB-GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F" class="sect4"><span class="enumeration_section">19.4.3 </span>Guideline: Create an index on a column targeted by a predicate
                  </h4>
                  <div>
                     <p>You can sometimes improve the performance of a query that is rewritten to include a SQL predicate, by creating an index that applies to the column targeted by the predicate.</p>
                     <p>A query resulting from XPath rewrite sometimes includes a SQL predicate (<code class="codeph">WHERE</code> clause). This can happen even if the original query does not use an XPath predicate, and it can happen even if the original query does not have a SQL <code class="codeph">WHERE</code> clause. 
                     </p>
                     <p>When this happens, you can sometimes improve performance by creating an index on the column that is targeted by the SQL predicate, or by creating an index on a function application to that column. </p>
                     <p><a href="XPath-rewrite-for-object-relational-storage.html#GUID-A2539B25-DD36-4F4C-8726-0B5FBD7A767B__CACIBIIG">Example 19-1</a> illustrates XPath rewrite for a query that includes a <code class="codeph">WHERE</code> clause. <a href="XPath-rewrite-for-object-relational-storage.html#GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACIIDHJ">Example 19-5</a> shows the predicate information from an execution plan for this query.
                     </p>
                     <p>The predicate information indicates that the expression <code class="codeph">XMLCast(XMLQuery...))</code> is rewritten to an application of SQL function <code class="codeph">cast</code> to the underlying relational column that stores the requestor information for the purchase order, <code class="codeph">SYS_NC0021$</code>. This column name is system-generated. The execution plan refers to this system-generated name, in spite of the fact that the governing XML schema uses annotation <code class="codeph">SQLName</code> to name this column <code class="codeph">REQUESTOR</code>.
                     </p>
                     <p>Because these two names (user-defined and system-generated) refer to the same column, you can create a B-tree index on this column using either name. Alternatively, you can use the <code class="codeph">extractValue</code> shortcut to create the index, by specifying an XPath expression that targets the purchase-order requestor data. 
                     </p>
                     <p>You can obtain the names of the underlying table and columns that correspond to a given XPath expression using procedure <code class="codeph">DBMS_XMLSTORAGE_MANAGE.XPath2TabColMapping</code>. <a href="XPath-rewrite-for-object-relational-storage.html#GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CHDCHCCB">Example 19-6</a> illustrates this for the XPath expression <code class="codeph">/PurchaseOrder/Requestor</code> used in the <code class="codeph">WHERE</code> clause of <a href="XPath-rewrite-for-object-relational-storage.html#GUID-A2539B25-DD36-4F4C-8726-0B5FBD7A767B__CACIBIIG">Example 19-1</a>. 
                     </p>
                     <p>If you provide an XPath expression that contains a wildcard or a descendent axis then multiple tables and columns might be selected. In that case procedure <code class="codeph">XPath2TabColMapping</code> returns multiple <code class="codeph">&lt;Mapping&gt;</code> elements, one for each table-column pair.
                     </p>
                     <p>You can then use the table and column names retrieved this way in a <code class="codeph">CREATE INDEX</code> statement to create an index that corresponds to the XPath expression. <a href="XPath-rewrite-for-object-relational-storage.html#GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACDBHCJ">Example 19-7</a> shows three equivalent ways to create a B-tree index on the predicate-targeted column.
                     </p>
                     <p>However, for this particular query it makes sense to create a function-based index, using a functional expression that matches the one in the rewritten query. <a href="XPath-rewrite-for-object-relational-storage.html#GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACCAJDI">Example 19-8</a> illustrates this.
                     </p>
                     <p><a href="XPath-rewrite-for-object-relational-storage.html#GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACJEJBH">Example 19-9</a> shows an execution plan that indicates that the index is picked up.
                     </p>
                     <p>In the particular case of this query, the original functional expression applies <code class="codeph">XMLCast</code> to <code class="codeph">XMLQuery</code> to target a singleton element, <code class="codeph">Requestor</code>. This is a special case, where you can as a shortcut use such a functional expression directly in the <code class="codeph">CREATE INDEX</code> statement. That statement is rewritten to create an index on the underlying scalar data. <a href="XPath-rewrite-for-object-relational-storage.html#GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACCGFBB">Example 19-10</a>, which targets an XPath expression, thus has the same effect as <a href="XPath-rewrite-for-object-relational-storage.html#GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACCAJDI">Example 19-8</a>, which targets the corresponding object-relational column.
                     </p>
                     <div class="infoboxnotealso" id="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__GUID-A276AAA7-4C93-432E-BE1F-C0B7478210D8">
                        <p class="notep1">See Also:</p>
                        <ul style="list-style-type: disc;">
                           <li>
                              <p><a href="indexes-for-XMLType-data.html#GUID-A01AC88E-C63B-40FC-9E6E-8BB1E65A459E" title="Table purchaseorder in sample database schema OE is stored object-relationally. Each purchase-order document has a single Reference element; this element is a singleton. You can thus use a shortcut to create an index on the underlying object-relational data.">Indexing Non-Repeating Text Nodes or Attribute Values</a> for information about using the shortcut of <code class="codeph">XMLCast</code> applied to <code class="codeph">XMLQuery</code> and the <code class="codeph">extractValue</code> shortcut to index singleton data 
                              </p>
                           </li>
                           <li>
                              <p><a href="../arpls/DBMS_XMLSTORAGE_MANAGE.html#ARPLS74503" target="_blank"><span><cite>Oracle Database PL/SQL Packages and Types Reference</cite></span></a> for information about procedure <code class="codeph">XPath2TabColMapping</code></p>
                           </li>
                        </ul>
                     </div>
                     <div class="example" id="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACIIDHJ">
                        <p class="titleinexample">Example 19-5 Analyzing an Execution Plan to Determine a Column to Index</p><pre class="oac_no_warn" dir="ltr">Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter(<span class="bold">CAST</span>("PURCHASEORDER"."<span class="bold">SYS_NC00021$</span>" AS VARCHAR2(128))='Sarah
              J. Bell' AND SYS_CHECKACL("ACLOID","OWNERID",xmltype('&lt;privilege
              xmlns="http://xmlns.oracle.com/xdb/acl.xsd"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://xmlns.oracle.com/xdb/acl.xsd
              http://xmlns.oracle.com/xdb/acl.xsd DAV:http://xmlns.oracle.com/xdb/dav.xsd
              "&gt;&lt;read-properties/&gt;&lt;read-contents/&gt;&lt;/privilege&gt;'))=1)
</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CHDCHCCB">
                        <p class="titleinexample">Example 19-6 Using DBMS_XMLSTORAGE_MANAGE.XPATH2TABCOLMAPPING</p><pre class="oac_no_warn" dir="ltr">SELECT DBMS_XMLSTORAGE_MANAGE.XPath2TabColMapping(USER,
                                                  'PURCHASEORDER',
                                                  '',
                                                  '/PurchaseOrder/Requestor',
                                                  '')
  FROM  DUAL;

DBMS_XMLSTORAGE_MANAGE.XPath2TabColMapping(US
---------------------------------------------
&lt;Result&gt;
  &lt;Mapping TableName="PURCHASEORDER" ColumnName="SYS_NC00021$"/&gt;
&lt;/Result&gt;
</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACDBHCJ">
                        <p class="titleinexample">Example 19-7 Creating an Index on a Column Targeted by a Predicate</p><pre class="oac_no_warn" dir="ltr">CREATE INDEX requestor_index ON purchaseorder ("SYS_NC00021$");

CREATE INDEX requestor_index ON purchaseorder ("XMLDATA"."REQUESTOR");

CREATE INDEX requestor_index ON purchaseorder
  (extractvalue(OBJECT_VALUE, '/PurchaseOrder/Requestor'));
</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACCAJDI">
                        <p class="titleinexample">Example 19-8 Creating a Function-Based Index for a Column Targeted by a Predicate</p><pre class="oac_no_warn" dir="ltr">CREATE INDEX requestor_index ON purchaseorder
  (<span class="bold">cast</span>("XMLDATA"."<span class="bold">REQUESTOR</span>" AS VARCHAR2(128)));
</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACJEJBH">
                        <p class="titleinexample">Example 19-9 Execution Plan Showing that Index Is Picked Up</p><pre class="oac_no_warn" dir="ltr">-----------------------------------------------------------------------------------------------
| Id  | Operation                   | Name            | Rows  | Bytes | Cost (%CPU)| Time     |
-----------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT            |                 |     1 |   524 |     2   (0)| 00:00:01 |
|*  1 |  TABLE ACCESS BY INDEX ROWID| PURCHASEORDER   |     1 |   524 |     2   (0)| 00:00:01 |
|*  2 |   INDEX RANGE SCAN          | <span class="bold">REQUESTOR_INDEX</span> |     1 |       |     1   (0)| 00:00:01 |
-----------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter(SYS_CHECKACL("ACLOID","OWNERID",xmltype('&lt;privilege
              xmlns="http://xmlns.oracle.com/xdb/acl.xsd"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://xmlns.oracle.com/xdb/acl.xsd
                                  http://xmlns.oracle.com/xdb/acl.xsd
              DAV:http://xmlns.oracle.com/xdb/dav.xsd"&gt;
              &lt;read-properties/&gt;&lt;read-contents/&gt;&lt;/privilege&gt;'))=1)
   2 - access(CAST("SYS_NC00021$" AS VARCHAR2(128))='Sarah J. Bell')
</pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-2A9AEEC5-6CD1-4A17-A3A7-08E86E547C2F__CACCGFBB">
                        <p class="titleinexample">Example 19-10 Creating a Function-Based Index for a Column Targeted by a Predicate</p><pre class="oac_no_warn" dir="ltr">CREATE INDEX requestor_index 
  ON purchaseorder po
     (XMLCast(XMLQuery('$p/PurchaseOrder/Requestor' PASSING po.OBJECT_VALUE AS "p"
                                                    RETURNING CONTENT)
              AS VARCHAR2(128)));</pre></div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157" title="Guidelines are presented for using execution plans to analyze query execution in order to (a) determine whether XPath rewrite occurs and (b) optimize query execution by using secondary indexes. These guidelines apply only to XMLType data that is stored object-relationally.">Guidelines for Using Execution Plans to Analyze and Optimize XPath Queries</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="ADXDB5859"></a><a id="ADXDB5860"></a><a id="ADXDB5858"></a><div class="props_rev_3"><a id="GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4" name="GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4"></a><h4 id="ADXDB-GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4" class="sect4"><span class="enumeration_section">19.4.4 </span>Guideline: Create indexes on ordered collection tables
                  </h4>
                  <div>
                     <p>If a collection is stored as an ordered collection table (OCT) or as an <code class="codeph">XMLType</code> instance, then you can directly access members of the collection. Each member becomes a table row, so you can access it directly with SQL. You can often improve performance by indexing such collection members. 
                     </p>
                     <p>You do this by creating a <span class="italic">composite</span> index on (a) the object attribute that corresponds to the collection XML element or its attribute and (b) pseudocolumn <code class="codeph">NESTED_TABLE_ID</code>.
                     </p>
                     <p><a href="XPath-rewrite-for-object-relational-storage.html#GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4__CACHICDI">Example 19-11</a> shows the execution plan for a query to find the <code class="codeph">Reference</code> elements in documents that contain an order for part number 717951002372 (<code class="codeph">Part</code> element with an <code class="codeph">Id</code> attribute of value <code class="codeph">717951002372</code>). The collection of <code class="codeph">LineItem</code> elements is stored as rows in the ordered collection table <code class="codeph">lineitem_table</code>.
                     </p>
                     <div class="infoboxnote" id="GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4__GUID-44E812FA-5D62-41BD-B1F9-19C6CFBBB8E2">
                        <p class="notep1">Note:</p>
                        <p><a href="XPath-rewrite-for-object-relational-storage.html#GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4__CACHICDI">Example 19-11</a> does not use the <code class="codeph">purchaseorder</code> table from sample database schema <code class="codeph">OE</code>. It uses a <code class="codeph">purchaseorder</code> table that uses an ordered collection table (OCT) named <code class="codeph">lineitem_table</code> for the collection element <code class="codeph">LineItem</code>.
                        </p>
                     </div>
                     <p>The execution plan shows a full scan of ordered collection table <code class="codeph">lineitem_table</code>. This could be acceptable if there were only a few hundred documents in the <code class="codeph">purchaseorder</code> table, but it would be unacceptable if there were thousands or millions of documents in the table.
                     </p>
                     <p>To improve the performance of such a query, you can create an index that provides direct access to pseudocolumn <code class="codeph">NESTED_TABLE_ID</code>, given the value of attribute <code class="codeph">Id</code>. Unfortunately, Oracle XML&nbsp;DB does not allow indexes on collections to be created using XPath expressions directly. To create the index, you must understand the structure of the SQL object that is used to manage the <code class="codeph">LineItem</code> elements. Given this information, you can create the required index using conventional object-relational SQL.
                     </p>
                     <p>In this case, element <code class="codeph">LineItem</code> is stored as an instance of object type <code class="codeph">lineitem_t</code>. Element <code class="codeph">Part</code> is stored as an instance of SQL data type <code class="codeph">part_t</code>. XML attribute <code class="codeph">Id</code> is mapped to object attribute <code class="codeph">part_number</code>. Given this information, you can create a <span class="italic">composite index</span> on attribute <code class="codeph">part_number</code> and pseudocolumn <code class="codeph">NESTED_TABLE_ID</code>, as shown in <a href="XPath-rewrite-for-object-relational-storage.html#GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4__CACDIGJF">Example 19-12</a>. This index provides direct access to those purchase-order documents that have <code class="codeph">LineItem</code> elements that reference the required part.
                     </p>
                     <div class="example" id="GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4__CACHICDI">
                        <p class="titleinexample">Example 19-11 Execution Plan for a Selection of Collection Elements</p><pre class="pre codeblock"><code>SELECT XMLCast(XMLQuery('$p/PurchaseOrder/Reference'
                        PASSING OBJECT_VALUE AS "p" RETURNING CONTENT)
               AS VARCHAR2(4000)) "Reference"
  FROM purchaseorder
  WHERE XMLExists('$p/PurchaseOrder/LineItems/LineItem/Part[@Id="717951002372"]'
                  PASSING OBJECT_VALUE AS "p");</code></pre><pre class="pre codeblock"><code>
-------------------------------------------------------------------------------------------------------
| Id  | Operation                    | Name                   | Rows  | Bytes | Cost (%CPU)| Time     |
-------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT             |                        |    21 |  2352 |    20  (10)| 00:00:01 |
|*  1 |  HASH JOIN RIGHT SEMI        |                        |    21 |  2352 |    20  (10)| 00:00:01 |
|   2 |   JOIN FILTER CREATE         | :BF0000                |    22 |   880 |    14   (8)| 00:00:01 |
|*  3 |    <span class="bold">TABLE ACCESS FULL</span>         | <span class="bold">LINEITEM_TABLE</span>         |    22 |   880 |    14   (8)| 00:00:01 |
|   4 |   JOIN FILTER USE            | :BF0000                |   132 |  9504 |     5   (0)| 00:00:01 |
|*  5 |    TABLE ACCESS FULL         | PURCHASEORDER          |   132 |  9504 |     5   (0)| 00:00:01 |
-------------------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
   1 - access("NESTED_TABLE_ID"="PURCHASEORDER"."SYS_NC0003400035$")
   3 - filter("SYS_NC00011$"='717951002372')
   5 - filter(SYS_OP_BLOOM_FILTER(:BF0000,"PURCHASEORDER","SYS_NC0003400035$"))
</code></pre></div>
                     <!-- class="example" -->
                     <div class="example" id="GUID-B10DA5D9-25C5-4F0B-AD4D-2CB93D5114D4__CACDIGJF">
                        <p class="titleinexample">Example 19-12 Creating an Index for Direct Access to an Ordered Collection Table</p><pre class="pre codeblock"><code>CREATE INDEX lineitem_part_index ON lineitem_table l (l.part.part_number, l.<span class="bold">NESTED_TABLE_ID</span>);</code></pre></div>
                     <!-- class="example" -->
                  </div>
                  <div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157" title="Guidelines are presented for using execution plans to analyze query execution in order to (a) determine whether XPath rewrite occurs and (b) optimize query execution by using secondary indexes. These guidelines apply only to XMLType data that is stored object-relationally.">Guidelines for Using Execution Plans to Analyze and Optimize XPath Queries</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div><a id="ADXDB5861"></a><div class="props_rev_3"><a id="GUID-7F6CF536-9DDC-42C8-AB0D-115A5300C616" name="GUID-7F6CF536-9DDC-42C8-AB0D-115A5300C616"></a><h4 id="ADXDB-GUID-7F6CF536-9DDC-42C8-AB0D-115A5300C616" class="sect4"><span class="enumeration_section">19.4.5 </span>Guideline: Use XMLOptimizationCheck to determine why a query is not rewritten
                  </h4>
                  <div>
                     <p>If a query has not been optimized, you can use system variable <code class="codeph">XMLOptimizationCheck</code> to try to determine why. 
                     </p>
                     <div class="section"></div>
                     <!-- class="section" -->
                  </div>
                  <div>
                     <div class="relinfo">
                        <p><strong>Related Topics</strong></p>
                        <ul>
                           <li><a href="query-and-update-XML.html#GUID-F6E94E06-C4A3-4956-868C-E33BD34D3116" title="You can examine an execution plan for your SQL code to determine whether XQuery optimization occurs or the plan is instead suboptimal.">Diagnosis of XQuery Optimization: XMLOptimizationCheck</a></li>
                        </ul>
                     </div>
                     <div class="familylinks">
                        <div class="parentlink">
                           <p><strong>Parent topic:</strong> <a href="XPath-rewrite-for-object-relational-storage.html#GUID-3B3A1D6C-38AF-4381-9F47-5E26AE84F157" title="Guidelines are presented for using execution plans to analyze query execution in order to (a) determine whether XPath rewrite occurs and (b) optimize query execution by using secondary indexes. These guidelines apply only to XMLType data that is stored object-relationally.">Guidelines for Using Execution Plans to Analyze and Optimize XPath Queries</a></p>
                        </div>
                     </div>
                  </div>
                  
               </div>
            </div>
            <hr><br><p style="text-decoration:underline">Footnote Legend</p>Footnote&nbsp;1: 
            <p>This example uses sample database schema <code class="codeph">OE</code> and its table <code class="codeph">purchaseorder</code>. The XML schema for this table is annotated with attribute <code class="codeph">SQLName</code> to specify SQL object attribute names such as <code class="codeph">REQUESTOR</code> — see <a href="oracle-supplied-XML-schemas-and-examples.html#GUID-1CB2213C-C6E8-4BC4-86A3-EFDE51AEBEFD__BABDAGBF">Example A-2</a>. Without such annotations, this example would use <code class="codeph">p."XMLDATA"."</code><span class="bold"><code class="codeph">Requestor</code></span><code class="codeph">"</code>, not <code class="codeph">p."XMLDATA"."</code>.<span class="bold"><code class="codeph">REQUESTOR</code></span><code class="codeph">"</code>.
            </p><br></div>
      </article>
   </body>
</html>